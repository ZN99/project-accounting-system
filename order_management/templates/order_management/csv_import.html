{% extends 'order_management/base.html' %}
{% load static %}

{% block title %}CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ{% endblock %}

{% block extra_css %}
<style>
/* Terminal-style log viewer */
.terminal-log {
    background-color: #1e1e1e;
    color: #d4d4d4;
    font-family: 'Courier New', Consolas, Monaco, monospace;
    font-size: 13px;
    line-height: 1.6;
    padding: 12px;
    border-radius: 6px;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #3c3c3c;
    box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
}

.terminal-line {
    margin-bottom: 2px;
    display: flex;
    align-items: flex-start;
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.terminal-line .timestamp {
    color: #858585;
    margin-right: 12px;
    flex-shrink: 0;
    font-weight: 600;
}

.terminal-line .log-info {
    color: #4fc3f7;
}

.terminal-line .log-success {
    color: #66bb6a;
    font-weight: 500;
}

.terminal-line .log-warning {
    color: #ffa726;
    font-weight: 500;
}

.terminal-line .log-error {
    color: #ef5350;
    font-weight: 600;
}

/* Custom scrollbar for terminal */
.terminal-log::-webkit-scrollbar {
    width: 10px;
}

.terminal-log::-webkit-scrollbar-track {
    background: #2d2d2d;
    border-radius: 5px;
}

.terminal-log::-webkit-scrollbar-thumb {
    background: #555;
    border-radius: 5px;
}

.terminal-log::-webkit-scrollbar-thumb:hover {
    background: #777;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-file-csv me-2"></i>
                        CSVä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                    </h4>
                </div>
                <div class="card-body">
                    <!-- èª¬æ˜ -->
                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>å—æ³¨å´CSV</strong>ã¨<strong>ä¾é ¼å´CSV</strong>ã®2ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
                        <ul class="mb-0 mt-2">
                            <li>ç®¡ç†ç•ªå·ã¯ <strong>M25xxxx</strong> å½¢å¼ã§è‡ªå‹•å¤‰æ›ã•ã‚Œã¾ã™</li>
                            <li>ç¾å ´åãŒç©ºã®ãƒ‡ãƒ¼ã‚¿ã¯è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™</li>
                            <li>Dry-runãƒ¢ãƒ¼ãƒ‰ã§ã¯ã€å®Ÿéš›ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã›ãšã«å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã§ãã¾ã™</li>
                            <li>ã‚¤ãƒ³ãƒãƒ¼ãƒˆå‰ã«è‡ªå‹•çš„ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã¾ã™</li>
                        </ul>
                    </div>

                    <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒ  -->
                    <form method="post" enctype="multipart/form-data" id="uploadForm">
                        {% csrf_token %}

                        <div class="row">
                            <!-- å—æ³¨å´CSV -->
                            <div class="col-md-6 mb-3">
                                <label for="order_csv" class="form-label fw-bold">
                                    <i class="fas fa-file-upload me-2"></i>
                                    å—æ³¨å´CSVï¼ˆå…ƒè«‹ãƒ‡ãƒ¼ã‚¿ï¼‰
                                </label>
                                <input
                                    type="file"
                                    class="form-control"
                                    id="order_csv"
                                    name="order_csv"
                                    accept=".csv"
                                    required
                                >
                                <div class="form-text">
                                    ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæƒ…å ±ã‚’å«ã‚€CSVãƒ•ã‚¡ã‚¤ãƒ«
                                </div>
                            </div>

                            <!-- ä¾é ¼å´CSV -->
                            <div class="col-md-6 mb-3">
                                <label for="subcontract_csv" class="form-label fw-bold">
                                    <i class="fas fa-file-upload me-2"></i>
                                    ä¾é ¼å´CSVï¼ˆä¸‹è«‹ãƒ‡ãƒ¼ã‚¿ï¼‰
                                </label>
                                <input
                                    type="file"
                                    class="form-control"
                                    id="subcontract_csv"
                                    name="subcontract_csv"
                                    accept=".csv"
                                    required
                                >
                                <div class="form-text">
                                    ä¸‹è«‹å¥‘ç´„æƒ…å ±ã‚’å«ã‚€CSVãƒ•ã‚¡ã‚¤ãƒ«
                                </div>
                            </div>
                        </div>

                        <!-- Dry-runã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input
                                    class="form-check-input"
                                    type="checkbox"
                                    id="dry_run"
                                    name="dry_run"
                                >
                                <label class="form-check-label" for="dry_run">
                                    <strong>Dry-runãƒ¢ãƒ¼ãƒ‰</strong>ï¼ˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼šãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã›ãšã«å‡¦ç†ã‚’ç¢ºèªï¼‰
                                </label>
                            </div>
                        </div>

                        <!-- å®Ÿè¡Œãƒœã‚¿ãƒ³ -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                                <i class="fas fa-upload me-2"></i>
                                CSVã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
                            </button>
                        </div>
                    </form>

                    <!-- å‡¦ç†ä¸­è¡¨ç¤º -->
                    <div id="processingAlert" class="alert alert-warning mt-3" style="display: none;">
                        <div class="text-center mb-3">
                            <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">å‡¦ç†ä¸­...</span>
                            </div>
                            <h5 class="mb-2"><i class="fas fa-cog fa-spin me-2"></i>CSVãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­...</h5>
                            <p class="mb-3">å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã®å ´åˆã€æ•°åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚<br>ã“ã®ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„ã€‚</p>

                            <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ -->
                            <button type="button" class="btn btn-danger btn-sm" id="cancelBtn" onclick="cancelImport()">
                                <i class="fas fa-times me-1"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>

                        <!-- ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰ -->
                        <div class="progress mb-3" style="height: 25px;">
                            <div class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                                 role="progressbar"
                                 id="progressBar"
                                 style="width: 0%;"
                                 aria-valuenow="0"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <span id="progressText">0%</span>
                            </div>
                        </div>

                        <!-- å‡¦ç†ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
                        <div class="small">
                            <ul class="list-unstyled mb-0" id="statusList">
                                <li><i class="fas fa-spinner fa-spin text-primary me-2"></i><span id="statusText">CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</span></li>
                            </ul>
                        </div>

                        <!-- æ¨å®šæ™‚é–“ã¨ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆ -->
                        <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
                            <div class="small text-muted">
                                <i class="fas fa-clock me-1"></i>æ¨å®šæ®‹ã‚Šæ™‚é–“: <span id="estimatedTime">è¨ˆç®—ä¸­...</span>
                            </div>
                            <div class="small text-success">
                                <i class="fas fa-circle" id="heartbeat"></i> å‡¦ç†ä¸­
                            </div>
                        </div>

                        <!-- ã‚¿ãƒ¼ãƒŸãƒŠãƒ«é¢¨ãƒ­ã‚°ãƒ“ãƒ¥ãƒ¼ã‚¢ãƒ¼ -->
                        <div class="mt-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0">
                                    <i class="fas fa-terminal me-2"></i>å‡¦ç†ãƒ­ã‚°
                                </h6>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="autoScrollToggle" checked>
                                    <label class="form-check-label small" for="autoScrollToggle">
                                        è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                                    </label>
                                </div>
                            </div>
                            <div id="terminalLog" class="terminal-log">
                                <div class="terminal-line">
                                    <span class="timestamp">--:--:--</span>
                                    <span class="log-info">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</span>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>å‡¦ç†ä¸­:</strong> ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®æˆ»ã‚‹ãƒœã‚¿ãƒ³ã‚„å†èª­ã¿è¾¼ã¿ã¯è¡Œã‚ãªã„ã§ãã ã•ã„ã€‚
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ -->
    {% if import_result %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card {% if import_result.success %}border-success{% else %}border-danger{% endif %}">
                <div class="card-header {% if import_result.success %}bg-success{% else %}bg-danger{% endif %} text-white">
                    <h5 class="mb-0">
                        {% if import_result.success %}
                            <i class="fas fa-check-circle me-2"></i>
                            {% if import_result.dry_run %}
                                Dry-runçµæœ
                            {% else %}
                                ã‚¤ãƒ³ãƒãƒ¼ãƒˆçµæœ
                            {% endif %}
                        {% else %}
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ã‚¨ãƒ©ãƒ¼
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if import_result.success %}
                        <!-- çµ±è¨ˆæƒ…å ± -->
                        <div class="row text-center mb-3">
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h2 class="text-primary mb-0">{{ import_result.stats.projects|default:0 }}</h2>
                                    <small class="text-muted">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h2 class="text-success mb-0">{{ import_result.stats.subcontracts|default:0 }}</h2>
                                    <small class="text-muted">ä¸‹è«‹å¥‘ç´„</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h2 class="text-warning mb-0">{{ import_result.stats.skipped|default:0 }}</h2>
                                    <small class="text-muted">ã‚¹ã‚­ãƒƒãƒ—</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="border rounded p-3">
                                    <h2 class="{% if import_result.stats.errors > 0 %}text-danger{% else %}text-muted{% endif %} mb-0">
                                        {{ import_result.stats.errors|default:0 }}
                                    </h2>
                                    <small class="text-muted">ã‚¨ãƒ©ãƒ¼</small>
                                </div>
                            </div>
                        </div>

                        {% if import_result.dry_run %}
                        <div class="alert alert-warning">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Dry-runãƒ¢ãƒ¼ãƒ‰ã§å®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚</strong>ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>
                            å®Ÿéš›ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹å ´åˆã¯ã€Dry-runãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ã¦å†åº¦å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
                        </div>
                        {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚<br>
                            <a href="{% url 'project_list' %}" class="alert-link">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä¸€è¦§</a>ã§ç¢ºèªã§ãã¾ã™ã€‚
                        </div>
                        {% endif %}

                        <!-- ãƒ­ã‚°ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ -->
                        <div class="mt-3">
                            <a href="{% url 'csv_import_download_log' %}" class="btn btn-outline-secondary">
                                <i class="fas fa-download me-2"></i>
                                ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                            </a>
                        </div>

                    {% else %}
                        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
                        <div class="alert alert-danger">
                            <h5 class="alert-heading">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h5>
                            <p class="mb-0">{{ import_result.error }}</p>
                        </div>

                        {% if import_result.output %}
                        <div class="mt-3">
                            <h6>è©³ç´°ãƒ­ã‚°:</h6>
                            <pre class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">{{ import_result.output }}</pre>
                        </div>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.getElementById('uploadForm').addEventListener('submit', function(e) {
    // å‡¦ç†ä¸­è¡¨ç¤º
    document.getElementById('processingAlert').style.display = 'block';
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('submitBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>å‡¦ç†ä¸­...';

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¦ç´ 
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const statusText = document.getElementById('statusText');
    const estimatedTimeElement = document.getElementById('estimatedTime');
    const heartbeat = document.getElementById('heartbeat');

    // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå‡¦ç†ãŒé€²ã‚“ã§ã„ã‚‹ã“ã¨ã‚’è¦–è¦šçš„ã«ç¤ºã™ï¼‰
    const heartbeatInterval = setInterval(() => {
        heartbeat.style.opacity = heartbeat.style.opacity === '0.3' ? '1' : '0.3';
    }, 800);

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å¾Œã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œã«ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
    setTimeout(() => {
        startProgressPolling();
    }, 1000);

    // Track displayed logs to avoid duplicates
    let displayedLogCount = 0;

    function updateTerminalLog(logs) {
        if (!logs || logs.length === 0) return;

        const terminalLog = document.getElementById('terminalLog');
        const autoScroll = document.getElementById('autoScrollToggle').checked;

        // Display only new logs
        const newLogs = logs.slice(displayedLogCount);

        newLogs.forEach(log => {
            const logLine = document.createElement('div');
            logLine.className = 'terminal-line';

            const timestamp = document.createElement('span');
            timestamp.className = 'timestamp';
            timestamp.textContent = log.timestamp || '--:--:--';

            const message = document.createElement('span');
            message.className = `log-${log.type || 'info'}`;
            message.textContent = log.message || '';

            logLine.appendChild(timestamp);
            logLine.appendChild(message);
            terminalLog.appendChild(logLine);
        });

        displayedLogCount = logs.length;

        // Auto-scroll to bottom if enabled
        if (autoScroll) {
            terminalLog.scrollTop = terminalLog.scrollHeight;
        }
    }

    function startProgressPolling() {
        // é€²æ—APIã‚’ãƒãƒ¼ãƒªãƒ³ã‚°ï¼ˆ1ç§’ã”ã¨ï¼‰
        const pollInterval = setInterval(() => {
            fetch('{% url "order_management:csv_import_progress" %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log('ğŸ“Š Progress:', data);

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒãƒƒãƒ”ãƒ³ã‚°
                const statusMessages = {
                    'starting': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...',
                    'initialization': 'åˆæœŸåŒ–ä¸­...',
                    'reading_csv': 'CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...',
                    'validating': 'ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã‚’è¡Œã£ã¦ã„ã¾ã™...',
                    'processing': data.message || 'å‡¦ç†ä¸­...',
                    'finalizing': 'æœ€çµ‚ç¢ºèªã‚’è¡Œã£ã¦ã„ã¾ã™...',
                    'completed': 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸï¼',
                    'error': 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'
                };

                // é€²æ—ç‡ã‚’æ›´æ–°
                const progress = data.progress || 0;
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);
                progressText.textContent = progress + '%';

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°ï¼ˆå®Ÿéš›ã®ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼‰
                const displayMessage = data.message || statusMessages[data.step] || statusMessages[data.status] || 'å‡¦ç†ä¸­...';

                // ãƒ­ã‚°ã‚’æ›´æ–°
                if (data.logs && data.logs.length > 0) {
                    updateTerminalLog(data.logs);
                }

                if (data.status === 'completed') {
                    statusText.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${displayMessage}`;
                    clearInterval(pollInterval);
                    clearInterval(heartbeatInterval);

                    // å®Œäº†å¾Œã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦çµæœã‚’è¡¨ç¤º
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else if (data.status === 'cancelled') {
                    statusText.innerHTML = `<i class="fas fa-times-circle text-warning me-2"></i>${displayMessage}`;
                    progressBar.classList.remove('bg-primary');
                    progressBar.classList.add('bg-warning');
                    clearInterval(pollInterval);
                    clearInterval(heartbeatInterval);

                    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¾Œã€ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                    setTimeout(() => {
                        window.location.reload();
                    }, 1500);
                } else if (data.status === 'error') {
                    statusText.innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-2"></i>${displayMessage}`;
                    clearInterval(pollInterval);
                    clearInterval(heartbeatInterval);

                    // ã‚¨ãƒ©ãƒ¼å¾Œã‚‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    statusText.innerHTML = `<i class="fas fa-spinner fa-spin text-primary me-2"></i>${displayMessage}`;
                }

                // æ¨å®šæ™‚é–“è¡¨ç¤ºï¼ˆé€²æ—ç‡ã‹ã‚‰è¨ˆç®—ï¼‰
                if (progress > 0 && progress < 100) {
                    const estimatedTotalSeconds = (100 / progress) * (Date.now() - startTime) / 1000;
                    const remainingSeconds = Math.max(0, estimatedTotalSeconds - ((Date.now() - startTime) / 1000));
                    const minutes = Math.floor(remainingSeconds / 60);
                    const seconds = Math.floor(remainingSeconds % 60);

                    if (remainingSeconds > 0) {
                        estimatedTimeElement.textContent = `ç´„${minutes > 0 ? minutes + 'åˆ†' : ''}${seconds}ç§’`;
                    } else {
                        estimatedTimeElement.textContent = 'ã¾ã‚‚ãªãå®Œäº†ã—ã¾ã™...';
                    }
                } else if (progress >= 100) {
                    estimatedTimeElement.textContent = 'å®Œäº†';
                }
            })
            .catch(error => {
                console.error('é€²æ—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            });
        }, 1000);

        // é–‹å§‹æ™‚åˆ»ã‚’è¨˜éŒ²
        const startTime = Date.now();
    }
});

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†
function cancelImport() {
    if (!confirm('æœ¬å½“ã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ\né€²è¡Œä¸­ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚')) {
        return;
    }

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const cancelBtn = document.getElementById('cancelBtn');
    cancelBtn.disabled = true;
    cancelBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>ã‚­ãƒ£ãƒ³ã‚»ãƒ«ä¸­...';

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«APIã‚’å‘¼ã³å‡ºã—
    fetch('{% url "order_management:csv_import_cancel" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('âœ“ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡æˆåŠŸ');
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            document.getElementById('statusText').innerHTML = '<i class="fas fa-times-circle text-danger me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ä¸­...';
        } else {
            console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', data.error);
            alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
            cancelBtn.disabled = false;
            cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        }
    })
    .catch(error => {
        console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«APIã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ');
        cancelBtn.disabled = false;
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
    });
}

// ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«é€²è¡Œä¸­ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒã‚ã‚‹ã‹ç¢ºèª
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ” ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - é€²è¡Œä¸­ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯');

    // é€²è¡Œä¸­ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒã‚ã‚Œã°ã€é€²æ—è¡¨ç¤ºã‚’é–‹å§‹
    fetch('{% url "order_management:csv_import_progress" %}', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        console.log('ğŸ“Š åˆæœŸé€²æ—ç¢ºèª:', data);

        if (data.status === 'processing' || data.status === 'starting') {
            console.log('âœ“ é€²è¡Œä¸­ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’æ¤œå‡º - é€²æ—è¡¨ç¤ºã‚’é–‹å§‹');

            // é€²è¡Œä¸­ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆãŒã‚ã‚‹å ´åˆã€å‡¦ç†ä¸­è¡¨ç¤ºã‚’é–‹å§‹
            document.getElementById('processingAlert').style.display = 'block';
            document.getElementById('submitBtn').disabled = true;
            document.getElementById('submitBtn').innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>å‡¦ç†ä¸­...';

            // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼è¦ç´ ã‚’å–å¾—
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const statusText = document.getElementById('statusText');
            const estimatedTimeElement = document.getElementById('estimatedTime');
            const heartbeat = document.getElementById('heartbeat');

            // ç¾åœ¨ã®é€²æ—ã‚’åæ˜ 
            const progress = data.progress || 0;
            progressBar.style.width = progress + '%';
            progressText.textContent = progress + '%';
            statusText.innerHTML = `<i class="fas fa-spinner fa-spin text-primary me-2"></i>${data.message || 'å‡¦ç†ä¸­...'}`;

            // ãƒ­ã‚°ãŒã‚ã‚Œã°è¡¨ç¤º
            if (data.logs && data.logs.length > 0) {
                updateTerminalLog(data.logs);
            }

            // ãƒãƒ¼ãƒˆãƒ“ãƒ¼ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
            const heartbeatInterval = setInterval(() => {
                heartbeat.style.opacity = heartbeat.style.opacity === '0.3' ? '1' : '0.3';
            }, 800);

            // ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
            const startTime = Date.now();
            const pollInterval = setInterval(() => {
                fetch('{% url "order_management:csv_import_progress" %}', {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('ğŸ“Š Progress:', data);

                    // é€²æ—ç‡ã‚’æ›´æ–°
                    const progress = data.progress || 0;
                    progressBar.style.width = progress + '%';
                    progressBar.setAttribute('aria-valuenow', progress);
                    progressText.textContent = progress + '%';

                    // ãƒ­ã‚°ã‚’æ›´æ–°
                    if (data.logs && data.logs.length > 0) {
                        updateTerminalLog(data.logs);
                    }

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–°
                    const displayMessage = data.message || 'å‡¦ç†ä¸­...';

                    if (data.status === 'completed') {
                        statusText.innerHTML = `<i class="fas fa-check-circle text-success me-2"></i>${displayMessage}`;
                        clearInterval(pollInterval);
                        clearInterval(heartbeatInterval);
                        setTimeout(() => { window.location.reload(); }, 1500);
                    } else if (data.status === 'cancelled') {
                        statusText.innerHTML = `<i class="fas fa-times-circle text-warning me-2"></i>${displayMessage}`;
                        progressBar.classList.remove('bg-primary');
                        progressBar.classList.add('bg-warning');
                        clearInterval(pollInterval);
                        clearInterval(heartbeatInterval);
                        setTimeout(() => { window.location.reload(); }, 1500);
                    } else if (data.status === 'error') {
                        statusText.innerHTML = `<i class="fas fa-exclamation-triangle text-danger me-2"></i>${displayMessage}`;
                        clearInterval(pollInterval);
                        clearInterval(heartbeatInterval);
                        setTimeout(() => { window.location.reload(); }, 2000);
                    } else {
                        statusText.innerHTML = `<i class="fas fa-spinner fa-spin text-primary me-2"></i>${displayMessage}`;
                    }

                    // æ¨å®šæ™‚é–“è¡¨ç¤º
                    if (progress > 0 && progress < 100) {
                        const estimatedTotalSeconds = (100 / progress) * (Date.now() - startTime) / 1000;
                        const remainingSeconds = Math.max(0, estimatedTotalSeconds - ((Date.now() - startTime) / 1000));
                        const minutes = Math.floor(remainingSeconds / 60);
                        const seconds = Math.floor(remainingSeconds % 60);
                        if (remainingSeconds > 0) {
                            estimatedTimeElement.textContent = `ç´„${minutes > 0 ? minutes + 'åˆ†' : ''}${seconds}ç§’`;
                        } else {
                            estimatedTimeElement.textContent = 'ã¾ã‚‚ãªãå®Œäº†ã—ã¾ã™...';
                        }
                    } else if (progress >= 100) {
                        estimatedTimeElement.textContent = 'å®Œäº†';
                    }
                })
                .catch(error => {
                    console.error('é€²æ—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                });
            }, 1000);
        } else {
            console.log('é€²è¡Œä¸­ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“');
        }
    })
    .catch(error => {
        console.error('åˆæœŸé€²æ—ç¢ºèªã‚¨ãƒ©ãƒ¼:', error);
    });
});
</script>
{% endblock %}
