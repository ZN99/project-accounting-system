{% extends 'order_management/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}ä½œæ¥­è€…è¿½åŠ  - {{ project.site_name }}{% endblock %}

{% block extra_css %}
<!-- Toastr CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

<style>
    .form-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .form-section-header {
        border-bottom: 2px solid #3b82f6;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .worker-type-selector {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .worker-type-card {
        flex: 1;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .worker-type-card:hover {
        border-color: #3b82f6;
        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.2);
    }

    .worker-type-card.active {
        border-color: #3b82f6;
        background: #eff6ff;
    }

    .conditional-section {
        display: none;
    }

    .conditional-section.active {
        display: block;
    }

    .pricing-type-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid #e5e7eb !important;
    }

    .pricing-type-card:hover {
        border-color: #3b82f6 !important;
        box-shadow: 0 2px 8px rgba(59, 130, 246, 0.2);
    }

    .pricing-type-card.active {
        border-color: #3b82f6 !important;
        background: #eff6ff;
    }

    .dynamic-item {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.5rem;
    }

    .remove-item-btn {
        cursor: pointer;
        color: #dc3545;
        transition: all 0.2s ease;
    }

    .remove-item-btn:hover {
        color: #a71d2a;
        transform: scale(1.1);
    }

    .cost-breakdown {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-top: 1rem;
    }

    .profit-preview-card {
        position: sticky;
        top: 20px;
        max-height: calc(100vh - 40px);
        overflow-y: auto;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid my-4">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-user-plus text-primary"></i> ä½œæ¥­è€…è¿½åŠ </h2>
            <p class="text-muted mb-0">æ¡ˆä»¶ï¼š{{ project.site_name }}</p>
            <p class="text-muted mb-0 small">å—æ³¨é¡ï¼šÂ¥{{ project.billing_amount|default:0|floatformat:0|intcomma }}</p>
        </div>
        <a href="{% url 'order_management:project_detail' project.pk %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> æ¡ˆä»¶è©³ç´°ã«æˆ»ã‚‹
        </a>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <form method="post" id="addWorkerForm">
                {% csrf_token %}

                <!-- ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—é¸æŠ -->
                <div class="form-section">
                    <div class="form-section-header">
                        <h4><i class="fas fa-users"></i> ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h4>
                    </div>

                    <div class="worker-type-selector">
                        <div class="worker-type-card active" data-type="external">
                            <div class="text-center">
                                <i class="fas fa-building fa-3x text-primary mb-3"></i>
                                <h5>å¤–æ³¨å…ˆ</h5>
                                <p class="text-muted small mb-0">å¤–éƒ¨ã®æ¥­è€…ã«ç™ºæ³¨</p>
                            </div>
                            <input type="radio" name="worker_type" value="external" checked style="display: none;">
                        </div>

                        <div class="worker-type-card" data-type="internal">
                            <div class="text-center">
                                <i class="fas fa-user-tie fa-3x text-success mb-3"></i>
                                <h5>ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹</h5>
                                <p class="text-muted small mb-0">è‡ªç¤¾ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰²ã‚Šå½“ã¦</p>
                            </div>
                            <input type="radio" name="worker_type" value="internal" style="display: none;">
                        </div>
                    </div>
                </div>

                <!-- å¤–æ³¨å…ˆãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="external-form" class="conditional-section active">
                    <div class="form-section">
                        <div class="form-section-header">
                            <h4><i class="fas fa-building"></i> å¤–æ³¨å…ˆæƒ…å ±</h4>
                        </div>

                        <!-- æ—¢å­˜/æ–°è¦é¸æŠ -->
                        <div class="mb-4">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="contractor_input_type" id="existing_contractor" value="existing" checked>
                                <label class="btn btn-outline-primary" for="existing_contractor">
                                    <i class="fas fa-list"></i> æ—¢å­˜ã®å¤–æ³¨å…ˆ
                                </label>

                                <input type="radio" class="btn-check" name="contractor_input_type" id="new_contractor" value="new">
                                <label class="btn btn-outline-primary" for="new_contractor">
                                    <i class="fas fa-plus"></i> æ–°è¦å¤–æ³¨å…ˆ
                                </label>
                            </div>
                        </div>

                        <!-- æ—¢å­˜å¤–æ³¨å…ˆé¸æŠ -->
                        <div id="existing-contractor-section">
                            <div class="mb-3">
                                <label class="form-label">å¤–æ³¨å…ˆã‚’é¸æŠ</label>
                                <div class="d-flex gap-2">
                                    <select class="form-select" name="existing_contractor_id" id="contractorSelect">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                        {% for contractor in contractors %}
                                        <option value="{{ contractor.id }}"
                                                data-name="{{ contractor.name }}"
                                                data-address="{{ contractor.address|default:'' }}"
                                                data-contractor-type="{{ contractor.contractor_type }}"
                                                data-phone="{{ contractor.phone|default:'' }}"
                                                data-email="{{ contractor.email|default:'' }}"
                                                data-contact-person="{{ contractor.contact_person|default:'' }}"
                                                data-specialties="{{ contractor.specialties|default:'' }}"
                                                data-hourly-rate="{{ contractor.hourly_rate|default:'' }}">
                                            {{ contractor.name }}{% if contractor.address %} ({{ contractor.address }}){% endif %}
                                        </option>
                                        {% endfor %}
                                    </select>
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openContractorManagementPanel()" style="white-space: nowrap;">
                                        <i class="fas fa-user-tie"></i> ä¸‹è«‹ã‘ç®¡ç†
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- æ–°è¦å¤–æ³¨å…ˆå…¥åŠ› -->
                        <div id="new-contractor-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">å¤–æ³¨å…ˆå <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="contractor_name" id="contractorName" placeholder="ä¾‹ï¼šâ—‹â—‹å»ºè¨­">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ä½æ‰€</label>
                                    <input type="text" class="form-control" name="contractor_address" id="contractorAddress" placeholder="ä¾‹ï¼šæ±äº¬éƒ½...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¥‘ç´„æƒ…å ±ï¼ˆå¤–æ³¨ï¼‰ -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h4><i class="fas fa-file-contract"></i> å¥‘ç´„æƒ…å ±</h4>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">ä¾é ¼é‡‘é¡ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="number" class="form-control" name="contract_amount" id="externalContractAmountInput" placeholder="0" required>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">è¢«è«‹æ±‚é¡</label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="number" class="form-control" name="billed_amount" id="externalBilledAmountInput" placeholder="0">
                                </div>
                                <small class="form-text text-muted">æœªå…¥åŠ›ã®å ´åˆã¯ä¾é ¼é‡‘é¡ã‚’ä½¿ç”¨ã—ã¾ã™</small>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">å‡ºé‡‘äºˆå®šæ—¥</label>
                                <input type="date" class="form-control" name="payment_due_date">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">å‡ºé‡‘æ—¥</label>
                                <input type="date" class="form-control" name="payment_date">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">å‡ºé‡‘çŠ¶æ³</label>
                                <select class="form-select" name="payment_status">
                                    <option value="pending">æœªæ‰•ã„</option>
                                    <option value="paid">æ”¯æ‰•æ¸ˆã¿</option>
                                    <option value="partial">ä¸€éƒ¨æ‰•ã„</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="purchase_order_issued" id="purchase_order_issued">
                            <label class="form-check-label" for="purchase_order_issued">
                                ç™ºæ³¨æ›¸ç™ºè¡Œæ¸ˆã¿
                            </label>
                        </div>
                    </div>

                    <!-- éƒ¨æè²»ï¼ˆå¤–æ³¨ï¼‰ -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h4><i class="fas fa-box"></i> éƒ¨æè²»æƒ…å ±</h4>
                        </div>

                        <div id="externalMaterialCostSection"></div>

                        <button type="button" class="btn btn-outline-success btn-sm" id="addExternalMaterialBtn">
                            <i class="fas fa-plus"></i> éƒ¨æè²»é …ç›®ã‚’è¿½åŠ 
                        </button>

                        <div class="mt-3">
                            <strong>éƒ¨æè²»åˆè¨ˆ: Â¥<span id="externalMaterialTotal">0</span></strong>
                        </div>
                    </div>

                    <!-- è¿½åŠ è²»ç”¨ï¼ˆå¤–æ³¨ï¼‰ -->
                    <div class="form-section">
                        <div class="form-section-header">
                            <h4><i class="fas fa-plus-circle"></i> è¿½åŠ è²»ç”¨æƒ…å ±</h4>
                        </div>

                        <div id="externalAdditionalCostSection"></div>

                        <button type="button" class="btn btn-outline-warning btn-sm" id="addExternalAdditionalCostBtn">
                            <i class="fas fa-plus"></i> è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ 
                        </button>

                        <div class="mt-3">
                            <strong>è¿½åŠ è²»ç”¨åˆè¨ˆ: Â¥<span id="externalAdditionalCostTotal">0</span></strong>
                        </div>
                    </div>

                    <!-- è²»ç”¨å†…è¨³ï¼ˆå¤–æ³¨ï¼‰ -->
                    <div class="form-section">
                        <div class="cost-breakdown">
                            <h5 class="mb-3"><i class="fas fa-calculator"></i> è²»ç”¨å†…è¨³ï¼ˆå¤–æ³¨ï¼‰</h5>
                            <div class="row mb-2">
                                <div class="col-8">ä¾é ¼é‡‘é¡:</div>
                                <div class="col-4 text-end fw-bold">Â¥<span id="externalContractDisplay">0</span></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-8">è¢«è«‹æ±‚é¡:</div>
                                <div class="col-4 text-end">Â¥<span id="externalBilledDisplay">0</span></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-8">éƒ¨æè²»:</div>
                                <div class="col-4 text-end">Â¥<span id="externalMaterialDisplay">0</span></div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-8">è¿½åŠ è²»ç”¨:</div>
                                <div class="col-4 text-end">Â¥<span id="externalAdditionalDisplay">0</span></div>
                            </div>
                            <hr>
                            <div class="row fw-bold text-primary fs-5">
                                <div class="col-8">ç·åˆè¨ˆ:</div>
                                <div class="col-4 text-end">Â¥<span id="externalGrandTotal">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="internal-form" class="conditional-section">
                    <div class="form-section">
                        <div class="form-section-header">
                            <h4><i class="fas fa-user-tie"></i> ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹æƒ…å ±</h4>
                        </div>

                        <!-- æ—¢å­˜/æ–°è¦é¸æŠ -->
                        <div class="mb-4">
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="internal_input_type" id="existing_internal" value="existing" checked>
                                <label class="btn btn-outline-success" for="existing_internal">
                                    <i class="fas fa-list"></i> æ—¢å­˜ã‚¹ã‚¿ãƒƒãƒ•
                                </label>

                                <input type="radio" class="btn-check" name="internal_input_type" id="new_internal" value="new">
                                <label class="btn btn-outline-success" for="new_internal">
                                    <i class="fas fa-plus"></i> æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•
                                </label>
                            </div>
                        </div>

                        <!-- æ—¢å­˜ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ -->
                        <div id="existing-internal-section">
                            <div class="mb-3">
                                <label class="form-label">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠ</label>
                                <select class="form-select" name="existing_internal_id" id="internalSelect">
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    {% for worker in internal_workers %}
                                    <option value="{{ worker.id }}"
                                            data-name="{{ worker.name }}"
                                            data-department="{{ worker.get_department_display }}"
                                            data-hourly-rate="{{ worker.hourly_rate }}"
                                            data-specialties="{{ worker.specialties }}">
                                        {{ worker.name }} ({{ worker.get_department_display }}) - Â¥{{ worker.hourly_rate|intcomma }}/æ™‚é–“
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•å…¥åŠ› -->
                        <div id="new-internal-section" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">ã‚¹ã‚¿ãƒƒãƒ•å <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="internal_worker_name" id="internalWorkerName" placeholder="ä¾‹ï¼šå±±ç”°å¤ªéƒ">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">éƒ¨ç½²</label>
                                    <input type="text" class="form-control" name="internal_department" id="internalDepartment" placeholder="ä¾‹ï¼šå·¥äº‹éƒ¨">
                                </div>
                            </div>
                        </div>

                        <!-- æ–™é‡‘ä½“ç³»é¸æŠ -->
                        <div class="mb-3">
                            <label class="form-label">æ–™é‡‘ä½“ç³» <span class="text-danger">*</span></label>
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <div class="card pricing-type-card active" id="hourlyCard">
                                        <div class="card-body text-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="internal_pricing_type" id="hourlyPricing" value="hourly" checked>
                                                <label class="form-check-label fw-bold" for="hourlyPricing">
                                                    <i class="fas fa-clock me-1"></i>æ™‚çµ¦ãƒ™ãƒ¼ã‚¹
                                                </label>
                                            </div>
                                            <small class="text-muted">æ™‚çµ¦ Ã— å·¥æ•°ã§è¨ˆç®—</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card pricing-type-card" id="projectCard">
                                        <div class="card-body text-center">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="internal_pricing_type" id="projectPricing" value="project">
                                                <label class="form-check-label fw-bold" for="projectPricing">
                                                    <i class="fas fa-file-invoice me-1"></i>æ¡ˆä»¶å˜ä½
                                                </label>
                                            </div>
                                            <small class="text-muted">å›ºå®šé‡‘é¡ã§è¨ˆç®—</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                        <div id="hourlyPricingFields">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">æ™‚çµ¦å˜ä¾¡ <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        <input type="number" class="form-control" name="internal_hourly_rate" id="internalHourlyRate" placeholder="3000">
                                        <span class="input-group-text">/æ™‚é–“</span>
                                    </div>
                                    <small class="text-muted">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰è‡ªå‹•å…¥åŠ›å¯èƒ½</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">è¦‹ç©å·¥æ•° <span class="text-danger">*</span></label>
                                    <div class="input-group">
                                        <input type="number" class="form-control" name="estimated_hours" id="estimatedHours" step="0.5" placeholder="8.0">
                                        <span class="input-group-text">æ™‚é–“</span>
                                    </div>
                                    <small class="text-muted">äºˆæƒ³ã•ã‚Œã‚‹ä½œæ¥­æ™‚é–“</small>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <small><i class="fas fa-calculator me-1"></i>åŸºæœ¬æ–™é‡‘: <strong>æ™‚çµ¦ Ã— å·¥æ•°</strong> ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™</small>
                            </div>
                        </div>

                        <!-- æ¡ˆä»¶å˜ä½ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                        <div id="projectPricingFields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">å¥‘ç´„é‡‘é¡ <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="number" class="form-control" name="project_contract_amount" id="projectContractAmount" placeholder="100000">
                                </div>
                                <small class="text-muted">æ¡ˆä»¶å…¨ä½“ã®å›ºå®šé‡‘é¡ã‚’å…¥åŠ›</small>
                            </div>
                            <div class="alert alert-success">
                                <small><i class="fas fa-handshake me-1"></i>æ¡ˆä»¶å˜ä½ã§ã¯<strong>å›ºå®šé‡‘é¡</strong>ã§å¥‘ç´„ã—ã¾ã™</small>
                            </div>
                        </div>

                        <!-- ç¨è¾¼/ç¨æŠœé¸æŠ -->
                        <div class="mb-3">
                            <label class="form-label">ç¨è¾¼/ç¨æŠœ <span class="text-danger">*</span></label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="tax_type" id="taxInclude" value="include" checked>
                                <label class="btn btn-outline-secondary" for="taxInclude">ç¨è¾¼</label>

                                <input type="radio" class="btn-check" name="tax_type" id="taxExclude" value="exclude">
                                <label class="btn btn-outline-secondary" for="taxExclude">ç¨æŠœ</label>
                            </div>
                        </div>

                        <!-- å‹•çš„è²»ç”¨é …ç›®ï¼ˆç¤¾å†…ï¼‰ -->
                        <div class="mb-3">
                            <label class="form-label" id="costItemsLabel">è¿½åŠ è²»ç”¨é …ç›®</label>
                            <div id="costItemsSection"></div>
                            <button type="button" class="btn btn-outline-info btn-sm" id="addCostItemBtn">
                                <i class="fas fa-plus"></i> <span id="addCostItemText">è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ </span>
                            </button>
                            <div class="mt-2">
                                <strong id="costItemsLabel2">è¿½åŠ è²»ç”¨åˆè¨ˆ: Â¥<span id="costItemsTotal">0</span></strong>
                            </div>
                        </div>

                        <!-- ä½œæ¥­è²»ç”¨ -->
                        <div class="mb-3">
                            <label class="form-label" id="contractAmountLabel">ä½œæ¥­è²»ç”¨ <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">Â¥</span>
                                <input type="number" class="form-control" name="contract_amount" id="internalContractAmount" value="0" min="0" required>
                            </div>
                            <small class="text-muted" id="contractAmountHint">æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ã®å ´åˆã¯æ™‚çµ¦ Ã— å·¥æ•° + è¿½åŠ è²»ç”¨ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™</small>
                            <div class="invalid-feedback">ä½œæ¥­è²»ç”¨ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>
                        </div>

                        <!-- å‡ºé‡‘æƒ…å ±ï¼ˆç¤¾å†…ï¼‰ -->
                        <hr>
                        <h6><i class="fas fa-credit-card"></i> å‡ºé‡‘æƒ…å ±</h6>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">å‡ºé‡‘äºˆå®šæ—¥</label>
                                <input type="date" class="form-control" name="payment_due_date">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">å‡ºé‡‘æ—¥</label>
                                <input type="date" class="form-control" name="payment_date">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">å‡ºé‡‘çŠ¶æ³</label>
                                <select class="form-select" name="payment_status">
                                    <option value="pending">æœªæ‰•ã„</option>
                                    <option value="processing">å‡¦ç†ä¸­</option>
                                    <option value="paid">æ”¯æ‰•æ¸ˆã¿</option>
                                </select>
                            </div>
                        </div>

                        <!-- éƒ¨æè²»ï¼ˆç¤¾å†…ï¼‰ -->
                        <hr>
                        <h6><i class="fas fa-box"></i> éƒ¨æè²»æƒ…å ±</h6>
                        <div id="materialCostSection"></div>
                        <button type="button" class="btn btn-outline-success btn-sm" id="addMaterialBtn">
                            <i class="fas fa-plus"></i> éƒ¨æè²»é …ç›®ã‚’è¿½åŠ 
                        </button>
                        <div class="mt-2">
                            <strong>éƒ¨æè²»åˆè¨ˆ: Â¥<span id="materialTotal">0</span></strong>
                        </div>
                    </div>

                    <!-- è²»ç”¨å†…è¨³ï¼ˆç¤¾å†…ï¼‰ -->
                    <div class="form-section">
                        <div class="cost-breakdown" id="costBreakdown">
                            <h5 class="mb-3"><i class="fas fa-calculator"></i> è²»ç”¨å†…è¨³</h5>

                            <!-- æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ã®å ´åˆ -->
                            <div id="hourlyBreakdown">
                                <div class="row mb-2">
                                    <div class="col-8">åŸºæœ¬æ–™é‡‘ï¼ˆæ™‚çµ¦ Ã— å·¥æ•°ï¼‰:</div>
                                    <div class="col-4 text-end">Â¥<span id="baseAmount">0</span></div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-8">è¿½åŠ è²»ç”¨:</div>
                                    <div class="col-4 text-end">Â¥<span id="additionalAmount">0</span></div>
                                </div>
                                <hr>
                                <div class="row mb-2 fw-bold">
                                    <div class="col-8">ä½œæ¥­è²»ç”¨å°è¨ˆ:</div>
                                    <div class="col-4 text-end">Â¥<span id="workSubtotal">0</span></div>
                                </div>
                            </div>

                            <!-- æ¡ˆä»¶å˜ä½ã®å ´åˆ -->
                            <div id="projectBreakdown" style="display: none;">
                                <div class="row mb-2 fw-bold">
                                    <div class="col-8">ä½œæ¥­è²»ç”¨å°è¨ˆ:</div>
                                    <div class="col-4 text-end">Â¥<span id="projectSubtotal">0</span></div>
                                </div>
                            </div>

                            <!-- éƒ¨æè²» -->
                            <div class="row mb-2">
                                <div class="col-8">éƒ¨æè²»:</div>
                                <div class="col-4 text-end">Â¥<span id="materialSubtotal">0</span></div>
                            </div>

                            <hr>
                            <div class="row fw-bold text-primary fs-5">
                                <div class="col-8">ç·åˆè¨ˆ:</div>
                                <div class="col-4 text-end">Â¥<span id="grandTotal">0</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- é€ä¿¡ãƒœã‚¿ãƒ³ -->
                <div class="form-section">
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'order_management:project_detail' project.pk %}" class="btn btn-secondary">
                            <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save"></i> <span id="submitButtonText">ä½œæ¥­è€…ã‚’è¿½åŠ </span>
                        </button>
                    </div>
                </div>
            </form>

            <!-- æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ï¼‰ -->
            {% include 'order_management/includes/contractor_add_modal.html' %}

            <!-- æ¥­è€…ç®¡ç†ãƒ‘ãƒãƒ«ï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ï¼‰ -->
            {% include 'order_management/includes/contractor_management_panel.html' %}
        </div>

        <!-- å³å´ï¼šåˆ©ç›Šç‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
        <div class="col-lg-4">
            <div class="card border-primary shadow-sm profit-preview-card" id="profitPreview">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line"></i> æš«å®šåˆ©ç›Šç‡åˆ†æï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <tbody>
                                <tr class="table-success">
                                    <td><strong>å£²ä¸Šï¼ˆå—æ³¨é¡ï¼‰</strong></td>
                                    <td class="text-end"><strong>Â¥<span id="previewRevenue">{{ project.billing_amount|default:0|floatformat:0|intcomma }}</span></strong></td>
                                </tr>
                                <tr>
                                    <td colspan="2"><strong>æ”¯å‡ºå†…è¨³</strong></td>
                                </tr>
                                <tr>
                                    <td class="ps-3">æ—¢å­˜ä½œæ¥­è²»ç”¨</td>
                                    <td class="text-end">Â¥<span id="previewExistingCost">{{ existing_total_cost|floatformat:0|intcomma }}</span></td>
                                </tr>
                                {% for sc in existing_subcontracts %}
                                <tr class="small text-muted">
                                    <td class="ps-5">
                                        {% if sc.contractor %}
                                            â”” {{ sc.contractor.name }}
                                        {% elif sc.internal_worker_name %}
                                            â”” {{ sc.internal_worker_name }}ï¼ˆç¤¾å†…ï¼‰
                                        {% else %}
                                            â”” æœªè¨­å®š
                                        {% endif %}
                                    </td>
                                    <td class="text-end">Â¥{{ sc.get_total_cost|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                                <tr>
                                    <td colspan="2" class="ps-3 pt-2"><strong>ä»Šå›è¿½åŠ åˆ†ï¼š<span id="selectedContractorName" class="text-primary"></span></strong></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">ãƒ»ä¾é ¼é‡‘é¡/å¥‘ç´„é‡‘é¡</td>
                                    <td class="text-end">Â¥<span id="previewNewBaseCost">0</span></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">ãƒ»è¿½åŠ è²»ç”¨</td>
                                    <td class="text-end">Â¥<span id="previewNewAdditionalCost">0</span></td>
                                </tr>
                                <tr>
                                    <td class="ps-4">ãƒ»éƒ¨æè²»</td>
                                    <td class="text-end">Â¥<span id="previewNewMaterialCost">0</span></td>
                                </tr>
                                <tr class="table-light">
                                    <td class="ps-3"><strong>è¿½åŠ åˆ†å°è¨ˆ</strong></td>
                                    <td class="text-end"><strong>Â¥<span id="previewNewWorkCost">0</span></strong></td>
                                </tr>
                                <tr class="table-warning">
                                    <td><strong>ç·æ”¯å‡º</strong></td>
                                    <td class="text-end"><strong>Â¥<span id="previewTotalCost">{{ existing_total_cost|floatformat:0|intcomma }}</span></strong></td>
                                </tr>
                                <tr class="table-primary">
                                    <td><strong>ç²—åˆ©ç›Š</strong></td>
                                    <td class="text-end"><strong>Â¥<span id="previewGrossProfit">0</span></strong></td>
                                </tr>
                                <tr class="table-info">
                                    <td><strong>åˆ©ç›Šç‡</strong></td>
                                    <td class="text-end">
                                        <strong class="fs-4" id="previewProfitRate">0%</strong>
                                        <div class="progress mt-1" style="height: 10px;">
                                            <div class="progress-bar" id="profitRateBar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-info mt-3 mb-0">
                        <small><i class="fas fa-info-circle"></i> å…¥åŠ›å€¤ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åæ˜ ã—ã¾ã™</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% load l10n %}
<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let materialItemCounter = 0;
let additionalCostCounter = 0;
let costItemCounter = 0;
const revenue = parseFloat("{{ project.billing_amount|unlocalize|default:0 }}") || 0;  // å—æ³¨é¡ï¼ˆå£²ä¸Šï¼‰
const existingCost = parseFloat("{{ existing_total_cost|unlocalize|default:0 }}") || 0;
console.log('ğŸ“Š åˆæœŸå€¤:', { revenue, existingCost });

$(document).ready(function() {
    // ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
    $('.worker-type-card').on('click', function() {
        $('.worker-type-card').removeClass('active');
        $(this).addClass('active');
        $(this).find('input[type="radio"]').prop('checked', true);

        const type = $(this).data('type');
        $('.conditional-section').removeClass('active');
        $(`#${type}-form`).addClass('active');

        // é¸æŠã—ãŸä½œæ¥­è€…åã‚’ã‚¯ãƒªã‚¢ï¼ˆåˆ‡ã‚Šæ›¿ãˆæ™‚ï¼‰
        $('#selectedContractorName').text('');

        // åˆ©ç›Šç‡ã‚’å†è¨ˆç®—
        updateProfitPreview();
    });

    // å¤–æ³¨å…ˆï¼šæ—¢å­˜/æ–°è¦åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="contractor_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existing-contractor-section').show();
            $('#new-contractor-section').hide();
            // æ—¢å­˜é¸æŠã®å ´åˆã¯é¸æŠä¸­ã®æ¥­è€…åã‚’è¡¨ç¤º
            const selectedName = $('#contractorSelect option:selected').data('name') || '';
            if (selectedName) {
                $('#selectedContractorName').text('ã€' + selectedName + 'ã€‘');
            } else {
                $('#selectedContractorName').text('');
            }
        } else {
            $('#existing-contractor-section').hide();
            $('#new-contractor-section').show();
            // æ–°è¦ã®å ´åˆã¯å…¥åŠ›ä¸­ã®åå‰ã‚’è¡¨ç¤º
            const newName = $('#contractorName').val().trim();
            if (newName) {
                $('#selectedContractorName').text('ã€' + newName + 'ã€‘');
            } else {
                $('#selectedContractorName').text('');
            }
        }
    });

    // æ—¢å­˜å¤–æ³¨å…ˆé¸æŠæ™‚ã«ä½æ‰€ã‚’è‡ªå‹•å…¥åŠ›
    $('#contractorSelect').on('change', function() {
        const selected = $(this).find('option:selected');
        const address = selected.data('address') || '';
        const name = selected.data('name') || '';
        $('#contractorAddress').val(address);
        $('#contractorName').val(name);

        // æš«å®šåˆ©ç›Šç‡åˆ†æã«é¸æŠã—ãŸå¤–æ³¨å…ˆåã‚’è¡¨ç¤º
        if (name) {
            $('#selectedContractorName').text('ã€' + name + 'ã€‘');
        } else {
            $('#selectedContractorName').text('');
        }
    });

    // æ–°è¦å¤–æ³¨å…ˆåã®å…¥åŠ›æ™‚ã«æš«å®šåˆ©ç›Šç‡åˆ†æã«è¡¨ç¤º
    $('#contractorName').on('input', function() {
        const name = $(this).val().trim();
        if (name) {
            $('#selectedContractorName').text('ã€' + name + 'ã€‘');
        } else {
            $('#selectedContractorName').text('');
        }
    });

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ï¼šæ—¢å­˜/æ–°è¦åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="internal_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existing-internal-section').show();
            $('#new-internal-section').hide();
            // æ—¢å­˜é¸æŠã®å ´åˆã¯é¸æŠä¸­ã®ã‚¹ã‚¿ãƒƒãƒ•åã‚’è¡¨ç¤º
            const selectedName = $('#internalSelect option:selected').data('name') || '';
            if (selectedName) {
                $('#selectedContractorName').text('ã€' + selectedName + 'ï¼ˆç¤¾å†…ï¼‰ã€‘');
            } else {
                $('#selectedContractorName').text('');
            }
        } else {
            $('#existing-internal-section').hide();
            $('#new-internal-section').show();
            // æ–°è¦å…¥åŠ›ã®å ´åˆã¯å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’ä½¿ç”¨
            const name = $('#internalWorkerName').val().trim();
            if (name) {
                $('#selectedContractorName').text('ã€' + name + 'ï¼ˆç¤¾å†…ï¼‰ã€‘');
            } else {
                $('#selectedContractorName').text('');
            }
        }
    });

    // æ–°è¦ç¤¾å†…ã‚¹ã‚¿ãƒƒãƒ•åã®å…¥åŠ›æ™‚ã«æš«å®šåˆ©ç›Šç‡åˆ†æã«è¡¨ç¤º
    $('#internalWorkerName').on('input', function() {
        const name = $(this).val().trim();
        if (name) {
            $('#selectedContractorName').text('ã€' + name + 'ï¼ˆç¤¾å†…ï¼‰ã€‘');
        } else {
            $('#selectedContractorName').text('');
        }
    });

    // æ—¢å­˜ç¤¾å†…ã‚¹ã‚¿ãƒƒãƒ•é¸æŠæ™‚ã«æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
    $('#internalSelect').on('change', function() {
        const selected = $(this).find('option:selected');
        const name = selected.data('name') || '';
        const department = selected.data('department') || '';
        const hourlyRate = selected.data('hourly-rate') || '';

        $('#internalWorkerName').val(name);
        $('#internalDepartment').val(department);
        $('#internalHourlyRate').val(hourlyRate);

        // æš«å®šåˆ©ç›Šç‡åˆ†æã«é¸æŠã—ãŸã‚¹ã‚¿ãƒƒãƒ•åã‚’è¡¨ç¤º
        if (name) {
            $('#selectedContractorName').text('ã€' + name + 'ï¼ˆç¤¾å†…ï¼‰ã€‘');
        } else {
            $('#selectedContractorName').text('');
        }

        // æ™‚çµ¦ãŒå¤‰æ›´ã•ã‚ŒãŸã®ã§è¨ˆç®—ã‚’æ›´æ–°
        calculateInternalCosts();
    });

    // æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ï¼‰
    $('.pricing-type-card').on('click', function() {
        $('.pricing-type-card').removeClass('active');
        $(this).addClass('active');
        $(this).find('input[type="radio"]').prop('checked', true).trigger('change');
    });

    // æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ï¼‰
    $('input[name="internal_pricing_type"]').on('change', function() {
        const pricingType = $(this).val();

        if (pricingType === 'hourly') {
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
            $('#hourlyBreakdown').show();
            $('#projectBreakdown').hide();
            $('#costItemsLabel').text('è¿½åŠ è²»ç”¨é …ç›®');
            $('#addCostItemText').text('è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ');
            $('#costItemsLabel2').text('è¿½åŠ è²»ç”¨åˆè¨ˆ: Â¥');
            $('#contractAmountHint').text('æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ã®å ´åˆã¯æ™‚çµ¦ Ã— å·¥æ•° + è¿½åŠ è²»ç”¨ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™');
        } else {
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
            $('#hourlyBreakdown').hide();
            $('#projectBreakdown').show();
            $('#costItemsLabel').text('è²»ç”¨é …ç›®');
            $('#addCostItemText').text('è²»ç”¨é …ç›®ã‚’è¿½åŠ ');
            $('#costItemsLabel2').text('è²»ç”¨é …ç›®åˆè¨ˆ: Â¥');
            $('#contractAmountHint').text('æ¡ˆä»¶å˜ä½ã®å ´åˆã¯è²»ç”¨é …ç›®ã®åˆè¨ˆãŒå¥‘ç´„é‡‘é¡ã«ãªã‚Šã¾ã™');
        }

        calculateInternalCosts();
    });

    // æ™‚çµ¦ãƒ»å·¥æ•°ã®å…¥åŠ›ã§è‡ªå‹•è¨ˆç®—
    $('#internalHourlyRate, #estimatedHours').on('input', function() {
        calculateInternalCosts();
    });

    // æ¡ˆä»¶å˜ä½ã®å¥‘ç´„é‡‘é¡å…¥åŠ›
    $('#projectContractAmount').on('input', function() {
        calculateInternalCosts();
    });

    // å¤–æ³¨å…ˆã®é‡‘é¡å…¥åŠ›
    $('#externalContractAmountInput, #externalBilledAmountInput').on('input', function() {
        calculateExternalCosts();
    });

    // å¤–æ³¨å…ˆï¼šéƒ¨æè²»è¿½åŠ 
    $('#addExternalMaterialBtn').on('click', function() {
        materialItemCounter++;
        const html = `
            <div class="dynamic-item" data-id="${materialItemCounter}">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="material_items[]" placeholder="å“ç›®åï¼ˆä¾‹ï¼šé¤Šç”Ÿãƒ†ãƒ¼ãƒ—ï¼‰">
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control external-material-cost-input" name="material_costs[]" placeholder="0">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <i class="fas fa-trash remove-item-btn" data-id="${materialItemCounter}"></i>
                    </div>
                </div>
            </div>
        `;
        $('#externalMaterialCostSection').append(html);
    });

    // å¤–æ³¨å…ˆï¼šè¿½åŠ è²»ç”¨è¿½åŠ 
    $('#addExternalAdditionalCostBtn').on('click', function() {
        additionalCostCounter++;
        const html = `
            <div class="dynamic-item" data-id="${additionalCostCounter}">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="additional_cost_items[]" placeholder="è²»ç”¨åï¼ˆä¾‹ï¼šäº¤é€šè²»ï¼‰">
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control external-additional-cost-input" name="additional_cost_amounts[]" placeholder="0">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <i class="fas fa-trash remove-item-btn" data-id="${additionalCostCounter}"></i>
                    </div>
                </div>
            </div>
        `;
        $('#externalAdditionalCostSection').append(html);
    });

    // ç¤¾å†…ï¼šè²»ç”¨é …ç›®è¿½åŠ 
    $('#addCostItemBtn').on('click', function() {
        costItemCounter++;
        const html = `
            <div class="dynamic-item" data-id="${costItemCounter}">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="cost_items[]" placeholder="é …ç›®å">
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control cost-item-input" name="cost_amounts[]" placeholder="0">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <i class="fas fa-trash remove-item-btn" data-id="${costItemCounter}"></i>
                    </div>
                </div>
            </div>
        `;
        $('#costItemsSection').append(html);
    });

    // ç¤¾å†…ï¼šéƒ¨æè²»è¿½åŠ 
    $('#addMaterialBtn').on('click', function() {
        const id = Date.now();
        const html = `
            <div class="dynamic-item" data-id="${id}">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="internal_material_items[]" placeholder="å“ç›®å">
                    </div>
                    <div class="col-md-5">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control internal-material-cost-input" name="internal_material_costs[]" placeholder="0">
                        </div>
                    </div>
                    <div class="col-md-1">
                        <i class="fas fa-trash remove-item-btn" data-id="${id}"></i>
                    </div>
                </div>
            </div>
        `;
        $('#materialCostSection').append(html);
    });

    // å‹•çš„é …ç›®å‰Šé™¤
    $(document).on('click', '.remove-item-btn', function() {
        const id = $(this).data('id');
        $(`.dynamic-item[data-id="${id}"]`).remove();
        calculateExternalCosts();
        calculateInternalCosts();
        updateProfitPreview();
    });

    // å‹•çš„å…¥åŠ›ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.external-material-cost-input, .external-additional-cost-input', function() {
        calculateExternalCosts();
    });

    $(document).on('input', '.cost-item-input, .internal-material-cost-input', function() {
        calculateInternalCosts();
    });

    // å¤–æ³¨å…ˆè²»ç”¨è¨ˆç®—
    function calculateExternalCosts() {
        const contractAmount = parseFloat($('#externalContractAmountInput').val()) || 0;
        const billedAmount = parseFloat($('#externalBilledAmountInput').val()) || 0;

        let materialTotal = 0;
        $('.external-material-cost-input').each(function() {
            materialTotal += parseFloat($(this).val()) || 0;
        });

        let additionalTotal = 0;
        $('.external-additional-cost-input').each(function() {
            additionalTotal += parseFloat($(this).val()) || 0;
        });

        // è¢«è«‹æ±‚é¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ä¾é ¼é‡‘é¡ã‚’ä½¿ç”¨
        const baseAmount = billedAmount > 0 ? billedAmount : contractAmount;
        const grandTotal = baseAmount + materialTotal + additionalTotal;

        $('#externalMaterialTotal').text(materialTotal.toLocaleString());
        $('#externalAdditionalCostTotal').text(additionalTotal.toLocaleString());
        $('#externalContractDisplay').text(contractAmount.toLocaleString());
        $('#externalBilledDisplay').text(billedAmount.toLocaleString());
        $('#externalMaterialDisplay').text(materialTotal.toLocaleString());
        $('#externalAdditionalDisplay').text(additionalTotal.toLocaleString());
        $('#externalGrandTotal').text(grandTotal.toLocaleString());

        updateProfitPreview();
    }

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹è²»ç”¨è¨ˆç®—
    function calculateInternalCosts() {
        const pricingType = $('input[name="internal_pricing_type"]:checked').val();
        let workCost = 0;
        let costItemsTotal = 0;
        let materialTotal = 0;

        // è²»ç”¨é …ç›®ã®åˆè¨ˆ
        $('.cost-item-input').each(function() {
            costItemsTotal += parseFloat($(this).val()) || 0;
        });

        // éƒ¨æè²»ã®åˆè¨ˆ
        $('.internal-material-cost-input').each(function() {
            materialTotal += parseFloat($(this).val()) || 0;
        });

        if (pricingType === 'hourly') {
            const hourlyRate = parseFloat($('#internalHourlyRate').val()) || 0;
            const hours = parseFloat($('#estimatedHours').val()) || 0;
            const baseAmount = hourlyRate * hours;

            workCost = baseAmount + costItemsTotal;

            $('#baseAmount').text(baseAmount.toLocaleString());
            $('#additionalAmount').text(costItemsTotal.toLocaleString());
            $('#workSubtotal').text(workCost.toLocaleString());
        } else {
            workCost = parseFloat($('#projectContractAmount').val()) || costItemsTotal;
            $('#projectSubtotal').text(workCost.toLocaleString());
        }

        const grandTotal = workCost + materialTotal;

        $('#costItemsTotal').text(costItemsTotal.toLocaleString());
        $('#materialTotal').text(materialTotal.toLocaleString());
        $('#materialSubtotal').text(materialTotal.toLocaleString());
        $('#grandTotal').text(grandTotal.toLocaleString());
        $('#internalContractAmount').val(workCost);

        updateProfitPreview();
    }

    // åˆ©ç›Šç‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
    function updateProfitPreview() {
        console.log('ğŸ“Š åˆ©ç›Šç‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°é–‹å§‹');
        console.log('å—æ³¨é¡ (revenue):', revenue);
        console.log('æ—¢å­˜è²»ç”¨ (existingCost):', existingCost);

        let newBaseCost = 0;        // åŸºæœ¬ä½œæ¥­è²»ç”¨ï¼ˆä¾é ¼é‡‘é¡ã¾ãŸã¯å¥‘ç´„é‡‘é¡ï¼‰
        let newAdditionalCost = 0;  // è¿½åŠ è²»ç”¨
        let newMaterialCost = 0;    // éƒ¨æè²»

        const workerType = $('input[name="worker_type"]:checked').val();
        console.log('ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—:', workerType);

        if (workerType === 'external') {
            const contractAmount = parseFloat($('#externalContractAmountInput').val()) || 0;
            const billedAmount = parseFloat($('#externalBilledAmountInput').val()) || 0;
            // è¢«è«‹æ±‚é¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°ä¾é ¼é‡‘é¡ã‚’ä½¿ç”¨
            newBaseCost = billedAmount > 0 ? billedAmount : contractAmount;

            console.log('å¤–æ³¨å…ˆ:', {
                'ä¾é ¼é‡‘é¡': contractAmount,
                'è¢«è«‹æ±‚é¡': billedAmount,
                'åŸºæœ¬è²»ç”¨ï¼ˆmaxï¼‰': newBaseCost
            });

            $('.external-material-cost-input').each(function() {
                const val = parseFloat($(this).val()) || 0;
                newMaterialCost += val;
                if (val > 0) console.log('éƒ¨æè²»é …ç›®:', val);
            });

            $('.external-additional-cost-input').each(function() {
                const val = parseFloat($(this).val()) || 0;
                newAdditionalCost += val;
                if (val > 0) console.log('è¿½åŠ è²»ç”¨é …ç›®:', val);
            });

            console.log('å¤–æ³¨å…ˆåˆè¨ˆ:', {
                'éƒ¨æè²»': newMaterialCost,
                'è¿½åŠ è²»ç”¨': newAdditionalCost
            });
        } else {
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®å ´åˆ
            const pricingType = $('input[name="internal_pricing_type"]:checked').val();
            console.log('ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹æ–™é‡‘ä½“ç³»:', pricingType);

            if (pricingType === 'hourly') {
                const hourlyRate = parseFloat($('#internalHourlyRate').val()) || 0;
                const hours = parseFloat($('#estimatedHours').val()) || 0;
                newBaseCost = hourlyRate * hours;

                console.log('æ™‚çµ¦ãƒ™ãƒ¼ã‚¹:', {
                    'æ™‚çµ¦': hourlyRate,
                    'å·¥æ•°': hours,
                    'åŸºæœ¬æ–™é‡‘': newBaseCost
                });

                // è¿½åŠ è²»ç”¨é …ç›®
                $('.cost-item-input').each(function() {
                    const val = parseFloat($(this).val()) || 0;
                    newAdditionalCost += val;
                    if (val > 0) console.log('è²»ç”¨é …ç›®:', val);
                });
            } else {
                // æ¡ˆä»¶å˜ä½ã®å ´åˆ
                newBaseCost = parseFloat($('#projectContractAmount').val()) || 0;
                console.log('æ¡ˆä»¶å˜ä½:', { 'å¥‘ç´„é‡‘é¡': newBaseCost });
            }

            $('.internal-material-cost-input').each(function() {
                const val = parseFloat($(this).val()) || 0;
                newMaterialCost += val;
                if (val > 0) console.log('éƒ¨æè²»é …ç›®:', val);
            });

            console.log('ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹åˆè¨ˆ:', {
                'åŸºæœ¬è²»ç”¨': newBaseCost,
                'è¿½åŠ è²»ç”¨': newAdditionalCost,
                'éƒ¨æè²»': newMaterialCost
            });
        }

        const newWorkCost = newBaseCost + newAdditionalCost;  // ä½œæ¥­è²»ç”¨åˆè¨ˆï¼ˆéƒ¨æè²»é™¤ãï¼‰
        const newTotalCost = newWorkCost + newMaterialCost;   // è¿½åŠ åˆ†ç·é¡
        const totalCost = existingCost + newTotalCost;        // å…¨ä½“ã®ç·æ”¯å‡º
        const grossProfit = revenue - totalCost;
        const profitRate = revenue > 0 ? (grossProfit / revenue) * 100 : 0;

        console.log('è¨ˆç®—çµæœ:', {
            'åŸºæœ¬ä½œæ¥­è²»ç”¨': newBaseCost,
            'è¿½åŠ è²»ç”¨': newAdditionalCost,
            'éƒ¨æè²»': newMaterialCost,
            'ä½œæ¥­è²»ç”¨åˆè¨ˆ': newWorkCost,
            'è¿½åŠ åˆ†ç·é¡': newTotalCost,
            'ç·æ”¯å‡º': totalCost,
            'ç²—åˆ©ç›Š': grossProfit,
            'åˆ©ç›Šç‡': profitRate.toFixed(1) + '%'
        });

        // è¡¨ç¤ºã‚’æ›´æ–°
        $('#previewNewBaseCost').text(newBaseCost.toLocaleString());
        $('#previewNewAdditionalCost').text(newAdditionalCost.toLocaleString());
        $('#previewNewMaterialCost').text(newMaterialCost.toLocaleString());
        $('#previewNewWorkCost').text(newTotalCost.toLocaleString());  // è¿½åŠ åˆ†å°è¨ˆï¼ˆå…¨ã¦å«ã‚€ï¼‰
        $('#previewTotalCost').text(totalCost.toLocaleString());
        $('#previewGrossProfit').text(grossProfit.toLocaleString());
        $('#previewProfitRate').text(profitRate.toFixed(1) + '%');

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
        const displayRate = Math.min(Math.abs(profitRate), 100);
        $('#profitRateBar').css('width', displayRate + '%');

        // è‰²ã®å¤‰æ›´
        const rateElement = $('#previewProfitRate');
        const progressBar = $('#profitRateBar');

        rateElement.removeClass('text-success text-warning text-danger');
        progressBar.removeClass('bg-success bg-warning bg-danger');

        if (profitRate >= 20) {
            rateElement.addClass('text-success');
            progressBar.addClass('bg-success');
        } else if (profitRate >= 10) {
            rateElement.addClass('text-warning');
            progressBar.addClass('bg-warning');
        } else {
            rateElement.addClass('text-danger');
            progressBar.addClass('bg-danger');
        }
    }

    // åˆæœŸè¨ˆç®—
    updateProfitPreview();

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    $('#addWorkerForm').on('submit', function(e) {
        const workerType = $('input[name="worker_type"]:checked').val();
        let isValid = true;
        let errorMessage = '';

        console.log('ğŸš€ ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–‹å§‹');
        console.log('ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—:', workerType);
        console.log('=== ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒãƒƒã‚°æƒ…å ± ===');

        // å¤–æ³¨å…ˆã®å ´åˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (workerType === 'external') {
            console.log('å¤–æ³¨å…ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            const contractorInputType = $('input[name="contractor_input_type"]:checked').val();
            console.log('  å…¥åŠ›ã‚¿ã‚¤ãƒ—:', contractorInputType);

            if (contractorInputType === 'existing') {
                const contractorId = $('#contractorSelect').val();
                console.log('  æ¥­è€…ID:', contractorId);
                if (!contractorId) {
                    isValid = false;
                    errorMessage = 'å¤–æ³¨å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„';
                }
            } else {
                const contractorName = $('#contractorName').val();
                console.log('  æ¥­è€…å:', contractorName);
                if (!contractorName || !contractorName.trim()) {
                    isValid = false;
                    errorMessage = 'å¤–æ³¨å…ˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
            }

            const contractAmount = parseFloat($('#externalContractAmountInput').val());
            console.log('  ä¾é ¼é‡‘é¡:', contractAmount);
            if (!contractAmount || contractAmount <= 0) {
                isValid = false;
                errorMessage = 'ä¾é ¼é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            }
        }
        // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®å ´åˆã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        else {
            console.log('ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            const internalInputType = $('input[name="internal_input_type"]:checked').val();
            console.log('  å…¥åŠ›ã‚¿ã‚¤ãƒ—:', internalInputType);

            if (internalInputType === 'existing') {
                const internalId = $('#internalSelect').val();
                console.log('  ã‚¹ã‚¿ãƒƒãƒ•ID:', internalId);
                if (!internalId) {
                    isValid = false;
                    errorMessage = 'ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„';
                }
            } else {
                const workerName = $('#internalWorkerName').val();
                console.log('  ã‚¹ã‚¿ãƒƒãƒ•å:', workerName);
                if (!workerName || !workerName.trim()) {
                    isValid = false;
                    errorMessage = 'ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                }
            }

            const pricingType = $('input[name="internal_pricing_type"]:checked').val();
            console.log('  æ–™é‡‘ä½“ç³»:', pricingType);

            if (pricingType === 'hourly') {
                const hourlyRate = parseFloat($('#internalHourlyRate').val());
                const hours = parseFloat($('#estimatedHours').val());
                console.log('  æ™‚çµ¦:', hourlyRate, 'å††/æ™‚');
                console.log('  å·¥æ•°:', hours, 'æ™‚é–“');

                if (!hourlyRate || hourlyRate <= 0) {
                    isValid = false;
                    errorMessage = 'æ™‚çµ¦å˜ä¾¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    console.error('âŒ æ™‚çµ¦å˜ä¾¡ã‚¨ãƒ©ãƒ¼');
                } else if (!hours || hours <= 0) {
                    isValid = false;
                    errorMessage = 'è¦‹ç©å·¥æ•°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    console.error('âŒ è¦‹ç©å·¥æ•°ã‚¨ãƒ©ãƒ¼');
                }
            } else {
                const projectAmount = parseFloat($('#projectContractAmount').val());
                console.log('  å¥‘ç´„é‡‘é¡:', projectAmount);
                if (!projectAmount || projectAmount <= 0) {
                    isValid = false;
                    errorMessage = 'å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                    console.error('âŒ å¥‘ç´„é‡‘é¡ã‚¨ãƒ©ãƒ¼');
                }
            }

            const contractAmount = parseFloat($('#internalContractAmount').val());
            console.log('  ä½œæ¥­è²»ç”¨åˆè¨ˆ (#internalContractAmount):', contractAmount);
            if (!contractAmount || contractAmount <= 0) {
                isValid = false;
                errorMessage = 'ä½œæ¥­è²»ç”¨ãŒ0å††ã§ã™ã€‚å¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                console.error('âŒ ä½œæ¥­è²»ç”¨ãŒ0å††ã§ã™');
                console.error('   ã“ã‚Œã¯è¨ˆç®—ãŒå®Ÿè¡Œã•ã‚Œã¦ã„ãªã„ã‹ã€å…¥åŠ›å€¤ãŒä¸è¶³ã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™');
            }
        }

        if (!isValid) {
            e.preventDefault();
            console.error('âŒ ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:', errorMessage);
            console.error('=== ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— ===');
            toastr.error(errorMessage);
            return false;
        }

        console.log('âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸ - ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡ã—ã¾ã™');
        console.log('=== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–‹å§‹ ===');

        // é¸æŠã•ã‚Œã¦ã„ãªã„ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–ï¼ˆé‡è¤‡ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã®å•é¡Œã‚’å›é¿ï¼‰
        if (workerType === 'external') {
            // å¤–æ³¨å…ˆã®å ´åˆï¼šç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
            console.log('ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™');
            $('#internalResourceSection').find('input, select, textarea').each(function() {
                $(this).prop('disabled', true);
                // nameå±æ€§ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‹ã‚‰é™¤å¤–
                const originalName = $(this).attr('name');
                if (originalName) {
                    $(this).data('original-name', originalName);
                    $(this).removeAttr('name');
                }
            });
        } else {
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®å ´åˆï¼šå¤–æ³¨å…ˆç”¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–
            console.log('å¤–æ³¨å…ˆç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™');
            $('#externalContractorSection').find('input, select, textarea').each(function() {
                $(this).prop('disabled', true);
                // nameå±æ€§ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‹ã‚‰é™¤å¤–
                const originalName = $(this).attr('name');
                if (originalName) {
                    $(this).data('original-name', originalName);
                    $(this).removeAttr('name');
                }
            });
        }

        // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        const formData = new FormData(this);
        console.log('=== é€ä¿¡ã•ã‚Œã‚‹ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ ===');
        for (let [key, value] of formData.entries()) {
            console.log(`${key}: ${value}`);
        }
        console.log('=== ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ç¢ºèªçµ‚äº† ===');

        // é€ä¿¡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆäºŒé‡é€ä¿¡é˜²æ­¢ï¼‰
        $(this).find('button[type="submit"]').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> å‡¦ç†ä¸­...');

        return true;
    });
});
</script>

<!-- æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®JavaScriptï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ï¼‰ -->
{% include 'order_management/includes/contractor_add_modal_script.html' %}

<!-- æ¥­è€…ç®¡ç†ãƒ‘ãƒãƒ«ã®JavaScriptï¼ˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ï¼‰ -->
{% include 'order_management/includes/contractor_management_panel_script.html' %}

<script>
$(document).ready(function() {
    // Djangoãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤º
    {% if messages %}
        {% for message in messages %}
            {% if message.tags == 'error' or message.tags == 'danger' %}
                toastr.error('{{ message|escapejs }}');
            {% elif message.tags == 'warning' %}
                toastr.warning('{{ message|escapejs }}');
            {% elif message.tags == 'success' %}
                toastr.success('{{ message|escapejs }}');
            {% else %}
                toastr.info('{{ message|escapejs }}');
            {% endif %}
        {% endfor %}
    {% endif %}
});
</script>
{% endblock %}
