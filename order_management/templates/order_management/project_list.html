{% extends "order_management/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}案件一覧 - 建築派遣管理システム{% endblock %}

{% block extra_css %}
<style>
    /* 案件一覧ページでは main-content の min-height を無効化 */
    .main-content {
        min-height: auto !important;
    }

    .progress-cell {
        min-width: 120px;
    }
    .progress-indicator {
        margin-bottom: 2px;
    }
    .deadline-warning {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    .table-responsive {
        min-height: 400px;
    }
    .clickable-row {
        cursor: pointer;
        transition: all 0.2s;
    }
    /* 受注ヨミの背景色を強制適用 */
    #projectTable tbody tr {
        background-color: inherit;
    }
    #projectTable tbody tr td {
        background-color: transparent !important;
    }
    .clickable-row:hover {
        filter: brightness(0.95);
        transform: translateX(2px);
    }
    .summary-card {
        cursor: pointer;
        transition: all 0.3s;
        border: 1px solid #dee2e6;
        height: 100%;
    }
    .summary-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
        border-color: #007bff;
    }
    .mode-toggle {
        position: relative;
        display: inline-block;
    }
    .list-view-item {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid #dee2e6;
        border-left: 5px solid transparent;
        border-radius: 8px;
        margin-bottom: 10px;
        padding: 12px !important;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .list-view-item:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: #007bff;
    }
    .summary-card:hover {
        transform: translateY(-2px) scale(1.02);
    }
    .view-toggle-group {
        display: inline-flex;
        gap: 5px;
    }
    .col-md-1-5 {
        flex: 0 0 auto;
        width: 12.5%;
    }
    @media (max-width: 767.98px) {
        .col-md-1-5 {
            width: 100%;
        }
    }
    /* 視覚的な改善 */
    .stats-card {
        transition: all 0.3s ease;
        border-radius: 12px;
    }
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .filter-card {
        border-radius: 12px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }
    .card-header {
        border-radius: 12px 12px 0 0 !important;
    }
    .summary-card {
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    .summary-card:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        border-radius: 8px;
    }
    .btn-lg {
        padding: 12px 24px;
        font-size: 1.1rem;
    }
    .progress-enhanced {
        border-radius: 10px;
        overflow: hidden;
        background: rgba(0,0,0,0.1);
    }
    .progress-bar {
        border-radius: 10px;
    }

    /* 統一カラーコード: verified（濃い緑）- 完了チェックボックスON */
    .bg-verified {
        background-color: #155724 !important;
    }
    .badge.bg-verified {
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- ヘッダーとクイック統計 -->
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-list me-2"></i>案件一覧</h2>
        <p class="text-muted mb-3">プロジェクトの一覧表示・検索・進捗管理</p>
    </div>
    <div class="col-auto text-end">
        <div class="view-toggle-group me-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" id="detailModeBtn" onclick="switchMode('detail')">
                    <i class="fas fa-table"></i> 詳細モード
                </button>
                <button type="button" class="btn btn-outline-secondary" id="summaryModeBtn" onclick="switchMode('summary')">
                    <i class="fas fa-th-large"></i> サマリーモード
                </button>
            </div>
            <div class="btn-group" id="summaryViewToggle" style="display: none;">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="tileViewBtn" onclick="switchSummaryView('tile')">
                    <i class="fas fa-th"></i> タイル
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="listViewBtn" onclick="switchSummaryView('list')">
                    <i class="fas fa-list"></i> リスト
                </button>
            </div>
        </div>
        <a href="{% url 'order_management:project_create' %}" class="btn btn-primary btn-lg shadow-sm">
            <i class="fas fa-plus-circle me-2"></i>新規案件登録
        </a>
    </div>
</div>

<!-- クイック統計カード -->
<div class="row mb-4 g-3">
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 stats-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-primary mb-1">{{ total_count }}</h4>
                        <small class="text-muted">総案件数</small>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-briefcase fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 stats-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-success mb-1">{{ received_count }}</h4>
                        <small class="text-muted">受注済み</small>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 stats-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-warning mb-1">{{ in_progress_count }}</h4>
                        <small class="text-muted">進行中</small>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 stats-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-info mb-1">{{ completed_count }}</h4>
                        <small class="text-muted">完了済み</small>
                    </div>
                    <div class="text-info">
                        <i class="fas fa-flag-checkered fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- コンパクト検索・フィルター -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-3">
        <form method="get" id="searchForm">
            <div class="row g-2 align-items-center">
                <!-- 管理No検索 -->
                <div class="col-md-2">
                    <input type="text"
                           name="management_no"
                           class="form-control"
                           placeholder="管理No..."
                           value="{{ management_no|default_if_none:'' }}">
                </div>

                <!-- 現場名検索 -->
                <div class="col-md-2">
                    <input type="text"
                           name="site_name"
                           class="form-control"
                           placeholder="現場名、顧客名..."
                           value="{{ site_name|default_if_none:'' }}">
                </div>

                <!-- クイックフィルター -->
                <div class="col-md-2">
                    <select name="stage_filter" class="form-select" onchange="this.form.submit()">
                        <option value="">すべての進捗</option>
                        {% for stage in stage_choices %}
                        <option value="{{ stage }}" {% if stage == stage_filter %}selected{% endif %}>{{ stage }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <select name="order_forecast" class="form-select" onchange="this.form.submit()">
                        <option value="">すべての受注ヨミ</option>
                        {% for value, label in order_forecast_choices %}
                        <option value="{{ value }}" {% if value == order_forecast %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 検索ボタン -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-1"></i>検索
                    </button>
                </div>

                <!-- 詳細フィルター＆クリア -->
                <div class="col-md-2">
                    <div class="d-flex gap-2">
                        <button type="button"
                                class="btn btn-outline-secondary flex-grow-1"
                                data-bs-toggle="collapse"
                                data-bs-target="#advancedFilters"
                                aria-expanded="false">
                            <i class="fas fa-sliders-h"></i>
                        </button>
                        {% if management_no or site_name or stage_filter or order_forecast or work_type or project_manager or witness_status or survey_status or estimate_status or construction_status or assignee_name or work_period_from or work_period_to or profit_min or profit_max %}
                        <a href="{% url 'order_management:project_list' %}"
                           class="btn btn-outline-danger"
                           title="クリア">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 詳細フィルター（折りたたみ） -->
            <div class="collapse mt-3" id="advancedFilters">
                <div class="border-top pt-3">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-filter me-2"></i>詳細フィルター
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label class="form-label small text-muted">施工種別</label>
                            <input type="text"
                                   name="work_type"
                                   class="form-control form-control-sm"
                                   value="{{ work_type|default_if_none:'' }}"
                                   placeholder="種別を入力">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">案件担当</label>
                            <input type="text"
                                   name="project_manager"
                                   class="form-control form-control-sm"
                                   value="{{ project_manager|default_if_none:'' }}"
                                   placeholder="担当者名">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">立ち会い</label>
                            <select name="witness_status" class="form-select form-select-sm">
                                <option value="">すべて</option>
                                {% for value, label in witness_status_choices %}
                                <option value="{{ value }}" {% if value == witness_status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">現地調査</label>
                            <select name="survey_status" class="form-select form-select-sm">
                                <option value="">すべて</option>
                                {% for value, label in survey_status_choices %}
                                <option value="{{ value }}" {% if value == survey_status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">見積もり</label>
                            <select name="estimate_status" class="form-select form-select-sm">
                                <option value="">すべて</option>
                                {% for value, label in estimate_status_choices %}
                                <option value="{{ value }}" {% if value == estimate_status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">工事</label>
                            <select name="construction_status" class="form-select form-select-sm">
                                <option value="">すべて</option>
                                {% for value, label in construction_status_choices %}
                                <option value="{{ value }}" {% if value == construction_status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">担当者名</label>
                            <input type="text"
                                   name="assignee_name"
                                   class="form-control form-control-sm"
                                   value="{{ assignee_name|default_if_none:'' }}"
                                   placeholder="担当者名で絞り込み">
                        </div>
                    </div>
                    <!-- 工期・利益フィルタ（2行目） -->
                    <div class="row g-2 mt-2">
                        <div class="col-md-2">
                            <label class="form-label small text-muted">工期（開始）</label>
                            <input type="date"
                                   name="work_period_from"
                                   class="form-control form-control-sm"
                                   value="{{ work_period_from|default_if_none:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">工期（終了）</label>
                            <input type="date"
                                   name="work_period_to"
                                   class="form-control form-control-sm"
                                   value="{{ work_period_to|default_if_none:'' }}">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">利益（最小）</label>
                            <input type="number"
                                   name="profit_min"
                                   class="form-control form-control-sm"
                                   value="{{ profit_min|default_if_none:'' }}"
                                   placeholder="円">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">利益（最大）</label>
                            <input type="number"
                                   name="profit_max"
                                   class="form-control form-control-sm"
                                   value="{{ profit_max|default_if_none:'' }}"
                                   placeholder="円">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-filter me-1"></i>フィルター適用
                            </button>
                        </div>
                    </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- データテーブル（詳細モード） -->
<div class="card" id="detailMode" style="display: none;">
    <div class="card-body">
        <div class="table-responsive">
            <table id="projectTable" class="table table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>管理No</th>
                        <th>現場名</th>
                        <th>現場住所</th>
                        <th>元請名</th>
                        <th>下請け名</th>
                        <th>案件担当</th>
                        <th>施工種別</th>
                        <th>案件進捗</th>
                        <th>受注ヨミ</th>
                        <th>手配状況</th>
                        <th>工期</th>
                        <th>売上内訳</th>
                        <th>コメント</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr class="clickable-row" style="background-color: {{ project.get_status_color_hex }} !important;" data-href="{% url 'order_management:project_detail' project.pk %}">
                        <td><small class="text-muted">{{ project.management_no }}</small></td>
                        <td>
                            <a href="{% url 'order_management:project_detail' project.pk %}" class="fw-bold">
                                {{ project.site_name }}
                            </a>
                        </td>
                        <td style="max-width: 200px;">
                            <div class="text-truncate" style="max-width: 200px;" title="{{ project.site_address }}">
                                <small class="text-muted">{{ project.site_address|default:"-" }}</small>
                            </div>
                        </td>
                        <td style="font-size: 0.85rem; max-width: 150px;">
                            <div class="text-truncate" style="max-width: 150px;" title="{% if project.client_company %}{{ project.client_company.company_name }}{% else %}{{ project.client_name }}{% endif %}">
                                {% if project.client_company %}
                                    {{ project.client_company.company_name }}
                                {% else %}
                                    {{ project.client_name|default:"-" }}
                                {% endif %}
                            </div>
                        </td>
                        <td style="font-size: 0.85rem; max-width: 150px;">
                            {% with subcontracts=project.subcontract_set.all %}
                                {% if subcontracts %}
                                    {% for subcontract in subcontracts|slice:":3" %}
                                        <div class="text-truncate" style="max-width: 150px;">
                                            {% if subcontract.contractor %}
                                                {{ subcontract.contractor.name }}
                                            {% elif subcontract.internal_worker %}
                                                {{ subcontract.internal_worker.name }}
                                            {% else %}
                                                未設定
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                    {% if subcontracts.count > 3 %}
                                        <small class="text-muted">他{{ subcontracts.count|add:"-3" }}件</small>
                                    {% endif %}
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            {% endwith %}
                        </td>
                        <td style="font-size: 0.85rem;">{{ project.project_manager|default:"-" }}</td>
                        <td style="font-size: 0.85rem;">{{ project.work_type|default:"-" }}</td>
                        <td>
                            {% with stage=project.get_current_project_stage %}
                            <span class="badge bg-{{ stage.color }}">
                                {{ stage.stage }}
                            </span>
                            {% endwith %}
                        </td>
                        <td class="text-center" data-order="{{ project.project_status }}" onclick="event.stopPropagation();">
                            <select class="form-select form-select-sm order-forecast-select"
                                    data-project-id="{{ project.pk }}"
                                    style="width: auto; display: inline-block;">
                                {% for value, label in order_forecast_choices %}
                                <option value="{{ value }}" {% if value == project.project_status %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="text-center">
                            {% with subcontract_status=project.get_subcontract_status %}
                            <span class="badge bg-{{ subcontract_status.color }}">
                                <i class="fas {{ subcontract_status.icon }}"></i> {{ subcontract_status.status }}
                                {% if subcontract_status.count > 0 %}<br><small>({{ subcontract_status.count }}件)</small>{% endif %}
                            </span>
                            {% endwith %}
                        </td>
                        <td style="font-size: 0.85rem;">
                            {% if project.work_start_date and project.work_end_date %}
                            <div>{{ project.work_start_date|date:"m/d" }} ~ {{ project.work_end_date|date:"m/d" }}</div>
                            {% elif project.work_start_date %}
                            <div>{{ project.work_start_date|date:"m/d" }} ~</div>
                            {% else %}
                            <div class="text-muted">未定</div>
                            {% endif %}
                        </td>
                        <td style="min-width: 200px; font-size: 0.75rem;">
                            {% with revenue=project.get_revenue_breakdown %}
                            <div>
                                <span class="text-muted" style="opacity: 0.7;">売上</span>
                                <span class="text-success fw-bold">¥{{ revenue.revenue|floatformat:0|intcomma }}</span>
                                <span class="text-muted mx-1">|</span>
                                <span class="text-muted" style="opacity: 0.7;">原価</span>
                                <span class="text-warning">¥{{ revenue.cost_of_sales|floatformat:0|intcomma }}</span>
                            </div>
                            <div>
                                <span class="text-muted" style="opacity: 0.7;">利益</span>
                                <span class="text-primary fw-bold">¥{{ revenue.gross_profit|floatformat:0|intcomma }}</span>
                                <small class="text-info">({{ revenue.profit_margin|floatformat:1 }}%)</small>
                            </div>
                            {% endwith %}
                        </td>
                        <td onclick="event.stopPropagation();" style="min-width: 200px;">
                            <div class="d-flex align-items-center gap-2">
                                {% if project.comment_count > 0 %}
                                    <div class="position-relative">
                                        <i class="fas fa-comment text-primary"></i>
                                        {% if project.latest_comment_date and project.last_read_at and project.latest_comment_date > project.last_read_at or project.latest_comment_date and not project.last_read_at %}
                                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="font-size: 0.6rem;">
                                                新
                                            </span>
                                        {% endif %}
                                        <small class="text-muted ms-1">({{ project.comment_count }})</small>
                                    </div>
                                    {% if project.latest_comment_list %}
                                        <div class="flex-grow-1" style="font-size: 0.75rem;">
                                            <div class="text-truncate" style="max-width: 150px;" title="{{ project.latest_comment_list.0.content }}">
                                                <strong>{{ project.latest_comment_list.0.author.username }}:</strong>
                                                {{ project.latest_comment_list.0.content }}
                                            </div>
                                            <small class="text-muted">{{ project.latest_comment_list.0.created_at|date:"m/d H:i" }}</small>
                                        </div>
                                    {% endif %}
                                    {% if project.latest_comment_date and project.last_read_at and project.latest_comment_date > project.last_read_at or project.latest_comment_date and not project.last_read_at %}
                                        <button class="btn btn-sm btn-outline-success mark-as-read-btn" data-project-id="{{ project.pk }}" title="既読にする">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    {% endif %}
                                {% else %}
                                    <small class="text-muted">-</small>
                                {% endif %}
                            </div>
                        </td>
                        <td onclick="event.stopPropagation();">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'order_management:project_detail' project.pk %}" class="btn btn-info btn-sm" title="詳細">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'subcontract_management:project_subcontract_list' project.pk %}" class="btn btn-success btn-sm" title="発注">
                                    <i class="fas fa-handshake"></i>
                                </a>
                                <a href="{% url 'order_management:project_update' project.pk %}" class="btn btn-warning btn-sm" title="編集">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="14" class="text-center text-muted">案件データがありません</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- 表示件数選択 -->
        <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
            <div class="d-flex align-items-center">
                <label for="perPageSelect" class="me-2 mb-0">表示件数:</label>
                <select id="perPageSelect" class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
                    <option value="25" {% if per_page == 25 %}selected{% endif %}>25件</option>
                    <option value="50" {% if per_page == 50 %}selected{% endif %}>50件</option>
                    <option value="100" {% if per_page == 100 %}selected{% endif %}>100件</option>
                    <option value="200" {% if per_page == 200 %}selected{% endif %}>200件</option>
                </select>
            </div>
            <div class="text-muted">
                全{{ page_obj.paginator.count }}件中 {{ page_obj.start_index }}〜{{ page_obj.end_index }}件表示
            </div>
        </div>

        <!-- ページネーション -->
        {% if page_obj.has_other_pages %}
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}{% if stage_filter %}&stage_filter={{ stage_filter }}{% endif %}{% if order_forecast %}&order_forecast={{ order_forecast }}{% endif %}{% if work_type %}&work_type={{ work_type }}{% endif %}{% if project_manager %}&project_manager={{ project_manager }}{% endif %}{% if management_no %}&management_no={{ management_no }}{% endif %}{% if site_name %}&site_name={{ site_name }}{% endif %}{% if work_period_from %}&work_period_from={{ work_period_from }}{% endif %}{% if work_period_to %}&work_period_to={{ work_period_to }}{% endif %}{% if profit_min %}&profit_min={{ profit_min }}{% endif %}{% if profit_max %}&profit_max={{ profit_max }}{% endif %}{% if witness_status %}&witness_status={{ witness_status }}{% endif %}{% if survey_status %}&survey_status={{ survey_status }}{% endif %}{% if estimate_status %}&estimate_status={{ estimate_status }}{% endif %}{% if construction_status %}&construction_status={{ construction_status }}{% endif %}{% if assignee_name %}&assignee_name={{ assignee_name }}{% endif %}">前へ</a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}&per_page={{ per_page }}{% if stage_filter %}&stage_filter={{ stage_filter }}{% endif %}{% if order_forecast %}&order_forecast={{ order_forecast }}{% endif %}{% if work_type %}&work_type={{ work_type }}{% endif %}{% if project_manager %}&project_manager={{ project_manager }}{% endif %}{% if management_no %}&management_no={{ management_no }}{% endif %}{% if site_name %}&site_name={{ site_name }}{% endif %}{% if work_period_from %}&work_period_from={{ work_period_from }}{% endif %}{% if work_period_to %}&work_period_to={{ work_period_to }}{% endif %}{% if profit_min %}&profit_min={{ profit_min }}{% endif %}{% if profit_max %}&profit_max={{ profit_max }}{% endif %}{% if witness_status %}&witness_status={{ witness_status }}{% endif %}{% if survey_status %}&survey_status={{ survey_status }}{% endif %}{% if estimate_status %}&estimate_status={{ estimate_status }}{% endif %}{% if construction_status %}&construction_status={{ construction_status }}{% endif %}{% if assignee_name %}&assignee_name={{ assignee_name }}{% endif %}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}{% if stage_filter %}&stage_filter={{ stage_filter }}{% endif %}{% if order_forecast %}&order_forecast={{ order_forecast }}{% endif %}{% if work_type %}&work_type={{ work_type }}{% endif %}{% if project_manager %}&project_manager={{ project_manager }}{% endif %}{% if management_no %}&management_no={{ management_no }}{% endif %}{% if site_name %}&site_name={{ site_name }}{% endif %}{% if work_period_from %}&work_period_from={{ work_period_from }}{% endif %}{% if work_period_to %}&work_period_to={{ work_period_to }}{% endif %}{% if profit_min %}&profit_min={{ profit_min }}{% endif %}{% if profit_max %}&profit_max={{ profit_max }}{% endif %}{% if witness_status %}&witness_status={{ witness_status }}{% endif %}{% if survey_status %}&survey_status={{ survey_status }}{% endif %}{% if estimate_status %}&estimate_status={{ estimate_status }}{% endif %}{% if construction_status %}&construction_status={{ construction_status }}{% endif %}{% if assignee_name %}&assignee_name={{ assignee_name }}{% endif %}">次へ</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- サマリーモード -->
<div class="container-fluid" id="summaryMode" style="display: block;">
    <!-- タイル表示 -->
    <div class="row g-3" id="tileView">
        {% for project in projects %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
            <div class="card summary-card h-100" onclick="window.location='{% url 'order_management:project_detail' project.pk %}';" style="border-left: 4px solid {% if project.project_status == '受注確定' %}#28a745{% elif project.project_status == 'A' %}#dc3545{% elif project.project_status == 'B' %}#ffc107{% elif project.project_status == 'NG' %}#6c757d{% else %}#e9d5ff{% endif %};">
                {% with stage=project.get_current_project_stage %}
                <div class="card-header bg-{{ stage.color }} text-white">
                    <h6 class="mb-0 text-truncate" title="{{ project.site_name }}">{{ project.site_name }}</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">種別:</small>
                        <strong>{{ project.work_type|default:"-" }}</strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">案件進捗:</small>
                        <span class="badge bg-{{ stage.color }}">
                            {{ stage.stage }}
                        </span>
                    </div>
                {% endwith %}
                    <div class="mb-2">
                        <small class="text-muted">受注ヨミ:</small>
                        <span class="badge {% if project.project_status == '受注確定' %}bg-success{% elif project.project_status == 'A' %}bg-danger{% elif project.project_status == 'B' %}bg-warning text-dark{% elif project.project_status == 'NG' %}bg-secondary{% else %}text-dark{% endif %}"
                              style="{% if project.project_status == 'ネタ' %}background-color: #e9d5ff;{% endif %} cursor: help;"
                              title="{% if project.project_status == '受注確定' %}正式に契約が決定した案件。施工準備・実施段階{% elif project.project_status == 'A' %}受注確度【高】見積提出済みで、契約の意向が強く確認できている案件{% elif project.project_status == 'B' %}受注確度【中】見積提出済みだが、他社との競合や不確定要素がある案件{% elif project.project_status == 'NG' %}失注または取り下げた案件。他社受注や予算不成立など{% else %}初期段階の見込み案件。元請からの問い合わせや引き合いがあった段階{% endif %}">
                            {{ project.get_project_status_display }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">進捗:</small>
                        {% if project.project_status == 'NG' %}
                        <div>
                            <span class="badge bg-secondary">NG</span>
                        </div>
                        {% else %}
                        {% with stage=project.get_current_project_stage details=project.get_progress_details %}
                        <div class="progress progress-enhanced" style="height: 20px;">
                            <div class="progress-bar bg-{{ stage.color }}"
                                 role="progressbar"
                                 style="width: {% if details.total_steps > 0 %}{% widthratio details.completed_steps details.total_steps 100 %}{% else %}0{% endif %}%"
                                 aria-valuenow="{% if details.total_steps > 0 %}{% widthratio details.completed_steps details.total_steps 100 %}{% else %}0{% endif %}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                {% if details.total_steps > 0 %}{{ details.completed_steps }}/{{ details.total_steps }}{% else %}0%{% endif %}
                            </div>
                        </div>
                        {% endwith %}
                        <!-- Next Action & Next Step -->
                        {% with next_info=project.get_next_action_and_step %}
                        {% if next_info.next_action and next_info.next_action != '完了' %}
                        <div class="mb-2">
                            <small class="text-muted d-block" style="font-size: 0.7rem; line-height: 1.3;">
                                <i class="fas fa-arrow-right me-1" style="font-size: 0.65rem;"></i><strong>Next Action:</strong><br>{{ next_info.next_action|format_next_action|safe }}
                            </small>
                        </div>
                        {% endif %}
                        {% endwith %}
                        {% endif %}
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">手配状況:</small>
                        {% with subcontract_status=project.get_subcontract_status %}
                        <span class="badge bg-{{ subcontract_status.color }}">
                            <i class="fas {{ subcontract_status.icon }}"></i> {{ subcontract_status.status }}
                            {% if subcontract_status.count > 0 %} ({{ subcontract_status.count }}件){% endif %}
                        </span>
                        {% endwith %}
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">工期:</small>
                        {% with period=project.get_construction_period %}
                        <div style="font-size: 0.75rem; line-height: 1.3;">
                            {% if period.days is not None %}
                            <div class="text-muted">
                                <i class="fas fa-calendar-alt"></i> {{ period.start_date|date:"m/d" }}~{{ period.end_date|date:"m/d" }} ({{ period.days }}日)
                            </div>
                            {% else %}
                            <div class="text-muted">-</div>
                            {% endif %}
                        </div>
                        {% endwith %}
                    </div>
                    <div>
                        <small class="text-muted">売上内訳:</small>
                        {% with revenue=project.get_revenue_breakdown %}
                        <div style="font-size: 0.75rem; line-height: 1.4; margin-top: 0.25rem;">
                            <span class="text-muted" style="opacity: 0.7;">売上</span>
                            <span class="text-success fw-bold">¥{{ revenue.revenue|floatformat:0|intcomma }}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="text-muted" style="opacity: 0.7;">原価</span>
                            <span class="text-warning">¥{{ revenue.cost_of_sales|floatformat:0|intcomma }}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="text-muted" style="opacity: 0.7;">利益</span>
                            <span class="text-primary fw-bold">¥{{ revenue.gross_profit|floatformat:0|intcomma }}</span>
                            <small class="text-info">({{ revenue.profit_margin|floatformat:1 }}%)</small>
                        </div>
                        {% endwith %}
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">{{ project.management_no }}</small>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> 案件データがありません
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- リスト表示 -->
    <div id="listView" style="display: none;">
        <!-- リスト表示のヘッダー行 -->
        <div class="mb-3 p-3 bg-white rounded shadow-sm border">
            <!-- 現場名ヘッダー -->
            <div class="row mb-2">
                <div class="col-md-10">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('name')">
                        <i class="fas fa-building me-1"></i>現場名・管理No <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-2">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('created')">
                        <i class="fas fa-clock me-1"></i>登録日時 <i class="fas fa-sort"></i>
                    </small>
                </div>
            </div>
            <!-- その他のカラムヘッダー -->
            <div class="row align-items-center">
                <div class="col-md-2">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('client')">
                        <i class="fas fa-building me-1"></i>元請 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-2">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('contractor')">
                        <i class="fas fa-users me-1"></i>下請 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('schedule')">
                        <i class="fas fa-calendar me-1"></i>工期 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('revenue')">
                        <i class="fas fa-yen-sign me-1"></i>売上 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('cost')">
                        <i class="fas fa-yen-sign me-1"></i>原価 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('profit')">
                        <i class="fas fa-yen-sign me-1"></i>利益 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('work_type')">
                        <i class="fas fa-tools me-1"></i>種別 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-2">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('stage')">
                        <i class="fas fa-tasks me-1"></i>案件進捗 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1">
                    <small class="text-muted fw-bold">
                        <i class="fas fa-comment me-1"></i>コメント
                    </small>
                </div>
            </div>
        </div>
        <div id="summaryListItems">
            {% for project in projects %}
            {% with stage=project.get_current_project_stage details=project.get_progress_details revenue=project.get_revenue_breakdown period=project.get_construction_period grouped_subs=project.get_grouped_subcontracts %}
            <div class="list-view-item"
                 onclick="window.location='{% url 'order_management:project_detail' project.pk %}'"
                 style="border-left-color: {% if project.project_status == '受注確定' %}#28a745{% elif project.project_status == 'A' %}#dc3545{% elif project.project_status == 'B' %}#ffc107{% elif project.project_status == 'NG' %}#6c757d{% else %}#e9d5ff{% endif %};"
                 data-name="{{ project.site_name }}"
                 data-client="{% if project.client_company %}{{ project.client_company.company_name }}{% else %}{{ project.client_name|default:'' }}{% endif %}"
                 data-contractor="{% if grouped_subs %}{{ grouped_subs|length }}{% else %}0{% endif %}"
                 data-schedule="{% if period.start_date %}{{ period.start_date|date:'Y-m-d' }}{% else %}9999-12-31{% endif %}"
                 data-revenue="{{ revenue.revenue|default:0 }}"
                 data-cost="{{ revenue.cost_of_sales|default:0 }}"
                 data-profit="{{ revenue.gross_profit|default:0 }}"
                 data-work-type="{{ project.work_type|default:'' }}"
                 data-stage="{{ stage.stage }}"
                 data-progress="{% if details.total_steps > 0 %}{% widthratio details.completed_steps details.total_steps 100 %}{% else %}0{% endif %}"
                 data-created="{{ project.created_at|date:'Y-m-d H:i:s' }}">
                <div class="row align-items-center">
                    <!-- 現場名・管理No -->
                    <div class="col-md-12 mb-2">
                        <div class="d-flex align-items-center justify-content-between">
                            <div class="d-flex align-items-center gap-2">
                                <h6 class="mb-0 fw-bold" style="color: #2c3e50;">{{ project.site_name }}</h6>
                                <span class="badge {% if project.project_status == '受注確定' %}bg-success{% elif project.project_status == 'A' %}bg-danger{% elif project.project_status == 'B' %}bg-warning text-dark{% elif project.project_status == 'NG' %}bg-secondary{% else %}text-dark{% endif %}"
                                      style="font-size: 0.7rem; padding: 0.25rem 0.5rem;{% if project.project_status == 'ネタ' %} background-color: #e9d5ff;{% endif %} cursor: help;"
                                      title="{% if project.project_status == '受注確定' %}正式に契約が決定した案件。施工準備・実施段階{% elif project.project_status == 'A' %}受注確度【高】見積提出済みで、契約の意向が強く確認できている案件{% elif project.project_status == 'B' %}受注確度【中】見積提出済みだが、他社との競合や不確定要素がある案件{% elif project.project_status == 'NG' %}失注または取り下げた案件。他社受注や予算不成立など{% else %}初期段階の見込み案件。元請からの問い合わせや引き合いがあった段階{% endif %}">
                                    {{ project.get_project_status_display }}
                                </span>
                                <small class="text-muted"><i class="fas fa-hashtag me-1"></i>{{ project.management_no }}</small>
                                <small class="text-muted ms-2" style="font-size: 0.6rem;" title="案件登録日時">
                                    <i class="fas fa-clock me-1"></i>{{ project.created_at|date:"Y/m/d H:i" }}
                                </small>
                            </div>
                            {% with comment_count=project.get_comment_count %}
                            {% if comment_count > 0 %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-comment"></i> {{ comment_count }}
                            </span>
                            {% endif %}
                            {% endwith %}
                        </div>
                        {% if project.site_address %}
                        <div class="mt-1">
                            <small class="text-muted" style="font-size: 0.65rem;">
                                <i class="fas fa-map-marker-alt me-1"></i>{{ project.site_address }}
                            </small>
                        </div>
                        {% endif %}
                    </div>

                    <!-- 3カラムレイアウト開始 -->
                    <div class="col-md-2">
                        <!-- Column 1: 元請情報 -->
                        <div class="border-end pe-2" style="min-height: 60px;">
                            <small class="text-muted d-block mb-1" style="font-size: 0.65rem;">
                                <i class="fas fa-building me-1"></i>元請
                            </small>
                            <div style="font-size: 0.7rem; line-height: 1.3;">
                                <div class="mb-1 fw-bold" style="font-size: 0.75rem;">
                                    {% if project.client_company %}
                                        {{ project.client_company.company_name }}
                                    {% else %}
                                        {{ project.client_name|default:"-" }}
                                    {% endif %}
                                </div>
                                {% if project.client_company and project.client_company.payment_cycle %}
                                <div class="text-muted mb-1" style="font-size: 0.65rem;">
                                    {{ project.client_company.get_payment_cycle_display }}
                                    {% if project.client_company.closing_day %}/締{{ project.client_company.closing_day }}{% endif %}{% if project.client_company.payment_day %}払{{ project.client_company.payment_day }}{% endif %}
                                </div>
                                {% endif %}
                                {% if project.payment_due_date %}
                                <div class="text-muted mb-1" style="font-size: 0.65rem;">
                                    <i class="fas fa-calendar me-1"></i>{{ project.payment_due_date|date:"m/d" }}
                                </div>
                                {% endif %}
                                {% with revenue=project.get_revenue_breakdown %}
                                <div class="text-success fw-bold" style="font-size: 0.75rem;">
                                    <i class="fas fa-arrow-down me-1"></i>¥{{ revenue.revenue|floatformat:0|intcomma }}
                                </div>
                                {% endwith %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <!-- Column 2: 下請情報 -->
                        <div class="border-end pe-2" style="min-height: 60px;">
                            <small class="text-muted d-block mb-1" style="font-size: 0.65rem;">
                                <i class="fas fa-users me-1"></i>下請
                            </small>
                            <div style="font-size: 0.7rem; line-height: 1.3;">
                                {% with grouped_subs=project.get_grouped_subcontracts %}
                                {% if grouped_subs %}
                                    {% for group in grouped_subs %}
                                    <div class="{% if not forloop.last %}mb-2 pb-2 border-bottom{% endif %}">
                                        <div class="fw-bold mb-1" style="font-size: 0.75rem;">
                                            {% if group.contractor %}
                                                {{ group.contractor.name }}
                                                <small class="text-muted" style="font-size: 0.65rem;">({{ group.contractor.get_contractor_type_display }})</small>
                                            {% elif group.internal_worker %}
                                                {{ group.internal_worker.name }}
                                                <small class="text-muted" style="font-size: 0.65rem;">(社内)</small>
                                            {% endif %}
                                        </div>
                                        {% if group.contractor and group.contractor.payment_cycle %}
                                        <div class="text-muted mb-1" style="font-size: 0.65rem;">
                                            月1回{% if group.contractor.closing_day %}/締{{ group.contractor.closing_day }}{% endif %}{% if group.contractor.payment_day %}払{{ group.contractor.payment_day }}{% endif %}
                                        </div>
                                        {% endif %}
                                        {% if group.payment_due_date %}
                                        <div class="text-muted mb-1" style="font-size: 0.65rem;">
                                            <i class="fas fa-calendar me-1"></i>{{ group.payment_due_date|date:"m/d" }}
                                        </div>
                                        {% endif %}
                                        <div class="text-warning fw-bold" style="font-size: 0.75rem;">
                                            <i class="fas fa-arrow-up me-1"></i>¥{{ group.total_amount|floatformat:0|intcomma }}
                                        </div>
                                    </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="text-muted">未手配</div>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-1">
                        <!-- Column 3A: 工期 -->
                        <div class="border-end pe-2" style="min-height: 60px;">
                            <small class="text-muted d-block mb-1" style="font-size: 0.65rem;"><i class="fas fa-calendar me-1"></i>工期</small>
                            {% with period=project.get_construction_period %}
                            <div style="font-size: 0.7rem; line-height: 1.2;">
                                {% if period.days is not None %}
                                <div class="text-muted mb-1">
                                    {{ period.start_date|date:"m/d" }}~{{ period.end_date|date:"m/d" }}
                                </div>
                                <div class="text-muted">
                                    ({{ period.days }}日)
                                </div>
                                {% else %}
                                <div class="text-muted mb-1">-</div>
                                {% endif %}
                            </div>
                            {% endwith %}
                        </div>
                    </div>

                    <div class="col-md-1">
                        <!-- Column 3B: 利益 -->
                        <div class="border-end pe-2" style="min-height: 60px;">
                            {% with revenue=project.get_revenue_breakdown %}
                            <div style="font-size: 0.7rem;">
                                <small class="text-muted d-block mb-1" style="font-size: 0.65rem;"><i class="fas fa-yen-sign me-1"></i>利益</small>
                                <div class="text-primary fw-bold">
                                    ¥{{ revenue.gross_profit|floatformat:0|intcomma }}
                                </div>
                                <small class="text-info">({{ revenue.profit_margin|floatformat:1 }}%)</small>
                            </div>
                            {% endwith %}
                        </div>
                    </div>

                    <div class="col-md-1">
                        <!-- Column 4: 工種 -->
                        <div class="border-end pe-2" style="min-height: 60px;">
                            <small class="text-muted d-block mb-1" style="font-size: 0.65rem;"><i class="fas fa-tools me-1"></i>種別</small>
                            <div style="font-size: 0.75rem; line-height: 1.3;">
                                <div class="fw-bold mb-1">{{ project.work_type|default:"-" }}</div>
                                <div class="text-muted mb-2" style="font-size: 0.7rem;">
                                    {% if project.material_labor_type %}{{ project.get_material_labor_type_display }}{% else %}-{% endif %}
                                </div>

                                <!-- 連携状況バッジ -->
                                {% with material_status=project.get_material_status subcontract_status=project.get_subcontract_status %}
                                <div class="d-flex flex-column gap-1">
                                    {% if project.material_labor_type == 'material_labor' %}
                                        <!-- 材工の場合：資材・下請両方を常に表示 -->
                                        <span class="badge bg-{{ material_status.color }}" style="font-size: 0.55rem; padding: 2px 4px;">
                                            資材:{{ material_status.status }}
                                        </span>
                                        <span class="badge bg-{{ subcontract_status.color }}" style="font-size: 0.55rem; padding: 2px 4px;">
                                            下請:{{ subcontract_status.status }}
                                        </span>
                                    {% elif project.material_labor_type == 'labor_only' %}
                                        <!-- 手間の場合：下請のみ表示 -->
                                        <span class="badge bg-{{ subcontract_status.color }}" style="font-size: 0.55rem; padding: 2px 4px;">
                                            下請:{{ subcontract_status.status }}
                                        </span>
                                    {% else %}
                                        <!-- 未選択の場合：実際に連携があるものを表示 -->
                                        {% if material_status.count > 0 %}
                                        <span class="badge bg-{{ material_status.color }}" style="font-size: 0.55rem; padding: 2px 4px;">
                                            資材:{{ material_status.status }}
                                        </span>
                                        {% endif %}
                                        {% if subcontract_status.count > 0 %}
                                        <span class="badge bg-{{ subcontract_status.color }}" style="font-size: 0.55rem; padding: 2px 4px;">
                                            下請:{{ subcontract_status.status }}
                                        </span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                {% endwith %}
                            </div>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <!-- Column 5: 案件進捗 -->
                        <small class="text-muted d-block mb-1" style="font-size: 0.65rem;"><i class="fas fa-tasks me-1"></i>案件進捗</small>
                        {% if project.project_status == 'NG' %}
                        <div>
                            <span class="badge bg-secondary">NG</span>
                        </div>
                        {% else %}
                        {% with stage=project.get_current_project_stage details=project.get_progress_details %}
                        <!-- 案件進捗ステージ -->
                        <div class="mb-2">
                            <span class="badge bg-{{ stage.color }}" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">
                                {{ stage.stage }}
                            </span>
                        </div>
                        <!-- 進捗バー -->
                        <div class="progress progress-enhanced" style="height: 15px;">
                            <div class="progress-bar bg-{{ stage.color }}"
                                 style="width: {% if details.total_steps > 0 %}{% widthratio details.completed_steps details.total_steps 100 %}{% else %}0{% endif %}%">
                                {% if details.total_steps > 0 %}{{ details.completed_steps }}/{{ details.total_steps }}{% else %}0%{% endif %}
                            </div>
                        </div>
                        {% endwith %}
                        <!-- Next Action & Next Step -->
                        {% with next_info=project.get_next_action_and_step %}
                        {% if next_info.next_action and next_info.next_action != '完了' %}
                        <div class="mt-1">
                            <small class="text-muted d-block" style="font-size: 0.65rem; line-height: 1.2;">
                                <i class="fas fa-arrow-right me-1" style="font-size: 0.6rem;"></i><strong>Next Action:</strong><br>{{ next_info.next_action|format_next_action|safe }}
                            </small>
                        </div>
                        {% endif %}
                        {% endwith %}
                        {% endif %}
                    </div>

                    <div class="col-md-1">
                        <!-- Column 6: コメント -->
                        <div style="font-size: 0.7rem; line-height: 1.3;">
                            {% if project.comment_count > 0 %}
                                <small class="text-muted d-block mb-1" style="font-size: 0.65rem;"><i class="fas fa-comment me-1"></i>コメント</small>
                                {% if project.latest_comment_list %}
                                    <div class="mb-1" style="font-size: 0.65rem;">
                                        {% if project.latest_comment_date and project.last_read_at and project.latest_comment_date > project.last_read_at or project.latest_comment_date and not project.last_read_at %}
                                            <span class="badge bg-secondary" style="font-size: 0.55rem; padding: 2px 4px;">新</span>
                                        {% endif %}
                                        <div class="text-truncate" style="max-width: 100px;" title="{{ project.latest_comment_list.0.content }}">
                                            <strong>{{ project.latest_comment_list.0.author.username }}:</strong>
                                            {{ project.latest_comment_list.0.content|truncatewords:3 }}
                                        </div>
                                        <small class="text-muted" style="font-size: 0.6rem;">{{ project.latest_comment_list.0.created_at|date:"m/d H:i" }}</small>
                                    </div>
                                {% endif %}
                            {% else %}
                                <small class="text-muted" style="font-size: 0.65rem;">-</small>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            {% endwith %}
            {% empty %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> 案件データがありません
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 表示件数選択（サマリーモード用） -->
    <div class="d-flex justify-content-between align-items-center mt-3 mb-2">
        <div class="d-flex align-items-center">
            <label for="perPageSelectSummary" class="me-2 mb-0">表示件数:</label>
            <select id="perPageSelectSummary" class="form-select form-select-sm" style="width: auto;" onchange="changePerPage(this.value)">
                <option value="25" {% if per_page == 25 %}selected{% endif %}>25件</option>
                <option value="50" {% if per_page == 50 %}selected{% endif %}>50件</option>
                <option value="100" {% if per_page == 100 %}selected{% endif %}>100件</option>
                <option value="200" {% if per_page == 200 %}selected{% endif %}>200件</option>
            </select>
        </div>
        <div class="text-muted">
            全{{ page_obj.paginator.count }}件中 {{ page_obj.start_index }}〜{{ page_obj.end_index }}件表示
        </div>
    </div>

    <!-- ページネーション（サマリーモード用） -->
    {% if page_obj.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&per_page={{ per_page }}{% if stage_filter %}&stage_filter={{ stage_filter }}{% endif %}{% if order_forecast %}&order_forecast={{ order_forecast }}{% endif %}{% if work_type %}&work_type={{ work_type }}{% endif %}{% if project_manager %}&project_manager={{ project_manager }}{% endif %}{% if management_no %}&management_no={{ management_no }}{% endif %}{% if site_name %}&site_name={{ site_name }}{% endif %}{% if work_period_from %}&work_period_from={{ work_period_from }}{% endif %}{% if work_period_to %}&work_period_to={{ work_period_to }}{% endif %}{% if profit_min %}&profit_min={{ profit_min }}{% endif %}{% if profit_max %}&profit_max={{ profit_max }}{% endif %}{% if witness_status %}&witness_status={{ witness_status }}{% endif %}{% if survey_status %}&survey_status={{ survey_status }}{% endif %}{% if estimate_status %}&estimate_status={{ estimate_status }}{% endif %}{% if construction_status %}&construction_status={{ construction_status }}{% endif %}{% if assignee_name %}&assignee_name={{ assignee_name }}{% endif %}">前へ</a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}&per_page={{ per_page }}{% if stage_filter %}&stage_filter={{ stage_filter }}{% endif %}{% if order_forecast %}&order_forecast={{ order_forecast }}{% endif %}{% if work_type %}&work_type={{ work_type }}{% endif %}{% if project_manager %}&project_manager={{ project_manager }}{% endif %}{% if management_no %}&management_no={{ management_no }}{% endif %}{% if site_name %}&site_name={{ site_name }}{% endif %}{% if work_period_from %}&work_period_from={{ work_period_from }}{% endif %}{% if work_period_to %}&work_period_to={{ work_period_to }}{% endif %}{% if profit_min %}&profit_min={{ profit_min }}{% endif %}{% if profit_max %}&profit_max={{ profit_max }}{% endif %}{% if witness_status %}&witness_status={{ witness_status }}{% endif %}{% if survey_status %}&survey_status={{ survey_status }}{% endif %}{% if estimate_status %}&estimate_status={{ estimate_status }}{% endif %}{% if construction_status %}&construction_status={{ construction_status }}{% endif %}{% if assignee_name %}&assignee_name={{ assignee_name }}{% endif %}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&per_page={{ per_page }}{% if stage_filter %}&stage_filter={{ stage_filter }}{% endif %}{% if order_forecast %}&order_forecast={{ order_forecast }}{% endif %}{% if work_type %}&work_type={{ work_type }}{% endif %}{% if project_manager %}&project_manager={{ project_manager }}{% endif %}{% if management_no %}&management_no={{ management_no }}{% endif %}{% if site_name %}&site_name={{ site_name }}{% endif %}{% if work_period_from %}&work_period_from={{ work_period_from }}{% endif %}{% if work_period_to %}&work_period_to={{ work_period_to }}{% endif %}{% if profit_min %}&profit_min={{ profit_min }}{% endif %}{% if profit_max %}&profit_max={{ profit_max }}{% endif %}{% if witness_status %}&witness_status={{ witness_status }}{% endif %}{% if survey_status %}&survey_status={{ survey_status }}{% endif %}{% if estimate_status %}&estimate_status={{ estimate_status }}{% endif %}{% if construction_status %}&construction_status={{ construction_status }}{% endif %}{% if assignee_name %}&assignee_name={{ assignee_name }}{% endif %}">次へ</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// ページネーション件数変更
function changePerPage(perPage) {
    const urlParams = new URLSearchParams(window.location.search);
    urlParams.set('per_page', perPage);
    urlParams.delete('page');  // Reset to page 1 when changing per_page
    window.location.search = urlParams.toString();
}

// モード切り替え機能
function switchMode(mode) {
    if (mode === 'detail') {
        document.getElementById('detailMode').style.display = 'block';
        document.getElementById('summaryMode').style.display = 'none';
        document.getElementById('summaryViewToggle').style.display = 'none';
        document.getElementById('detailModeBtn').classList.add('btn-primary');
        document.getElementById('detailModeBtn').classList.remove('btn-outline-secondary');
        document.getElementById('summaryModeBtn').classList.remove('btn-primary');
        document.getElementById('summaryModeBtn').classList.add('btn-outline-secondary');
        localStorage.setItem('projectViewMode', 'detail');

        // 詳細モードに切り替えた時にDataTablesを初期化（遅延初期化）
        initializeDataTable();
    } else {
        document.getElementById('detailMode').style.display = 'none';
        document.getElementById('summaryMode').style.display = 'block';
        document.getElementById('summaryViewToggle').style.display = 'inline-flex';
        document.getElementById('summaryModeBtn').classList.add('btn-primary');
        document.getElementById('summaryModeBtn').classList.remove('btn-outline-secondary');
        document.getElementById('detailModeBtn').classList.remove('btn-primary');
        document.getElementById('detailModeBtn').classList.add('btn-outline-secondary');
        localStorage.setItem('projectViewMode', 'summary');

        // サマリービューのデフォルトを復元（デフォルトは'list'）
        var savedSummaryView = localStorage.getItem('summaryViewType') || 'list';
        console.log('Switching to summary view:', savedSummaryView);
        switchSummaryView(savedSummaryView);
    }
}

// サマリーモードのビュー切り替え（タイル/リスト）
function switchSummaryView(view) {
    if (view === 'tile') {
        document.getElementById('tileView').style.display = 'flex';
        document.getElementById('listView').style.display = 'none';
        document.getElementById('tileViewBtn').classList.add('btn-primary');
        document.getElementById('tileViewBtn').classList.remove('btn-outline-secondary');
        document.getElementById('listViewBtn').classList.remove('btn-primary');
        document.getElementById('listViewBtn').classList.add('btn-outline-secondary');
        localStorage.setItem('summaryViewType', 'tile');
    } else {
        document.getElementById('tileView').style.display = 'none';
        document.getElementById('listView').style.display = 'block';
        document.getElementById('listViewBtn').classList.add('btn-primary');
        document.getElementById('listViewBtn').classList.remove('btn-outline-secondary');
        document.getElementById('tileViewBtn').classList.remove('btn-primary');
        document.getElementById('tileViewBtn').classList.add('btn-outline-secondary');
        localStorage.setItem('summaryViewType', 'list');
    }
}

// DataTables初期化フラグ
var dataTableInitialized = false;

// DataTablesを初期化する関数
function initializeDataTable() {
    if (dataTableInitialized) {
        return; // Already initialized
    }

    console.log('DEBUG: Initializing projectTable');
    console.log('DEBUG: thead th count:', $('#projectTable thead th').length);
    console.log('DEBUG: tbody first row td count:', $('#projectTable tbody tr:first td').length);

    // データ行があるかチェック（colspan属性を持つ行は除外）
    var hasData = $('#projectTable tbody tr').filter(function() {
        return !$(this).find('td[colspan]').length;
    }).length > 0;

    console.log('DEBUG: Has data rows:', hasData);

    if (!hasData) {
        console.log('DEBUG: No data rows found, skipping DataTables initialization');
        return;
    }

    var table = $('#projectTable').DataTable({
        responsive: false,  // responsive modeを無効化してカラム数エラーを回避
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json"
        },
        pageLength: 25,
        order: [[0, 'desc']],
        columnDefs: [
            { targets: -1, orderable: false, searchable: false }
        ],
        scrollX: true, // 横スクロールを有効化
        paging: false, // ページネーションはサーバーサイドで処理
        info: false,
        initComplete: function(settings, json) {
            console.log('DEBUG: DataTables initialized successfully');
            console.log('DEBUG: Columns count:', settings.aoColumns.length);
        }
    });

    dataTableInitialized = true;
}

$(document).ready(function() {
    // DataTablesの初期化は詳細モードに切り替えた時のみ行う（遅延初期化）

    // 保存されたモードの復元（デフォルトをサマリーのリストモードに）
    // バージョン管理：デフォルトをサマリーモードに変更（一度だけ実行）
    var viewModeVersion = localStorage.getItem('projectViewModeVersion');
    console.log('=== View Mode Initialization ===');
    console.log('Current viewModeVersion:', viewModeVersion);

    if (viewModeVersion !== '2.2') {
        console.log('Upgrading to version 2.2 - forcing summary list mode');
        // 新しいバージョン：デフォルトをサマリーのリストモードに強制変更
        localStorage.setItem('projectViewMode', 'summary');
        localStorage.setItem('summaryViewType', 'list');
        localStorage.setItem('projectViewModeVersion', '2.2');
        console.log('localStorage updated: projectViewMode=summary, summaryViewType=list');
    }

    var savedMode = localStorage.getItem('projectViewMode');
    var savedSummaryType = localStorage.getItem('summaryViewType');
    console.log('Saved mode:', savedMode);
    console.log('Saved summary type:', savedSummaryType);

    if (!savedMode) {
        savedMode = 'summary';
        localStorage.setItem('projectViewMode', 'summary');
        console.log('No saved mode, defaulting to summary');
    }

    if (!savedSummaryType) {
        localStorage.setItem('summaryViewType', 'list');
        console.log('No saved summary type, defaulting to list');
    }

    console.log('Calling switchMode with:', savedMode);
    switchMode(savedMode);
    console.log('=== End View Mode Initialization ===');

    // Auto-expand advanced filters if any are active
    {% if work_type or project_manager or witness_status or survey_status or estimate_status or construction_status or assignee_name %}
    var advancedFiltersElement = document.getElementById('advancedFilters');
    if (advancedFiltersElement && typeof bootstrap !== 'undefined') {
        var advancedFiltersCollapse = new bootstrap.Collapse(advancedFiltersElement, {
            show: true
        });
        console.log('Advanced filters auto-expanded due to active filters');
    }
    {% endif %}

    // 行クリック時の処理（DataTablesイベントを使用）
    $('#projectTable tbody').on('click', 'tr.clickable-row', function(e) {
        // ボタン要素のクリックは除外、そしてselectも除外
        if (!$(e.target).closest('.btn').length && !$(e.target).hasClass('btn') && !$(e.target).is('select') && !$(e.target).closest('select').length) {
            var href = $(this).data('href');
            if (href) {
                window.location = href;
            }
        }
    });

    // 受注ヨミのselectをクリックしたときに行クリックを防ぐ
    $(document).on('click', '.order-forecast-select', function(e) {
        e.stopPropagation();  // 行クリックイベントを防ぐ
    });

    // 受注ヨミの変更を自動保存
    $(document).on('change', '.order-forecast-select', function(e) {
        e.stopPropagation();  // 行クリックイベントを防ぐ

        var select = $(this);
        var projectId = select.data('project-id');
        var newValue = select.val();

        // CSRFトークンを取得
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrfToken = getCookie('csrftoken');

        // 保存中の表示
        select.prop('disabled', true).css('opacity', '0.5');

        $.ajax({
            url: '/orders/' + projectId + '/update-forecast/',
            method: 'POST',
            headers: {
                'X-CSRFToken': csrfToken
            },
            data: {
                project_status: newValue
            },
            success: function(response) {
                if (response.success) {
                    // 保存成功時の視覚フィードバック
                    select.css('border-color', '#28a745');

                    // 行の背景色を更新
                    var tr = select.closest('tr');
                    var colorMap = {
                        '受注確定': '#d4edda',
                        'A': '#f8d7da',
                        'B': '#fff3cd',
                        'NG': '#e2e3e5',
                        'ネタ': '#f3e8ff'
                    };
                    var newColor = colorMap[newValue] || '#ffffff';
                    tr.css('background-color', newColor);

                    setTimeout(function() {
                        select.css('border-color', '');
                    }, 1000);
                } else {
                    console.error('保存失敗:', response);
                    alert('保存に失敗しました: ' + (response.error || '不明なエラー'));
                    location.reload();
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX エラー:', {
                    status: xhr.status,
                    statusText: xhr.statusText,
                    responseText: xhr.responseText,
                    error: error
                });
                var errorMsg = '保存に失敗しました';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg += ': ' + xhr.responseJSON.error;
                } else if (xhr.status === 403) {
                    errorMsg += ': CSRF検証エラー';
                } else if (xhr.status === 404) {
                    errorMsg += ': 案件が見つかりません';
                }
                alert(errorMsg);
                location.reload();
            },
            complete: function() {
                select.prop('disabled', false).css('opacity', '1');
            }
        });
    });
});
</script>

<!-- DataTables Core CSS and JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- DataTables Responsive CSS and JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
// サマリーリストの並び替え機能
let currentSortField = '';
let currentSortDirection = 'asc';

function sortSummaryList(field) {
    console.log('Sorting by:', field);

    // 同じフィールドをクリックした場合は方向を反転
    if (currentSortField === field) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortField = field;
        currentSortDirection = 'asc';
    }

    const container = $('#summaryListItems');
    const items = container.children('.list-view-item').get();

    items.sort(function(a, b) {
        let aValue, bValue;

        switch(field) {
            case 'name':
                aValue = $(a).data('name') || '';
                bValue = $(b).data('name') || '';
                break;
            case 'client':
                aValue = $(a).data('client') || '';
                bValue = $(b).data('client') || '';
                break;
            case 'contractor':
                aValue = parseInt($(a).data('contractor')) || 0;
                bValue = parseInt($(b).data('contractor')) || 0;
                break;
            case 'schedule':
                aValue = $(a).data('schedule') || '9999-12-31';
                bValue = $(b).data('schedule') || '9999-12-31';
                break;
            case 'profit':
                aValue = parseFloat($(a).data('profit')) || 0;
                bValue = parseFloat($(b).data('profit')) || 0;
                break;
            case 'work_type':
                aValue = $(a).data('work-type') || '';
                bValue = $(b).data('work-type') || '';
                break;
            case 'stage':
                aValue = $(a).data('stage') || '';
                bValue = $(b).data('stage') || '';
                break;
            case 'progress':
                aValue = parseInt($(a).data('progress')) || 0;
                bValue = parseInt($(b).data('progress')) || 0;
                break;
            case 'revenue':
                aValue = parseFloat($(a).data('revenue')) || 0;
                bValue = parseFloat($(b).data('revenue')) || 0;
                break;
            case 'cost':
                aValue = parseFloat($(a).data('cost')) || 0;
                bValue = parseFloat($(b).data('cost')) || 0;
                break;
            case 'created':
                aValue = $(a).data('created') || '9999-12-31 23:59:59';
                bValue = $(b).data('created') || '9999-12-31 23:59:59';
                break;
            default:
                return 0;
        }

        // 数値の場合
        if (typeof aValue === 'number' && typeof bValue === 'number') {
            return currentSortDirection === 'asc' ? aValue - bValue : bValue - aValue;
        }

        // 文字列の場合
        if (currentSortDirection === 'asc') {
            return aValue.toString().localeCompare(bValue.toString(), 'ja');
        } else {
            return bValue.toString().localeCompare(aValue.toString(), 'ja');
        }
    });

    $.each(items, function(idx, item) {
        container.append(item);
    });

    // ソートアイコンを更新
    updateSortIcons(field);
}

function updateSortIcons(field) {
    // すべてのソートアイコンをリセット
    $('#listView .bg-white.rounded i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');

    // 現在のソートフィールドのアイコンを更新
    const iconClass = currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
    $('#listView .bg-white.rounded small[onclick*="' + field + '"] i')
        .removeClass('fa-sort')
        .addClass(iconClass);
}

// コメント既読マーク機能
$(document).on('click', '.mark-as-read-btn', function(e) {
    e.preventDefault();
    e.stopPropagation();

    const button = $(this);
    const projectId = button.data('project-id');

    // ボタンを無効化
    button.prop('disabled', true);

    fetch(`/orders/projects/${projectId}/mark-comments-read/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // バッジを非表示（テーブルビューとリストビューの両方に対応）
            // 親要素内のバッジを検索
            button.parent().find('.badge.bg-danger').fadeOut();
            // 祖父母要素内のバッジも検索（リストビュー用）
            button.parent().parent().find('.badge.bg-danger').fadeOut();
            // ボタン自体も非表示
            button.fadeOut();
        } else {
            alert('既読マークに失敗しました: ' + (data.error || '不明なエラー'));
            button.prop('disabled', false);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('既読マークに失敗しました');
        button.prop('disabled', false);
    });
});

// CSRFトークン取得用関数
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

{% endblock %}