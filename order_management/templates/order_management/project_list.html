{% extends "order_management/base.html" %}
{% load humanize %}
{% load custom_filters %}

{% block title %}案件一覧 - 建築派遣管理システム{% endblock %}

{% block extra_css %}
<style>
    .progress-cell {
        min-width: 120px;
    }
    .progress-indicator {
        margin-bottom: 2px;
    }
    .deadline-warning {
        animation: pulse 2s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.5; }
        100% { opacity: 1; }
    }
    .table-responsive {
        min-height: 400px;
    }
    .clickable-row {
        cursor: pointer;
        transition: all 0.2s;
    }
    .clickable-row:hover {
        background-color: rgba(0, 123, 255, 0.05) !important;
        transform: translateX(2px);
    }
    .summary-card {
        cursor: pointer;
        transition: all 0.3s;
        border: 1px solid #dee2e6;
        height: 100%;
    }
    .summary-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
        border-color: #007bff;
    }
    .mode-toggle {
        position: relative;
        display: inline-block;
    }
    .list-view-item {
        cursor: pointer;
        transition: all 0.3s;
        border: 2px solid #dee2e6;
        border-left: 5px solid transparent;
        border-radius: 8px;
        margin-bottom: 12px;
        padding: 16px !important;
        background: white;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .list-view-item:hover {
        background-color: #f8f9fa;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: #007bff;
    }
    .summary-card:hover {
        transform: translateY(-2px) scale(1.02);
    }
    .view-toggle-group {
        display: inline-flex;
        gap: 5px;
    }
    .col-md-1-5 {
        flex: 0 0 auto;
        width: 12.5%;
    }
    @media (max-width: 767.98px) {
        .col-md-1-5 {
            width: 100%;
        }
    }
    /* 視覚的な改善 */
    .stats-card {
        transition: all 0.3s ease;
        border-radius: 12px;
    }
    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    .filter-card {
        border-radius: 12px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }
    .card-header {
        border-radius: 12px 12px 0 0 !important;
    }
    .summary-card {
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    .summary-card:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border: none;
        border-radius: 8px;
    }
    .btn-lg {
        padding: 12px 24px;
        font-size: 1.1rem;
    }
    .progress-enhanced {
        border-radius: 10px;
        overflow: hidden;
        background: rgba(0,0,0,0.1);
    }
    .progress-bar {
        border-radius: 10px;
    }

    /* 統一カラーコード: verified（濃い緑）- 完了チェックボックスON */
    .bg-verified {
        background-color: #155724 !important;
    }
    .badge.bg-verified {
        color: white;
    }
</style>
{% endblock %}

{% block content %}
<!-- ヘッダーとクイック統計 -->
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-list me-2"></i>案件一覧</h2>
        <p class="text-muted mb-3">プロジェクトの一覧表示・検索・進捗管理</p>
    </div>
    <div class="col-auto text-end">
        <div class="view-toggle-group me-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-secondary" id="detailModeBtn" onclick="switchMode('detail')">
                    <i class="fas fa-table"></i> 詳細モード
                </button>
                <button type="button" class="btn btn-outline-secondary" id="summaryModeBtn" onclick="switchMode('summary')">
                    <i class="fas fa-th-large"></i> サマリーモード
                </button>
            </div>
            <div class="btn-group" id="summaryViewToggle" style="display: none;">
                <button type="button" class="btn btn-outline-secondary btn-sm" id="tileViewBtn" onclick="switchSummaryView('tile')">
                    <i class="fas fa-th"></i> タイル
                </button>
                <button type="button" class="btn btn-outline-secondary btn-sm" id="listViewBtn" onclick="switchSummaryView('list')">
                    <i class="fas fa-list"></i> リスト
                </button>
            </div>
        </div>
        <a href="{% url 'order_management:project_create' %}" class="btn btn-primary btn-lg shadow-sm">
            <i class="fas fa-plus-circle me-2"></i>新規案件登録
        </a>
    </div>
</div>

<!-- クイック統計カード -->
<div class="row mb-4 g-3">
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 stats-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-primary mb-1">{{ total_count }}</h4>
                        <small class="text-muted">総案件数</small>
                    </div>
                    <div class="text-primary">
                        <i class="fas fa-briefcase fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 stats-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-success mb-1">{{ received_count }}</h4>
                        <small class="text-muted">受注済み</small>
                    </div>
                    <div class="text-success">
                        <i class="fas fa-check-circle fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 stats-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-warning mb-1">{{ in_progress_count }}</h4>
                        <small class="text-muted">進行中</small>
                    </div>
                    <div class="text-warning">
                        <i class="fas fa-clock fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-md-3">
        <div class="card border-0 shadow-sm h-100 stats-card">
            <div class="card-body text-center">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h4 class="text-info mb-1">{{ completed_count }}</h4>
                        <small class="text-muted">完了済み</small>
                    </div>
                    <div class="text-info">
                        <i class="fas fa-flag-checkered fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- コンパクト検索・フィルター -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body py-3">
        <form method="get" id="searchForm">
            <div class="row g-2 align-items-center">
                <!-- キーワード検索 -->
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-white border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text"
                               name="search"
                               class="form-control border-start-0 ps-0"
                               placeholder="現場名、住所、管理No で検索..."
                               value="{{ search_query|default_if_none:'' }}">
                    </div>
                </div>

                <!-- クイックフィルター -->
                <div class="col-md-2">
                    <select name="stage_filter" class="form-select" onchange="this.form.submit()">
                        <option value="">すべての進捗</option>
                        {% for stage in stage_choices %}
                        <option value="{{ stage }}" {% if stage == stage_filter %}selected{% endif %}>{{ stage }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="col-md-2">
                    <select name="order_forecast" class="form-select" onchange="this.form.submit()">
                        <option value="">すべての受注ヨミ</option>
                        {% for value, label in order_forecast_choices %}
                        <option value="{{ value }}" {% if value == order_forecast %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>

                <!-- 検索ボタン -->
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search me-1"></i>検索
                    </button>
                </div>

                <!-- 詳細フィルター＆クリア -->
                <div class="col-md-2">
                    <div class="d-flex gap-2">
                        <button type="button"
                                class="btn btn-outline-secondary flex-grow-1"
                                data-bs-toggle="collapse"
                                data-bs-target="#advancedFilters"
                                aria-expanded="false">
                            <i class="fas fa-sliders-h"></i>
                        </button>
                        {% if search_query or stage_filter or order_forecast or work_type or project_manager or witness_status or survey_status or estimate_status or construction_status or assignee_name %}
                        <a href="{% url 'order_management:project_list' %}"
                           class="btn btn-outline-danger"
                           title="クリア">
                            <i class="fas fa-times"></i>
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- 詳細フィルター（折りたたみ） -->
            <div class="collapse mt-3" id="advancedFilters">
                <div class="border-top pt-3">
                    <h6 class="text-muted mb-3">
                        <i class="fas fa-filter me-2"></i>詳細フィルター
                    </h6>
                    <div class="row g-2">
                        <div class="col-md-3">
                            <label class="form-label small text-muted">施工種別</label>
                            <input type="text"
                                   name="work_type"
                                   class="form-control form-control-sm"
                                   value="{{ work_type|default_if_none:'' }}"
                                   placeholder="種別を入力">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">案件担当</label>
                            <input type="text"
                                   name="project_manager"
                                   class="form-control form-control-sm"
                                   value="{{ project_manager|default_if_none:'' }}"
                                   placeholder="担当者名">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">立ち会い</label>
                            <select name="witness_status" class="form-select form-select-sm">
                                <option value="">すべて</option>
                                {% for value, label in witness_status_choices %}
                                <option value="{{ value }}" {% if value == witness_status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">現地調査</label>
                            <select name="survey_status" class="form-select form-select-sm">
                                <option value="">すべて</option>
                                {% for value, label in survey_status_choices %}
                                <option value="{{ value }}" {% if value == survey_status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">見積もり</label>
                            <select name="estimate_status" class="form-select form-select-sm">
                                <option value="">すべて</option>
                                {% for value, label in estimate_status_choices %}
                                <option value="{{ value }}" {% if value == estimate_status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label small text-muted">工事</label>
                            <select name="construction_status" class="form-select form-select-sm">
                                <option value="">すべて</option>
                                {% for value, label in construction_status_choices %}
                                <option value="{{ value }}" {% if value == construction_status %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small text-muted">担当者名</label>
                            <input type="text"
                                   name="assignee_name"
                                   class="form-control form-control-sm"
                                   value="{{ assignee_name|default_if_none:'' }}"
                                   placeholder="担当者名で絞り込み">
                        </div>
                        <div class="col-md-7 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary btn-sm">
                                <i class="fas fa-filter me-1"></i>フィルター適用
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- データテーブル（詳細モード） -->
<div class="card" id="detailMode">
    <div class="card-body">
        <div class="table-responsive">
            <table id="projectTable" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>管理No</th>
                        <th>現場名</th>
                        <th>現場住所</th>
                        <th>元請名</th>
                        <th>案件担当</th>
                        <th>施工種別</th>
                        <th>案件進捗</th>
                        <th>受注ヨミ</th>
                        <th>手配状況</th>
                        <th>工期</th>
                        <th>売上内訳</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for project in projects %}
                    <tr class="clickable-row" style="background-color: {{ project.get_status_color_hex }}20;" data-href="{% url 'order_management:project_detail' project.pk %}">
                        <td><small class="text-muted">{{ project.management_no }}</small></td>
                        <td>
                            <a href="{% url 'order_management:project_detail' project.pk %}" class="fw-bold">
                                {{ project.site_name }}
                            </a>
                        </td>
                        <td style="max-width: 200px;">
                            <small class="text-muted">{{ project.site_address|default:"-" }}</small>
                        </td>
                        <td>{{ project.client_name|default:"-" }}</td>
                        <td>{{ project.project_manager|default:"-" }}</td>
                        <td>{{ project.work_type|default:"-" }}</td>
                        <td>
                            {% with stage=project.get_current_project_stage %}
                            <span class="badge bg-{{ stage.color }}">
                                {{ stage.stage }}
                            </span>
                            {% endwith %}
                        </td>
                        <td class="text-center" data-order="{{ project.project_status }}" onclick="event.stopPropagation();">
                            <select class="form-select form-select-sm order-forecast-select"
                                    data-project-id="{{ project.pk }}"
                                    style="width: auto; display: inline-block;">
                                {% for value, label in order_forecast_choices %}
                                <option value="{{ value }}" {% if value == project.project_status %}selected{% endif %}>
                                    {{ label }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td class="text-center">
                            {% with subcontract_status=project.get_subcontract_status %}
                            <span class="badge bg-{{ subcontract_status.color }}">
                                <i class="fas {{ subcontract_status.icon }}"></i> {{ subcontract_status.status }}
                                {% if subcontract_status.count > 0 %}<br><small>({{ subcontract_status.count }}件)</small>{% endif %}
                            </span>
                            {% endwith %}
                        </td>
                        <td style="font-size: 0.85rem;">
                            {% if project.work_start_date and project.work_end_date %}
                            <div>{{ project.work_start_date|date:"m/d" }} ~ {{ project.work_end_date|date:"m/d" }}</div>
                            {% elif project.work_start_date %}
                            <div>{{ project.work_start_date|date:"m/d" }} ~</div>
                            {% else %}
                            <div class="text-muted">未定</div>
                            {% endif %}
                        </td>
                        <td style="min-width: 220px; font-size: 0.75rem;">
                            {% with revenue=project.get_revenue_breakdown %}
                            <span class="text-muted" style="opacity: 0.7;">売上</span>
                            <span class="text-success fw-bold">¥{{ revenue.revenue|floatformat:0|intcomma }}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="text-muted" style="opacity: 0.7;">原価</span>
                            <span class="text-warning">-¥{{ revenue.cost_of_sales|floatformat:0|intcomma }}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="text-muted" style="opacity: 0.7;">利益</span>
                            <span class="text-primary fw-bold">¥{{ revenue.gross_profit|floatformat:0|intcomma }}</span>
                            <small class="text-info">({{ revenue.profit_margin|floatformat:1 }}%)</small>
                            {% endwith %}
                        </td>
                        <td onclick="event.stopPropagation();">
                            <div class="btn-group btn-group-sm" role="group">
                                <a href="{% url 'order_management:project_detail' project.pk %}" class="btn btn-info btn-sm" title="詳細">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <a href="{% url 'subcontract_management:project_subcontract_list' project.pk %}" class="btn btn-success btn-sm" title="発注">
                                    <i class="fas fa-handshake"></i>
                                </a>
                                <a href="{% url 'order_management:project_update' project.pk %}" class="btn btn-warning btn-sm" title="編集">
                                    <i class="fas fa-edit"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="9" class="text-center text-muted">案件データがありません</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- ページネーション -->
        {% if page_obj.has_other_pages %}
        <nav class="mt-4">
            <ul class="pagination justify-content-center">
                {% if page_obj.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&stage_filter={{ stage_filter }}&order_forecast={{ order_forecast }}&work_type={{ work_type }}&project_manager={{ project_manager }}&search={{ search_query }}&witness_status={{ witness_status }}&survey_status={{ survey_status }}&estimate_status={{ estimate_status }}&construction_status={{ construction_status }}&assignee_name={{ assignee_name }}">前へ</a>
                </li>
                {% endif %}

                {% for num in page_obj.paginator.page_range %}
                    {% if page_obj.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                    <li class="page-item"><a class="page-link" href="?page={{ num }}&stage_filter={{ stage_filter }}&order_forecast={{ order_forecast }}&work_type={{ work_type }}&project_manager={{ project_manager }}&search={{ search_query }}&witness_status={{ witness_status }}&survey_status={{ survey_status }}&estimate_status={{ estimate_status }}&construction_status={{ construction_status }}&assignee_name={{ assignee_name }}">{{ num }}</a></li>
                    {% endif %}
                {% endfor %}

                {% if page_obj.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&stage_filter={{ stage_filter }}&order_forecast={{ order_forecast }}&work_type={{ work_type }}&project_manager={{ project_manager }}&search={{ search_query }}&witness_status={{ witness_status }}&survey_status={{ survey_status }}&estimate_status={{ estimate_status }}&construction_status={{ construction_status }}&assignee_name={{ assignee_name }}">次へ</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- サマリーモード -->
<div class="container-fluid" id="summaryMode" style="display: none;">
    <!-- タイル表示 -->
    <div class="row g-3" id="tileView">
        {% for project in projects %}
        <div class="col-12 col-sm-6 col-md-4 col-lg-3">
            <div class="card summary-card h-100" onclick="window.location='{% url 'order_management:project_detail' project.pk %}';" style="border-left: 4px solid {% if project.project_status == '受注確定' %}#28a745{% elif project.project_status == 'A' %}#dc3545{% elif project.project_status == 'B' %}#ffc107{% elif project.project_status == 'NG' %}#6c757d{% else %}#e9d5ff{% endif %};">
                {% with stage=project.get_current_project_stage %}
                <div class="card-header bg-{{ stage.color }} text-white">
                    <h6 class="mb-0 text-truncate" title="{{ project.site_name }}">{{ project.site_name }}</h6>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">種別:</small>
                        <strong>{{ project.work_type|default:"-" }}</strong>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">案件進捗:</small>
                        <span class="badge bg-{{ stage.color }}">
                            {{ stage.stage }}
                        </span>
                    </div>
                {% endwith %}
                    <div class="mb-2">
                        <small class="text-muted">受注ヨミ:</small>
                        <span class="badge {% if project.project_status == '受注確定' %}bg-success{% elif project.project_status == 'A' %}bg-danger{% elif project.project_status == 'B' %}bg-warning text-dark{% elif project.project_status == 'NG' %}bg-secondary{% else %}text-dark{% endif %}"
                              style="{% if project.project_status == 'ネタ' %}background-color: #e9d5ff;{% endif %} cursor: help;"
                              title="{% if project.project_status == '受注確定' %}正式に契約が決定した案件。施工準備・実施段階{% elif project.project_status == 'A' %}受注確度【高】見積提出済みで、契約の意向が強く確認できている案件{% elif project.project_status == 'B' %}受注確度【中】見積提出済みだが、他社との競合や不確定要素がある案件{% elif project.project_status == 'NG' %}失注または取り下げた案件。他社受注や予算不成立など{% else %}初期段階の見込み案件。元請からの問い合わせや引き合いがあった段階{% endif %}">
                            {{ project.get_project_status_display }}
                        </span>
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">進捗:</small>
                        {% with stage=project.get_current_project_stage details=project.get_progress_details %}
                        <div class="progress progress-enhanced" style="height: 20px;">
                            <div class="progress-bar bg-{{ stage.color }}"
                                 role="progressbar"
                                 style="width: {% if details.total_steps > 0 %}{% widthratio details.completed_steps details.total_steps 100 %}{% else %}0{% endif %}%"
                                 aria-valuenow="{% if details.total_steps > 0 %}{% widthratio details.completed_steps details.total_steps 100 %}{% else %}0{% endif %}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                {% if details.total_steps > 0 %}{{ details.completed_steps }}/{{ details.total_steps }}{% else %}0%{% endif %}
                            </div>
                        </div>
                        {% endwith %}
                    </div>
                    <!-- Next Action & Next Step -->
                    {% with next_info=project.get_next_action_and_step %}
                    {% if next_info.next_action and next_info.next_action != '完了' %}
                    <div class="mb-2">
                        <small class="text-muted d-block" style="font-size: 0.7rem; line-height: 1.3;">
                            <i class="fas fa-arrow-right me-1" style="font-size: 0.65rem;"></i><strong>Next Action:</strong><br>{{ next_info.next_action|format_next_action|safe }}
                        </small>
                        {% if next_info.next_step and next_info.next_step != '完了' and next_info.next_step != '-' %}
                        <small class="text-secondary d-block" style="font-size: 0.65rem; line-height: 1.2; margin-top: 0.3rem;">
                            <i class="fas fa-forward me-1" style="font-size: 0.6rem;"></i><strong>Next Step:</strong><br>{{ next_info.next_step|format_next_action|safe }}
                        </small>
                        {% endif %}
                    </div>
                    {% endif %}
                    {% endwith %}
                    <div class="mb-2">
                        <small class="text-muted">手配状況:</small>
                        {% with subcontract_status=project.get_subcontract_status %}
                        <span class="badge bg-{{ subcontract_status.color }}">
                            <i class="fas {{ subcontract_status.icon }}"></i> {{ subcontract_status.status }}
                            {% if subcontract_status.count > 0 %} ({{ subcontract_status.count }}件){% endif %}
                        </span>
                        {% endwith %}
                    </div>
                    <div class="mb-2">
                        <small class="text-muted">工期:</small>
                        {% with period=project.get_construction_period %}
                        <div style="font-size: 0.75rem; line-height: 1.3;">
                            {% if period.days is not None %}
                            <div class="text-muted">
                                <i class="fas fa-calendar-alt"></i> {{ period.start_date|date:"m/d" }}~{{ period.end_date|date:"m/d" }} ({{ period.days }}日)
                            </div>
                            {% else %}
                            <div class="text-muted">-</div>
                            {% endif %}
                        </div>
                        {% endwith %}
                    </div>
                    <div>
                        <small class="text-muted">売上内訳:</small>
                        {% with revenue=project.get_revenue_breakdown %}
                        <div style="font-size: 0.75rem; line-height: 1.4; margin-top: 0.25rem;">
                            <span class="text-muted" style="opacity: 0.7;">売上</span>
                            <span class="text-success fw-bold">¥{{ revenue.revenue|floatformat:0|intcomma }}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="text-muted" style="opacity: 0.7;">原価</span>
                            <span class="text-warning">-¥{{ revenue.cost_of_sales|floatformat:0|intcomma }}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="text-muted" style="opacity: 0.7;">利益</span>
                            <span class="text-primary fw-bold">¥{{ revenue.gross_profit|floatformat:0|intcomma }}</span>
                            <small class="text-info">({{ revenue.profit_margin|floatformat:1 }}%)</small>
                        </div>
                        {% endwith %}
                    </div>
                </div>
                <div class="card-footer bg-light">
                    <small class="text-muted">{{ project.management_no }}</small>
                </div>
            </div>
        </div>
        {% empty %}
        <div class="col-12">
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> 案件データがありません
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- リスト表示 -->
    <div id="listView" style="display: none;">
        <!-- リスト表示のヘッダー行 -->
        <div class="mb-3 p-3 bg-white rounded shadow-sm border">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('name')">
                        案件名 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1-5">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('work_type')">
                        施工種別 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1-5">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('stage')">
                        案件進捗 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-2">
                    <small class="text-muted fw-bold" style="cursor: pointer;" onclick="sortSummaryList('progress')">
                        進捗 <i class="fas fa-sort"></i>
                    </small>
                </div>
                <div class="col-md-1-5">
                    <small class="text-muted fw-bold">手配状況</small>
                </div>
                <div class="col-md-1-5">
                    <small class="text-muted fw-bold">工期・入金予定</small>
                </div>
            </div>
        </div>
        <div id="summaryListItems">
            {% for project in projects %}
            {% with stage=project.get_current_project_stage details=project.get_progress_details revenue=project.get_revenue_breakdown %}
            <div class="list-view-item"
                 onclick="window.location='{% url 'order_management:project_detail' project.pk %}'"
                 style="border-left-color: {% if project.project_status == '受注確定' %}#28a745{% elif project.project_status == 'A' %}#dc3545{% elif project.project_status == 'B' %}#ffc107{% elif project.project_status == 'NG' %}#6c757d{% else %}#e9d5ff{% endif %};"
                 data-name="{{ project.site_name }}"
                 data-work-type="{{ project.work_type|default:'' }}"
                 data-stage="{{ stage.stage }}"
                 data-progress="{% if details.total_steps > 0 %}{% widthratio details.completed_steps details.total_steps 100 %}{% else %}0{% endif %}"
                 data-revenue="{{ revenue.revenue }}">
                <div class="row align-items-center">
                    <div class="col-md-3">
                        <h6 class="mb-1 fw-bold" style="color: #2c3e50;">{{ project.site_name }}</h6>
                        <small class="text-muted"><i class="fas fa-hashtag me-1"></i>{{ project.management_no }}</small>

                        <!-- 売上内訳（一列表示） -->
                        {% with revenue=project.get_revenue_breakdown %}
                        <div class="mt-1" style="font-size: 0.75rem; line-height: 1.4;">
                            <span class="text-muted" style="opacity: 0.7;">売上</span>
                            <span class="text-success fw-bold">¥{{ revenue.revenue|floatformat:0|intcomma }}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="text-muted" style="opacity: 0.7;">原価</span>
                            <span class="text-warning">-¥{{ revenue.cost_of_sales|floatformat:0|intcomma }}</span>
                            <span class="text-muted mx-1">|</span>
                            <span class="text-muted" style="opacity: 0.7;">利益</span>
                            <span class="text-primary fw-bold">¥{{ revenue.gross_profit|floatformat:0|intcomma }}</span>
                            <small class="text-info">({{ revenue.profit_margin|floatformat:1 }}%)</small>
                        </div>
                        {% endwith %}
                    </div>
                    <div class="col-md-1-5">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;"><i class="fas fa-tools me-1"></i>施工種別</small>
                        <strong style="font-size: 0.9rem;">{{ project.work_type|default:"-" }}</strong>
                    </div>
                    <div class="col-md-1-5">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;"><i class="fas fa-tasks me-1"></i>案件進捗</small>
                        {% with stage=project.get_current_project_stage %}
                        <span class="badge bg-{{ stage.color }}" style="font-size: 0.85rem; padding: 0.35rem 0.6rem;">
                            {{ stage.stage }}
                        </span>
                        {% endwith %}
                        <div class="mt-1">
                            <small class="text-muted d-block mb-1" style="font-size: 0.65rem;"><i class="fas fa-chart-pie me-1"></i>受注ヨミ</small>
                            <span class="badge {% if project.project_status == '受注確定' %}bg-success{% elif project.project_status == 'A' %}bg-danger{% elif project.project_status == 'B' %}bg-warning text-dark{% elif project.project_status == 'NG' %}bg-secondary{% else %}text-dark{% endif %}"
                                  style="font-size: 0.75rem; padding: 0.25rem 0.5rem;{% if project.project_status == 'ネタ' %} background-color: #e9d5ff;{% endif %} cursor: help;"
                                  title="{% if project.project_status == '受注確定' %}正式に契約が決定した案件。施工準備・実施段階{% elif project.project_status == 'A' %}受注確度【高】見積提出済みで、契約の意向が強く確認できている案件{% elif project.project_status == 'B' %}受注確度【中】見積提出済みだが、他社との競合や不確定要素がある案件{% elif project.project_status == 'NG' %}失注または取り下げた案件。他社受注や予算不成立など{% else %}初期段階の見込み案件。元請からの問い合わせや引き合いがあった段階{% endif %}">
                                {{ project.get_project_status_display }}
                            </span>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;"><i class="fas fa-chart-line me-1"></i>進捗</small>
                        {% with stage=project.get_current_project_stage details=project.get_progress_details %}
                        <div class="progress progress-enhanced" style="height: 15px;">
                            <div class="progress-bar bg-{{ stage.color }}"
                                 style="width: {% if details.total_steps > 0 %}{% widthratio details.completed_steps details.total_steps 100 %}{% else %}0{% endif %}%">
                                {% if details.total_steps > 0 %}{{ details.completed_steps }}/{{ details.total_steps }}{% else %}0%{% endif %}
                            </div>
                        </div>
                        {% endwith %}
                        <!-- Next Action & Next Step -->
                        {% with next_info=project.get_next_action_and_step %}
                        {% if next_info.next_action and next_info.next_action != '完了' %}
                        <div class="mt-1">
                            <small class="text-muted d-block" style="font-size: 0.65rem; line-height: 1.2;">
                                <i class="fas fa-arrow-right me-1" style="font-size: 0.6rem;"></i><strong>Next Action:</strong><br>{{ next_info.next_action|format_next_action|safe }}
                            </small>
                            {% if next_info.next_step and next_info.next_step != '完了' and next_info.next_step != '-' %}
                            <small class="text-secondary d-block" style="font-size: 0.6rem; line-height: 1.1; margin-top: 0.3rem;">
                                <i class="fas fa-forward me-1" style="font-size: 0.55rem;"></i><strong>Next Step:</strong><br>{{ next_info.next_step|format_next_action|safe }}
                            </small>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endwith %}
                    </div>
                    <div class="col-md-1-5">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;"><i class="fas fa-handshake me-1"></i>手配状況</small>
                        {% with subcontract_status=project.get_subcontract_status %}
                        <span class="badge bg-{{ subcontract_status.color }}">
                            <i class="fas {{ subcontract_status.icon }}"></i> {{ subcontract_status.status }}
                        </span>
                        {% endwith %}
                    </div>
                    <div class="col-md-1-5">
                        <small class="text-muted d-block mb-1" style="font-size: 0.7rem;"><i class="fas fa-calendar me-1"></i>工期・入金予定</small>
                        {% with period=project.get_construction_period %}
                        <div style="font-size: 0.75rem; line-height: 1.3;">
                            {% if period.days is not None %}
                            <div class="text-muted mb-1">
                                <i class="fas fa-calendar-alt"></i> {{ period.start_date|date:"m/d" }}~{{ period.end_date|date:"m/d" }} ({{ period.days }}日)
                            </div>
                            {% else %}
                            <div class="text-muted mb-1">-</div>
                            {% endif %}
                            {% if project.payment_due_date %}
                            <div class="text-info">
                                <i class="fas fa-yen-sign"></i> {{ project.payment_due_date|date:"m/d" }}
                            </div>
                            {% else %}
                            <div class="text-muted">未定</div>
                            {% endif %}
                        </div>
                        {% endwith %}
                    </div>
                </div>
            </div>
            {% endwith %}
            {% empty %}
            <div class="alert alert-info text-center">
                <i class="fas fa-info-circle"></i> 案件データがありません
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ページネーション（サマリーモード用） -->
    {% if page_obj.has_other_pages %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}&stage_filter={{ stage_filter }}&order_forecast={{ order_forecast }}&work_type={{ work_type }}&project_manager={{ project_manager }}&search={{ search_query }}&witness_status={{ witness_status }}&survey_status={{ survey_status }}&estimate_status={{ estimate_status }}&construction_status={{ construction_status }}&assignee_name={{ assignee_name }}">前へ</a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
                {% if page_obj.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}&stage_filter={{ stage_filter }}&order_forecast={{ order_forecast }}&work_type={{ work_type }}&project_manager={{ project_manager }}&search={{ search_query }}&witness_status={{ witness_status }}&survey_status={{ survey_status }}&estimate_status={{ estimate_status }}&construction_status={{ construction_status }}&assignee_name={{ assignee_name }}">{{ num }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}&stage_filter={{ stage_filter }}&order_forecast={{ order_forecast }}&work_type={{ work_type }}&project_manager={{ project_manager }}&search={{ search_query }}&witness_status={{ witness_status }}&survey_status={{ survey_status }}&estimate_status={{ estimate_status }}&construction_status={{ construction_status }}&assignee_name={{ assignee_name }}">次へ</a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// モード切り替え機能
function switchMode(mode) {
    if (mode === 'detail') {
        document.getElementById('detailMode').style.display = 'block';
        document.getElementById('summaryMode').style.display = 'none';
        document.getElementById('summaryViewToggle').style.display = 'none';
        document.getElementById('detailModeBtn').classList.add('btn-primary');
        document.getElementById('detailModeBtn').classList.remove('btn-outline-secondary');
        document.getElementById('summaryModeBtn').classList.remove('btn-primary');
        document.getElementById('summaryModeBtn').classList.add('btn-outline-secondary');
        localStorage.setItem('projectViewMode', 'detail');
    } else {
        document.getElementById('detailMode').style.display = 'none';
        document.getElementById('summaryMode').style.display = 'block';
        document.getElementById('summaryViewToggle').style.display = 'inline-flex';
        document.getElementById('summaryModeBtn').classList.add('btn-primary');
        document.getElementById('summaryModeBtn').classList.remove('btn-outline-secondary');
        document.getElementById('detailModeBtn').classList.remove('btn-primary');
        document.getElementById('detailModeBtn').classList.add('btn-outline-secondary');
        localStorage.setItem('projectViewMode', 'summary');

        // サマリービューのデフォルトを復元（デフォルトは'list'）
        var savedSummaryView = localStorage.getItem('summaryViewType') || 'list';
        console.log('Switching to summary view:', savedSummaryView);
        switchSummaryView(savedSummaryView);
    }
}

// サマリーモードのビュー切り替え（タイル/リスト）
function switchSummaryView(view) {
    if (view === 'tile') {
        document.getElementById('tileView').style.display = 'flex';
        document.getElementById('listView').style.display = 'none';
        document.getElementById('tileViewBtn').classList.add('btn-primary');
        document.getElementById('tileViewBtn').classList.remove('btn-outline-secondary');
        document.getElementById('listViewBtn').classList.remove('btn-primary');
        document.getElementById('listViewBtn').classList.add('btn-outline-secondary');
        localStorage.setItem('summaryViewType', 'tile');
    } else {
        document.getElementById('tileView').style.display = 'none';
        document.getElementById('listView').style.display = 'block';
        document.getElementById('listViewBtn').classList.add('btn-primary');
        document.getElementById('listViewBtn').classList.remove('btn-outline-secondary');
        document.getElementById('tileViewBtn').classList.remove('btn-primary');
        document.getElementById('tileViewBtn').classList.add('btn-outline-secondary');
        localStorage.setItem('summaryViewType', 'list');
    }
}

$(document).ready(function() {
    // DataTableの初期化（レスポンシブ対応強化）
    // DataTablesエラーのデバッグ情報を出力
    console.log('DEBUG: Initializing projectTable');
    console.log('DEBUG: thead th count:', $('#projectTable thead th').length);
    console.log('DEBUG: tbody first row td count:', $('#projectTable tbody tr:first td').length);

    // データ行があるかチェック（colspan属性を持つ行は除外）
    var hasData = $('#projectTable tbody tr').filter(function() {
        return !$(this).find('td[colspan]').length;
    }).length > 0;

    console.log('DEBUG: Has data rows:', hasData);

    if (!hasData) {
        console.log('DEBUG: No data rows found, skipping DataTables initialization');
        return;
    }

    var table = $('#projectTable').DataTable({
        responsive: false,  // responsive modeを無効化してカラム数エラーを回避
        language: {
            url: "//cdn.datatables.net/plug-ins/1.13.6/i18n/ja.json"
        },
        pageLength: 25,
        order: [[0, 'desc']],
        columnDefs: [
            { targets: -1, orderable: false, searchable: false }
        ],
        scrollX: true, // 横スクロールを有効化
        paging: false, // ページネーションはサーバーサイドで処理
        info: false,
        initComplete: function(settings, json) {
            console.log('DEBUG: DataTables initialized successfully');
            console.log('DEBUG: Columns count:', settings.aoColumns.length);
        }
    });

    // 保存されたモードの復元（デフォルトをサマリーのリストモードに）
    // バージョン管理：デフォルトをサマリーモードに変更（一度だけ実行）
    var viewModeVersion = localStorage.getItem('projectViewModeVersion');
    console.log('=== View Mode Initialization ===');
    console.log('Current viewModeVersion:', viewModeVersion);

    if (viewModeVersion !== '2.2') {
        console.log('Upgrading to version 2.2 - forcing summary list mode');
        // 新しいバージョン：デフォルトをサマリーのリストモードに強制変更
        localStorage.setItem('projectViewMode', 'summary');
        localStorage.setItem('summaryViewType', 'list');
        localStorage.setItem('projectViewModeVersion', '2.2');
        console.log('localStorage updated: projectViewMode=summary, summaryViewType=list');
    }

    var savedMode = localStorage.getItem('projectViewMode');
    var savedSummaryType = localStorage.getItem('summaryViewType');
    console.log('Saved mode:', savedMode);
    console.log('Saved summary type:', savedSummaryType);

    if (!savedMode) {
        savedMode = 'summary';
        localStorage.setItem('projectViewMode', 'summary');
        console.log('No saved mode, defaulting to summary');
    }

    if (!savedSummaryType) {
        localStorage.setItem('summaryViewType', 'list');
        console.log('No saved summary type, defaulting to list');
    }

    console.log('Calling switchMode with:', savedMode);
    switchMode(savedMode);
    console.log('=== End View Mode Initialization ===');

    // Auto-expand advanced filters if any are active
    {% if work_type or project_manager or witness_status or survey_status or estimate_status or construction_status or assignee_name %}
    var advancedFiltersElement = document.getElementById('advancedFilters');
    if (advancedFiltersElement && typeof bootstrap !== 'undefined') {
        var advancedFiltersCollapse = new bootstrap.Collapse(advancedFiltersElement, {
            show: true
        });
        console.log('Advanced filters auto-expanded due to active filters');
    }
    {% endif %}

    // 行クリック時の処理（DataTablesイベントを使用）
    $('#projectTable tbody').on('click', 'tr.clickable-row', function(e) {
        // ボタン要素のクリックは除外、そしてselectも除外
        if (!$(e.target).closest('.btn').length && !$(e.target).hasClass('btn') && !$(e.target).is('select') && !$(e.target).closest('select').length) {
            var href = $(this).data('href');
            if (href) {
                window.location = href;
            }
        }
    });

    // 受注ヨミのselectをクリックしたときに行クリックを防ぐ
    $(document).on('click', '.order-forecast-select', function(e) {
        e.stopPropagation();  // 行クリックイベントを防ぐ
    });

    // 受注ヨミの変更を自動保存
    $(document).on('change', '.order-forecast-select', function(e) {
        e.stopPropagation();  // 行クリックイベントを防ぐ

        var select = $(this);
        var projectId = select.data('project-id');
        var newValue = select.val();
        var csrfToken = $('[name=csrfmiddlewaretoken]').val() || '{{ csrf_token }}';

        // 保存中の表示
        select.prop('disabled', true).css('opacity', '0.5');

        $.ajax({
            url: '/orders/' + projectId + '/update-forecast/',
            method: 'POST',
            data: {
                project_status: newValue,
                csrfmiddlewaretoken: csrfToken
            },
            success: function(response) {
                if (response.success) {
                    // 保存成功時の視覚フィードバック
                    select.css('border-color', '#28a745');
                    setTimeout(function() {
                        select.css('border-color', '');
                    }, 1000);
                } else {
                    alert('保存に失敗しました: ' + (response.error || '不明なエラー'));
                    location.reload();
                }
            },
            error: function(xhr, status, error) {
                console.error('保存エラー:', error);
                alert('保存に失敗しました');
                location.reload();
            },
            complete: function() {
                select.prop('disabled', false).css('opacity', '1');
            }
        });
    });
});
</script>

<!-- DataTables Core CSS and JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<!-- DataTables Responsive CSS and JS -->
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.dataTables.min.css">
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>

<script>
// サマリーリストの並び替え機能
let currentSortField = '';
let currentSortDirection = 'asc';

function sortSummaryList(field) {
    console.log('Sorting by:', field);

    // 同じフィールドをクリックした場合は方向を反転
    if (currentSortField === field) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortField = field;
        currentSortDirection = 'asc';
    }

    const container = $('#summaryListItems');
    const items = container.children('.list-view-item').get();

    items.sort(function(a, b) {
        let aValue, bValue;

        switch(field) {
            case 'name':
                aValue = $(a).data('name') || '';
                bValue = $(b).data('name') || '';
                break;
            case 'work_type':
                aValue = $(a).data('work-type') || '';
                bValue = $(b).data('work-type') || '';
                break;
            case 'stage':
                aValue = $(a).data('stage') || '';
                bValue = $(b).data('stage') || '';
                break;
            case 'progress':
                aValue = parseInt($(a).data('progress')) || 0;
                bValue = parseInt($(b).data('progress')) || 0;
                break;
            case 'revenue':
                aValue = parseFloat($(a).data('revenue')) || 0;
                bValue = parseFloat($(b).data('revenue')) || 0;
                break;
            default:
                return 0;
        }

        // 数値の場合
        if (typeof aValue === 'number' && typeof bValue === 'number') {
            return currentSortDirection === 'asc' ? aValue - bValue : bValue - aValue;
        }

        // 文字列の場合
        if (currentSortDirection === 'asc') {
            return aValue.toString().localeCompare(bValue.toString(), 'ja');
        } else {
            return bValue.toString().localeCompare(aValue.toString(), 'ja');
        }
    });

    $.each(items, function(idx, item) {
        container.append(item);
    });

    // ソートアイコンを更新
    updateSortIcons(field);
}

function updateSortIcons(field) {
    // すべてのソートアイコンをリセット
    $('#listView .bg-white.rounded i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');

    // 現在のソートフィールドのアイコンを更新
    const iconClass = currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down';
    $('#listView .bg-white.rounded small[onclick*="' + field + '"] i')
        .removeClass('fa-sort')
        .addClass(iconClass);
}
</script>

{% endblock %}