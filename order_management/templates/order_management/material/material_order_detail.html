{% extends 'order_management/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<style>
.info-label {
    font-weight: 600;
    color: #6c757d;
    font-size: 0.85rem;
}
.info-value {
    font-size: 1rem;
    color: #212529;
}
.material-item-card {
    border-left: 3px solid #ffc107;
    background-color: #fffbf0;
}
.timeline-item {
    display: flex;
    align-items: start;
    margin-bottom: 1rem;
    padding-left: 10px;
    border-left: 2px solid #dee2e6;
}
.timeline-item i {
    margin-right: 10px;
    margin-top: 3px;
    width: 20px;
}
</style>
{% endblock %}

{% block title %}資材発注詳細 - {{ order.order_number }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-file-invoice"></i> 資材発注詳細</h2>
        <p class="text-muted">{{ project.management_no }} - {{ project.site_name }} | {{ order.order_number }}</p>
    </div>
    <div class="col text-end">
        <a href="{% url 'order_management:material_order_edit' project.id order.id %}"
           class="btn btn-warning">
            <i class="fas fa-edit"></i> 編集
        </a>
        <a href="{% url 'order_management:material_order_list' project.id %}"
           class="btn btn-secondary">
            <i class="fas fa-list"></i> 一覧へ戻る
        </a>
    </div>
</div>

<div class="row">
    <!-- 左カラム: 発注情報と資材項目 -->
    <div class="col-md-8">
        <!-- 発注基本情報 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> 発注情報</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="info-label">発注番号</div>
                        <div class="info-value"><strong>{{ order.order_number }}</strong></div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">ステータス</div>
                        <div class="info-value">
                            <span class="badge
                                {% if order.status == 'completed' %}bg-success
                                {% elif order.status == 'delivered' %}bg-info
                                {% elif order.status == 'ordered' %}bg-warning
                                {% elif order.status == 'cancelled' %}bg-danger
                                {% else %}bg-secondary
                                {% endif %} fs-6">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="info-label">資材業者</div>
                        <div class="info-value">
                            <i class="fas fa-building text-warning"></i>
                            {% if order.contractor %}
                                {{ order.contractor.name }}
                            {% else %}
                                <span class="text-muted">業者未設定</span>
                            {% endif %}
                        </div>
                        {% if order.contractor.address %}
                        <small class="text-muted">{{ order.contractor.address }}</small>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">発注日</div>
                        <div class="info-value">{{ order.order_date|date:"Y年m月d日" }}</div>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="info-label">希望納期</div>
                        <div class="info-value">
                            {% if order.delivery_date %}
                                {{ order.delivery_date|date:"Y年m月d日" }}
                            {% else %}
                                <span class="text-muted">未設定</span>
                            {% endif %}
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="info-label">実際の納品日</div>
                        <div class="info-value">
                            {% if order.actual_delivery_date %}
                                <span class="text-success">{{ order.actual_delivery_date|date:"Y年m月d日" }}</span>
                            {% else %}
                                <span class="text-muted">未納品</span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                {% if order.notes %}
                <div class="row">
                    <div class="col-12">
                        <div class="info-label">備考</div>
                        <div class="info-value bg-light p-2 rounded">{{ order.notes|linebreaks }}</div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 資材項目一覧 -->
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-boxes"></i> 資材項目</h5>
                <span class="badge bg-light text-dark">{{ order.items.count }}件</span>
            </div>
            <div class="card-body">
                {% if order.items.exists %}
                    {% for item in order.items.all %}
                    <div class="material-item-card card mb-3">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <h6 class="mb-1">
                                        <i class="fas fa-box text-warning"></i> {{ item.material_name }}
                                    </h6>
                                    {% if item.specification %}
                                    <small class="text-muted">規格: {{ item.specification }}</small>
                                    {% endif %}
                                </div>
                                <div class="col-md-2 text-center">
                                    <div class="info-label">数量</div>
                                    <div class="info-value">{{ item.quantity }} {{ item.unit }}</div>
                                </div>
                                <div class="col-md-3 text-center">
                                    <div class="info-label">単価</div>
                                    <div class="info-value">¥{{ item.unit_price|floatformat:0|intcomma }}</div>
                                </div>
                                <div class="col-md-3 text-end">
                                    <div class="info-label">小計</div>
                                    <div class="info-value text-warning">
                                        <strong>¥{{ item.total_price|floatformat:0|intcomma }}</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                        <p class="text-muted">資材項目がありません</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 右カラム: サマリーとステータス管理 -->
    <div class="col-md-4">
        <!-- 金額サマリー -->
        <div class="card shadow-sm mb-4 border-warning">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> 金額サマリー</h5>
            </div>
            <div class="card-body text-center">
                <div class="mb-3">
                    <h6 class="text-muted">合計金額</h6>
                    <h2 class="text-warning mb-0">¥{{ order.total_amount|floatformat:0|intcomma }}</h2>
                </div>
                <hr>
                <div class="row">
                    <div class="col-6">
                        <div class="info-label">項目数</div>
                        <div class="info-value">{{ order.items.count }}件</div>
                    </div>
                    <div class="col-6">
                        <div class="info-label">平均単価</div>
                        <div class="info-value">
                            {% if order.items.count > 0 %}
                                {% widthratio order.total_amount order.items.count 1 as avg %}
                                ¥{{ avg|floatformat:0|intcomma }}
                            {% else %}
                                -
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ステータス管理 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="fas fa-tasks"></i> ステータス管理</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% for value, label in order.ORDER_STATUS_CHOICES %}
                    <button class="btn
                            {% if order.status == value %}btn-warning{% else %}btn-outline-secondary{% endif %}"
                            onclick="updateStatus('{{ value }}')"
                            {% if order.status == value %}disabled{% endif %}>
                        {{ label }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>

        <!-- タイムライン -->
        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0"><i class="fas fa-clock"></i> 履歴</h6>
            </div>
            <div class="card-body">
                <div class="timeline-item">
                    <i class="fas fa-plus-circle text-success"></i>
                    <div>
                        <div class="info-label">作成日時</div>
                        <small class="text-muted">{{ order.created_at|date:"Y/m/d H:i" }}</small>
                    </div>
                </div>
                <div class="timeline-item">
                    <i class="fas fa-paper-plane text-warning"></i>
                    <div>
                        <div class="info-label">発注日</div>
                        <small class="text-muted">{{ order.order_date|date:"Y/m/d" }}</small>
                    </div>
                </div>
                {% if order.actual_delivery_date %}
                <div class="timeline-item">
                    <i class="fas fa-truck text-info"></i>
                    <div>
                        <div class="info-label">納品日</div>
                        <small class="text-muted">{{ order.actual_delivery_date|date:"Y/m/d" }}</small>
                    </div>
                </div>
                {% endif %}
                <div class="timeline-item">
                    <i class="fas fa-edit text-secondary"></i>
                    <div>
                        <div class="info-label">最終更新</div>
                        <small class="text-muted">{{ order.updated_at|date:"Y/m/d H:i" }}</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function updateStatus(newStatus) {
    fetch(`{% url 'order_management:material_order_status_update' project.id order.id %}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('エラー: ' + data.error);
        }
    })
    .catch(error => {
        alert('通信エラーが発生しました');
        console.error('Error:', error);
    });
}
</script>
{% endblock %}
