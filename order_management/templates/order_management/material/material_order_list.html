{% extends 'order_management/base.html' %}
{% load static %}
{% load humanize %}

{% block extra_css %}
<style>
.material-card {
    background: linear-gradient(135deg, #fff8e1, #fff3c4);
    border-left: 4px solid #ff9800;
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.1);
}
.material-header {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    color: white;
}
.material-status {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}
.status-draft { background-color: #e0e0e0; color: #666; }
.status-ordered { background-color: #fff3e0; color: #f57c00; }
.status-delivered { background-color: #e8f5e8; color: #2e7d32; }
.status-completed { background-color: #e3f2fd; color: #1976d2; }
.status-cancelled { background-color: #ffebee; color: #d32f2f; }
.btn-material {
    background: linear-gradient(135deg, #ff9800, #f57c00);
    border: none;
    color: white;
}
.btn-material:hover {
    background: linear-gradient(135deg, #f57c00, #ef6c00);
    color: white;
}
.material-amount {
    font-size: 1.1rem;
    font-weight: bold;
    color: #f57c00;
}
</style>
{% endblock %}

{% block title %}è³‡æç™ºæ³¨ç®¡ç† - {{ project.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="material-header p-4 mb-4 rounded">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h2 class="mb-1">ğŸ“¦ è³‡æç™ºæ³¨ç®¡ç†</h2>
                <p class="mb-0">æ¡ˆä»¶: {{ project.name }}</p>
            </div>
            <a href="{% url 'order_management:material_order_create' project.id %}" class="btn btn-light btn-lg">
                <i class="fas fa-plus"></i> æ–°è¦ç™ºæ³¨
            </a>
        </div>
    </div>

    <div class="row">
        <div class="col-md-8">
            {% if orders %}
                {% for order in orders %}
                <div class="material-card card mb-3">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="card-title mb-1">
                                    <i class="fas fa-file-invoice text-warning"></i>
                                    {{ order.order_number }}
                                </h5>
                                <p class="text-muted mb-2">
                                    <i class="fas fa-building"></i> {{ order.contractor.name }}
                                </p>
                                <span class="material-status status-{{ order.status }}">
                                    {{ order.get_status_display }}
                                </span>
                            </div>
                            <div class="col-md-3 text-center">
                                <div class="material-amount">
                                    Â¥{{ order.total_amount|floatformat:0|intcomma }}
                                </div>
                                <small class="text-muted">
                                    ç™ºæ³¨æ—¥: {{ order.order_date }}
                                </small>
                                {% if order.delivery_date %}
                                <br><small class="text-muted">
                                    ç´æœŸ: {{ order.delivery_date }}
                                </small>
                                {% endif %}
                            </div>
                            <div class="col-md-3 text-end">
                                <a href="{% url 'order_management:material_order_detail' project.id order.id %}"
                                   class="btn btn-material btn-sm me-2">
                                    è©³ç´°
                                </a>
                                <a href="{% url 'order_management:material_order_edit' project.id order.id %}"
                                   class="btn btn-outline-warning btn-sm">
                                    ç·¨é›†
                                </a>
                            </div>
                        </div>

                        {% if order.items.exists %}
                        <div class="mt-3 pt-3 border-top">
                            <div class="row">
                                {% for item in order.items.all|slice:":3" %}
                                <div class="col-md-4">
                                    <small class="text-muted">
                                        <i class="fas fa-box"></i> {{ item.material_name }}
                                        <br>æ•°é‡: {{ item.quantity }} {{ item.unit }}
                                    </small>
                                </div>
                                {% endfor %}
                                {% if order.items.count > 3 %}
                                <div class="col-md-12">
                                    <small class="text-muted">ä»– {{ order.items.count|add:"-3" }} é …ç›®...</small>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <div class="material-card card text-center py-5">
                    <div class="card-body">
                        <i class="fas fa-box-open fa-3x text-warning mb-3"></i>
                        <h4>ã¾ã è³‡æç™ºæ³¨ãŒã‚ã‚Šã¾ã›ã‚“</h4>
                        <p class="text-muted">æ–°è¦ç™ºæ³¨ãƒœã‚¿ãƒ³ã‹ã‚‰æœ€åˆã®ç™ºæ³¨ã‚’ä½œæˆã—ã¾ã—ã‚‡ã†</p>
                        <a href="{% url 'order_management:material_order_create' project.id %}" class="btn btn-material">
                            <i class="fas fa-plus"></i> æ–°è¦ç™ºæ³¨ä½œæˆ
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>

        <div class="col-md-4">
            <div class="material-card card">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-chart-pie"></i> ç™ºæ³¨ã‚µãƒãƒªãƒ¼</h5>
                </div>
                <div class="card-body">
                    {% with material_status=project.get_material_status %}
                    <div class="row text-center">
                        <div class="col-6 mb-3">
                            <div class="h4 text-warning">{{ material_status.total_orders }}</div>
                            <small class="text-muted">ç·ç™ºæ³¨æ•°</small>
                        </div>
                        <div class="col-6 mb-3">
                            <div class="h4 text-success">Â¥{{ material_status.total_amount|floatformat:0|intcomma }}</div>
                            <small class="text-muted">ç·é‡‘é¡</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <span>ä¸‹æ›¸ã</span>
                            <span class="badge bg-secondary">{{ material_status.draft_count }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>ç™ºæ³¨æ¸ˆã¿</span>
                            <span class="badge bg-warning">{{ material_status.ordered_count }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>ç´å“æ¸ˆã¿</span>
                            <span class="badge bg-success">{{ material_status.delivered_count }}</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>å®Œäº†</span>
                            <span class="badge bg-info">{{ material_status.completed_count }}</span>
                        </div>
                    </div>
                    {% endwith %}
                </div>
            </div>

            <div class="material-card card mt-3">
                <div class="card-header bg-warning text-white">
                    <h6 class="mb-0"><i class="fas fa-info-circle"></i> æ“ä½œã‚¬ã‚¤ãƒ‰</h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled small">
                        <li class="mb-2"><i class="fas fa-plus text-warning"></i> æ–°è¦ç™ºæ³¨ã§è³‡æã‚’æ³¨æ–‡</li>
                        <li class="mb-2"><i class="fas fa-edit text-warning"></i> ç·¨é›†ã§å†…å®¹ã‚’å¤‰æ›´</li>
                        <li class="mb-2"><i class="fas fa-eye text-warning"></i> è©³ç´°ã§é€²æ—ç¢ºèª</li>
                        <li class="mb-2"><i class="fas fa-check text-warning"></i> ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ã§é€²è¡ŒçŠ¶æ³ã‚’æ›´æ–°</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="mt-4">
        <a href="{% url 'order_management:project_detail' project.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> æ¡ˆä»¶è©³ç´°ã«æˆ»ã‚‹
        </a>
    </div>
</div>
{% endblock %}