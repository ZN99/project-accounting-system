{% extends 'order_management/base.html' %}
{% load static %}

{% block title %}{% if is_create %}チェックリストテンプレート作成{% else %}チェックリストテンプレート編集{% endif %}{% endblock %}

{% block extra_css %}
<style>
    .form-container {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 2rem 0;
    }

    .form-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(71,85,105,0.08);
        max-width: 900px;
        margin: 0 auto;
    }

    .form-header {
        background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 2rem;
    }

    .items-section {
        background: #f9fafb;
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
    }

    .checklist-item {
        background: white;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border: 1px solid #e5e7eb;
    }

    .item-handle {
        cursor: move;
        color: #9ca3af;
        font-size: 1.2rem;
    }

    .item-handle:hover {
        color: #6366f1;
    }

    .btn-add-item {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border: none;
    }

    .btn-add-item:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="form-container">
    <div class="container">
        <div class="form-card">
            <div class="form-header">
                <h2 class="mb-2">
                    <i class="fas fa-clipboard-list me-2"></i>
                    {% if is_create %}チェックリストテンプレート作成{% else %}チェックリストテンプレート編集{% endif %}
                </h2>
                <p class="mb-0 opacity-75">Checklist Template Form</p>
            </div>

            <form method="post" id="template-form">
                {% csrf_token %}

                <!-- 基本情報 -->
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        テンプレート名 <span class="text-danger">*</span>
                    </label>
                    {{ form.name }}
                    {% if form.name.errors %}
                    <div class="text-danger small mt-1">{{ form.name.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">
                        施工種別 <span class="text-danger">*</span>
                    </label>
                    {{ form.work_type }}
                    <div class="form-text">
                        例: 解体工事、電気工事、内装工事など
                    </div>
                    {% if form.work_type.errors %}
                    <div class="text-danger small mt-1">{{ form.work_type.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <label class="form-label fw-bold">説明</label>
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="text-danger small mt-1">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <div class="form-check">
                        {{ form.is_active }}
                        <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                            アクティブ
                        </label>
                    </div>
                </div>

                <!-- チェック項目 -->
                <div class="items-section">
                    <h5 class="mb-3">
                        <i class="fas fa-list me-2"></i>チェック項目
                    </h5>
                    <p class="text-muted small mb-3">
                        案件に適用する際のチェック項目を設定します。ドラッグで並び替えできます。
                    </p>

                    <div id="items-list">
                        <!-- Items will be added dynamically -->
                    </div>

                    <button type="button" class="btn btn-success btn-add-item w-100" onclick="addItem()">
                        <i class="fas fa-plus me-2"></i>項目を追加
                    </button>
                </div>

                <input type="hidden" name="items_json" id="items-json">

                {% if form.errors %}
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    入力内容にエラーがあります。ご確認ください。
                </div>
                {% endif %}

                <!-- アクション -->
                <div class="d-flex gap-2 justify-content-end">
                    <a href="{% url 'order_management:checklist_template_list' %}"
                       class="btn btn-outline-secondary">
                        <i class="fas fa-times me-2"></i>キャンセル
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-2"></i>保存
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
let items = {{ items|safe|default:"[]" }};
let itemCounter = items.length;

function renderItems() {
    const itemsList = document.getElementById('items-list');
    itemsList.innerHTML = '';

    items.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'checklist-item';
        itemDiv.innerHTML = `
            <div class="row align-items-start">
                <div class="col-auto">
                    <span class="item-handle">
                        <i class="fas fa-grip-vertical"></i>
                    </span>
                </div>
                <div class="col">
                    <input type="text" class="form-control mb-2" placeholder="項目名 *"
                           value="${item.name || ''}"
                           onchange="updateItem(${index}, 'name', this.value)">
                    <textarea class="form-control" rows="2" placeholder="説明（任意）"
                              onchange="updateItem(${index}, 'description', this.value)">${item.description || ''}</textarea>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-outline-danger btn-sm"
                            onclick="removeItem(${index})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
        itemsList.appendChild(itemDiv);
    });

    updateItemsJson();
}

function addItem() {
    items.push({
        name: '',
        description: '',
        order: items.length + 1
    });
    renderItems();
}

function removeItem(index) {
    if (confirm('この項目を削除しますか？')) {
        items.splice(index, 1);
        // Reorder
        items.forEach((item, idx) => {
            item.order = idx + 1;
        });
        renderItems();
    }
}

function updateItem(index, field, value) {
    items[index][field] = value;
    updateItemsJson();
}

function updateItemsJson() {
    document.getElementById('items-json').value = JSON.stringify(items);
}

// Form submission validation
document.getElementById('template-form').addEventListener('submit', function(e) {
    // Check if all items have names
    const emptyItems = items.filter(item => !item.name || item.name.trim() === '');
    if (emptyItems.length > 0) {
        e.preventDefault();
        alert('全ての項目に名前を入力してください。');
        return false;
    }

    updateItemsJson();
});

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    if (items.length === 0) {
        // Add one default item for new templates
        {% if is_create %}
        addItem();
        {% endif %}
    } else {
        renderItems();
    }
});

// Make items sortable (simple drag and drop)
let draggedIndex = null;

document.getElementById('items-list').addEventListener('dragstart', function(e) {
    if (e.target.closest('.checklist-item')) {
        const items = Array.from(document.querySelectorAll('.checklist-item'));
        draggedIndex = items.indexOf(e.target.closest('.checklist-item'));
    }
});

document.getElementById('items-list').addEventListener('dragover', function(e) {
    e.preventDefault();
});

document.getElementById('items-list').addEventListener('drop', function(e) {
    e.preventDefault();
    if (draggedIndex !== null) {
        const items = Array.from(document.querySelectorAll('.checklist-item'));
        const targetItem = e.target.closest('.checklist-item');
        if (targetItem) {
            const targetIndex = items.indexOf(targetItem);
            if (draggedIndex !== targetIndex) {
                // Swap items
                const temp = items[draggedIndex];
                items.splice(draggedIndex, 1);
                items.splice(targetIndex, 0, temp);

                // Update data
                const draggedData = items.splice(draggedIndex, 1)[0];
                items.splice(targetIndex, 0, draggedData);

                renderItems();
            }
        }
        draggedIndex = null;
    }
});

// Make items draggable
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('items-list').addEventListener('mousedown', function(e) {
        const handle = e.target.closest('.item-handle');
        if (handle) {
            handle.closest('.checklist-item').draggable = true;
        }
    });
});
</script>
{% endblock %}
