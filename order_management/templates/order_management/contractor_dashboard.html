{% extends "order_management/base.html" %}
{% load humanize %}

{% block title %}ÂèóÊ≥®Ê•≠Âãô„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ - Âª∫ÁØâÊ¥æÈÅ£ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†{% endblock %}

{% block extra_css %}
<style>
    .dashboard-card {
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }
    .dashboard-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }
    .metric-label {
        opacity: 0.9;
        font-size: 0.9rem;
    }
    .profit-positive {
        color: #28a745;
        font-weight: bold;
    }
    .profit-negative {
        color: #dc3545;
        font-weight: bold;
    }
    .table-hover tbody tr:hover {
        background-color: #f8f9fa;
    }
    .chart-container {
        position: relative;
        height: 300px;
        margin-bottom: 20px;
    }
    .performance-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 500;
    }
    .performance-excellent {
        background-color: #d4edda;
        color: #155724;
    }
    .performance-good {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    .performance-average {
        background-color: #fff3cd;
        color: #856404;
    }
    .performance-poor {
        background-color: #f8d7da;
        color: #721c24;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- „Éò„ÉÉ„ÉÄ„Éº -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-handshake me-2"></i>ÂèóÊ≥®Ê•≠Âãô„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i>ExcelÂá∫Âäõ
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="printReport()">
                    <i class="fas fa-print me-1"></i>Âç∞Âà∑
                </button>
            </div>
            <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#filterModal">
                <i class="fas fa-filter me-1"></i>„Éï„Ç£„É´„Çø„Éº
            </button>
        </div>
    </div>

    <!-- „Çµ„Éû„É™„Éº„Ç´„Éº„Éâ -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="metric-label">Á∑èÊ•≠ËÄÖÊï∞</div>
                        <div class="metric-value">{{ summary.total_contractors }}</div>
                    </div>
                    <i class="fas fa-building fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="metric-label">Á∑èÊ°à‰ª∂Êï∞</div>
                        <div class="metric-value">{{ summary.total_projects|intcomma }}</div>
                    </div>
                    <i class="fas fa-folder fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="metric-label">Á∑èÂ£≤‰∏äÈ´ò</div>
                        <div class="metric-value">¬•{{ summary.total_revenue|floatformat:0|intcomma }}</div>
                    </div>
                    <i class="fas fa-yen-sign fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="metric-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="metric-label">Âπ≥ÂùáÂà©ÁõäÁéá</div>
                        <div class="metric-value">{{ summary.avg_profit_rate|floatformat:1 }}%</div>
                    </div>
                    <i class="fas fa-percentage fa-2x opacity-75"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê•≠ËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÜ„Éº„Éñ„É´ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card dashboard-card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Ê•≠ËÄÖÂà•„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ‰∏ÄË¶ß
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="contractorTable">
                            <thead class="table-light">
                                <tr>
                                    <th class="sortable" data-sort="name" style="cursor: pointer;">
                                        Ê•≠ËÄÖÂêç <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="text-center">Ê•≠ËÄÖ„Çø„Ç§„Éó„ÉªÂ∞ÇÈñÄÂàÜÈáé</th>
                                    <th class="text-end sortable" data-sort="project_count" style="cursor: pointer;">
                                        ÂèóÊ≥®‰ª∂Êï∞ <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="total_revenue" style="cursor: pointer;">
                                        Â£≤‰∏äÂêàË®à <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="total_cost" style="cursor: pointer;">
                                        Âéü‰æ° <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="text-end sortable" data-sort="profit" style="cursor: pointer;">
                                        Âà©ÁõäÈ°ç <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="text-center sortable" data-sort="profit_rate" style="cursor: pointer;">
                                        Âà©ÁõäÁéá <i class="fas fa-sort ms-1"></i>
                                    </th>
                                    <th class="text-center">Ë©ï‰æ°</th>
                                    <th class="text-center">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for contractor in contractors %}
                                <tr class="contractor-row" data-contractor-id="{{ contractor.id }}"
                                    data-name="{{ contractor.name }}"
                                    data-project-count="{{ contractor.project_count }}"
                                    data-total-revenue="{{ contractor.total_revenue }}"
                                    data-total-cost="{{ contractor.total_cost }}"
                                    data-profit="{{ contractor.profit }}"
                                    data-profit-rate="{{ contractor.profit_rate }}"
                                    style="cursor: pointer;">
                                    <td>
                                        <strong>{{ contractor.name }}</strong>
                                        {% if contractor.status == 'active' %}
                                            <span class="badge bg-success ms-2">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</span>
                                        {% else %}
                                            <span class="badge bg-secondary ms-2">Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <div class="mb-1">
                                            {% for tag in contractor.contractor_tags %}
                                                {% if tag == "Áô∫Ê≥®Ê•≠ËÄÖ" %}
                                                    <span class="badge bg-primary me-1">{{ tag }}</span>
                                                {% elif tag == "ÂèóÊ≥®Ê•≠ËÄÖ" %}
                                                    <span class="badge bg-success me-1">{{ tag }}</span>
                                                {% elif tag == "Ë≥áÊùêÂ±ã" %}
                                                    <span class="badge bg-warning text-dark me-1">{{ tag }}</span>
                                                {% elif tag == "„Åù„ÅÆ‰ªñ" %}
                                                    <span class="badge bg-secondary me-1">{{ tag }}</span>
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                        <small class="text-muted">{{ contractor.specialties|default:"Êú™Ë®≠ÂÆö" }}</small>
                                    </td>
                                    <td class="text-end">
                                        <span class="badge bg-info">{{ contractor.project_count }}‰ª∂</span>
                                    </td>
                                    <td class="text-end">
                                        <strong>¬•{{ contractor.total_revenue|floatformat:0|intcomma }}</strong>
                                    </td>
                                    <td class="text-end text-muted">
                                        ¬•{{ contractor.total_cost|floatformat:0|intcomma }}
                                    </td>
                                    <td class="text-end {% if contractor.profit > 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                        ¬•{{ contractor.profit|floatformat:0|intcomma }}
                                    </td>
                                    <td class="text-center">
                                        {% if contractor.profit_rate >= 25 %}
                                            <span class="performance-badge performance-excellent">
                                                {{ contractor.profit_rate|floatformat:1 }}%
                                            </span>
                                        {% elif contractor.profit_rate >= 20 %}
                                            <span class="performance-badge performance-good">
                                                {{ contractor.profit_rate|floatformat:1 }}%
                                            </span>
                                        {% elif contractor.profit_rate >= 15 %}
                                            <span class="performance-badge performance-average">
                                                {{ contractor.profit_rate|floatformat:1 }}%
                                            </span>
                                        {% else %}
                                            <span class="performance-badge performance-poor">
                                                {{ contractor.profit_rate|floatformat:1 }}%
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        {% if contractor.profit_rate >= 25 %}
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="fas fa-star text-warning"></i>
                                        {% elif contractor.profit_rate >= 20 %}
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="far fa-star text-warning"></i>
                                        {% elif contractor.profit_rate >= 15 %}
                                            <i class="fas fa-star text-warning"></i>
                                            <i class="far fa-star text-warning"></i>
                                            <i class="far fa-star text-warning"></i>
                                        {% else %}
                                            <i class="far fa-star text-muted"></i>
                                            <i class="far fa-star text-muted"></i>
                                            <i class="far fa-star text-muted"></i>
                                        {% endif %}
                                    </td>
                                    <td class="text-center">
                                        <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); viewContractorDetail('{{ contractor.id }}', '{{ contractor.name }}')">
                                            <i class="fas fa-chart-line"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); editContractor('{{ contractor.id }}')">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- „Ç∞„É©„Éï„Çª„ÇØ„Ç∑„Éß„É≥ -->
    <div class="row">
        <!-- Áµ±Âêà„Ç∞„É©„ÉïÔºàÊúàÂà•Â£≤‰∏ä„ÉªÂà©Áõä„ÉªÂà©ÁõäÁéáÊé®ÁßªÔºâ -->
        <div class="col-lg-12 mb-4">
            <div class="card dashboard-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>ÊúàÂà•Â£≤‰∏ä„ÉªÂà©Áõä„ÉªÂà©ÁõäÁéáÊé®Áßª
                    </h6>
                    <button class="btn btn-sm btn-outline-primary" type="button" data-bs-toggle="collapse" data-bs-target="#integratedChartOptions">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="collapse mb-3" id="integratedChartOptions">
                        <div class="border rounded p-3 bg-light">
                            <!-- „Éá„Éº„Çø„Çø„Ç§„ÉóÈÅ∏Êäû -->
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <strong>Ë°®Á§∫„Éá„Éº„Çø:</strong>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showRevenue" checked>
                                        <label class="form-check-label" for="showRevenue">üí∞ Â£≤‰∏ä</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showProfit" checked>
                                        <label class="form-check-label" for="showProfit">üìà Âà©ÁõäÈ°ç</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="showProfitRate" checked>
                                        <label class="form-check-label" for="showProfitRate">üìä Âà©ÁõäÁéá(%)</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <strong>Âà©ÁõäÁéáË°®Á§∫ÊñπÂºè:</strong>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="profitRateMode" id="profitRateSingle" checked>
                                        <label class="form-check-label" for="profitRateSingle">ÂçòÊúàÂà©ÁõäÁéá</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="profitRateMode" id="profitRateCumulative">
                                        <label class="form-check-label" for="profitRateCumulative">Á¥ØË®àÂà©ÁõäÁéá</label>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <strong>„ÉÅ„É£„Éº„ÉàÁ®ÆÂà•:</strong>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="chartType" id="chartTypeLine" checked>
                                        <label class="form-check-label" for="chartTypeLine">Á∑ö„Ç∞„É©„Éï</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="chartType" id="chartTypeBar">
                                        <label class="form-check-label" for="chartTypeBar">Ê£í„Ç∞„É©„Éï</label>
                                    </div>
                                </div>
                            </div>
                                </div>
                                <div class="col-md-6">
                                    <strong>ÈõÜË®àÊñπÂºè:</strong>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="revenueAggregation" id="revenueSingle" checked>
                                        <label class="form-check-label" for="revenueSingle">ÂçòÊúà</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="revenueAggregation" id="revenueCumulative">
                                        <label class="form-check-label" for="revenueCumulative">Á¥ØË®à</label>
                                    </div>
                                </div>
                            </div>

                            <!-- Ê•≠ËÄÖÈÅ∏Êäû -->
                            <div class="mb-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong>Ë°®Á§∫„Åô„ÇãÊ•≠ËÄÖ:</strong>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                            ÈÅ∏Êäû„Ç™„Éó„Ç∑„Éß„É≥
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); selectAllContractors('revenue');"><i class="fas fa-check-square me-2"></i>„Åô„Åπ„Å¶ÈÅ∏Êäû</a></li>
                                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); clearAllContractors('revenue');"><i class="far fa-square me-2"></i>„Åô„Åπ„Å¶„ÇØ„É™„Ç¢</a></li>
                                            <li><hr class="dropdown-divider"></li>
                                            <li><a class="dropdown-item" href="#" onclick="event.preventDefault(); event.stopPropagation(); selectTopPerformers('revenue');"><i class="fas fa-star me-2"></i>‰∏ä‰ΩçÊ•≠ËÄÖ„ÅÆ„Åø</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="form-check form-check-inline mb-2">
                                <input class="form-check-input revenue-contractor-checkbox" type="checkbox" id="revenueAllToggle" checked>
                                <label class="form-check-label fw-bold text-primary" for="revenueAllToggle">
                                    ÂÖ®‰ΩìÂêàË®à
                                </label>
                            </div>
                            <div class="border-top pt-2">
                                {% for contractor in contractors %}
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input contractor-checkbox" type="checkbox" id="contractor{{ forloop.counter }}" value="{{ contractor.name }}" data-index="{{ forloop.counter0 }}" checked>
                                    <label class="form-check-label" for="contractor{{ forloop.counter }}">
                                        {{ contractor.name }}
                                    </label>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    <div class="chart-container" style="height: 500px;">
                        <canvas id="integratedChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê•≠ËÄÖÂà•Â£≤‰∏äÊßãÊàê -->
        <div class="col-lg-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-pie me-2"></i>Ê•≠ËÄÖÂà•Â£≤‰∏äÊßãÊàê
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="contractorPieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ê•≠ËÄÖÂà•Âà©ÁõäÁéáÊØîËºÉ -->
        <div class="col-lg-6 mb-4">
            <div class="card dashboard-card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Ê•≠ËÄÖÂà•Âà©ÁõäÁéáÊØîËºÉ
                    </h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="profitRateBarChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Ê•≠ËÄÖË©≥Á¥∞„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="contractorDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-building me-2"></i>
                    <span id="modalContractorName"></span>„ÅÆË©≥Á¥∞ÂàÜÊûê
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-12">
                        <div class="chart-container" style="height: 400px;">
                            <canvas id="contractorTrendChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
                <button type="button" class="btn btn-primary" onclick="exportContractorData()">
                    <i class="fas fa-download me-1"></i>„Éá„Éº„ÇøÂá∫Âäõ
                </button>
            </div>
        </div>
    </div>
</div>

<!-- „Éï„Ç£„É´„Çø„Éº„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="filterModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-filter me-2"></i>„Éï„Ç£„É´„Çø„ÉºË®≠ÂÆö
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="filterForm">
                    <div class="mb-3">
                        <label class="form-label">ÊúüÈñì</label>
                        <select class="form-select" name="period">
                            <option value="all">ÂÖ®ÊúüÈñì</option>
                            <option value="12months" selected>ÈÅéÂéª12„É∂Êúà</option>
                            <option value="6months">ÈÅéÂéª6„É∂Êúà</option>
                            <option value="3months">ÈÅéÂéª3„É∂Êúà</option>
                            <option value="1month">ÈÅéÂéª1„É∂Êúà</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ê•≠ËÄÖ„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                        <select class="form-select" name="status">
                            <option value="all">„Åô„Åπ„Å¶</option>
                            <option value="active">„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÅÆ„Åø</option>
                            <option value="inactive">Èùû„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÅÆ„Åø</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Âà©ÁõäÁéá</label>
                        <select class="form-select" name="profit_rate">
                            <option value="all">„Åô„Åπ„Å¶</option>
                            <option value="excellent">25%‰ª•‰∏ä</option>
                            <option value="good">20%‰ª•‰∏ä</option>
                            <option value="average">15%‰ª•‰∏ä</option>
                            <option value="poor">15%Êú™Ê∫Ä</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" class="btn btn-primary" onclick="applyFilter()">ÈÅ©Áî®</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÇíJSON„Å®„Åó„Å¶Âèó„ÅëÂèñ„Çã
let contractorsData = JSON.parse('{{ contractors_json|escapejs }}');
let monthlyData = JSON.parse('{{ monthly_data_json|escapejs }}');
let chartLabels = JSON.parse('{{ chart_labels_json|escapejs }}');

// „ÉÅ„É£„Éº„Éà„Ç§„É≥„Çπ„Çø„É≥„Çπ„Çí‰øùÊåÅ
let integratedChartInstance = null;

// ÈáçË§á„Åó„ÅüÂàùÊúüÂåñ„ÇíÂâäÈô§
// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ„ÅØÊúÄÂæå„ÅÆÊñπ„ÅßÁµ±‰∏Ä

// „ÉÅ„É£„Éº„Éà„ÅÆÂàùÊúüÂåñ
function initializeCharts() {
    // ÊúàÂà•Â£≤‰∏ä„ÉªÂà©ÁõäÊé®Áßª„ÉÅ„É£„Éº„Éà
    const integratedCtx = document.getElementById('integratedChart').getContext('2d');
    integratedChartInstance = new Chart(integratedCtx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [
                {
                    label: 'Â£≤‰∏äÈ´ò',
                    data: monthlyData.map(d => d.revenue),
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.1)',
                    tension: 0.1
                },
                {
                    label: 'Âà©Áõä',
                    data: monthlyData.map(d => d.profit),
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.1)',
                    tension: 0.1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            label += '¬•' + context.parsed.y.toLocaleString();
                            return label;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '¬•' + value.toLocaleString();
                        }
                    }
                }
            }
        }
    });

    // ÊúàÂà•Âà©ÁõäÁéáÊé®Áßª„ÉÅ„É£„Éº„Éà
    const profitRateCtx = document.getElementById('profitRateChart').getContext('2d');
    profitRateChartInstance = new Chart(profitRateCtx, {
        type: 'line',
        data: {
            labels: chartLabels,
            datasets: [{
                label: 'Âà©ÁõäÁéá',
                data: monthlyData.map(d => d.profit_rate),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.1)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Âà©ÁõäÁéá: ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });

    // Ê•≠ËÄÖÂà•Â£≤‰∏äÊßãÊàê„ÉÅ„É£„Éº„Éà
    const pieCtx = document.getElementById('contractorPieChart').getContext('2d');
    const topContractors = contractorsData.slice(0, 5);
    new Chart(pieCtx, {
        type: 'pie',
        data: {
            labels: topContractors.map(c => c.name),
            datasets: [{
                data: topContractors.map(c => c.total_revenue),
                backgroundColor: [
                    'rgba(255, 99, 132, 0.8)',
                    'rgba(54, 162, 235, 0.8)',
                    'rgba(255, 206, 86, 0.8)',
                    'rgba(75, 192, 192, 0.8)',
                    'rgba(153, 102, 255, 0.8)'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = '¬•' + context.parsed.toLocaleString();
                            const percentage = ((context.parsed / context.dataset.data.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                            return label + ': ' + value + ' (' + percentage + '%)';
                        }
                    }
                }
            }
        }
    });

    // Ê•≠ËÄÖÂà•Âà©ÁõäÁéáÊØîËºÉ„ÉÅ„É£„Éº„Éà
    const barCtx = document.getElementById('profitRateBarChart').getContext('2d');
    new Chart(barCtx, {
        type: 'bar',
        data: {
            labels: contractorsData.map(c => c.name),
            datasets: [{
                label: 'Âà©ÁõäÁéá',
                data: contractorsData.map(c => c.profit_rate),
                backgroundColor: contractorsData.map(c => {
                    if (c.profit_rate >= 25) return 'rgba(40, 167, 69, 0.8)';
                    if (c.profit_rate >= 20) return 'rgba(23, 162, 184, 0.8)';
                    if (c.profit_rate >= 15) return 'rgba(255, 193, 7, 0.8)';
                    return 'rgba(220, 53, 69, 0.8)';
                })
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Âà©ÁõäÁéá: ' + context.parsed.y.toFixed(1) + '%';
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Ê•≠ËÄÖË©≥Á¥∞Ë°®Á§∫
function viewContractorDetail(contractorId, contractorName) {
    const contractor = contractorsData.find(c => c.id == contractorId);
    if (!contractor) return;

    document.getElementById('modalContractorName').textContent = contractorName;

    const modal = new bootstrap.Modal(document.getElementById('contractorDetailModal'));
    modal.show();

    // „É¢„Éº„ÉÄ„É´Ë°®Á§∫Âæå„Å´„ÉÅ„É£„Éº„Éà„ÇíÊèèÁîª
    setTimeout(() => {
        const ctx = document.getElementById('contractorTrendChart').getContext('2d');

        // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„Åå„ÅÇ„Çå„Å∞Á†¥Ê£Ñ
        if (window.contractorChart) {
            window.contractorChart.destroy();
        }

        window.contractorChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: contractor.monthly_trends.map(d => d.month),
                datasets: [
                    {
                        label: 'Â£≤‰∏äÈ´ò',
                        data: contractor.monthly_trends.map(d => d.revenue),
                        borderColor: 'rgb(54, 162, 235)',
                        backgroundColor: 'rgba(54, 162, 235, 0.1)',
                        yAxisID: 'y',
                        tension: 0.1
                    },
                    {
                        label: 'Âà©Áõä',
                        data: contractor.monthly_trends.map(d => d.profit),
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        yAxisID: 'y',
                        tension: 0.1
                    },
                    {
                        label: 'Âà©ÁõäÁéá',
                        data: contractor.monthly_trends.map(d => d.profit_rate),
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.1)',
                        yAxisID: 'y1',
                        tension: 0.1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        ticks: {
                            callback: function(value) {
                                return '¬•' + value.toLocaleString();
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false,
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }, 200);
}

// Ê•≠ËÄÖÁ∑®ÈõÜ
function editContractor(contractorId) {
    // Ê•≠ËÄÖÁ∑®ÈõÜÁîªÈù¢„Å∏ÈÅ∑Áßª
    window.location.href = `/orders/contractors/${contractorId}/edit/`;
}

// „Éá„Éº„Çø„ÉÜ„Éº„Éñ„É´ÂàùÊúüÂåñ
function initializeDataTable() {
    // Ê•≠ËÄÖË°å„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíË®≠ÂÆö
    document.querySelectorAll('.contractor-row').forEach(row => {
        row.addEventListener('click', function(e) {
            // „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„ÅØË°å„ÇØ„É™„ÉÉ„ÇØ„ÇíÁÑ°Ë¶ñ
            if (e.target.closest('button')) return;

            const contractorId = this.dataset.contractorId;
            if (contractorId) {
                window.location.href = `/orders/contractor/${contractorId}/projects/`;
            }
        });

        // „Éõ„Éê„ÉºÂäπÊûú„ÇíËøΩÂä†
        row.addEventListener('mouseenter', function() {
            this.style.backgroundColor = '#f8f9fa';
        });

        row.addEventListener('mouseleave', function() {
            this.style.backgroundColor = '';
        });
    });
}

// „Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®
function applyFilter() {
    const form = document.getElementById('filterForm');
    const formData = new FormData(form);

    // „Éï„Ç£„É´„Çø„ÉºÊù°‰ª∂„Å´Âü∫„Å•„ÅÑ„Å¶„Éá„Éº„Çø„ÇíÂÜçÂèñÂæó
    console.log('„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®:', Object.fromEntries(formData));

    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    bootstrap.Modal.getInstance(document.getElementById('filterModal')).hide();

    // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åæ„Åü„ÅØAJAX„Åß„Éá„Éº„ÇøÊõ¥Êñ∞
    location.reload();
}

// ExcelÂá∫Âäõ
function exportToExcel() {
    // ExcelÂá∫ÂäõÂá¶ÁêÜ
    alert('ExcelÂá∫ÂäõÊ©üËÉΩ„ÅØÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
}

// Âç∞Âà∑
function printReport() {
    window.print();
}

// Ê•≠ËÄÖ„Éá„Éº„ÇøÂá∫Âäõ
function exportContractorData() {
    alert('Ê•≠ËÄÖ„Éá„Éº„ÇøÂá∫ÂäõÊ©üËÉΩ„ÅØÂÆüË£Ö‰∫àÂÆö„Åß„Åô');
}

// „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
function setupChartCheckboxListeners() {
    // Â£≤‰∏ä„ÉªÂà©Áõä„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ
    document.querySelectorAll('.revenue-contractor-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateRevenueChart);
    });

    // Âà©ÁõäÁéá„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ
    document.querySelectorAll('.profit-rate-contractor-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateProfitRateChart);
    });

    // „Éá„Éº„Çø„Çø„Ç§„Éó„Å®ÈõÜË®àÊñπÂºè„ÅÆ„É™„Çπ„Éä„Éº
    ['revenueShowRevenue', 'revenueShowProfit', 'revenueSingle', 'revenueCumulative'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', updateRevenueChart);
        }
    });

    ['profitRateSingle', 'profitRateCumulative'].forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.addEventListener('change', updateProfitRateChart);
        }
    });
}

// Â£≤‰∏ä„ÉªÂà©Áõä„ÉÅ„É£„Éº„Éà„ÅÆÊõ¥Êñ∞
function updateRevenueChart() {
    const showTotal = document.getElementById('revenueAllToggle').checked;
    const showRevenue = document.getElementById('revenueShowRevenue').checked;
    const showProfit = document.getElementById('revenueShowProfit').checked;
    const isCumulative = document.getElementById('revenueCumulative').checked;
    const selectedContractors = [];

    document.querySelectorAll('.revenue-contractor-checkbox:not(#revenueAllToggle)').forEach(checkbox => {
        if (checkbox.checked) {
            selectedContractors.push(checkbox.value);
        }
    });

    // „Éá„Éº„Çø„ÇíÂá¶ÁêÜÔºàÁ¥ØË®à„Åæ„Åü„ÅØÂçòÊúàÔºâ
    let processedMonthlyData = [...monthlyData];
    if (isCumulative) {
        let cumulativeRevenue = 0;
        let cumulativeProfit = 0;
        processedMonthlyData = monthlyData.map(item => {
            cumulativeRevenue += item.revenue;
            cumulativeProfit += item.profit;
            return {
                ...item,
                revenue: cumulativeRevenue,
                profit: cumulativeProfit
            };
        });
    }

    // Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„Çª„ÉÉ„Éà„Çí‰ΩúÊàê
    const newDatasets = [];

    // ÂÖ®‰ΩìÂêàË®à„ÇíË°®Á§∫
    if (showTotal) {
        if (showRevenue) {
            newDatasets.push({
                label: 'Â£≤‰∏äÈ´òÔºàÂÖ®‰ΩìÔºâ',
                data: processedMonthlyData.map(d => d.revenue),
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                tension: 0.1,
                borderWidth: 3
            });
        }
        if (showProfit) {
            newDatasets.push({
                label: 'Âà©ÁõäÔºàÂÖ®‰ΩìÔºâ',
                data: processedMonthlyData.map(d => d.profit),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.1)',
                tension: 0.1,
                borderWidth: 3
            });
        }
    }

    // ÂêÑÊ•≠ËÄÖ„ÅÆ„Éá„Éº„Çø„ÇíËøΩÂä†
    const colors = [
        { border: 'rgb(255, 99, 132)', bg: 'rgba(255, 99, 132, 0.1)' },
        { border: 'rgb(255, 159, 64)', bg: 'rgba(255, 159, 64, 0.1)' },
        { border: 'rgb(255, 205, 86)', bg: 'rgba(255, 205, 86, 0.1)' },
        { border: 'rgb(153, 102, 255)', bg: 'rgba(153, 102, 255, 0.1)' },
        { border: 'rgb(201, 203, 207)', bg: 'rgba(201, 203, 207, 0.1)' }
    ];

    selectedContractors.forEach((contractorName, index) => {
        const contractor = contractorsData.find(c => c.name === contractorName);
        if (contractor && contractor.monthly_trends) {
            const colorIndex = index % colors.length;

            // Á¥ØË®àÂá¶ÁêÜ
            let contractorData = [...contractor.monthly_trends];
            if (isCumulative) {
                let cumulativeRevenue = 0;
                let cumulativeProfit = 0;
                contractorData = contractor.monthly_trends.map(item => {
                    cumulativeRevenue += item.revenue;
                    cumulativeProfit += item.profit;
                    return {
                        ...item,
                        revenue: cumulativeRevenue,
                        profit: cumulativeProfit
                    };
                });
            }

            // Â£≤‰∏ä„Éá„Éº„Çø
            if (showRevenue) {
                newDatasets.push({
                    label: `Â£≤‰∏äÔºà${contractor.name}Ôºâ`,
                    data: contractorData.map(d => d.revenue),
                    borderColor: colors[colorIndex].border,
                    backgroundColor: colors[colorIndex].bg,
                    tension: 0.1,
                    borderWidth: 2,
                    borderDash: [5, 5]
                });
            }

            // Âà©Áõä„Éá„Éº„Çø
            if (showProfit) {
                newDatasets.push({
                    label: `Âà©ÁõäÔºà${contractor.name}Ôºâ`,
                    data: contractorData.map(d => d.profit),
                    borderColor: colors[colorIndex].border,
                    backgroundColor: colors[colorIndex].bg,
                    tension: 0.1,
                    borderWidth: 1,
                    borderDash: [2, 2]
                });
            }
        }
    });

    // „ÉÅ„É£„Éº„Éà„ÇíÊõ¥Êñ∞
    revenueChartInstance.data.datasets = newDatasets;
    revenueChartInstance.update();
}

// Âà©ÁõäÁéá„ÉÅ„É£„Éº„Éà„ÅÆÊõ¥Êñ∞
function updateProfitRateChart() {
    const showAverage = document.getElementById('profitRateAllToggle').checked;
    const isCumulative = document.getElementById('profitRateCumulative').checked;
    const selectedContractors = [];

    document.querySelectorAll('.profit-rate-contractor-checkbox:not(#profitRateAllToggle)').forEach(checkbox => {
        if (checkbox.checked) {
            selectedContractors.push(checkbox.value);
        }
    });

    // „Éá„Éº„Çø„ÇíÂá¶ÁêÜÔºàÁ¥ØË®à„Åæ„Åü„ÅØÂçòÊúàÔºâ
    let processedMonthlyData = [...monthlyData];
    if (isCumulative) {
        let cumulativeRevenue = 0;
        let cumulativeProfit = 0;
        processedMonthlyData = monthlyData.map(item => {
            cumulativeRevenue += item.revenue;
            cumulativeProfit += item.profit;
            const profitRate = cumulativeRevenue > 0 ? (cumulativeProfit / cumulativeRevenue * 100) : 0;
            return {
                ...item,
                profit_rate: profitRate
            };
        });
    }

    // Êñ∞„Åó„ÅÑ„Éá„Éº„Çø„Çª„ÉÉ„Éà„Çí‰ΩúÊàê
    const newDatasets = [];

    // ÂÖ®‰ΩìÂπ≥Âùá„ÇíË°®Á§∫
    if (showAverage) {
        newDatasets.push({
            label: 'Âà©ÁõäÁéáÔºàÂÖ®‰ΩìÂπ≥ÂùáÔºâ',
            data: processedMonthlyData.map(d => d.profit_rate),
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.1)',
            tension: 0.1,
            borderWidth: 3
        });
    }

    // ÂêÑÊ•≠ËÄÖ„ÅÆ„Éá„Éº„Çø„ÇíËøΩÂä†
    const colors = [
        'rgb(54, 162, 235)',
        'rgb(255, 159, 64)',
        'rgb(75, 192, 192)',
        'rgb(153, 102, 255)',
        'rgb(255, 205, 86)'
    ];

    selectedContractors.forEach((contractorName, index) => {
        const contractor = contractorsData.find(c => c.name === contractorName);
        if (contractor && contractor.monthly_trends) {
            const colorIndex = index % colors.length;

            // Á¥ØË®àÂá¶ÁêÜ
            let contractorData = [...contractor.monthly_trends];
            if (isCumulative) {
                let cumulativeRevenue = 0;
                let cumulativeProfit = 0;
                contractorData = contractor.monthly_trends.map(item => {
                    cumulativeRevenue += item.revenue;
                    cumulativeProfit += item.profit;
                    const profitRate = cumulativeRevenue > 0 ? (cumulativeProfit / cumulativeRevenue * 100) : 0;
                    return {
                        ...item,
                        profit_rate: profitRate
                    };
                });
            }

            newDatasets.push({
                label: contractor.name,
                data: contractorData.map(d => d.profit_rate),
                borderColor: colors[colorIndex],
                backgroundColor: colors[colorIndex].replace('rgb', 'rgba').replace(')', ', 0.1)'),
                tension: 0.1,
                borderWidth: 2,
                borderDash: [5, 5]
            });
        }
    });

    // „ÉÅ„É£„Éº„Éà„ÇíÊõ¥Êñ∞
    profitRateChartInstance.data.datasets = newDatasets;
    profitRateChartInstance.update();
}

// ExcelÈ¢®„Çª„É¨„ÇØ„Ç∑„Éß„É≥Ê©üËÉΩ
function selectAllContractors(chartType) {
    console.log('=== selectAllContractors DEBUG START ===');
    console.log('chartType:', chartType);

    // ÂÖ®‰ΩìÂπ≥Âùá/ÂêàË®à„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØ
    const allToggleId = `${chartType}AllToggle`;
    console.log('Looking for element with ID:', allToggleId);
    const allToggle = document.getElementById(allToggleId);
    console.log('All toggle element found:', allToggle);
    console.log('All toggle current checked state:', allToggle ? allToggle.checked : 'element not found');

    if (allToggle) {
        allToggle.checked = true;
        console.log('Set all toggle to checked');
    } else {
        console.error('All toggle element not found!');
    }

    // ÂÄãÂà•Ê•≠ËÄÖ„ÇÇ„Åô„Åπ„Å¶„ÉÅ„Çß„ÉÉ„ÇØ
    const selector = `.${chartType}-contractor-checkbox:not(#${chartType}AllToggle)`;
    console.log('Checkbox selector:', selector);
    const checkboxes = document.querySelectorAll(selector);
    console.log('Individual checkboxes found:', checkboxes.length);
    console.log('Individual checkboxes:', checkboxes);

    checkboxes.forEach((checkbox, index) => {
        console.log(`Setting checkbox ${index} (${checkbox.id}) to checked`);
        checkbox.checked = true;
    });

    console.log('Calling update function for chart type:', chartType);
    if (chartType === 'revenue') {
        updateRevenueChart();
    } else if (chartType === 'profitRate') {
        updateProfitRateChart();
    }

    console.log('=== selectAllContractors DEBUG END ===');
}

function clearAllContractors(chartType) {
    // ÂÖ®‰ΩìÂπ≥Âùá/ÂêàË®à„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇÇÂê´„ÇÅ„Å¶„Åô„Åπ„Å¶„ÇØ„É™„Ç¢
    const allCheckboxes = document.querySelectorAll(`.${chartType}-contractor-checkbox`);
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });

    if (chartType === 'revenue') {
        updateRevenueChart();
    } else if (chartType === 'profitRate') {
        updateProfitRateChart();
    }
}

function selectTopPerformers(chartType) {
    // ÂÖ®‰ΩìÂπ≥Âùá/ÂêàË®à„ÅØ„ÇØ„É™„Ç¢
    const allToggle = document.getElementById(`${chartType}AllToggle`);
    if (allToggle) {
        allToggle.checked = false;
    }

    // ‰∏ä‰Ωç3Ê•≠ËÄÖ„ÅÆ„Åø„ÇíÈÅ∏Êäû
    const checkboxes = document.querySelectorAll(`.${chartType}-contractor-checkbox:not(#${chartType}AllToggle)`);
    checkboxes.forEach((checkbox, index) => {
        checkbox.checked = index < 3;
    });

    if (chartType === 'revenue') {
        updateRevenueChart();
    } else if (chartType === 'profitRate') {
        updateProfitRateChart();
    }
}

// „ÉÜ„Éº„Éñ„É´„ÇΩ„Éº„ÉàÊ©üËÉΩ
let currentSortColumn = null;
let sortDirection = 'desc'; // „Éá„Éï„Ç©„É´„Éà„ÅØÈôçÈ†Ü

function initializeTableSort() {
    document.querySelectorAll('.sortable').forEach(header => {
        header.addEventListener('click', function() {
            const sortBy = this.dataset.sort;
            sortTable(sortBy);
        });
    });
}

function sortTable(column) {
    const tbody = document.querySelector('#contractorTable tbody');
    const rows = Array.from(tbody.querySelectorAll('.contractor-row'));

    // „ÇΩ„Éº„ÉàÊñπÂêë„ÇíÊ±∫ÂÆö
    if (currentSortColumn === column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        sortDirection = 'desc'; // Êñ∞„Åó„ÅÑÂàó„ÅØÈôçÈ†Ü„Åã„ÇâÈñãÂßã
        currentSortColumn = column;
    }

    // „ÇΩ„Éº„Éà„Ç¢„Ç§„Ç≥„É≥„ÇíÊõ¥Êñ∞
    updateSortIcons(column, sortDirection);

    // „Éá„Éº„Çø„Çí„ÇΩ„Éº„Éà
    rows.sort((a, b) => {
        let aValue, bValue;

        switch(column) {
            case 'name':
                aValue = a.dataset.name.toLowerCase();
                bValue = b.dataset.name.toLowerCase();
                break;
            case 'project_count':
                aValue = parseInt(a.dataset.projectCount);
                bValue = parseInt(b.dataset.projectCount);
                break;
            case 'total_revenue':
                aValue = parseFloat(a.dataset.totalRevenue);
                bValue = parseFloat(b.dataset.totalRevenue);
                break;
            case 'total_cost':
                aValue = parseFloat(a.dataset.totalCost);
                bValue = parseFloat(b.dataset.totalCost);
                break;
            case 'profit':
                aValue = parseFloat(a.dataset.profit);
                bValue = parseFloat(b.dataset.profit);
                break;
            case 'profit_rate':
                aValue = parseFloat(a.dataset.profitRate);
                bValue = parseFloat(b.dataset.profitRate);
                break;
            default:
                return 0;
        }

        if (typeof aValue === 'string') {
            return sortDirection === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
        } else {
            return sortDirection === 'asc' ? aValue - bValue : bValue - aValue;
        }
    });

    // „ÇΩ„Éº„Éà„Åï„Çå„ÅüË°å„ÇíÂÜçÊåøÂÖ•
    rows.forEach(row => tbody.appendChild(row));

    // Ë°å„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà„ÇíÂÜçË®≠ÂÆö
    initializeDataTable();
}

function updateSortIcons(activeColumn, direction) {
    // „Åô„Åπ„Å¶„ÅÆ„ÇΩ„Éº„Éà„Ç¢„Ç§„Ç≥„É≥„Çí„É™„Çª„ÉÉ„Éà
    document.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort ms-1';
    });

    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Âàó„ÅÆ„Ç¢„Ç§„Ç≥„É≥„ÇíÊõ¥Êñ∞
    const activeHeader = document.querySelector(`[data-sort="${activeColumn}"]`);
    const icon = activeHeader.querySelector('i');

    if (direction === 'asc') {
        icon.className = 'fas fa-sort-up ms-1';
    } else {
        icon.className = 'fas fa-sort-down ms-1';
    }
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„ÇΩ„Éº„ÉàÊ©üËÉΩ„ÇíÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== PAGE LOADED DEBUG ===');

    // Âà©ÁõäÁéá„ÉÅ„É£„Éº„Éà„ÅÆË¶ÅÁ¥†„ÇíÁ¢∫Ë™ç
    console.log('Checking profit rate elements...');
    const profitRateAllToggle = document.getElementById('profitRateAllToggle');
    console.log('profitRateAllToggle:', profitRateAllToggle);

    const profitRateCheckboxes = document.querySelectorAll('.profit-rate-contractor-checkbox');
    console.log('profit-rate-contractor-checkbox elements:', profitRateCheckboxes.length);
    profitRateCheckboxes.forEach((cb, i) => {
        console.log(`Checkbox ${i}:`, cb.id, cb.checked);
    });

    initializeCharts();
    initializeDataTable();
    setupChartCheckboxListeners();
    initializeTableSort();

    // „Éá„Éï„Ç©„É´„Éà„ÅßÂ£≤‰∏äÈ†Ü„Å´„ÇΩ„Éº„Éà
    sortTable('total_revenue');

    console.log('=== PAGE LOADED DEBUG END ===');
});
</script>
{% endblock %}