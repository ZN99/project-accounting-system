{% extends 'order_management/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}æ–½å·¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼{% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<!-- Frappe Gantt CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.min.css">
<!-- Tippy.js CSS for tooltips -->
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/dist/tippy.css">
<link rel="stylesheet" href="https://unpkg.com/tippy.js@6/themes/light-border.css">
<style>
    .calendar-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 10px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .fc {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .fc-toolbar-title {
        font-size: 1.75rem !important;
        font-weight: 600;
    }

    .fc-event {
        cursor: pointer;
        border-radius: 4px;
        padding: 2px 4px;
    }

    .legend {
        display: flex;
        gap: 1.5rem;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 1.5rem;
        padding: 1rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }

    .legend-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .legend-color {
        width: 24px;
        height: 24px;
        border-radius: 4px;
    }

    .month-nav {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .event-modal .modal-body {
        padding: 2rem;
    }

    .event-detail-label {
        font-weight: 600;
        color: #6c757d;
        min-width: 100px;
        display: inline-block;
    }

    .event-detail-row {
        padding: 0.75rem 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .event-detail-row:last-child {
        border-bottom: none;
    }

    /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    #ganttView {
        display: none;
    }

    .gantt-container {
        background: white;
        border-radius: 10px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        overflow-x: auto;
    }

    /* ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ« */
    .gantt-tooltip {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        overflow: hidden;
        min-width: 300px;
    }

    .gantt-tooltip-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 16px;
        font-weight: 600;
        font-size: 0.95rem;
    }

    .gantt-tooltip-body {
        padding: 12px 16px;
    }

    .gantt-tooltip-row {
        display: flex;
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 0.875rem;
    }

    .gantt-tooltip-row:last-child {
        border-bottom: none;
    }

    .gantt-tooltip-row .label {
        font-weight: 600;
        color: #6c757d;
        min-width: 100px;
    }

    .gantt-tooltip-row .value {
        flex: 1;
        color: #212529;
    }

    .view-toggle-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .view-toggle-buttons .btn {
        min-width: 120px;
    }

    .view-toggle-buttons .btn.active {
        background-color: white;
        color: #667eea;
        font-weight: 600;
    }

    /* ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .event-tooltip {
        padding: 0;
        max-width: 350px;
    }

    .event-tooltip-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 12px 16px;
        font-weight: 600;
        border-radius: 4px 4px 0 0;
    }

    .event-tooltip-body {
        padding: 12px 16px;
    }

    .event-tooltip-row {
        display: flex;
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
    }

    .event-tooltip-row:last-child {
        border-bottom: none;
    }

    .event-tooltip-label {
        font-weight: 600;
        color: #6c757d;
        min-width: 100px;
        font-size: 0.875rem;
    }

    .event-tooltip-value {
        flex: 1;
        font-size: 0.875rem;
    }

    /* ãƒªã‚¹ãƒˆãƒ“ãƒ¥ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
    .fc-list-event-title {
        font-weight: 600;
    }

    .fc-list-event-time {
        font-weight: normal;
        opacity: 0.8;
    }

    /* ãƒªã‚¹ãƒˆè¡¨ç¤ºã§ã¯ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¦‹ç©ã€å¥‘ç´„ã€ç¾èª¿ãªã©ï¼‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹ */
    .fc-list-view .milestone-event {
        display: none !important;
    }

    .fc-list-view .fc-list-event.milestone-event {
        display: none !important;
    }

    /* ã‚ˆã‚Šåºƒç¯„å›²ã«ã‚«ãƒãƒ¼ */
    .fc-daygrid-event.milestone-event {
        /* æœˆè¡¨ç¤ºã§ã¯è¡¨ç¤º */
    }

    .fc-timegrid-event.milestone-event {
        /* é€±è¡¨ç¤ºã§ã¯è¡¨ç¤º */
    }

    /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼å†…ã®é’è‰²ãƒªãƒ³ã‚¯ã‚’é€šå¸¸ã®è‰²ã«å¤‰æ›´ */
    .fc-list-day-text,
    .fc-list-day-text:hover,
    .fc-list-day-text:visited {
        color: #212529 !important;
        text-decoration: none !important;
    }

    .fc-list-event-title a,
    .fc-list-event-title a:hover,
    .fc-list-event-title a:visited {
        color: inherit !important;
        text-decoration: none !important;
    }

    .fc a,
    .fc a:hover,
    .fc a:visited {
        color: inherit;
        text-decoration: none;
    }

    /* æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã®è‰² */
    .fc-col-header-cell-cushion {
        color: #212529 !important;
        text-decoration: none !important;
    }

    .fc-daygrid-day-number {
        color: #212529 !important;
        text-decoration: none !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="calendar-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h2 class="mb-2">
                    <i class="fas fa-calendar-alt me-2"></i>æ–½å·¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼
                </h2>
                <p class="mb-0 opacity-75">å·¥äº‹äºˆå®šã‚’æœˆé–“ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã§è¡¨ç¤º</p>
            </div>
            <div class="col-md-6 text-md-end">
                <div class="d-flex justify-content-end align-items-center gap-3 flex-wrap">
                    <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                    <div class="view-toggle-buttons">
                        <button type="button" class="btn btn-light active" id="calendarViewBtn">
                            <i class="fas fa-calendar me-1"></i>æœˆè¡¨ç¤º
                        </button>
                        <button type="button" class="btn btn-light" id="ganttViewBtn">
                            <i class="fas fa-chart-bar me-1"></i>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º -->
    <div class="row" id="calendarView">
        <div class="col-12">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤º -->
    <div class="row" id="ganttView">
        <div class="col-12">
            <!-- ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºç¯„å›²åˆ‡ã‚Šæ›¿ãˆ -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆ</h5>
                <div class="btn-group btn-group-sm" role="group" aria-label="è¡¨ç¤ºç¯„å›²">
                    <button type="button" class="btn btn-outline-primary gantt-view-btn" data-view="Day">æ—¥</button>
                    <button type="button" class="btn btn-outline-primary gantt-view-btn" data-view="Week">é€±</button>
                    <button type="button" class="btn btn-outline-primary gantt-view-btn active" data-view="Month">æœˆ</button>
                    <button type="button" class="btn btn-outline-primary gantt-view-btn" data-view="Year">å¹´</button>
                </div>
            </div>
            <div class="gantt-container">
                <div id="gantt"></div>
            </div>
        </div>
    </div>

    <!-- å‡¡ä¾‹ -->
    <div class="legend">
        <strong>ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³å‡¡ä¾‹:</strong>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #17a2b8;"></div>
            <span>ğŸ“„ è¦‹ç©ç™ºè¡Œ</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #ffc107;"></div>
            <span>ğŸ“ å¥‘ç´„</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #007bff;"></div>
            <span>ğŸš§ å·¥æœŸï¼ˆäºˆå®šãƒ»é€²è¡Œä¸­ï¼‰</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #28a745;"></div>
            <span>âœ“ å·¥æœŸï¼ˆå®Œå·¥ï¼‰</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #6f42c1;"></div>
            <span>ğŸ“… ç¾èª¿</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #fd7e14;"></div>
            <span>ğŸ‘¥ ç«‹ã¡ä¼šã„</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background-color: #e83e8c;"></div>
            <span>ğŸ” æ¤œæŸ»</span>
        </div>
    </div>
</div>

<!-- ã‚¤ãƒ™ãƒ³ãƒˆè©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade event-modal" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventModalTitle">æ¡ˆä»¶è©³ç´°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="eventModalBody">
                <!-- æ¡ˆä»¶è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            <div class="modal-footer">
                <a href="#" id="eventDetailLink" class="btn btn-primary" target="_blank">
                    <i class="fas fa-external-link-alt me-2"></i>æ¡ˆä»¶è©³ç´°ã‚’é–‹ã
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<!-- Frappe Gantt JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/frappe-gantt/0.5.0/frappe-gantt.min.js"></script>
<!-- Tippy.js for tooltips -->
<script src="https://unpkg.com/@popperjs/core@2"></script>
<script src="https://unpkg.com/tippy.js@6"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    let ganttChart = null;

    // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    const calendarViewBtn = document.getElementById('calendarViewBtn');
    const ganttViewBtn = document.getElementById('ganttViewBtn');
    const calendarView = document.getElementById('calendarView');
    const ganttView = document.getElementById('ganttView');

    calendarViewBtn.addEventListener('click', function() {
        calendarView.style.display = 'block';
        ganttView.style.display = 'none';
        calendarViewBtn.classList.add('active');
        ganttViewBtn.classList.remove('active');
    });

    ganttViewBtn.addEventListener('click', function() {
        calendarView.style.display = 'none';
        ganttView.style.display = 'block';
        calendarViewBtn.classList.remove('active');
        ganttViewBtn.classList.add('active');

        // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãŒæœªåˆæœŸåŒ–ã®å ´åˆã€åˆæœŸåŒ–
        if (!ganttChart) {
            initGanttChart();
        }
    });

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,dayGridWeek,listMonth'
        },
        buttonText: {
            today: 'ä»Šæ—¥',
            month: 'æœˆ',
            week: 'é€±',
            list: 'ãƒªã‚¹ãƒˆ'
        },
        height: 'auto',
        displayEventEnd: true,  // ã‚¤ãƒ™ãƒ³ãƒˆã®çµ‚äº†æ—¥ã‚’è¡¨ç¤º
        displayEventTime: false,  // æ™‚é–“ã¯éè¡¨ç¤ºï¼ˆallDayã‚¤ãƒ™ãƒ³ãƒˆã®ãŸã‚ï¼‰
        eventDisplay: 'block',  // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒ–ãƒ­ãƒƒã‚¯ã¨ã—ã¦è¡¨ç¤º

        // ãƒªã‚¹ãƒˆè¡¨ç¤ºã®è¨­å®š
        views: {
            dayGridWeek: {
                displayEventTime: false  // é€±è¡¨ç¤ºã§ã‚‚æ™‚é–“ã‚’éè¡¨ç¤º
            },
            listMonth: {
                listDayFormat: { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' },
                listDaySideFormat: false,
                noEventsContent: 'è¡¨ç¤ºã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“'
            }
        },

        events: function(info, successCallback, failureCallback) {
            // APIã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            fetch('{% url "order_management:calendar_events_api" %}')
                .then(response => response.json())
                .then(data => {
                    successCallback(data);
                })
                .catch(error => {
                    console.error('Error loading events:', error);
                    failureCallback(error);
                });
        },
        eventClick: function(info) {
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®è©³ç´°è¡¨ç¤º
            const event = info.event;
            const props = event.extendedProps;

            // å®Ÿç¸¾/äºˆå®šãƒãƒƒã‚¸ã®ä½œæˆ
            let actualBadge = '';
            if (props.is_actual !== undefined) {
                actualBadge = props.is_actual
                    ? '<span class="badge bg-success ms-1">å®Ÿç¸¾</span>'
                    : '<span class="badge bg-warning ms-1">äºˆå®š</span>';
            }

            const modalBody = document.getElementById('eventModalBody');

            // æ—¥ä»˜ã®è¡¨ç¤ºï¼ˆå·¥æœŸã®å ´åˆã¯æœŸé–“ã€ãã‚Œä»¥å¤–ã¯å˜æ—¥ï¼‰
            let dateDisplay = '';
            if (props.milestone_type === 'work_period') {
                const startDate = new Date(props.work_start).toLocaleDateString('ja-JP');
                const endDate = new Date(props.work_end).toLocaleDateString('ja-JP');
                dateDisplay = startDate + ' ã€œ ' + endDate;
            } else {
                dateDisplay = event.start ? event.start.toLocaleDateString('ja-JP') : '';
            }

            const formattedAmount = props.amount.toLocaleString();

            modalBody.innerHTML =
                '<div class="event-detail-row">' +
                    '<span class="event-detail-label">ç¾å ´å:</span>' +
                    '<strong>' + props.project_name + '</strong>' +
                '</div>' +
                '<div class="event-detail-row">' +
                    '<span class="event-detail-label">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³:</span>' +
                    '<span class="badge" style="background-color: ' + event.backgroundColor + ';">' + props.milestone_label + '</span>' +
                    actualBadge +
                '</div>' +
                '<div class="event-detail-row">' +
                    '<span class="event-detail-label">æ—¥ä»˜:</span>' +
                    dateDisplay +
                '</div>' +
                '<div class="event-detail-row">' +
                    '<span class="event-detail-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>' +
                    '<span class="badge bg-secondary">' + props.status + '</span>' +
                '</div>' +
                '<div class="event-detail-row">' +
                    '<span class="event-detail-label">å…ƒè«‹å:</span>' +
                    props.client +
                '</div>' +
                '<div class="event-detail-row">' +
                    '<span class="event-detail-label">æ¡ˆä»¶æ‹…å½“:</span>' +
                    props.manager +
                '</div>' +
                '<div class="event-detail-row">' +
                    '<span class="event-detail-label">ä¸‹è«‹æ¥­è€…:</span>' +
                    '<strong>' + (props.subcontractors || 'æœªå‰²å½“') + '</strong>' +
                '</div>' +
                '<div class="event-detail-row">' +
                    '<span class="event-detail-label">å—æ³¨é‡‘é¡:</span>' +
                    '<strong>Â¥' + formattedAmount + '</strong>' +
                '</div>';

            // è©³ç´°ãƒªãƒ³ã‚¯ã®è¨­å®š
            document.getElementById('eventDetailLink').href = '/orders/' + props.project_id + '/';

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = new bootstrap.Modal(document.getElementById('eventModal'));
            modal.show();
        },
        eventDidMount: function(info) {
            const view = info.view;

            // ãƒªã‚¹ãƒˆè¡¨ç¤ºã®å‡¦ç†
            if (view.type === 'listMonth') {
                // milestone-eventã‚¯ãƒ©ã‚¹ã‚’æŒã¤ã‚¤ãƒ™ãƒ³ãƒˆã¯éè¡¨ç¤º
                if (info.event.classNames && info.event.classNames.includes('milestone-event')) {
                    info.el.style.display = 'none';
                    return;
                }

                // æœŸé–“ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã€é–‹å§‹æ—¥ä»¥å¤–ã¯éè¡¨ç¤ºã«ã™ã‚‹
                const isStartDay = info.el.classList.contains('fc-event-start');

                // æœŸé–“ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆendãŒã‚ã‚‹ï¼‰ã‹ã¤é–‹å§‹æ—¥ã§ãªã„å ´åˆã¯éè¡¨ç¤º
                if (info.event.end && !isStartDay) {
                    info.el.style.display = 'none';
                    return;
                }

                // é–‹å§‹æ—¥ã«æœŸé–“ã‚’è¡¨ç¤º
                if (isStartDay && info.event.end) {
                    const startDate = new Date(info.event.start);
                    const endDate = new Date(info.event.end);
                    endDate.setDate(endDate.getDate() - 1);

                    const formatDate = (date) => {
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    };

                    const periodText = `ï¼ˆ${formatDate(startDate)}ã€œ${formatDate(endDate)}ï¼‰`;

                    const titleElement = info.el.querySelector('.fc-list-event-title a');
                    if (titleElement) {
                        const originalText = titleElement.textContent;
                        titleElement.innerHTML = `${originalText} <span style="color: white; font-size: 0.9em;">${periodText}</span>`;
                    }
                }
            }
            // æœˆè¡¨ç¤ºãƒ»é€±è¡¨ç¤ºã®å‡¦ç†
            else if (view.type === 'dayGridMonth' || view.type === 'dayGridWeek') {
                // æœŸé–“ã‚¤ãƒ™ãƒ³ãƒˆã«ã®ã¿æœŸé–“ã‚’è¿½åŠ 
                if (info.event.end && info.event.extendedProps.milestone_type === 'work_period') {
                    const startDate = new Date(info.event.start);
                    const endDate = new Date(info.event.end);
                    endDate.setDate(endDate.getDate() - 1);

                    const formatDate = (date) => {
                        return `${date.getMonth() + 1}/${date.getDate()}`;
                    };

                    const periodText = `ï¼ˆ${formatDate(startDate)}ã€œ${formatDate(endDate)}ï¼‰`;

                    // æœˆ/é€±è¡¨ç¤ºã®ã‚¿ã‚¤ãƒˆãƒ«è¦ç´ ã«æœŸé–“ã‚’è¿½åŠ 
                    const titleElement = info.el.querySelector('.fc-event-title');
                    if (titleElement && !titleElement.dataset.periodAdded) {
                        const originalText = titleElement.textContent;
                        titleElement.innerHTML = `${originalText} <span style="color: white; font-size: 0.85em;">${periodText}</span>`;
                        titleElement.dataset.periodAdded = 'true';
                    }
                }
            }

            // ãƒªãƒƒãƒãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã®è¿½åŠ 
            const props = info.event.extendedProps;

            // æ—¥ä»˜è¡¨ç¤ºã‚’æº–å‚™
            let dateDisplay = '';
            if (props.milestone_type === 'work_period') {
                const startDate = new Date(props.work_start).toLocaleDateString('ja-JP');
                const endDate = new Date(props.work_end).toLocaleDateString('ja-JP');
                dateDisplay = startDate + ' ã€œ ' + endDate;
            } else {
                dateDisplay = info.event.start ? info.event.start.toLocaleDateString('ja-JP') : '';
            }

            // å®Ÿç¸¾/äºˆå®šãƒãƒƒã‚¸
            let actualBadge = '';
            if (props.is_actual !== undefined) {
                actualBadge = props.is_actual
                    ? '<span class="badge bg-success ms-1">å®Ÿç¸¾</span>'
                    : '<span class="badge bg-warning text-dark ms-1">äºˆå®š</span>';
            }

            const tooltipContent = `
                <div class="event-tooltip">
                    <div class="event-tooltip-header">
                        ${info.event.title}
                    </div>
                    <div class="event-tooltip-body">
                        <div class="event-tooltip-row">
                            <div class="event-tooltip-label">ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³:</div>
                            <div class="event-tooltip-value">
                                <span class="badge" style="background-color: ${info.event.backgroundColor};">${props.milestone_label}</span>
                                ${actualBadge}
                            </div>
                        </div>
                        <div class="event-tooltip-row">
                            <div class="event-tooltip-label">æ—¥ä»˜:</div>
                            <div class="event-tooltip-value">${dateDisplay}</div>
                        </div>
                        <div class="event-tooltip-row">
                            <div class="event-tooltip-label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</div>
                            <div class="event-tooltip-value">${props.status}</div>
                        </div>
                        <div class="event-tooltip-row">
                            <div class="event-tooltip-label">å…ƒè«‹:</div>
                            <div class="event-tooltip-value">${props.client}</div>
                        </div>
                        <div class="event-tooltip-row">
                            <div class="event-tooltip-label">æ¡ˆä»¶æ‹…å½“:</div>
                            <div class="event-tooltip-value">${props.manager}</div>
                        </div>
                        <div class="event-tooltip-row">
                            <div class="event-tooltip-label">ä¸‹è«‹:</div>
                            <div class="event-tooltip-value"><strong>${props.subcontractors || 'æœªå‰²å½“'}</strong></div>
                        </div>
                        <div class="event-tooltip-row">
                            <div class="event-tooltip-label">å—æ³¨é‡‘é¡:</div>
                            <div class="event-tooltip-value"><strong>Â¥${props.amount.toLocaleString()}</strong></div>
                        </div>
                    </div>
                </div>
            `;

            // Tippy.jsãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ã‚’ä½œæˆ
            tippy(info.el, {
                content: tooltipContent,
                allowHTML: true,
                theme: 'light-border',
                placement: 'top',
                arrow: true,
                delay: [0, 0],  // ãƒ›ãƒãƒ¼æ™‚ã™ãã«è¡¨ç¤ºã€éãƒ›ãƒãƒ¼æ™‚ã™ãã«éè¡¨ç¤º
                duration: [200, 150],  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“ã‚’çŸ­ç¸®
                interactive: false  // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—å†…ã§ãƒã‚¦ã‚¹æ“ä½œä¸è¦
            });
        },
        eventsSet: function(events) {
            // ãƒªã‚¹ãƒˆè¡¨ç¤ºã®å ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆã®ãªã„æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            const view = calendar.view;
            if (view.type === 'listMonth') {
                // å°‘ã—é…å»¶ã•ã›ã¦ã€DOMãŒå®Œå…¨ã«æ§‹ç¯‰ã•ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œ
                setTimeout(() => {
                    const dayHeaders = document.querySelectorAll('.fc-list-day');
                    dayHeaders.forEach(dayHeader => {
                        // ã“ã®æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã®å¾Œã«ç¶šãã€è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¢ã™
                        let nextElement = dayHeader.nextElementSibling;
                        let hasVisibleEvent = false;

                        while (nextElement && !nextElement.classList.contains('fc-list-day')) {
                            // ã‚¤ãƒ™ãƒ³ãƒˆè¡Œã§ã€display: none ã§ãªã„ã‚‚ã®ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                            if (nextElement.classList.contains('fc-list-event')) {
                                const style = window.getComputedStyle(nextElement);
                                if (style.display !== 'none') {
                                    hasVisibleEvent = true;
                                    break;
                                }
                            }
                            nextElement = nextElement.nextElementSibling;
                        }

                        // è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãŒãªã„å ´åˆã€æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’éè¡¨ç¤º
                        if (!hasVisibleEvent) {
                            dayHeader.style.display = 'none';
                        } else {
                            // ã“ã®æ—¥ä»˜ã«é–‹å§‹ã•ã‚Œã‚‹å·¥æœŸã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¢ã™
                            const dateTextElement = dayHeader.querySelector('.fc-list-day-text');
                            if (dateTextElement && !dateTextElement.dataset.periodAdded) {
                                // aria-labelã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—
                                const ariaLabel = dateTextElement.getAttribute('aria-label');
                                if (ariaLabel) {
                                    // "2025å¹´11æœˆ23æ—¥"ã®å½¢å¼ã‹ã‚‰æ—¥ä»˜ã‚’æŠ½å‡º
                                    const dateMatch = ariaLabel.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
                                    if (dateMatch) {
                                        const headerDate = new Date(dateMatch[1], dateMatch[2] - 1, dateMatch[3]);
                                        const headerDateStr = headerDate.toISOString().split('T')[0];

                                        // ã“ã®æ—¥ä»˜ã«é–‹å§‹ã•ã‚Œã‚‹å·¥æœŸã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¢ã™
                                        const workPeriodEvents = events.filter(event => {
                                            if (event.extendedProps && event.extendedProps.milestone_type === 'work_period') {
                                                const eventStartStr = new Date(event.start).toISOString().split('T')[0];
                                                return eventStartStr === headerDateStr;
                                            }
                                            return false;
                                        });

                                        // å·¥æœŸã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã€æœŸé–“ã‚’è¿½åŠ 
                                        if (workPeriodEvents.length > 0) {
                                            const event = workPeriodEvents[0]; // æœ€åˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ä½¿ç”¨
                                            const startDate = new Date(event.start);
                                            const endDate = new Date(event.end);
                                            endDate.setDate(endDate.getDate() - 1); // FullCalendarã®çµ‚äº†æ—¥ã¯ç¿Œæ—¥ãªã®ã§-1

                                            const formatDate = (date) => {
                                                return `${date.getMonth() + 1}/${date.getDate()}`;
                                            };

                                            const periodText = ` (${formatDate(startDate)}ã€œ${formatDate(endDate)})`;

                                            // æ—¥ä»˜ãƒ†ã‚­ã‚¹ãƒˆã«æœŸé–“ã‚’è¿½åŠ 
                                            dateTextElement.innerHTML = dateTextElement.innerHTML + `<span style="color: #6c757d; font-size: 0.9em; margin-left: 0.5rem;">${periodText}</span>`;
                                            dateTextElement.dataset.periodAdded = 'true';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }, 50);
            }
        }
    });

    calendar.render();

    // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–é–¢æ•°
    function initGanttChart() {
        // APIã‹ã‚‰ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        fetch('{% url "order_management:gantt_data_api" %}')
            .then(response => response.json())
            .then(data => {
                console.log('Gantt API response:', data);
                if (data.tasks && data.tasks.length > 0) {
                    try {
                        // ãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼ã¨ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
                        const validTasks = data.tasks.filter(task => {
                            if (!task.start || !task.end) {
                                console.warn('Invalid task (missing dates):', task);
                                return false;
                            }
                            return true;
                        });

                        console.log('Valid tasks count:', validTasks.length);
                        console.log('First task sample:', validTasks[0]);

                        if (validTasks.length === 0) {
                            document.getElementById('gantt').innerHTML = '<div class="alert alert-info">æœ‰åŠ¹ãªå·¥æœŸãƒ‡ãƒ¼ã‚¿ã‚’æŒã¤æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                            return;
                        }

                        // æ—¥ä»˜ã‚’æ˜ç¤ºçš„ã«æ–‡å­—åˆ—å½¢å¼ã«å¤‰æ›
                        const formattedTasks = validTasks.map(task => ({
                            ...task,
                            start: task.start.split('T')[0],  // "2025-12-07T00:00:00" â†’ "2025-12-07"
                            end: task.end.split('T')[0]
                        }));

                        console.log('Formatted first task:', formattedTasks[0]);

                        ganttChart = new Gantt('#gantt', formattedTasks, {
                            view_mode: 'Month',
                            bar_height: 30,
                            bar_corner_radius: 3,
                            padding: 18,
                            custom_popup_html: function(task) {
                                // ã‚«ã‚¹ã‚¿ãƒ ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—HTML
                                const startDate = new Date(task._start).toLocaleDateString('ja-JP');
                                const endDate = new Date(task._end).toLocaleDateString('ja-JP');
                                const statusBadge = task.is_completed
                                    ? '<span class="badge bg-success">å®Œå·¥</span>'
                                    : '<span class="badge bg-primary">é€²è¡Œä¸­</span>';

                                return `
                                    <div class="gantt-tooltip">
                                        <div class="gantt-tooltip-header">
                                            <strong>${task.name}</strong>
                                        </div>
                                        <div class="gantt-tooltip-body">
                                            <div class="gantt-tooltip-row">
                                                <span class="label">å·¥æœŸ:</span>
                                                <span class="value">${startDate} ã€œ ${endDate}</span>
                                            </div>
                                            <div class="gantt-tooltip-row">
                                                <span class="label">æ—¥æ•°:</span>
                                                <span class="value">${task.construction_period_days}æ—¥</span>
                                            </div>
                                            <div class="gantt-tooltip-row">
                                                <span class="label">é€²æ—:</span>
                                                <span class="value">${task.progress}% ${statusBadge}</span>
                                            </div>
                                            <div class="gantt-tooltip-row">
                                                <span class="label">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</span>
                                                <span class="value">${task.status}</span>
                                            </div>
                                            <div class="gantt-tooltip-row">
                                                <span class="label">å…ƒè«‹:</span>
                                                <span class="value">${task.client}</span>
                                            </div>
                                            <div class="gantt-tooltip-row">
                                                <span class="label">æ¡ˆä»¶æ‹…å½“:</span>
                                                <span class="value">${task.manager}</span>
                                            </div>
                                            <div class="gantt-tooltip-row">
                                                <span class="label">ä¸‹è«‹:</span>
                                                <span class="value"><strong>${task.subcontractors}</strong></span>
                                            </div>
                                            <div class="gantt-tooltip-row">
                                                <span class="label">å—æ³¨é‡‘é¡:</span>
                                                <span class="value"><strong>Â¥${task.amount.toLocaleString()}</strong></span>
                                            </div>
                                        </div>
                                    </div>
                                `;
                            },
                            on_click: function(task) {
                                const projectId = task.id.replace('project-', '');
                                window.location.href = '/orders/' + projectId + '/';
                            },
                            on_view_change: function(mode) {
                                console.log('View mode changed to:', mode);
                            }
                        });

                        // è¡¨ç¤ºç¯„å›²åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
                        const viewButtons = document.querySelectorAll('.gantt-view-btn');
                        viewButtons.forEach(button => {
                            button.addEventListener('click', function() {
                                const viewMode = this.getAttribute('data-view');

                                // ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®è¡¨ç¤ºç¯„å›²ã‚’å¤‰æ›´
                                if (ganttChart) {
                                    ganttChart.change_view_mode(viewMode);
                                }

                                // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒœã‚¿ãƒ³ã®åˆ‡ã‚Šæ›¿ãˆ
                                viewButtons.forEach(btn => btn.classList.remove('active'));
                                this.classList.add('active');
                            });
                        });
                    } catch (e) {
                        console.error('Gantt initialization error:', e);
                        document.getElementById('gantt').innerHTML =
                            '<div class="alert alert-warning">' +
                            '<strong>ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼</strong><br>' +
                            'ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚<br>' +
                            '<small>ã‚¨ãƒ©ãƒ¼: ' + e.message + '</small>' +
                            '</div>';
                    }
                } else {
                    document.getElementById('gantt').innerHTML = '<div class="alert alert-info">è¡¨ç¤ºã™ã‚‹æ¡ˆä»¶ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                }
            })
            .catch(error => {
                console.error('Error loading gantt data:', error);
                document.getElementById('gantt').innerHTML = '<div class="alert alert-danger">ã‚¬ãƒ³ãƒˆãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
            });
    }
});
</script>
{% endblock %}
