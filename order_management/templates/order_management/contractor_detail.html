{% extends 'order_management/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}{{ contractor.name }} - 詳細{% endblock %}

{% block extra_css %}
<style>
    .detail-container {
        background: #f8f9fa;
        min-height: 100vh;
        padding: 2rem 0;
    }

    .detail-header {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .info-card {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(71,85,105,0.08);
        border: 1px solid #e2e8f0;
        margin-bottom: 2rem;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
        border-bottom: 2px solid #10b981;
        padding-bottom: 0.5rem;
        margin-bottom: 1.5rem;
    }

    .info-row {
        padding: 0.75rem 0;
        border-bottom: 1px solid #f3f4f6;
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        font-weight: 500;
        color: #6b7280;
        margin-bottom: 0.25rem;
        font-size: 0.9rem;
    }

    .info-value {
        color: #1f2937;
        font-size: 1.05rem;
    }

    .badge-active {
        background-color: #10b981;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
    }

    .badge-inactive {
        background-color: #6b7280;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.875rem;
    }

    .stat-box {
        text-align: center;
        padding: 1.5rem;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 700;
        color: #10b981;
        font-family: 'SF Mono', 'Monaco', monospace;
    }

    .stat-label {
        font-size: 0.9rem;
        color: #6b7280;
        margin-top: 0.5rem;
    }

    .subcontract-item {
        padding: 1rem;
        border-left: 4px solid #10b981;
        background: #f8fafc;
        margin-bottom: 1rem;
        border-radius: 0 0.5rem 0.5rem 0;
    }

    .subcontract-item h6 {
        margin-bottom: 0.5rem;
        color: #1f2937;
    }

    .subcontract-meta {
        font-size: 0.875rem;
        color: #6b7280;
    }

    .badge-type-individual {
        background-color: #3b82f6;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
    }

    .badge-type-company {
        background-color: #8b5cf6;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
    }

    .badge-payment-pending {
        background-color: #f59e0b;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
    }

    .badge-payment-paid {
        background-color: #10b981;
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
    }

    .custom-fields-section {
        background: #fefce8;
        border: 1px solid #fde047;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }

    .custom-fields-section .section-title {
        border-bottom-color: #eab308;
    }

    .field-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">
    <div class="detail-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="mb-2">
                        <i class="fas fa-user-tie me-3"></i>{{ contractor.name }}
                    </h1>
                    <p class="mb-0 opacity-75">
                        {% if contractor.is_active %}
                            <span class="badge-active">アクティブ</span>
                        {% else %}
                            <span class="badge-inactive">無効</span>
                        {% endif %}
                        {% if contractor.contractor_type == 'individual' %}
                            <span class="badge-type-individual ms-2">個人職人</span>
                        {% elif contractor.contractor_type == 'company' %}
                            <span class="badge-type-company ms-2">協力会社</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <a href="{% url 'order_management:contractor_edit' contractor.pk %}" class="btn btn-light me-2">
                        <i class="fas fa-edit me-2"></i>編集
                    </a>
                    <a href="{% url 'order_management:external_contractor_management' %}" class="btn btn-outline-light">
                        <i class="fas fa-arrow-left me-2"></i>一覧に戻る
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 統計情報 -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value">{{ total_subcontracts }}</div>
                    <div class="stat-label">総案件数</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value">¥{{ total_amount|floatformat:0|intcomma }}</div>
                    <div class="stat-label">総発注額</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value">¥{{ total_billed|floatformat:0|intcomma }}</div>
                    <div class="stat-label">総請求額</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-box">
                    <div class="stat-value">¥{{ unpaid_amount|floatformat:0|intcomma }}</div>
                    <div class="stat-label">未払額</div>
                </div>
            </div>
        </div>

        <!-- 基本情報 -->
        <div class="info-card">
            <div class="section-title">
                <i class="fas fa-info-circle me-2"></i>基本情報
            </div>

            <div class="info-row">
                <div class="info-label">業者名</div>
                <div class="info-value">{{ contractor.name }}</div>
            </div>

            <div class="info-row">
                <div class="info-label">業者種別</div>
                <div class="info-value">{{ contractor.get_contractor_type_display }}</div>
            </div>

            {% if contractor.address %}
            <div class="info-row">
                <div class="info-label">住所</div>
                <div class="info-value">{{ contractor.address }}</div>
            </div>
            {% endif %}

            {% if contractor.contact_person %}
            <div class="info-row">
                <div class="info-label">担当者名</div>
                <div class="info-value">{{ contractor.contact_person }}</div>
            </div>
            {% endif %}

            {% if contractor.phone %}
            <div class="info-row">
                <div class="info-label">電話番号</div>
                <div class="info-value">
                    <a href="tel:{{ contractor.phone }}">{{ contractor.phone }}</a>
                </div>
            </div>
            {% endif %}

            {% if contractor.email %}
            <div class="info-row">
                <div class="info-label">メールアドレス</div>
                <div class="info-value">
                    <a href="mailto:{{ contractor.email }}">{{ contractor.email }}</a>
                </div>
            </div>
            {% endif %}

            {% if contractor.specialties %}
            <div class="info-row">
                <div class="info-label">得意分野</div>
                <div class="info-value">{{ contractor.specialties }}</div>
            </div>
            {% endif %}

            {% if contractor.hourly_rate and contractor.contractor_type == 'individual' %}
            <div class="info-row">
                <div class="info-label">時給単価</div>
                <div class="info-value">¥{{ contractor.hourly_rate|floatformat:0|intcomma }}</div>
            </div>
            {% endif %}
        </div>

        <!-- カスタムフィールド -->
        {% if custom_fields_by_category %}
        <div class="custom-fields-section">
            <div class="section-title">
                <i class="fas fa-star me-2"></i>追加情報
            </div>

            {% for cat_data in custom_fields_by_category %}
            <div class="mb-4">
                <h6 class="text-warning fw-bold mb-3">{{ cat_data.category.name }}</h6>
                <div class="field-grid">
                    {% for field in cat_data.fields %}
                    <div class="info-row">
                        <div class="info-label">{{ field.definition.name }}</div>
                        <div class="info-value">
                            {% if field.display_value %}
                                {{ field.display_value }}
                            {% else %}
                                <span class="text-muted">未設定</span>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- 支払い情報 -->
        <div class="info-card">
            <div class="section-title">
                <i class="fas fa-money-bill me-2"></i>支払い情報
            </div>

            {% if contractor.payment_cycle %}
            <div class="info-row">
                <div class="info-label">支払サイクル</div>
                <div class="info-value">{{ contractor.get_payment_cycle_display }}</div>
            </div>
            {% endif %}

            {% if contractor.closing_day %}
            <div class="info-row">
                <div class="info-label">締日</div>
                <div class="info-value">毎月{{ contractor.closing_day }}日</div>
            </div>
            {% endif %}

            {% if contractor.payment_offset_months is not None %}
            <div class="info-row">
                <div class="info-label">支払月</div>
                <div class="info-value">{{ contractor.get_payment_offset_months_display }}</div>
            </div>
            {% endif %}

            {% if contractor.payment_day %}
            <div class="info-row">
                <div class="info-label">支払日</div>
                <div class="info-value">毎月{{ contractor.payment_day }}日</div>
            </div>
            {% endif %}

            {% if contractor.bank_name or contractor.account_number %}
            <div class="info-row">
                <div class="info-label">銀行口座</div>
                <div class="info-value">
                    {% if contractor.bank_name %}{{ contractor.bank_name }}{% endif %}
                    {% if contractor.branch_name %} {{ contractor.branch_name }}{% endif %}
                    {% if contractor.account_type %} {{ contractor.get_account_type_display }}{% endif %}
                    {% if contractor.account_number %} {{ contractor.account_number }}{% endif %}
                    {% if contractor.account_holder %}<br>{{ contractor.account_holder }}{% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- 外注案件一覧 -->
        <div class="info-card">
            <div class="section-title">
                <i class="fas fa-list me-2"></i>外注案件一覧
            </div>

            {% if subcontracts_page %}
                {% for subcontract in subcontracts_page %}
                <div class="subcontract-item">
                    <h6>
                        <a href="{% url 'order_management:project_detail' subcontract.project.pk %}">
                            {{ subcontract.project.management_no }} - {{ subcontract.project.site_name }}
                        </a>
                    </h6>
                    <div class="subcontract-meta">
                        <div class="mb-1">
                            <i class="fas fa-yen-sign me-1"></i>
                            発注額: ¥{{ subcontract.contract_amount|floatformat:0|intcomma }}
                            {% if subcontract.billed_amount %}
                                / 請求額: ¥{{ subcontract.billed_amount|floatformat:0|intcomma }}
                            {% endif %}
                        </div>
                        <div class="mb-1">
                            <i class="fas fa-calendar me-1"></i>
                            {% if subcontract.payment_due_date %}
                                出金予定日: {{ subcontract.payment_due_date|date:"Y年m月d日" }}
                            {% endif %}
                            {% if subcontract.payment_status == 'pending' %}
                                <span class="badge-payment-pending ms-2">未払い</span>
                            {% elif subcontract.payment_status == 'paid' %}
                                <span class="badge-payment-paid ms-2">支払済</span>
                            {% endif %}
                        </div>
                        {% if subcontract.work_description %}
                        <div>
                            <i class="fas fa-tasks me-1"></i>
                            {{ subcontract.work_description|truncatewords:20 }}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}

                <!-- ページネーション -->
                {% if subcontracts_page.has_other_pages %}
                <nav aria-label="案件ページネーション" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if subcontracts_page.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ subcontracts_page.previous_page_number }}&per_page={{ per_page }}">前へ</a>
                        </li>
                        {% endif %}

                        <li class="page-item disabled">
                            <span class="page-link">{{ subcontracts_page.number }} / {{ subcontracts_page.paginator.num_pages }}</span>
                        </li>

                        {% if subcontracts_page.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ subcontracts_page.next_page_number }}&per_page={{ per_page }}">次へ</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <p class="text-muted text-center py-4">外注案件はありません</p>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}
