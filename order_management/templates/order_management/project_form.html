{% extends "order_management/base.html" %}
{% load humanize %}
{# Cache buster: 2025-11-28-17:05-fixed #}
{% block title %}{{ title }} - å»ºç¯‰æ´¾é£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<style>
    .form-section {
        border-radius: 12px;
        border: 1px solid #e3e6f0;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .form-section:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    .section-header {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
        margin: 0;
        border-bottom: 1px solid #e3e6f0;
    }
    .section-header h5 {
        margin: 0;
        font-weight: 600;
    }
    .form-label {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
    }
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #d1d3e2;
        transition: all 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    .btn-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(78, 115, 223, 0.4);
    }
    .btn-secondary {
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
    }
    .revenue-preview {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid #dee2e6;
    }
    .revenue-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    .revenue-item:last-child {
        border-bottom: none;
        font-weight: 600;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®z-indexèª¿æ•´ */
    #staffManagementModal {
        z-index: 9999 !important;
    }
    #staffManagementModal .modal-backdrop {
        z-index: 9998 !important;
    }
    #salesStaffManagementModal {
        z-index: 9999 !important;
    }
    /* æ–°è¦å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¦ªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸Šã«è¡¨ç¤ºï¼‰ */
    #addSalesStaffModal {
        z-index: 10050 !important;
    }
    #addSalesStaffModal + .modal-backdrop {
        z-index: 10040 !important;
    }
    #craftsmanManagementModal {
        z-index: 9999 !important;
    }
    #contractorManagementModal {
        z-index: 2050 !important;
    }
    #contractorManagementModal .modal-backdrop {
        z-index: 2049 !important;
    }

    /* èƒŒæ™¯ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ */
    body.modal-open {
        overflow: hidden !important;
        position: fixed !important;
        width: 100% !important;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ */
    #contractorManagementModal .modal-body {
        max-height: 70vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã®70% */
        overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ */
        padding: 1rem;
        -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    }

    #contractorManagementModal .modal-dialog {
        max-height: 90vh; /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ã®æœ€å¤§é«˜ã• */
        display: flex;
        flex-direction: column;
    }

    /* å…¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ã‚’çµ±ä¸€ */
    .modal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    #contractorManagementModal .modal-content {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    #contractorModal {
        z-index: 2060 !important;
    }
    #contractorModal .modal-backdrop {
        z-index: 2059 !important;
    }
    #addImplementationModal {
        z-index: 1055 !important;
    }
    .modal-backdrop.show {
        z-index: 1054 !important;
    }

    /* èƒŒæ™¯ã®é‡è¤‡ã‚’é˜²ã */
    .modal.show {
        background-color: rgba(0,0,0,0.5) !important;
    }

    /* æ¥­è€…ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .contractor-table-wrapper {
        position: relative;
        overflow: hidden;
    }

    .contractor-table-scroll {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 50vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã®50%ã«èª¿æ•´ */
        margin-right: 160px; /* å›ºå®šåˆ—ã®å¹…åˆ†ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¢ºä¿ */
    }

    .contractor-table-fixed {
        position: absolute;
        top: 0;
        right: 0;
        width: 160px;
        max-height: 50vh; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸã¨åŒã˜é«˜ã• */
        overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
        background: white;
        border-left: 2px solid #dee2e6;
        z-index: 10;
    }

    .contractor-table-scroll table,
    .contractor-table-fixed table {
        margin-bottom: 0;
        table-layout: fixed !important;
        width: 100% !important;
    }

    .contractor-table-fixed th,
    .contractor-table-fixed td {
        text-align: center;
        white-space: nowrap;
        height: 60px !important;
        vertical-align: middle !important;
        padding: 8px 8px !important;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®é«˜ã•ã‚‚çµ±ä¸€ */
    .contractor-table thead th {
        height: 50px !important;
        vertical-align: middle !important;
        padding: 8px 8px !important;
    }

    /* æ¥­è€…åˆ†é¡ã«ã‚ˆã‚‹è¡Œã®è‰²åˆ†ã‘ */
    .contractor-table tbody tr.bg-success.bg-opacity-10 {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }
    .contractor-table tbody tr.bg-warning.bg-opacity-10 {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }
    .contractor-table tbody tr.bg-success.bg-opacity-10:hover {
        background-color: rgba(25, 135, 84, 0.2) !important;
    }
    .contractor-table tbody tr.bg-warning.bg-opacity-10:hover {
        background-color: rgba(255, 193, 7, 0.2) !important;
    }
        padding: 8px 4px;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®é«˜ã•ã‚’çµ±ä¸€ - ã‚ˆã‚Šå¼·åˆ¶çš„ã«é©ç”¨ */
    .contractor-table tbody tr {
        height: 60px !important;
        min-height: 60px !important;
        max-height: 60px !important;
    }

    .contractor-table tbody td {
        vertical-align: middle !important;
        white-space: nowrap;
        height: 60px !important;
        line-height: 1.2 !important;
        padding: 8px 8px !important;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .contractor-table .badge {
        font-size: 0.7em;
        margin-right: 2px;
        margin-bottom: 2px;
        display: inline-block;
    }

    /* æ“ä½œãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ */
    .contractor-table .btn {
        height: 32px !important;
        min-height: 32px !important;
        padding: 4px 8px !important;
        font-size: 0.75em !important;
        line-height: 1.2 !important;
        margin: 2px !important;
        display: inline-block !important;
        vertical-align: middle !important;
    }

    /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .contractor-table tbody tr.clickable-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .contractor-table tbody tr.clickable-row:hover {
        background-color: #e3f2fd !important;
    }

    .contractor-table tbody tr.clickable-row.active {
        background-color: #f0f8ff !important;
        border-left: 3px solid #007bff;
    }

    .contractor-table tbody tr.inactive-row {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .contractor-table tbody tr.inactive-row:hover {
        background-color: #f8f9fa !important;
    }

    /* ã‚¿ãƒ–UIã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #projectFormTabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 1rem 1.5rem;
        transition: all 0.3s ease;
    }

    #projectFormTabs .nav-link:hover {
        color: #0d6efd;
        background: #f8f9fa;
        border-bottom-color: #dee2e6;
    }

    #projectFormTabs .nav-link.active {
        color: #0d6efd;
        background: white;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }

    /* è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-group .btn-light.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .btn-group .btn-light {
        transition: all 0.3s ease;
    }

    .btn-group .btn-light:hover:not(.active) {
        background-color: #e9ecef;
    }

    /* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #projectFormTabsContent .tab-pane {
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ– */
    }

    #projectFormTabsContent.full-view-mode .tab-pane {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    #projectFormTabsContent.full-view-mode .tab-pane:last-child {
        margin-bottom: 0;
    }

    #projectFormTabsContent.full-view-mode .tab-pane::before {
        content: attr(data-section-title);
        display: block;
        font-size: 1.25rem;
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #0d6efd;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>

<!-- Toastr CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="fas fa-edit me-2"></i>{{ title }}</h3>
                <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-light active" id="tabViewBtn" onclick="switchFormViewMode('tab')">
                        <i class="fas fa-th-large me-1"></i>ã‚¿ãƒ–è¡¨ç¤º
                    </button>
                    <button type="button" class="btn btn-light" id="fullViewBtn" onclick="switchFormViewMode('full')">
                        <i class="fas fa-list me-1"></i>å…¨ä½“è¡¨ç¤º
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <form method="post" id="projectForm">
                    {% csrf_token %}

                    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <ul class="nav nav-tabs" id="projectFormTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>åŸºæœ¬æƒ…å ±
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="order-tab" data-bs-toggle="tab" data-bs-target="#order" type="button" role="tab">
                                <i class="fas fa-file-invoice-dollar me-1"></i>å—æ³¨ãƒ»è¦‹ç©ãƒ»è«‹æ±‚
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-1"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="staff-tab" data-bs-toggle="tab" data-bs-target="#staff" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>æ¥­è€…ãƒ»æ‹…å½“
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                                <i class="fas fa-sticky-note me-1"></i>å‚™è€ƒ
                            </button>
                        </li>
                    </ul>

                    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                    <div class="tab-content p-4" id="projectFormTabsContent">
                        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
                        <div class="tab-pane show active" id="basic" role="tabpanel" data-section-title="ğŸ“‹ åŸºæœ¬æƒ…å ±">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-info-circle me-2"></i>åŸºæœ¬æƒ…å ±</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.site_name.id_for_label }}" class="form-label">
                                        ç¾å ´å <span class="text-danger">*</span>
                                    </label>
                                    {{ form.site_name }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.work_type.id_for_label }}" class="form-label">
                                        ç¨®åˆ¥ <span class="text-danger">*</span>
                                    </label>
                                    <div class="d-flex gap-2">
                                        {{ form.work_type }}
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openWorkTypeManagementModal()" title="å·¥äº‹ç¨®åˆ¥ã‚’ç®¡ç†">
                                            <i class="fas fa-tools"></i> ç¨®åˆ¥ç®¡ç†
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.site_address.id_for_label }}" class="form-label">
                                    ç¾å ´ä½æ‰€
                                </label>
                                {{ form.site_address }}
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">å…ƒè«‹å <span class="text-danger">*</span></label>
                                    <div class="d-flex gap-2">
                                        <select name="client_company" class="form-select" id="clientCompanySelect">
                                            <option value="">-- å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                            {% for company in client_companies %}
                                            <option value="{{ company.id }}"
                                                    {% if project.client_company_id == company.id %}selected{% endif %}
                                                    data-name="{{ company.company_name }}"
                                                    data-address="{{ company.address }}"
                                                    data-payment-cycle="{{ company.payment_cycle }}"
                                                    data-closing-day="{{ company.closing_day|default:'' }}"
                                                    data-payment-offset-months="{{ company.payment_offset_months|default:'' }}"
                                                    data-payment-day="{{ company.payment_day|default:'' }}">
                                                {{ company.company_name }}{% if company.address %} - {{ company.address }}{% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openClientCompanyManagementPanel()" title="å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠãƒ»ç®¡ç†">
                                            <i class="fas fa-building"></i> å…ƒè«‹ç®¡ç†
                                        </button>
                                    </div>
                                    <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šsurvey_status -->
                                    <input type="hidden" name="survey_status" value="{{ project.survey_status|default:'not_required' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">æ¡ˆä»¶æ‹…å½“è€…ï¼ˆå–¶æ¥­ï¼‰ <span class="text-danger">*</span></label>
                                    <div class="d-flex gap-2">
                                        <select name="sales_manager" class="form-select" id="salesManagerSelect">
                                            <option value="">-- å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                            {% for worker in internal_workers %}
                                            {% if worker.department == 'sales' or worker.department == 'marketing' %}
                                            <option value="{{ worker.id }}"
                                                    {% if project and worker.name == project.project_manager %}selected{% endif %}
                                                    data-name="{{ worker.name }}"
                                                    data-department="{{ worker.get_department_display }}">
                                                {{ worker.name }} ({{ worker.get_department_display }})
                                            </option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openSalesStaffManagementPanel()">
                                            <i class="fas fa-chart-line"></i> å–¶æ¥­ç®¡ç†
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- éµå—ã‘æ¸¡ã—è¨­å®šï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <!-- æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
                                    <div class="d-flex align-items-center mb-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleKeyHandoverSection()" id="keyHandoverToggleBtn">
                                            <i class="fas fa-plus me-1" id="keyHandoverToggleIcon"></i>
                                            <i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’è¿½åŠ 
                                        </button>
                                        <small class="text-muted ms-2">ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¨­å®šã—ã¦ãã ã•ã„ï¼‰</small>
                                    </div>

                                    <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªè¨­å®šã‚¨ãƒªã‚¢ -->
                                    <div id="keyHandoverSection" style="display: none;">
                                        <div class="alert alert-info small mb-3">
                                            <i class="fas fa-info-circle me-1"></i>
                                            å…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ãŒã€æ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ã§ã™ã€‚
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.key_handover_location.id_for_label }}" class="form-label">
                                                    éµå—ã‘æ¸¡ã—å ´æ‰€
                                                </label>
                                                {{ form.key_handover_location }}
                                                <div class="form-text">éµã®å—ã‘æ¸¡ã—å ´æ‰€ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼ˆå…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‹ã‚‰è‡ªå‹•å…¥åŠ›ï¼‰</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.key_handover_date.id_for_label }}" class="form-label">
                                                    éµå—ã‘æ¸¡ã—æ—¥æ™‚
                                                </label>
                                                {{ form.key_handover_date }}
                                                <div class="form-text">éµã®å—ã‘æ¸¡ã—äºˆå®šæ—¥æ™‚</div>
                                            </div>
                                            <div class="col-12 mb-3">
                                                <label for="{{ form.key_handover_notes.id_for_label }}" class="form-label">
                                                    éµå—ã‘æ¸¡ã—ãƒ¡ãƒ¢
                                                </label>
                                                {{ form.key_handover_notes }}
                                                <div class="form-text">éµå—ã‘æ¸¡ã—ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …ã‚„ãƒ¡ãƒ¢</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ–çµ‚äº† -->

                        <!-- å—æ³¨ãƒ»è¦‹ç©ãƒ»è«‹æ±‚ã‚¿ãƒ– -->
                        <div class="tab-pane" id="order" role="tabpanel" data-section-title="ğŸ’° å—æ³¨ãƒ»è¦‹ç©ãƒ»è«‹æ±‚">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-file-invoice-dollar me-2"></i>å—æ³¨ãƒ»è¦‹ç©ãƒ»è«‹æ±‚</h5>
                        </div>
                        <div class="card-body">
                            <!-- å—æ³¨çŠ¶æ³ -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-handshake me-2"></i>å—æ³¨çŠ¶æ³
                                    </h6>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.project_status.id_for_label }}" class="form-label">
                                        å—æ³¨ãƒ¨ãƒŸ <span class="text-danger">*</span>
                                    </label>
                                    {{ form.project_status }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.contract_date.id_for_label }}" class="form-label">
                                        å¥‘ç´„æ—¥
                                    </label>
                                    {{ form.contract_date }}
                                    <small class="text-muted">å—æ³¨ç¢ºå®šæ™‚ã«å…¥åŠ›</small>
                                </div>
                            </div>

                            <!-- è¦‹ç©æƒ…å ± -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-success border-bottom pb-2 mb-3">
                                        <i class="fas fa-calculator me-2"></i>è¦‹ç©æƒ…å ±
                                    </h6>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.estimate_issued_date.id_for_label }}" class="form-label">
                                        è¦‹ç©æ›¸ç™ºè¡Œæ—¥
                                    </label>
                                    {{ form.estimate_issued_date }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">è¦‹ç©æ›¸ã«ã¤ã„ã¦</label>
                                    <div class="form-check mt-2">
                                        <input type="checkbox" class="form-check-input" id="{{ form.estimate_not_required.id_for_label }}" name="{{ form.estimate_not_required.html_name }}" {% if form.estimate_not_required.value %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ form.estimate_not_required.id_for_label }}">
                                            è¦‹ç©æ›¸ä¸è¦
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.order_amount.id_for_label }}" class="form-label">
                                        å—æ³¨é‡‘é¡(ç¨æŠœ) <span class="text-danger">*</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        {{ form.order_amount }}
                                    </div>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.parking_fee.id_for_label }}" class="form-label">
                                        é§è»Šå ´ä»£
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        {{ form.parking_fee }}
                                    </div>
                                </div>
                            </div>

                            <!-- çµŒè²»ãƒ»è«‹æ±‚é …ç›® -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-warning border-bottom pb-2 mb-3">
                                        <i class="fas fa-receipt me-2"></i>çµŒè²»ãƒ»è«‹æ±‚é …ç›®
                                    </h6>
                                </div>
                            </div>

                            <!-- è«¸çµŒè²»é …ç›®ã‚’ç¸¦ä¸¦ã³ã§é…ç½® -->
                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.expense_item_1.id_for_label }}" class="form-label">
                                        è«¸çµŒè²»é …ç›®â‘ 
                                    </label>
                                    {{ form.expense_item_1 }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.expense_amount_1.id_for_label }}" class="form-label">
                                        è«¸çµŒè²»ä»£â‘ 
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        {{ form.expense_amount_1 }}
                                    </div>
                                </div>
                            </div>

                            <div class="row mb-3">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.expense_item_2.id_for_label }}" class="form-label">
                                        è«¸çµŒè²»é …ç›®â‘¡
                                    </label>
                                    {{ form.expense_item_2 }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.expense_amount_2.id_for_label }}" class="form-label">
                                        è«¸çµŒè²»ä»£â‘¡
                                    </label>
                                    <div class="input-group">
                                        <span class="input-group-text">Â¥</span>
                                        {{ form.expense_amount_2 }}
                                    </div>
                                </div>
                            </div>

                            <!-- æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ± -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-info border-bottom pb-2 mb-3">
                                        <i class="fas fa-money-bill-wave me-2"></i>æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±
                                    </h6>
                                    <small class="text-muted">å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®ä¼šç¤¾ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«è¨­å®šãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚ä»»æ„ã§ç·¨é›†å¯èƒ½ã§ã™ã€‚</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.payment_cycle.id_for_label }}" class="form-label">
                                        æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«
                                    </label>
                                    {{ form.payment_cycle }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.closing_day.id_for_label }}" class="form-label">
                                        ç· ã‚æ—¥
                                    </label>
                                    {{ form.closing_day }}
                                    <small class="text-muted">æœˆæœ«ç· ã‚ã®å ´åˆã¯31</small>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.payment_offset_months.id_for_label }}" class="form-label">
                                        æ”¯æ‰•æœˆ
                                    </label>
                                    {{ form.payment_offset_months }}
                                    <small class="text-muted">ç· æ—¥ã‹ã‚‰ä½•ãƒ¶æœˆå¾Œã«æ”¯æ‰•ã†ã‹</small>
                                </div>
                                <div class="col-md-2 mb-3">
                                    <label for="{{ form.payment_day.id_for_label }}" class="form-label">
                                        æ”¯æ‰•æ—¥
                                    </label>
                                    {{ form.payment_day }}
                                    <small class="text-muted">ä¾‹ï¼š25æ—¥æ‰•ã„ã®å ´åˆã¯25</small>
                                </div>
                            </div>

                            <div class="row mb-4">
                                <div class="col-md-12 mb-3">
                                    <label class="form-label">è«‹æ±‚æ›¸çŠ¶æ³</label>
                                    <div class="form-check mt-2">
                                        <input type="checkbox" class="form-check-input" id="{{ form.invoice_issued.id_for_label }}" name="{{ form.invoice_issued.html_name }}" {% if form.invoice_issued.value %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ form.invoice_issued.id_for_label }}">
                                            è«‹æ±‚æ›¸ç™ºè¡Œæ¸ˆã¿
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- å—æ³¨ãƒ»è¦‹ç©ãƒ»è«‹æ±‚ã‚¿ãƒ–çµ‚äº† -->

                        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
                        <div class="tab-pane" id="schedule" role="tabpanel" data-section-title="ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-calendar-alt me-2"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-info border-bottom pb-2 mb-3">
                                        <i class="fas fa-calendar-check me-2"></i>å·¥äº‹ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                                    </h6>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.work_start_date.id_for_label }}" class="form-label">
                                        ç€å·¥æ—¥
                                    </label>
                                    {{ form.work_start_date }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.work_end_date.id_for_label }}" class="form-label">
                                        å®Œå·¥æ—¥
                                    </label>
                                    {{ form.work_end_date }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.payment_due_date.id_for_label }}" class="form-label">
                                        å…¥é‡‘äºˆå®šæ—¥ <span class="text-danger">*</span>
                                    </label>
                                    {{ form.payment_due_date }}
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="{{ form.invoice_status.id_for_label }}" class="form-label">
                                        è«‹æ±‚æ›¸ç™ºè¡Œã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                                    </label>
                                    {{ form.invoice_status }}
                                </div>
                            </div>

                        </div>
                    </div>
                        </div>
                        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–çµ‚äº† -->

                        <!-- æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ– -->
                        <div class="tab-pane" id="staff" role="tabpanel" data-section-title="ğŸ‘¥ æ¥­è€…ãƒ»æ‹…å½“">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-users me-2"></i>å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…æƒ…å ±</h5>
                        </div>
                        <div class="card-body">
                            <!-- è¿½åŠ æ¸ˆã¿å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…ä¸€è¦§ -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-user-cog me-2"></i>å®Ÿæ–½ä½“åˆ¶ä¸€è¦§
                                    </h6>
                                    <div id="implementationList">
                                        <!-- å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹å®Ÿæ–½ä½“åˆ¶ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                                    </div>
                                </div>
                            </div>

                            <!-- å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…è¿½åŠ ãƒœã‚¿ãƒ³ -->
                            <div class="row">
                                <div class="col-md-12 text-center">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="console.log('å®Ÿæ–½ä½“åˆ¶ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ'); try { openAddImplementationModal(); } catch(e) { console.error('å®Ÿæ–½ä½“åˆ¶é–¢æ•°å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', e); toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message); }">
                                        <i class="fas fa-plus me-2"></i>å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…ã‚’è¿½åŠ 
                                    </button>
                                    <small class="d-block text-muted mt-2">å¤–æ³¨å…ˆã€ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã€ã¾ãŸã¯å¾Œã§æ±ºå®šã‚’è¿½åŠ ã§ãã¾ã™</small>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ–çµ‚äº† -->

                        <!-- å‚™è€ƒã‚¿ãƒ– -->
                        <div class="tab-pane" id="notes" role="tabpanel" data-section-title="ğŸ“ å‚™è€ƒ">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-sticky-note me-2"></i>å‚™è€ƒ</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">å‚™è€ƒ</label>
                                {{ form.notes }}
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- å‚™è€ƒã‚¿ãƒ–çµ‚äº† -->
                    </div>
                    <!-- ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„çµ‚äº† -->

                    <!-- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒœã‚¿ãƒ³ -->
                    <div class="row mt-4">
                        <div class="col-md-12 text-center">
                            <button type="submit" class="btn btn-success btn-lg me-3" id="submitBtn">
                                <i class="fas fa-save"></i>
                                {% if project %}æ¡ˆä»¶ã‚’æ›´æ–°{% else %}æ¡ˆä»¶ã‚’ç™»éŒ²{% endif %}
                            </button>
                            <a href="{% if project %}{% url 'order_management:project_detail' project.pk %}{% else %}{% url 'order_management:project_list' %}{% endif %}"
                               class="btn btn-secondary btn-lg" id="cancelBtn">
                                <i class="fas fa-times"></i>
                                {% if project %}æˆ»ã‚‹{% else %}ã‚­ãƒ£ãƒ³ã‚»ãƒ«{% endif %}
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="addImplementationModal" tabindex="-1" aria-labelledby="addImplementationModalLabel" aria-hidden="true" style="z-index: 1055;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addImplementationModalLabel">å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—é¸æŠ -->
                <div class="row mb-4">
                    <div class="col-md-12">
                        <h6 class="text-primary border-bottom pb-2 mb-3">å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="modal_implementation_type" id="modalOutsource" value="outsource" checked>
                                    <label class="form-check-label fw-bold text-primary" for="modalOutsource">
                                        <i class="fas fa-handshake me-2"></i>å¤–æ³¨å…ˆã«ç™ºæ³¨
                                    </label>
                                    <small class="d-block text-muted">å¤–éƒ¨æ¥­è€…ã«å·¥äº‹ã‚’ä¾é ¼</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="modal_implementation_type" id="modalInternal" value="internal">
                                    <label class="form-check-label fw-bold text-success" for="modalInternal">
                                        <i class="fas fa-users me-2"></i>ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹
                                    </label>
                                    <small class="d-block text-muted">è‡ªç¤¾ã§å·¥äº‹ã‚’å®Ÿæ–½</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="modal_implementation_type" id="modalLater" value="later">
                                    <label class="form-check-label fw-bold text-warning" for="modalLater">
                                        <i class="fas fa-clock me-2"></i>å¾Œã§æ±ºå®š
                                    </label>
                                    <small class="d-block text-muted">è©³ç´°ç”»é¢ã§è¨­å®š</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¤–æ³¨å…ˆãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="modalContractorForm" class="implementation-form">
                    <h6 class="text-primary border-bottom pb-2 mb-3">å¤–æ³¨å…ˆè©³ç´°æƒ…å ±</h6>

                    <!-- å¤–æ³¨å…ˆé¸æŠ -->
                    <div class="mb-3">
                        <label class="form-label">å¤–æ³¨å…ˆ <span class="text-danger">*</span></label>
                        <select name="modal_existing_contractor_id" class="form-select" id="modalContractorSelect">
                            <option value="">-- å¤–æ³¨å…ˆã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                            {% for contractor in contractors %}
                            <option value="{{ contractor.id }}" data-name="{{ contractor.name }}" data-address="{{ contractor.address }}">
                                {{ contractor.name }} {% if contractor.address %}({{ contractor.address }}){% endif %}
                            </option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openContractorManagementPanel()">
                            <i class="fas fa-building"></i> å¤–æ³¨å…ˆç®¡ç†
                        </button>
                    </div>

                    <!-- ä½œæ¥­å†…å®¹ -->
                    <div class="mb-3">
                        <label class="form-label">ä½œæ¥­å†…å®¹ <span class="text-danger">*</span></label>
                        <small class="text-muted d-block">æœ€ä½é™å…¥åŠ›ï¼šã©ã‚“ãªå·¥äº‹ã‚’ä¾é ¼ã™ã‚‹ã‹ã‚’è¨˜å…¥</small>
                        <textarea name="modal_work_description" class="form-control" rows="3" placeholder="ä¾‹: å¤–å£å¡—è£…å·¥äº‹ã€è¶³å ´è¨­ç½®"></textarea>
                    </div>

                    <!-- é‡‘é¡æƒ…å ± -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">ä¾é ¼é‡‘é¡ <span class="text-muted">ï¼ˆå¾Œã§å…¥åŠ›å¯ï¼‰</span></label>
                            <small class="text-muted d-block">å¤–æ³¨å…ˆã¸ã®ç™ºæ³¨äºˆå®šé‡‘é¡</small>
                            <div class="input-group">
                                <span class="input-group-text">Â¥</span>
                                <input type="number" name="modal_contract_amount" class="form-control" placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">è¢«è«‹æ±‚é¡ <span class="text-muted">ï¼ˆå¾Œã§å…¥åŠ›å¯ï¼‰</span></label>
                            <small class="text-muted d-block">å¤–æ³¨å…ˆã‹ã‚‰å®Ÿéš›ã«è«‹æ±‚ã•ã‚ŒãŸé‡‘é¡</small>
                            <div class="input-group">
                                <span class="input-group-text">Â¥</span>
                                <input type="number" name="modal_billed_amount" class="form-control" placeholder="0">
                            </div>
                        </div>
                    </div>

                    <!-- è¿½åŠ è²»ç”¨æƒ…å ± -->
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <h6 class="text-info border-bottom pb-2 mb-3">
                                <i class="fas fa-plus-circle me-2"></i>è¿½åŠ è²»ç”¨é …ç›®
                            </h6>
                            <div id="modalAdditionalCostList">
                                <!-- å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹è²»ç”¨é …ç›®ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                            </div>
                            <div class="row">
                                <div class="col-md-4">
                                    <input type="text" id="modalNewCostItemName" class="form-control" placeholder="è²»ç”¨é …ç›®å">
                                </div>
                                <div class="col-md-3">
                                    <input type="number" id="modalNewCostItemAmount" class="form-control" placeholder="é‡‘é¡">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" id="modalNewCostItemDescription" class="form-control" placeholder="å‚™è€ƒ">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-outline-primary w-100" onclick="addModalCostItem()">
                                        <i class="fas fa-plus"></i> è¿½åŠ 
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-3">
                                <div class="col-md-12">
                                    <div class="d-flex justify-content-between align-items-center p-3 bg-light rounded">
                                        <strong>è¿½åŠ è²»ç”¨åˆè¨ˆ:</strong>
                                        <span id="modalAdditionalCostTotal" class="fw-bold text-primary">Â¥0</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è©³ç´°æƒ…å ± -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">å‡ºé‡‘äºˆå®šæ—¥ <span class="text-muted">ï¼ˆå¾Œã§å…¥åŠ›å¯ï¼‰</span></label>
                            <input type="date" name="modal_payment_due_date" class="form-control">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">å‡ºé‡‘çŠ¶æ³ <span class="text-muted">ï¼ˆå¾Œã§å¤‰æ›´å¯ï¼‰</span></label>
                            <select name="modal_payment_status" class="form-select">
                                <option value="pending">æœªæ‰•ã„</option>
                                <option value="paid">æ”¯æ‰•æ¸ˆã¿</option>
                                <option value="partial">ä¸€éƒ¨æ‰•ã„</option>
                            </select>
                        </div>
                    </div>

                    <!-- ç™ºæ³¨æ›¸æƒ…å ± -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="modal_purchase_order_issued" id="modalPurchaseOrder">
                            <label class="form-check-label" for="modalPurchaseOrder">
                                ç™ºæ³¨æ›¸ç™ºè¡Œæ¸ˆã¿ <span class="text-muted">ï¼ˆå¾Œã§å¤‰æ›´å¯ï¼‰</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="modalInternalForm" class="implementation-form" style="display: none;">
                    <h6 class="text-success border-bottom pb-2 mb-3">ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹è©³ç´°æƒ…å ±</h6>

                    <!-- æ‹…å½“è€…é¸æŠæ–¹æ³• -->
                    <div class="mb-3">
                        <label class="form-label">æ‹…å½“è€…é¸æŠæ–¹æ³• <span class="text-danger">*</span></label>
                        <div class="mb-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="modal_internal_input_type" id="modalExistingInternal" value="existing" checked>
                                <label class="form-check-label" for="modalExistingInternal">
                                    æ—¢å­˜ã‹ã‚‰é¸æŠ
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="modal_internal_input_type" id="modalNewInternal" value="new">
                                <label class="form-check-label" for="modalNewInternal">
                                    æ–°è¦å…¥åŠ›
                                </label>
                            </div>
                        </div>
                        <!-- æ—¢å­˜æ‹…å½“è€…é¸æŠ -->
                        <div id="modalExistingInternalDiv">
                            <select name="modal_existing_internal_id" class="form-select" id="modalInternalSelect">
                                <option value="">-- æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                {% for worker in internal_workers %}
                                <option value="{{ worker.id }}"
                                        data-name="{{ worker.name }}"
                                        data-department="{{ worker.get_department_display }}"
                                        data-hourly-rate="{{ worker.hourly_rate }}"
                                        data-specialties="{{ worker.specialties }}">
                                    {{ worker.name }} ({{ worker.get_department_display }}) - Â¥{{ worker.hourly_rate }}/æ™‚é–“
                                </option>
                                {% endfor %}
                            </select>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openCraftsmanManagementPanel()">
                                <i class="fas fa-tools"></i> è·äººç®¡ç†
                            </button>
                        </div>
                        <!-- æ–°è¦æ‹…å½“è€…å…¥åŠ› -->
                        <div id="modalNewInternalDiv" style="display: none;">
                            <input type="text" name="modal_new_internal_name" class="form-control" placeholder="ä¾‹: ç”°ä¸­å¤ªéƒ">
                        </div>
                    </div>

                    <!-- æ‰€å±éƒ¨ç½² -->
                    <div class="mb-3">
                        <label class="form-label">æ‰€å±éƒ¨ç½² <span class="text-muted">ï¼ˆå¾Œã§å…¥åŠ›å¯ï¼‰</span></label>
                        <input type="text" name="modal_internal_department" class="form-control" placeholder="ä¾‹: æ–½å·¥éƒ¨">
                    </div>

                    <!-- æ‹…å½“ã™ã‚‹ä½œæ¥­å†…å®¹ -->
                    <div class="mb-3">
                        <label class="form-label">æ‹…å½“ã™ã‚‹ä½œæ¥­å†…å®¹</label>
                        <small class="text-muted d-block">æœ€ä½é™å…¥åŠ›ï¼šã©ã‚“ãªä½œæ¥­ã‚’æ‹…å½“ã™ã‚‹ã‹ã‚’è¨˜å…¥</small>
                        <textarea name="modal_internal_work_description" class="form-control" rows="2" placeholder="ä¾‹: é›»æ°—é…ç·šå·¥äº‹ã€ç…§æ˜å™¨å…·è¨­ç½®"></textarea>
                    </div>

                    <!-- æ–™é‡‘ä½“ç³» -->
                    <div class="mb-3">
                        <label class="form-label">æ–™é‡‘ä½“ç³»</label>
                        <small class="text-muted d-block">ä½œæ¥­ã‚³ã‚¹ãƒˆã®è¨ˆç®—æ–¹æ³•ã‚’é¸æŠ</small>
                        <div class="mb-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="modal_internal_pricing_type" id="modalHourlyPricing" value="hourly" checked>
                                <label class="form-check-label" for="modalHourlyPricing">
                                    æ™‚çµ¦ãƒ™ãƒ¼ã‚¹
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="modal_internal_pricing_type" id="modalProjectPricing" value="project">
                                <label class="form-check-label" for="modalProjectPricing">
                                    æ¡ˆä»¶å˜ä½
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ã®å ´åˆ -->
                    <div id="modalHourlyPricingFields">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">æ™‚çµ¦å˜ä¾¡ <span class="text-muted">ï¼ˆå¾Œã§å…¥åŠ›å¯ï¼‰</span></label>
                                <small class="text-muted d-block">1æ™‚é–“ã‚ãŸã‚Šã®ä½œæ¥­ã‚³ã‚¹ãƒˆ</small>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="number" name="modal_internal_hourly_rate" class="form-control" placeholder="3000">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">è¦‹ç©å·¥æ•°ï¼ˆæ™‚é–“ï¼‰ <span class="text-muted">ï¼ˆå¾Œã§å…¥åŠ›å¯ï¼‰</span></label>
                                <small class="text-muted d-block">äºˆæƒ³ã•ã‚Œã‚‹ä½œæ¥­æ™‚é–“</small>
                                <input type="number" name="modal_estimated_hours" class="form-control" step="0.5" placeholder="8.0">
                            </div>
                        </div>
                    </div>

                    <!-- æ¡ˆä»¶å˜ä½ã®å ´åˆ -->
                    <div id="modalProjectPricingFields" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">æ¡ˆä»¶å˜ä½æ–™é‡‘ <span class="text-muted">ï¼ˆå¾Œã§å…¥åŠ›å¯ï¼‰</span></label>
                            <small class="text-muted d-block">ã“ã®æ¡ˆä»¶å…¨ä½“ã®ä½œæ¥­ã‚³ã‚¹ãƒˆ</small>
                            <div class="input-group">
                                <span class="input-group-text">Â¥</span>
                                <input type="number" name="modal_internal_project_amount" class="form-control" placeholder="50000">
                            </div>
                        </div>
                    </div>

                    <!-- ç¨è¾¼/ç¨æŠœé¸æŠ -->
                    <div class="mb-3">
                        <label class="form-label">ç¨è¾¼/ç¨æŠœ <span class="text-muted">ï¼ˆå¾Œã§å¤‰æ›´å¯ï¼‰</span></label>
                        <div class="mb-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="modal_tax_type" id="modalTaxInclude" value="include" checked>
                                <label class="form-check-label" for="modalTaxInclude">
                                    ç¨è¾¼
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="modal_tax_type" id="modalTaxExclude" value="exclude">
                                <label class="form-check-label" for="modalTaxExclude">
                                    ç¨æŠœ
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- å°‚é–€åˆ†é‡ -->
                    <div class="mb-3">
                        <label class="form-label">å°‚é–€åˆ†é‡ <span class="text-muted">ï¼ˆå¾Œã§å…¥åŠ›å¯ï¼‰</span></label>
                        <input type="text" name="modal_internal_specialties" class="form-control" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                    </div>

                    <!-- ç¨¼åƒçŠ¶æ³ -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="modal_internal_is_active" id="modalInternalIsActive" checked>
                            <label class="form-check-label" for="modalInternalIsActive">
                                ç¨¼åƒä¸­ <span class="text-muted">ï¼ˆå¾Œã§å¤‰æ›´å¯ï¼‰</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- å¾Œã§æ±ºå®šãƒ•ã‚©ãƒ¼ãƒ  -->
                <div id="modalLaterForm" class="implementation-form" style="display: none;">
                    <div class="alert alert-warning border-warning">
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-clock text-warning me-2"></i>
                            <strong>å¾Œã§æ±ºå®š</strong>
                        </div>
                        <p class="mb-0">ã“ã®å®Ÿæ–½ä½“åˆ¶ã¯è©³ç´°ç”»é¢ã§å¾Œã‹ã‚‰è¨­å®šã§ãã¾ã™ã€‚</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="addImplementationItem()">è¿½åŠ </button>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰ -->
<div class="modal fade" id="staffManagementModalInvalid" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true" style="z-index: 1060; display: none !important;">

                                            <!-- å°‚é–€åˆ†é‡ -->
                                            <div class="mb-3">
                                                <label class="form-label">å°‚é–€åˆ†é‡</label>
                                                <input type="text" name="internal_specialties" class="form-control" id="internalSpecialties" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                                            </div>

                                            <!-- ç¨¼åƒçŠ¶æ³ -->
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="internal_is_active" id="internalIsActive" checked>
                                                    <label class="form-check-label" for="internalIsActive">
                                                        ç¨¼åƒä¸­
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å¾Œã§æ±ºå®šæƒ…å ± -->
                            <div class="row mb-4" id="later_info" style="display: none;">
                                <div class="col-md-12">
                                    <div class="alert alert-warning border-warning">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-clock text-warning me-2"></i>
                                            <strong>å¾Œã§æ±ºå®šï¼ˆè©³ç´°ç”»é¢ï¼‰</strong>
                                        </div>
                                        <small class="text-muted">
                                            è©³ç´°ç”»é¢ã§ã¯ä»¥ä¸‹ã®å®Ÿæ–½ä½“åˆ¶ã‹ã‚‰é¸æŠã§ãã¾ã™ï¼š
                                        </small>
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <div class="form-check mb-1">
                                                <input class="form-check-input" type="radio" disabled>
                                                <label class="form-check-label">
                                                    <i class="fas fa-building me-1"></i>å¤–æ³¨å…ˆã«ç™ºæ³¨
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" disabled>
                                                <label class="form-check-label">
                                                    <i class="fas fa-users me-1"></i>ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹
                                                </label>
                                            </div>
                                            <small class="text-muted d-block mt-2">
                                                â€¢ è¤‡æ•°ã®å¤–æ³¨å…ˆã¨ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®çµ„ã¿åˆã‚ã›ã‚‚å¯èƒ½<br>
                                                â€¢ å·¥ç¨‹ã”ã¨ã«ç•°ãªã‚‹å®Ÿæ–½ä½“åˆ¶ã‚’è¨­å®šå¯èƒ½
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffManagementModal" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffManagementModalLabel">
                    <i class="fas fa-users"></i> æ‹…å½“è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">æ‹…å½“è€…ä¸€è¦§</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewStaff()">
                        <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>éƒ¨ç½²</th>
                                <th>æ™‚çµ¦</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç·¨é›†/è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalTitle">æ‹…å½“è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    <div class="mb-3">
                        <label for="staffName" class="form-label">æ‹…å½“è€…å <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="staffName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staffDepartment" class="form-label">éƒ¨ç½²</label>
                        <input type="text" class="form-control" id="staffDepartment" name="department" placeholder="ä¾‹: æ–½å·¥éƒ¨">
                    </div>
                    <div class="mb-3">
                        <label for="staffHourlyRate" class="form-label">æ™‚çµ¦</label>
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control" id="staffHourlyRate" name="hourly_rate" placeholder="ä¾‹: 3000">
                            <span class="input-group-text">/æ™‚é–“</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="staffSpecialties" name="specialties" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="staffActive" name="active" checked>
                        <label class="form-check-label" for="staffActive">
                            æœ‰åŠ¹
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="salesStaffManagementModal" tabindex="-1" aria-labelledby="salesStaffManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="salesStaffManagementModalLabel">
                    <i class="fas fa-chart-line"></i> å–¶æ¥­æ‹…å½“è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">å–¶æ¥­æ‹…å½“è€…ä¸€è¦§</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="openAddSalesStaffModal()">
                        <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                    </button>
                </div>

                <!-- å–¶æ¥­æ‹…å½“è€…ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>éƒ¨ç½²</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="salesStaffTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- å®Ÿç¸¾æ¨ç§»ã‚°ãƒ©ãƒ•äºˆå®šåœ° (ç®¡ç†è€…ã®ã¿è¡¨ç¤º) -->
                {% if user.is_staff or user.is_superuser %}
                <div class="mt-4" style="opacity: 0.6;">
                    <h6 class="mb-3">å®Ÿç¸¾æ¨ç§»</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">åˆ©ç›Šç‡æ¨ç§»</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">æ¡ˆä»¶æ•°æ¨ç§»</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°è¦å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="addSalesStaffModal" tabindex="-1" aria-labelledby="addSalesStaffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSalesStaffModalLabel">
                    <i class="fas fa-user-plus"></i> æ–°è¦å–¶æ¥­æ‹…å½“è€…è¿½åŠ 
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSalesStaffForm">
                    <div class="mb-3">
                        <label for="salesStaffName" class="form-label">åå‰ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="salesStaffName" name="name" required placeholder="ä¾‹: ç”°ä¸­ å¤ªéƒ">
                    </div>
                    <div class="mb-3">
                        <label for="salesStaffDepartment" class="form-label">éƒ¨ç½² <span class="text-danger">*</span></label>
                        <select class="form-select" id="salesStaffDepartment" name="department" required>
                            <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
                            <option value="sales">å–¶æ¥­éƒ¨</option>
                            <option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="salesStaffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="salesStaffSpecialties" name="specialties" placeholder="ä¾‹: ä½å®…å–¶æ¥­ã€æ³•äººå–¶æ¥­">
                        <small class="form-text text-muted">ä»»æ„: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥åŠ›å¯</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="submitNewSalesStaff()">
                    <i class="fas fa-save"></i> è¿½åŠ 
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editSalesStaffModal" tabindex="-1" aria-labelledby="editSalesStaffModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSalesStaffModalLabel">
                    <i class="fas fa-user-edit"></i> å–¶æ¥­æ‹…å½“è€…ç·¨é›†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSalesStaffForm">
                    <input type="hidden" id="editSalesStaffId">
                    <div class="mb-3">
                        <label for="editSalesStaffName" class="form-label">åå‰ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editSalesStaffName" name="name" required placeholder="ä¾‹: ç”°ä¸­ å¤ªéƒ">
                    </div>
                    <div class="mb-3">
                        <label for="editSalesStaffDepartment" class="form-label">éƒ¨ç½² <span class="text-danger">*</span></label>
                        <select class="form-select" id="editSalesStaffDepartment" name="department" required>
                            <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
                            <option value="sales">å–¶æ¥­éƒ¨</option>
                            <option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSalesStaffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="editSalesStaffSpecialties" name="specialties" placeholder="ä¾‹: ä½å®…å–¶æ¥­ã€æ³•äººå–¶æ¥­">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editSalesStaffIsActive" name="is_active" checked>
                            <label class="form-check-label" for="editSalesStaffIsActive">
                                æœ‰åŠ¹
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="submitEditSalesStaff()">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteSalesStaffModal" tabindex="-1" aria-labelledby="deleteSalesStaffModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSalesStaffModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> å‰Šé™¤ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong id="deleteSalesStaffName"></strong>ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-circle"></i> ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </div>
                <input type="hidden" id="deleteSalesStaffId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteSalesStaff()">
                    <i class="fas fa-trash"></i> å‰Šé™¤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ±ç”¨å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> å‰Šé™¤ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" id="confirmDeleteMessage">ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-circle"></i> ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">
                    <i class="fas fa-trash"></i> å‰Šé™¤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="craftsmanManagementModal" tabindex="-1" aria-labelledby="craftsmanManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="craftsmanManagementModalLabel">
                    <i class="fas fa-tools"></i> è·äººç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">è·äººä¸€è¦§</h6>
                    <div class="d-flex gap-2">
                        <span class="badge bg-warning">â€» ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…äºˆå®š</span>
                        <button type="button" class="btn btn-primary btn-sm" onclick="toastr.info('æ–°è¦è¿½åŠ æ©Ÿèƒ½ã¯å¾Œæ—¥å®Ÿè£…äºˆå®šã§ã™')" disabled>
                            <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- è·äººã‚¹ã‚­ãƒ«ãƒ»å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive" style="opacity: 0.6;">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>è·ç¨®</th>
                                <th>ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>è³‡æ ¼</th>
                                <th>çµŒé¨“å¹´æ•°</th>
                                <th>å®Œäº†æ¡ˆä»¶æ•°</th>
                                <th>å¹³å‡è©•ä¾¡</th>
                                <th>æ™‚çµ¦å˜ä¾¡</th>
                                <th>ç¨¼åƒçŠ¶æ³</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>å±±ç”° è·äºº</strong></td>
                                <td>é›»æ°—å·¥äº‹å£«</td>
                                <td><span class="badge bg-success">ä¸Šç´š</span></td>
                                <td>é«˜åœ§é›»æ°—å·¥äº‹ã€åˆ¶å¾¡ç›¤</td>
                                <td>ç¬¬ä¸€ç¨®é›»æ°—å·¥äº‹å£«ã€é«˜åœ§é›»æ°—å·¥äº‹æŠ€å¸«</td>
                                <td>15å¹´</td>
                                <td><span class="badge bg-primary">245</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜†</span> 4.2</td>
                                <td><strong>Â¥4,500/æ™‚</strong></td>
                                <td><span class="badge bg-success">ç¨¼åƒä¸­</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>é«˜æ©‹ é…ç®¡</strong></td>
                                <td>é…ç®¡å·¥</td>
                                <td><span class="badge bg-info">ä¸­ç´š</span></td>
                                <td>çµ¦æ’æ°´é…ç®¡ã€ç©ºèª¿é…ç®¡</td>
                                <td>é…ç®¡æŠ€èƒ½å£«1ç´šã€ç®¡å·¥äº‹æ–½å·¥ç®¡ç†æŠ€å£«</td>
                                <td>8å¹´</td>
                                <td><span class="badge bg-primary">112</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜†</span> 3.8</td>
                                <td><strong>Â¥3,200/æ™‚</strong></td>
                                <td><span class="badge bg-warning">ç©ºã</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>ä¼Šè—¤ å¤§å·¥</strong></td>
                                <td>å¤§å·¥</td>
                                <td><span class="badge bg-success">ä¸Šç´š</span></td>
                                <td>æœ¨é€ å»ºç¯‰ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ã€å†…è£…</td>
                                <td>å»ºç¯‰å¤§å·¥æŠ€èƒ½å£«1ç´šã€å»ºç¯‰æ–½å·¥ç®¡ç†æŠ€å£«</td>
                                <td>20å¹´</td>
                                <td><span class="badge bg-primary">320</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜…</span> 4.7</td>
                                <td><strong>Â¥4,000/æ™‚</strong></td>
                                <td><span class="badge bg-success">ç¨¼åƒä¸­</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ã‚¹ã‚­ãƒ«çµ±è¨ˆ -->
                <div class="mt-4" style="opacity: 0.6;">
                    <h6 class="mb-3">ã‚¹ã‚­ãƒ«çµ±è¨ˆ</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">è·ç¨®åˆ¥åˆ†å¸ƒ</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">å††ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«åˆ†å¸ƒ</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">æ£’ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ç¨¼åƒçŠ¶æ³</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ç¨¼åƒçŠ¶æ³ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="contractorManagementModal" tabindex="-1" aria-labelledby="contractorManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 95vw; width: 95vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorManagementModalLabel">
                    <i class="fas fa-building"></i> æ¥­è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h6 class="mb-2">æ¥­è€…ä¸€è¦§</h6>
                        <div class="d-flex gap-3">
                            <span class="badge bg-success bg-opacity-25 text-success border border-success">
                                <i class="fas fa-circle me-1"></i>å—æ³¨æ¥­è€…
                            </span>
                            <span class="badge bg-warning bg-opacity-25 text-warning border border-warning">
                                <i class="fas fa-circle me-1"></i>ç™ºæ³¨æ¥­è€…
                            </span>
                            <span class="badge bg-light text-dark border">
                                <i class="fas fa-circle me-1"></i>ãã®ä»–
                            </span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewContractor()">
                        <i class="fas fa-plus"></i> æ–°è¦æ¥­è€…è¿½åŠ 
                    </button>
                </div>

                <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" id="contractorSearch" class="form-control" placeholder="å…ƒè«‹åãƒ»é›»è©±ãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢" onkeyup="filterContractors()">
                    </div>
                    <div class="col-md-3">
                        <select id="contractorTypeFilter" class="form-select" onchange="filterContractors()">
                            <option value="">å…¨ã‚¿ã‚¤ãƒ—</option>
                            <option value="ordering">ç™ºæ³¨æ¥­è€…</option>
                            <option value="receiving">å—æ³¨æ¥­è€…</option>
                            <option value="supplier">è³‡æå±‹</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="contractorStatusFilter" class="form-select" onchange="filterContractors()">
                            <option value="">å…¨çŠ¶æ…‹</option>
                            <option value="active">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
                            <option value="inactive">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearContractorFilters()">
                            <i class="fas fa-times"></i> ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>

                <!-- æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-hover contractor-table">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="min-width: 200px; cursor: pointer;" onclick="sortContractorTable('name')">
                                    å…ƒè«‹å <i class="fas fa-sort"></i>
                                </th>
                                <th style="min-width: 200px;">æ¥­è€…ã‚¿ã‚¤ãƒ—</th>
                                <th style="min-width: 150px;">å°‚é–€åˆ†é‡</th>
                                <th style="min-width: 300px;">ä½æ‰€</th>
                                <th style="min-width: 140px;">é›»è©±ç•ªå·</th>
                                <th style="min-width: 200px;">ãƒ¡ãƒ¼ãƒ«</th>
                                <th style="min-width: 120px;">æ‹…å½“è€…</th>
                                <th style="min-width: 100px; cursor: pointer;" onclick="sortContractorTable('status')">
                                    çŠ¶æ…‹ <i class="fas fa-sort"></i>
                                </th>
                                <th style="min-width: 100px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="contractorTableBody">
                            <!-- æ¥­è€…æƒ…å ±ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¥­è€…ç·¨é›†/è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="contractorModal" tabindex="-1" aria-labelledby="contractorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorModalTitle">æ¥­è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="contractorForm">
                    <input type="hidden" id="contractorId" name="id">

                    <!-- æ¥­è€…é¸æŠæ–¹æ³• -->
                    <div class="mb-3 contractor-input-method">
                        <label class="form-label">æ¥­è€…é¸æŠæ–¹æ³• <span class="text-danger">*</span></label>
                        <div class="mb-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="contractor_input_type" id="existingContractorChoice" value="existing" checked>
                                <label class="form-check-label" for="existingContractorChoice">
                                    æ—¢å­˜ã‹ã‚‰é¸æŠ
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="contractor_input_type" id="newContractorChoice" value="new">
                                <label class="form-check-label" for="newContractorChoice">
                                    æ–°è¦å…¥åŠ›
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¢å­˜æ¥­è€…é¸æŠ -->
                    <div id="existingContractorDiv">
                        <div class="mb-3">
                            <label class="form-label">æ—¢å­˜æ¥­è€…ã‚’é¸æŠ</label>
                            <select class="form-select" id="existingContractorSelect" name="existing_contractor_id">
                                <option value="">-- æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                {% for contractor in contractors %}
                                <option value="{{ contractor.id }}"
                                        data-name="{{ contractor.name }}"
                                        data-address="{{ contractor.address }}"
                                        data-phone="{{ contractor.phone|default:'' }}"
                                        data-type="{{ contractor.contractor_type|default:'' }}"
                                        data-specialties="{{ contractor.specialties|default:'' }}">
                                    {{ contractor.name }}{% if contractor.address %} - {{ contractor.address }}{% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- æ–°è¦æ¥­è€…å…¥åŠ› -->
                    <div id="newContractorDiv" style="display: none;">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="contractorName" class="form-label">å…ƒè«‹å <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="contractorName" name="name" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">æ¥­è€…åˆ†é¡ <span class="text-danger">*</span></label>
                                <div class="mt-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="contractor_classification" value="ordering" id="contractorOrdering">
                                        <label class="form-check-label" for="contractorOrdering">
                                            ç™ºæ³¨æ¥­è€…
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="contractor_classification" value="receiving" id="contractorReceiving">
                                        <label class="form-check-label" for="contractorReceiving">
                                            å—æ³¨æ¥­è€…
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="contractor_classification" value="supplier" id="contractorSupplier">
                                        <label class="form-check-label" for="contractorSupplier">
                                            è³‡æå±‹
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="contractor_classification" value="other" id="contractorOther">
                                        <label class="form-check-label" for="contractorOther">
                                            ãã®ä»–
                                        </label>
                                    </div>
                                    <div class="mt-2" id="contractorOtherText" style="display: none;">
                                        <input type="text" class="form-control form-control-sm" name="contractor_classification_other" placeholder="ãã®ä»–ã®åˆ†é¡ã‚’å…¥åŠ›">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="contractorType" class="form-label">æ¥­ç¨®</label>
                                <select class="form-select" id="contractorType" name="contractor_type">
                                    <option value="">-- æ¥­ç¨®ã‚’é¸æŠ --</option>
                                    <option value="construction">å»ºè¨­æ¥­</option>
                                    <option value="electrical">é›»æ°—å·¥äº‹æ¥­</option>
                                    <option value="plumbing">ç®¡å·¥äº‹æ¥­</option>
                                    <option value="painting">å¡—è£…æ¥­</option>
                                    <option value="interior">å†…è£…æ¥­</option>
                                    <option value="other">ãã®ä»–</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="contractorAddress" class="form-label">ä½æ‰€</label>
                            <input type="text" class="form-control" id="contractorAddress" name="address">
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="contractorPhone" class="form-label">é›»è©±ç•ªå·</label>
                                <input type="tel" class="form-control" id="contractorPhone" name="phone">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="contractorEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                                <input type="email" class="form-control" id="contractorEmail" name="email">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="contractorSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                            <input type="text" class="form-control" id="contractorSpecialties" name="specialties" placeholder="ä¾‹: æœ¨é€ å»ºç¯‰ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ">
                        </div>

                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="contractorActive" name="active" checked>
                            <label class="form-check-label" for="contractorActive">
                                æœ‰åŠ¹
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveContractor()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<script>
// ãƒ•ã‚©ãƒ¼ãƒ å¤‰æ›´çŠ¶æ…‹ã®ç®¡ç†
let formChanged = false;
let originalFormData = {};
let hasFormBeenModified = false; // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ãƒ©ã‚°

// ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã‚’ä¿å­˜
function saveOriginalFormData() {
    const form = document.querySelector('form');
    if (!form) return;

    const formData = new FormData(form);
    originalFormData = {};
    for (let [key, value] of formData.entries()) {
        originalFormData[key] = value;
    }
    console.log('Original form data saved:', Object.keys(originalFormData).length, 'fields');
}

// ãƒ•ã‚©ãƒ¼ãƒ ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
function checkFormChanges() {
    const form = document.querySelector('form');
    if (!form) return false;

    const currentFormData = new FormData(form);
    let hasChanges = false;

    // ãƒ‡ãƒãƒƒã‚°ç”¨
    console.log('Original form data:', originalFormData);
    console.log('Current form data:', Object.fromEntries(currentFormData.entries()));

    // ç¾åœ¨ã®å€¤ã¨åˆæœŸå€¤ã‚’æ¯”è¼ƒ
    for (let [key, value] of currentFormData.entries()) {
        if (originalFormData[key] !== value) {
            console.log(`Field changed: ${key} = "${originalFormData[key]}" â†’ "${value}"`);
            hasChanges = true;
            break;
        }
    }

    // å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒã‚§ãƒƒã‚¯
    if (!hasChanges) {
        for (let key in originalFormData) {
            if (!currentFormData.has(key)) {
                console.log(`Field removed: ${key}`);
                hasChanges = true;
                break;
            }
        }
    }

    return hasChanges;
}

// ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
function updateButtonText() {
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const isEdit = {{ project|yesno:"true,false" }};

    if (!isEdit) return; // æ–°è¦ä½œæˆã®å ´åˆã¯å¤‰æ›´ã—ãªã„

    const hasChanges = checkFormChanges();
    console.log('Form changes detected:', hasChanges); // ãƒ‡ãƒãƒƒã‚°ç”¨

    if (hasChanges) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> æ¡ˆä»¶ã‚’æ›´æ–°';
        submitBtn.className = 'btn btn-warning btn-lg me-3';
        submitBtn.disabled = false; // ç¢ºå®Ÿã«æœ‰åŠ¹åŒ–
        formChanged = true;
    } else {
        submitBtn.innerHTML = '<i class="fas fa-check"></i> ä¿å­˜æ¸ˆã¿';
        submitBtn.className = 'btn btn-success btn-lg me-3';
        submitBtn.disabled = true;
        formChanged = false;
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æˆåŠŸæ™‚ã®å‡¦ç†
function handleFormSubmitSuccess() {
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    submitBtn.innerHTML = '<i class="fas fa-check"></i> æ›´æ–°å®Œäº†';
    submitBtn.className = 'btn btn-success btn-lg me-3';
    submitBtn.disabled = true;

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’ã€Œæˆ»ã‚‹ã€ã«å¤‰æ›´
    cancelBtn.innerHTML = '<i class="fas fa-arrow-left"></i> æˆ»ã‚‹';

    // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ï¼ˆé€ä¿¡æˆåŠŸãªã®ã§ä¸è¦ï¼‰
    clearSavedFormValues();

    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
    setTimeout(() => {
        saveOriginalFormData(); // æ–°ã—ã„çŠ¶æ…‹ã‚’åˆæœŸå€¤ã¨ã—ã¦ä¿å­˜
        updateButtonText();
    }, 2000);
}

$(document).ready(function() {
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãŒå®Œå…¨ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§ï¼‰
    setTimeout(function() {
        // åˆæœŸå€¤ã‚’ä¿å­˜
        saveOriginalFormData();

        // åˆæœŸçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        updateButtonText();

        console.log('Form initialization completed');

        // ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ï¼‰
        const isEdit = {{ project|yesno:"true,false" }};
        if (isEdit) {
            console.log('Setting up form change listeners for edit mode');

            // ã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ã‚’ä½¿ã£ã¦ã‚ˆã‚Šç¢ºå®Ÿã«ç›£è¦–
            $(document).on('input change', 'form input, form select, form textarea', function(e) {
                const fieldName = $(this).attr('name') || 'unnamed';
                console.log('Form field changed:', fieldName, 'value:', $(this).val());

                // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰æ›´æ–°ï¼ˆé€£ç¶šã—ãŸå¤‰æ›´ã‚’ã¾ã¨ã‚ã‚‹ï¼‰
                clearTimeout(window.formChangeTimeout);
                window.formChangeTimeout = setTimeout(function() {
                    console.log('Calling updateButtonText after field change');
                    updateButtonText();
                }, 100);
            });
        }
    }, 100);

    // å—æ³¨ãƒ¨ãƒŸã®å¤‰æ›´ã‚’ç‰¹åˆ¥ã«å‡¦ç†
    $('select[name="project_status"]').on('change', function(e) {
        const projectId = {{ project.pk|default:"null" }};
        const newValue = $(this).val();

        // æ–°è¦ä½œæˆã®å ´åˆã¯ã€ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã«å€¤ãŒå«ã¾ã‚Œã‚‹ã®ã§ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
        if (!projectId) {
            updateButtonText(); // ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¯æ›´æ–°
            return;
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å³åº§ã«AJAXæ›´æ–°
        e.stopPropagation(); // é€šå¸¸ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ã

        const csrfToken = $('[name=csrfmiddlewaretoken]').val();

        // update_forecastã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ä½¿ç”¨
        $.ajax({
            url: '/orders/' + projectId + '/update-forecast/',
            method: 'POST',
            data: {
                project_status: newValue,
                csrfmiddlewaretoken: csrfToken
            },
            success: function(response) {
                if (response.success) {
                    // åˆæœŸå€¤ã‚’æ›´æ–°ï¼ˆä¿å­˜æ¸ˆã¿ã¨ã—ã¦ãƒãƒ¼ã‚¯ï¼‰
                    originalFormData['project_status'] = newValue;
                    updateButtonText();
                } else {
                    toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
            },
            error: function() {
                toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
    });

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆproject_statusä»¥å¤–ï¼‰
    $('#projectForm').on('input change', 'input, select:not([name="project_status"]), textarea', function() {
        console.log('Form field changed:', $(this).attr('name'), $(this).val());
        updateButtonText();
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
    $('#projectForm').on('submit', function(e) {
        e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡ã‚’é˜²ã

        const form = this;
        const submitBtn = document.getElementById('submitBtn');
        const formData = new FormData(form);

        // é€ä¿¡ä¸­ã®è¡¨ç¤º
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
        submitBtn.disabled = true;

        // AJAXé€ä¿¡
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers.get('content-type'));

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ãªã„å ´åˆã®å‡¦ç†
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    console.log('Non-JSON response:', text.substring(0, 500));
                    throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.success) {
                // æˆåŠŸæ™‚ã®å‡¦ç†
                handleFormSubmitSuccess();

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                if (data.message) {
                    // Bootstrap toast ã¾ãŸã¯ alert ã§æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    showSuccessMessage(data.message);
                }

                // 2ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                setTimeout(() => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    }
                }, 2000);
            } else {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                submitBtn.className = 'btn btn-danger btn-lg me-3';
                submitBtn.disabled = false;

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorMessage = data.message || 'ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (data.errors) {
                    console.log('Form errors:', data.errors);
                    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                    const errorDetails = Object.entries(data.errors).map(([field, errors]) =>
                        `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`
                    ).join('\n');
                    errorMessage += '\nè©³ç´°:\n' + errorDetails;
                }
                showErrorMessage(errorMessage);

                // 3ç§’å¾Œã«å…ƒã«æˆ»ã™
                setTimeout(() => {
                    updateButtonText();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> é€šä¿¡ã‚¨ãƒ©ãƒ¼';
            submitBtn.className = 'btn btn-danger btn-lg me-3';
            submitBtn.disabled = false;

            // 3ç§’å¾Œã«å…ƒã«æˆ»ã™
            setTimeout(() => {
                updateButtonText();
            }, 3000);
        });
    });

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showSuccessMessage(message) {
        // ç°¡å˜ãªã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦Bootstrap toastã«å¤‰æ›´å¯èƒ½ï¼‰
        const alertDiv = $(`
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('.container').first().prepend(alertDiv);

        // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            alertDiv.alert('close');
        }, 5000);
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showErrorMessage(message) {
        const alertDiv = $(`
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('.container').first().prepend(alertDiv);

        // 10ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            alertDiv.alert('close');
        }, 10000);
    }
});
</script>
<script>
console.log('ğŸ”¥ JavaScript loading...');

// å¿…é ˆé–¢æ•°ã‚’å®šç¾©
window.openBasicInfoContractorManagementPanel = function() {
    console.log('âœ… openBasicInfoContractorManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#contractorManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆå—æ³¨æ¥­è€…å„ªå…ˆï¼‰
            refreshContractorListForBasicInfo();

            console.log('âœ… æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ contractorManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.openAddImplementationModal = function() {
    console.log('âœ… openAddImplementationModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#addImplementationModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            clearImplementationModalForms();

            // åˆæœŸçŠ¶æ…‹ã‚’å¤–æ³¨å…ˆã«è¨­å®š
            $('input[name="modal_implementation_type"][value="outsource"]').prop('checked', true);
            toggleImplementationType();

            // æ¥­è€…é¸æŠæ–¹æ³•ã‚’æ—¢å­˜ã‹ã‚‰é¸æŠã«åˆæœŸè¨­å®š
            $('input[name="modal_contractor_input_type"][value="existing"]').prop('checked', true);
            toggleContractorInputType();

            // ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•ã‚’æ—¢å­˜ã‹ã‚‰é¸æŠã«åˆæœŸè¨­å®š
            $('input[name="modal_internal_input_type"][value="existing"]').prop('checked', true);
            toggleInternalInputType();

            console.log('âœ… å®Ÿæ–½ä½“åˆ¶ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ addImplementationModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.closeModal = function(modalId) {
    if (modalId) {
        $(`#${modalId}`).removeClass('show').css('display', 'none');
    } else {
        $('.modal').removeClass('show').css('display', 'none');
    }
    $('.modal-backdrop').remove();

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
    $('body').removeClass('modal-open').css('overflow', '');

    console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ:', modalId || 'all');
};

// è¿½åŠ ã®å¿…é ˆé–¢æ•°ã‚’å®šç¾©
window.openSalesStaffManagementPanel = function() {
    console.log('âœ… openSalesStaffManagementPanel called');

    try {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modalElement = document.getElementById('salesStaffManagementModal');
        if (modalElement) {
            // Bootstrap Modal APIã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true
            });
            modal.show();

            // å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            refreshSalesStaffList();

            console.log('âœ… å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ salesStaffManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.refreshSalesStaffList = function() {
    console.log('âœ… refreshSalesStaffList called');

    const tbody = $('#salesStaffTableBody');
    tbody.html('<tr><td colspan="5" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td></tr>');

    // AJAXã§æœ€æ–°ã®å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    $.ajax({
        url: '{% url "order_management:staff_api" %}',
        method: 'GET',
        success: function(response) {
            if (response.success && response.workers) {
                // å–¶æ¥­æ‹…å½“è€…ï¼ˆdepartment ãŒ sales ã¾ãŸã¯ marketingï¼‰ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
                const salesStaff = response.workers.filter(worker =>
                    worker.department === 'sales' || worker.department === 'marketing'
                );

                if (salesStaff.length === 0) {
                    tbody.html('<tr><td colspan="5" class="text-center text-muted">å–¶æ¥­æ‹…å½“è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>');
                    return;
                }

                let html = '';
                salesStaff.forEach(function(staff) {
                    const departmentDisplay = staff.department === 'sales' ? 'å–¶æ¥­éƒ¨' :
                                             staff.department === 'marketing' ? 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨' : staff.department;
                    const statusBadge = staff.is_active ?
                        '<span class="badge bg-success">æœ‰åŠ¹</span>' :
                        '<span class="badge bg-secondary">ç„¡åŠ¹</span>';
                    const specialties = staff.specialties || '-';

                    html += `
                        <tr style="cursor: pointer;" onclick="selectSalesStaff(${staff.id})" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                            <td><strong>${staff.name}</strong></td>
                            <td>${departmentDisplay}</td>
                            <td>${specialties}</td>
                            <td>${statusBadge}</td>
                            <td onclick="event.stopPropagation()">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editSalesStaff(${staff.id})" title="ç·¨é›†">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.html(html);
                console.log('âœ… å–¶æ¥­æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ:', salesStaff.length + 'ä»¶');
            } else {
                tbody.html('<tr><td colspan="5" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>');
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);
            tbody.html('<tr><td colspan="5" class="text-center text-danger">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td></tr>');
        }
    });
};

// å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
window.selectSalesStaff = function(staffId) {
    console.log('âœ… selectSalesStaff called', staffId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆBootstrap Modal APIã‚’ä½¿ç”¨ï¼‰
    const modalElement = document.getElementById('salesStaffManagementModal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«é¸æŠã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹IDãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const selectElement = $('#salesManagerSelect');
    const existingOption = selectElement.find(`option[value="${staffId}"]`);

    if (existingOption.length === 0) {
        // å­˜åœ¨ã—ãªã„å ´åˆã€APIã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¿½åŠ 
        console.log('âš ï¸ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«å–¶æ¥­æ‹…å½“è€…ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å–å¾—ä¸­...', staffId);

        $.ajax({
            url: '{% url "order_management:staff_api" %}',
            method: 'GET',
            success: function(response) {
                if (response.success && response.workers) {
                    // é¸æŠã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å–¶æ¥­æ‹…å½“è€…ã‚’æ¢ã™
                    const staff = response.workers.find(w => w.id == staffId);
                    if (staff) {
                        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
                        const newOption = $('<option></option>')
                            .val(staff.id)
                            .text(staff.name)
                            .data('name', staff.name)
                            .data('department', staff.department)
                            .data('hourly-rate', staff.hourly_rate);

                        selectElement.append(newOption);
                        selectElement.val(staffId).trigger('change');

                        console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ã—ã¦é¸æŠã—ã¾ã—ãŸ:', staff.name);
                    } else {
                        console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ:', staffId);
                        toastr.error('å–¶æ¥­æ‹…å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);
                toastr.error('å–¶æ¥­æ‹…å½“è€…ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
    } else {
        // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯é€šå¸¸é€šã‚Šé¸æŠ
        selectElement.val(staffId).trigger('change');
        console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¾ã—ãŸ:', staffId);
    }
};

window.openAddSalesStaffModal = function() {
    console.log('âœ… openAddSalesStaffModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢/ãƒªã‚»ãƒƒãƒˆ
    $('#addSalesStaffForm')[0].reset();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modalElement = document.getElementById('addSalesStaffModal');
    const modal = new bootstrap.Modal(modalElement);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã€backdropã®z-indexã‚’èª¿æ•´
    modalElement.addEventListener('shown.bs.modal', function() {
        // æœ€å¾Œã«è¿½åŠ ã•ã‚ŒãŸbackdropï¼ˆã“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã®backdropï¼‰ã®z-indexã‚’èª¿æ•´
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            const lastBackdrop = backdrops[backdrops.length - 1];
            lastBackdrop.style.zIndex = '10040';
        }
    }, { once: true });

    modal.show();
};

window.submitNewSalesStaff = function() {
    console.log('âœ… submitNewSalesStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const name = $('#salesStaffName').val().trim();
    const department = $('#salesStaffDepartment').val();
    const hourlyRateStr = $('#salesStaffHourlyRate').val();
    const hourlyRate = hourlyRateStr ? parseFloat(hourlyRateStr) : 0;
    const specialties = $('#salesStaffSpecialties').val().trim();

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name) {
        toastr.error('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    if (!department) {
        toastr.error('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    // æ–°è¦å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ 
    addNewSalesStaff({
        name: name,
        department: department,
        hourly_rate: hourlyRate,
        specialties: specialties
    });
};

window.addNewSalesStaff = function(staffData) {
    console.log('âœ… addNewSalesStaff called', staffData);

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ–°è¦å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ï¼ˆAJAXï¼‰
    $.ajax({
        url: '{% url "subcontract_management:add_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            name: staffData.name,
            department: staffData.department,
            hourly_rate: staffData.hourly_rate,
            specialties: staffData.specialties,
            is_active: true
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('addSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${staffData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                refreshSalesStaffList();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«æ–°ã—ã„å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
                const newStaffId = response.staff_id;
                const newOption = $('<option></option>')
                    .val(newStaffId)
                    .text(staffData.name)
                    .data('name', staffData.name)
                    .data('department', staffData.department)
                    .data('hourly-rate', staffData.hourly_rate);

                $('#salesManagerSelect').append(newOption);

                // æ–°ã—ãè¿½åŠ ã—ãŸå–¶æ¥­æ‹…å½“è€…ã‚’è‡ªå‹•é¸æŠ
                $('#salesManagerSelect').val(newStaffId).trigger('change');

                console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ã—ã€è‡ªå‹•é¸æŠã—ã¾ã—ãŸ');
            } else {
                toastr.error(response.message || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†
window.editSalesStaff = function(staffId) {
    console.log('âœ… editSalesStaff called for ID:', staffId);

    // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const allInternalWorkers = {{ internal_workers_json|safe }};
    const staff = allInternalWorkers.find(w => w.id === staffId);

    if (!staff) {
        toastr.error('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    $('#editSalesStaffId').val(staff.id);
    $('#editSalesStaffName').val(staff.name);
    $('#editSalesStaffDepartment').val(staff.department);
    $('#editSalesStaffHourlyRate').val(staff.hourly_rate || '');
    $('#editSalesStaffSpecialties').val(staff.specialties || '');
    $('#editSalesStaffIsActive').prop('checked', staff.is_active);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('editSalesStaffModal'));
    modal.show();
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ã‚’ä¿å­˜
window.submitEditSalesStaff = function() {
    console.log('âœ… submitEditSalesStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const staffId = $('#editSalesStaffId').val();
    const name = $('#editSalesStaffName').val().trim();
    const department = $('#editSalesStaffDepartment').val();
    const hourlyRateStr = $('#editSalesStaffHourlyRate').val();
    const hourlyRate = hourlyRateStr ? parseFloat(hourlyRateStr) : 0;
    const specialties = $('#editSalesStaffSpecialties').val().trim();
    const isActive = $('#editSalesStaffIsActive').is(':checked');

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name) {
        toastr.error('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    if (!department) {
        toastr.error('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    $.ajax({
        url: '{% url "subcontract_management:update_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            staff_id: staffId,
            name: name,
            department: department,
            hourly_rate: hourlyRate,
            specialties: specialties,
            is_active: isActive
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('editSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${name}ã®æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(response.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
window.deleteSalesStaff = function(staffId, staffName) {
    console.log('âœ… deleteSalesStaff called for ID:', staffId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    $('#deleteSalesStaffId').val(staffId);
    $('#deleteSalesStaffName').text(staffName);

    // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('deleteSalesStaffModal'));
    modal.show();
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ã‚’å®Ÿè¡Œ
window.confirmDeleteSalesStaff = function() {
    console.log('âœ… confirmDeleteSalesStaff called');

    const staffId = $('#deleteSalesStaffId').val();
    const staffName = $('#deleteSalesStaffName').text();

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    $.ajax({
        url: '{% url "subcontract_management:delete_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            staff_id: staffId
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${staffName}ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(response.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

window.openContractorManagementPanel = function() {
    console.log('âœ… openContractorManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#contractorManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆç™ºæ³¨æ¥­è€…å„ªå…ˆï¼‰
            refreshContractorListForImplementation();

            console.log('âœ… å·¥äº‹æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ contractorManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('å·¥äº‹æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.openCraftsmanManagementPanel = function() {
    console.log('âœ… openCraftsmanManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#craftsmanManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // è·äººãƒªã‚¹ãƒˆã‚’æ›´æ–°
            refreshCraftsmanList();

            console.log('âœ… è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ craftsmanManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.addImplementationItem = function() {
    console.log('âœ… addImplementationItem called');

    const implementationType = $('input[name="modal_implementation_type"]:checked').val();

    if (!implementationType) {
        toastr.warning('å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    let itemData = {
        type: implementationType,
        id: Date.now() // ç°¡æ˜“çš„ãªID
    };

    if (implementationType === 'outsource') {
        // å¤–æ³¨å…ˆã®æƒ…å ±ã‚’å–å¾—
        const contractorInputType = $('input[name="modal_contractor_input_type"]:checked').val();
        let contractorName = '';

        if (contractorInputType === 'existing') {
            // æ—¢å­˜æ¥­è€…ã‹ã‚‰é¸æŠ
            const selectedOption = $('#modalContractorSelect option:selected');
            contractorName = selectedOption.data('name') || selectedOption.text();
        } else {
            // æ–°è¦æ¥­è€…
            contractorName = $('input[name="modal_new_client_name"]').val();
        }

        const workDescription = $('textarea[name="modal_work_description"]').val();
        const contractAmount = $('input[name="modal_contract_amount"]').val();

        if (!contractorName || !workDescription) {
            toastr.warning('å…ƒè«‹åã¨ä½œæ¥­å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        itemData.contractorName = contractorName;
        itemData.workDescription = workDescription;
        itemData.contractAmount = contractAmount || 0;
        itemData.additionalCosts = [...window.modalAdditionalCosts];
        itemData.additionalCostTotal = window.modalAdditionalCosts.reduce((sum, item) => sum + item.amount, 0);

    } else if (implementationType === 'internal') {
        // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®æƒ…å ±ã‚’å–å¾—
        const internalInputType = $('input[name="modal_internal_input_type"]:checked').val();
        let staffName = '';
        let department = '';

        if (internalInputType === 'existing') {
            // æ—¢å­˜æ‹…å½“è€…ã‹ã‚‰é¸æŠ
            const selectedOption = $('#modalInternalSelect option:selected');
            staffName = selectedOption.data('name') || selectedOption.text();
            department = selectedOption.data('department') || '';
        } else {
            // æ–°è¦æ‹…å½“è€…
            staffName = $('input[name="modal_new_internal_name"]').val();
            department = $('input[name="modal_internal_department"]').val();
        }

        if (!staffName) {
            toastr.warning('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        itemData.staffName = staffName;
        itemData.department = department;

    } else if (implementationType === 'later') {
        itemData.description = 'å¾Œã§æ±ºå®š';
    }

    // å®Ÿæ–½ä½“åˆ¶ãƒªã‚¹ãƒˆã«è¿½åŠ 
    addToImplementationList(itemData);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#addImplementationModal').removeClass('show').css('display', 'none');
    $('.modal-backdrop').remove();

    toastr.success('å®Ÿæ–½ä½“åˆ¶ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
};

window.addNewStaff = function() {
    console.log('âœ… addNewStaff called');

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
    $('body').addClass('modal-open').css('overflow', 'hidden');

    // ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const modal = $('#staffModal');
    modal.css('display', 'block').addClass('show');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#staffForm')[0].reset();
    $('#staffModalTitle').text('æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ');
    $('#staffId').val('');

    // z-indexã‚’èª¿æ•´
    modal.css('z-index', '2060');
    $('.modal-backdrop').css('z-index', '2059');

    console.log('æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ');
};

window.saveStaff = function() {
    console.log('âœ… saveStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const formData = {
        name: $('#staffName').val(),
        department: $('#staffDepartment').val(),
        hourlyRate: $('#staffHourlyRate').val(),
        specialties: $('#staffSpecialties').val(),
        active: $('#staffActive').is(':checked')
    };

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.name) {
        toastr.warning('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã«è¿½åŠ 
    addStaffToList(formData);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#staffModal').removeClass('show').css('display', 'none');

    toastr.success('ã‚¹ã‚¿ãƒƒãƒ•ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
};

window.addNewContractor = function() {
    console.log('âœ… addNewContractor called');

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
    $('body').addClass('modal-open').css('overflow', 'hidden');

    // æ¥­è€…ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const modal = $('#contractorModal');
    modal.css('display', 'block').addClass('show');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#contractorForm')[0].reset();
    $('#contractorModalTitle').text('æ–°ã—ã„æ¥­è€…ã‚’è¿½åŠ ');

    // æ–°è¦è¿½åŠ æ™‚ã¯æ¥­è€…é¸æŠæ–¹æ³•ã‚’éè¡¨ç¤ºã«ã—ã¦ã€ç›´æ¥æ–°è¦å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    $('.contractor-input-method').hide();
    $('#existingContractorDiv').hide();
    $('#newContractorDiv').show();

    // z-indexã‚’èª¿æ•´ï¼ˆæ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šå‰é¢ã«ï¼‰
    modal.css('z-index', '2060');
    $('.modal-backdrop').css('z-index', '2059');

    console.log('æ–°è¦æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ');
};

window.saveContractor = function() {
    console.log('âœ… saveContractor called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§ï¼‰
    const formData = {
        name: $('#contractorName').val(),
        type: $('#contractorType').val(),
        address: $('#contractorAddress').val(),
        phone: $('#contractorPhone').val(),
        email: $('#contractorEmail').val(),
        specialties: $('#contractorSpecialties').val()
    };

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.name) {
        toastr.warning('å…ƒè«‹åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // æ¥­è€…ä¸€è¦§ã«è¿½åŠ ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
    addContractorToList(formData);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#contractorModal').removeClass('show').css('display', 'none');

    toastr.success('æ¥­è€…ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
};

// æ¥­è€…ä¸€è¦§ã«è¿½åŠ 
window.addContractorToList = function(contractorData) {
    const tableBody = $('#contractorTableBody');
    const id = Date.now(); // ç°¡æ˜“ID

    const newRow = `
        <tr data-contractor-id="${id}">
            <td><strong>${contractorData.name}</strong></td>
            <td><span class="badge bg-primary me-1">æ–°è¦</span></td>
            <td title="${contractorData.specialties}" class="text-wrap" style="max-width: 150px;">${contractorData.specialties || '-'}</td>
            <td title="${contractorData.address}" class="text-wrap" style="max-width: 300px;">${contractorData.address || '-'}</td>
            <td>${contractorData.phone || '-'}</td>
            <td title="${contractorData.email}" style="max-width: 200px;">${contractorData.email || '-'}</td>
            <td>-</td>
            <td><span class="badge bg-success">æœ‰åŠ¹</span></td>
            <td>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="editContractor(${id})" title="ç·¨é›†">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `;

    tableBody.append(newRow);

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚‚è¿½åŠ ï¼ˆã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨æœªä½¿ç”¨ï¼‰
    // const option = `<option value="${id}" data-name="${contractorData.name}">${contractorData.name}</option>`;
    // $('#clientCompanySelect').append(option);
    // $('#modalContractorSelect').append(option);
};

// ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿å®šç¾©
window.dummyContractors = [
    {
        id: 1,
        name: 'ç”°ä¸­å»ºè¨­æ ªå¼ä¼šç¤¾',
        classification: ['ç™ºæ³¨æ¥­è€…'],
        type: 'å»ºè¨­æ¥­',
        address: 'æ±äº¬éƒ½æ¸¯åŒºå…­æœ¬æœ¨1-2-3',
        phone: '03-1234-5678',
        email: 'tanaka@construction.com',
        specialties: 'æœ¨é€ å»ºç¯‰ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ',
        active: true
    },
    {
        id: 2,
        name: 'å±±ç”°é›»æ°—å·¥äº‹',
        classification: ['å—æ³¨æ¥­è€…'],
        type: 'é›»æ°—å·¥äº‹æ¥­',
        address: 'æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿2-3-4',
        phone: '03-2345-6789',
        email: 'yamada@electric.com',
        specialties: 'é«˜åœ§é›»æ°—ã€åˆ¶å¾¡ç›¤',
        active: true
    },
    {
        id: 3,
        name: 'ä½è—¤é…ç®¡ã‚µãƒ¼ãƒ“ã‚¹',
        classification: ['å—æ³¨æ¥­è€…', 'è³‡æå±‹'],
        type: 'ç®¡å·¥äº‹æ¥­',
        address: 'æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·1-5-6',
        phone: '03-3456-7890',
        email: 'sato@piping.com',
        specialties: 'çµ¦æ’æ°´ã€ç©ºèª¿é…ç®¡',
        active: true
    },
    {
        id: 4,
        name: 'éˆ´æœ¨å¡—è£…å·¥æ¥­',
        classification: ['å—æ³¨æ¥­è€…'],
        type: 'å¡—è£…æ¥­',
        address: 'æ±äº¬éƒ½ä¸–ç”°è°·åŒºä¸‹åŒ—æ²¢2-1-3',
        phone: '03-4567-8901',
        email: 'suzuki@painting.com',
        specialties: 'å¤–å£å¡—è£…ã€é˜²æ°´å·¥äº‹',
        active: false
    },
    {
        id: 5,
        name: 'é«˜æ©‹å†…è£…',
        classification: ['å—æ³¨æ¥­è€…'],
        type: 'å†…è£…æ¥­',
        address: 'æ±äº¬éƒ½ä¸­é‡åŒºä¸­é‡3-4-5',
        phone: '03-5678-9012',
        email: 'takahashi@interior.com',
        specialties: 'å†…è£…ä»•ä¸Šã’ã€åºŠå·¥äº‹',
        active: true
    }
];

window.dummyCraftsmen = [
    {
        id: 1,
        name: 'ä¼Šè—¤è·äºº',
        specialties: 'å¤§å·¥å·¥äº‹ã€æœ¨å·¥',
        experience: '15å¹´',
        hourlyRate: 3500,
        phone: '090-1234-5678',
        active: true
    },
    {
        id: 2,
        name: 'æ¸¡è¾ºå¡—è£…',
        specialties: 'å¡—è£…å·¥äº‹',
        experience: '10å¹´',
        hourlyRate: 3000,
        phone: '090-2345-6789',
        active: true
    },
    {
        id: 3,
        name: 'ä¸­æ‘é›»å·¥',
        specialties: 'é›»æ°—å·¥äº‹',
        experience: '8å¹´',
        hourlyRate: 3200,
        phone: '090-3456-7890',
        active: true
    }
];

window.dummyInternalStaff = [
    {
        id: 1,
        name: 'ç”°ä¸­å¤ªéƒ',
        department: 'å·¥äº‹éƒ¨',
        hourlyRate: 2500,
        specialties: 'ç¾å ´ç®¡ç†ã€å“è³ªç®¡ç†',
        active: true
    },
    {
        id: 2,
        name: 'ä½è—¤èŠ±å­',
        department: 'å–¶æ¥­éƒ¨',
        hourlyRate: 2800,
        specialties: 'å–¶æ¥­ã€é¡§å®¢å¯¾å¿œ',
        active: true
    },
    {
        id: 3,
        name: 'å±±ç”°æ¬¡éƒ',
        department: 'è¨­è¨ˆéƒ¨',
        hourlyRate: 3000,
        specialties: 'è¨­è¨ˆã€CAD',
        active: true
    }
];

// æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°
window.refreshContractorList = function() {
    console.log('æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderContractorTable(window.dummyContractors);
};

// åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆå—æ³¨æ¥­è€…å„ªå…ˆï¼‰
window.refreshContractorListForBasicInfo = function() {
    console.log('åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆå—æ³¨æ¥­è€…å„ªå…ˆï¼‰');
    const sortedContractors = [...window.dummyContractors].sort((a, b) => {
        if (a.active && !b.active) return -1;
        if (!a.active && b.active) return 1;
        if (a.classification.includes('å—æ³¨æ¥­è€…') && !b.classification.includes('å—æ³¨æ¥­è€…')) return -1;
        if (!a.classification.includes('å—æ³¨æ¥­è€…') && b.classification.includes('å—æ³¨æ¥­è€…')) return 1;
        return a.name.localeCompare(b.name);
    });
    renderContractorTable(sortedContractors);
};

// å®Ÿæ–½ä½“åˆ¶ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆç™ºæ³¨æ¥­è€…å„ªå…ˆï¼‰
window.refreshContractorListForImplementation = function() {
    console.log('å®Ÿæ–½ä½“åˆ¶ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆç™ºæ³¨æ¥­è€…å„ªå…ˆï¼‰');
    const sortedContractors = [...window.dummyContractors].sort((a, b) => {
        if (a.active && !b.active) return -1;
        if (!a.active && b.active) return 1;
        if (a.classification.includes('ç™ºæ³¨æ¥­è€…') && !b.classification.includes('ç™ºæ³¨æ¥­è€…')) return -1;
        if (!a.classification.includes('ç™ºæ³¨æ¥­è€…') && b.classification.includes('ç™ºæ³¨æ¥­è€…')) return 1;
        return a.name.localeCompare(b.name);
    });
    renderContractorTable(sortedContractors);
};

// è·äººãƒªã‚¹ãƒˆæ›´æ–°
window.refreshCraftsmanList = function() {
    console.log('è·äººãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderCraftsmanTable(window.dummyCraftsmen);
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆæ›´æ–°
window.refreshStaffList = function() {
    console.log('ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderStaffTable(window.dummyInternalStaff);
};

// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
window.filterContractors = function() {
    const searchTerm = $('#contractorSearch').val().toLowerCase();
    const typeFilter = $('#contractorTypeFilter').val();
    const statusFilter = $('#contractorStatusFilter').val();

    let filteredContractors = [...window.dummyContractors];

    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
    if (searchTerm) {
        filteredContractors = filteredContractors.filter(contractor =>
            contractor.name.toLowerCase().includes(searchTerm) ||
            (contractor.phone && contractor.phone.includes(searchTerm)) ||
            (contractor.email && contractor.email.toLowerCase().includes(searchTerm))
        );
    }

    // ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿
    if (typeFilter) {
        const typeMap = {
            'ordering': 'ç™ºæ³¨æ¥­è€…',
            'receiving': 'å—æ³¨æ¥­è€…',
            'supplier': 'è³‡æå±‹',
            'other': 'ãã®ä»–'
        };
        filteredContractors = filteredContractors.filter(contractor =>
            contractor.classification.includes(typeMap[typeFilter])
        );
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
    if (statusFilter) {
        const isActive = statusFilter === 'active';
        filteredContractors = filteredContractors.filter(contractor => contractor.active === isActive);
    }

    renderContractorTable(filteredContractors);
};

// ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
window.clearContractorFilters = function() {
    $('#contractorSearch').val('');
    $('#contractorTypeFilter').val('');
    $('#contractorStatusFilter').val('');
    filterContractors();
};

// ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
let currentSortColumn = '';
let currentSortDirection = 'asc';

window.sortContractorTable = function(column) {
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }

    let sortedContractors = [...window.dummyContractors];

    sortedContractors.sort((a, b) => {
        let aValue, bValue;

        switch(column) {
            case 'name':
                aValue = a.name.toLowerCase();
                bValue = b.name.toLowerCase();
                break;
            case 'status':
                aValue = a.active ? 1 : 0;
                bValue = b.active ? 1 : 0;
                break;
            default:
                return 0;
        }

        if (currentSortDirection === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });

    renderContractorTable(sortedContractors);

    // ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
    $('.contractor-table th i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
    $(`th[onclick*="${column}"] i`).removeClass('fa-sort')
        .addClass(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
};

// æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderContractorTable = function(contractors) {
    const tbody = $('#contractorTableBody');

    if (tbody.length === 0) {
        console.log('æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    contractors.forEach((contractor) => {
        const statusBadge = contractor.active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        const classificationBadges = contractor.classification.map(c => {
            const badgeClass = c.includes('å—æ³¨æ¥­è€…') ? 'bg-success' :
                             c.includes('ç™ºæ³¨æ¥­è€…') ? 'bg-primary' :
                             c.includes('è³‡æå±‹') ? 'bg-warning text-dark' : 'bg-secondary';
            return `<span class="badge ${badgeClass} me-1">${c}</span>`;
        }).join('');

        let rowClass = contractor.active ? 'clickable-row' : 'inactive-row';

        // å—æ³¨æ¥­è€…ãƒ»ç™ºæ³¨æ¥­è€…ã®è‰²åˆ†ã‘
        const isReceivingContractor = contractor.classification.some(c => c.includes('å—æ³¨æ¥­è€…'));
        const isOrderingContractor = contractor.classification.some(c => c.includes('ç™ºæ³¨æ¥­è€…'));

        if (isReceivingContractor) {
            rowClass += ' bg-success bg-opacity-10';
        } else if (isOrderingContractor) {
            rowClass += ' bg-warning bg-opacity-10';
        }

        const row = `
            <tr data-contractor-id="${contractor.id}" class="${rowClass}">
                <td><strong>${contractor.name}</strong></td>
                <td>${classificationBadges}</td>
                <td title="${contractor.specialties}" class="text-wrap" style="max-width: 150px;">${contractor.specialties || '-'}</td>
                <td title="${contractor.address}" class="text-wrap" style="max-width: 300px;">${contractor.address || '-'}</td>
                <td>${contractor.phone || '-'}</td>
                <td title="${contractor.email}" style="max-width: 200px;">${contractor.email || '-'}</td>
                <td>${contractor.contact_person || '-'}</td>
                <td>${statusBadge}</td>
                <td>
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                            onclick="editContractor(${contractor.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;

        tbody.append(row);
    });

    console.log(`æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã«${contractors.length}ä»¶ã®æ¥­è€…ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
};

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸ
function setupScrollSync() {
    const scrollContainer = $('.contractor-table-scroll');
    const fixedContainer = $('.contractor-table-fixed');

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸã‚’è¨­å®šï¼ˆé‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ããŸã‚ã€ä¸€åº¦å‰Šé™¤ã—ã¦ã‹ã‚‰è¨­å®šï¼‰
    scrollContainer.off('scroll.sync');
    fixedContainer.off('scroll.sync');

    scrollContainer.on('scroll.sync', function() {
        fixedContainer.scrollTop(this.scrollTop);
    });

    fixedContainer.on('scroll.sync', function() {
        scrollContainer.scrollTop(this.scrollTop);
    });

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šè¡Œã®é«˜ã•ã‚’ãƒã‚§ãƒƒã‚¯
    console.log('ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®é«˜ã•èª¿æ•´å®Œäº†');
    setTimeout(() => {
        const scrollRows = $('.contractor-table-scroll tbody tr');
        const fixedRows = $('.contractor-table-fixed tbody tr');
        console.log(`ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å´è¡Œæ•°: ${scrollRows.length}, å›ºå®šå´è¡Œæ•°: ${fixedRows.length}`);
        if (scrollRows.length > 0 && fixedRows.length > 0) {
            const scrollHeight = scrollRows.first().outerHeight();
            const fixedHeight = fixedRows.first().outerHeight();
            console.log(`è¡Œã®é«˜ã• - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å´: ${scrollHeight}px, å›ºå®šå´: ${fixedHeight}px`);
        }
    }, 100);
}

// è·äººãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderCraftsmanTable = function(craftsmen) {
    const tbody = $('#craftsmanTableBody');

    if (tbody.length === 0) {
        console.log('è·äººãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    craftsmen.forEach((craftsman) => {
        const statusBadge = craftsman.active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        tbody.append(`
            <tr data-craftsman-id="${craftsman.id}">
                <td><strong>${craftsman.name}</strong></td>
                <td>${craftsman.specialties}</td>
                <td>${craftsman.experience}</td>
                <td>Â¥${craftsman.hourlyRate.toLocaleString()}/æ™‚é–“</td>
                <td>${craftsman.phone}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editCraftsman(${craftsman.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCraftsman(${craftsman.id})" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderStaffTable = function(staff) {
    const tbody = $('#staffTableBody');

    if (tbody.length === 0) {
        console.log('ã‚¹ã‚¿ãƒƒãƒ•ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    staff.forEach((member) => {
        const statusBadge = member.active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        tbody.append(`
            <tr data-staff-id="${member.id}">
                <td><strong>${member.name}</strong></td>
                <td>${member.department}</td>
                <td>Â¥${member.hourlyRate.toLocaleString()}/æ™‚é–“</td>
                <td>${member.specialties}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editStaff(${member.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStaff(${member.id})" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã«è¿½åŠ 
window.addStaffToList = function(staffData) {
    const id = Date.now(); // ç°¡æ˜“ID
    const newStaff = {
        id: id,
        name: staffData.name,
        department: staffData.department,
        hourlyRate: staffData.hourlyRate || 0,
        specialties: staffData.specialties,
        active: staffData.active
    };

    window.dummyInternalStaff.push(newStaff);

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚‚è¿½åŠ 
    const option = `<option value="${id}" data-name="${staffData.name}" data-department="${staffData.department}" data-hourly-rate="${staffData.hourlyRate}">${staffData.name} (${staffData.department})</option>`;
    $('#modalInternalSelect').append(option);

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
    renderStaffTable(window.dummyInternalStaff);
};

// ç·¨é›†ãƒ»å‰Šé™¤é–¢æ•°ã®ã‚¹ã‚¿ãƒ–
// æ¥­è€…é¸æŠæ©Ÿèƒ½
window.selectContractor = function(id) {
    console.log(`æ¥­è€…ID ${id} ã‚’é¸æŠ`);

    // é¸æŠã•ã‚ŒãŸæ¥­è€…æƒ…å ±ã‚’å–å¾—
    const contractor = window.dummyContractors.find(c => c.id === id);
    if (!contractor) {
        toastr.error('æ¥­è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // ã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢: ClientCompanyã¯å°‚ç”¨ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã§ç®¡ç†ã—ã¾ã™
    // å¿…è¦ã«å¿œã˜ã¦å…ƒè«‹ä¼šç¤¾ç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆ/orders/client-companies/ï¼‰ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„
    console.warn('ã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚å…ƒè«‹ä¼šç¤¾ã¯å°‚ç”¨ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã§ç®¡ç†ã—ã¦ãã ã•ã„ã€‚');

    // æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#contractorManagementModal').removeClass('show').css('display', 'none');
    $('.modal-backdrop').remove();

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
    $('body').removeClass('modal-open').css('overflow', '');

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿ï¼‰
    console.log(`${contractor.name} ã‚’æ¥­è€…ã¨ã—ã¦è¨­å®šã—ã¾ã—ãŸ`);
};

window.editContractor = function(id) {
    // æ¥­è€…ç·¨é›†ãƒšãƒ¼ã‚¸ã«é·ç§»
    window.open(`/orders/contractors/${id}/edit/`, '_blank');
};

// æ±ç”¨å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
window.showConfirmDelete = function(message, onConfirm) {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    $('#confirmDeleteMessage').text(message);

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
    $('#confirmDeleteButton').off('click');

    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    $('#confirmDeleteButton').on('click', function() {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
        if (modal) {
            modal.hide();
        }

        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè¡Œ
        if (onConfirm && typeof onConfirm === 'function') {
            onConfirm();
        }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    modal.show();
};

window.deleteContractor = function(id) {
    showConfirmDelete('ã“ã®æ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        window.dummyContractors = window.dummyContractors.filter(c => c.id !== id);
        refreshContractorList();
        toastr.success('æ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });
};

window.editCraftsman = function(id) {
    toastr.info(`è·äººID ${id} ã®ç·¨é›†æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰`);
};

window.deleteCraftsman = function(id) {
    showConfirmDelete('ã“ã®è·äººã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        window.dummyCraftsmen = window.dummyCraftsmen.filter(c => c.id !== id);
        refreshCraftsmanList();
        toastr.success('è·äººã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });
};

window.editStaff = function(id) {
    toastr.info(`ã‚¹ã‚¿ãƒƒãƒ•ID ${id} ã®ç·¨é›†æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰`);
};

window.deleteStaff = function(id) {
    showConfirmDelete('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        window.dummyInternalStaff = window.dummyInternalStaff.filter(s => s.id !== id);
        refreshStaffList();
        toastr.success('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });
};

// å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
window.toggleImplementationType = function() {
    const selectedType = $('input[name="modal_implementation_type"]:checked').val();

    // å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
    $('.implementation-form').hide();

    // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    switch(selectedType) {
        case 'outsource':
            $('#modalContractorForm').show();
            break;
        case 'internal':
            $('#modalInternalForm').show();
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ãŒé¸æŠã•ã‚ŒãŸæ™‚ã€æ–™é‡‘ä½“ç³»ã‚‚åˆæœŸåŒ–
            $('input[name="modal_internal_pricing_type"][value="hourly"]').prop('checked', true);
            togglePricingType();
            break;
        case 'later':
            $('#modalLaterForm').show();
            break;
    }

    console.log('å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ:', selectedType);
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ©Ÿèƒ½
window.clearImplementationModalForms = function() {
    $('#addImplementationModal input[type="text"]').val('');
    $('#addImplementationModal input[type="number"]').val('');
    $('#addImplementationModal textarea').val('');
    $('#addImplementationModal select').val('');

    // è¿½åŠ è²»ç”¨ã‚‚ã‚¯ãƒªã‚¢
    clearModalAdditionalCosts();

    console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
};

// å®Ÿæ–½ä½“åˆ¶ãƒªã‚¹ãƒˆã«è¿½åŠ 
window.addToImplementationList = function(itemData) {
    const listContainer = $('#implementationList');

    let html = '';
    if (itemData.type === 'outsource') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-handshake text-primary me-2"></i>å¤–æ³¨å…ˆ: ${itemData.contractorName}
                            </h6>
                            <p class="card-text mb-1">
                                <strong>ä½œæ¥­å†…å®¹:</strong> ${itemData.workDescription}
                            </p>
                            <p class="card-text mb-1">
                                <strong>å¥‘ç´„é¡:</strong> Â¥${Number(itemData.contractAmount).toLocaleString()}
                            </p>
                            ${itemData.additionalCostTotal > 0 ? `
                            <p class="card-text mb-0">
                                <strong>è¿½åŠ è²»ç”¨:</strong> Â¥${Number(itemData.additionalCostTotal).toLocaleString()}
                                <small class="text-muted">(${itemData.additionalCosts.length}é …ç›®)</small>
                            </p>
                            ` : ''}
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else if (itemData.type === 'internal') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-users text-success me-2"></i>ç¤¾å†…: ${itemData.staffName}
                            </h6>
                            <p class="card-text mb-0">
                                <strong>éƒ¨ç½²:</strong> ${itemData.department || '-'}
                            </p>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else if (itemData.type === 'later') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-clock text-warning me-2"></i>å¾Œã§æ±ºå®š
                            </h6>
                            <p class="card-text mb-0">è©³ç´°ç”»é¢ã§å®Ÿæ–½ä½“åˆ¶ã‚’è¨­å®šã—ã¾ã™</p>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    listContainer.append(html);
};

// å®Ÿæ–½ä½“åˆ¶ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤
window.removeImplementationItem = function(itemId) {
    $(`[data-item-id="${itemId}"]`).remove();
};

// æ¥­è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆå‰Šé™¤æ¸ˆã¿ - ã‚·ãƒ³ãƒ—ãƒ«ãªå¤–æ³¨å…ˆé¸æŠã®ã¿ã«å¤‰æ›´ï¼‰

// ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
window.toggleInternalInputType = function() {
    const inputType = $('input[name="modal_internal_input_type"]:checked').val();
    console.log('ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•åˆ‡ã‚Šæ›¿ãˆ:', inputType);

    if (inputType === 'existing') {
        $('#modalExistingInternalDiv').show();
        $('#modalNewInternalDiv').hide();
        console.log('æ—¢å­˜æ‹…å½“è€…é¸æŠè¡¨ç¤º');
    } else {
        $('#modalExistingInternalDiv').hide();
        $('#modalNewInternalDiv').show();
        console.log('æ–°è¦æ‹…å½“è€…å…¥åŠ›è¡¨ç¤º');
    }
};

// æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆ
window.togglePricingType = function() {
    const pricingType = $('input[name="modal_internal_pricing_type"]:checked').val();
    console.log('========================');
    console.log('ğŸ”¥ æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆ:', pricingType);

    const hourlyFields = $('#modalHourlyPricingFields');
    const projectFields = $('#modalProjectPricingFields');

    console.log('ğŸ”§ Before changes:');
    console.log('  - modalHourlyPricingFields visible:', hourlyFields.is(':visible'));
    console.log('  - modalProjectPricingFields visible:', projectFields.is(':visible'));

    if (pricingType === 'hourly') {
        console.log('ğŸ”§ Setting to hourly mode');
        hourlyFields.show();
        projectFields.hide();
    } else if (pricingType === 'project') {
        console.log('ğŸ”§ Setting to project mode');
        hourlyFields.hide();
        projectFields.show();
    }

    console.log('ğŸ”§ After changes:');
    console.log('  - modalHourlyPricingFields visible:', hourlyFields.is(':visible'));
    console.log('  - modalProjectPricingFields visible:', projectFields.is(':visible'));
    console.log('========================');
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹è²»ç”¨è‡ªå‹•è¨ˆç®—
window.calculateModalInternalCost = function() {
    const pricingType = $('input[name="modal_internal_pricing_type"]:checked').val();

    if (pricingType === 'hourly') {
        const hourlyRate = parseFloat($('input[name="modal_internal_hourly_rate"]').val()) || 0;
        const hours = parseFloat($('input[name="modal_estimated_hours"]').val()) || 0;
        const totalCost = hourlyRate * hours;

        console.log('ğŸ’° æ™‚çµ¦ãƒ™ãƒ¼ã‚¹è¨ˆç®—:', {
            æ™‚çµ¦: hourlyRate,
            å·¥æ•°: hours,
            åˆè¨ˆ: totalCost
        });

        // è¨ˆç®—çµæœã‚’è¡¨ç¤ºã™ã‚‹å ´æ‰€ãŒã‚ã‚Œã°æ›´æ–°
        // (ç¾åœ¨ã®HTMLã«è¡¨ç¤ºé ˜åŸŸãŒãªã„å ´åˆã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèªã®ã¿)
        if ($('#modalInternalTotalCost').length) {
            $('#modalInternalTotalCost').text(totalCost.toLocaleString());
        }

        return totalCost;
    }
};

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
$(document).ready(function() {
    // å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_implementation_type"]', toggleImplementationType);

    // æ¥­è€…é¸æŠæ–¹æ³•å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_contractor_input_type"]', toggleContractorInputType);

    // ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_internal_input_type"]', toggleInternalInputType);

    // æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_internal_pricing_type"]', togglePricingType);

    // æ—¢å­˜æ‹…å½“è€…é¸æŠæ™‚ã®æ™‚çµ¦è‡ªå‹•å…¥åŠ›
    $(document).on('change', '#modalInternalSelect', function() {
        const selectedOption = $(this).find('option:selected');
        const hourlyRate = selectedOption.data('hourly-rate');

        if (hourlyRate) {
            $('input[name="modal_internal_hourly_rate"]').val(hourlyRate);
            console.log('ğŸ¯ æ‹…å½“è€…æ™‚çµ¦è‡ªå‹•å…¥åŠ›:', selectedOption.data('name'), 'Â¥' + hourlyRate + '/æ™‚é–“');

            // æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€è‡ªå‹•è¨ˆç®—ã‚’å®Ÿè¡Œ
            if ($('input[name="modal_internal_pricing_type"]:checked').val() === 'hourly') {
                calculateModalInternalCost();
            }
        }
    });

    // æ™‚çµ¦ãƒ»å·¥æ•°å¤‰æ›´æ™‚ã®è‡ªå‹•è¨ˆç®—
    $(document).on('input', 'input[name="modal_internal_hourly_rate"], input[name="modal_estimated_hours"]', function() {
        if ($('input[name="modal_internal_pricing_type"]:checked').val() === 'hourly') {
            calculateModalInternalCost();
        }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('click', '[data-bs-dismiss="modal"]', function() {
        const modal = $(this).closest('.modal');
        modal.removeClass('show').css('display', 'none');
        $('.modal-backdrop').remove();

        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
        $('body').removeClass('modal-open').css('overflow', '');

        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    $(document).on('click', '.modal-backdrop', function() {
        $('.modal').removeClass('show').css('display', 'none');
        $('.modal-backdrop').remove();

        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
        $('body').removeClass('modal-open').css('overflow', '');

        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    });

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape') {
            $('.modal.show').removeClass('show').css('display', 'none');
            $('.modal-backdrop').remove();

            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
            $('body').removeClass('modal-open').css('overflow', '');
            console.log('ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
        }
    });

    // åˆæœŸåŒ–æ™‚ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
    initializeDropdowns();

    console.log('ğŸ“Œ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
});

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ï¼ˆã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢ï¼‰
window.initializeDropdowns = function() {
    // å…ƒè«‹ä¼šç¤¾ã¯å°‚ç”¨ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã§ç®¡ç†ã—ã¾ã™
    // ã“ã®é–¢æ•°ã¯å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã—ã¦ã„ã¾ã™ãŒã€ä½•ã‚‚å®Ÿè¡Œã—ã¾ã›ã‚“
    console.log('initializeDropdowns: ã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸ');

    // ç¤¾å†…ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
    const internalSelect = $('#modalInternalSelect');

    window.dummyInternalStaff.filter(s => s.active).forEach(staff => {
        const option = `<option value="${staff.id}" data-name="${staff.name}" data-department="${staff.department}" data-hourly-rate="${staff.hourlyRate}">${staff.name} (${staff.department})</option>`;
        internalSelect.append(option);
    });

    console.log('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…è¿½åŠ è²»ç”¨ç®¡ç†
window.modalAdditionalCosts = [];

window.addModalCostItem = function() {
    const name = $('#modalNewCostItemName').val().trim();
    const amount = parseFloat($('#modalNewCostItemAmount').val()) || 0;
    const description = $('#modalNewCostItemDescription').val().trim();

    if (!name || amount <= 0) {
        toastr.warning('è²»ç”¨é …ç›®åã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    const costItem = {
        id: Date.now(),
        name: name,
        amount: amount,
        description: description
    };

    window.modalAdditionalCosts.push(costItem);
    renderModalCostList();
    updateModalCostTotal();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#modalNewCostItemName').val('');
    $('#modalNewCostItemAmount').val('');
    $('#modalNewCostItemDescription').val('');

    console.log('è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', costItem);
};

window.removeModalCostItem = function(id) {
    window.modalAdditionalCosts = window.modalAdditionalCosts.filter(item => item.id !== id);
    renderModalCostList();
    updateModalCostTotal();
    console.log('è¿½åŠ è²»ç”¨é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', id);
};

window.renderModalCostList = function() {
    const listContainer = $('#modalAdditionalCostList');
    listContainer.empty();

    window.modalAdditionalCosts.forEach(item => {
        const html = `
            <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2" data-cost-id="${item.id}">
                <div class="flex-grow-1">
                    <strong>${item.name}</strong>
                    <span class="text-muted ms-2">Â¥${item.amount.toLocaleString()}</span>
                    ${item.description ? `<br><small class="text-muted">${item.description}</small>` : ''}
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeModalCostItem(${item.id})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        listContainer.append(html);
    });
};

window.updateModalCostTotal = function() {
    const total = window.modalAdditionalCosts.reduce((sum, item) => sum + item.amount, 0);
    $('#modalAdditionalCostTotal').text('Â¥' + total.toLocaleString());
};

window.clearModalAdditionalCosts = function() {
    window.modalAdditionalCosts = [];
    renderModalCostList();
    updateModalCostTotal();
};

console.log('âœ… All functions loaded:', {
    fn1: typeof window.openBasicInfoContractorManagementPanel,
    fn2: typeof window.openAddImplementationModal,
    fn3: typeof window.closeModal,
    fn4: typeof window.toggleImplementationType,
    fn5: typeof window.clearImplementationModalForms,
    fn6: typeof window.addToImplementationList,
    fn7: typeof window.removeImplementationItem
});

// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
function switchFormViewMode(mode) {
    const tabViewBtn = document.getElementById('tabViewBtn');
    const fullViewBtn = document.getElementById('fullViewBtn');
    const tabNav = document.getElementById('projectFormTabs');
    const tabContent = document.getElementById('projectFormTabsContent');
    const tabPanes = document.querySelectorAll('#projectFormTabsContent .tab-pane');

    if (mode === 'tab') {
        // ã‚¿ãƒ–è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        tabViewBtn.classList.add('active');
        fullViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        tabNav.style.display = 'flex';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        tabContent.classList.remove('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // æœ€åˆã®ã‚¿ãƒ–ã‚’è¡¨ç¤º
        const firstPane = document.getElementById('basic');
        if (firstPane) {
            firstPane.classList.add('show', 'active');
        }

        // æœ€åˆã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        const tabButtons = document.querySelectorAll('#projectFormTabs .nav-link');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        const firstButton = document.getElementById('basic-tab');
        if (firstButton) {
            firstButton.classList.add('active');
        }

    } else if (mode === 'full') {
        // å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        fullViewBtn.classList.add('active');
        tabViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        tabNav.style.display = 'none';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        tabContent.classList.add('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        tabPanes.forEach(pane => {
            pane.classList.add('show', 'active');
        });
    }

    // é¸æŠçŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('projectFormViewMode', mode);
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œæ™‚ã®å€¤ä¿æŒç”¨ï¼‰
function saveFormValues() {
    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    if (siteNameField && siteNameField.value) {
        localStorage.setItem('project_form_site_name', siteNameField.value);
    }
    if (siteAddressField && siteAddressField.value) {
        localStorage.setItem('project_form_site_address', siteAddressField.value);
    }

    console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', {
        site_name: siteNameField?.value || '(ç©º)',
        site_address: siteAddressField?.value || '(ç©º)'
    });
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
function restoreFormValues() {
    const savedSiteName = localStorage.getItem('project_form_site_name');
    const savedSiteAddress = localStorage.getItem('project_form_site_address');

    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    // ç¾åœ¨ã®å€¤ãŒç©ºã®å ´åˆã®ã¿å¾©å…ƒ
    if (savedSiteName && siteNameField && !siteNameField.value) {
        siteNameField.value = savedSiteName;
        console.log('âœ… site_name ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', savedSiteName);
    }
    if (savedSiteAddress && siteAddressField && !siteAddressField.value) {
        siteAddressField.value = savedSiteAddress;
        console.log('âœ… site_address ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', savedSiteAddress);
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æˆåŠŸæ™‚ç”¨ï¼‰
function clearSavedFormValues() {
    localStorage.removeItem('project_form_site_name');
    localStorage.removeItem('project_form_site_address');
    console.log('ğŸ—‘ï¸ ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
document.addEventListener('DOMContentLoaded', function() {
    const savedMode = localStorage.getItem('projectFormViewMode');
    if (savedMode === 'full') {
        switchFormViewMode('full');
    }

    // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’å¾©å…ƒï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œï¼‰
    restoreFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›æ™‚ã«è‡ªå‹•ä¿å­˜
    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    if (siteNameField) {
        siteNameField.addEventListener('input', saveFormValues);
    }
    if (siteAddressField) {
        siteAddressField.addEventListener('input', saveFormValues);
    }

    // å…ƒè«‹ä¼šç¤¾é¸æŠæ™‚ã«æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•ã‚³ãƒ”ãƒ¼
    const clientCompanySelect = document.getElementById('clientCompanySelect');
    if (clientCompanySelect) {
        clientCompanySelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‹ã‚‰æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—
                const paymentCycle = selectedOption.getAttribute('data-payment-cycle');
                const closingDay = selectedOption.getAttribute('data-closing-day');
                const paymentDay = selectedOption.getAttribute('data-payment-day');

                // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
                const paymentCycleField = document.getElementById('{{ form.payment_cycle.id_for_label }}');
                const closingDayField = document.getElementById('{{ form.closing_day.id_for_label }}');
                const paymentDayField = document.getElementById('{{ form.payment_day.id_for_label }}');

                // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ï¼ˆç©ºæ–‡å­—åˆ—ã§ã‚‚è¨­å®šï¼‰
                if (paymentCycleField) {
                    paymentCycleField.value = paymentCycle || '';
                }

                // ç· ã‚æ—¥ï¼ˆå€¤ãŒã‚ã‚‹å ´åˆã®ã¿è¨­å®šã€ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¯ãƒªã‚¢ï¼‰
                if (closingDayField) {
                    if (closingDay && closingDay !== '' && closingDay !== 'null' && closingDay !== 'None') {
                        closingDayField.value = closingDay;
                    } else {
                        closingDayField.value = '';
                    }
                }

                // æ”¯æ‰•ã„æ—¥ï¼ˆå€¤ãŒã‚ã‚‹å ´åˆã®ã¿è¨­å®šã€ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¯ãƒªã‚¢ï¼‰
                if (paymentDayField) {
                    if (paymentDay && paymentDay !== '' && paymentDay !== 'null' && paymentDay !== 'None') {
                        paymentDayField.value = paymentDay;
                    } else {
                        paymentDayField.value = '';
                    }
                }

                console.log('âœ… æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã—ãŸ:', {
                    paymentCycle: paymentCycle || '(æœªè¨­å®š)',
                    closingDay: closingDay || '(æœªè¨­å®š)',
                    paymentDay: paymentDay || '(æœªè¨­å®š)'
                });
            }
        });
    }
});

// ============================================
// å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«
// ============================================

// å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã
window.openClientCompanyManagementPanel = function() {
    console.log('âœ… openClientCompanyManagementPanel called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('clientCompanyManagementModal'));
    modal.show();

    // å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    refreshClientCompanyList();

    // æ¤œç´¢æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
    setTimeout(function() {
        const searchInput = $('#clientCompanySearchInput');
        if (searchInput.length) {
            searchInput.off('input').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterClientCompanyList(searchTerm);
            });
        }
    }, 100);
};

// å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°
window.refreshClientCompanyList = function() {
    console.log('âœ… refreshClientCompanyList called');

    const tbody = $('#clientCompanyTableBody');
    tbody.html('<tr><td colspan="10" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>èª­ã¿è¾¼ã¿ä¸­...</td></tr>');

    // AJAXã§æœ€æ–°ã®å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’å–å¾—
    $.ajax({
        url: '{% url "order_management:client_company_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (!response.success || !response.companies) {
                tbody.html('<tr><td colspan="10" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>');
                return;
            }

            const allClientCompanies = response.companies;

    // ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’ç¢ºèª
    console.log('ğŸ“‹ å…ƒè«‹ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿:', allClientCompanies);
    if (allClientCompanies && allClientCompanies.length > 0) {
        console.log('ğŸ“‹ æœ€åˆã®å…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿è©³ç´°:', allClientCompanies[0]);
    }

    if (!allClientCompanies || allClientCompanies.length === 0) {
        tbody.html('<tr><td colspan="10" class="text-center text-muted">å…ƒè«‹ä¼šç¤¾ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>');
        return;
    }

    let html = '';
    allClientCompanies.forEach(function(company) {
        const statusBadge = company.is_active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        const paymentCycleText = company.payment_cycle_label || '-';

        // ç· ã‚æ—¥: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ0ã¯ç„¡åŠ¹ãªå€¤ãªã®ã§é™¤å¤–ï¼‰
        const closingDayText = (company.closing_day !== null && company.closing_day !== undefined)
            ? `${company.closing_day}æ—¥` : '-';

        // æ”¯æ‰•æœˆ: payment_offset_monthsã®å€¤ã‚’è¡¨ç¤º
        const paymentOffsetMonthsText = company.payment_offset_months_label || '-';

        // æ”¯æ‰•ã„æ—¥: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ0ã¯ç„¡åŠ¹ãªå€¤ãªã®ã§é™¤å¤–ï¼‰
        const paymentDayText = (company.payment_day !== null && company.payment_day !== undefined)
            ? `${company.payment_day}æ—¥` : '-';

        // ãƒ‡ãƒãƒƒã‚°: å„ä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        console.log(`  - ${company.company_name}: ç· ã‚æ—¥=${company.closing_day}, æ”¯æ‰•æœˆ=${company.payment_offset_months}, æ”¯æ‰•ã„æ—¥=${company.payment_day}`);

        html += `
            <tr style="cursor: pointer;" onclick="selectClientCompany(${company.id})" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                <td><strong>${escapeHtml(company.company_name)}</strong></td>
                <td>${escapeHtml(company.address || '-')}</td>
                <td>${escapeHtml(company.phone || '-')}</td>
                <td>${escapeHtml(company.contact_person || '-')}</td>
                <td class="text-center">${paymentCycleText}</td>
                <td class="text-center">${closingDayText}</td>
                <td class="text-center">${paymentOffsetMonthsText}</td>
                <td class="text-center">${paymentDayText}</td>
                <td class="text-center">${statusBadge}</td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-outline-primary" onclick="editClientCompany(${company.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.html(html);
        },
        error: function(xhr, status, error) {
            console.error('âŒ å…ƒè«‹ä¼šç¤¾ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            tbody.html('<tr><td colspan="10" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error + '</td></tr>');
        }
    });
};

// å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
window.selectClientCompany = function(companyId) {
    console.log('âœ… selectClientCompany called', companyId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const modal = bootstrap.Modal.getInstance(document.getElementById('clientCompanyManagementModal'));
    if (modal) modal.hide();

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠ
    $('#clientCompanySelect').val(companyId);

    // allClientCompaniesé…åˆ—ã‹ã‚‰é¸æŠã•ã‚ŒãŸä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const allClientCompanies = {{ client_companies_json|safe }};
    const selectedCompany = allClientCompanies.find(c => c.id === companyId);

    if (selectedCompany) {
        console.log('âœ… é¸æŠã•ã‚ŒãŸå…ƒè«‹ä¼šç¤¾:', selectedCompany);

        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’ç›´æ¥è¨­å®š
        const paymentCycleField = document.getElementById('{{ form.payment_cycle.id_for_label }}');
        const closingDayField = document.getElementById('{{ form.closing_day.id_for_label }}');
        const paymentDayField = document.getElementById('{{ form.payment_day.id_for_label }}');

        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«
        if (paymentCycleField) {
            paymentCycleField.value = selectedCompany.payment_cycle || '';
            console.log('  - æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«:', selectedCompany.payment_cycle || '(æœªè¨­å®š)');
        }

        // ç· ã‚æ—¥
        if (closingDayField) {
            if (selectedCompany.closing_day !== null && selectedCompany.closing_day !== undefined && selectedCompany.closing_day !== '') {
                closingDayField.value = selectedCompany.closing_day;
                console.log('  - ç· ã‚æ—¥:', selectedCompany.closing_day + 'æ—¥');
            } else {
                closingDayField.value = '';
                console.log('  - ç· ã‚æ—¥: (æœªè¨­å®š)');
            }
        }

        // æ”¯æ‰•ã„æ—¥
        if (paymentDayField) {
            if (selectedCompany.payment_day !== null && selectedCompany.payment_day !== undefined && selectedCompany.payment_day !== '') {
                paymentDayField.value = selectedCompany.payment_day;
                console.log('  - æ”¯æ‰•ã„æ—¥:', selectedCompany.payment_day + 'æ—¥');
            } else {
                paymentDayField.value = '';
                console.log('  - æ”¯æ‰•ã„æ—¥: (æœªè¨­å®š)');
            }
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (typeof toastr !== 'undefined') {
            toastr.success(`ã€Œ${selectedCompany.company_name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
        }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã®å…ˆé ­ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('html, body').animate({
        scrollTop: $('#clientCompanySelect').offset().top - 100
    }, 500);
};

// å…ƒè«‹ä¼šç¤¾ç·¨é›†ï¼ˆåˆ¥ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼‰
window.editClientCompany = function(companyId) {
    window.open(`/orders/client-companies/${companyId}/edit/`, '_blank');
};

// å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
window.filterClientCompanyList = function(searchTerm) {
    console.log('ğŸ” Filtering client companies:', searchTerm);

    const rows = $('#clientCompanyTableBody tr');

    if (!searchTerm || searchTerm.trim() === '') {
        rows.show();
        return;
    }

    rows.each(function() {
        const row = $(this);
        const companyName = row.find('td:first strong').text().toLowerCase();
        const address = row.find('td:nth-child(2)').text().toLowerCase();
        const phone = row.find('td:nth-child(3)').text().toLowerCase();

        if (companyName.includes(searchTerm) ||
            address.includes(searchTerm) ||
            phone.includes(searchTerm)) {
            row.show();
        } else {
            row.hide();
        }
    });

    // æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const visibleRows = rows.filter(':visible').length;
    if (visibleRows === 0) {
        const tbody = $('#clientCompanyTableBody');
        if (tbody.find('.no-results-row').length === 0) {
            tbody.append('<tr class="no-results-row"><td colspan="10" class="text-center text-muted py-4"><i class="fas fa-search me-2"></i>ã€Œ' + escapeHtml(searchTerm) + 'ã€ã«ä¸€è‡´ã™ã‚‹å…ƒè«‹ä¼šç¤¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>');
        }
    } else {
        $('#clientCompanyTableBody .no-results-row').remove();
    }
};

// æ–°è¦å…ƒè«‹ä¼šç¤¾è¿½åŠ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§ä½œæˆï¼‰
window.addNewClientCompany = function() {
    openClientCompanyCreateModal();
};

// éµå—ã‘æ¸¡ã—è¨­å®šã®æŠ˜ã‚ŠãŸãŸã¿åˆ‡ã‚Šæ›¿ãˆ
window.toggleKeyHandoverSection = function() {
    const section = document.getElementById('keyHandoverSection');
    const toggleBtn = document.getElementById('keyHandoverToggleBtn');
    const toggleIcon = document.getElementById('keyHandoverToggleIcon');

    if (section.style.display === 'none') {
        // å±•é–‹
        section.style.display = 'block';
        toggleIcon.classList.remove('fa-plus');
        toggleIcon.classList.add('fa-minus');
        toggleBtn.innerHTML = '<i class="fas fa-minus me-1" id="keyHandoverToggleIcon"></i><i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’é–‰ã˜ã‚‹';
    } else {
        // æŠ˜ã‚ŠãŸãŸã¿
        section.style.display = 'none';
        toggleIcon.classList.remove('fa-minus');
        toggleIcon.classList.add('fa-plus');
        toggleBtn.innerHTML = '<i class="fas fa-plus me-1" id="keyHandoverToggleIcon"></i><i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’è¿½åŠ ';
    }
};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼šéµå—ã‘æ¸¡ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•å±•é–‹
document.addEventListener('DOMContentLoaded', function() {
    const keyLocation = document.getElementById('{{ form.key_handover_location.id_for_label }}');
    const keyDate = document.getElementById('{{ form.key_handover_date.id_for_label }}');
    const keyNotes = document.getElementById('{{ form.key_handover_notes.id_for_label }}');

    // ã„ãšã‚Œã‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•å±•é–‹
    if ((keyLocation && keyLocation.value) ||
        (keyDate && keyDate.value) ||
        (keyNotes && keyNotes.value)) {
        toggleKeyHandoverSection();
    }
});

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>

<!-- å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="clientCompanyManagementModal" tabindex="-1" aria-labelledby="clientCompanyManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientCompanyManagementModalLabel">
                    <i class="fas fa-building"></i> å…ƒè«‹ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">ç™»éŒ²å…ƒè«‹ä¼šç¤¾ä¸€è¦§</h6>
                    <div class="d-flex gap-2">
                        <input type="text" id="clientCompanySearchInput" class="form-control form-control-sm" placeholder="å…ƒè«‹ä¼šç¤¾åã§æ¤œç´¢..." style="width: 250px;">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewClientCompany()">
                            <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- å…ƒè«‹ä¼šç¤¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>ä¼šç¤¾å</th>
                                <th>ä½æ‰€</th>
                                <th>é›»è©±ç•ªå·</th>
                                <th>æ‹…å½“è€…</th>
                                <th class="text-center">æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«</th>
                                <th class="text-center">ç· ã‚æ—¥</th>
                                <th class="text-center">æ”¯æ‰•æœˆ</th>
                                <th class="text-center">æ”¯æ‰•ã„æ—¥</th>
                                <th class="text-center">çŠ¶æ…‹</th>
                                <th style="width: 140px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="clientCompanyTableBody">
                            <tr>
                                <td colspan="10" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- å·¥äº‹ç¨®åˆ¥ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="workTypeManagementModal" tabindex="-1" aria-labelledby="workTypeManagementModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <h5 class="modal-title" id="workTypeManagementModalLabel">
                    <i class="fas fa-tools me-2"></i>å·¥äº‹ç¨®åˆ¥ç®¡ç†
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- æ—¢å­˜ã®å·¥äº‹ç¨®åˆ¥ä¸€è¦§ -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-list me-2"></i>ç™»éŒ²æ¸ˆã¿å·¥äº‹ç¨®åˆ¥
                    </h6>
                    <div id="workTypeList" class="mb-3">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin me-2"></i>èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>

                <!-- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="border-top pt-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-plus-circle me-2"></i>æ–°ã—ã„å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ 
                    </h6>
                    <form id="workTypeForm">
                        {% csrf_token %}
                        <input type="hidden" id="workTypeId" name="id" value="">

                        <div class="mb-3">
                            <label for="workTypeName" class="form-label">
                                ç¨®åˆ¥å <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="workTypeName" name="name" required maxlength="100">
                        </div>

                        <div class="mb-3">
                            <label for="workTypeDescription" class="form-label">èª¬æ˜</label>
                            <textarea class="form-control" id="workTypeDescription" name="description" rows="2"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success" id="workTypeSubmitBtn">
                                <i class="fas fa-save me-2"></i>ä¿å­˜ã™ã‚‹
                            </button>
                            <button type="button" class="btn btn-secondary" id="workTypeCancelBtn" style="display: none;" onclick="cancelWorkTypeEdit()">
                                <i class="fas fa-times me-2"></i>ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </form>

                    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="workTypeError" class="alert alert-danger mt-3" style="display: none;"></div>
                    <div id="workTypeSuccess" class="alert alert-success mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å·¥äº‹ç¨®åˆ¥å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="workTypeDeleteConfirmModal" tabindex="-1" aria-hidden="true" style="z-index: 10050 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>å‰Šé™¤ã®ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">å·¥äº‹ç¨®åˆ¥ã€Œ<strong id="deleteWorkTypeName"></strong>ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-info-circle me-2"></i>æ¡ˆä»¶ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteWorkTypeBtn">
                    <i class="fas fa-trash me-2"></i>å‰Šé™¤ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å…ƒè«‹ä¼šç¤¾æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="clientCompanyCreateModal" tabindex="-1" aria-labelledby="clientCompanyCreateModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="clientCompanyCreateModalLabel">
                    <i class="fas fa-building me-2"></i>å…ƒè«‹ä¼šç¤¾æ–°è¦ç™»éŒ²
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="clientCompanyCreateForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- å…ƒè«‹æ¥­è€…ã¨ã¯ï¼ˆèª¬æ˜ï¼‰ -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-info-circle me-2"></i>å…ƒè«‹æ¥­è€…ã¨ã¯</h6>
                        <p class="mb-2">
                            ã“ã®ç”»é¢ã§ã¯<strong>æ¡ˆä»¶ã‚’ãã‚Œã‚‹ä¼šç¤¾ï¼ˆå…ƒè«‹æ¥­è€…ï¼‰</strong>ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
                        </p>
                        <ul class="mb-0" style="font-size: 0.9rem;">
                            <li>å…ƒè«‹æ¥­è€…: æ¡ˆä»¶ã‚’ç™ºæ³¨ã—ã¦ãã‚Œã‚‹ä¼šç¤¾</li>
                            <li>è·äººãƒ»ä¸‹è«‹ã‘æ¥­è€…: æ¡ˆä»¶ä½œæˆæ™‚ã®ã€Œä½œæ¥­è€…è¿½åŠ ã€ã¾ãŸã¯ã€Œæ¥­è€…ç®¡ç†ã€ç”»é¢ã§ç™»éŒ²ã—ã¦ãã ã•ã„</li>
                        </ul>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-info-circle me-2"></i>åŸºæœ¬æƒ…å ±
                        </h6>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="newCompanyName" class="form-label" style="font-weight: 500;">
                                ä¼šç¤¾å <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="newCompanyName" name="company_name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="newContactPerson" class="form-label" style="font-weight: 500;">
                                æ‹…å½“è€…å
                            </label>
                            <input type="text" class="form-control" id="newContactPerson" name="contact_person">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="newEmail" class="form-label" style="font-weight: 500;">
                                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                            </label>
                            <input type="email" class="form-control" id="newEmail" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newPhone" class="form-label" style="font-weight: 500;">
                                é›»è©±ç•ªå·
                            </label>
                            <input type="tel" class="form-control" id="newPhone" name="phone">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="newAddress" class="form-label" style="font-weight: 500;">
                            ä½æ‰€
                        </label>
                        <textarea class="form-control" id="newAddress" name="address" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="newWebsite" class="form-label" style="font-weight: 500;">
                            ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
                        </label>
                        <input type="url" class="form-control" id="newWebsite" name="website">
                        <small class="text-muted">ä¼šç¤¾ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURLï¼ˆä¾‹ï¼šhttps://example.comï¼‰</small>
                    </div>

                    <!-- æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«è¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-money-bill-wave me-2"></i>æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«è¨­å®š
                        </h6>
                    </div>

                    <div class="alert alert-secondary mb-3">
                        <small>ã“ã“ã§è¨­å®šã—ãŸæ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ã¯ã€æ¡ˆä»¶ç™»éŒ²æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚æ¡ˆä»¶ã”ã¨ã«å€‹åˆ¥ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</small>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="newPaymentCycle" class="form-label" style="font-weight: 500;">
                                æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«
                            </label>
                            <select class="form-select" id="newPaymentCycle" name="payment_cycle">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="monthly">æœˆæ‰•ã„</option>
                                <option value="bimonthly">éš”æœˆæ‰•ã„</option>
                                <option value="quarterly">å››åŠæœŸæ‰•ã„</option>
                                <option value="half_yearly">åŠå¹´æ‰•ã„</option>
                                <option value="yearly">å¹´æ‰•ã„</option>
                                <option value="other">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="newClosingDay" class="form-label" style="font-weight: 500;">
                                ç· ã‚æ—¥
                            </label>
                            <input type="number" class="form-control" id="newClosingDay" name="closing_day" min="1" max="31">
                            <small class="text-muted">æœˆæœ«ç· ã‚ã®å ´åˆã¯31ã€20æ—¥ç· ã‚ã®å ´åˆã¯20</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="newPaymentDay" class="form-label" style="font-weight: 500;">
                                æ”¯æ‰•æ—¥
                            </label>
                            <input type="number" class="form-control" id="newPaymentDay" name="payment_day" min="1" max="31">
                            <small class="text-muted">æ¯æœˆã®æ”¯æ‰•æ—¥ï¼ˆ1-31ï¼‰ã€‚ä¾‹ï¼š25æ—¥æ‰•ã„ã®å ´åˆã¯25</small>
                        </div>
                    </div>

                    <!-- éµå—ã‘æ¸¡ã—è¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-key me-2"></i>éµå—ã‘æ¸¡ã—è¨­å®š
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newDefaultKeyHandoverLocation" class="form-label" style="font-weight: 500;">
                            ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå—ã‘æ¸¡ã—å ´æ‰€
                        </label>
                        <input type="text" class="form-control" id="newDefaultKeyHandoverLocation" name="default_key_handover_location">
                        <small class="text-muted">æ¡ˆä»¶ç™»éŒ²æ™‚ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆæ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ï¼‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="newKeyHandoverNotes" class="form-label" style="font-weight: 500;">
                            ç‰¹è¨˜äº‹é …
                        </label>
                        <textarea class="form-control" id="newKeyHandoverNotes" name="key_handover_notes" rows="2"></textarea>
                    </div>

                    <!-- å®Œäº†å ±å‘Šè¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-file-alt me-2"></i>å®Œäº†å ±å‘Šè¨­å®š
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newCompletionReportTemplate" class="form-label" style="font-weight: 500;">
                            å®Œäº†å ±å‘Šã‚·ãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                        </label>
                        <input type="file" class="form-control" id="newCompletionReportTemplate" name="completion_report_template" accept=".xlsx,.xls,.pdf,.doc,.docx">
                        <small class="text-muted">Excel/PDFå½¢å¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="newCompletionReportNotes" class="form-label" style="font-weight: 500;">
                            å®Œäº†å ±å‘Šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹
                        </label>
                        <textarea class="form-control" id="newCompletionReportNotes" name="completion_report_notes" rows="3"></textarea>
                        <small class="text-muted">æ¡ˆä»¶ç™»éŒ²æ™‚ã«å®Œäº†å ±å‘Šå†…å®¹ã¨ã—ã¦è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆæ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ï¼‰</small>
                    </div>

                    <!-- é‹ç”¨ãƒ«ãƒ¼ãƒ«ãƒ»ç‰¹è¨˜äº‹é … -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-clipboard-list me-2"></i>é‹ç”¨ãƒ«ãƒ¼ãƒ«ãƒ»ç‰¹è¨˜äº‹é …
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newSpecialNotes" class="form-label" style="font-weight: 500;">
                            ç‰¹è¨˜äº‹é …
                        </label>
                        <textarea class="form-control" id="newSpecialNotes" name="special_notes" rows="3"></textarea>
                        <small class="text-muted">ã“ã®ä¼šç¤¾ã¨ã®å–å¼•ã«ãŠã‘ã‚‹æ³¨æ„äº‹é …ã‚„é‹ç”¨ãƒ«ãƒ¼ãƒ«ã‚’è¨˜è¼‰</small>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="newIsActive" name="is_active" checked>
                        <label class="form-check-label" for="newIsActive">
                            ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                        </label>
                    </div>
                </form>

                <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="clientCompanyCreateError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-primary" id="submitClientCompanyBtn" onclick="submitNewClientCompany()">
                    <i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// å…ƒè«‹ä¼šç¤¾æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
window.openClientCompanyCreateModal = function() {
    console.log('âœ… openClientCompanyCreateModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('clientCompanyCreateForm').reset();

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#clientCompanyCreateError').hide();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('clientCompanyCreateModal'));
    modal.show();
};

// å…ƒè«‹ä¼šç¤¾ã‚’æ–°è¦ä½œæˆ
window.submitNewClientCompany = function() {
    console.log('âœ… submitNewClientCompany called');

    const form = document.getElementById('clientCompanyCreateForm');
    const formData = new FormData(form);

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#clientCompanyCreateError').hide();

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆIDçµŒç”±ã§å–å¾—ï¼‰
    const submitBtn = document.getElementById('submitClientCompanyBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...';

    $.ajax({
        url: '{% url "order_management:client_company_create_ajax" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                console.log('âœ… å…ƒè«‹ä¼šç¤¾ä½œæˆæˆåŠŸ:', response.company);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('clientCompanyCreateModal'));
                if (modal) modal.hide();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«æ–°ã—ã„å…ƒè«‹ä¼šç¤¾ã‚’è¿½åŠ 
                const select = $('#clientCompanySelect');
                const newOption = new Option(
                    response.company.company_name + (response.company.address ? ' - ' + response.company.address : ''),
                    response.company.id,
                    false,
                    true
                );
                $(newOption).attr('data-name', response.company.company_name);
                $(newOption).attr('data-address', response.company.address || '');
                $(newOption).attr('data-payment-cycle', response.company.payment_cycle || '');
                $(newOption).attr('data-closing-day', response.company.closing_day || '');
                $(newOption).attr('data-payment-day', response.company.payment_day || '');
                select.append(newOption);

                // æ–°ã—ã„å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠ
                select.val(response.company.id).trigger('change');

                // å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°ï¼ˆç®¡ç†ãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆï¼‰
                if (typeof refreshClientCompanyList === 'function') {
                    console.log('âœ… å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°ä¸­...');
                    setTimeout(function() {
                        refreshClientCompanyList();
                    }, 100);
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (typeof toastr !== 'undefined') {
                    toastr.success('å…ƒè«‹ä¼šç¤¾ã€Œ' + response.company.company_name + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
                } else {
                    alert('å…ƒè«‹ä¼šç¤¾ã€Œ' + response.company.company_name + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
                }

                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
            } else {
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorHtml = '<strong>ã‚¨ãƒ©ãƒ¼:</strong><ul class="mb-0">';
                if (response.errors) {
                    for (let field in response.errors) {
                        response.errors[field].forEach(function(error) {
                            errorHtml += '<li>' + error + '</li>';
                        });
                    }
                } else {
                    errorHtml += '<li>' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') + '</li>';
                }
                errorHtml += '</ul>';
                $('#clientCompanyCreateError').html(errorHtml).show();

                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ å…ƒè«‹ä¼šç¤¾ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            $('#clientCompanyCreateError').html('<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + (xhr.responseJSON?.error || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();

            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
        }
    });
};

// ===== å·¥äº‹ç¨®åˆ¥ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« =====
// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
window.openWorkTypeManagementModal = function() {
    console.log('âœ… openWorkTypeManagementModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('workTypeManagementModal'));
    modal.show();

    // å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    loadWorkTypeList();
};

// å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
function loadWorkTypeList() {
    $.ajax({
        url: '{% url "order_management:work_type_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                renderWorkTypeList(response.work_types);
            } else {
                $('#workTypeList').html('<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
            }
        },
        error: function() {
            $('#workTypeList').html('<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
        }
    });
}

// å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’æç”»
function renderWorkTypeList(workTypes) {
    if (workTypes.length === 0) {
        $('#workTypeList').html('<div class="text-muted text-center py-3">ç™»éŒ²æ¸ˆã¿ã®å·¥äº‹ç¨®åˆ¥ã¯ã‚ã‚Šã¾ã›ã‚“</div>');
        return;
    }

    let html = '<div class="list-group">';
    workTypes.forEach(function(workType, index) {
        const escapedName = $('<div>').text(workType.name).html();
        const escapedDesc = $('<div>').text(workType.description || '').html();

        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <i class="fas fa-tools me-2"></i>${escapedName}
                        </h6>
                        ${workType.description ? `<p class="mb-1 small text-muted">${escapedDesc}</p>` : ''}
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="moveWorkType(${workType.id}, 'up')" ${index === 0 ? 'disabled' : ''} title="ä¸Šã¸ç§»å‹•">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="moveWorkType(${workType.id}, 'down')" ${index === workTypes.length - 1 ? 'disabled' : ''} title="ä¸‹ã¸ç§»å‹•">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary"
                                data-id="${workType.id}"
                                data-name="${escapedName}"
                                data-description="${escapedDesc}"
                                onclick="editWorkTypeFromButton(this)"
                                title="ç·¨é›†">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger"
                                data-id="${workType.id}"
                                data-name="${escapedName}"
                                onclick="deleteWorkTypeFromButton(this)"
                                title="å‰Šé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';

    $('#workTypeList').html(html);
}

// ãƒœã‚¿ãƒ³ã‹ã‚‰å·¥äº‹ç¨®åˆ¥ã‚’ç·¨é›†ï¼ˆdataå±æ€§ã‚’ä½¿ç”¨ï¼‰
window.editWorkTypeFromButton = function(button) {
    const id = $(button).data('id');
    const name = $(button).data('name');
    const description = $(button).data('description');
    editWorkType(id, name, description);
};

// å·¥äº‹ç¨®åˆ¥ã‚’ç·¨é›†
window.editWorkType = function(id, name, description) {
    console.log('âœ… editWorkType called:', id, name);

    // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
    $('#workTypeId').val(id);
    $('#workTypeName').val(name);
    $('#workTypeDescription').val(description);

    // ãƒœã‚¿ãƒ³ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
    $('#workTypeSubmitBtn').html('<i class="fas fa-save me-2"></i>æ›´æ–°ã™ã‚‹');
    $('#workTypeCancelBtn').show();

    // ãƒ•ã‚©ãƒ¼ãƒ ä½ç½®ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('#workTypeForm')[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
};

// ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
window.cancelWorkTypeEdit = function() {
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#workTypeForm')[0].reset();
    $('#workTypeId').val('');

    // ãƒœã‚¿ãƒ³ã‚’æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«
    $('#workTypeSubmitBtn').html('<i class="fas fa-save me-2"></i>ä¿å­˜ã™ã‚‹');
    $('#workTypeCancelBtn').hide();

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#workTypeError').hide();
    $('#workTypeSuccess').hide();
};

// ãƒœã‚¿ãƒ³ã‹ã‚‰å·¥äº‹ç¨®åˆ¥ã‚’å‰Šé™¤ï¼ˆdataå±æ€§ã‚’ä½¿ç”¨ï¼‰
window.deleteWorkTypeFromButton = function(button) {
    const id = $(button).data('id');
    const name = $(button).data('name');
    deleteWorkType(id, name);
};

// å·¥äº‹ç¨®åˆ¥ã‚’å‰Šé™¤
window.deleteWorkType = function(id, name) {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
    $('#deleteWorkTypeName').text(name);

    // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('workTypeDeleteConfirmModal'));
    modal.show();

    // backdropã®z-indexã‚’èª¿æ•´ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(function() {
        $('.modal-backdrop').last().css('z-index', 10049);
    }, 10);

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ ï¼‰
    $('#confirmDeleteWorkTypeBtn').off('click').on('click', function() {
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>å‰Šé™¤ä¸­...');

        $.ajax({
            url: '{% url "order_management:work_type_delete_ajax" %}',
            type: 'POST',
            data: {
                id: id,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    modal.hide();

                    $('#workTypeSuccess').html('<i class="fas fa-check-circle me-2"></i>' + response.message).show();
                    setTimeout(function() { $('#workTypeSuccess').hide(); }, 3000);

                    // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    loadWorkTypeList();

                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                    refreshWorkTypeDropdown();
                } else {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    modal.hide();

                    $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
                }
            },
            error: function(xhr) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                modal.hide();

                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
            },
            complete: function() {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                $('#confirmDeleteWorkTypeBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>å‰Šé™¤ã™ã‚‹');
            }
        });
    });
};

// å·¥äº‹ç¨®åˆ¥ã‚’ä¸¦ã³æ›¿ãˆ
window.moveWorkType = function(id, direction) {
    $.ajax({
        url: '{% url "order_management:work_type_reorder_ajax" %}',
        type: 'POST',
        data: {
            id: id,
            direction: direction,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                loadWorkTypeList();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                refreshWorkTypeDropdown();
            } else {
                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
            }
        },
        error: function(xhr) {
            $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
        }
    });
};

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
$('#workTypeForm').on('submit', function(e) {
    e.preventDefault();

    const workTypeId = $('#workTypeId').val();
    const isUpdate = workTypeId !== '';
    const url = isUpdate
        ? '{% url "order_management:work_type_update_ajax" %}'
        : '{% url "order_management:work_type_create_ajax" %}';

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#workTypeError').hide();
    $('#workTypeSuccess').hide();

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const submitBtn = $('#workTypeSubmitBtn');
    submitBtn.prop('disabled', true);
    submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...');

    // ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    const formData = {
        name: $('#workTypeName').val(),
        description: $('#workTypeDescription').val(),
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    };

    if (isUpdate) {
        formData.id = workTypeId;
    }

    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        success: function(response) {
            if (response.success) {
                const message = isUpdate ? 'å·¥äº‹ç¨®åˆ¥ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ ã—ã¾ã—ãŸ';
                $('#workTypeSuccess').html('<i class="fas fa-check-circle me-2"></i>' + message).show();
                setTimeout(function() { $('#workTypeSuccess').hide(); }, 3000);

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                cancelWorkTypeEdit();

                // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                loadWorkTypeList();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                refreshWorkTypeDropdown(response.work_type.id);
            } else {
                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
            }
        },
        error: function(xhr) {
            $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
        },
        complete: function() {
            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            submitBtn.prop('disabled', false);
            const buttonText = isUpdate ? 'æ›´æ–°ã™ã‚‹' : 'ä¿å­˜ã™ã‚‹';
            submitBtn.html('<i class="fas fa-save me-2"></i>' + buttonText);
        }
    });
});

// å·¥äº‹ç¨®åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
function refreshWorkTypeDropdown(selectedId) {
    $.ajax({
        url: '{% url "order_management:work_type_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const select = $('[name="work_type"]');
                const currentValue = selectedId || select.val();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†æ§‹ç¯‰
                select.empty();
                select.append('<option value="">-- å·¥äº‹ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>');

                // å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ ï¼ˆè¡¨ç¤ºé †ã§æ—¢ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ï¼‰
                response.work_types.forEach(function(workType) {
                    const option = new Option(workType.name, workType.name);
                    select.append(option);
                });

                // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
                if (currentValue) {
                    select.val(currentValue);
                }
            }
        }
    });
}

// å…ƒè«‹ä¼šç¤¾é¸æŠæ™‚ã«æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
$('#clientCompanySelect').on('change', function() {
    const selectedOption = $(this).find('option:selected');

    if (selectedOption.val()) {
        // dataå±æ€§ã‹ã‚‰å€¤ã‚’å–å¾—
        const paymentCycle = selectedOption.data('payment-cycle') || '';
        const closingDay = selectedOption.data('closing-day') || '';
        const paymentOffsetMonths = selectedOption.data('payment-offset-months');
        const paymentDay = selectedOption.data('payment-day') || '';

        // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
        $('[name="payment_cycle"]').val(paymentCycle);
        $('[name="closing_day"]').val(closingDay);
        $('[name="payment_offset_months"]').val(paymentOffsetMonths !== undefined && paymentOffsetMonths !== '' ? paymentOffsetMonths : '');
        $('[name="payment_day"]').val(paymentDay);

        // å…ƒè«‹åã¨ä½æ‰€ã‚‚è‡ªå‹•å…¥åŠ›
        const companyName = selectedOption.data('name') || '';
        const companyAddress = selectedOption.data('address') || '';
        $('[name="client_name"]').val(companyName);
        $('[name="client_address"]').val(companyAddress);

        console.log('âœ… å…ƒè«‹ä¼šç¤¾ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ');
    } else {
        // é¸æŠã‚’è§£é™¤ã—ãŸå ´åˆã¯ã‚¯ãƒªã‚¢
        $('[name="payment_cycle"]').val('');
        $('[name="closing_day"]').val('');
        $('[name="payment_offset_months"]').val('');
        $('[name="payment_day"]').val('');
        $('[name="client_name"]').val('');
        $('[name="client_address"]').val('');
    }
});
</script>

{% endblock %}
