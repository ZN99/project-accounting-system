{% extends "order_management/base.html" %}
{% load humanize %}
{# CACHE_CLEAR_20251129_002531 #}
{% block title %}{{ title }} - å»ºç¯‰æ´¾é£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />
<style>
    .form-section {
        border-radius: 12px;
        border: 1px solid #e3e6f0;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .form-section:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    .section-header {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
        margin: 0;
        border-bottom: 1px solid #e3e6f0;
    }
    .section-header h5 {
        margin: 0;
        font-weight: 600;
    }
    .form-label {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
    }
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #d1d3e2;
        transition: all 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    .btn-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(78, 115, 223, 0.4);
    }
    .btn-secondary {
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
    }
    .revenue-preview {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid #dee2e6;
    }
    .revenue-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    .revenue-item:last-child {
        border-bottom: none;
        font-weight: 600;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®z-indexèª¿æ•´ */
    #staffManagementModal {
        z-index: 9999 !important;
    }
    #staffManagementModal .modal-backdrop {
        z-index: 9998 !important;
    }
    #salesStaffManagementModal {
        z-index: 9999 !important;
    }
    /* æ–°è¦å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¦ªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸Šã«è¡¨ç¤ºï¼‰ */
    #addSalesStaffModal {
        z-index: 10050 !important;
    }
    #addSalesStaffModal + .modal-backdrop {
        z-index: 10040 !important;
    }
    #craftsmanManagementModal {
        z-index: 9999 !important;
    }
    #contractorManagementModal {
        z-index: 2050 !important;
    }
    #contractorManagementModal .modal-backdrop {
        z-index: 2049 !important;
    }

    /* èƒŒæ™¯ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ */
    body.modal-open {
        overflow: hidden !important;
        position: fixed !important;
        width: 100% !important;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ */
    #contractorManagementModal .modal-body {
        max-height: 70vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã®70% */
        overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ */
        padding: 1rem;
        -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    }

    #contractorManagementModal .modal-dialog {
        max-height: 90vh; /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ã®æœ€å¤§é«˜ã• */
        display: flex;
        flex-direction: column;
    }

    /* å…¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ã‚’çµ±ä¸€ */
    .modal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    #contractorManagementModal .modal-content {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    #contractorModal {
        z-index: 2060 !important;
    }
    #contractorModal .modal-backdrop {
        z-index: 2059 !important;
    }
    #addImplementationModal {
        z-index: 1055 !important;
    }
    .modal-backdrop.show {
        z-index: 1054 !important;
    }

    /* èƒŒæ™¯ã®é‡è¤‡ã‚’é˜²ã */
    .modal.show {
        background-color: rgba(0,0,0,0.5) !important;
    }

    /* æ¥­è€…ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .contractor-table-wrapper {
        position: relative;
        overflow: hidden;
    }

    .contractor-table-scroll {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 50vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã®50%ã«èª¿æ•´ */
        margin-right: 160px; /* å›ºå®šåˆ—ã®å¹…åˆ†ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¢ºä¿ */
    }

    .contractor-table-fixed {
        position: absolute;
        top: 0;
        right: 0;
        width: 160px;
        max-height: 50vh; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸã¨åŒã˜é«˜ã• */
        overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
        background: white;
        border-left: 2px solid #dee2e6;
        z-index: 10;
    }

    .contractor-table-scroll table,
    .contractor-table-fixed table {
        margin-bottom: 0;
        table-layout: fixed !important;
        width: 100% !important;
    }

    .contractor-table-fixed th,
    .contractor-table-fixed td {
        text-align: center;
        white-space: nowrap;
        height: 60px !important;
        vertical-align: middle !important;
        padding: 8px 8px !important;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®é«˜ã•ã‚‚çµ±ä¸€ */
    .contractor-table thead th {
        height: 50px !important;
        vertical-align: middle !important;
        padding: 8px 8px !important;
    }

    /* æ¥­è€…åˆ†é¡ã«ã‚ˆã‚‹è¡Œã®è‰²åˆ†ã‘ */
    .contractor-table tbody tr.bg-success.bg-opacity-10 {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }
    .contractor-table tbody tr.bg-warning.bg-opacity-10 {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }
    .contractor-table tbody tr.bg-success.bg-opacity-10:hover {
        background-color: rgba(25, 135, 84, 0.2) !important;
    }
    .contractor-table tbody tr.bg-warning.bg-opacity-10:hover {
        background-color: rgba(255, 193, 7, 0.2) !important;
    }
        padding: 8px 4px;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®é«˜ã•ã‚’çµ±ä¸€ - ã‚ˆã‚Šå¼·åˆ¶çš„ã«é©ç”¨ */
    .contractor-table tbody tr {
        height: 60px !important;
        min-height: 60px !important;
        max-height: 60px !important;
    }

    .contractor-table tbody td {
        vertical-align: middle !important;
        white-space: nowrap;
        height: 60px !important;
        line-height: 1.2 !important;
        padding: 8px 8px !important;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .contractor-table .badge {
        font-size: 0.7em;
        margin-right: 2px;
        margin-bottom: 2px;
        display: inline-block;
    }

    /* æ“ä½œãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ */
    .contractor-table .btn {
        height: 32px !important;
        min-height: 32px !important;
        padding: 4px 8px !important;
        font-size: 0.75em !important;
        line-height: 1.2 !important;
        margin: 2px !important;
        display: inline-block !important;
        vertical-align: middle !important;
    }

    /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .contractor-table tbody tr.clickable-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .contractor-table tbody tr.clickable-row:hover {
        background-color: #e3f2fd !important;
    }

    .contractor-table tbody tr.clickable-row.active {
        background-color: #f0f8ff !important;
        border-left: 3px solid #007bff;
    }

    .contractor-table tbody tr.inactive-row {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .contractor-table tbody tr.inactive-row:hover {
        background-color: #f8f9fa !important;
    }

    /* ã‚¿ãƒ–UIã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #projectFormTabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 1rem 1.5rem;
        transition: all 0.3s ease;
    }

    #projectFormTabs .nav-link:hover {
        color: #0d6efd;
        background: #f8f9fa;
        border-bottom-color: #dee2e6;
    }

    #projectFormTabs .nav-link.active {
        color: #0d6efd;
        background: white;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }

    /* è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-group .btn-light.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .btn-group .btn-light {
        transition: all 0.3s ease;
    }

    .btn-group .btn-light:hover:not(.active) {
        background-color: #e9ecef;
    }

    /* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #projectFormTabsContent .tab-pane {
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ– */
    }

    #projectFormTabsContent.full-view-mode .tab-pane {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    #projectFormTabsContent.full-view-mode .tab-pane:last-child {
        margin-bottom: 0;
    }

    #projectFormTabsContent.full-view-mode .tab-pane::before {
        content: attr(data-section-title);
        display: block;
        font-size: 1.25rem;
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #0d6efd;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>

<!-- Toastr CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="fas fa-edit me-2"></i>{{ title }}</h3>
                <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-light active" id="tabViewBtn" onclick="switchFormViewMode('tab')">
                        <i class="fas fa-th-large me-1"></i>ã‚¿ãƒ–è¡¨ç¤º
                    </button>
                    <button type="button" class="btn btn-light" id="fullViewBtn" onclick="switchFormViewMode('full')">
                        <i class="fas fa-list me-1"></i>å…¨ä½“è¡¨ç¤º
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <form method="post" id="projectForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <ul class="nav nav-tabs" id="projectFormTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>åŸºæœ¬æƒ…å ±
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-1"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="order-tab" data-bs-toggle="tab" data-bs-target="#order" type="button" role="tab">
                                <i class="fas fa-file-invoice-dollar me-1"></i>è«‹æ±‚
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="staff-tab" data-bs-toggle="tab" data-bs-target="#staff" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>æ¥­è€…ãƒ»æ‹…å½“
                            </button>
                        </li>
                    </ul>

                    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                    <div class="tab-content p-4" id="projectFormTabsContent">
                        <!-- Hidden field for project ID (used by subcontract modal) -->
                        <input type="hidden" name="project_id" value="{% if project %}{{ project.pk }}{% endif %}">

                        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
                        <div class="tab-pane show active" id="basic" role="tabpanel" data-section-title="ğŸ“‹ åŸºæœ¬æƒ…å ±">
                            <div class="form-section mb-4">

                            <!-- åŸºæœ¬æƒ…å ±ã¨å—æ³¨é‡‘é¡æƒ…å ±ã‚’æ¨ªä¸¦ã³ -->
                            <div class="row">
                                <div class="col-md-6">
                            <!-- åŸºæœ¬æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>åŸºæœ¬æƒ…å ±</h6>
                                </div>
                                <div class="card-body">
                                    <!-- å…ƒè«‹åã¨æ¡ˆä»¶æ‹…å½“è€…ã‚’æœ€å„ªå…ˆ -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">å…ƒè«‹å <span class="text-danger">*</span></label>
                                            <div class="d-flex gap-2">
                                                <select name="client_company" class="form-select" id="clientCompanySelect">
                                                    <option value="">-- å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                                    {% for company in client_companies %}
                                                    <option value="{{ company.id }}"
                                                            {% if project.client_company_id == company.id %}selected{% endif %}
                                                            data-name="{{ company.company_name }}"
                                                            data-address="{{ company.address }}"
                                                            data-payment-cycle="{{ company.payment_cycle }}"
                                                            data-closing-day="{% if company.closing_day is not None %}{{ company.closing_day }}{% endif %}"
                                                            data-payment-offset-months="{% if company.payment_offset_months is not None %}{{ company.payment_offset_months }}{% endif %}"
                                                            data-payment-day="{% if company.payment_day is not None %}{{ company.payment_day }}{% endif %}">
                                                        {{ company.company_name }}{% if company.address %} - {{ company.address }}{% endif %}
                                                    </option>
                                                    {% endfor %}
                                                </select>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openClientCompanyManagementPanel()" title="å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠãƒ»ç®¡ç†">
                                                    <i class="fas fa-building"></i> å…ƒè«‹ç®¡ç†
                                                </button>
                                            </div>
                                            <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šsurvey_status -->
                                            <input type="hidden" name="survey_status" value="{{ project.survey_status|default:'not_required' }}">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">æ¡ˆä»¶æ‹…å½“è€…ï¼ˆå–¶æ¥­ï¼‰ <span class="text-danger">*</span></label>
                                            <div class="d-flex gap-2">
                                                <select name="sales_manager" class="form-select" id="salesManagerSelect">
                                                    <option value="">-- å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                                    {% for worker in internal_workers %}
                                                    {% if worker.department == 'sales' or worker.department == 'marketing' %}
                                                    <option value="{{ worker.id }}"
                                                            {% if project and worker.name == project.project_manager %}selected{% endif %}
                                                            data-name="{{ worker.name }}"
                                                            data-department="{{ worker.get_department_display }}">
                                                        {{ worker.name }} ({{ worker.get_department_display }})
                                                    </option>
                                                    {% endif %}
                                                    {% endfor %}
                                                </select>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openSalesStaffManagementPanel()">
                                                    <i class="fas fa-chart-line"></i> å–¶æ¥­ç®¡ç†
                                                </button>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ç¾å ´åãƒ»ç¨®åˆ¥ãƒ»ä½æ‰€ -->
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.site_name.id_for_label }}" class="form-label">
                                                ç¾å ´å <span class="text-danger">*</span>
                                            </label>
                                            {{ form.site_name }}
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.work_type.id_for_label }}" class="form-label">
                                                ç¨®åˆ¥ <span class="text-danger">*</span>
                                            </label>
                                            <div class="d-flex gap-2">
                                                {{ form.work_type }}
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openWorkTypeManagementModal()" title="å·¥äº‹ç¨®åˆ¥ã‚’ç®¡ç†">
                                                    <i class="fas fa-tools"></i> ç¨®åˆ¥ç®¡ç†
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">
                                                æå·¥/æ‰‹é–“
                                                <i class="fas fa-info-circle text-muted ms-1"
                                                   data-bs-toggle="tooltip"
                                                   data-bs-placement="top"
                                                   title="æå·¥=è³‡æã®ç™ºæ³¨ã‚‚è‡ªç¤¾ã§è¡Œã†ã€æ‰‹é–“=ææ–™ã¯å…ƒè«‹ã‹ã‚‰æ”¯çµ¦ã•ã‚ŒåŠ´åƒåŠ›ã®ã¿æä¾›"></i>
                                            </label>
                                            <div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="material_labor_type" id="id_material_labor_type_0" value="" {% if not form.material_labor_type.value or form.material_labor_type.value == '' %}checked{% endif %}>
                                                    <label class="form-check-label" for="id_material_labor_type_0">-</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="material_labor_type" id="id_material_labor_type_1" value="material_labor" {% if form.material_labor_type.value == 'material_labor' %}checked{% endif %}>
                                                    <label class="form-check-label" for="id_material_labor_type_1">æå·¥</label>
                                                </div>
                                                <div class="form-check form-check-inline">
                                                    <input class="form-check-input" type="radio" name="material_labor_type" id="id_material_labor_type_2" value="labor_only" {% if form.material_labor_type.value == 'labor_only' %}checked{% endif %}>
                                                    <label class="form-check-label" for="id_material_labor_type_2">æ‰‹é–“</label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="{{ form.site_address.id_for_label }}" class="form-label">
                                            ç¾å ´ä½æ‰€
                                        </label>
                                        {{ form.site_address }}
                                    </div>

                                    <!-- éµå—ã‘æ¸¡ã—è¨­å®šï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
                                    <div class="row mt-3">
                                        <div class="col-12">
                                            <!-- æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
                                            <div class="d-flex align-items-center mb-2">
                                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleKeyHandoverSection()" id="keyHandoverToggleBtn">
                                                    <i class="fas fa-plus me-1" id="keyHandoverToggleIcon"></i>
                                                    <i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’è¿½åŠ 
                                                </button>
                                                <small class="text-muted ms-2">ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¨­å®šã—ã¦ãã ã•ã„ï¼‰</small>
                                            </div>

                                            <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªè¨­å®šã‚¨ãƒªã‚¢ -->
                                            <div id="keyHandoverSection" style="display: none;">
                                                <div class="alert alert-info small mb-3">
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    å…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ãŒã€æ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ã§ã™ã€‚
                                                </div>
                                                <div class="row">
                                                    <div class="col-md-6 mb-3">
                                                        <label for="{{ form.key_handover_location.id_for_label }}" class="form-label">
                                                            éµå—ã‘æ¸¡ã—å ´æ‰€
                                                        </label>
                                                        {{ form.key_handover_location }}
                                                        <div class="form-text">éµã®å—ã‘æ¸¡ã—å ´æ‰€ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼ˆå…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‹ã‚‰è‡ªå‹•å…¥åŠ›ï¼‰</div>
                                                    </div>
                                                    <div class="col-md-6 mb-3">
                                                        <label for="{{ form.key_handover_date.id_for_label }}" class="form-label">
                                                            éµå—ã‘æ¸¡ã—æ—¥æ™‚
                                                        </label>
                                                        {{ form.key_handover_date }}
                                                        <div class="form-text">éµã®å—ã‘æ¸¡ã—äºˆå®šæ—¥æ™‚</div>
                                                    </div>
                                                    <div class="col-12 mb-3">
                                                        <label for="{{ form.key_handover_notes.id_for_label }}" class="form-label">
                                                            éµå—ã‘æ¸¡ã—ãƒ¡ãƒ¢
                                                        </label>
                                                        {{ form.key_handover_notes }}
                                                        <div class="form-text">éµå—ã‘æ¸¡ã—ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …ã‚„ãƒ¡ãƒ¢</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                </div>
                                <div class="col-md-6">
                            <!-- å—æ³¨é‡‘é¡æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-yen-sign me-2"></i>å—æ³¨é‡‘é¡æƒ…å ±</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-12 mb-3">
                                            <label class="form-label">å—æ³¨ãƒ¨ãƒŸ <span class="text-danger">*</span></label>
                                            <div class="d-flex gap-2 align-items-center">
                                                <select name="project_status" id="{{ form.project_status.id_for_label }}" class="form-select" required onchange="updateProjectStatusBadge()">
                                                    <option value="">-- å—æ³¨ãƒ¨ãƒŸã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                                    <option value="ãƒã‚¿" {% if not project or project.project_status == 'ãƒã‚¿' %}selected{% endif %}>ãƒã‚¿ï¼ˆè¦‹è¾¼ã¿æ¡ˆä»¶ï¼‰</option>
                                                    <option value="A" {% if project and project.project_status == 'A' %}selected{% endif %}>Aï¼ˆå—æ³¨ç¢ºåº¦é«˜ï¼‰</option>
                                                    <option value="B" {% if project and project.project_status == 'B' %}selected{% endif %}>Bï¼ˆå—æ³¨ç¢ºåº¦ä¸­ï¼‰</option>
                                                    <option value="å—æ³¨ç¢ºå®š" {% if project and project.project_status == 'å—æ³¨ç¢ºå®š' %}selected{% endif %}>å—æ³¨ç¢ºå®š</option>
                                                    <option value="NG" {% if project and project.project_status == 'NG' %}selected{% endif %}>NGï¼ˆå—æ³¨ã§ããšï¼‰</option>
                                                </select>
                                                <span id="projectStatusBadge" class="badge" style="min-width: 120px; font-size: 0.9rem;"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.order_amount.id_for_label }}" class="form-label">
                                                å—æ³¨é‡‘é¡(ç¨æŠœ) <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">Â¥</span>
                                                {{ form.order_amount }}
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">
                                                é‡‘é¡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
                                            </label>
                                            <select class="form-select" id="orderAmountStatus" name="order_amount_status">
                                                <option value="estimated" {% if project and project.order_amount_status == 'estimated' %}selected{% endif %}>è¦‹ç©ã‚‚ã‚Šå¾Œç¢ºå®š</option>
                                                <option value="planned" {% if project and project.order_amount_status == 'planned' %}selected{% endif %}>äºˆå®š</option>
                                                <option value="confirmed" {% if project and project.order_amount_status == 'confirmed' %}selected{% endif %}>ç¢ºå®š</option>
                                            </select>
                                            <small class="text-muted d-block">å—æ³¨é‡‘é¡ã®ç¢ºå®šåº¦åˆã„ã‚’é¸æŠ</small>
                                        </div>
                                    </div>

                                    <!-- çµŒè²»ãƒ»è«¸çµŒè²»é …ç›® -->
                                    <div class="mt-3">
                                        <div class="d-flex align-items-center mb-2">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleExpenseSection()" id="expenseToggleBtn">
                                                <i class="fas fa-plus me-1" id="expenseToggleIcon"></i>
                                                <i class="fas fa-receipt me-1"></i>çµŒè²»ãƒ»è«¸çµŒè²»é …ç›®ã‚’è¿½åŠ 
                                            </button>
                                            <small class="text-muted ms-2">ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¨­å®šã—ã¦ãã ã•ã„ï¼‰</small>
                                        </div>
                                        <div id="expenseSection" style="display: none;">
                                            <div class="card border-warning">
                                                <div class="card-header bg-warning bg-opacity-10">
                                                    <div class="d-flex justify-content-between align-items-center">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-receipt me-2"></i>çµŒè²»ãƒ»è«¸çµŒè²»é …ç›®
                                                        </h6>
                                                        <button type="button" class="btn btn-sm btn-warning" onclick="addExpenseItem()">
                                                            <i class="fas fa-plus me-1"></i>é …ç›®è¿½åŠ 
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="card-body">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-hover mb-0">
                                                    <thead class="table-light">
                                                        <tr>
                                                            <th style="width: 50%;">é …ç›®å</th>
                                                            <th style="width: 40%;">é‡‘é¡</th>
                                                            <th style="width: 10%;">æ“ä½œ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="expenseItemsTableBody">
                                                        <!-- åˆæœŸé …ç›®ï¼ˆæ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿æŒï¼‰ -->
                                                        <tr data-expense-index="1">
                                                            <td>
                                                                {{ form.expense_item_1 }}
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm">
                                                                    <span class="input-group-text">Â¥</span>
                                                                    {{ form.expense_amount_1 }}
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExpenseItem(this)" title="å‰Šé™¤">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        <tr data-expense-index="2">
                                                            <td>
                                                                {{ form.expense_item_2 }}
                                                            </td>
                                                            <td>
                                                                <div class="input-group input-group-sm">
                                                                    <span class="input-group-text">Â¥</span>
                                                                    {{ form.expense_amount_2 }}
                                                                </div>
                                                            </td>
                                                            <td>
                                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExpenseItem(this)" title="å‰Šé™¤">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="mt-3">
                                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                                    <span class="fw-bold">çµŒè²»åˆè¨ˆ:</span>
                                                    <span class="fs-5 fw-bold text-warning">Â¥<span id="expenseTotalAmount">0</span></span>
                                                </div>
                                            </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                </div>
                            </div>

                            <!-- å‚™è€ƒãƒ»æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚«ãƒ¼ãƒ‰ -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>å‚™è€ƒãƒ»æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«</h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                                            å‚™è€ƒ
                                        </label>
                                        {{ form.notes }}
                                        <small class="text-muted d-block">æ¡ˆä»¶ã«é–¢ã™ã‚‹å‚™è€ƒã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-paperclip me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜
                                        </label>
                                        <input type="file" id="projectFileInput" class="form-control" multiple>
                                        <small class="text-muted d-block">è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã§ãã¾ã™ï¼ˆPDFã€Wordã€Excelã€ç”»åƒãªã©ï¼‰</small>

                                        <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ -->
                                        <div id="uploadedFilesList" class="mt-3">
                                            {% if project and project.files.exists %}
                                            <div class="card">
                                                <div class="card-header bg-light py-2">
                                                    <small class="text-muted"><i class="fas fa-file me-1"></i>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«</small>
                                                </div>
                                                <div class="card-body p-2">
                                                    <ul class="list-group list-group-flush">
                                                        {% for file in project.files.all %}
                                                        <li class="list-group-item d-flex justify-content-between align-items-center py-2">
                                                            <span>
                                                                <i class="fas fa-file-{% if file.is_pdf %}pdf{% elif file.is_image %}image{% else %}alt{% endif %} me-2"></i>
                                                                {{ file.file_name }}
                                                                <small class="text-muted">({{ file.get_file_size_display }})</small>
                                                            </span>
                                                            <div>
                                                                <a href="{{ file.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                                                                    <i class="fas fa-download"></i>
                                                                </a>
                                                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteProjectFile({{ file.id }})">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                                            </div>
                                                        </li>
                                                        {% endfor %}
                                                    </ul>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <!-- æ–°è¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                                        <div id="newFilesPreview" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ–çµ‚äº† -->


                        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
                        <div class="tab-pane" id="schedule" role="tabpanel" data-section-title="ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«">
                            <div class="form-section mb-4">
                                <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç† -->
                                <div class="card shadow-sm mb-4">
                                    <div class="card-header bg-gradient-primary text-white py-2">
                                        <h6 class="mb-0"><i class="fas fa-cog me-2"></i>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†</h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéš -->
                                        <div id="formActiveSteps">
                                            <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                        </div>

                                        <!-- åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ— -->
                                        <div id="formStepInventory" class="mt-3">
                                            <hr>
                                            <h6><i class="fas fa-box me-2"></i>åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—</h6>
                                            <div class="row" id="formAvailableSteps">
                                                <!-- åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ãƒœã‚¿ãƒ³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                                            </div>
                                        </div>

                                        <!-- ã‚¹ãƒ†ãƒƒãƒ—é †åºã¨ãƒ‡ãƒ¼ã‚¿ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                                        <input type="hidden" name="schedule_steps_data" id="formScheduleStepsData" value="">
                                    </div>
                                </div>

                                <!-- ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                                <div class="card shadow-sm">
                                    <div class="card-header bg-light py-2">
                                        <h6 class="mb-0"><i class="fas fa-calendar me-2"></i>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h6>
                                    </div>
                                    <div class="card-body p-2">
                                        <div id="formScheduleCalendar" style="min-height: 400px;"></div>
                                    </div>
                                    <div class="card-footer bg-light py-2">
                                        <small class="text-muted d-block mb-1">
                                            <span class="badge" style="background-color: #4CAF50;">â– </span> ã“ã®æ¡ˆä»¶ã®ã‚¹ãƒ†ãƒƒãƒ—
                                        </small>
                                        <small class="text-muted d-block">
                                            <span class="badge" style="background-color: #E0E0E0;">â– </span> æ—¢å­˜æ¡ˆä»¶
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–çµ‚äº† -->

                        <!-- è«‹æ±‚ã‚¿ãƒ– -->
                        <div class="tab-pane" id="order" role="tabpanel" data-section-title="ğŸ’° è«‹æ±‚">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-file-invoice-dollar me-2"></i>è«‹æ±‚</h5>
                        </div>
                        <div class="card-body">
                            <!-- è«‹æ±‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                            <div class="card border-info mb-4">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-invoice me-2"></i>è«‹æ±‚
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ï¼ˆèª­ã¿å–ã‚Šå°‚ç”¨ã‚«ãƒ¼ãƒ‰ï¼‰ -->
                                    <div class="alert alert-info mb-3" id="paymentCycleInfoCard" style="display: none;">
                                        <h6 class="mb-2">
                                            <i class="fas fa-info-circle me-2"></i>å…ƒè«‹ä¼šç¤¾ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«
                                        </h6>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <strong>æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«:</strong><br>
                                                <span id="displayPaymentCycle">-</span>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>ç· ã‚æ—¥:</strong><br>
                                                <span id="displayClosingDay">-</span>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>æ”¯æ‰•æœˆ:</strong><br>
                                                <span id="displayPaymentOffsetMonths">-</span>
                                            </div>
                                            <div class="col-md-3">
                                                <strong>æ”¯æ‰•æ—¥:</strong><br>
                                                <span id="displayPaymentDay">-</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Hidden fields for form submission -->
                                    <input type="hidden" name="payment_cycle" id="{{ form.payment_cycle.id_for_label }}">
                                    <input type="hidden" name="closing_day" id="{{ form.closing_day.id_for_label }}">
                                    <input type="hidden" name="payment_offset_months" id="{{ form.payment_offset_months.id_for_label }}">
                                    <input type="hidden" name="payment_day" id="{{ form.payment_day.id_for_label }}">

                                    <!-- å…¥é‡‘äºˆå®šæ—¥ -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.payment_due_date.id_for_label }}" class="form-label">
                                                å…¥é‡‘äºˆå®šæ—¥ï¼ˆè‡ªç¤¾â†å…ƒè«‹ï¼‰ <span class="text-danger">*</span>
                                            </label>

                                            <!-- åŸºæº–æ—¥é¸æŠ -->
                                            <div class="mb-2 p-2 bg-light rounded">
                                                <label class="form-label small mb-1">
                                                    <i class="fas fa-calendar me-1"></i>ç· æ—¥ã®åŸºæº–æ—¥
                                                </label>
                                                <div class="d-flex gap-2 align-items-center flex-wrap">
                                                    <select class="form-select form-select-sm" id="incomingPaymentBaseDateType" style="max-width: 200px;" onchange="updateIncomingPaymentBaseDate()">
                                                        <!-- ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                                                    </select>
                                                    <input type="date" class="form-control form-control-sm"
                                                           id="incomingPaymentCustomBaseDate"
                                                           style="max-width: 200px; display: none;"
                                                           onchange="updateIncomingPaymentBaseDate()">
                                                    <span class="text-muted small">
                                                        åŸºæº–æ—¥: <strong id="incomingPaymentBaseDateDisplay">æœªé¸æŠ</strong>
                                                    </span>
                                                </div>
                                                <small class="text-muted d-block mt-1">
                                                    <i class="fas fa-info-circle me-1"></i>ã“ã®æ—¥ä»˜ãŒå…ƒè«‹ä¼šç¤¾ã®ç· æ—¥ã«å…¥ã‚‹ã‹ã©ã†ã‹ã‚’è¨ˆç®—ã—ã¾ã™
                                                </small>
                                            </div>

                                            <div class="input-group">
                                                {{ form.payment_due_date }}
                                                <button type="button" class="btn btn-outline-primary" onclick="autoCalculatePaymentDueDateFromContract()" title="åŸºæº–æ—¥ã‹ã‚‰è‡ªå‹•è¨ˆç®—">
                                                    <i class="fas fa-calculator me-1"></i>è‡ªå‹•è¨ˆç®—
                                                </button>
                                            </div>
                                            <small class="text-muted">æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ã¯å…ƒè«‹ä¼šç¤¾ã®è¨­å®šå€¤ã§ã™ã€‚ç· æ—¥ã«å…¥ã‚‹ã‹ã¯åŸºæº–æ—¥ã§å¤‰ã‚ã‚Šã¾ã™ã€‚</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">è«‹æ±‚æ›¸çŠ¶æ³ï¼ˆè‡ªç¤¾â†’å…ƒè«‹ï¼‰</label>
                                            <div class="form-check mt-2">
                                                <input type="checkbox" class="form-check-input" id="{{ form.invoice_issued.id_for_label }}" name="{{ form.invoice_issued.html_name }}" {% if form.invoice_issued.value %}checked{% endif %}>
                                                <label class="form-check-label" for="{{ form.invoice_issued.id_for_label }}">
                                                    è«‹æ±‚æ›¸ç™ºè¡Œæ¸ˆã¿
                                                </label>
                                            </div>

                                            <!-- è«‹æ±‚æ›¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                                            <div class="mt-3" id="clientInvoiceUploadSection">
                                                <label class="form-label small">
                                                    <i class="fas fa-file-invoice me-1"></i>è«‹æ±‚æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆè‡ªç¤¾â†’å…ƒè«‹ï¼‰
                                                </label>
                                                <input type="file" id="clientInvoiceFileInput" class="form-control form-control-sm" accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png">
                                                <small class="text-muted d-block">è«‹æ±‚æ›¸ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</small>

                                                <!-- ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ¸ˆã¿è«‹æ±‚æ›¸ -->
                                                {% if project and project.invoice_file %}
                                                <div class="mt-2">
                                                    <a href="{{ project.invoice_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                        <i class="fas fa-file-pdf me-1"></i>è«‹æ±‚æ›¸ã‚’ç¢ºèª
                                                    </a>
                                                </div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                        </div>
                        <!-- è«‹æ±‚ã‚¿ãƒ–çµ‚äº† -->

                        <!-- æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ– -->
                        <div class="tab-pane" id="staff" role="tabpanel" data-section-title="ğŸ‘¥ æ¥­è€…ãƒ»æ‹…å½“">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-users me-2"></i>å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…æƒ…å ±</h5>
                        </div>
                        <div class="card-body">
                            <!-- å·¥ç¨‹åˆ¥å®Ÿæ–½ä½“åˆ¶ç™»éŒ² -->
                            <div class="mb-3">
                                <h6 class="text-primary mb-2">
                                    <i class="fas fa-project-diagram me-2"></i>å·¥ç¨‹åˆ¥å®Ÿæ–½ä½“åˆ¶ç™»éŒ²
                                </h6>
                                <p class="text-muted small mb-3">
                                    <i class="fas fa-info-circle me-1"></i>
                                    å¤–æ³¨ãŒå¿…è¦ãªå·¥ç¨‹ã‚’å±•é–‹ã—ã¦ã€ä½œæ¥­è€…ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚å„å·¥ç¨‹ã«è¤‡æ•°ã®æ¥­è€…ã‚’è¿½åŠ ã§ãã¾ã™ã€‚
                                </p>
                            </div>

                            <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå·¥ç¨‹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
                            <div class="vertical-progress" id="implementationTimeline">
                                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ–çµ‚äº† -->
                    </div>
                    <!-- ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„çµ‚äº† -->

                    <!-- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒœã‚¿ãƒ³ -->
                    <div class="row mt-4">
                        <div class="col-md-12 text-center">
                            <button type="submit" class="btn btn-success btn-lg me-3" id="submitBtn">
                                <i class="fas fa-save"></i>
                                {% if project %}æ¡ˆä»¶ã‚’æ›´æ–°{% else %}æ¡ˆä»¶ã‚’ç™»éŒ²{% endif %}
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-lg me-3" id="saveDraftBtn" onclick="saveDraft()">
                                <i class="fas fa-file-alt"></i>
                                ä¸‹æ›¸ãä¿å­˜
                            </button>
                            <a href="{% if project %}{% url 'order_management:project_detail' project.pk %}{% else %}{% url 'order_management:project_list' %}{% endif %}"
                               class="btn btn-secondary btn-lg" id="cancelBtn">
                                <i class="fas fa-times"></i>
                                {% if project %}æˆ»ã‚‹{% else %}ã‚­ãƒ£ãƒ³ã‚»ãƒ«{% endif %}
                            </a>
                            <div class="mt-2">
                                <small id="autoSaveStatus" class="text-muted">
                                    <i class="fas fa-circle text-secondary"></i> è‡ªå‹•ä¿å­˜å¾…æ©Ÿä¸­
                                </small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- æ”¹å–„ç‰ˆ å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆPhase 5ã§è¿½åŠ ï¼‰ -->
{% include "order_management/includes/improved_implementation_modal.html" %}
{% include "order_management/includes/improved_implementation_modal_script.html" %}

<!-- ç·¨é›†æ™‚ã®æ—¢å­˜subcontractãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ– -->
<script>
{% if subcontracts %}
(function() {
    // window.processWorkersãŒåˆæœŸåŒ–ã•ã‚Œã‚‹ã¾ã§å¾…ã¤
    function initializeSubcontracts() {
        if (typeof window.processWorkers === 'undefined') {
            console.log('â³ window.processWorkersã®åˆæœŸåŒ–ã‚’å¾…ã£ã¦ã„ã¾ã™...');
            setTimeout(initializeSubcontracts, 100);
            return;
        }

        console.log('âœ… æ—¢å­˜subcontractãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...');

        // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—ã—ãŸsubcontractsãƒ‡ãƒ¼ã‚¿ã§window.processWorkersã‚’åˆæœŸåŒ–
        {% for subcontract in subcontracts %}
        {% if subcontract.contractor %}
        (function() {
            const stepKey = 'step_{{ subcontract.step }}';

            if (!window.processWorkers[stepKey]) {
                window.processWorkers[stepKey] = [];
            }

            window.processWorkers[stepKey].push({
                subcontractId: {{ subcontract.id }},
                contractorId: {{ subcontract.contractor.id }},
                contractorName: '{{ subcontract.contractor.name|escapejs }}',
                contractAmount: parseFloat('{{ subcontract.contract_amount }}') || 0,
                billedAmount: parseFloat('{{ subcontract.billed_amount }}') || 0,
                paymentDueDate: '{{ subcontract.payment_due_date|date:"Y-m-d"|default:"" }}',
                paymentStatus: '{{ subcontract.payment_status }}',
                workDescription: '{{ subcontract.work_description|escapejs }}',
                step: '{{ subcontract.step }}'
            });
        })();
        {% endif %}
        {% endfor %}

        console.log('âœ… processWorkersãƒ‡ãƒ¼ã‚¿:', window.processWorkers);

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†ç”Ÿæˆ
        setTimeout(function() {
            if (typeof generateImplementationTimeline === 'function') {
                console.log('ğŸ”„ ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†ç”Ÿæˆä¸­...');
                generateImplementationTimeline();
            }
        }, 300);
    }

    // åˆæœŸåŒ–ã‚’é–‹å§‹
    initializeSubcontracts();
})();
{% endif %}
</script>

<!-- ä¸‹è«‹ã‘ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="subcontractModal" tabindex="-1" aria-labelledby="subcontractModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="subcontractModalLabel">
                    <i class="fas fa-user-plus me-2"></i>ä½œæ¥­è€…ã‚’è¿½åŠ 
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="subcontractForm">
                    {% csrf_token %}
                    <input type="hidden" id="subcontractStep" name="step">

                    <!-- å¤–æ³¨å…ˆæƒ…å ± -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">å¤–æ³¨å…ˆæƒ…å ±</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-0">
                                <label class="form-label">
                                    ç™ºæ³¨å…ˆ <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="hidden" id="subcontractContractor" name="contractor" required>
                                    <input type="text" id="selectedContractorDisplay" class="form-control" readonly placeholder="ä¸‹è«‹ã‘ç®¡ç†ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„" style="flex: 1; background-color: #f8f9fa; cursor: pointer;" onclick="openContractorManagementPanel()">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openContractorManagementPanel()" title="ä¸‹è«‹ã‘æ¥­è€…ã‚’é¸æŠãƒ»ç®¡ç†">
                                        <i class="fas fa-handshake"></i> ä¸‹è«‹ã‘ç®¡ç†
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    ä¸‹è«‹ã‘ç®¡ç†ãƒœã‚¿ãƒ³ã‹ã‚‰æ¥­è€…ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®æ¥­è€…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- é‡‘é¡ç®¡ç† -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">é‡‘é¡ç®¡ç†</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="subcontractContractAmount" class="form-label">
                                            å¥‘ç´„é‡‘é¡
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control" id="subcontractContractAmount" name="contract_amount" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="subcontractBilledAmount" class="form-label">
                                            è¢«è«‹æ±‚é¡
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control" id="subcontractBilledAmount" name="billed_amount">
                                        </div>
                                        <small class="form-text text-muted">å®Ÿéš›ã«è«‹æ±‚ã•ã‚ŒãŸé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰</small>
                                    </div>
                                </div>
                            </div>

                            <!-- è¿½åŠ è²»ç”¨ -->
                            <hr>
                            <h6 class="mb-3"><i class="fas fa-plus-circle me-1"></i>è¿½åŠ è²»ç”¨</h6>
                            <div id="modalAdditionalCostsContainer"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addModalAdditionalCostRow()">
                                <i class="fas fa-plus me-1"></i>è²»ç”¨ã‚’è¿½åŠ 
                            </button>
                            <input type="hidden" id="modalAdditionalCostsData" name="additional_costs_data">

                            <!-- è¿½åŠ è²»ç”¨åˆè¨ˆè¡¨ç¤º -->
                            <div id="modal_additional_total_display" class="alert alert-secondary mt-2 mb-0" style="display: none;">
                                <strong>è¿½åŠ è²»ç”¨åˆè¨ˆ: Â¥<span id="modal_additional_total_amount">0</span></strong>
                            </div>

                            <!-- è«‹æ±‚æ›¸ãƒ•ã‚¡ã‚¤ãƒ« -->
                            <hr>
                            <div class="mb-0">
                                <label for="subcontractInvoiceFile" class="form-label">
                                    <i class="fas fa-file-invoice me-1"></i>è«‹æ±‚æ›¸ãƒ•ã‚¡ã‚¤ãƒ«
                                </label>
                                <input type="file" class="form-control" id="subcontractInvoiceFile" name="invoice_file" accept=".pdf,.jpg,.jpeg,.png">
                                <small class="form-text text-muted">PDFã€JPGã€PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½</small>
                            </div>
                        </div>
                    </div>

                    <!-- æ”¯æ‰•ã„ç®¡ç† -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">æ”¯æ‰•ã„ç®¡ç†</h5>
                        </div>
                        <div class="card-body">
                            <!-- æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±è¡¨ç¤º -->
                            <div class="alert alert-info mb-3" id="contractorPaymentInfo" style="display: none;">
                                <h6 class="mb-2">
                                    <i class="fas fa-info-circle me-2"></i>é¸æŠã•ã‚ŒãŸæ¥­è€…ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«
                                </h6>
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«:</strong><br>
                                        <span id="modalDisplayPaymentCycle">æœˆ1å›</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>ç· ã‚æ—¥:</strong><br>
                                        <span id="modalDisplayClosingDay">-</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>æ”¯æ‰•æœˆ:</strong><br>
                                        <span id="modalDisplayPaymentOffsetMonths">-</span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>æ”¯æ‰•æ—¥:</strong><br>
                                        <span id="modalDisplayPaymentDay">-</span>
                                    </div>
                                </div>
                            </div>

                            <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                            <div id="modalPaymentCalculationError" class="alert alert-warning d-none mb-3" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="modalPaymentCalculationErrorMessage"></span>
                            </div>

                            <!-- åŸºæº–æ—¥é¸æŠ -->
                            <div class="mb-3 p-2 bg-light rounded">
                                <label class="form-label small mb-1">
                                    <i class="fas fa-calendar me-1"></i>ç· æ—¥ã®åŸºæº–æ—¥
                                </label>
                                <div class="d-flex gap-2 align-items-center flex-wrap">
                                    <select class="form-select form-select-sm" id="modalBaseDateType" style="max-width: 200px;" onchange="updateModalBaseDate()">
                                        <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
                                        <option value="custom">ä»»æ„æ—¥</option>
                                        <!-- ãã®ä»–ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯JavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                                    </select>
                                    <input type="date" class="form-control form-control-sm"
                                           id="modalReferenceDate"
                                           style="max-width: 200px; display: none;"
                                           onchange="updateModalBaseDate()">
                                    <span class="text-muted small">
                                        åŸºæº–æ—¥: <strong id="modalBaseDateDisplay">æœªé¸æŠ</strong>
                                    </span>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    <i class="fas fa-info-circle me-1"></i>ã“ã®æ—¥ä»˜ãŒæ¥­è€…ã®ç· æ—¥ã«å…¥ã‚‹ã‹ã©ã†ã‹ã‚’è¨ˆç®—ã—ã¾ã™
                                </small>
                            </div>

                            <!-- å‡ºé‡‘äºˆå®šæ—¥ï¼ˆè‡ªç¤¾â†’æ¥­è€…ï¼‰ -->
                            <div class="mb-3">
                                <label for="subcontractPaymentDueDate" class="form-label">
                                    å‡ºé‡‘äºˆå®šæ—¥ï¼ˆè‡ªç¤¾â†’æ¥­è€…ï¼‰ <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <input type="date" class="form-control" id="subcontractPaymentDueDate" name="payment_due_date">
                                    <button type="button" id="modalCalculatePaymentDueDate" class="btn btn-outline-primary" title="åŸºæº–æ—¥ã‹ã‚‰è‡ªå‹•è¨ˆç®—">
                                        <i class="fas fa-calculator me-1"></i>è‡ªå‹•è¨ˆç®—
                                    </button>
                                </div>
                                <small class="text-muted">æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ã¯æ¥­è€…ã®è¨­å®šå€¤ã§ã™ã€‚ç· æ—¥ã«å…¥ã‚‹ã‹ã¯åŸºæº–æ—¥ã§å¤‰ã‚ã‚Šã¾ã™ã€‚</small>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="subcontractPaymentStatus" class="form-label">
                                        æ”¯æ‰•ã„çŠ¶æ³
                                    </label>
                                    <select class="form-select" id="subcontractPaymentStatus" name="payment_status">
                                        <option value="pending">æœªæ‰•ã„</option>
                                        <option value="processing">å‡¦ç†ä¸­</option>
                                        <option value="paid">æ”¯æ‰•æ¸ˆ</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="subcontractPaymentDate" class="form-label">
                                        å‡ºé‡‘æ—¥
                                    </label>
                                    <input type="date" class="form-control" id="subcontractPaymentDate" name="payment_date">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="subcontractPurchaseOrderIssued" name="purchase_order_issued">
                                        <label class="form-check-label" for="subcontractPurchaseOrderIssued">
                                            ç™ºæ³¨æ›¸ç™ºè¡Œæ¸ˆã¿
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="subcontractPurchaseOrderFile" class="form-label">
                                        ç™ºæ³¨æ›¸ãƒ•ã‚¡ã‚¤ãƒ«
                                    </label>
                                    <input type="file" class="form-control" id="subcontractPurchaseOrderFile" name="purchase_order_file" accept=".pdf,.jpg,.jpeg,.png">
                                    <small class="form-text text-muted">PDFã€JPGã€PNGãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯èƒ½</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- éƒ¨æè²»ç®¡ç†ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
                    <div class="card mb-3 border-secondary">
                        <div class="card-header bg-light" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#materialCostSection">
                            <h6 class="mb-0">
                                <i class="fas fa-boxes me-2"></i>éƒ¨æè²»ï¼ˆä»»æ„ï¼‰
                                <i class="fas fa-chevron-down float-end"></i>
                            </h6>
                        </div>
                        <div id="materialCostSection" class="collapse">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem1" class="form-label">éƒ¨æè²»é …ç›®â‘ </label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem1" name="material_item_1" placeholder="ä¾‹ï¼šæœ¨æ">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost1" class="form-label">éƒ¨æè²»ä»£â‘ </label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost1" name="material_cost_1">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem2" class="form-label">éƒ¨æè²»é …ç›®â‘¡</label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem2" name="material_item_2" placeholder="ä¾‹ï¼šé‡‘å…·">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost2" class="form-label">éƒ¨æè²»ä»£â‘¡</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost2" name="material_cost_2">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem3" class="form-label">éƒ¨æè²»é …ç›®â‘¢</label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem3" name="material_item_3" placeholder="ä¾‹ï¼šå¡—æ–™">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost3" class="form-label">éƒ¨æè²»ä»£â‘¢</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost3" name="material_cost_3">
                                        </div>
                                    </div>
                                </div>

                                <!-- å‹•çš„éƒ¨æè²»è¿½åŠ ã‚¨ãƒªã‚¢ -->
                                <hr>
                                <h6 class="mb-3"><i class="fas fa-plus-circle me-1"></i>è¿½åŠ éƒ¨æè²»</h6>
                                <div id="modalDynamicMaterialsContainer"></div>
                                <button type="button" class="btn btn-sm btn-outline-success mb-3" onclick="addModalMaterialRow()">
                                    <i class="fas fa-plus me-1"></i>éƒ¨æè²»ã‚’è¿½åŠ 
                                </button>
                                <input type="hidden" id="modalDynamicMaterialsData" name="dynamic_materials_data">

                                <!-- éƒ¨æè²»åˆè¨ˆè¡¨ç¤º -->
                                <div class="alert alert-info mb-0">
                                    <strong>éƒ¨æè²»åˆè¨ˆ: Â¥<span id="modalMaterialTotalAmount">0</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å‚™è€ƒ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">å‚™è€ƒ</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-0">
                                <label for="subcontractNotes" class="form-label">å‚™è€ƒ</label>
                                <textarea class="form-control" id="subcontractNotes" name="notes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- ç·ã‚³ã‚¹ãƒˆè¡¨ç¤º -->
                    <div class="alert alert-warning mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>
                            <strong>ç·ã‚³ã‚¹ãƒˆ: Â¥<span id="modalTotalCostAmount">0</span></strong>
                        </h5>
                        <small class="text-muted">ï¼ˆ<span id="modalCostBaseLabel">å¥‘ç´„é‡‘é¡</span> + éƒ¨æè²»åˆè¨ˆ + è¿½åŠ è²»ç”¨ï¼‰</small>
                    </div>

                    <!-- ä»–ã®å·¥ç¨‹ã«ã‚‚è¿½åŠ  -->
                    <div class="mb-3" id="additionalStepsSection" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-clone me-2"></i>ä»–ã®å·¥ç¨‹ã«ã‚‚è¿½åŠ 
                                </h6>
                                <small class="text-muted">åŒã˜æ¥­è€…ãƒ»åŒã˜æ¡ä»¶ã§è¤‡æ•°ã®å·¥ç¨‹ã«ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™</small>
                            </div>
                            <div class="card-body">
                                <!-- å·¥ç¨‹é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                                <div id="additionalStepsCheckboxes" class="mb-3">
                                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                                </div>

                                <!-- é‡‘é¡ã®è¨­å®šæ–¹æ³•ã‚’é¸æŠ -->
                                <div id="costAllocationSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="mb-3">
                                        <i class="fas fa-yen-sign me-2"></i>é‡‘é¡ã®è¨­å®šæ–¹æ³•
                                    </h6>
                                    <div class="mb-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="cost_allocation_method" id="costMethodLumpSum" value="lump_sum" checked>
                                            <label class="form-check-label" for="costMethodLumpSum">
                                                <strong>å…¨å·¥ç¨‹ä¸€å¼ã§ç™»éŒ²</strong>
                                                <div class="text-muted small">ä¸Šè¨˜ã®å¥‘ç´„é‡‘é¡ã§å…¨å·¥ç¨‹ã‚’ã‚«ãƒãƒ¼ã—ã¾ã™ï¼ˆè¿½åŠ å·¥ç¨‹ã¯Â¥0ã§é–¢é€£ä»˜ã‘ï¼‰</div>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="cost_allocation_method" id="costMethodPerStep" value="per_step">
                                            <label class="form-check-label" for="costMethodPerStep">
                                                <strong>å·¥ç¨‹ã”ã¨ã«é‡‘é¡ã‚’è¨­å®š</strong>
                                                <div class="text-muted small">å„å·¥ç¨‹ã®é‡‘é¡ã‚’å€‹åˆ¥ã«å…¥åŠ›ã—ã¾ã™</div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›æ¬„ -->
                                    <div id="perStepAmountsSection" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-1"></i>å„å·¥ç¨‹ã®å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                                        </div>
                                        <div id="perStepAmountsInputs">
                                            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                                        </div>

                                        <!-- å·¥ç¨‹åˆ¥é‡‘é¡ã®åˆè¨ˆè¡¨ç¤º -->
                                        <div class="alert alert-success mt-3">
                                            <h6 class="mb-2">
                                                <i class="fas fa-calculator me-2"></i>
                                                <strong>å…¨å·¥ç¨‹ã®ç·ã‚³ã‚¹ãƒˆ</strong>
                                            </h6>
                                            <div id="perStepCostBreakdown" class="mb-2 small">
                                                <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                                            </div>
                                            <hr class="my-2">
                                            <h5 class="mb-0">
                                                <strong>åˆè¨ˆ: Â¥<span id="perStepTotalCost">0</span></strong>
                                            </h5>
                                            <small class="text-muted">ï¼ˆå…¨å·¥ç¨‹ã®å¥‘ç´„é‡‘é¡ã®åˆè¨ˆï¼‰</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSubcontract()">
                    <i class="fas fa-save me-1"></i>ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è³‡æç™ºæ³¨ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="materialOrderModal" tabindex="-1" aria-labelledby="materialOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="materialOrderModalLabel">
                    <i class="fas fa-box-open me-2"></i>è³‡æç™ºæ³¨ã‚’è¿½åŠ 
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="materialOrderForm">
                    {% csrf_token %}

                    <!-- è³‡ææ¥­è€…é¸æŠ -->
                    <div class="mb-3">
                        <label for="materialContractor" class="form-label">
                            è³‡ææ¥­è€… <span class="text-danger">*</span>
                        </label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="materialContractor" name="contractor" required style="flex: 1;">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                {% for contractor in contractors %}
                                <option value="{{ contractor.id }}">{{ contractor.name }}</option>
                                {% endfor %}
                            </select>
                            <a href="{% url 'order_management:contractor_create' %}?back={{ request.path }}" target="_blank" class="btn btn-outline-warning" title="æ–°è¦æ¥­è€…ã‚’è¿½åŠ ">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>æ–°ã—ã„æ¥­è€…ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯<i class="fas fa-plus"></i>ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
                        </small>
                    </div>

                    <!-- ç™ºæ³¨æƒ…å ± -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="materialOrderDate" class="form-label">
                                    ç™ºæ³¨æ—¥ <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="materialOrderDate" name="order_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="materialDeliveryDate" class="form-label">
                                    å¸Œæœ›ç´æœŸ
                                </label>
                                <input type="date" class="form-control" id="materialDeliveryDate" name="delivery_date">
                            </div>
                        </div>
                    </div>

                    <!-- è³‡æé …ç›® -->
                    <div class="mb-3">
                        <h6 class="text-warning border-bottom border-warning pb-2 mb-3">
                            <i class="fas fa-boxes me-1"></i>è³‡æé …ç›®
                        </h6>
                        <div id="materialItems">
                            <!-- æœ€åˆã®è³‡æé …ç›® -->
                            <div class="material-item mb-3 p-3 bg-light rounded">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">è³‡æå <span class="text-danger">*</span></label>
                                        <input type="text" name="material_name[]" class="form-control" placeholder="ä¾‹: ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">æ•°é‡</label>
                                        <input type="number" name="quantity[]" class="form-control material-quantity" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">å˜ä½</label>
                                        <input type="text" name="unit[]" class="form-control" placeholder="ä¾‹: mÂ³">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">å˜ä¾¡(å††)</label>
                                        <input type="number" name="unit_price[]" class="form-control material-unit-price" step="0.01" placeholder="0.00">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <label class="form-label">ä»•æ§˜ãƒ»è¦æ ¼</label>
                                        <input type="text" name="specification[]" class="form-control" placeholder="ä¾‹: 24-21-20">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è³‡æé …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ -->
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="addMaterialItem()">
                            <i class="fas fa-plus me-1"></i>è³‡æé …ç›®ã‚’è¿½åŠ 
                        </button>
                    </div>

                    <!-- åˆè¨ˆé‡‘é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ -->
                    <div class="mb-3">
                        <div class="alert alert-warning">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <strong><i class="fas fa-calculator me-1"></i>åˆè¨ˆé‡‘é¡:</strong>
                                </div>
                                <div class="col-md-6 text-end">
                                    <h4 class="mb-0" id="materialTotalAmount">Â¥0</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å‚™è€ƒ -->
                    <div class="mb-3">
                        <label for="materialNotes" class="form-label">
                            å‚™è€ƒ
                        </label>
                        <textarea class="form-control" id="materialNotes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-warning" onclick="saveMaterialOrder()">
                    <i class="fas fa-save me-1"></i>ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ¡ˆä»¶ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - Phase 5 (Only shown when editing existing project) -->
{% if project %}
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-folder-open me-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
                </h5>
                <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-light btn-sm">
                    <i class="fas fa-cloud-upload-alt me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if project.files.all %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">ç¨®åˆ¥</th>
                                <th width="35%">ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                <th width="15%">ã‚µã‚¤ã‚º</th>
                                <th width="20%">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è€…</th>
                                <th width="15%">æ—¥æ™‚</th>
                                <th width="10%" class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in project.files.all %}
                            <tr {% if file.is_linked_file %}class="table-info"{% endif %}>
                                <td>
                                    {% if file.is_linked_file %}
                                        <span class="badge bg-info" title="ãƒªãƒ³ã‚¯ãƒ•ã‚¡ã‚¤ãƒ«">
                                            <i class="fas fa-link"></i>
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success" title="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚¡ã‚¤ãƒ«">
                                            <i class="fas fa-upload"></i>
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.is_linked_file %}
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        <strong>{{ file.file_name }}</strong>
                                        <br><small class="text-muted ms-4">
                                            {% if file.linked_source_type == 'purchase_order' %}
                                                ç™ºæ³¨æ›¸ï¼ˆè¤‡æ•°æ¡ˆä»¶å«ã‚€ï¼‰
                                            {% elif file.linked_source_type == 'invoice' %}
                                                è«‹æ±‚æ›¸ï¼ˆè¤‡æ•°æ¡ˆä»¶å«ã‚€ï¼‰
                                            {% endif %}
                                        </small>
                                    {% else %}
                                        {% if 'pdf' in file.file_type %}
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                        {% elif 'word' in file.file_type or 'document' in file.file_type %}
                                            <i class="fas fa-file-word text-primary me-2"></i>
                                        {% elif 'excel' in file.file_type or 'spreadsheet' in file.file_type %}
                                            <i class="fas fa-file-excel text-success me-2"></i>
                                        {% elif 'image' in file.file_type or 'jpg' in file.file_type or 'png' in file.file_type %}
                                            <i class="fas fa-file-image text-info me-2"></i>
                                        {% else %}
                                            <i class="fas fa-file text-secondary me-2"></i>
                                        {% endif %}
                                        <strong>{{ file.file_name }}</strong>
                                        {% if file.description %}
                                            <br><small class="text-muted ms-4">{{ file.description }}</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not file.is_linked_file %}
                                        <span class="badge bg-light text-dark">{{ file.get_file_size_display }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.is_linked_file %}
                                        <span class="text-muted">è‡ªå‹•ãƒªãƒ³ã‚¯</span>
                                    {% elif file.uploaded_by %}
                                        <i class="fas fa-user-circle me-1"></i>{{ file.uploaded_by.get_full_name|default:file.uploaded_by.username }}
                                    {% else %}
                                        <span class="text-muted">ä¸æ˜</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.is_linked_file and file.linked_at %}
                                        <small>{{ file.linked_at|date:"Y/m/d H:i:s" }}</small>
                                    {% else %}
                                        <small>{{ file.uploaded_at|date:"Y/m/d H:i:s" }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if file.is_linked_file %}
                                        <a href="/media/{{ file.linked_source_file }}"
                                           class="btn btn-outline-primary btn-sm"
                                           target="_blank"
                                           title="PDFã‚’é–‹ã">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    {% else %}
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'order_management:project_file_download' project.pk file.pk %}"
                                               class="btn btn-outline-primary"
                                               title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <button type="button"
                                                    class="btn btn-outline-danger"
                                                    onclick="confirmFileDelete({{ file.pk }}, '{{ file.file_name }}')"
                                                    title="å‰Šé™¤">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p class="mb-2">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-info">
                        <i class="fas fa-cloud-upload-alt me-1"></i>æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰ -->
<div class="modal fade" id="staffManagementModalInvalid" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true" style="z-index: 1060; display: none !important;">

                                            <!-- å°‚é–€åˆ†é‡ -->
                                            <div class="mb-3">
                                                <label class="form-label">å°‚é–€åˆ†é‡</label>
                                                <input type="text" name="internal_specialties" class="form-control" id="internalSpecialties" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                                            </div>

                                            <!-- ç¨¼åƒçŠ¶æ³ -->
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="internal_is_active" id="internalIsActive" checked>
                                                    <label class="form-check-label" for="internalIsActive">
                                                        ç¨¼åƒä¸­
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å¾Œã§æ±ºå®šæƒ…å ± -->
                            <div class="row mb-4" id="later_info" style="display: none;">
                                <div class="col-md-12">
                                    <div class="alert alert-warning border-warning">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-clock text-warning me-2"></i>
                                            <strong>å¾Œã§æ±ºå®šï¼ˆè©³ç´°ç”»é¢ï¼‰</strong>
                                        </div>
                                        <small class="text-muted">
                                            è©³ç´°ç”»é¢ã§ã¯ä»¥ä¸‹ã®å®Ÿæ–½ä½“åˆ¶ã‹ã‚‰é¸æŠã§ãã¾ã™ï¼š
                                        </small>
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <div class="form-check mb-1">
                                                <input class="form-check-input" type="radio" disabled>
                                                <label class="form-check-label">
                                                    <i class="fas fa-building me-1"></i>å¤–æ³¨å…ˆã«ç™ºæ³¨
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" disabled>
                                                <label class="form-check-label">
                                                    <i class="fas fa-users me-1"></i>ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹
                                                </label>
                                            </div>
                                            <small class="text-muted d-block mt-2">
                                                â€¢ è¤‡æ•°ã®å¤–æ³¨å…ˆã¨ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®çµ„ã¿åˆã‚ã›ã‚‚å¯èƒ½<br>
                                                â€¢ å·¥ç¨‹ã”ã¨ã«ç•°ãªã‚‹å®Ÿæ–½ä½“åˆ¶ã‚’è¨­å®šå¯èƒ½
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffManagementModal" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffManagementModalLabel">
                    <i class="fas fa-users"></i> æ‹…å½“è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">æ‹…å½“è€…ä¸€è¦§</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewStaff()">
                        <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>éƒ¨ç½²</th>
                                <th>æ™‚çµ¦</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç·¨é›†/è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalTitle">æ‹…å½“è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    <div class="mb-3">
                        <label for="staffName" class="form-label">æ‹…å½“è€…å <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="staffName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staffDepartment" class="form-label">éƒ¨ç½²</label>
                        <input type="text" class="form-control" id="staffDepartment" name="department" placeholder="ä¾‹: æ–½å·¥éƒ¨">
                    </div>
                    <div class="mb-3">
                        <label for="staffHourlyRate" class="form-label">æ™‚çµ¦</label>
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control" id="staffHourlyRate" name="hourly_rate" placeholder="ä¾‹: 3000">
                            <span class="input-group-text">/æ™‚é–“</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="staffSpecialties" name="specialties" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="staffActive" name="active" checked>
                        <label class="form-check-label" for="staffActive">
                            æœ‰åŠ¹
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="salesStaffManagementModal" tabindex="-1" aria-labelledby="salesStaffManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="salesStaffManagementModalLabel">
                    <i class="fas fa-chart-line"></i> å–¶æ¥­æ‹…å½“è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">å–¶æ¥­æ‹…å½“è€…ä¸€è¦§</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="openAddSalesStaffModal()">
                        <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                    </button>
                </div>

                <!-- å–¶æ¥­æ‹…å½“è€…ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>éƒ¨ç½²</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="salesStaffTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- å®Ÿç¸¾æ¨ç§»ã‚°ãƒ©ãƒ•äºˆå®šåœ° (ç®¡ç†è€…ã®ã¿è¡¨ç¤º) -->
                {% if user.is_staff or user.is_superuser %}
                <div class="mt-4" style="opacity: 0.6;">
                    <h6 class="mb-3">å®Ÿç¸¾æ¨ç§»</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">åˆ©ç›Šç‡æ¨ç§»</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">æ¡ˆä»¶æ•°æ¨ç§»</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°è¦å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="addSalesStaffModal" tabindex="-1" aria-labelledby="addSalesStaffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSalesStaffModalLabel">
                    <i class="fas fa-user-plus"></i> æ–°è¦å–¶æ¥­æ‹…å½“è€…è¿½åŠ 
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSalesStaffForm">
                    <div class="mb-3">
                        <label for="salesStaffName" class="form-label">åå‰ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="salesStaffName" name="name" required placeholder="ä¾‹: ç”°ä¸­ å¤ªéƒ">
                    </div>
                    <div class="mb-3">
                        <label for="salesStaffDepartment" class="form-label">éƒ¨ç½² <span class="text-danger">*</span></label>
                        <select class="form-select" id="salesStaffDepartment" name="department" required>
                            <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
                            <option value="sales">å–¶æ¥­éƒ¨</option>
                            <option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="salesStaffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="salesStaffSpecialties" name="specialties" placeholder="ä¾‹: ä½å®…å–¶æ¥­ã€æ³•äººå–¶æ¥­">
                        <small class="form-text text-muted">ä»»æ„: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥åŠ›å¯</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="submitNewSalesStaff()">
                    <i class="fas fa-save"></i> è¿½åŠ 
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editSalesStaffModal" tabindex="-1" aria-labelledby="editSalesStaffModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSalesStaffModalLabel">
                    <i class="fas fa-user-edit"></i> å–¶æ¥­æ‹…å½“è€…ç·¨é›†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSalesStaffForm">
                    <input type="hidden" id="editSalesStaffId">
                    <div class="mb-3">
                        <label for="editSalesStaffName" class="form-label">åå‰ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editSalesStaffName" name="name" required placeholder="ä¾‹: ç”°ä¸­ å¤ªéƒ">
                    </div>
                    <div class="mb-3">
                        <label for="editSalesStaffDepartment" class="form-label">éƒ¨ç½² <span class="text-danger">*</span></label>
                        <select class="form-select" id="editSalesStaffDepartment" name="department" required>
                            <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
                            <option value="sales">å–¶æ¥­éƒ¨</option>
                            <option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSalesStaffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="editSalesStaffSpecialties" name="specialties" placeholder="ä¾‹: ä½å®…å–¶æ¥­ã€æ³•äººå–¶æ¥­">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editSalesStaffIsActive" name="is_active" checked>
                            <label class="form-check-label" for="editSalesStaffIsActive">
                                æœ‰åŠ¹
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="submitEditSalesStaff()">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteSalesStaffModal" tabindex="-1" aria-labelledby="deleteSalesStaffModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSalesStaffModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> å‰Šé™¤ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong id="deleteSalesStaffName"></strong>ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-circle"></i> ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </div>
                <input type="hidden" id="deleteSalesStaffId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteSalesStaff()">
                    <i class="fas fa-trash"></i> å‰Šé™¤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ±ç”¨å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> å‰Šé™¤ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" id="confirmDeleteMessage">ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-circle"></i> ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">
                    <i class="fas fa-trash"></i> å‰Šé™¤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="craftsmanManagementModal" tabindex="-1" aria-labelledby="craftsmanManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="craftsmanManagementModalLabel">
                    <i class="fas fa-tools"></i> è·äººç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">è·äººä¸€è¦§</h6>
                    <div class="d-flex gap-2">
                        <span class="badge bg-warning">â€» ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…äºˆå®š</span>
                        <button type="button" class="btn btn-primary btn-sm" onclick="toastr.info('æ–°è¦è¿½åŠ æ©Ÿèƒ½ã¯å¾Œæ—¥å®Ÿè£…äºˆå®šã§ã™')" disabled>
                            <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- è·äººã‚¹ã‚­ãƒ«ãƒ»å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive" style="opacity: 0.6;">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>è·ç¨®</th>
                                <th>ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>è³‡æ ¼</th>
                                <th>çµŒé¨“å¹´æ•°</th>
                                <th>å®Œäº†æ¡ˆä»¶æ•°</th>
                                <th>å¹³å‡è©•ä¾¡</th>
                                <th>æ™‚çµ¦å˜ä¾¡</th>
                                <th>ç¨¼åƒçŠ¶æ³</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>å±±ç”° è·äºº</strong></td>
                                <td>é›»æ°—å·¥äº‹å£«</td>
                                <td><span class="badge bg-success">ä¸Šç´š</span></td>
                                <td>é«˜åœ§é›»æ°—å·¥äº‹ã€åˆ¶å¾¡ç›¤</td>
                                <td>ç¬¬ä¸€ç¨®é›»æ°—å·¥äº‹å£«ã€é«˜åœ§é›»æ°—å·¥äº‹æŠ€å¸«</td>
                                <td>15å¹´</td>
                                <td><span class="badge bg-primary">245</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜†</span> 4.2</td>
                                <td><strong>Â¥4,500/æ™‚</strong></td>
                                <td><span class="badge bg-success">ç¨¼åƒä¸­</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>é«˜æ©‹ é…ç®¡</strong></td>
                                <td>é…ç®¡å·¥</td>
                                <td><span class="badge bg-info">ä¸­ç´š</span></td>
                                <td>çµ¦æ’æ°´é…ç®¡ã€ç©ºèª¿é…ç®¡</td>
                                <td>é…ç®¡æŠ€èƒ½å£«1ç´šã€ç®¡å·¥äº‹æ–½å·¥ç®¡ç†æŠ€å£«</td>
                                <td>8å¹´</td>
                                <td><span class="badge bg-primary">112</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜†</span> 3.8</td>
                                <td><strong>Â¥3,200/æ™‚</strong></td>
                                <td><span class="badge bg-warning">ç©ºã</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>ä¼Šè—¤ å¤§å·¥</strong></td>
                                <td>å¤§å·¥</td>
                                <td><span class="badge bg-success">ä¸Šç´š</span></td>
                                <td>æœ¨é€ å»ºç¯‰ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ã€å†…è£…</td>
                                <td>å»ºç¯‰å¤§å·¥æŠ€èƒ½å£«1ç´šã€å»ºç¯‰æ–½å·¥ç®¡ç†æŠ€å£«</td>
                                <td>20å¹´</td>
                                <td><span class="badge bg-primary">320</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜…</span> 4.7</td>
                                <td><strong>Â¥4,000/æ™‚</strong></td>
                                <td><span class="badge bg-success">ç¨¼åƒä¸­</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ã‚¹ã‚­ãƒ«çµ±è¨ˆ -->
                <div class="mt-4" style="opacity: 0.6;">
                    <h6 class="mb-3">ã‚¹ã‚­ãƒ«çµ±è¨ˆ</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">è·ç¨®åˆ¥åˆ†å¸ƒ</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">å††ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«åˆ†å¸ƒ</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">æ£’ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ç¨¼åƒçŠ¶æ³</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ç¨¼åƒçŠ¶æ³ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="contractorManagementModal" tabindex="-1" aria-labelledby="contractorManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 95vw; width: 95vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorManagementModalLabel">
                    <i class="fas fa-building"></i> æ¥­è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h6 class="mb-2">æ¥­è€…ä¸€è¦§</h6>
                        <div class="d-flex gap-3">
                            <span class="badge bg-primary bg-opacity-25 text-primary border border-primary">
                                <i class="fas fa-circle me-1"></i>å”åŠ›ä¼šç¤¾
                            </span>
                            <span class="badge bg-success bg-opacity-25 text-success border border-success">
                                <i class="fas fa-circle me-1"></i>å€‹äººè·äºº
                            </span>
                            <span class="badge bg-warning bg-opacity-25 text-warning border border-warning">
                                <i class="fas fa-circle me-1"></i>è³‡æå±‹
                            </span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" onclick="openAddContractorModal()">
                        <i class="fas fa-plus"></i> æ–°è¦æ¥­è€…è¿½åŠ 
                    </button>
                </div>

                <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" id="contractorSearch" class="form-control" placeholder="æ¥­è€…åãƒ»é›»è©±ãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢" onkeyup="filterContractors()">
                    </div>
                    <div class="col-md-3">
                        <select id="contractorTypeFilter" class="form-select" onchange="filterContractors()">
                            <option value="">å…¨ã‚¿ã‚¤ãƒ—</option>
                            <option value="company">å”åŠ›ä¼šç¤¾</option>
                            <option value="individual">å€‹äººè·äºº</option>
                            <option value="material">è³‡æå±‹</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="contractorStatusFilter" class="form-select" onchange="filterContractors()">
                            <option value="">å…¨çŠ¶æ…‹</option>
                            <option value="active">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
                            <option value="inactive">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearContractorFilters()">
                            <i class="fas fa-times"></i> ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>

                <!-- æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-hover contractor-table" style="table-layout: fixed; width: 100%;">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="width: 13%; cursor: pointer;" onclick="sortContractorTable('name')">
                                    æ¥­è€…å <i class="fas fa-sort"></i>
                                </th>
                                <th style="width: 10%;">æ¥­è€…ã‚¿ã‚¤ãƒ—</th>
                                <th style="width: 12%;">å°‚é–€åˆ†é‡</th>
                                <th style="width: 10%;">æ‹…å½“è€…</th>
                                <th style="width: 15%;">é€£çµ¡å…ˆ</th>
                                <th style="width: 15%;">æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«</th>
                                <th style="width: 8%; cursor: pointer;" onclick="sortContractorTable('status')">
                                    çŠ¶æ…‹ <i class="fas fa-sort"></i>
                                </th>
                                <th style="width: 8%;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="contractorTableBody">
                            <!-- æ¥­è€…æƒ…å ±ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ/orders/contractors/new/ ã¨åŒã˜ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ -->
<div class="modal fade" id="contractorModal" tabindex="-1" aria-labelledby="contractorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorModalTitle">æ¥­è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="contractorForm">
                    <input type="hidden" id="contractorId" name="id">

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div class="mb-3">
                        <label for="contractorName" class="form-label">æ¥­è€…å <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="contractorName" name="name" required>
                    </div>

                    <div class="mb-3">
                        <label for="contractorType" class="form-label">æ¥­è€…ç¨®åˆ¥ <span class="text-danger">*</span></label>
                        <select class="form-select" id="contractorType" name="contractor_type" required onchange="toggleModalHourlyRateField()">
                            <option value="">-- æ¥­è€…ç¨®åˆ¥ã‚’é¸æŠ --</option>
                            <option value="individual">å€‹äººè·äºº</option>
                            <option value="company">å”åŠ›ä¼šç¤¾</option>
                            <option value="material">è³‡æ</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="contractorAddress" class="form-label">ä½æ‰€</label>
                        <input type="text" class="form-control" id="contractorAddress" name="address">
                    </div>

                    <div class="mb-3">
                        <label for="contractorPhone" class="form-label">é›»è©±ç•ªå·</label>
                        <input type="tel" class="form-control" id="contractorPhone" name="phone">
                    </div>

                    <div class="mb-3">
                        <label for="contractorEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" class="form-control" id="contractorEmail" name="email">
                    </div>

                    <div class="mb-3">
                        <label for="contractorContactPerson" class="form-label">æ‹…å½“è€…å</label>
                        <input type="text" class="form-control" id="contractorContactPerson" name="contact_person">
                    </div>

                    <div class="mb-3" id="modalHourlyRateField" style="display: none;">
                        <label for="contractorHourlyRate" class="form-label">æ™‚çµ¦å˜ä¾¡ï¼ˆå††ï¼‰</label>
                        <input type="number" class="form-control" id="contractorHourlyRate" name="hourly_rate" min="0" step="100">
                        <small class="form-text text-muted">ä»»æ„: ã‚³ã‚¹ãƒˆè¨ˆç®—ç”¨ï¼ˆå€‹äººè·äººã®ã¿ï¼‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="contractorSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="contractorSpecialties" name="specialties" placeholder="ä¾‹: æœ¨é€ å»ºç¯‰ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ">
                        <small class="form-text text-muted">ä»»æ„: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥åŠ›å¯</small>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="contractorActive" name="is_active" checked>
                        <label class="form-check-label" for="contractorActive">
                            ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                        </label>
                    </div>

                    <!-- æ”¯æ‰•ã„æƒ…å ± -->
                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="fas fa-money-bill me-2"></i>æ”¯æ‰•ã„æƒ…å ±
                    </h6>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="contractorPaymentCycle" class="form-label">æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«</label>
                                <select class="form-select" id="contractorPaymentCycle" name="payment_cycle">
                                    <option value="">-- é¸æŠ --</option>
                                    <option value="monthly">æœˆæ‰•ã„</option>
                                    <option value="bimonthly">éš”æœˆæ‰•ã„</option>
                                    <option value="quarterly">å››åŠæœŸæ‰•ã„</option>
                                    <option value="custom">ãã®ä»–</option>
                                </select>
                                <small class="form-text text-muted">æœˆæ‰•ã„ã€éš”æœˆæ‰•ã„ãªã©</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="contractorClosingDay" class="form-label">ç· æ—¥</label>
                                <input type="number" class="form-control" id="contractorClosingDay" name="closing_day" min="1" max="31">
                                <small class="form-text text-muted">æ¯æœˆã®ç· æ—¥ï¼ˆ1-31ï¼‰</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="contractorPaymentOffsetMonths" class="form-label">æ”¯æ‰•æœˆ</label>
                                <select class="form-select" id="contractorPaymentOffsetMonths" name="payment_offset_months">
                                    <option value="">-- é¸æŠ --</option>
                                    <option value="0">å½“æœˆ</option>
                                    <option value="1">ç¿Œæœˆ</option>
                                    <option value="2">ç¿Œã€…æœˆ</option>
                                    <option value="3">3ãƒ¶æœˆå¾Œ</option>
                                </select>
                                <small class="form-text text-muted">å½“æœˆã€ç¿Œæœˆã€ç¿Œã€…æœˆãªã©</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="contractorPaymentDay" class="form-label">æ”¯æ‰•æ—¥</label>
                                <input type="number" class="form-control" id="contractorPaymentDay" name="payment_day" min="1" max="31">
                                <small class="form-text text-muted">æ¯æœˆã®æ”¯æ‰•æ—¥ï¼ˆ1-31ï¼‰</small>
                            </div>
                        </div>
                    </div>

                    <!-- éŠ€è¡Œå£åº§æƒ…å ± -->
                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="fas fa-university me-2"></i>éŠ€è¡Œå£åº§æƒ…å ±
                    </h6>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractorBankName" class="form-label">éŠ€è¡Œå</label>
                                <input type="text" class="form-control" id="contractorBankName" name="bank_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractorBranchName" class="form-label">æ”¯åº—å</label>
                                <input type="text" class="form-control" id="contractorBranchName" name="branch_name">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractorAccountType" class="form-label">å£åº§ç¨®åˆ¥</label>
                                <select class="form-select" id="contractorAccountType" name="account_type">
                                    <option value="">-- é¸æŠ --</option>
                                    <option value="ordinary">æ™®é€š</option>
                                    <option value="current">å½“åº§</option>
                                    <option value="savings">è²¯è“„</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractorAccountNumber" class="form-label">å£åº§ç•ªå·</label>
                                <input type="text" class="form-control" id="contractorAccountNumber" name="account_number">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="contractorAccountHolder" class="form-label">å£åº§åç¾©</label>
                        <input type="text" class="form-control" id="contractorAccountHolder" name="account_holder">
                        <small class="form-text text-muted">ä»»æ„: ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ï¼ˆä¾‹: ã‚«ï¼‰ãƒãƒ«ãƒãƒ«ã‚±ãƒ³ã‚»ãƒ„ï¼‰</small>
                    </div>

                    <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆè¿½åŠ æƒ…å ±ï¼‰ -->
                    {% if contractor_custom_fields_by_category %}
                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="fas fa-star me-2"></i>è¿½åŠ æƒ…å ±
                    </h6>

                    {% for cat_data in contractor_custom_fields_by_category %}
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h6 class="mb-0">{{ cat_data.category.name }}</h6>
                            {% if cat_data.category.description %}
                            <small class="text-muted">{{ cat_data.category.description }}</small>
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <div class="row">
                                {% for field in cat_data.fields %}
                                <div class="{% if field.definition.field_type == 'textarea' or field.definition.slug == 'has_wholesale_contract' %}col-md-12{% else %}col-md-6{% endif %} mb-3 {% if field.definition.slug == 'wholesale_contract_details' %}d-none{% endif %} {% if field.definition.slug == 'scaffolding_whole_house_cost' %}d-none{% endif %}"
                                     {% if field.definition.slug == 'wholesale_contract_details' %}id="modal_wholesale_contract_details_wrapper"{% endif %}
                                     {% if field.definition.slug == 'scaffolding_whole_house_cost' %}id="modal_scaffolding_whole_house_cost_wrapper"{% endif %}>
                                    {% if field.definition.field_type == 'text' %}
                                        <label class="form-label">
                                            {{ field.definition.name }}
                                            {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        <input type="text"
                                               name="custom_{{ field.definition.slug }}"
                                               id="modal_custom_{{ field.definition.slug }}"
                                               class="form-control"
                                               value="{{ field.current_value }}"
                                               placeholder="{{ field.definition.placeholder }}"
                                               {% if field.definition.is_required %}required{% endif %}>
                                        {% if field.definition.help_text %}
                                            <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                        {% endif %}

                                    {% elif field.definition.field_type == 'number' %}
                                        <label class="form-label">
                                            {{ field.definition.name }}
                                            {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        <input type="number"
                                               name="custom_{{ field.definition.slug }}"
                                               id="modal_custom_{{ field.definition.slug }}"
                                               class="form-control"
                                               value="{{ field.current_value }}"
                                               placeholder="{{ field.definition.placeholder }}"
                                               {% if field.definition.min_value %}min="{{ field.definition.min_value }}"{% endif %}
                                               {% if field.definition.max_value %}max="{{ field.definition.max_value }}"{% endif %}
                                               {% if field.definition.is_required %}required{% endif %}>
                                        {% if field.definition.help_text %}
                                            <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                        {% endif %}

                                    {% elif field.definition.field_type == 'date' %}
                                        <label class="form-label">
                                            {{ field.definition.name }}
                                            {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        <input type="date"
                                               name="custom_{{ field.definition.slug }}"
                                               id="modal_custom_{{ field.definition.slug }}"
                                               class="form-control"
                                               value="{{ field.current_value }}"
                                               {% if field.definition.is_required %}required{% endif %}>
                                        {% if field.definition.help_text %}
                                            <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                        {% endif %}

                                    {% elif field.definition.field_type == 'textarea' %}
                                        <label class="form-label">
                                            {{ field.definition.name }}
                                            {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        <textarea name="custom_{{ field.definition.slug }}"
                                                  id="modal_custom_{{ field.definition.slug }}"
                                                  class="form-control"
                                                  rows="3"
                                                  placeholder="{{ field.definition.placeholder }}"
                                                  {% if field.definition.is_required %}required{% endif %}>{{ field.current_value }}</textarea>
                                        {% if field.definition.help_text %}
                                            <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                        {% endif %}

                                    {% elif field.definition.field_type == 'select' %}
                                        <label class="form-label">
                                            {{ field.definition.name }}
                                            {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                        </label>
                                        <select name="custom_{{ field.definition.slug }}"
                                                id="modal_custom_{{ field.definition.slug }}"
                                                class="form-select"
                                                {% if field.definition.is_required %}required{% endif %}>
                                            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                            {% for choice in field.definition.choices %}
                                                <option value="{{ choice }}" {% if field.current_value == choice %}selected{% endif %}>
                                                    {{ choice }}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        {% if field.definition.help_text %}
                                            <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                        {% endif %}

                                    {% elif field.definition.field_type == 'multiselect' %}
                                        <label class="form-label d-block">
                                            {{ field.definition.name }}
                                            {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                        </label>

                                        {% if field.definition.slug == 'service_areas' or field.definition.slug == 'travel_expense_areas' %}
                                            <!-- åœ°æ–¹ã”ã¨ã®ä¸€æ‹¬é¸æŠæ©Ÿèƒ½ä»˜ãè¡¨ç¤º -->
                                            <div class="checkbox-group-regions" id="modal_{{ field.definition.slug }}_container">
                                                {% for region, prefectures in regions_mapping.items %}
                                                <div class="region-group mb-2 border-start border-primary border-3 ps-2">
                                                    <div class="form-check mb-1">
                                                        <input type="checkbox"
                                                               class="form-check-input region-toggle"
                                                               id="modal_region_{{ field.definition.slug }}_{{ forloop.counter }}"
                                                               data-region="{{ region }}"
                                                               data-field-slug="modal_{{ field.definition.slug }}"
                                                               onchange="toggleModalRegionPrefectures(this)">
                                                        <label class="form-check-label fw-bold" for="modal_region_{{ field.definition.slug }}_{{ forloop.counter }}">
                                                            <i class="fas fa-map-marked-alt me-1"></i>{{ region }}ï¼ˆå…¨é¸æŠ/è§£é™¤ï¼‰
                                                        </label>
                                                    </div>
                                                    <div class="prefecture-checkboxes ps-3" style="max-height: 150px; overflow-y: auto;">
                                                        {% for prefecture in prefectures %}
                                                        <div class="form-check form-check-inline">
                                                            <input type="checkbox"
                                                                   class="form-check-input prefecture-checkbox"
                                                                   name="custom_{{ field.definition.slug }}"
                                                                   value="{{ prefecture }}"
                                                                   id="modal_custom_{{ field.definition.slug }}_{{ prefecture }}"
                                                                   data-region="{{ region }}"
                                                                   data-field-slug="modal_{{ field.definition.slug }}"
                                                                   {% if prefecture in field.current_value %}checked{% endif %}>
                                                            <label class="form-check-label" for="modal_custom_{{ field.definition.slug }}_{{ prefecture }}">
                                                                {{ prefecture }}
                                                            </label>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% else %}
                                            <!-- é€šå¸¸ã®multiselectè¡¨ç¤º -->
                                            <div class="checkbox-group">
                                                {% for choice in field.definition.choices %}
                                                <div class="form-check form-check-inline">
                                                    <input type="checkbox"
                                                           class="form-check-input"
                                                           name="custom_{{ field.definition.slug }}"
                                                           value="{{ choice }}"
                                                           id="modal_custom_{{ field.definition.slug }}_{{ forloop.counter }}"
                                                           {% if choice in field.current_value %}checked{% endif %}>
                                                    <label class="form-check-label" for="modal_custom_{{ field.definition.slug }}_{{ forloop.counter }}">
                                                        {{ choice }}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                        {% endif %}

                                        {% if field.definition.help_text %}
                                            <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                        {% endif %}

                                    {% elif field.definition.field_type == 'checkbox' %}
                                        <div class="form-check">
                                            <input type="checkbox"
                                                   name="custom_{{ field.definition.slug }}"
                                                   id="modal_custom_{{ field.definition.slug }}"
                                                   class="form-check-input"
                                                   {% if field.current_value %}checked{% endif %}>
                                            <label class="form-check-label">
                                                {{ field.definition.name }}
                                            </label>
                                        </div>
                                        {% if field.definition.help_text %}
                                            <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                        {% endif %}
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveContractor()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Sortable.js for drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Phase 2.2ã§è¿½åŠ : contractorsãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
window.contractors_json = {{ contractors_json|safe }};
console.log('âœ… contractors_json loaded:', window.contractors_json ? window.contractors_json.length : 0, 'contractors');

// ãƒ•ã‚©ãƒ¼ãƒ å¤‰æ›´çŠ¶æ…‹ã®ç®¡ç†
let formChanged = false;
let originalFormData = {};
let hasFormBeenModified = false; // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ãƒ©ã‚°

// ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã‚’ä¿å­˜
function saveOriginalFormData() {
    const form = document.querySelector('form');
    if (!form) return;

    const formData = new FormData(form);
    originalFormData = {};
    for (let [key, value] of formData.entries()) {
        originalFormData[key] = value;
    }
    console.log('Original form data saved:', Object.keys(originalFormData).length, 'fields');
}

// ãƒ•ã‚©ãƒ¼ãƒ ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
function checkFormChanges() {
    const form = document.querySelector('form');
    if (!form) return false;

    const currentFormData = new FormData(form);
    let hasChanges = false;

    // ç¾åœ¨ã®å€¤ã¨åˆæœŸå€¤ã‚’æ¯”è¼ƒ
    for (let [key, value] of currentFormData.entries()) {
        if (originalFormData[key] !== value) {
            hasChanges = true;
            break;
        }
    }

    // å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒã‚§ãƒƒã‚¯
    if (!hasChanges) {
        for (let key in originalFormData) {
            if (!currentFormData.has(key)) {
                hasChanges = true;
                break;
            }
        }
    }

    return hasChanges;
}

// ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
function updateButtonText() {
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const isEdit = {{ project|yesno:"true,false" }};

    if (!isEdit) return; // æ–°è¦ä½œæˆã®å ´åˆã¯å¤‰æ›´ã—ãªã„

    const hasChanges = checkFormChanges();

    if (hasChanges) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> æ¡ˆä»¶ã‚’æ›´æ–°';
        submitBtn.className = 'btn btn-warning btn-lg me-3';
        submitBtn.disabled = false;
        formChanged = true;
    } else {
        submitBtn.innerHTML = '<i class="fas fa-check"></i> ä¿å­˜æ¸ˆã¿';
        submitBtn.className = 'btn btn-success btn-lg me-3';
        submitBtn.disabled = true;
        formChanged = false;
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æˆåŠŸæ™‚ã®å‡¦ç†
function handleFormSubmitSuccess() {
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    submitBtn.innerHTML = '<i class="fas fa-check"></i> æ›´æ–°å®Œäº†';
    submitBtn.className = 'btn btn-success btn-lg me-3';
    submitBtn.disabled = true;

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’ã€Œæˆ»ã‚‹ã€ã«å¤‰æ›´
    cancelBtn.innerHTML = '<i class="fas fa-arrow-left"></i> æˆ»ã‚‹';

    // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ï¼ˆé€ä¿¡æˆåŠŸãªã®ã§ä¸è¦ï¼‰
    clearSavedFormValues();

    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
    setTimeout(() => {
        saveOriginalFormData(); // æ–°ã—ã„çŠ¶æ…‹ã‚’åˆæœŸå€¤ã¨ã—ã¦ä¿å­˜
        updateButtonText();
    }, 2000);
}

$(document).ready(function() {
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãŒå®Œå…¨ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§ï¼‰
    setTimeout(function() {
        // åˆæœŸå€¤ã‚’ä¿å­˜
        saveOriginalFormData();

        // åˆæœŸçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        updateButtonText();

        // ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ï¼‰
        const isEdit = {{ project|yesno:"true,false" }};

        if (isEdit) {
            // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’ç›´æ¥å–å¾—ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const $form = $('form');

            // ãƒ•ã‚©ãƒ¼ãƒ å†…ã®å…¨è¦ç´ ã«ç›´æ¥ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            $form.find('input, select, textarea').on('input change', function(e) {
                // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰æ›´æ–°ï¼ˆé€£ç¶šã—ãŸå¤‰æ›´ã‚’ã¾ã¨ã‚ã‚‹ï¼‰
                clearTimeout(window.formChangeTimeout);
                window.formChangeTimeout = setTimeout(function() {
                    updateButtonText();
                }, 100);
            });
        }
    }, 100);

    // å—æ³¨ãƒ¨ãƒŸã®å¤‰æ›´ã‚’å‡¦ç†ï¼ˆNGæ™‚ã®é€²æ—ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã®ãŸã‚ï¼‰
    $('select[name="project_status"]').on('change', function(e) {
        const projectId = {{ project.pk|default:"null" }};
        const newValue = $(this).val();

        // æ–°è¦ä½œæˆã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (!projectId) {
            return;
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€NGã«å¤‰æ›´ã—ãŸæ™‚ã®ã¿å³åº§ã«AJAXä¿å­˜
        // ï¼ˆé€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ï¼‰
        if (newValue === 'NG') {
            const csrfToken = $('[name=csrfmiddlewaretoken]').val();

            $.ajax({
                url: '/orders/' + projectId + '/update-forecast/',
                method: 'POST',
                data: {
                    project_status: newValue,
                    csrfmiddlewaretoken: csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        // åˆæœŸå€¤ã‚’æ›´æ–°
                        originalFormData['project_status'] = newValue;
                        // ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                        updateButtonText();
                        toastr.warning('NGã«è¨­å®šã—ã€é–¢é€£ã™ã‚‹é€²æ—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                    } else {
                        toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                    }
                },
                error: function() {
                    toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            });
        }
        // NGä»¥å¤–ã®å ´åˆã¯ã€é€šå¸¸ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã§ä¿å­˜
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
    $('#projectForm').on('submit', function(e) {
        e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡ã‚’é˜²ã

        const form = this;
        const submitBtn = document.getElementById('submitBtn');

        // HTML5ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯
        if (!form.checkValidity()) {
            // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’å–å¾—
            const invalidFields = Array.from(form.querySelectorAll(':invalid'));
            const fieldNames = invalidFields.map(field => {
                const label = form.querySelector(`label[for="${field.id}"]`);
                return label ? label.textContent.replace(/\s*\*\s*$/, '').trim() : field.name;
            }).filter(name => name);

            showErrorMessage(`å…¥åŠ›ã‚¨ãƒ©ãƒ¼: ä»¥ä¸‹ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nâ€¢ ${fieldNames.join('\nâ€¢ ')}`);

            // æœ€åˆã®ç„¡åŠ¹ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
            if (invalidFields.length > 0) {
                invalidFields[0].focus();
            }

            return false;
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ï¼‰
        if (typeof updateFormScheduleData === 'function') {
            updateFormScheduleData();
            console.log('ğŸ“‹ ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ï¼‰');
        }

        const formData = new FormData(form);

        // é€ä¿¡ä¸­ã®è¡¨ç¤º
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
        submitBtn.disabled = true;

        // AJAXé€ä¿¡
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ãªã„å ´åˆã®å‡¦ç†
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    // HTMLãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®å ´åˆã€ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(text, 'text/html');
                    const errorTitle = doc.querySelector('h1')?.textContent || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼';
                    const errorDetail = doc.querySelector('.exception_value')?.textContent || '';

                    let errorMessage = `${errorTitle}`;
                    if (errorDetail) {
                        errorMessage += `: ${errorDetail}`;
                    }

                    throw new Error(errorMessage);
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // æˆåŠŸæ™‚ã®å‡¦ç†
                handleFormSubmitSuccess();

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                if (data.message) {
                    // Bootstrap toast ã¾ãŸã¯ alert ã§æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    showSuccessMessage(data.message);
                }

                // 2ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                setTimeout(() => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    }
                }, 2000);
            } else {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                submitBtn.className = 'btn btn-danger btn-lg me-3';
                submitBtn.disabled = false;

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorMessage = data.message || 'ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (data.errors) {
                    console.log('Form errors:', data.errors);
                    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                    const errorDetails = Object.entries(data.errors).map(([field, errors]) =>
                        `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`
                    ).join('\n');
                    errorMessage += '\nè©³ç´°:\n' + errorDetails;
                }
                showErrorMessage(errorMessage);

                // 3ç§’å¾Œã«å…ƒã«æˆ»ã™
                setTimeout(() => {
                    updateButtonText();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> é€šä¿¡ã‚¨ãƒ©ãƒ¼';
            submitBtn.className = 'btn btn-danger btn-lg me-3';
            submitBtn.disabled = false;

            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            showErrorMessage(`ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);

            // 3ç§’å¾Œã«å…ƒã«æˆ»ã™
            setTimeout(() => {
                updateButtonText();
            }, 3000);
        });
    });

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showSuccessMessage(message) {
        // ç°¡å˜ãªã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦Bootstrap toastã«å¤‰æ›´å¯èƒ½ï¼‰
        const alertDiv = $(`
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('.container').first().prepend(alertDiv);

        // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            alertDiv.alert('close');
        }, 5000);
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showErrorMessage(message) {
        const alertDiv = $(`
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('.container').first().prepend(alertDiv);

        // 10ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            alertDiv.alert('close');
        }, 10000);
    }
});
</script>
<script>
console.log('ğŸ”¥ JavaScript loading...');

// å¿…é ˆé–¢æ•°ã‚’å®šç¾©
window.openBasicInfoContractorManagementPanel = function() {
    console.log('âœ… openBasicInfoContractorManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#contractorManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆå—æ³¨æ¥­è€…å„ªå…ˆï¼‰
            refreshContractorListForBasicInfo();

            console.log('âœ… æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ contractorManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.openAddImplementationModal = function() {
    console.log('âœ… openAddImplementationModal called');

    // project_idã‚’ç¢ºèª
    const projectId = $('input[name="project_id"]').val();

    // project_idãŒãªã„å ´åˆã¯ã€å…ˆã«ä¸‹æ›¸ãä¿å­˜ã‚’å®Ÿè¡Œ
    if (!projectId) {
        console.log('âš ï¸ Project ID not found. Saving draft first...');

        // ä¸‹æ›¸ãä¿å­˜ã‚’å®Ÿè¡Œ
        updateAutoSaveStatus('ä¿å­˜ä¸­...', 'saving');
        const formData = new FormData($('#projectForm')[0]);
        const saveUrl = "{% url 'order_management:project_save_as_draft' %}";
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        fetch(saveUrl, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.project_id) {
                // project_idã‚’è¨­å®š
                $('input[name="project_id"]').val(data.project_id);

                // URLã‚’æ›´æ–°
                const newUrl = `/orders/${data.project_id}/update/`;
                window.history.replaceState({}, '', newUrl);

                updateAutoSaveStatus('ä¿å­˜å®Œäº†', 'success');
                console.log('âœ… Project saved. ID:', data.project_id);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã‚’ç¶šè¡Œ
                openAddImplementationModalContinue();
            } else {
                updateAutoSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
                toastr.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        })
        .catch(error => {
            updateAutoSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
            toastr.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            console.error('Save error:', error);
        });

        return; // ä¿å­˜å®Œäº†å¾Œã«å†åº¦å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§çµ‚äº†
    }

    openAddImplementationModalContinue();
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ï¼ˆæœ¬ä½“ï¼‰
function openAddImplementationModalContinue() {
    console.log('âœ… openAddImplementationModalContinue called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modalElement = document.getElementById('addImplementationModal');
        if (modalElement) {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            clearImplementationModalForms();

            // åˆæœŸçŠ¶æ…‹ã‚’å¤–æ³¨å…ˆã«è¨­å®š
            $('input[name="modal_implementation_type"][value="outsource"]').prop('checked', true);
            toggleImplementationType();

            // æ¥­è€…é¸æŠæ–¹æ³•ã‚’æ—¢å­˜ã‹ã‚‰é¸æŠã«åˆæœŸè¨­å®š
            $('input[name="modal_contractor_input_type"][value="existing"]').prop('checked', true);
            toggleContractorInputType();

            // ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•ã‚’æ—¢å­˜ã‹ã‚‰é¸æŠã«åˆæœŸè¨­å®š
            $('input[name="modal_internal_input_type"][value="existing"]').prop('checked', true);
            toggleInternalInputType();

            // å—æ³¨é‡‘é¡ã‚’åŸºæœ¬æƒ…å ±ã‚¿ãƒ–ã‹ã‚‰å–å¾—ã—ã¦åˆ©ç›Šç‡åˆ†æã«åæ˜ 
            const orderAmountInput = document.getElementById('{{ form.order_amount.id_for_label }}');
            if (orderAmountInput && orderAmountInput.value) {
                const orderAmount = parseFloat(orderAmountInput.value) || 0;
                const modalProjectOrderAmountElement = document.getElementById('modalProjectOrderAmount');
                if (modalProjectOrderAmountElement) {
                    modalProjectOrderAmountElement.textContent = orderAmount.toLocaleString();
                    console.log('âœ“ å—æ³¨é‡‘é¡ã‚’åæ˜ :', orderAmount);
                }
            }

            // Bootstrap Modal APIã‚’ä½¿ã£ã¦é–‹ãï¼ˆã“ã‚Œã«ã‚ˆã‚Šshown.bs.modalã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã™ã‚‹ï¼‰
            const bsModal = new bootstrap.Modal(modalElement);
            bsModal.show();

            console.log('âœ… å®Ÿæ–½ä½“åˆ¶ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ addImplementationModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.closeModal = function(modalId) {
    if (modalId) {
        $(`#${modalId}`).removeClass('show').css('display', 'none');
    } else {
        $('.modal').removeClass('show').css('display', 'none');
    }
    $('.modal-backdrop').remove();

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
    $('body').removeClass('modal-open').css('overflow', '');

    console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ:', modalId || 'all');
};

// è¿½åŠ ã®å¿…é ˆé–¢æ•°ã‚’å®šç¾©
window.openSalesStaffManagementPanel = function() {
    console.log('âœ… openSalesStaffManagementPanel called');

    try {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modalElement = document.getElementById('salesStaffManagementModal');
        if (modalElement) {
            // Bootstrap Modal APIã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true
            });
            modal.show();

            // å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            refreshSalesStaffList();

            console.log('âœ… å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ salesStaffManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.refreshSalesStaffList = function() {
    console.log('âœ… refreshSalesStaffList called');

    // jQueryãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded in refreshSalesStaffList');
        return;
    }

    const tbody = $('#salesStaffTableBody');
    tbody.html('<tr><td colspan="5" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td></tr>');

    // AJAXã§æœ€æ–°ã®å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    $.ajax({
        url: '{% url "order_management:staff_api" %}',
        method: 'GET',
        success: function(response) {
            if (response.success && response.workers) {
                // å–¶æ¥­æ‹…å½“è€…ï¼ˆdepartment ãŒ sales ã¾ãŸã¯ marketingï¼‰ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
                const salesStaff = response.workers.filter(worker =>
                    worker.department === 'sales' || worker.department === 'marketing'
                );

                if (salesStaff.length === 0) {
                    tbody.html('<tr><td colspan="5" class="text-center text-muted">å–¶æ¥­æ‹…å½“è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>');
                    return;
                }

                let html = '';
                salesStaff.forEach(function(staff) {
                    const departmentDisplay = staff.department === 'sales' ? 'å–¶æ¥­éƒ¨' :
                                             staff.department === 'marketing' ? 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨' : staff.department;
                    const statusBadge = staff.is_active ?
                        '<span class="badge bg-success">æœ‰åŠ¹</span>' :
                        '<span class="badge bg-secondary">ç„¡åŠ¹</span>';
                    const specialties = staff.specialties || '-';

                    html += `
                        <tr style="cursor: pointer;" onclick="selectSalesStaff(${staff.id})" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                            <td><strong>${staff.name}</strong></td>
                            <td>${departmentDisplay}</td>
                            <td>${specialties}</td>
                            <td>${statusBadge}</td>
                            <td onclick="event.stopPropagation()">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editSalesStaff(${staff.id})" title="ç·¨é›†">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.html(html);
                console.log('âœ… å–¶æ¥­æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ:', salesStaff.length + 'ä»¶');
            } else {
                tbody.html('<tr><td colspan="5" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>');
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);
            tbody.html('<tr><td colspan="5" class="text-center text-danger">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td></tr>');
        }
    });
};

// å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
window.selectSalesStaff = function(staffId) {
    console.log('âœ… selectSalesStaff called', staffId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆBootstrap Modal APIã‚’ä½¿ç”¨ï¼‰
    const modalElement = document.getElementById('salesStaffManagementModal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«é¸æŠã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹IDãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const selectElement = $('#salesManagerSelect');
    const existingOption = selectElement.find(`option[value="${staffId}"]`);

    if (existingOption.length === 0) {
        // å­˜åœ¨ã—ãªã„å ´åˆã€APIã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¿½åŠ 
        console.log('âš ï¸ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«å–¶æ¥­æ‹…å½“è€…ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å–å¾—ä¸­...', staffId);

        $.ajax({
            url: '{% url "order_management:staff_api" %}',
            method: 'GET',
            success: function(response) {
                if (response.success && response.workers) {
                    // é¸æŠã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å–¶æ¥­æ‹…å½“è€…ã‚’æ¢ã™
                    const staff = response.workers.find(w => w.id == staffId);
                    if (staff) {
                        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
                        const newOption = $('<option></option>')
                            .val(staff.id)
                            .text(staff.name)
                            .data('name', staff.name)
                            .data('department', staff.department)
                            .data('hourly-rate', staff.hourly_rate);

                        selectElement.append(newOption);
                        selectElement.val(staffId).trigger('change');

                        console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ã—ã¦é¸æŠã—ã¾ã—ãŸ:', staff.name);
                    } else {
                        console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ:', staffId);
                        toastr.error('å–¶æ¥­æ‹…å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);
                toastr.error('å–¶æ¥­æ‹…å½“è€…ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
    } else {
        // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯é€šå¸¸é€šã‚Šé¸æŠ
        selectElement.val(staffId).trigger('change');
        console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¾ã—ãŸ:', staffId);
    }
};

window.openAddSalesStaffModal = function() {
    console.log('âœ… openAddSalesStaffModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢/ãƒªã‚»ãƒƒãƒˆ
    const form = document.getElementById('addSalesStaffForm');
    if (form) form.reset();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modalElement = document.getElementById('addSalesStaffModal');
    const modal = new bootstrap.Modal(modalElement);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã€backdropã®z-indexã‚’èª¿æ•´
    modalElement.addEventListener('shown.bs.modal', function() {
        // æœ€å¾Œã«è¿½åŠ ã•ã‚ŒãŸbackdropï¼ˆã“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã®backdropï¼‰ã®z-indexã‚’èª¿æ•´
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            const lastBackdrop = backdrops[backdrops.length - 1];
            lastBackdrop.style.zIndex = '10040';
        }
    }, { once: true });

    modal.show();
};

window.submitNewSalesStaff = function() {
    console.log('âœ… submitNewSalesStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const nameEl = document.getElementById('salesStaffName');
    const departmentEl = document.getElementById('salesStaffDepartment');
    const hourlyRateEl = document.getElementById('salesStaffHourlyRate');
    const specialtiesEl = document.getElementById('salesStaffSpecialties');

    const name = nameEl ? nameEl.value.trim() : '';
    const department = departmentEl ? departmentEl.value : '';
    const hourlyRateStr = hourlyRateEl ? hourlyRateEl.value : '';
    const hourlyRate = hourlyRateStr ? parseFloat(hourlyRateStr) : 0;
    const specialties = specialtiesEl ? specialtiesEl.value.trim() : '';

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name) {
        if (typeof toastr !== 'undefined') {
            toastr.error('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        } else {
            alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
        return;
    }

    if (!department) {
        if (typeof toastr !== 'undefined') {
            toastr.error('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        } else {
            alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        }
        return;
    }

    // æ–°è¦å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ 
    addNewSalesStaff({
        name: name,
        department: department,
        hourly_rate: hourlyRate,
        specialties: specialties
    });
};

window.addNewSalesStaff = function(staffData) {
    console.log('âœ… addNewSalesStaff called', staffData);

    // jQueryãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
        console.error('jQuery is not loaded');
        alert('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        return;
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ–°è¦å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ï¼ˆAJAXï¼‰
    $.ajax({
        url: '{% url "subcontract_management:add_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            name: staffData.name,
            department: staffData.department,
            hourly_rate: staffData.hourly_rate,
            specialties: staffData.specialties,
            is_active: true
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('addSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${staffData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                refreshSalesStaffList();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«æ–°ã—ã„å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
                const newStaffId = response.staff_id;
                const newOption = $('<option></option>')
                    .val(newStaffId)
                    .text(staffData.name)
                    .data('name', staffData.name)
                    .data('department', staffData.department)
                    .data('hourly-rate', staffData.hourly_rate);

                $('#salesManagerSelect').append(newOption);

                // æ–°ã—ãè¿½åŠ ã—ãŸå–¶æ¥­æ‹…å½“è€…ã‚’è‡ªå‹•é¸æŠ
                $('#salesManagerSelect').val(newStaffId).trigger('change');

                console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ã—ã€è‡ªå‹•é¸æŠã—ã¾ã—ãŸ');
            } else {
                toastr.error(response.message || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†
window.editSalesStaff = function(staffId) {
    console.log('âœ… editSalesStaff called for ID:', staffId);

    // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const allInternalWorkers = {{ internal_workers_json|safe }};
    const staff = allInternalWorkers.find(w => w.id === staffId);

    if (!staff) {
        toastr.error('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    $('#editSalesStaffId').val(staff.id);
    $('#editSalesStaffName').val(staff.name);
    $('#editSalesStaffDepartment').val(staff.department);
    $('#editSalesStaffHourlyRate').val(staff.hourly_rate || '');
    $('#editSalesStaffSpecialties').val(staff.specialties || '');
    $('#editSalesStaffIsActive').prop('checked', staff.is_active);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('editSalesStaffModal'));
    modal.show();
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ã‚’ä¿å­˜
window.submitEditSalesStaff = function() {
    console.log('âœ… submitEditSalesStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const staffId = $('#editSalesStaffId').val();
    const name = $('#editSalesStaffName').val().trim();
    const department = $('#editSalesStaffDepartment').val();
    const hourlyRateStr = $('#editSalesStaffHourlyRate').val();
    const hourlyRate = hourlyRateStr ? parseFloat(hourlyRateStr) : 0;
    const specialties = $('#editSalesStaffSpecialties').val().trim();
    const isActive = $('#editSalesStaffIsActive').is(':checked');

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name) {
        toastr.error('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    if (!department) {
        toastr.error('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    $.ajax({
        url: '{% url "subcontract_management:update_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            staff_id: staffId,
            name: name,
            department: department,
            hourly_rate: hourlyRate,
            specialties: specialties,
            is_active: isActive
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('editSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${name}ã®æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(response.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
window.deleteSalesStaff = function(staffId, staffName) {
    console.log('âœ… deleteSalesStaff called for ID:', staffId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    $('#deleteSalesStaffId').val(staffId);
    $('#deleteSalesStaffName').text(staffName);

    // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('deleteSalesStaffModal'));
    modal.show();
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ã‚’å®Ÿè¡Œ
window.confirmDeleteSalesStaff = function() {
    console.log('âœ… confirmDeleteSalesStaff called');

    const staffId = $('#deleteSalesStaffId').val();
    const staffName = $('#deleteSalesStaffName').text();

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    $.ajax({
        url: '{% url "subcontract_management:delete_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            staff_id: staffId
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${staffName}ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(response.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

window.openContractorManagementPanel = function() {
    console.log('âœ… openContractorManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#contractorManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆç™ºæ³¨æ¥­è€…å„ªå…ˆï¼‰
            refreshContractorListForImplementation();

            console.log('âœ… å·¥äº‹æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ contractorManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('å·¥äº‹æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.openCraftsmanManagementPanel = function() {
    console.log('âœ… openCraftsmanManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#craftsmanManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // è·äººãƒªã‚¹ãƒˆã‚’æ›´æ–°
            refreshCraftsmanList();

            console.log('âœ… è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ craftsmanManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.addImplementationItem = function(closeModal = true) {
    console.log('âœ… addImplementationItem called, closeModal:', closeModal);

    const implementationType = $('input[name="modal_implementation_type"]:checked').val();

    if (!implementationType) {
        toastr.warning('å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    let itemData = {
        type: implementationType,
        id: Date.now() // ç°¡æ˜“çš„ãªID
    };

    if (implementationType === 'outsource') {
        // å¤–æ³¨å…ˆã®æƒ…å ±ã‚’å–å¾—
        const contractorInputType = $('input[name="modal_contractor_input_type"]:checked').val();
        let contractorName = '';

        if (contractorInputType === 'existing') {
            // æ—¢å­˜æ¥­è€…ã‹ã‚‰é¸æŠ
            const selectedOption = $('#modalContractorSelect option:selected');
            contractorName = selectedOption.data('name') || selectedOption.text();
        } else {
            // æ–°è¦æ¥­è€…
            contractorName = $('input[name="modal_new_client_name"]').val();
        }

        const workDescription = $('textarea[name="modal_work_description"]').val();
        const contractAmount = $('input[name="modal_contract_amount"]').val();

        if (!contractorName || !workDescription) {
            toastr.warning('æ¥­è€…åã¨ä½œæ¥­å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        itemData.contractorName = contractorName;
        itemData.workDescription = workDescription;
        itemData.contractAmount = contractAmount || 0;
        itemData.additionalCosts = [...window.modalAdditionalCosts];
        itemData.additionalCostTotal = window.modalAdditionalCosts.reduce((sum, item) => sum + item.amount, 0);

    } else if (implementationType === 'internal') {
        // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®æƒ…å ±ã‚’å–å¾—
        const internalInputType = $('input[name="modal_internal_input_type"]:checked').val();
        let staffName = '';
        let department = '';

        if (internalInputType === 'existing') {
            // æ—¢å­˜æ‹…å½“è€…ã‹ã‚‰é¸æŠ
            const selectedOption = $('#modalInternalSelect option:selected');
            staffName = selectedOption.data('name') || selectedOption.text();
            department = selectedOption.data('department') || '';
        } else {
            // æ–°è¦æ‹…å½“è€…
            staffName = $('input[name="modal_new_internal_name"]').val();
            department = $('input[name="modal_internal_department"]').val();
        }

        if (!staffName) {
            toastr.warning('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        itemData.staffName = staffName;
        itemData.department = department;

    } else if (implementationType === 'later') {
        itemData.description = 'å¾Œã§æ±ºå®š';
    }

    // å®Ÿæ–½ä½“åˆ¶ãƒªã‚¹ãƒˆã«è¿½åŠ 
    addToImplementationList(itemData);

    if (closeModal) {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        $('#addImplementationModal').removeClass('show').css('display', 'none');
        $('.modal-backdrop').remove();
        $('body').removeClass('modal-open').css('overflow', '');
        toastr.success('å®Ÿæ–½ä½“åˆ¶ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
    } else {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã¯é–‹ã„ãŸã¾ã¾ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¦æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã«æˆ»ã‚‹
        clearImplementationModalForms();

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚’æœ€åˆã«æˆ»ã™
        window.currentModalStep = 1;
        if (typeof window.showModalStep === 'function') {
            window.showModalStep(1);
        }

        // åˆæœŸçŠ¶æ…‹ã‚’å¤–æ³¨å…ˆã«è¨­å®š
        $('input[name="modal_implementation_type"][value="outsource"]').prop('checked', true);
        toggleImplementationType();

        // å—æ³¨é‡‘é¡ã‚’å†åº¦åæ˜ 
        const orderAmountInput = document.getElementById('{{ form.order_amount.id_for_label }}');
        if (orderAmountInput && orderAmountInput.value) {
            const orderAmount = parseFloat(orderAmountInput.value) || 0;
            const modalProjectOrderAmountElement = document.getElementById('modalProjectOrderAmount');
            if (modalProjectOrderAmountElement) {
                modalProjectOrderAmountElement.textContent = orderAmount.toLocaleString();
            }
        }

        toastr.success('è¿½åŠ ã•ã‚Œã¾ã—ãŸï¼ç¶šã‘ã¦åˆ¥ã®æ¥­è€…ã‚’è¿½åŠ ã§ãã¾ã™ã€‚');
    }
};

window.addNewStaff = function() {
    console.log('âœ… addNewStaff called');

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
    $('body').addClass('modal-open').css('overflow', 'hidden');

    // ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const modal = $('#staffModal');
    modal.css('display', 'block').addClass('show');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#staffForm')[0].reset();
    $('#staffModalTitle').text('æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ');
    $('#staffId').val('');

    // z-indexã‚’èª¿æ•´
    modal.css('z-index', '2060');
    $('.modal-backdrop').css('z-index', '2059');

    console.log('æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ');
};

window.saveStaff = function() {
    console.log('âœ… saveStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const formData = {
        name: $('#staffName').val(),
        department: $('#staffDepartment').val(),
        hourlyRate: $('#staffHourlyRate').val(),
        specialties: $('#staffSpecialties').val(),
        active: $('#staffActive').is(':checked')
    };

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.name) {
        toastr.warning('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã«è¿½åŠ 
    addStaffToList(formData);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#staffModal').removeClass('show').css('display', 'none');

    toastr.success('ã‚¹ã‚¿ãƒƒãƒ•ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
};

window.addNewContractor = function() {
    console.log('âœ… addNewContractor called');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#contractorForm')[0].reset();
    $('#contractorModalTitle').text('æ–°ã—ã„æ¥­è€…ã‚’è¿½åŠ ');

    // æ–°è¦è¿½åŠ æ™‚ã¯æ¥­è€…é¸æŠæ–¹æ³•ã‚’éè¡¨ç¤ºã«ã—ã¦ã€ç›´æ¥æ–°è¦å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    $('.contractor-input-method').hide();
    $('#existingContractorDiv').hide();
    $('#newContractorDiv').show();

    // Bootstrap 5ã®Modal APIã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const modalElement = document.getElementById('contractorModal');
    const modal = new bootstrap.Modal(modalElement, {
        backdrop: true,
        keyboard: true,
        focus: true
    });
    modal.show();

    console.log('æ–°è¦æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ');
};

// ã‚¨ã‚¤ãƒªã‚¢ã‚¹ï¼šæ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã€Œæ–°è¦æ¥­è€…è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã°ã‚Œã‚‹
window.openAddContractorModal = window.addNewContractor;

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ™‚çµ¦å˜ä¾¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
window.toggleModalHourlyRateField = function() {
    const contractorType = $('#contractorType').val();
    const hourlyRateField = $('#modalHourlyRateField');

    if (contractorType === 'individual') {
        hourlyRateField.show();
    } else {
        hourlyRateField.hide();
        $('#contractorHourlyRate').val('');
    }
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®åœ°æ–¹ã”ã¨ã®éƒ½é“åºœçœŒä¸€æ‹¬é¸æŠ/è§£é™¤æ©Ÿèƒ½
window.toggleModalRegionPrefectures = function(regionCheckbox) {
    const region = regionCheckbox.dataset.region;
    const fieldSlug = regionCheckbox.dataset.fieldSlug;
    const isChecked = regionCheckbox.checked;

    // åŒã˜åœ°æ–¹ã®éƒ½é“åºœçœŒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’å–å¾—
    const prefectureCheckboxes = document.querySelectorAll(
        `input.prefecture-checkbox[data-region="${region}"][data-field-slug="${fieldSlug}"]`
    );

    // ã™ã¹ã¦ã®éƒ½é“åºœçœŒãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ä¸€æ‹¬ã§å¤‰æ›´
    prefectureCheckboxes.forEach(checkbox => {
        checkbox.checked = isChecked;
    });
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åˆæœŸåŒ–ï¼ˆDOMContentLoadedæ™‚ã«å®Ÿè¡Œï¼‰
$(document).ready(function() {
    // å•å±‹å¥‘ç´„ã®æ¡ä»¶ä»˜ãè¡¨ç¤º
    const modalWholesaleContractSelect = document.querySelector('select#modal_custom_has_wholesale_contract');
    if (modalWholesaleContractSelect) {
        function toggleModalWholesaleDetails() {
            const detailsField = document.getElementById('modal_wholesale_contract_details_wrapper');
            if (detailsField) {
                if (modalWholesaleContractSelect.value === 'ã‚ã‚Š') {
                    detailsField.classList.remove('d-none');
                } else {
                    detailsField.classList.add('d-none');
                }
            }
        }
        modalWholesaleContractSelect.addEventListener('change', toggleModalWholesaleDetails);
        toggleModalWholesaleDetails(); // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    }

    // è¶³å ´å¥‘ç´„ã®æ¡ä»¶ä»˜ãè¡¨ç¤º
    const modalScaffoldingCheckbox = document.querySelector('input#modal_custom_scaffolding_contract');
    if (modalScaffoldingCheckbox) {
        function toggleModalScaffoldingCost() {
            const costField = document.getElementById('modal_scaffolding_whole_house_cost_wrapper');
            if (costField) {
                if (modalScaffoldingCheckbox.checked) {
                    costField.classList.remove('d-none');
                } else {
                    costField.classList.add('d-none');
                }
            }
        }
        modalScaffoldingCheckbox.addEventListener('change', toggleModalScaffoldingCost);
        toggleModalScaffoldingCost(); // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
    }

    // ã‚¤ãƒ³ãƒœã‚¤ã‚¹ç•ªå·ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    const modalInvoiceField = document.querySelector('input#modal_custom_invoice_number');
    if (modalInvoiceField) {
        modalInvoiceField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9T]/g, ''); // T ã¨æ•°å­—ã®ã¿

            if (value.startsWith('T')) {
                let numbers = value.substring(1);
                // æœ€å¤§12æ¡ã¾ã§
                numbers = numbers.substring(0, 12);

                if (numbers.length > 8) {
                    value = 'T' + numbers.substring(0, 4) + '-' + numbers.substring(4, 8) + '-' + numbers.substring(8);
                } else if (numbers.length > 4) {
                    value = 'T' + numbers.substring(0, 4) + '-' + numbers.substring(4);
                } else {
                    value = 'T' + numbers;
                }
            } else if (value.length > 0) {
                // T ãŒãªã„å ´åˆã¯å…ˆé ­ã«è¿½åŠ 
                value = 'T' + value.replace(/[^0-9]/g, '').substring(0, 12);
            }

            e.target.value = value;
        });
    }
});

window.saveContractor = function() {
    console.log('âœ… saveContractor called');

    // åŸºæœ¬ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const formData = {
        name: $('#contractorName').val(),
        contractor_type: $('#contractorType').val(),
        address: $('#contractorAddress').val(),
        phone: $('#contractorPhone').val(),
        email: $('#contractorEmail').val(),
        contact_person: $('#contractorContactPerson').val(),
        hourly_rate: $('#contractorHourlyRate').val(),
        specialties: $('#contractorSpecialties').val(),
        is_active: $('#contractorActive').is(':checked'),
        payment_cycle: $('#contractorPaymentCycle').val(),
        closing_day: $('#contractorClosingDay').val(),
        payment_offset_months: $('#contractorPaymentOffsetMonths').val(),
        payment_day: $('#contractorPaymentDay').val(),
        bank_name: $('#contractorBankName').val(),
        branch_name: $('#contractorBranchName').val(),
        account_type: $('#contractorAccountType').val(),
        account_number: $('#contractorAccountNumber').val(),
        account_holder: $('#contractorAccountHolder').val()
    };

    // ã‚«ã‚¹ã‚¿ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const customFields = {};

    // ãƒ†ã‚­ã‚¹ãƒˆã€æ•°å€¤ã€æ—¥ä»˜ã€ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
    $('input[name^="custom_"], select[name^="custom_"], textarea[name^="custom_"]').each(function() {
        const fieldName = $(this).attr('name');
        if (!fieldName) return;

        const fieldSlug = fieldName.replace('custom_', '');

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ä»¥å¤–ã® input, select, textarea
        if ($(this).attr('type') === 'checkbox' && !$(this).hasClass('form-check-input')) {
            customFields[fieldSlug] = $(this).is(':checked');
        } else if ($(this).attr('type') !== 'checkbox') {
            const value = $(this).val();
            if (value) {
                customFields[fieldSlug] = value;
            }
        }
    });

    // è¤‡æ•°é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆmultiselectï¼‰ã‚’åé›†
    const multiselectFields = {};
    $('input[name^="custom_"][type="checkbox"].form-check-input:checked').each(function() {
        const fieldName = $(this).attr('name');
        if (!fieldName) return;

        const fieldSlug = fieldName.replace('custom_', '');
        if (!multiselectFields[fieldSlug]) {
            multiselectFields[fieldSlug] = [];
        }
        multiselectFields[fieldSlug].push($(this).val());
    });

    // multiselectãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’customFieldsã«è¿½åŠ 
    Object.keys(multiselectFields).forEach(slug => {
        customFields[slug] = multiselectFields[slug];
    });

    // customFieldsã‚’formDataã«è¿½åŠ 
    formData.custom_fields = customFields;

    console.log('ğŸ“¦ Form data with custom fields:', formData);

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.name) {
        toastr.warning('æ¥­è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // æ¥­è€…ä¸€è¦§ã«è¿½åŠ ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
    addContractorToList(formData);

    // Bootstrap 5ã®Modal APIã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const modalElement = document.getElementById('contractorModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    if (modal) {
        modal.hide();
    }

    toastr.success('æ¥­è€…ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
};

// æ¥­è€…ä¸€è¦§ã«è¿½åŠ 
window.addContractorToList = function(contractorData) {
    const tableBody = $('#contractorTableBody');
    const id = Date.now(); // ç°¡æ˜“ID

    // æ¥­è€…ã‚¿ã‚¤ãƒ—ãƒãƒƒã‚¸
    let typeBadge = '';
    if (contractorData.contractor_type === 'individual') {
        typeBadge = '<span class="badge bg-success me-1">å€‹äººè·äºº</span>';
    } else if (contractorData.contractor_type === 'company') {
        typeBadge = '<span class="badge bg-primary me-1">å”åŠ›ä¼šç¤¾</span>';
    } else if (contractorData.contractor_type === 'material') {
        typeBadge = '<span class="badge bg-warning me-1">è³‡æå±‹</span>';
    } else {
        typeBadge = '<span class="badge bg-primary me-1">æ–°è¦</span>';
    }

    // é€£çµ¡å…ˆæƒ…å ±
    let contactInfo = '';
    if (contractorData.phone) {
        contactInfo += `<div class="mb-1" style="font-size: 0.85rem;"><i class="fas fa-phone me-1 text-primary"></i>${contractorData.phone}</div>`;
    }
    if (contractorData.email) {
        contactInfo += `<div style="font-size: 0.85rem;"><i class="fas fa-envelope me-1 text-primary"></i>${contractorData.email}</div>`;
    }
    if (!contactInfo) {
        contactInfo = '<span class="text-muted">-</span>';
    }

    // æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
    const paymentInfo = `
        <div style="font-size: 0.8rem; line-height: 1.4;">
            <div>æœˆæ‰•ã„</div>
            <div class="text-muted">ç· æ—¥: -</div>
            <div class="text-muted">æ”¯æ‰•æœˆ: -</div>
            <div class="text-muted">æ”¯æ‰•æ—¥: -</div>
        </div>
    `;

    const newRow = `
        <tr data-contractor-id="${id}" class="clickable-row" style="cursor: pointer;"
            onclick="selectContractor(${id})"
            onmouseover="this.style.backgroundColor='#f8f9fa'"
            onmouseout="this.style.backgroundColor=''">
            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contractorData.name}">
                <strong>${contractorData.name}</strong>
            </td>
            <td>${typeBadge}</td>
            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contractorData.specialties || ''}">
                ${contractorData.specialties || '-'}
            </td>
            <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contractorData.contact_person || ''}">
                ${contractorData.contact_person || '-'}
            </td>
            <td>${contactInfo}</td>
            <td>${paymentInfo}</td>
            <td><span class="badge bg-success">æœ‰åŠ¹</span></td>
            <td onclick="event.stopPropagation()">
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="editContractor(${id})" title="ç·¨é›†">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `;

    tableBody.append(newRow);

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚‚è¿½åŠ ï¼ˆã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨æœªä½¿ç”¨ï¼‰
    // const option = `<option value="${id}" data-name="${contractorData.name}">${contractorData.name}</option>`;
    // $('#clientCompanySelect').append(option);
    // $('#modalContractorSelect').append(option);
};

// å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤ï¼‰

// æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°
window.refreshContractorList = function() {
    console.log('æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderContractorTable(window.contractors_json || []);
};

// åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆå€‹äººè·äººå„ªå…ˆï¼‰
window.refreshContractorListForBasicInfo = function() {
    console.log('åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆå€‹äººè·äººå„ªå…ˆï¼‰');
    const sortedContractors = [...(window.contractors_json || [])].sort((a, b) => {
        if (a.is_active && !b.is_active) return -1;
        if (!a.is_active && b.is_active) return 1;
        // å€‹äººè·äººã‚’å„ªå…ˆ
        if (a.contractor_type === 'individual' && b.contractor_type !== 'individual') return -1;
        if (a.contractor_type !== 'individual' && b.contractor_type === 'individual') return 1;
        return a.name.localeCompare(b.name);
    });
    renderContractorTable(sortedContractors);
};

// å®Ÿæ–½ä½“åˆ¶ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆå”åŠ›ä¼šç¤¾å„ªå…ˆï¼‰
window.refreshContractorListForImplementation = function() {
    console.log('å®Ÿæ–½ä½“åˆ¶ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆå”åŠ›ä¼šç¤¾å„ªå…ˆï¼‰');
    const sortedContractors = [...(window.contractors_json || [])].sort((a, b) => {
        if (a.is_active && !b.is_active) return -1;
        if (!a.is_active && b.is_active) return 1;
        // å”åŠ›ä¼šç¤¾ã‚’å„ªå…ˆ
        if (a.contractor_type === 'company' && b.contractor_type !== 'company') return -1;
        if (a.contractor_type !== 'company' && b.contractor_type === 'company') return 1;
        return a.name.localeCompare(b.name);
    });
    renderContractorTable(sortedContractors);
};

// è·äººãƒªã‚¹ãƒˆæ›´æ–°
window.refreshCraftsmanList = function() {
    console.log('è·äººãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderCraftsmanTable(window.dummyCraftsmen);
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆæ›´æ–°
window.refreshStaffList = function() {
    console.log('ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderStaffTable(window.dummyInternalStaff);
};

// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
window.filterContractors = function() {
    const searchTerm = $('#contractorSearch').val().toLowerCase();
    const typeFilter = $('#contractorTypeFilter').val();
    const statusFilter = $('#contractorStatusFilter').val();

    let filteredContractors = [...(window.contractors_json || [])];

    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
    if (searchTerm) {
        filteredContractors = filteredContractors.filter(contractor =>
            contractor.name.toLowerCase().includes(searchTerm) ||
            (contractor.phone && contractor.phone.includes(searchTerm)) ||
            (contractor.email && contractor.email.toLowerCase().includes(searchTerm))
        );
    }

    // ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿
    if (typeFilter) {
        filteredContractors = filteredContractors.filter(contractor =>
            contractor.contractor_type === typeFilter
        );
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
    if (statusFilter) {
        const isActive = statusFilter === 'active';
        filteredContractors = filteredContractors.filter(contractor => contractor.is_active === isActive);
    }

    renderContractorTable(filteredContractors);
};

// ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
window.clearContractorFilters = function() {
    $('#contractorSearch').val('');
    $('#contractorTypeFilter').val('');
    $('#contractorStatusFilter').val('');
    filterContractors();
};

// ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
let currentSortColumn = '';
let currentSortDirection = 'asc';

window.sortContractorTable = function(column) {
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }

    let sortedContractors = [...(window.contractors_json || [])];

    sortedContractors.sort((a, b) => {
        let aValue, bValue;

        switch(column) {
            case 'name':
                aValue = a.name.toLowerCase();
                bValue = b.name.toLowerCase();
                break;
            case 'status':
                aValue = a.is_active ? 1 : 0;
                bValue = b.is_active ? 1 : 0;
                break;
            default:
                return 0;
        }

        if (currentSortDirection === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });

    renderContractorTable(sortedContractors);

    // ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
    $('.contractor-table th i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
    $(`th[onclick*="${column}"] i`).removeClass('fa-sort')
        .addClass(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
};

// æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderContractorTable = function(contractors) {
    const tbody = $('#contractorTableBody');

    if (tbody.length === 0) {
        console.log('æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    contractors.forEach((contractor) => {
        const statusBadge = contractor.is_active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        // contractor_typeã«åŸºã¥ã„ã¦ãƒãƒƒã‚¸ã‚’ä½œæˆ
        let typeBadge = '';
        if (contractor.contractor_type === 'company') {
            typeBadge = '<span class="badge bg-primary me-1">å”åŠ›ä¼šç¤¾</span>';
        } else if (contractor.contractor_type === 'individual') {
            typeBadge = '<span class="badge bg-success me-1">å€‹äººè·äºº</span>';
        } else if (contractor.contractor_type === 'material') {
            typeBadge = '<span class="badge bg-warning text-dark me-1">è³‡æå±‹</span>';
        } else {
            typeBadge = '<span class="badge bg-secondary me-1">ãã®ä»–</span>';
        }

        let rowClass = contractor.is_active ? 'clickable-row' : 'inactive-row';

        // é€£çµ¡å…ˆæƒ…å ±
        let contactInfo = '';
        if (contractor.phone) {
            contactInfo += `<div class="mb-1" style="font-size: 0.85rem;"><i class="fas fa-phone me-1 text-primary"></i>${contractor.phone}</div>`;
        }
        if (contractor.email) {
            contactInfo += `<div style="font-size: 0.85rem;"><i class="fas fa-envelope me-1 text-primary"></i>${contractor.email}</div>`;
        }
        if (!contractor.phone && !contractor.email) {
            contactInfo = '<span class="text-muted">-</span>';
        }

        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±
        let paymentCycleInfo = '';
        const paymentCycleMap = {
            'monthly': 'æœˆæ‰•ã„',
            'bimonthly': 'éš”æœˆæ‰•ã„',
            'quarterly': 'å››åŠæœŸæ‰•ã„',
            'custom': 'ãã®ä»–'
        };
        const paymentOffsetMap = {
            0: 'å½“æœˆ',
            1: 'ç¿Œæœˆ',
            2: 'ç¿Œã€…æœˆ',
            3: '3ãƒ¶æœˆå¾Œ'
        };

        const paymentCycle = contractor.payment_cycle ? paymentCycleMap[contractor.payment_cycle] || '-' : '-';
        const closingDay = contractor.closing_day ? `${contractor.closing_day}æ—¥` : '-';
        const paymentOffset = contractor.payment_offset_months !== null && contractor.payment_offset_months !== undefined && contractor.payment_offset_months !== ''
            ? (paymentOffsetMap[contractor.payment_offset_months] || '-')
            : '-';
        const paymentDay = contractor.payment_day ? `${contractor.payment_day}æ—¥` : '-';

        if (paymentCycle !== '-' || closingDay !== '-' || paymentDay !== '-') {
            paymentCycleInfo = `
                <div style="font-size: 0.8rem; line-height: 1.4;">
                    <div>${paymentCycle}</div>
                    <div class="text-muted">ç· æ—¥: ${closingDay}</div>
                    <div class="text-muted">æ”¯æ‰•æœˆ: ${paymentOffset}</div>
                    <div class="text-muted">æ”¯æ‰•æ—¥: ${paymentDay}</div>
                </div>
            `;
        } else {
            paymentCycleInfo = '<span class="text-muted">-</span>';
        }

        const row = `
            <tr data-contractor-id="${contractor.id}" class="${rowClass}"
                style="cursor: pointer;"
                onclick="selectContractor(${contractor.id})"
                onmouseover="this.style.backgroundColor='#f8f9fa'"
                onmouseout="this.style.backgroundColor=''">
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contractor.name}"><strong>${contractor.name}</strong></td>
                <td>${typeBadge}</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contractor.specialties || ''}">${contractor.specialties || '-'}</td>
                <td style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${contractor.contact_person || ''}">${contractor.contact_person || '-'}</td>
                <td>${contactInfo}</td>
                <td>${paymentCycleInfo}</td>
                <td>${statusBadge}</td>
                <td onclick="event.stopPropagation()">
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                            onclick="editContractor(${contractor.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;

        tbody.append(row);
    });

    console.log(`æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã«${contractors.length}ä»¶ã®æ¥­è€…ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
};

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸ
function setupScrollSync() {
    const scrollContainer = $('.contractor-table-scroll');
    const fixedContainer = $('.contractor-table-fixed');

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸã‚’è¨­å®šï¼ˆé‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ããŸã‚ã€ä¸€åº¦å‰Šé™¤ã—ã¦ã‹ã‚‰è¨­å®šï¼‰
    scrollContainer.off('scroll.sync');
    fixedContainer.off('scroll.sync');

    scrollContainer.on('scroll.sync', function() {
        fixedContainer.scrollTop(this.scrollTop);
    });

    fixedContainer.on('scroll.sync', function() {
        scrollContainer.scrollTop(this.scrollTop);
    });

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šè¡Œã®é«˜ã•ã‚’ãƒã‚§ãƒƒã‚¯
    console.log('ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®é«˜ã•èª¿æ•´å®Œäº†');
    setTimeout(() => {
        const scrollRows = $('.contractor-table-scroll tbody tr');
        const fixedRows = $('.contractor-table-fixed tbody tr');
        console.log(`ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å´è¡Œæ•°: ${scrollRows.length}, å›ºå®šå´è¡Œæ•°: ${fixedRows.length}`);
        if (scrollRows.length > 0 && fixedRows.length > 0) {
            const scrollHeight = scrollRows.first().outerHeight();
            const fixedHeight = fixedRows.first().outerHeight();
            console.log(`è¡Œã®é«˜ã• - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å´: ${scrollHeight}px, å›ºå®šå´: ${fixedHeight}px`);
        }
    }, 100);
}

// è·äººãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderCraftsmanTable = function(craftsmen) {
    const tbody = $('#craftsmanTableBody');

    if (tbody.length === 0) {
        console.log('è·äººãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    craftsmen.forEach((craftsman) => {
        const statusBadge = craftsman.active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        tbody.append(`
            <tr data-craftsman-id="${craftsman.id}">
                <td><strong>${craftsman.name}</strong></td>
                <td>${craftsman.specialties}</td>
                <td>${craftsman.experience}</td>
                <td>Â¥${craftsman.hourlyRate.toLocaleString()}/æ™‚é–“</td>
                <td>${craftsman.phone}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editCraftsman(${craftsman.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCraftsman(${craftsman.id})" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderStaffTable = function(staff) {
    const tbody = $('#staffTableBody');

    if (tbody.length === 0) {
        console.log('ã‚¹ã‚¿ãƒƒãƒ•ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    staff.forEach((member) => {
        const statusBadge = member.active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        tbody.append(`
            <tr data-staff-id="${member.id}">
                <td><strong>${member.name}</strong></td>
                <td>${member.department}</td>
                <td>Â¥${member.hourlyRate.toLocaleString()}/æ™‚é–“</td>
                <td>${member.specialties}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editStaff(${member.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStaff(${member.id})" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã«è¿½åŠ 
window.addStaffToList = function(staffData) {
    const id = Date.now(); // ç°¡æ˜“ID
    const newStaff = {
        id: id,
        name: staffData.name,
        department: staffData.department,
        hourlyRate: staffData.hourlyRate || 0,
        specialties: staffData.specialties,
        active: staffData.active
    };

    window.dummyInternalStaff.push(newStaff);

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚‚è¿½åŠ 
    const option = `<option value="${id}" data-name="${staffData.name}" data-department="${staffData.department}" data-hourly-rate="${staffData.hourlyRate}">${staffData.name} (${staffData.department})</option>`;
    $('#modalInternalSelect').append(option);

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
    renderStaffTable(window.dummyInternalStaff);
};

// ç·¨é›†ãƒ»å‰Šé™¤é–¢æ•°ã®ã‚¹ã‚¿ãƒ–
// æ¥­è€…é¸æŠæ©Ÿèƒ½
window.selectContractor = function(id) {
    console.log(`æ¥­è€…ID ${id} ã‚’é¸æŠ`);

    // é¸æŠã•ã‚ŒãŸæ¥­è€…æƒ…å ±ã‚’å–å¾—
    const contractor = (window.contractors_json || []).find(c => c.id === id);
    if (!contractor) {
        toastr.error('æ¥­è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#contractorManagementModal').removeClass('show').css('display', 'none');
    $('.modal-backdrop').remove();

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
    $('body').removeClass('modal-open').css('overflow', '');

    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ¤å®š: ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹ã‹ã©ã†ã‹
    const subcontractModal = document.getElementById('subcontractModal');
    const isSubcontractModalOpen = subcontractModal && $(subcontractModal).hasClass('show');

    if (isSubcontractModalOpen) {
        // ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆ
        // hidden fieldã«æ¥­è€…IDã‚’è¨­å®š
        $('#subcontractContractor').val(id);

        // è¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ¥­è€…åã‚’è¨­å®š
        $('#selectedContractorDisplay').val(contractor.name);

        // change ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒˆãƒªã‚¬ãƒ¼ã—ã¦æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
        $('#subcontractContractor').trigger('change');

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (typeof toastr !== 'undefined') {
            toastr.success(`ã€Œ${contractor.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
        }
    } else {
        // ãã®ä»–ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
        if (typeof toastr !== 'undefined') {
            toastr.success(`ã€Œ${contractor.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
        }
    }
};

window.editContractor = function(id) {
    // æ¥­è€…ç·¨é›†ãƒšãƒ¼ã‚¸ã«é·ç§»
    window.open(`/orders/contractors/${id}/edit/`, '_blank');
};

// æ±ç”¨å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
window.showConfirmDelete = function(message, onConfirm) {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    $('#confirmDeleteMessage').text(message);

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
    $('#confirmDeleteButton').off('click');

    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    $('#confirmDeleteButton').on('click', function() {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
        if (modal) {
            modal.hide();
        }

        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè¡Œ
        if (onConfirm && typeof onConfirm === 'function') {
            onConfirm();
        }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    modal.show();
};

window.deleteContractor = function(id) {
    showConfirmDelete('ã“ã®æ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        // å®Ÿéš›ã®å‰Šé™¤ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰APIã§è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™
        toastr.warning('å‰Šé™¤æ©Ÿèƒ½ã¯å°‚ç”¨ã®æ¥­è€…ç®¡ç†ãƒšãƒ¼ã‚¸ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„');
        console.log('æ¥­è€…å‰Šé™¤: ID', id, '(ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å®Ÿè£…ãŒå¿…è¦)');
    });
};

window.editCraftsman = function(id) {
    toastr.info(`è·äººID ${id} ã®ç·¨é›†æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰`);
};

window.deleteCraftsman = function(id) {
    showConfirmDelete('ã“ã®è·äººã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        window.dummyCraftsmen = window.dummyCraftsmen.filter(c => c.id !== id);
        refreshCraftsmanList();
        toastr.success('è·äººã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });
};

window.editStaff = function(id) {
    toastr.info(`ã‚¹ã‚¿ãƒƒãƒ•ID ${id} ã®ç·¨é›†æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰`);
};

window.deleteStaff = function(id) {
    showConfirmDelete('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        window.dummyInternalStaff = window.dummyInternalStaff.filter(s => s.id !== id);
        refreshStaffList();
        toastr.success('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });
};

// å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
window.toggleImplementationType = function() {
    const selectedType = $('input[name="modal_implementation_type"]:checked').val();

    // å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
    $('.implementation-form').hide();

    // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    switch(selectedType) {
        case 'outsource':
            $('#modalContractorForm').show();
            break;
        case 'internal':
            $('#modalInternalForm').show();
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ãŒé¸æŠã•ã‚ŒãŸæ™‚ã€æ–™é‡‘ä½“ç³»ã‚‚åˆæœŸåŒ–
            $('input[name="modal_internal_pricing_type"][value="hourly"]').prop('checked', true);
            togglePricingType();
            break;
        case 'later':
            $('#modalLaterForm').show();
            break;
    }

    console.log('å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ:', selectedType);
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ©Ÿèƒ½
window.clearImplementationModalForms = function() {
    $('#addImplementationModal input[type="text"]').val('');
    $('#addImplementationModal input[type="number"]').val('');
    $('#addImplementationModal textarea').val('');
    $('#addImplementationModal select').val('');

    // è¿½åŠ è²»ç”¨ã‚‚ã‚¯ãƒªã‚¢
    clearModalAdditionalCosts();

    console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
};

// å®Ÿæ–½ä½“åˆ¶ãƒªã‚¹ãƒˆã«è¿½åŠ 
window.addToImplementationList = function(itemData) {
    const listContainer = $('#implementationList');

    let html = '';
    if (itemData.type === 'outsource') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-handshake text-primary me-2"></i>å¤–æ³¨å…ˆ: ${itemData.contractorName}
                            </h6>
                            <p class="card-text mb-1">
                                <strong>ä½œæ¥­å†…å®¹:</strong> ${itemData.workDescription}
                            </p>
                            <p class="card-text mb-1">
                                <strong>å¥‘ç´„é¡:</strong> Â¥${Number(itemData.contractAmount).toLocaleString()}
                            </p>
                            ${itemData.additionalCostTotal > 0 ? `
                            <p class="card-text mb-0">
                                <strong>è¿½åŠ è²»ç”¨:</strong> Â¥${Number(itemData.additionalCostTotal).toLocaleString()}
                                <small class="text-muted">(${itemData.additionalCosts.length}é …ç›®)</small>
                            </p>
                            ` : ''}
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else if (itemData.type === 'internal') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-users text-success me-2"></i>ç¤¾å†…: ${itemData.staffName}
                            </h6>
                            <p class="card-text mb-0">
                                <strong>éƒ¨ç½²:</strong> ${itemData.department || '-'}
                            </p>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else if (itemData.type === 'later') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-clock text-warning me-2"></i>å¾Œã§æ±ºå®š
                            </h6>
                            <p class="card-text mb-0">è©³ç´°ç”»é¢ã§å®Ÿæ–½ä½“åˆ¶ã‚’è¨­å®šã—ã¾ã™</p>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    listContainer.append(html);
};

// å®Ÿæ–½ä½“åˆ¶ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤
window.removeImplementationItem = function(itemId) {
    $(`[data-item-id="${itemId}"]`).remove();
};

// æ¥­è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
window.toggleContractorInputType = function() {
    const inputType = $('input[name="modal_contractor_input_type"]:checked').val();
    console.log('æ¥­è€…é¸æŠæ–¹æ³•åˆ‡ã‚Šæ›¿ãˆ:', inputType);

    if (inputType === 'existing') {
        $('#modalExistingContractorDiv').show();
        $('#modalNewContractorDiv').hide();
        console.log('æ—¢å­˜æ¥­è€…é¸æŠè¡¨ç¤º');
    } else {
        $('#modalExistingContractorDiv').hide();
        $('#modalNewContractorDiv').show();
        console.log('æ–°è¦æ¥­è€…å…¥åŠ›è¡¨ç¤º');
    }
};

// ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
window.toggleInternalInputType = function() {
    const inputType = $('input[name="modal_internal_input_type"]:checked').val();
    console.log('ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•åˆ‡ã‚Šæ›¿ãˆ:', inputType);

    if (inputType === 'existing') {
        $('#modalExistingInternalDiv').show();
        $('#modalNewInternalDiv').hide();
        console.log('æ—¢å­˜æ‹…å½“è€…é¸æŠè¡¨ç¤º');
    } else {
        $('#modalExistingInternalDiv').hide();
        $('#modalNewInternalDiv').show();
        console.log('æ–°è¦æ‹…å½“è€…å…¥åŠ›è¡¨ç¤º');
    }
};

// æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆ
window.togglePricingType = function() {
    const pricingType = $('input[name="modal_internal_pricing_type"]:checked').val();
    console.log('========================');
    console.log('ğŸ”¥ æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆ:', pricingType);

    const hourlyFields = $('#modalHourlyPricingFields');
    const projectFields = $('#modalProjectPricingFields');

    console.log('ğŸ”§ Before changes:');
    console.log('  - modalHourlyPricingFields visible:', hourlyFields.is(':visible'));
    console.log('  - modalProjectPricingFields visible:', projectFields.is(':visible'));

    if (pricingType === 'hourly') {
        console.log('ğŸ”§ Setting to hourly mode');
        hourlyFields.show();
        projectFields.hide();
    } else if (pricingType === 'project') {
        console.log('ğŸ”§ Setting to project mode');
        hourlyFields.hide();
        projectFields.show();
    }

    console.log('ğŸ”§ After changes:');
    console.log('  - modalHourlyPricingFields visible:', hourlyFields.is(':visible'));
    console.log('  - modalProjectPricingFields visible:', projectFields.is(':visible'));
    console.log('========================');
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹è²»ç”¨è‡ªå‹•è¨ˆç®—
window.calculateModalInternalCost = function() {
    const pricingType = $('input[name="modal_internal_pricing_type"]:checked').val();

    if (pricingType === 'hourly') {
        const hourlyRate = parseFloat($('input[name="modal_internal_hourly_rate"]').val()) || 0;
        const hours = parseFloat($('input[name="modal_estimated_hours"]').val()) || 0;
        const totalCost = hourlyRate * hours;

        console.log('ğŸ’° æ™‚çµ¦ãƒ™ãƒ¼ã‚¹è¨ˆç®—:', {
            æ™‚çµ¦: hourlyRate,
            å·¥æ•°: hours,
            åˆè¨ˆ: totalCost
        });

        // è¨ˆç®—çµæœã‚’è¡¨ç¤ºã™ã‚‹å ´æ‰€ãŒã‚ã‚Œã°æ›´æ–°
        // (ç¾åœ¨ã®HTMLã«è¡¨ç¤ºé ˜åŸŸãŒãªã„å ´åˆã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèªã®ã¿)
        if ($('#modalInternalTotalCost').length) {
            $('#modalInternalTotalCost').text(totalCost.toLocaleString());
        }

        return totalCost;
    }
};

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
$(document).ready(function() {
    // å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_implementation_type"]', toggleImplementationType);

    // æ¥­è€…é¸æŠæ–¹æ³•å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_contractor_input_type"]', toggleContractorInputType);

    // ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_internal_input_type"]', toggleInternalInputType);

    // æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_internal_pricing_type"]', togglePricingType);

    // æ—¢å­˜æ‹…å½“è€…é¸æŠæ™‚ã®æ™‚çµ¦è‡ªå‹•å…¥åŠ›
    $(document).on('change', '#modalInternalSelect', function() {
        const selectedOption = $(this).find('option:selected');
        const hourlyRate = selectedOption.data('hourly-rate');

        if (hourlyRate) {
            $('input[name="modal_internal_hourly_rate"]').val(hourlyRate);
            console.log('ğŸ¯ æ‹…å½“è€…æ™‚çµ¦è‡ªå‹•å…¥åŠ›:', selectedOption.data('name'), 'Â¥' + hourlyRate + '/æ™‚é–“');

            // æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€è‡ªå‹•è¨ˆç®—ã‚’å®Ÿè¡Œ
            if ($('input[name="modal_internal_pricing_type"]:checked').val() === 'hourly') {
                calculateModalInternalCost();
            }
        }
    });

    // æ™‚çµ¦ãƒ»å·¥æ•°å¤‰æ›´æ™‚ã®è‡ªå‹•è¨ˆç®—
    $(document).on('input', 'input[name="modal_internal_hourly_rate"], input[name="modal_estimated_hours"]', function() {
        if ($('input[name="modal_internal_pricing_type"]:checked').val() === 'hourly') {
            calculateModalInternalCost();
        }
    });

    // Phase 3.2ã§è¿½åŠ : å·¥ç¨‹é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', '.modal-step-checkbox', handleModalStepSelection);

    // Phase 3.2ã§è¿½åŠ : é‡‘é¡è¨­å®šæ–¹æ³•ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_cost_allocation_method"]', handleModalCostAllocationMethod);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('click', '[data-bs-dismiss="modal"]', function() {
        const modal = $(this).closest('.modal');
        modal.removeClass('show').css('display', 'none');
        $('.modal-backdrop').remove();

        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
        $('body').removeClass('modal-open').css('overflow', '');

        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    $(document).on('click', '.modal-backdrop', function() {
        $('.modal').removeClass('show').css('display', 'none');
        $('.modal-backdrop').remove();

        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
        $('body').removeClass('modal-open').css('overflow', '');

        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    });

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape') {
            $('.modal.show').removeClass('show').css('display', 'none');
            $('.modal-backdrop').remove();

            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
            $('body').removeClass('modal-open').css('overflow', '');
            console.log('ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
        }
    });

    // åˆæœŸåŒ–æ™‚ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
    initializeDropdowns();

    console.log('ğŸ“Œ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
});

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ï¼ˆã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢ï¼‰
window.initializeDropdowns = function() {
    // å…ƒè«‹ä¼šç¤¾ã¯å°‚ç”¨ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã§ç®¡ç†ã—ã¾ã™
    // ã“ã®é–¢æ•°ã¯å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã—ã¦ã„ã¾ã™ãŒã€ä½•ã‚‚å®Ÿè¡Œã—ã¾ã›ã‚“
    console.log('initializeDropdowns: ã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸ');

    // ç¤¾å†…ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
    const internalSelect = $('#modalInternalSelect');

    // window.dummyInternalStaffãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    if (window.dummyInternalStaff && Array.isArray(window.dummyInternalStaff)) {
        window.dummyInternalStaff.filter(s => s.active).forEach(staff => {
            const option = `<option value="${staff.id}" data-name="${staff.name}" data-department="${staff.department}" data-hourly-rate="${staff.hourlyRate}">${staff.name} (${staff.department})</option>`;
            internalSelect.append(option);
        });
        console.log('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
    }
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…è¿½åŠ è²»ç”¨ç®¡ç†
window.modalAdditionalCosts = [];

window.addModalCostItem = function() {
    console.log('âœ… addModalCostItem called');

    // jQuery ãƒã‚§ãƒƒã‚¯
    if (typeof $ === 'undefined') {
        console.error('âŒ jQuery not loaded');
        return;
    }

    // è¦ç´ ã®å­˜åœ¨ç¢ºèªã¨å€¤å–å¾—
    const nameEl = $('#modalNewCostItemName');
    const amountEl = $('#modalNewCostItemAmount');
    const descriptionEl = $('#modalNewCostItemDescription');

    if (nameEl.length === 0 || amountEl.length === 0 || descriptionEl.length === 0) {
        console.error('âŒ Cost item input fields not found');
        if (typeof toastr !== 'undefined') {
            toastr.error('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        return;
    }

    const nameValue = nameEl.val();
    const amountValue = amountEl.val();
    const descriptionValue = descriptionEl.val();

    const name = nameValue ? nameValue.trim() : '';
    const amount = parseFloat(amountValue) || 0;
    const description = descriptionValue ? descriptionValue.trim() : '';

    console.log('ğŸ“ Cost item values:', { name, amount, description });

    if (!name || amount <= 0) {
        if (typeof toastr !== 'undefined') {
            toastr.warning('è²»ç”¨é …ç›®åã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        }
        return;
    }

    const costItem = {
        id: Date.now(),
        name: name,
        amount: amount,
        description: description
    };

    window.modalAdditionalCosts.push(costItem);
    renderModalCostList();
    updateModalCostTotal();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    nameEl.val('');
    amountEl.val('');
    descriptionEl.val('');

    console.log('âœ… è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', costItem);
};

window.removeModalCostItem = function(id) {
    window.modalAdditionalCosts = window.modalAdditionalCosts.filter(item => item.id !== id);
    renderModalCostList();
    updateModalCostTotal();
    console.log('è¿½åŠ è²»ç”¨é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', id);
};

window.renderModalCostList = function() {
    const listContainer = $('#modalAdditionalCostList');
    listContainer.empty();

    window.modalAdditionalCosts.forEach(item => {
        const html = `
            <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2" data-cost-id="${item.id}">
                <div class="flex-grow-1">
                    <strong>${item.name}</strong>
                    <span class="text-muted ms-2">Â¥${item.amount.toLocaleString()}</span>
                    ${item.description ? `<br><small class="text-muted">${item.description}</small>` : ''}
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeModalCostItem(${item.id})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        listContainer.append(html);
    });
};

window.updateModalCostTotal = function() {
    const total = window.modalAdditionalCosts.reduce((sum, item) => sum + item.amount, 0);
    $('#modalAdditionalCostTotal').text('Â¥' + total.toLocaleString());

    // æ–™é‡‘ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    if (typeof calculateModalTotal === 'function') {
        calculateModalTotal();
    }
};

window.clearModalAdditionalCosts = function() {
    window.modalAdditionalCosts = [];
    renderModalCostList();
    updateModalCostTotal();
};

// ==========================================
// Phase 2.2ã§è¿½åŠ : æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã¨éƒ¨æè²»ç®¡ç†
// ==========================================

// å¤–æ³¨å…ˆé¸æŠæ™‚ã®å‡¦ç†ï¼ˆæ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã®è‡ªå‹•å…¥åŠ›ï¼‰
window.onModalContractorChange = function(selectElement) {
    const contractorId = selectElement.value;
    const contractorInfoSection = document.getElementById('modalSelectedContractorInfo');

    if (!contractorId) {
        console.log('æ¥­è€…é¸æŠãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
        // æ¥­è€…æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        if (contractorInfoSection) {
            contractorInfoSection.style.display = 'none';
        }
        return;
    }

    // é¸æŠã•ã‚ŒãŸæ¥­è€…ã®dataå±æ€§ã‹ã‚‰å€¤ã‚’å–å¾—
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const contractorName = selectedOption.getAttribute('data-name') || '';
    const paymentCycleRaw = selectedOption.getAttribute('data-payment-cycle') || '';
    const closingDayRaw = selectedOption.getAttribute('data-closing-day') || '';
    const paymentOffsetRaw = selectedOption.getAttribute('data-payment-offset-months') || '';
    const paymentDayRaw = selectedOption.getAttribute('data-payment-day') || '';

    console.log('âœ… æ¥­è€…ã‚’é¸æŠã—ã¾ã—ãŸ:', contractorName);

    // ã‚¹ãƒ†ãƒƒãƒ—3ã®æ¥­è€…æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ›´æ–°
    if (contractorInfoSection) {
        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ã‚’æ—¥æœ¬èªã«å¤‰æ›
        const paymentCycleMap = {
            'monthly': 'æœˆæ‰•ã„',
            'bimonthly': 'éš”æœˆæ‰•ã„',
            'quarterly': 'å››åŠæœŸæ‰•ã„',
            'custom': 'ãã®ä»–'
        };
        const paymentCycleDisplay = paymentCycleRaw ? (paymentCycleMap[paymentCycleRaw] || paymentCycleRaw) : '-';

        // æ”¯æ‰•æœˆã‚’æ—¥æœ¬èªã«å¤‰æ›
        const paymentOffsetMap = {
            '0': 'å½“æœˆ',
            '1': 'ç¿Œæœˆ',
            '2': 'ç¿Œã€…æœˆ',
            '3': '3ãƒ¶æœˆå¾Œ'
        };
        const paymentOffsetDisplay = paymentOffsetRaw !== '' ? (paymentOffsetMap[paymentOffsetRaw] || paymentOffsetRaw) : '-';

        // ç· ã‚æ—¥ã¨æ”¯æ‰•æ—¥ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const closingDayDisplay = closingDayRaw ? `${closingDayRaw}æ—¥` : '-';
        const paymentDayDisplay = paymentDayRaw ? `${paymentDayRaw}æ—¥` : '-';

        // è¡¨ç¤ºã‚’æ›´æ–°
        const contractorNameEl = document.getElementById('modalSelectedContractorName');
        const paymentCycleEl = document.getElementById('modalSelectedPaymentCycle');
        const closingDayEl = document.getElementById('modalSelectedClosingDay');
        const paymentOffsetEl = document.getElementById('modalSelectedPaymentOffset');
        const paymentDayEl = document.getElementById('modalSelectedPaymentDay');

        if (contractorNameEl) contractorNameEl.textContent = contractorName;
        if (paymentCycleEl) paymentCycleEl.textContent = paymentCycleDisplay;
        if (closingDayEl) closingDayEl.textContent = closingDayDisplay;
        if (paymentOffsetEl) paymentOffsetEl.textContent = paymentOffsetDisplay;
        if (paymentDayEl) paymentDayEl.textContent = paymentDayDisplay;

        // æ¥­è€…æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        contractorInfoSection.style.display = 'block';

        console.log('ğŸ“Š æ¥­è€…æƒ…å ±ã‚’è¡¨ç¤º:', {
            name: contractorName,
            paymentCycle: paymentCycleDisplay,
            closingDay: closingDayDisplay,
            paymentOffset: paymentOffsetDisplay,
            paymentDay: paymentDayDisplay
        });
    }
};

// éƒ¨æè²»ç®¡ç†
window.modalMaterialCosts = [];

window.addModalMaterialCostRow = function() {
    const name = $('#modalNewMaterialName').val().trim();
    const unitPrice = parseFloat($('#modalNewMaterialUnitPrice').val()) || 0;
    const quantity = parseFloat($('#modalNewMaterialQuantity').val()) || 0;

    if (!name || unitPrice <= 0 || quantity <= 0) {
        toastr.warning('éƒ¨æåã€å˜ä¾¡ã€æ•°é‡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    const subtotal = unitPrice * quantity;

    const materialItem = {
        id: Date.now(),
        name: name,
        unit_price: unitPrice,
        quantity: quantity,
        subtotal: subtotal
    };

    window.modalMaterialCosts.push(materialItem);
    renderModalMaterialCostTable();
    calculateModalMaterialCostTotal();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#modalNewMaterialName').val('');
    $('#modalNewMaterialUnitPrice').val('');
    $('#modalNewMaterialQuantity').val('');

    console.log('éƒ¨æè²»é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', materialItem);
};

window.removeModalMaterialCostRow = function(id) {
    window.modalMaterialCosts = window.modalMaterialCosts.filter(item => item.id !== id);
    renderModalMaterialCostTable();
    calculateModalMaterialCostTotal();
    console.log('éƒ¨æè²»é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', id);
};

window.renderModalMaterialCostTable = function() {
    const tableBody = $('#modalMaterialCostTableBody');
    tableBody.empty();

    window.modalMaterialCosts.forEach(item => {
        const row = `
            <tr data-material-id="${item.id}">
                <td>${item.name}</td>
                <td class="text-end">Â¥${item.unit_price.toLocaleString()}</td>
                <td class="text-end">${item.quantity}</td>
                <td class="text-end material-subtotal" data-subtotal="${item.subtotal}">Â¥${item.subtotal.toLocaleString()}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeModalMaterialCostRow(${item.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `;
        tableBody.append(row);
    });
};

window.calculateModalMaterialCostTotal = function() {
    const total = window.modalMaterialCosts.reduce((sum, item) => sum + item.subtotal, 0);
    $('#modalMaterialCostTotal').text('Â¥' + total.toLocaleString());

    // æ–™é‡‘ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    if (typeof calculateModalTotal === 'function') {
        calculateModalTotal();
    }

    console.log('âœ… éƒ¨æè²»åˆè¨ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ:', total);
};

window.clearModalMaterialCosts = function() {
    window.modalMaterialCosts = [];
    renderModalMaterialCostTable();
    calculateModalMaterialCostTotal();
};

// å‡ºé‡‘äºˆå®šæ—¥ã®è‡ªå‹•è¨ˆç®—
window.autoCalculatePaymentDueDate = function() {
    console.log('âœ… autoCalculatePaymentDueDate called');

    // æ¥­è€…ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const contractorSelect = document.getElementById('modalContractorSelect');
    if (!contractorSelect || !contractorSelect.value) {
        if (typeof toastr !== 'undefined') {
            toastr.warning('æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        }
        return;
    }

    // é¸æŠã•ã‚ŒãŸæ¥­è€…ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—
    const selectedOption = contractorSelect.options[contractorSelect.selectedIndex];
    const closingDayRaw = selectedOption.getAttribute('data-closing-day');
    const paymentOffsetRaw = selectedOption.getAttribute('data-payment-offset-months');
    const paymentDayRaw = selectedOption.getAttribute('data-payment-day');

    console.log('ğŸ“ æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±:', {
        closingDayRaw,
        paymentOffsetRaw,
        paymentDayRaw
    });

    // å¿…è¦ãªæƒ…å ±ãŒæƒã£ã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆpaymentOffsetRawã¯ç©ºæ–‡å­—åˆ—ã§ã‚‚OK = 0ã¨ã—ã¦æ‰±ã†ï¼‰
    if (!closingDayRaw || paymentOffsetRaw === null || paymentOffsetRaw === undefined || !paymentDayRaw) {
        if (typeof toastr !== 'undefined') {
            toastr.warning('é¸æŠã•ã‚ŒãŸæ¥­è€…ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãŒä¸å®Œå…¨ã§ã™ï¼ˆç· æ—¥ãƒ»æ”¯æ‰•æ—¥ãŒå¿…è¦ã§ã™ï¼‰');
        }
        console.error('âŒ æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãŒä¸è¶³:', {
            closingDayRaw,
            paymentOffsetRaw,
            paymentDayRaw
        });
        return;
    }

    const closingDay = parseInt(closingDayRaw);
    // ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯0ï¼ˆå½“æœˆï¼‰ã¨ã—ã¦æ‰±ã†
    const paymentOffsetMonths = paymentOffsetRaw === '' ? 0 : parseInt(paymentOffsetRaw);
    const paymentDay = parseInt(paymentDayRaw);

    console.log('ğŸ“ ãƒ‘ãƒ¼ã‚¹å¾Œã®å€¤:', {
        closingDay,
        paymentOffsetMonths,
        paymentDay
    });

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth(); // 0-11
    const currentDay = today.getDate();

    // æ¬¡ã®ç· æ—¥ã‚’è¨ˆç®—
    let closingDate;
    if (currentDay <= closingDay) {
        // ä»Šæœˆã®ç· æ—¥ãŒã¾ã æ¥ã¦ã„ãªã„
        closingDate = new Date(currentYear, currentMonth, closingDay);
    } else {
        // ä»Šæœˆã®ç· æ—¥ã‚’éãã¦ã„ã‚‹ â†’ æ¥æœˆã®ç· æ—¥
        closingDate = new Date(currentYear, currentMonth + 1, closingDay);
    }

    console.log('ğŸ“… ç· æ—¥:', closingDate.toISOString().split('T')[0]);

    // æ”¯æ‰•æœˆã‚’è¨ˆç®—ï¼ˆç· æ—¥ + ã‚ªãƒ•ã‚»ãƒƒãƒˆæœˆï¼‰
    const paymentDate = new Date(
        closingDate.getFullYear(),
        closingDate.getMonth() + paymentOffsetMonths,
        paymentDay
    );

    console.log('ğŸ’° å‡ºé‡‘äºˆå®šæ—¥:', paymentDate.toISOString().split('T')[0]);

    // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®šï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    const paymentDueDateInput = document.getElementById('modalPaymentDueDate');
    if (paymentDueDateInput) {
        const dateStr = paymentDate.toISOString().split('T')[0];
        paymentDueDateInput.value = dateStr;

        if (typeof toastr !== 'undefined') {
            toastr.success(`å‡ºé‡‘äºˆå®šæ—¥ã‚’ ${dateStr} ã«è¨­å®šã—ã¾ã—ãŸ`);
        }
    }
};

// ==========================================
// Phase 2.2ã§è¿½åŠ ã“ã“ã¾ã§
// ==========================================

// ==========================================
// Phase 3.2ã§è¿½åŠ : å·¥ç¨‹é¸æŠã¨é‡‘é¡è¨­å®š
// ==========================================

// å·¥ç¨‹é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ãƒãƒ³ãƒ‰ãƒ«
window.handleModalStepSelection = function() {
    const checkedSteps = $('.modal-step-checkbox:checked');
    const costAllocationSection = $('#modalCostAllocationSection');
    const perStepAmountsSection = $('#modalPerStepAmountsSection');

    if (checkedSteps.length > 1) {
        // è¤‡æ•°ã®å·¥ç¨‹ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€é‡‘é¡è¨­å®šæ–¹æ³•ã‚’è¡¨ç¤º
        costAllocationSection.show();
    } else {
        // 1ã¤ä»¥ä¸‹ã®å ´åˆã¯éè¡¨ç¤º
        costAllocationSection.hide();
        perStepAmountsSection.hide();
        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ä¸€å¼ã«ãƒªã‚»ãƒƒãƒˆ
        $('#modalCostLumpSum').prop('checked', true);
    }

    // å·¥ç¨‹ã”ã¨ã®é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    updateModalPerStepAmountFields();
};

// é‡‘é¡è¨­å®šæ–¹æ³•ã®å¤‰æ›´ã‚’ãƒãƒ³ãƒ‰ãƒ«
window.handleModalCostAllocationMethod = function() {
    const method = $('input[name="modal_cost_allocation_method"]:checked').val();
    const perStepAmountsSection = $('#modalPerStepAmountsSection');

    if (method === 'per_step') {
        perStepAmountsSection.show();
        updateModalPerStepAmountFields();
    } else {
        perStepAmountsSection.hide();
    }
};

// å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‹•çš„ç”Ÿæˆ
window.updateModalPerStepAmountFields = function() {
    const checkedSteps = $('.modal-step-checkbox:checked');
    const container = $('#modalPerStepAmountFields');
    container.empty();

    const stepNames = {
        'step_survey': 'ç¾èª¿',
        'step_construction_start': 'ç€å·¥',
        'step_attendance': 'ç«‹ã¡ä¼šã„'
    };

    const stepIcons = {
        'step_survey': 'fas fa-clipboard-list text-info',
        'step_construction_start': 'fas fa-hard-hat text-warning',
        'step_attendance': 'fas fa-user-check text-success'
    };

    checkedSteps.each(function() {
        const stepKey = $(this).val();
        const stepName = stepNames[stepKey];
        const stepIcon = stepIcons[stepKey];

        const fieldHtml = `
            <div class="mb-3">
                <label class="form-label">
                    <i class="${stepIcon} me-1"></i>${stepName}ã®é‡‘é¡
                </label>
                <div class="input-group">
                    <span class="input-group-text">Â¥</span>
                    <input type="number"
                           name="modal_step_amount_${stepKey}"
                           class="form-control modal-step-amount"
                           data-step="${stepKey}"
                           placeholder="0"
                           min="0">
                </div>
            </div>
        `;
        container.append(fieldHtml);
    });
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒªã‚¢æ™‚ã«å·¥ç¨‹é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
window.clearModalStepSelection = function() {
    $('.modal-step-checkbox').prop('checked', false);
    $('#modalCostAllocationSection').hide();
    $('#modalPerStepAmountsSection').hide();
    $('#modalCostLumpSum').prop('checked', true);
    $('#modalPerStepAmountFields').empty();
};

// ==========================================
// Phase 3.2ã§è¿½åŠ ã“ã“ã¾ã§
// ==========================================

console.log('âœ… All functions loaded:', {
    fn1: typeof window.openBasicInfoContractorManagementPanel,
    fn2: typeof window.openAddImplementationModal,
    fn3: typeof window.closeModal,
    fn4: typeof window.toggleImplementationType,
    fn5: typeof window.clearImplementationModalForms,
    fn6: typeof window.addToImplementationList,
    fn7: typeof window.removeImplementationItem
});

// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
function switchFormViewMode(mode) {
    const tabViewBtn = document.getElementById('tabViewBtn');
    const fullViewBtn = document.getElementById('fullViewBtn');
    const tabNav = document.getElementById('projectFormTabs');
    const tabContent = document.getElementById('projectFormTabsContent');
    const tabPanes = document.querySelectorAll('#projectFormTabsContent .tab-pane');

    if (mode === 'tab') {
        // ã‚¿ãƒ–è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        tabViewBtn.classList.add('active');
        fullViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        tabNav.style.display = 'flex';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        tabContent.classList.remove('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // æœ€åˆã®ã‚¿ãƒ–ã‚’è¡¨ç¤º
        const firstPane = document.getElementById('basic');
        if (firstPane) {
            firstPane.classList.add('show', 'active');
        }

        // æœ€åˆã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        const tabButtons = document.querySelectorAll('#projectFormTabs .nav-link');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        const firstButton = document.getElementById('basic-tab');
        if (firstButton) {
            firstButton.classList.add('active');
        }

    } else if (mode === 'full') {
        // å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        fullViewBtn.classList.add('active');
        tabViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        tabNav.style.display = 'none';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        tabContent.classList.add('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        tabPanes.forEach(pane => {
            pane.classList.add('show', 'active');
        });
    }

    // é¸æŠçŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('projectFormViewMode', mode);
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œæ™‚ã®å€¤ä¿æŒç”¨ï¼‰
function saveFormValues() {
    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    if (siteNameField && siteNameField.value) {
        localStorage.setItem('project_form_site_name', siteNameField.value);
    }
    if (siteAddressField && siteAddressField.value) {
        localStorage.setItem('project_form_site_address', siteAddressField.value);
    }

    console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', {
        site_name: siteNameField?.value || '(ç©º)',
        site_address: siteAddressField?.value || '(ç©º)'
    });
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
function restoreFormValues() {
    const savedSiteName = localStorage.getItem('project_form_site_name');
    const savedSiteAddress = localStorage.getItem('project_form_site_address');

    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    // ç¾åœ¨ã®å€¤ãŒç©ºã®å ´åˆã®ã¿å¾©å…ƒ
    if (savedSiteName && siteNameField && !siteNameField.value) {
        siteNameField.value = savedSiteName;
        console.log('âœ… site_name ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', savedSiteName);
    }
    if (savedSiteAddress && siteAddressField && !siteAddressField.value) {
        siteAddressField.value = savedSiteAddress;
        console.log('âœ… site_address ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', savedSiteAddress);
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æˆåŠŸæ™‚ç”¨ï¼‰
function clearSavedFormValues() {
    localStorage.removeItem('project_form_site_name');
    localStorage.removeItem('project_form_site_address');
    console.log('ğŸ—‘ï¸ ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
document.addEventListener('DOMContentLoaded', function() {
    const savedMode = localStorage.getItem('projectFormViewMode');
    if (savedMode === 'full') {
        switchFormViewMode('full');
    }

    // å—æ³¨ãƒ¨ãƒŸã®ãƒãƒƒã‚¸ã‚’åˆæœŸåŒ–
    if (typeof updateProjectStatusBadge === 'function') {
        updateProjectStatusBadge();
    }

    // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’å¾©å…ƒï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œï¼‰
    restoreFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›æ™‚ã«è‡ªå‹•ä¿å­˜
    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    if (siteNameField) {
        siteNameField.addEventListener('input', saveFormValues);
    }
    if (siteAddressField) {
        siteAddressField.addEventListener('input', saveFormValues);
    }

    // å…ƒè«‹ä¼šç¤¾é¸æŠæ™‚ã«æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•ã‚³ãƒ”ãƒ¼
    const clientCompanySelect = document.getElementById('clientCompanySelect');
    if (clientCompanySelect) {
        clientCompanySelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‹ã‚‰æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—
                const paymentCycle = selectedOption.getAttribute('data-payment-cycle');
                const closingDay = selectedOption.getAttribute('data-closing-day');
                const paymentDay = selectedOption.getAttribute('data-payment-day');

                // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
                const paymentCycleField = document.getElementById('{{ form.payment_cycle.id_for_label }}');
                const closingDayField = document.getElementById('{{ form.closing_day.id_for_label }}');
                const paymentDayField = document.getElementById('{{ form.payment_day.id_for_label }}');

                // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ï¼ˆç©ºæ–‡å­—åˆ—ã§ã‚‚è¨­å®šï¼‰
                if (paymentCycleField) {
                    paymentCycleField.value = paymentCycle || '';
                }

                // ç· ã‚æ—¥ï¼ˆå€¤ãŒã‚ã‚‹å ´åˆã®ã¿è¨­å®šã€ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¯ãƒªã‚¢ï¼‰
                if (closingDayField) {
                    if (closingDay && closingDay !== '' && closingDay !== 'null' && closingDay !== 'None') {
                        closingDayField.value = closingDay;
                    } else {
                        closingDayField.value = '';
                    }
                }

                // æ”¯æ‰•ã„æ—¥ï¼ˆå€¤ãŒã‚ã‚‹å ´åˆã®ã¿è¨­å®šã€ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¯ãƒªã‚¢ï¼‰
                if (paymentDayField) {
                    if (paymentDay && paymentDay !== '' && paymentDay !== 'null' && paymentDay !== 'None') {
                        paymentDayField.value = paymentDay;
                    } else {
                        paymentDayField.value = '';
                    }
                }

                console.log('âœ… æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã—ãŸ:', {
                    paymentCycle: paymentCycle || '(æœªè¨­å®š)',
                    closingDay: closingDay || '(æœªè¨­å®š)',
                    paymentDay: paymentDay || '(æœªè¨­å®š)'
                });
            }
        });
    }
});

// ============================================
// å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«
// ============================================

// å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã
window.openClientCompanyManagementPanel = function() {
    console.log('âœ… openClientCompanyManagementPanel called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('clientCompanyManagementModal'));
    modal.show();

    // å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    refreshClientCompanyList();

    // æ¤œç´¢æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
    setTimeout(function() {
        const searchInput = $('#clientCompanySearchInput');
        if (searchInput.length) {
            searchInput.off('input').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterClientCompanyList(searchTerm);
            });
        }
    }, 100);
};

// å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°
window.refreshClientCompanyList = function() {
    console.log('âœ… refreshClientCompanyList called');

    const tbody = $('#clientCompanyTableBody');
    tbody.html('<tr><td colspan="10" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>èª­ã¿è¾¼ã¿ä¸­...</td></tr>');

    // AJAXã§æœ€æ–°ã®å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’å–å¾—
    $.ajax({
        url: '{% url "order_management:client_company_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (!response.success || !response.companies) {
                tbody.html('<tr><td colspan="10" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>');
                return;
            }

            const allClientCompanies = response.companies;

    // ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’ç¢ºèª
    console.log('ğŸ“‹ å…ƒè«‹ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿:', allClientCompanies);
    if (allClientCompanies && allClientCompanies.length > 0) {
        console.log('ğŸ“‹ æœ€åˆã®å…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿è©³ç´°:', allClientCompanies[0]);
    }

    if (!allClientCompanies || allClientCompanies.length === 0) {
        tbody.html('<tr><td colspan="10" class="text-center text-muted">å…ƒè«‹ä¼šç¤¾ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>');
        return;
    }

    let html = '';
    allClientCompanies.forEach(function(company) {
        const statusBadge = company.is_active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        const paymentCycleText = company.payment_cycle_label || '-';

        // ç· ã‚æ—¥: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ0ã¯ç„¡åŠ¹ãªå€¤ãªã®ã§é™¤å¤–ï¼‰
        const closingDayText = (company.closing_day !== null && company.closing_day !== undefined)
            ? `${company.closing_day}æ—¥` : '-';

        // æ”¯æ‰•æœˆ: payment_offset_monthsã®å€¤ã‚’è¡¨ç¤º
        const paymentOffsetMonthsText = company.payment_offset_months_label || '-';

        // æ”¯æ‰•ã„æ—¥: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ0ã¯ç„¡åŠ¹ãªå€¤ãªã®ã§é™¤å¤–ï¼‰
        const paymentDayText = (company.payment_day !== null && company.payment_day !== undefined)
            ? `${company.payment_day}æ—¥` : '-';

        // ãƒ‡ãƒãƒƒã‚°: å„ä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        console.log(`  - ${company.company_name}: ç· ã‚æ—¥=${company.closing_day}, æ”¯æ‰•æœˆ=${company.payment_offset_months}, æ”¯æ‰•ã„æ—¥=${company.payment_day}`);

        html += `
            <tr style="cursor: pointer;" onclick="selectClientCompany(${company.id})" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                <td><strong>${escapeHtml(company.company_name)}</strong></td>
                <td>${escapeHtml(company.address || '-')}</td>
                <td>${escapeHtml(company.phone || '-')}</td>
                <td>${escapeHtml(company.contact_person || '-')}</td>
                <td class="text-center">${paymentCycleText}</td>
                <td class="text-center">${closingDayText}</td>
                <td class="text-center">${paymentOffsetMonthsText}</td>
                <td class="text-center">${paymentDayText}</td>
                <td class="text-center">${statusBadge}</td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-outline-primary" onclick="editClientCompany(${company.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.html(html);
        },
        error: function(xhr, status, error) {
            console.error('âŒ å…ƒè«‹ä¼šç¤¾ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            tbody.html('<tr><td colspan="10" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error + '</td></tr>');
        }
    });
};

// å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
window.selectClientCompany = function(companyId) {
    console.log('âœ… selectClientCompany called', companyId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const modal = bootstrap.Modal.getInstance(document.getElementById('clientCompanyManagementModal'));
    if (modal) modal.hide();

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠ
    $('#clientCompanySelect').val(companyId);

    // allClientCompaniesé…åˆ—ã‹ã‚‰é¸æŠã•ã‚ŒãŸä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const allClientCompanies = {{ client_companies_json|safe }};
    const selectedCompany = allClientCompanies.find(c => c.id === companyId);

    if (selectedCompany) {
        console.log('âœ… é¸æŠã•ã‚ŒãŸå…ƒè«‹ä¼šç¤¾:', selectedCompany);
        console.log('ğŸ” payment_offset_months ã®å€¤:', selectedCompany.payment_offset_months);
        console.log('ğŸ” payment_offset_months ã®å‹:', typeof selectedCompany.payment_offset_months);
        console.log('ğŸ” ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒ¼ä¸€è¦§:', Object.keys(selectedCompany));

        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºã¨éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
        const paymentCycleField = document.getElementById('{{ form.payment_cycle.id_for_label }}');
        const closingDayField = document.getElementById('{{ form.closing_day.id_for_label }}');
        const paymentOffsetMonthsField = document.getElementById('{{ form.payment_offset_months.id_for_label }}');
        const paymentDayField = document.getElementById('{{ form.payment_day.id_for_label }}');

        const paymentCycleCard = document.getElementById('paymentCycleInfoCard');
        const paymentCycleLabels = {
            'monthly': 'æœˆ1å›',
            'bimonthly': 'æœˆ2å›',
            'weekly': 'é€±1å›',
            'custom': 'ãã®ä»–'
        };
        const monthLabels = {0: 'å½“æœˆ', 1: 'ç¿Œæœˆ', 2: 'ç¿Œã€…æœˆ', 3: '3ãƒ¶æœˆå¾Œ'};

        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«
        if (paymentCycleField) {
            paymentCycleField.value = selectedCompany.payment_cycle || '';
            document.getElementById('displayPaymentCycle').textContent = paymentCycleLabels[selectedCompany.payment_cycle] || '-';
            console.log('  - æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«:', selectedCompany.payment_cycle || '(æœªè¨­å®š)');
        }

        // ç· ã‚æ—¥
        if (closingDayField) {
            if (selectedCompany.closing_day !== null && selectedCompany.closing_day !== undefined && selectedCompany.closing_day !== '') {
                closingDayField.value = selectedCompany.closing_day;
                document.getElementById('displayClosingDay').textContent = selectedCompany.closing_day + 'æ—¥' + (selectedCompany.closing_day == 31 ? ' (æœˆæœ«)' : '');
                console.log('  - ç· ã‚æ—¥:', selectedCompany.closing_day + 'æ—¥');
            } else {
                closingDayField.value = '';
                document.getElementById('displayClosingDay').textContent = '-';
                console.log('  - ç· ã‚æ—¥: (æœªè¨­å®š)');
            }
        }

        // æ”¯æ‰•æœˆ
        if (paymentOffsetMonthsField) {
            if (selectedCompany.payment_offset_months !== null && selectedCompany.payment_offset_months !== undefined && selectedCompany.payment_offset_months !== '') {
                paymentOffsetMonthsField.value = selectedCompany.payment_offset_months;
                document.getElementById('displayPaymentOffsetMonths').textContent = monthLabels[selectedCompany.payment_offset_months] || selectedCompany.payment_offset_months + 'ãƒ¶æœˆå¾Œ';
                console.log('  - æ”¯æ‰•æœˆ:', monthLabels[selectedCompany.payment_offset_months] || selectedCompany.payment_offset_months + 'ãƒ¶æœˆå¾Œ');
            } else {
                paymentOffsetMonthsField.value = '';
                document.getElementById('displayPaymentOffsetMonths').textContent = '-';
                console.log('  - æ”¯æ‰•æœˆ: (æœªè¨­å®š)');
            }
        }

        // æ”¯æ‰•ã„æ—¥
        if (paymentDayField) {
            if (selectedCompany.payment_day !== null && selectedCompany.payment_day !== undefined && selectedCompany.payment_day !== '') {
                paymentDayField.value = selectedCompany.payment_day;
                document.getElementById('displayPaymentDay').textContent = selectedCompany.payment_day + 'æ—¥';
                console.log('  - æ”¯æ‰•ã„æ—¥:', selectedCompany.payment_day + 'æ—¥');
            } else {
                paymentDayField.value = '';
                document.getElementById('displayPaymentDay').textContent = '-';
                console.log('  - æ”¯æ‰•ã„æ—¥: (æœªè¨­å®š)');
            }
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        if (paymentCycleCard) {
            paymentCycleCard.style.display = 'block';
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (typeof toastr !== 'undefined') {
            toastr.success(`ã€Œ${selectedCompany.company_name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
        }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã®å…ˆé ­ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('html, body').animate({
        scrollTop: $('#clientCompanySelect').offset().top - 100
    }, 500);
};

// å…ƒè«‹ä¼šç¤¾ç·¨é›†ï¼ˆåˆ¥ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼‰
window.editClientCompany = function(companyId) {
    window.open(`/orders/client-companies/${companyId}/edit/`, '_blank');
};

// å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
window.filterClientCompanyList = function(searchTerm) {
    console.log('ğŸ” Filtering client companies:', searchTerm);

    const rows = $('#clientCompanyTableBody tr');

    if (!searchTerm || searchTerm.trim() === '') {
        rows.show();
        return;
    }

    rows.each(function() {
        const row = $(this);
        const companyName = row.find('td:first strong').text().toLowerCase();
        const address = row.find('td:nth-child(2)').text().toLowerCase();
        const phone = row.find('td:nth-child(3)').text().toLowerCase();

        if (companyName.includes(searchTerm) ||
            address.includes(searchTerm) ||
            phone.includes(searchTerm)) {
            row.show();
        } else {
            row.hide();
        }
    });

    // æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const visibleRows = rows.filter(':visible').length;
    if (visibleRows === 0) {
        const tbody = $('#clientCompanyTableBody');
        if (tbody.find('.no-results-row').length === 0) {
            tbody.append('<tr class="no-results-row"><td colspan="10" class="text-center text-muted py-4"><i class="fas fa-search me-2"></i>ã€Œ' + escapeHtml(searchTerm) + 'ã€ã«ä¸€è‡´ã™ã‚‹å…ƒè«‹ä¼šç¤¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>');
        }
    } else {
        $('#clientCompanyTableBody .no-results-row').remove();
    }
};

// æ–°è¦å…ƒè«‹ä¼šç¤¾è¿½åŠ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§ä½œæˆï¼‰
window.addNewClientCompany = function() {
    openClientCompanyCreateModal();
};

// éµå—ã‘æ¸¡ã—è¨­å®šã®æŠ˜ã‚ŠãŸãŸã¿åˆ‡ã‚Šæ›¿ãˆ
window.toggleKeyHandoverSection = function() {
    const section = document.getElementById('keyHandoverSection');
    const toggleBtn = document.getElementById('keyHandoverToggleBtn');
    const toggleIcon = document.getElementById('keyHandoverToggleIcon');

    if (!section || !toggleBtn || !toggleIcon) return;

    if (section.style.display === 'none') {
        // å±•é–‹
        section.style.display = 'block';
        toggleIcon.classList.remove('fa-plus');
        toggleIcon.classList.add('fa-minus');
        toggleBtn.innerHTML = '<i class="fas fa-minus me-1" id="keyHandoverToggleIcon"></i><i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’é–‰ã˜ã‚‹';
    } else {
        // æŠ˜ã‚ŠãŸãŸã¿
        section.style.display = 'none';
        toggleIcon.classList.remove('fa-minus');
        toggleIcon.classList.add('fa-plus');
        toggleBtn.innerHTML = '<i class="fas fa-plus me-1" id="keyHandoverToggleIcon"></i><i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’è¿½åŠ ';
    }
};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼šéµå—ã‘æ¸¡ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•å±•é–‹
document.addEventListener('DOMContentLoaded', function() {
    const keyLocation = document.getElementById('{{ form.key_handover_location.id_for_label }}');
    const keyDate = document.getElementById('{{ form.key_handover_date.id_for_label }}');
    const keyNotes = document.getElementById('{{ form.key_handover_notes.id_for_label }}');

    // ã„ãšã‚Œã‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•å±•é–‹
    if ((keyLocation && keyLocation.value) ||
        (keyDate && keyDate.value) ||
        (keyNotes && keyNotes.value)) {
        toggleKeyHandoverSection();
    }
});

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>

<!-- å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="clientCompanyManagementModal" tabindex="-1" aria-labelledby="clientCompanyManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientCompanyManagementModalLabel">
                    <i class="fas fa-building"></i> å…ƒè«‹ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">ç™»éŒ²å…ƒè«‹ä¼šç¤¾ä¸€è¦§</h6>
                    <div class="d-flex gap-2">
                        <input type="text" id="clientCompanySearchInput" class="form-control form-control-sm" placeholder="å…ƒè«‹ä¼šç¤¾åã§æ¤œç´¢..." style="width: 250px;">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewClientCompany()">
                            <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- å…ƒè«‹ä¼šç¤¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>ä¼šç¤¾å</th>
                                <th>ä½æ‰€</th>
                                <th>é›»è©±ç•ªå·</th>
                                <th>æ‹…å½“è€…</th>
                                <th class="text-center">æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«</th>
                                <th class="text-center">ç· ã‚æ—¥</th>
                                <th class="text-center">æ”¯æ‰•æœˆ</th>
                                <th class="text-center">æ”¯æ‰•ã„æ—¥</th>
                                <th class="text-center">çŠ¶æ…‹</th>
                                <th style="width: 140px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="clientCompanyTableBody">
                            <tr>
                                <td colspan="10" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- å·¥äº‹ç¨®åˆ¥ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="workTypeManagementModal" tabindex="-1" aria-labelledby="workTypeManagementModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <h5 class="modal-title" id="workTypeManagementModalLabel">
                    <i class="fas fa-tools me-2"></i>å·¥äº‹ç¨®åˆ¥ç®¡ç†
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- æ—¢å­˜ã®å·¥äº‹ç¨®åˆ¥ä¸€è¦§ -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-list me-2"></i>ç™»éŒ²æ¸ˆã¿å·¥äº‹ç¨®åˆ¥
                    </h6>
                    <div id="workTypeList" class="mb-3">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin me-2"></i>èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>

                <!-- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="border-top pt-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-plus-circle me-2"></i>æ–°ã—ã„å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ 
                    </h6>
                    <form id="workTypeForm">
                        {% csrf_token %}
                        <input type="hidden" id="workTypeId" name="id" value="">

                        <div class="mb-3">
                            <label for="workTypeName" class="form-label">
                                ç¨®åˆ¥å <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="workTypeName" name="name" required maxlength="100">
                        </div>

                        <div class="mb-3">
                            <label for="workTypeDescription" class="form-label">èª¬æ˜</label>
                            <textarea class="form-control" id="workTypeDescription" name="description" rows="2"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success" id="workTypeSubmitBtn">
                                <i class="fas fa-save me-2"></i>ä¿å­˜ã™ã‚‹
                            </button>
                            <button type="button" class="btn btn-secondary" id="workTypeCancelBtn" style="display: none;" onclick="cancelWorkTypeEdit()">
                                <i class="fas fa-times me-2"></i>ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </form>

                    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="workTypeError" class="alert alert-danger mt-3" style="display: none;"></div>
                    <div id="workTypeSuccess" class="alert alert-success mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å·¥äº‹ç¨®åˆ¥å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="workTypeDeleteConfirmModal" tabindex="-1" aria-hidden="true" style="z-index: 10050 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>å‰Šé™¤ã®ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">å·¥äº‹ç¨®åˆ¥ã€Œ<strong id="deleteWorkTypeName"></strong>ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-info-circle me-2"></i>æ¡ˆä»¶ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteWorkTypeBtn">
                    <i class="fas fa-trash me-2"></i>å‰Šé™¤ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å…ƒè«‹ä¼šç¤¾æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="clientCompanyCreateModal" tabindex="-1" aria-labelledby="clientCompanyCreateModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="clientCompanyCreateModalLabel">
                    <i class="fas fa-building me-2"></i>å…ƒè«‹ä¼šç¤¾æ–°è¦ç™»éŒ²
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="clientCompanyCreateForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- å…ƒè«‹æ¥­è€…ã¨ã¯ï¼ˆèª¬æ˜ï¼‰ -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-info-circle me-2"></i>å…ƒè«‹æ¥­è€…ã¨ã¯</h6>
                        <p class="mb-2">
                            ã“ã®ç”»é¢ã§ã¯<strong>å…ƒè«‹æ¥­è€…ï¼ˆç™ºæ³¨å…ƒä¼æ¥­ï¼‰</strong>ã®æƒ…å ±ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
                        </p>
                        <ul class="mb-0" style="font-size: 0.9rem;">
                            <li>å…ƒè«‹æ¥­è€…: æ¡ˆä»¶ã‚’ç™ºæ³¨ã™ã‚‹ä¼šç¤¾</li>
                            <li>è·äººãƒ»ä¸‹è«‹ã‘æ¥­è€…: æ¡ˆä»¶ä½œæˆæ™‚ã®ã€Œä½œæ¥­è€…è¿½åŠ ã€ã¾ãŸã¯ã€Œæ¥­è€…ç®¡ç†ã€ç”»é¢ã§ç™»éŒ²ã—ã¦ãã ã•ã„</li>
                        </ul>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-info-circle me-2"></i>åŸºæœ¬æƒ…å ±
                        </h6>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="newCompanyName" class="form-label" style="font-weight: 500;">
                                ä¼šç¤¾å <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="newCompanyName" name="company_name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="newContactPerson" class="form-label" style="font-weight: 500;">
                                æ‹…å½“è€…å
                            </label>
                            <input type="text" class="form-control" id="newContactPerson" name="contact_person">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="newEmail" class="form-label" style="font-weight: 500;">
                                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                            </label>
                            <input type="email" class="form-control" id="newEmail" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newPhone" class="form-label" style="font-weight: 500;">
                                é›»è©±ç•ªå·
                            </label>
                            <input type="tel" class="form-control" id="newPhone" name="phone">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="newAddress" class="form-label" style="font-weight: 500;">
                            ä½æ‰€
                        </label>
                        <textarea class="form-control" id="newAddress" name="address" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="newWebsite" class="form-label" style="font-weight: 500;">
                            ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
                        </label>
                        <input type="url" class="form-control" id="newWebsite" name="website">
                        <small class="text-muted">ä¼šç¤¾ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURLï¼ˆä¾‹ï¼šhttps://example.comï¼‰</small>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="newInvoiceSubmissionDeadline" class="form-label" style="font-weight: 500;">
                                è«‹æ±‚æ›¸æå‡ºæœŸé™ï¼ˆæ—¥ï¼‰
                            </label>
                            <input type="number" class="form-control" id="newInvoiceSubmissionDeadline" name="invoice_submission_deadline" min="1" max="31">
                            <small class="text-muted">æ¯æœˆã®è«‹æ±‚æ›¸æå‡ºæœŸé™æ—¥ï¼ˆä¾‹ï¼š25æ—¥æå‡ºã®å ´åˆã¯25ï¼‰</small>
                        </div>
                        <div class="col-md-8 mb-3">
                            <label for="newInvoiceSubmissionNotes" class="form-label" style="font-weight: 500;">
                                è«‹æ±‚æ›¸æå‡ºæœŸé™ è£œè¶³èª¬æ˜
                            </label>
                            <input type="text" class="form-control" id="newInvoiceSubmissionNotes" name="invoice_submission_notes">
                            <small class="text-muted">ä¾‹ï¼šæ¯æœˆ25æ—¥å¿…ç€ã€æœˆæœ«å¿…ç€ãªã©</small>
                        </div>
                    </div>

                    <!-- æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«è¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-money-bill-wave me-2"></i>æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«è¨­å®š
                        </h6>
                    </div>

                    <div class="alert alert-secondary mb-3">
                        <small>ã“ã“ã§è¨­å®šã—ãŸæ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ã¯ã€æ¡ˆä»¶ç™»éŒ²æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚æ¡ˆä»¶ã”ã¨ã«å€‹åˆ¥ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</small>
                    </div>

                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="newPaymentCycle" class="form-label" style="font-weight: 500;">
                                æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«
                            </label>
                            <select class="form-select" id="newPaymentCycle" name="payment_cycle">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="monthly">æœˆæ‰•ã„</option>
                                <option value="bimonthly">éš”æœˆæ‰•ã„</option>
                                <option value="quarterly">å››åŠæœŸæ‰•ã„</option>
                                <option value="half_yearly">åŠå¹´æ‰•ã„</option>
                                <option value="yearly">å¹´æ‰•ã„</option>
                                <option value="other">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="newClosingDay" class="form-label" style="font-weight: 500;">
                                ç· ã‚æ—¥
                            </label>
                            <input type="number" class="form-control" id="newClosingDay" name="closing_day" min="1" max="31">
                            <small class="text-muted">æœˆæœ«ç· ã‚ã®å ´åˆã¯31ã€20æ—¥ç· ã‚ã®å ´åˆã¯20</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="newPaymentOffsetMonths" class="form-label" style="font-weight: 500;">
                                æ”¯æ‰•æœˆ
                            </label>
                            <select class="form-select" id="newPaymentOffsetMonths" name="payment_offset_months">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="0">å½“æœˆ</option>
                                <option value="1">ç¿Œæœˆ</option>
                                <option value="2">ç¿Œã€…æœˆ</option>
                                <option value="3">3ãƒ¶æœˆå¾Œ</option>
                            </select>
                            <small class="text-muted">ç· æ—¥ã‹ã‚‰ä½•ãƒ¶æœˆå¾Œã«æ”¯æ‰•ã†ã‹</small>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="newPaymentDay" class="form-label" style="font-weight: 500;">
                                æ”¯æ‰•æ—¥
                            </label>
                            <input type="number" class="form-control" id="newPaymentDay" name="payment_day" min="1" max="31">
                            <small class="text-muted">æ¯æœˆã®æ”¯æ‰•æ—¥ï¼ˆ1-31ï¼‰ã€‚ä¾‹ï¼š25æ—¥æ‰•ã„ã®å ´åˆã¯25</small>
                        </div>
                    </div>

                    <!-- éµå—ã‘æ¸¡ã—è¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-key me-2"></i>éµå—ã‘æ¸¡ã—è¨­å®š
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newDefaultKeyHandoverLocation" class="form-label" style="font-weight: 500;">
                            ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå—ã‘æ¸¡ã—å ´æ‰€
                        </label>
                        <input type="text" class="form-control" id="newDefaultKeyHandoverLocation" name="default_key_handover_location">
                        <small class="text-muted">æ¡ˆä»¶ç™»éŒ²æ™‚ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆæ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ï¼‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="newKeyHandoverNotes" class="form-label" style="font-weight: 500;">
                            ç‰¹è¨˜äº‹é …
                        </label>
                        <textarea class="form-control" id="newKeyHandoverNotes" name="key_handover_notes" rows="2"></textarea>
                    </div>

                    <!-- å®Œäº†å ±å‘Šè¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-file-alt me-2"></i>å®Œäº†å ±å‘Šè¨­å®š
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newCompletionReportTemplate" class="form-label" style="font-weight: 500;">
                            å®Œäº†å ±å‘Šã‚·ãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                        </label>
                        <input type="file" class="form-control" id="newCompletionReportTemplate" name="completion_report_template" accept=".xlsx,.xls,.pdf,.doc,.docx">
                        <small class="text-muted">Excel/PDFå½¢å¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="newCompletionReportNotes" class="form-label" style="font-weight: 500;">
                            å®Œäº†å ±å‘Šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹
                        </label>
                        <textarea class="form-control" id="newCompletionReportNotes" name="completion_report_notes" rows="3"></textarea>
                        <small class="text-muted">æ¡ˆä»¶ç™»éŒ²æ™‚ã«å®Œäº†å ±å‘Šå†…å®¹ã¨ã—ã¦è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆæ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ï¼‰</small>
                    </div>

                    <!-- æ¥­å‹™æƒ…å ± -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-briefcase me-2"></i>æ¥­å‹™æƒ…å ±
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" style="font-weight: 500;">
                            å¯¾å¿œå¯èƒ½ãªå·¥äº‹ç¨®åˆ¥
                        </label>
                        <select class="form-select" id="newWorkTypes" name="work_types" multiple size="5">
                            <option value="">å·¥äº‹ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                        <small class="text-muted">ã“ã®å…ƒè«‹ã‹ã‚‰ä¾é ¼ã•ã‚Œã‚‹å·¥äº‹ã®ç¨®é¡ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="newPricingTier" class="form-label" style="font-weight: 500;">
                            å˜ä¾¡å¸¯ãƒ»å…±æœ‰å˜ä¾¡è¡¨
                        </label>
                        <input type="text" class="form-control" id="newPricingTier" name="pricing_tier">
                        <small class="text-muted">ä¾‹ï¼šAå˜ä¾¡è¡¨ã€Bå˜ä¾¡ã®ã¿å…±æœ‰ã€1å¼â—¯ä¸‡å††ãªã©</small>
                    </div>

                    <div class="mb-3">
                        <label for="newSiteRules" class="form-label" style="font-weight: 500;">
                            ç¾å ´ãƒ«ãƒ¼ãƒ«
                        </label>
                        <textarea class="form-control" id="newSiteRules" name="site_rules" rows="3"></textarea>
                        <small class="text-muted">ç¾å ´ã§ã®æ³¨æ„äº‹é …ã‚„ãƒ«ãƒ¼ãƒ«ã‚’ç®‡æ¡æ›¸ãã§å…¥åŠ›</small>
                    </div>

                    <!-- å“è³ªãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-comments me-2"></i>å“è³ªãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newTroubleTendencies" class="form-label" style="font-weight: 500;">
                            ãƒˆãƒ©ãƒ–ãƒ«å‚¾å‘
                        </label>
                        <textarea class="form-control" id="newTroubleTendencies" name="trouble_tendencies" rows="2"></textarea>
                        <small class="text-muted">ä¾‹ï¼šè¿½åŠ æ›¸é¡ãŒå¤šã„ã€ç¾å ´å¤‰æ›´ãŒæ€¥ã€æŒ‡ç¤ºå†…å®¹ãŒæ›–æ˜§ãªã©</small>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="newResponseEaseRating" class="form-label" style="font-weight: 500;">
                                å¯¾å¿œã®ã—ã‚„ã™ã•
                            </label>
                            <select class="form-select" id="newResponseEaseRating" name="response_ease_rating">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="1">1 - éå¸¸ã«å›°é›£</option>
                                <option value="2">2 - ã‚„ã‚„å›°é›£</option>
                                <option value="3">3 - æ™®é€š</option>
                                <option value="4">4 - ã‚„ã‚„å®¹æ˜“</option>
                                <option value="5">5 - éå¸¸ã«å®¹æ˜“</option>
                            </select>
                            <small class="text-muted">é€£çµ¡å¯¾å¿œã‚„æ„æ€æ±ºå®šã®ã‚¹ãƒ ãƒ¼ã‚ºã•ã‚’5æ®µéšã§è©•ä¾¡</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newResponseEaseNotes" class="form-label" style="font-weight: 500;">
                                å¯¾å¿œã®ã—ã‚„ã™ã• è£œè¶³
                            </label>
                            <input type="text" class="form-control" id="newResponseEaseNotes" name="response_ease_notes">
                            <small class="text-muted">å¯¾å¿œã®ã—ã‚„ã™ã•ã«é–¢ã™ã‚‹å…·ä½“çš„ãªæƒ…å ±</small>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="newWorkEaseRating" class="form-label" style="font-weight: 500;">
                                ä½œæ¥­ã®ã—ã‚„ã™ã•
                            </label>
                            <select class="form-select" id="newWorkEaseRating" name="work_ease_rating">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="1">1 - éå¸¸ã«å›°é›£</option>
                                <option value="2">2 - ã‚„ã‚„å›°é›£</option>
                                <option value="3">3 - æ™®é€š</option>
                                <option value="4">4 - ã‚„ã‚„å®¹æ˜“</option>
                                <option value="5">5 - éå¸¸ã«å®¹æ˜“</option>
                            </select>
                            <small class="text-muted">ç¾å ´ã§ã®ä½œæ¥­ã®ã—ã‚„ã™ã•ã‚’5æ®µéšã§è©•ä¾¡</small>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newWorkEaseNotes" class="form-label" style="font-weight: 500;">
                                ä½œæ¥­ã®ã—ã‚„ã™ã• è£œè¶³
                            </label>
                            <input type="text" class="form-control" id="newWorkEaseNotes" name="work_ease_notes">
                            <small class="text-muted">ä½œæ¥­ã®ã—ã‚„ã™ã•ã«é–¢ã™ã‚‹å…·ä½“çš„ãªæƒ…å ±</small>
                        </div>
                    </div>

                    <!-- é‹ç”¨ãƒ«ãƒ¼ãƒ«ãƒ»ç‰¹è¨˜äº‹é … -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-clipboard-list me-2"></i>é‹ç”¨ãƒ«ãƒ¼ãƒ«ãƒ»ç‰¹è¨˜äº‹é …
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newSpecialNotes" class="form-label" style="font-weight: 500;">
                            ç‰¹è¨˜äº‹é …
                        </label>
                        <textarea class="form-control" id="newSpecialNotes" name="special_notes" rows="3"></textarea>
                        <small class="text-muted">ã“ã®ä¼šç¤¾ã¨ã®å–å¼•ã«ãŠã‘ã‚‹æ³¨æ„äº‹é …ã‚„é‹ç”¨ãƒ«ãƒ¼ãƒ«ã‚’è¨˜è¼‰</small>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="newIsActive" name="is_active" checked>
                        <label class="form-check-label" for="newIsActive">
                            ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                        </label>
                    </div>
                </form>

                <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="clientCompanyCreateError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-primary" id="submitClientCompanyBtn" onclick="submitNewClientCompany()">
                    <i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// å…ƒè«‹ä¼šç¤¾æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
window.openClientCompanyCreateModal = function() {
    console.log('âœ… openClientCompanyCreateModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('clientCompanyCreateForm').reset();

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#clientCompanyCreateError').hide();

    // å·¥äº‹ç¨®åˆ¥ã‚’èª­ã¿è¾¼ã¿
    loadWorkTypesForClientModal();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('clientCompanyCreateModal'));
    modal.show();
};

// å·¥äº‹ç¨®åˆ¥ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«èª­ã¿è¾¼ã‚€
function loadWorkTypesForClientModal() {
    $.ajax({
        url: '{% url "order_management:work_type_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const select = $('#newWorkTypes');
                select.empty();
                response.work_types.forEach(function(workType) {
                    select.append(
                        $('<option></option>')
                            .attr('value', workType.id)
                            .text(workType.name)
                    );
                });
                console.log('âœ… å·¥äº‹ç¨®åˆ¥ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', response.work_types.length, 'ä»¶');
            }
        },
        error: function() {
            console.error('âŒ å·¥äº‹ç¨®åˆ¥ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    });
}

// å…ƒè«‹ä¼šç¤¾ã‚’æ–°è¦ä½œæˆ
window.submitNewClientCompany = function() {
    console.log('âœ… submitNewClientCompany called');

    const form = document.getElementById('clientCompanyCreateForm');
    const formData = new FormData(form);

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#clientCompanyCreateError').hide();

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆIDçµŒç”±ã§å–å¾—ï¼‰
    const submitBtn = document.getElementById('submitClientCompanyBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...';

    $.ajax({
        url: '{% url "order_management:client_company_create_ajax" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                console.log('âœ… å…ƒè«‹ä¼šç¤¾ä½œæˆæˆåŠŸ:', response.company);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('clientCompanyCreateModal'));
                if (modal) modal.hide();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«æ–°ã—ã„å…ƒè«‹ä¼šç¤¾ã‚’è¿½åŠ 
                const select = $('#clientCompanySelect');
                const newOption = new Option(
                    response.company.company_name + (response.company.address ? ' - ' + response.company.address : ''),
                    response.company.id,
                    false,
                    true
                );
                $(newOption).attr('data-name', response.company.company_name);
                $(newOption).attr('data-address', response.company.address || '');
                $(newOption).attr('data-payment-cycle', response.company.payment_cycle || '');
                $(newOption).attr('data-closing-day', response.company.closing_day || '');
                $(newOption).attr('data-payment-day', response.company.payment_day || '');
                select.append(newOption);

                // æ–°ã—ã„å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠ
                select.val(response.company.id).trigger('change');

                // å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°ï¼ˆç®¡ç†ãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆï¼‰
                if (typeof refreshClientCompanyList === 'function') {
                    console.log('âœ… å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°ä¸­...');
                    setTimeout(function() {
                        refreshClientCompanyList();
                    }, 100);
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (typeof toastr !== 'undefined') {
                    toastr.success('å…ƒè«‹ä¼šç¤¾ã€Œ' + response.company.company_name + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
                } else {
                    alert('å…ƒè«‹ä¼šç¤¾ã€Œ' + response.company.company_name + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
                }

                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
            } else {
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorHtml = '<strong>ã‚¨ãƒ©ãƒ¼:</strong><ul class="mb-0">';
                if (response.errors) {
                    for (let field in response.errors) {
                        response.errors[field].forEach(function(error) {
                            errorHtml += '<li>' + error + '</li>';
                        });
                    }
                } else {
                    errorHtml += '<li>' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') + '</li>';
                }
                errorHtml += '</ul>';
                $('#clientCompanyCreateError').html(errorHtml).show();

                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ å…ƒè«‹ä¼šç¤¾ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            $('#clientCompanyCreateError').html('<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + (xhr.responseJSON?.error || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();

            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
        }
    });
};

// ===== å·¥äº‹ç¨®åˆ¥ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« =====
// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
window.openWorkTypeManagementModal = function() {
    console.log('âœ… openWorkTypeManagementModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('workTypeManagementModal'));
    modal.show();

    // å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    loadWorkTypeList();
};

// å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
function loadWorkTypeList() {
    $.ajax({
        url: '{% url "order_management:work_type_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                renderWorkTypeList(response.work_types);
            } else {
                $('#workTypeList').html('<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
            }
        },
        error: function() {
            $('#workTypeList').html('<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
        }
    });
}

// å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’æç”»
function renderWorkTypeList(workTypes) {
    if (workTypes.length === 0) {
        $('#workTypeList').html('<div class="text-muted text-center py-3">ç™»éŒ²æ¸ˆã¿ã®å·¥äº‹ç¨®åˆ¥ã¯ã‚ã‚Šã¾ã›ã‚“</div>');
        return;
    }

    let html = '<div class="list-group">';
    workTypes.forEach(function(workType, index) {
        const escapedName = $('<div>').text(workType.name).html();
        const escapedDesc = $('<div>').text(workType.description || '').html();

        html += `
            <div class="list-group-item list-group-item-action"
                 style="cursor: pointer; transition: all 0.2s;"
                 data-work-type-name="${escapedName}"
                 onclick="selectWorkTypeFromRow(event, '${escapedName}')">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <i class="fas fa-tools me-2"></i>${escapedName}
                        </h6>
                        ${workType.description ? `<p class="mb-1 small text-muted">${escapedDesc}</p>` : ''}
                    </div>
                    <div class="btn-group btn-group-sm" onclick="event.stopPropagation()">
                        <button type="button" class="btn btn-outline-secondary" onclick="moveWorkType(${workType.id}, 'up')" ${index === 0 ? 'disabled' : ''} title="ä¸Šã¸ç§»å‹•">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="moveWorkType(${workType.id}, 'down')" ${index === workTypes.length - 1 ? 'disabled' : ''} title="ä¸‹ã¸ç§»å‹•">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary"
                                data-id="${workType.id}"
                                data-name="${escapedName}"
                                data-description="${escapedDesc}"
                                onclick="editWorkTypeFromButton(this)"
                                title="ç·¨é›†">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger"
                                data-id="${workType.id}"
                                data-name="${escapedName}"
                                onclick="deleteWorkTypeFromButton(this)"
                                title="å‰Šé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';

    $('#workTypeList').html(html);
}

// è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å·¥äº‹ç¨®åˆ¥ã‚’é¸æŠ
window.selectWorkTypeFromRow = function(event, workTypeName) {
    console.log('âœ… selectWorkTypeFromRow called:', workTypeName);

    // å·¥äº‹ç¨®åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
    const workTypeField = $('#id_work_type');
    if (workTypeField.length) {
        workTypeField.val(workTypeName);

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        toastr.success(`å·¥äº‹ç¨®åˆ¥ã€Œ${workTypeName}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const modal = bootstrap.Modal.getInstance(document.getElementById('workTypeManagementModal'));
        if (modal) {
            modal.hide();
        }
    } else {
        console.error('å·¥äº‹ç¨®åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        toastr.error('å·¥äº‹ç¨®åˆ¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    }
};

// ãƒœã‚¿ãƒ³ã‹ã‚‰å·¥äº‹ç¨®åˆ¥ã‚’ç·¨é›†ï¼ˆdataå±æ€§ã‚’ä½¿ç”¨ï¼‰
window.editWorkTypeFromButton = function(button) {
    const id = $(button).data('id');
    const name = $(button).data('name');
    const description = $(button).data('description');
    editWorkType(id, name, description);
};

// å·¥äº‹ç¨®åˆ¥ã‚’ç·¨é›†
window.editWorkType = function(id, name, description) {
    console.log('âœ… editWorkType called:', id, name);

    // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
    $('#workTypeId').val(id);
    $('#workTypeName').val(name);
    $('#workTypeDescription').val(description);

    // ãƒœã‚¿ãƒ³ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
    $('#workTypeSubmitBtn').html('<i class="fas fa-save me-2"></i>æ›´æ–°ã™ã‚‹');
    $('#workTypeCancelBtn').show();

    // ãƒ•ã‚©ãƒ¼ãƒ ä½ç½®ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('#workTypeForm')[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
};

// ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
window.cancelWorkTypeEdit = function() {
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#workTypeForm')[0].reset();
    $('#workTypeId').val('');

    // ãƒœã‚¿ãƒ³ã‚’æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«
    $('#workTypeSubmitBtn').html('<i class="fas fa-save me-2"></i>ä¿å­˜ã™ã‚‹');
    $('#workTypeCancelBtn').hide();

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#workTypeError').hide();
    $('#workTypeSuccess').hide();
};

// ãƒœã‚¿ãƒ³ã‹ã‚‰å·¥äº‹ç¨®åˆ¥ã‚’å‰Šé™¤ï¼ˆdataå±æ€§ã‚’ä½¿ç”¨ï¼‰
window.deleteWorkTypeFromButton = function(button) {
    const id = $(button).data('id');
    const name = $(button).data('name');
    deleteWorkType(id, name);
};

// å·¥äº‹ç¨®åˆ¥ã‚’å‰Šé™¤
window.deleteWorkType = function(id, name) {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
    $('#deleteWorkTypeName').text(name);

    // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('workTypeDeleteConfirmModal'));
    modal.show();

    // backdropã®z-indexã‚’èª¿æ•´ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(function() {
        $('.modal-backdrop').last().css('z-index', 10049);
    }, 10);

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ ï¼‰
    $('#confirmDeleteWorkTypeBtn').off('click').on('click', function() {
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>å‰Šé™¤ä¸­...');

        $.ajax({
            url: '{% url "order_management:work_type_delete_ajax" %}',
            type: 'POST',
            data: {
                id: id,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    modal.hide();

                    $('#workTypeSuccess').html('<i class="fas fa-check-circle me-2"></i>' + response.message).show();
                    setTimeout(function() { $('#workTypeSuccess').hide(); }, 3000);

                    // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    loadWorkTypeList();

                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                    refreshWorkTypeDropdown();
                } else {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    modal.hide();

                    $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
                }
            },
            error: function(xhr) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                modal.hide();

                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
            },
            complete: function() {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                $('#confirmDeleteWorkTypeBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>å‰Šé™¤ã™ã‚‹');
            }
        });
    });
};

// å·¥äº‹ç¨®åˆ¥ã‚’ä¸¦ã³æ›¿ãˆ
window.moveWorkType = function(id, direction) {
    $.ajax({
        url: '{% url "order_management:work_type_reorder_ajax" %}',
        type: 'POST',
        data: {
            id: id,
            direction: direction,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                loadWorkTypeList();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                refreshWorkTypeDropdown();
            } else {
                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
            }
        },
        error: function(xhr) {
            $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
        }
    });
};

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
$(document).ready(function() {
    $('#workTypeForm').on('submit', function(e) {
        e.preventDefault();

        const workTypeId = $('#workTypeId').val();
        const isUpdate = workTypeId !== '';
        const url = isUpdate
            ? '{% url "order_management:work_type_update_ajax" %}'
            : '{% url "order_management:work_type_create_ajax" %}';

        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        $('#workTypeError').hide();
        $('#workTypeSuccess').hide();

        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        const submitBtn = $('#workTypeSubmitBtn');
        submitBtn.prop('disabled', true);
        submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...');

        // ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™ï¼ˆãƒ•ã‚©ãƒ¼ãƒ å†…ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’ç¢ºå®Ÿã«å–å¾—ï¼‰
        const formData = {
            name: $('#workTypeName').val(),
            description: $('#workTypeDescription').val(),
            csrfmiddlewaretoken: $('#workTypeForm [name=csrfmiddlewaretoken]').val()
        };

        if (isUpdate) {
            formData.id = workTypeId;
        }

        $.ajax({
            url: url,
            type: 'POST',
            data: formData,
            success: function(response) {
                if (response.success) {
                    const message = isUpdate ? 'å·¥äº‹ç¨®åˆ¥ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ ã—ã¾ã—ãŸ';
                    $('#workTypeSuccess').html('<i class="fas fa-check-circle me-2"></i>' + message).show();
                    setTimeout(function() { $('#workTypeSuccess').hide(); }, 3000);

                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                    cancelWorkTypeEdit();

                    // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    loadWorkTypeList();

                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                    refreshWorkTypeDropdown(response.work_type.id);
                } else {
                    $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
                }
            },
            error: function(xhr) {
                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
            },
            complete: function() {
                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.prop('disabled', false);
                const buttonText = isUpdate ? 'æ›´æ–°ã™ã‚‹' : 'ä¿å­˜ã™ã‚‹';
                submitBtn.html('<i class="fas fa-save me-2></i>' + buttonText);
            }
        });
    });
});

// å·¥äº‹ç¨®åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
function refreshWorkTypeDropdown(selectedId) {
    $.ajax({
        url: '{% url "order_management:work_type_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const select = $('[name="work_type"]');
                const currentValue = selectedId || select.val();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†æ§‹ç¯‰
                select.empty();
                select.append('<option value="">-- å·¥äº‹ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>');

                // å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ ï¼ˆè¡¨ç¤ºé †ã§æ—¢ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ï¼‰
                response.work_types.forEach(function(workType) {
                    const option = new Option(workType.name, workType.name);
                    select.append(option);
                });

                // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
                if (currentValue) {
                    select.val(currentValue);
                }
            }
        }
    });
}

// å…ƒè«‹ä¼šç¤¾é¸æŠæ™‚ã«æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
$(document).ready(function() {
$('#clientCompanySelect').on('change', function() {
    const selectedOption = $(this).find('option:selected');

    if (selectedOption.val()) {
        // dataå±æ€§ã‹ã‚‰å€¤ã‚’å–å¾—ï¼ˆattr()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨ã—ã¦ç¢ºå®Ÿã«å–å¾—ï¼‰
        const paymentCycle = selectedOption.attr('data-payment-cycle') || '';
        const closingDay = selectedOption.attr('data-closing-day') || '';
        const paymentOffsetMonths = selectedOption.attr('data-payment-offset-months');
        const paymentDay = selectedOption.attr('data-payment-day') || '';

        // ãƒ©ãƒ™ãƒ«ãƒãƒƒãƒ”ãƒ³ã‚°
        const paymentCycleLabels = {
            'monthly': 'æœˆ1å›',
            'bimonthly': 'æœˆ2å›',
            'weekly': 'é€±1å›',
            'custom': 'ãã®ä»–'
        };
        const monthLabels = {
            '0': 'å½“æœˆ',
            '1': 'ç¿Œæœˆ',
            '2': 'ç¿Œã€…æœˆ',
            '3': '3ãƒ¶æœˆå¾Œ'
        };

        // Hidden fieldsï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ç”¨ï¼‰ã‚’è¨­å®š
        const paymentCycleField = document.getElementById('{{ form.payment_cycle.id_for_label }}');
        const closingDayField = document.getElementById('{{ form.closing_day.id_for_label }}');
        const paymentOffsetMonthsField = document.getElementById('{{ form.payment_offset_months.id_for_label }}');
        const paymentDayField = document.getElementById('{{ form.payment_day.id_for_label }}');

        if (paymentCycleField) paymentCycleField.value = paymentCycle;
        if (closingDayField) closingDayField.value = closingDay || '';
        if (paymentOffsetMonthsField) {
            paymentOffsetMonthsField.value = (paymentOffsetMonths !== undefined && paymentOffsetMonths !== null && paymentOffsetMonths !== '') ? String(paymentOffsetMonths) : '';
        }
        if (paymentDayField) paymentDayField.value = paymentDay || '';

        // Display spansï¼ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤ºç”¨ï¼‰ã‚’æ›´æ–°
        const displayCycle = document.getElementById('displayPaymentCycle');
        const displayClosingDay = document.getElementById('displayClosingDay');
        const displayPaymentOffsetMonths = document.getElementById('displayPaymentOffsetMonths');
        const displayPaymentDay = document.getElementById('displayPaymentDay');

        if (displayCycle) {
            displayCycle.textContent = paymentCycleLabels[paymentCycle] || paymentCycle || '-';
        }
        if (displayClosingDay) {
            displayClosingDay.textContent = closingDay ? `æ¯æœˆ${closingDay}æ—¥` : '-';
        }
        if (displayPaymentOffsetMonths) {
            if (paymentOffsetMonths !== undefined && paymentOffsetMonths !== null && paymentOffsetMonths !== '') {
                displayPaymentOffsetMonths.textContent = monthLabels[String(paymentOffsetMonths)] || `${paymentOffsetMonths}ãƒ¶æœˆå¾Œ`;
            } else {
                displayPaymentOffsetMonths.textContent = '-';
            }
        }
        if (displayPaymentDay) {
            displayPaymentDay.textContent = paymentDay ? `æ¯æœˆ${paymentDay}æ—¥` : '-';
        }

        // ã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
        const paymentCycleCard = document.getElementById('paymentCycleInfoCard');
        if (paymentCycleCard) {
            paymentCycleCard.style.display = 'block';
        }

        // å…ƒè«‹åã¨ä½æ‰€ã‚‚è‡ªå‹•å…¥åŠ›
        const companyName = selectedOption.data('name') || '';
        const companyAddress = selectedOption.data('address') || '';
        $('[name="client_name"]').val(companyName);
        $('[name="client_address"]').val(companyAddress);
    } else {
        // é¸æŠã‚’è§£é™¤ã—ãŸå ´åˆã¯ã‚¯ãƒªã‚¢
        const paymentCycleField = document.getElementById('{{ form.payment_cycle.id_for_label }}');
        const closingDayField = document.getElementById('{{ form.closing_day.id_for_label }}');
        const paymentOffsetMonthsField = document.getElementById('{{ form.payment_offset_months.id_for_label }}');
        const paymentDayField = document.getElementById('{{ form.payment_day.id_for_label }}');

        if (paymentCycleField) paymentCycleField.value = '';
        if (closingDayField) closingDayField.value = '';
        if (paymentOffsetMonthsField) paymentOffsetMonthsField.value = '';
        if (paymentDayField) paymentDayField.value = '';

        // ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤º
        const paymentCycleCard = document.getElementById('paymentCycleInfoCard');
        if (paymentCycleCard) {
            paymentCycleCard.style.display = 'none';
        }

        // Display spans ã‚‚ã‚¯ãƒªã‚¢
        const displayCycle = document.getElementById('displayPaymentCycle');
        const displayClosingDay = document.getElementById('displayClosingDay');
        const displayPaymentOffsetMonths = document.getElementById('displayPaymentOffsetMonths');
        const displayPaymentDay = document.getElementById('displayPaymentDay');

        if (displayCycle) displayCycle.textContent = '-';
        if (displayClosingDay) displayClosingDay.textContent = '-';
        if (displayPaymentOffsetMonths) displayPaymentOffsetMonths.textContent = '-';
        if (displayPaymentDay) displayPaymentDay.textContent = '-';

        $('[name="client_name"]').val('');
        $('[name="client_address"]').val('');
    }
});

// ========================================
// çµŒè²»é …ç›®ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»åˆè¨ˆè¨ˆç®—
// ========================================
let expenseItemCounter = 2; // æ—¢å­˜ã®2ã¤ãŒã‚ã‚‹ã®ã§3ã‹ã‚‰é–‹å§‹

// çµŒè²»é …ç›®ã‚’è¿½åŠ 
window.addExpenseItem = function() {
    expenseItemCounter++;
    const tbody = document.getElementById('expenseItemsTableBody');
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-expense-index', expenseItemCounter);

    newRow.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm"
                   name="expense_item_${expenseItemCounter}"
                   placeholder="ä¾‹: è«¸çµŒè²»">
        </td>
        <td>
            <div class="input-group input-group-sm">
                <span class="input-group-text">Â¥</span>
                <input type="number" class="form-control expense-amount-input"
                       name="expense_amount_${expenseItemCounter}"
                       value="0" min="0" step="1000"
                       onchange="calculateExpenseTotal()">
            </div>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger"
                    onclick="removeExpenseItem(this)" title="å‰Šé™¤">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    tbody.appendChild(newRow);
    calculateExpenseTotal();
};

// çµŒè²»é …ç›®ã‚’å‰Šé™¤
window.removeExpenseItem = function(button) {
    const row = button.closest('tr');
    const index = row.getAttribute('data-expense-index');

    // æœ€ä½1ã¤ã¯æ®‹ã™
    const tbody = document.getElementById('expenseItemsTableBody');
    if (tbody.querySelectorAll('tr').length <= 1) {
        alert('æœ€ä½1ã¤ã®çµŒè²»é …ç›®ãŒå¿…è¦ã§ã™');
        return;
    }

    row.remove();
    calculateExpenseTotal();
};

// çµŒè²»åˆè¨ˆã‚’è¨ˆç®—
window.calculateExpenseTotal = function() {
    let total = 0;

    // expense_amount_1, expense_amount_2ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã‚’å–å¾—
    const amount1Input = document.getElementById('{{ form.expense_amount_1.id_for_label }}');
    const amount2Input = document.getElementById('{{ form.expense_amount_2.id_for_label }}');

    if (amount1Input && amount1Input.value) {
        total += parseFloat(amount1Input.value) || 0;
    }
    if (amount2Input && amount2Input.value) {
        total += parseFloat(amount2Input.value) || 0;
    }

    // å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸçµŒè²»é …ç›®ã®åˆè¨ˆ
    const dynamicAmounts = document.querySelectorAll('#expenseItemsTableBody .expense-amount-input');
    dynamicAmounts.forEach(input => {
        if (input.value) {
            total += parseFloat(input.value) || 0;
        }
    });

    // åˆè¨ˆã‚’è¡¨ç¤º
    const totalElement = document.getElementById('expenseTotalAmount');
    if (totalElement) {
        totalElement.textContent = total.toLocaleString();
    }
};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨å…¥åŠ›æ™‚ã«åˆè¨ˆã‚’è¨ˆç®—
document.addEventListener('DOMContentLoaded', function() {
    // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    const amount1Input = document.getElementById('{{ form.expense_amount_1.id_for_label }}');
    const amount2Input = document.getElementById('{{ form.expense_amount_2.id_for_label }}');

    if (amount1Input) {
        amount1Input.addEventListener('input', calculateExpenseTotal);
        amount1Input.addEventListener('change', calculateExpenseTotal);
    }
    if (amount2Input) {
        amount2Input.addEventListener('input', calculateExpenseTotal);
        amount2Input.addEventListener('change', calculateExpenseTotal);
    }

    // åˆå›è¨ˆç®—
    calculateExpenseTotal();
});

// ========================================
// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆ
// ========================================
let scheduleSteps = [];
window.scheduleSteps = scheduleSteps; // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆå®Ÿæ–½ä½“åˆ¶ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ãŸã‚ï¼‰
let scheduleStepCounter = 0;

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
window.addScheduleStep = function(stepData = null) {
    scheduleStepCounter++;
    const stepId = stepData ? stepData.id : `step_${scheduleStepCounter}`;
    const stepName = stepData ? stepData.name : '';
    const stepDate = stepData ? stepData.date : '';
    const stepCompleted = stepData ? stepData.completed : false;
    const stepKey = stepData ? stepData.key : stepId; // keyãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¿½åŠ 

    const step = {
        id: stepId,
        key: stepKey, // keyãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ä¿å­˜
        name: stepName,
        date: stepDate,
        completed: stepCompleted,
        order: scheduleSteps.length,
        scheduled_date: stepDate // scheduled_dateã‚‚è¿½åŠ ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã§å¿…è¦ï¼‰
    };

    scheduleSteps.push(step);
    window.scheduleSteps = scheduleSteps; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã‚’æ›´æ–°
    renderScheduleSteps();
    updateScheduleStepsData();

    // åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
    if (typeof populateBaseDateOptions === 'function') {
        populateBaseDateOptions();
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤
window.removeScheduleStep = function(stepId) {
    scheduleSteps = scheduleSteps.filter(s => s.id !== stepId);
    window.scheduleSteps = scheduleSteps; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã‚’æ›´æ–°
    renderScheduleSteps();
    updateScheduleStepsData();

    // åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
    if (typeof populateBaseDateOptions === 'function') {
        populateBaseDateOptions();
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¸Šã«ç§»å‹•
window.moveScheduleStepUp = function(stepId) {
    const index = scheduleSteps.findIndex(s => s.id === stepId);
    if (index > 0) {
        [scheduleSteps[index - 1], scheduleSteps[index]] = [scheduleSteps[index], scheduleSteps[index - 1]];
        window.scheduleSteps = scheduleSteps; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã‚’æ›´æ–°
        renderScheduleSteps();
        updateScheduleStepsData();
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¸‹ã«ç§»å‹•
window.moveScheduleStepDown = function(stepId) {
    const index = scheduleSteps.findIndex(s => s.id === stepId);
    if (index < scheduleSteps.length - 1) {
        [scheduleSteps[index], scheduleSteps[index + 1]] = [scheduleSteps[index + 1], scheduleSteps[index]];
        window.scheduleSteps = scheduleSteps; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã‚’æ›´æ–°
        renderScheduleSteps();
        updateScheduleStepsData();
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã‚’æ›´æ–°
window.updateScheduleStep = function(stepId, field, value) {
    const step = scheduleSteps.find(s => s.id === stepId);
    if (step) {
        step[field] = value;

        // dateãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ›´æ–°ã•ã‚ŒãŸå ´åˆã€scheduled_dateã‚‚æ›´æ–°
        if (field === 'date') {
            step.scheduled_date = value;
        }

        updateScheduleStepsData();
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰
function renderScheduleSteps() {
    const container = document.getElementById('scheduleStepsList');
    if (!container) return;

    if (scheduleSteps.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>ã€Œã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å·¥ç¨‹ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
            </div>
        `;
        return;
    }

    let html = '<div class="progress-steps-list">';

    scheduleSteps.forEach((step, index) => {
        const stepClass = step.completed ? 'completed' : '';
        const statusHtml = step.completed
            ? '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†</div>'
            : '<div class="progress-step-date">æœªå®Œäº†</div>';

        html += `
            <div class="progress-step ${stepClass} card border" data-step-id="${step.id}" style="margin-bottom: 12px;">
                <div class="card-body p-2">
                    <div class="progress-step-header d-flex justify-content-between align-items-center" onclick="toggleStepContent('${step.id}')">
                        <div class="d-flex align-items-center flex-grow-1">
                            <span class="badge bg-primary me-2">${index + 1}</span>
                            <span class="progress-step-label flex-grow-1">${step.name || 'ã‚¹ãƒ†ãƒƒãƒ—åæœªè¨­å®š'}</span>
                            <i class="fas fa-chevron-down toggle-icon ms-2" id="toggle-icon-${step.id}"></i>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="event.stopPropagation(); moveScheduleStepUp('${step.id}')"
                                    ${index === 0 ? 'disabled' : ''}
                                    title="ä¸Šã«ç§»å‹•">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="event.stopPropagation(); moveScheduleStepDown('${step.id}')"
                                    ${index === scheduleSteps.length - 1 ? 'disabled' : ''}
                                    title="ä¸‹ã«ç§»å‹•">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick="event.stopPropagation(); removeScheduleStep('${step.id}')"
                                    title="å‰Šé™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${statusHtml}
                    <div class="progress-step-content" id="step-content-${step.id}" style="display: none;">
                        <div class="mb-2">
                            <label class="form-label small mb-1">ã‚¹ãƒ†ãƒƒãƒ—å</label>
                            <input type="text" class="form-control form-control-sm"
                                   value="${step.name}"
                                   onchange="updateScheduleStep('${step.id}', 'name', this.value)"
                                   placeholder="ä¾‹: ç€å·¥æº–å‚™">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">äºˆå®šæ—¥</label>
                            <input type="date" class="form-control form-control-sm"
                                   value="${step.date}"
                                   onchange="updateScheduleStep('${step.id}', 'date', this.value)">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   ${step.completed ? 'checked' : ''}
                                   onchange="updateScheduleStep('${step.id}', 'completed', this.checked)"
                                   id="completed-${step.id}">
                            <label class="form-check-label small" for="completed-${step.id}">
                                <i class="fas fa-check me-1"></i>å®Œäº†
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// ã‚¹ãƒ†ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
window.toggleStepContent = function(stepId) {
    const content = document.getElementById(`step-content-${stepId}`);
    const icon = document.getElementById(`toggle-icon-${stepId}`);

    if (content && icon) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
};

// çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
window.toggleExpenseSection = function() {
    const content = document.getElementById('expenseSection');
    const icon = document.getElementById('expenseToggleIcon');
    const btn = document.getElementById('expenseToggleBtn');

    if (content && icon && btn) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.classList.remove('fa-plus');
            icon.classList.add('fa-minus');
            btn.innerHTML = '<i class="fas fa-minus me-1" id="expenseToggleIcon"></i><i class="fas fa-receipt me-1"></i>çµŒè²»ãƒ»è«¸çµŒè²»é …ç›®ã‚’é–‰ã˜ã‚‹';
        } else {
            content.style.display = 'none';
            icon.classList.remove('fa-minus');
            icon.classList.add('fa-plus');
            btn.innerHTML = '<i class="fas fa-plus me-1" id="expenseToggleIcon"></i><i class="fas fa-receipt me-1"></i>çµŒè²»ãƒ»è«¸çµŒè²»é …ç›®ã‚’è¿½åŠ ';
        }
    }
};

// å—æ³¨ãƒ¨ãƒŸã®ãƒãƒƒã‚¸ã‚’æ›´æ–°
window.updateProjectStatusBadge = function() {
    const select = document.getElementById('{{ form.project_status.id_for_label }}');
    const badge = document.getElementById('projectStatusBadge');

    if (!select || !badge) return;

    const value = select.value;
    // æ¡ˆä»¶ä¸€è¦§ãƒ»è©³ç´°ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä½¿ç”¨
    const statusConfig = {
        'ãƒã‚¿': { text: 'è¦‹è¾¼ã¿æ¡ˆä»¶', class: 'text-dark', style: 'background-color: #e9d5ff;' },
        'A': { text: 'å—æ³¨ç¢ºåº¦é«˜', class: 'bg-danger', style: '' },
        'B': { text: 'å—æ³¨ç¢ºåº¦ä¸­', class: 'bg-warning text-dark', style: '' },
        'å—æ³¨ç¢ºå®š': { text: 'å—æ³¨ç¢ºå®š', class: 'bg-success', style: '' },
        'NG': { text: 'å—æ³¨ã§ããš', class: 'bg-secondary', style: '' }
    };

    // ã™ã¹ã¦ã®ãƒãƒƒã‚¸ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
    badge.className = 'badge';
    badge.style.cssText = 'min-width: 120px; font-size: 0.9rem;';

    if (value && statusConfig[value]) {
        badge.textContent = statusConfig[value].text;
        // ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ï¼ˆè¤‡æ•°ã®ã‚¯ãƒ©ã‚¹ãŒã‚ã‚‹å ´åˆã«å¯¾å¿œï¼‰
        statusConfig[value].class.split(' ').forEach(cls => {
            if (cls) badge.classList.add(cls);
        });
        // è¿½åŠ ã®ã‚¹ã‚¿ã‚¤ãƒ«ãŒã‚ã‚Œã°é©ç”¨
        if (statusConfig[value].style) {
            badge.style.cssText += statusConfig[value].style;
        }
    } else {
        badge.textContent = '';
    }
};

// éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« JSON ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
function updateScheduleStepsData() {
    const dataField = document.getElementById('formScheduleStepsData');
    if (dataField) {
        // ã‚µãƒ¼ãƒãƒ¼å´ã¯step_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—ã®ã‚­ãƒ¼ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
        const sanitizedSteps = scheduleSteps.map(step => {
            const sanitizedKey = step.key && step.key.startsWith('step_')
                ? step.key.replace('step_', '')
                : step.key;

            return {
                key: sanitizedKey,
                order: step.order,
                scheduled_date: step.scheduled_date || step.date || '',
                completed: step.completed || false
            };
        });

        dataField.value = JSON.stringify(sanitizedSteps);
        console.log('âœ… Schedule steps data updated:', sanitizedSteps.length, 'steps');
        console.log('ğŸ“‹ Sanitized keys:', sanitizedSteps.map(s => s.key));
    } else {
        console.error('âŒ formScheduleStepsData element not found!');
    }
}

// ========================================
// å—æ³¨é‡‘é¡è¨ˆç®—ï¼ˆé§è»Šå ´ä»£ã¯å‰Šé™¤æ¸ˆã¿ï¼‰
// ========================================
// é§è»Šå ´ä»£ãŒå‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€å°è¨ˆè¨ˆç®—ã¯ä¸è¦
window.calculateOrderAmountSubtotal = function() {
    // ã“ã®é–¢æ•°ã¯äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã—ã¦ã„ã¾ã™ãŒã€ä½•ã‚‚ã—ã¾ã›ã‚“
    console.log('å—æ³¨é‡‘é¡å°è¨ˆè¨ˆç®—: é§è»Šå ´ä»£ãŒå‰Šé™¤ã•ã‚ŒãŸãŸã‚ä¸è¦');
};

// ========================================
// å¥‘ç´„æ—¥ã‹ã‚‰å…¥é‡‘äºˆå®šæ—¥ã‚’è‡ªå‹•è¨ˆç®—
// ========================================
// å…¥é‡‘äºˆå®šæ—¥ã®åŸºæº–æ—¥é¸æŠå‡¦ç†
// ========================================
window.updateIncomingPaymentBaseDate = function() {
    const baseDateTypeElement = document.getElementById('incomingPaymentBaseDateType');
    const baseDateType = baseDateTypeElement ? baseDateTypeElement.value : '';
    const customDateInput = document.getElementById('incomingPaymentCustomBaseDate');
    const baseDateDisplay = document.getElementById('incomingPaymentBaseDateDisplay');

    // ä»»æ„æ—¥é¸æŠæ™‚ã®ã¿ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜å…¥åŠ›ã‚’è¡¨ç¤º
    if (customDateInput) {
        if (baseDateType === 'custom') {
            customDateInput.style.display = 'block';
        } else {
            customDateInput.style.display = 'none';
        }
    }

    // åŸºæº–æ—¥ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    let baseDate = null;
    let baseDateText = 'æœªé¸æŠ';

    if (!baseDateType) {
        baseDateText = 'æœªé¸æŠ';
    } else if (baseDateType === 'contract') {
        const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
        if (contractDateInput && contractDateInput.value) {
            baseDate = contractDateInput.value;
            baseDateText = baseDate + ' (å¥‘ç´„æ—¥)';
        } else {
            baseDateText = 'æœªå…¥åŠ› (å¥‘ç´„æ—¥)';
        }
    } else if (baseDateType.startsWith('step_')) {
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ã®å„å·¥ç¨‹ã®äºˆå®šæ—¥ã‚’å–å¾—
        const stepKey = baseDateType.replace('step_', '');
        const stepDateInput = document.querySelector(`input[name="step_${stepKey}_scheduled_date"]`);

        // å‹•çš„ã«å·¥ç¨‹åã‚’å–å¾—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒƒãƒ—ã‹ã‚‰ï¼‰
        const stepName = (window.stepNameMap && window.stepNameMap[stepKey]) || stepKey;

        if (stepDateInput && stepDateInput.value) {
            baseDate = stepDateInput.value;
            baseDateText = baseDate + ' (' + stepName + ')';
        } else {
            baseDateText = 'æœªå…¥åŠ› (' + stepName + ')';
        }
    } else if (baseDateType === 'custom') {
        if (customDateInput && customDateInput.value) {
            baseDate = customDateInput.value;
            baseDateText = baseDate + ' (ä»»æ„æ—¥)';
        } else {
            baseDateText = 'æœªé¸æŠ (ä»»æ„æ—¥)';
        }
    }

    if (baseDateDisplay) {
        baseDateDisplay.textContent = baseDateText;
    }
};

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«è¡¨ç¤º
window.showModalPaymentError = function(message) {
    const errorDiv = $('#modalPaymentCalculationError');
    const errorMessage = $('#modalPaymentCalculationErrorMessage');

    errorMessage.html(message);
    errorDiv.removeClass('d-none');

    // 5ç§’å¾Œã«è‡ªå‹•çš„ã«éè¡¨ç¤º
    setTimeout(function() {
        errorDiv.addClass('d-none');
    }, 8000);
};

// ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
window.hideModalPaymentError = function() {
    $('#modalPaymentCalculationError').addClass('d-none');
};

// ========================================
window.autoCalculatePaymentDueDateFromContract = function() {
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    hideModalPaymentError();

    // ã¾ãšå…ƒè«‹ä¼šç¤¾ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const clientCompanySelect = document.getElementById('clientCompanySelect');
    if (!clientCompanySelect || !clientCompanySelect.value) {
        showModalPaymentError('å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br><small>åŸºæœ¬æƒ…å ±ã‚¿ãƒ–ã§å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã™ã‚‹ã¨ã€æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚</small>');
        return;
    }

    // åŸºæº–æ—¥ã‚’å–å¾—
    const baseDateType = document.getElementById('incomingPaymentBaseDateType').value;
    let baseDate = null;

    if (!baseDateType) {
        alert('åŸºæº–æ—¥ã®ç¨®é¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    if (baseDateType === 'contract') {
        const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
        if (!contractDateInput || !contractDateInput.value) {
            alert('å¥‘ç´„æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        baseDate = new Date(contractDateInput.value);
    } else if (baseDateType.startsWith('step_')) {
        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ã®å„å·¥ç¨‹ã®äºˆå®šæ—¥ã‚’å–å¾—
        const stepKey = baseDateType.replace('step_', '');
        const stepDateInput = document.querySelector(`input[name="step_${stepKey}_scheduled_date"]`);

        // å‹•çš„ã«å·¥ç¨‹åã‚’å–å¾—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒãƒƒãƒ—ã‹ã‚‰ï¼‰
        const stepName = (window.stepNameMap && window.stepNameMap[stepKey]) || stepKey;

        if (!stepDateInput || !stepDateInput.value) {
            alert(stepName + 'ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ã§å…¥åŠ›ï¼‰');
            return;
        }
        baseDate = new Date(stepDateInput.value);
    } else if (baseDateType === 'custom') {
        const customDateInput = document.getElementById('incomingPaymentCustomBaseDate');
        if (!customDateInput || !customDateInput.value) {
            showModalPaymentError('ä»»æ„ã®åŸºæº–æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        baseDate = new Date(customDateInput.value);
    }

    // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—
    const closingDayInput = document.getElementById('{{ form.closing_day.id_for_label }}');
    const paymentOffsetInput = document.getElementById('{{ form.payment_offset_months.id_for_label }}');
    const paymentDayInput = document.getElementById('{{ form.payment_day.id_for_label }}');

    if (!closingDayInput || !closingDayInput.value) {
        // å…ƒè«‹ä¼šç¤¾åã‚’å–å¾—ã—ã¦è¡¨ç¤º
        const clientCompanySelect = document.getElementById('clientCompanySelect');
        const companyName = clientCompanySelect ? clientCompanySelect.options[clientCompanySelect.selectedIndex]?.text : 'é¸æŠã•ã‚ŒãŸå…ƒè«‹ä¼šç¤¾';
        showModalPaymentError(`<strong>${companyName}</strong> ã®ç· ã‚æ—¥æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br><small>å…ƒè«‹ç®¡ç†ç”»é¢ã§æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ï¼ˆç· ã‚æ—¥ãƒ»æ”¯æ‰•æ—¥ï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</small>`);
        return;
    }
    if (!paymentDayInput || !paymentDayInput.value) {
        const clientCompanySelect = document.getElementById('clientCompanySelect');
        const companyName = clientCompanySelect ? clientCompanySelect.options[clientCompanySelect.selectedIndex]?.text : 'é¸æŠã•ã‚ŒãŸå…ƒè«‹ä¼šç¤¾';
        showModalPaymentError(`<strong>${companyName}</strong> ã®æ”¯æ‰•æ—¥æƒ…å ±ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br><small>å…ƒè«‹ç®¡ç†ç”»é¢ã§æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ï¼ˆç· ã‚æ—¥ãƒ»æ”¯æ‰•æ—¥ï¼‰ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚</small>`);
        return;
    }

    const closingDay = parseInt(closingDayInput.value);
    const paymentOffsetMonths = parseInt(paymentOffsetInput.value) || 0;
    const paymentDay = parseInt(paymentDayInput.value);

    // è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯:
    // 1. åŸºæº–æ—¥ã®æœˆã®ç· ã‚æ—¥ã‚’è¨ˆç®—
    // 2. åŸºæº–æ—¥ãŒç· ã‚æ—¥ã‚ˆã‚Šå¾Œãªã‚‰ã€æ¬¡ã®æœˆã®ç· ã‚æ—¥ã¨ã™ã‚‹
    // 3. ç· ã‚æ—¥ + ã‚ªãƒ•ã‚»ãƒƒãƒˆæœˆ + æ”¯æ‰•æ—¥ã§å…¥é‡‘äºˆå®šæ—¥ã‚’è¨ˆç®—

    let closingDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), closingDay);

    // åŸºæº–æ—¥ãŒç· ã‚æ—¥ã‚ˆã‚Šå¾Œã®å ´åˆã€æ¬¡ã®æœˆã®ç· ã‚æ—¥ã«ã™ã‚‹
    if (baseDate.getDate() > closingDay) {
        closingDate.setMonth(closingDate.getMonth() + 1);
    }

    // æ”¯æ‰•æœˆã‚’è¨ˆç®—ï¼ˆç· ã‚æ—¥ã‹ã‚‰ã‚ªãƒ•ã‚»ãƒƒãƒˆæœˆå¾Œï¼‰
    // æœˆã¨æ—¥ã‚’åŒæ™‚ã«è¨­å®šã™ã‚‹ã“ã¨ã§ã€æœˆæœ«æ—¥ã®ç¹°ã‚Šè¶Šã—ã‚’é˜²ã
    const paymentDate = new Date(closingDate.getFullYear(), closingDate.getMonth() + paymentOffsetMonths, paymentDay);

    // å…¥é‡‘äºˆå®šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
    const paymentDueDateInput = document.getElementById('{{ form.payment_due_date.id_for_label }}');
    if (paymentDueDateInput) {
        const year = paymentDate.getFullYear();
        const month = String(paymentDate.getMonth() + 1).padStart(2, '0');
        const day = String(paymentDate.getDate()).padStart(2, '0');
        paymentDueDateInput.value = `${year}-${month}-${day}`;
    }
};

// é§è»Šå ´ä»£ãŒå‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€å—æ³¨é‡‘é¡å°è¨ˆã®è¨ˆç®—ã¯ä¸è¦

// åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆã™ã‚‹é–¢æ•°
window.populateBaseDateOptions = function() {
    const baseDateSelect = document.getElementById('incomingPaymentBaseDateType');
    if (!baseDateSelect) return;

    // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿å­˜
    const currentValue = baseDateSelect.value;

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢
    baseDateSelect.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';

    // å¥‘ç´„æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ 
    const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
    if (contractDateInput) {
        baseDateSelect.innerHTML += '<option value="contract">å¥‘ç´„æ—¥</option>';
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ã®å·¥ç¨‹ã‚’å–å¾—
    const activeSteps = [];
    $('#formActiveSteps .progress-step').each(function() {
        const stepKey = $(this).data('step');
        const stepName = $(this).find('.progress-step-label').text().trim();
        if (stepKey && stepName) {
            activeSteps.push({
                key: stepKey,
                name: stepName
            });
        }
    });

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å·¥ç¨‹ã‚’å–å¾—
    if (typeof window.scheduleSteps !== 'undefined' && window.scheduleSteps) {
        window.scheduleSteps.forEach(step => {
            if (step.id && step.name) {
                activeSteps.push({
                    key: step.id,
                    name: step.name
                });
            }
        });
    }

    // é‡è¤‡ã‚’å‰Šé™¤ï¼ˆåŒã˜keyã®ã‚‚ã®ã¯1ã¤ã ã‘ï¼‰
    const uniqueSteps = [];
    const seenKeys = new Set();
    activeSteps.forEach(step => {
        if (!seenKeys.has(step.key)) {
            seenKeys.add(step.key);
            uniqueSteps.push(step);
        }
    });

    // å·¥ç¨‹ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
    uniqueSteps.forEach(step => {
        // step.keyãŒæ—¢ã«'step_'ã§å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã¯ã€ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ãªã„
        const optionValue = step.key.startsWith('step_') ? step.key : `step_${step.key}`;
        baseDateSelect.innerHTML += `<option value="${optionValue}">${step.name}</option>`;
    });

    // ä»»æ„æ—¥ã¯å¸¸ã«è¡¨ç¤º
    baseDateSelect.innerHTML += '<option value="custom">ä»»æ„æ—¥</option>';

    // ä»¥å‰ã®é¸æŠå€¤ã‚’å¾©å…ƒï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
    if (currentValue) {
        const option = baseDateSelect.querySelector(`option[value="${currentValue}"]`);
        if (option) {
            baseDateSelect.value = currentValue;
        }
    } else {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œå®Œå·¥ã€ã‚’é¸æŠï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
        // ä¸¡æ–¹ã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
        let completionOption = baseDateSelect.querySelector('option[value="step_completion"]');
        if (!completionOption) {
            completionOption = baseDateSelect.querySelector('option[value="step_step_completion"]');
        }
        if (completionOption) {
            baseDateSelect.value = completionOption.value;
            // é¸æŠå¾Œã€è¡¨ç¤ºã‚‚æ›´æ–°
            updateIncomingPaymentBaseDate();
        }
    }

    // å·¥ç¨‹åãƒãƒƒãƒ—ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆupdateIncomingPaymentBaseDateã§ä½¿ç”¨ï¼‰
    // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—ã®ã‚­ãƒ¼ã§ä¿å­˜
    window.stepNameMap = {};
    uniqueSteps.forEach(step => {
        const keyWithoutPrefix = step.key.startsWith('step_') ? step.key.replace('step_', '') : step.key;
        window.stepNameMap[keyWithoutPrefix] = step.name;
    });
};

// å…¥é‡‘äºˆå®šæ—¥ã®åŸºæº–æ—¥è¡¨ç¤ºã‚’åˆæœŸåŒ–
const incomingBaseDateTypeSelect = document.getElementById('incomingPaymentBaseDateType');
if (incomingBaseDateTypeSelect) {
    // åˆæœŸãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
    populateBaseDateOptions();

    // åˆæœŸè¡¨ç¤ºã‚’æ›´æ–°
    updateIncomingPaymentBaseDate();

    // å¥‘ç´„æ—¥ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã‚‚åŸºæº–æ—¥è¡¨ç¤ºã‚’æ›´æ–°
    const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
    if (contractDateInput) {
        contractDateInput.addEventListener('change', updateIncomingPaymentBaseDate);
    }

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å·¥ç¨‹ã®æ—¥ä»˜ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã‚‚åŸºæº–æ—¥è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('change', 'input[name^="step_"][name$="_scheduled_date"]', function() {
        console.log('ğŸ“… å·¥ç¨‹ã®æ—¥ä»˜ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', this.name, this.value);
        updateIncomingPaymentBaseDate();
    });

    // MutationObserverã‚’ä½¿ã£ã¦formActiveStepsã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å¤‰æ›´ã‚’ç›£è¦–
    const observer = new MutationObserver(function(mutations) {
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†ç”Ÿæˆ
        populateBaseDateOptions();

        // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å†è¨­å®š
        updateIncomingPaymentBaseDate();
    });

    // formActiveStepsã‚’ç›£è¦–
    const formActiveSteps = document.getElementById('formActiveSteps');
    if (formActiveSteps) {
        observer.observe(formActiveSteps, {
            childList: true,
            subtree: true
        });
    }

    // scheduleStepsListã‚’ç›£è¦–ï¼ˆã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å·¥ç¨‹ã‚¿ãƒ–ï¼‰
    const scheduleStepsList = document.getElementById('scheduleStepsList');
    if (scheduleStepsList) {
        observer.observe(scheduleStepsList, {
            childList: true,
            subtree: true
        });
    }
}

// ========================================
// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†)
// ========================================

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã®å®šç¾© (formç”¨ã®ç°¡æ˜“ç‰ˆ)
const formDefaultSteps = [
    { name: 'ç«‹ã¡ä¼šã„', icon: 'fas fa-user-check', key: 'step_attendance' },
    { name: 'ç¾èª¿', icon: 'fas fa-clipboard-list', key: 'step_survey' },
    { name: 'è¦‹ç©æ›¸ç™ºè¡Œ', icon: 'fas fa-file-invoice', key: 'step_estimate' },
    { name: 'ç€å·¥', icon: 'fas fa-hard-hat', key: 'step_construction_start' },
    { name: 'å®Œå·¥', icon: 'fas fa-check-circle', key: 'step_completion' }
];

// è¿½åŠ å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã®å®šç¾©
const formAvailableSteps = [
    { name: 'å¥‘ç´„', icon: 'fas fa-handshake', key: 'step_contract' },
    { name: 'è«‹æ±‚æ›¸ç™ºè¡Œ', icon: 'fas fa-file-invoice-dollar', key: 'step_invoice' },
    { name: 'è¨±å¯ç”³è«‹', icon: 'fas fa-file-signature', key: 'step_permit_application' },
    { name: 'è³‡æç™ºæ³¨', icon: 'fas fa-boxes', key: 'step_material_order' },
    { name: 'æ¤œæŸ»', icon: 'fas fa-clipboard-check', key: 'step_inspection' }
];

// æ—¢å­˜ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆï¼‰
const existingScheduleSteps = {{ existing_schedule_steps|default:"[]"|safe }};

let formSortable = null;

// ã‚¹ãƒ†ãƒƒãƒ—HTMLã‚’ç”Ÿæˆï¼ˆ1è¡Œå½¢å¼ï¼‰
function generateFormStepHTML(stepData) {
    // stepData.keyãŒæ—¢ã«'step_'ã§å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã¯ã€ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»
    const stepKey = stepData.key.startsWith('step_') ? stepData.key.replace('step_', '') : stepData.key;

    return `
        <div class="card shadow-sm mb-2 progress-step" data-step="${stepData.key}">
            <div class="card-body p-2">
                <div class="row align-items-center">
                    <!-- å·¦: ã‚¢ã‚¤ã‚³ãƒ³ï¼‹åå‰ -->
                    <div class="col-md-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-grip-vertical drag-handle me-2 text-muted" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ" style="cursor: grab;"></i>
                            <span style="font-size: 0.9rem;"><i class="${stepData.icon} me-2"></i><span class="progress-step-label">${stepData.name}</span></span>
                        </div>
                    </div>

                    <!-- ä¸­å¤®: äºˆå®šæ—¥å…¥åŠ› -->
                    <div class="col-md-5">
                        <div class="row g-2 align-items-center">
                            <div class="col-auto">
                                <label class="form-label mb-0 small">äºˆå®šæ—¥:</label>
                            </div>
                            <div class="col">
                                <input type="date" class="form-control form-control-sm step-date-input"
                                       name="step_${stepKey}_scheduled_date"
                                       data-step="${stepData.key}"
                                       onchange="updateFormCalendar()">
                            </div>
                            <div class="col-auto">
                                <div class="form-check mb-0">
                                    <input class="form-check-input step-completed-checkbox" type="checkbox"
                                           name="step_${stepKey}_completed"
                                           id="formStep_${stepKey}_completed"
                                           onchange="updateFormScheduleData(); updateStepCompletedClass(this)">
                                    <label class="form-check-label small" for="formStep_${stepKey}_completed">
                                        å®Œäº†
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å³: è©³ç´°ãƒœã‚¿ãƒ³ï¼‹å‰Šé™¤ãƒœã‚¿ãƒ³ -->
                    <div class="col-md-4 text-end">
                        ${(stepData.key === 'estimate' || stepData.key === 'step_estimate') ? `
                        <button type="button" class="btn btn-sm btn-outline-secondary toggle-step-details-btn me-1"
                                data-step="${stepData.key}" title="è©³ç´°æƒ…å ±ã‚’è¿½åŠ "
                                style="font-size: 0.65rem; padding: 0.15rem 0.3rem; line-height: 1;">
                            <i class="fas fa-plus" style="font-size: 0.6rem;"></i> è©³ç´°
                        </button>
                        ` : ''}
                        <button type="button" class="btn btn-outline-danger btn-sm remove-form-step-btn"
                                data-step="${stepData.key}" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤"
                                style="font-size: 0.7rem; padding: 0.15rem 0.4rem;">
                            <i class="fas fa-minus"></i> å‰Šé™¤
                        </button>
                    </div>
                </div>

                ${(stepData.key === 'estimate' || stepData.key === 'step_estimate') ? `
                <!-- è©³ç´°æƒ…å ±ã‚¨ãƒªã‚¢ï¼ˆåˆæœŸéè¡¨ç¤ºï¼‰ -->
                <div class="step-details-area mt-2" style="display: none; border-top: 1px solid #dee2e6; padding-top: 10px;">
                    <!-- å®Ÿæ–½æ—¥ -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0 small">å®Ÿæ–½æ—¥</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="estimate" title="å®Ÿæ–½æ—¥ã‚’è¿½åŠ ">
                                <i class="fas fa-plus me-1"></i>è¿½åŠ 
                            </button>
                        </div>
                        <div class="actual-date-field" style="display: none;">
                            <div class="input-group input-group-sm">
                                <input type="date" name="dynamic_field_estimate_actual_date" class="form-control actual-date-input" value="">
                                <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="å®Ÿæ–½æ—¥ã‚’å‰Šé™¤">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox"
                               name="{{ form.estimate_not_required.html_name }}"
                               id="{{ form.estimate_not_required.id_for_label }}"
                               {% if form.estimate_not_required.value %}checked{% endif %}
                               onchange="updateFormCalendar()">
                        <label class="form-check-label small" for="{{ form.estimate_not_required.id_for_label }}">
                            <i class="fas fa-times me-1"></i>è¦‹ç©æ›¸ä¸è¦
                        </label>
                    </div>

                    <!-- ä¸‹è«‹æ¥­è€…è¦‹ç©é‡‘é¡ -->
                    <div class="mb-3">
                        <label class="form-label small mb-1">
                            <i class="fas fa-yen-sign me-1"></i>ä¸‹è«‹æ¥­è€…è¦‹ç©é‡‘é¡
                        </label>
                        <textarea name="contractor_estimate_amount" class="form-control form-control-sm contractor-estimate-amount-input" rows="3" placeholder="ä¸‹è«‹æ¥­è€…ã®è¦‹ç©é‡‘é¡ã‚’ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›"></textarea>
                        <small class="text-muted">ä¸‹è«‹æ¥­è€…ã®è¦‹ç©é‡‘é¡ã‚„å†…è¨³ã‚’è‡ªç”±ã«å…¥åŠ›ã§ãã¾ã™</small>
                    </div>

                    <!-- å‚™è€ƒ -->
                    <div class="mb-3">
                        <label class="form-label small mb-1">
                            <i class="fas fa-comment me-1"></i>å‚™è€ƒ
                        </label>
                        <textarea name="estimate_notes" class="form-control form-control-sm estimate-notes-input" rows="3" placeholder="è¦‹ç©ã‚‚ã‚Šã«é–¢ã™ã‚‹å‚™è€ƒã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›"></textarea>
                        <small class="text-muted">è¦‹ç©ã‚‚ã‚Šã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚„ç‰¹è¨˜äº‹é …ã‚’å…¥åŠ›ã§ãã¾ã™</small>
                    </div>

                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                    <div class="estimate-files-section mb-2">
                        <label class="form-label small mb-1 d-flex align-items-center">
                            <i class="fas fa-paperclip me-2"></i>è¦‹ç©ã‚‚ã‚Šæ›¸é¡
                        </label>
                        <div class="mb-2">
                            <input type="file" class="form-control form-control-sm estimate-file-input" accept=".pdf,.xlsx,.xls,.docx,.doc,.jpg,.jpeg,.png" style="position: absolute; left: -9999px;">
                            <button type="button" class="btn btn-sm btn-outline-primary upload-estimate-file-btn">
                                <i class="fas fa-upload me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                            </button>
                            <small class="text-muted d-block mt-1">
                                PDF, Excel, Word, ç”»åƒ (æœ€å¤§10MB)
                            </small>
                        </div>
                        <div class="estimate-files-list"><small class="text-muted">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</small></div>
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
    `;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸåŒ–
function initializeFormDefaultSteps() {
    const container = document.getElementById('formActiveSteps');
    if (!container) return;

    // æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰
    if (existingScheduleSteps && existingScheduleSteps.length > 0) {
        console.log('âœ“ Loading existing schedule steps:', existingScheduleSteps);

        // æ—¢å­˜ã‚¹ãƒ†ãƒƒãƒ—ã‚’é †ç•ªã«è¿½åŠ 
        existingScheduleSteps.forEach(existingStep => {
            // ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã‚’æ¤œç´¢ï¼ˆã‚­ãƒ¼ã®æ­£è¦åŒ–ï¼šstep_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’é™¤å»ã—ã¦æ¯”è¼ƒï¼‰
            const normalizedExistingKey = existingStep.key.startsWith('step_')
                ? existingStep.key.replace('step_', '')
                : existingStep.key;

            const allSteps = [...formDefaultSteps, ...formAvailableSteps];
            const stepDef = allSteps.find(s => {
                const normalizedStepKey = s.key.startsWith('step_')
                    ? s.key.replace('step_', '')
                    : s.key;
                return normalizedStepKey === normalizedExistingKey;
            });

            if (stepDef) {
                // HTMLã‚’ç”Ÿæˆã—ã¦è¿½åŠ 
                container.insertAdjacentHTML('beforeend', generateFormStepHTML(stepDef));

                // äºˆå®šæ—¥ã¨å®Œäº†çŠ¶æ…‹ã‚’è¨­å®šï¼ˆstepDef.keyã‚’ä½¿ç”¨ã€ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãï¼‰
                const stepElement = container.querySelector(`[data-step="${stepDef.key}"]`);
                if (stepElement) {
                    const dateInput = stepElement.querySelector(`input[name="${stepDef.key}_scheduled_date"]`);
                    if (dateInput && existingStep.scheduled_date) {
                        dateInput.value = existingStep.scheduled_date;
                    }

                    const completedCheckbox = stepElement.querySelector(`input[name="${stepDef.key}_completed"]`);
                    if (completedCheckbox) {
                        completedCheckbox.checked = existingStep.completed || false;

                        // å®Œäº†çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ /å‰Šé™¤
                        if (existingStep.completed) {
                            stepElement.classList.add('completed');
                        } else {
                            stepElement.classList.remove('completed');
                        }
                    }
                }
            } else {
                console.warn('âš  Step definition not found for key:', existingStep.key);
            }
        });
    } else {
        // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ï¼šãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ5ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤ºï¼ˆå‰Šé™¤å¯èƒ½ï¼‰
        console.log('âœ“ Adding default 5 steps');
        formDefaultSteps.forEach(step => {
            container.insertAdjacentHTML('beforeend', generateFormStepHTML(step));
        });
    }

    // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
    renderFormAvailableSteps();

    // Sortableã‚’åˆæœŸåŒ–
    initializeFormSortable();

    // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
    initializeFormCalendar();

    // åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    updateFormScheduleData();

    // è¦‹ç©æ›¸ä¸è¦ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯è©³ç´°ã‚¨ãƒªã‚¢ã‚’è‡ªå‹•å±•é–‹
    setTimeout(() => {
        const estimateNotRequired = document.getElementById('{{ form.estimate_not_required.id_for_label }}');

        if (estimateNotRequired && estimateNotRequired.checked) {
            const estimateStep = document.querySelector('[data-step="step_estimate"]');
            if (estimateStep) {
                const detailsBtn = estimateStep.querySelector('.toggle-step-details-btn');
                if (detailsBtn) {
                    detailsBtn.click(); // è©³ç´°ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å±•é–‹
                }
            }
        }
    }, 100);

    console.log('âœ“ Schedule steps initialized');
}

// åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
function renderFormAvailableSteps() {
    const container = document.getElementById('formAvailableSteps');
    if (!container) return;

    container.innerHTML = '';

    // è¿½åŠ å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã¯å«ã‚ãªã„ï¼‰
    formAvailableSteps.forEach(step => {
        // ã™ã§ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—
        const existingStep = document.querySelector(`#formActiveSteps .progress-step[data-step="${step.key}"]`);
        if (existingStep) return;

        const stepHTML = `
            <div class="col-auto mb-2">
                <button type="button" class="btn btn-sm btn-outline-primary add-form-step-btn"
                        data-step-key="${step.key}">
                    <i class="${step.icon} me-1"></i>${step.name}+
                </button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', stepHTML);
    });
}

// Sortableã‚’åˆæœŸåŒ–
function initializeFormSortable() {
    const container = document.getElementById('formActiveSteps');
    if (!container) return;

    if (formSortable) {
        formSortable.destroy();
    }

    formSortable = Sortable.create(container, {
        animation: 150,
        handle: '.drag-handle',
        filter: 'button, .btn, input, select, textarea',
        preventOnFilter: false,
        onEnd: function() {
            updateFormScheduleData();
            console.log('âœ“ Step order changed');
        }
    });
}

// FullCalendarç”¨ã®å¤‰æ•°
let formScheduleCalendar = null;

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼åˆæœŸåŒ–ï¼ˆFullCalendarï¼‰
function initializeFormCalendar() {
    const calendarEl = document.getElementById('formScheduleCalendar');
    if (!calendarEl) return;

    // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const scheduleTab = document.getElementById('schedule');
    const isScheduleTabVisible = scheduleTab && scheduleTab.classList.contains('active');

    formScheduleCalendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ja',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: ''  // å³å´ã®ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã¯ä¸è¦
        },
        buttonText: {
            today: 'ä»Šæ—¥'
        },
        height: 'auto',
        displayEventEnd: true,  // æœŸé–“ã‚¤ãƒ™ãƒ³ãƒˆã®çµ‚äº†æ—¥ã‚’è¡¨ç¤º
        displayEventTime: false,
        eventDisplay: 'block',
        events: function(info, successCallback, failureCallback) {
            // ã“ã®æ¡ˆä»¶ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
            const stepEvents = [];
            let constructionStartDate = null;
            let completionDate = null;

            // è¦‹ç©æ›¸ä¸è¦ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
            const estimateNotRequiredCheckbox = document.getElementById('{{ form.estimate_not_required.id_for_label }}');
            const isEstimateNotRequired = estimateNotRequiredCheckbox && estimateNotRequiredCheckbox.checked;

            // ã¾ãšç€å·¥æ—¥ã¨å®Œå·¥æ—¥ã‚’æ¢ã™
            document.querySelectorAll('#formActiveSteps .step-date-input').forEach(input => {
                if (input.value && input.dataset.step) {
                    // step_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãã®ã‚­ãƒ¼ã«å¯¾å¿œ
                    const stepKey = input.dataset.step;
                    if (stepKey === 'step_construction_start' || stepKey === 'construction_start') {
                        constructionStartDate = input.value;
                    } else if (stepKey === 'step_completion' || stepKey === 'completion') {
                        completionDate = input.value;
                    }
                }
            });

            // ç€å·¥æ—¥ã¨å®Œå·¥æ—¥ã®ä¸¡æ–¹ãŒã‚ã‚‹å ´åˆã¯1ã¤ã®æœŸé–“ã‚¤ãƒ™ãƒ³ãƒˆã¨ã—ã¦ä½œæˆ
            if (constructionStartDate && completionDate) {
                // FullCalendarã®æœŸé–“ã‚¤ãƒ™ãƒ³ãƒˆ: endã¯æ’ä»–çš„ï¼ˆç¿Œæ—¥ã‚’æŒ‡å®šï¼‰
                const endDate = new Date(completionDate);
                endDate.setDate(endDate.getDate() + 1);
                const endDateStr = endDate.toISOString().split('T')[0];

                stepEvents.push({
                    title: 'ç€å·¥ã€œå®Œå·¥',
                    start: constructionStartDate,
                    end: endDateStr,
                    allDay: true,
                    backgroundColor: '#4CAF50',  // ç·‘è‰²
                    borderColor: '#4CAF50',
                    extendedProps: {
                        isCurrentProject: true,
                        stepKey: 'construction_period'
                    }
                });
            } else if (constructionStartDate) {
                // ç€å·¥æ—¥ã®ã¿ã‚ã‚‹å ´åˆ
                stepEvents.push({
                    title: 'ç€å·¥æ—¥',
                    start: constructionStartDate,
                    allDay: true,
                    backgroundColor: '#4CAF50',
                    borderColor: '#4CAF50',
                    extendedProps: {
                        isCurrentProject: true,
                        stepKey: 'construction_start'
                    }
                });
            } else if (completionDate) {
                // å®Œå·¥æ—¥ã®ã¿ã‚ã‚‹å ´åˆ
                stepEvents.push({
                    title: 'å®Œå·¥æ—¥',
                    start: completionDate,
                    allDay: true,
                    backgroundColor: '#4CAF50',
                    borderColor: '#4CAF50',
                    extendedProps: {
                        isCurrentProject: true,
                        stepKey: 'completion'
                    }
                });
            }

            // ãã®ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ï¼ˆç€å·¥æ—¥ã¨å®Œå·¥æ—¥ä»¥å¤–ï¼‰
            document.querySelectorAll('#formActiveSteps .step-date-input').forEach(input => {
                if (input.value && input.dataset.step) {
                    const stepKey = input.dataset.step;

                    // ç€å·¥æ—¥ã¨å®Œå·¥æ—¥ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã™ã§ã«å‡¦ç†æ¸ˆã¿ï¼‰
                    if (stepKey === 'step_construction_start' || stepKey === 'construction_start' ||
                        stepKey === 'step_completion' || stepKey === 'completion') {
                        return;
                    }

                    // è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã¯è¦‹ç©ã‚‚ã‚Šä¸è¦ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                    if ((stepKey === 'step_estimate' || stepKey === 'estimate') && isEstimateNotRequired) {
                        return;
                    }

                    const stepData = formDefaultSteps.find(s => s.key === stepKey) ||
                                    formAvailableSteps.find(s => s.key === stepKey);
                    if (stepData) {
                        stepEvents.push({
                            title: stepData.name,
                            start: input.value,
                            allDay: true,
                            backgroundColor: '#4CAF50',  // ç·‘è‰²
                            borderColor: '#4CAF50',
                            extendedProps: {
                                isCurrentProject: true,
                                stepKey: stepKey
                            }
                        });
                    }
                }
            });

            // æ—¢å­˜æ¡ˆä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’å–å¾—
            fetch('{% url "order_management:calendar_events_api" %}')
                .then(response => response.json())
                .then(data => {
                    // æ—¢å­˜æ¡ˆä»¶ã¯è–„ã„ç°è‰²ã«
                    const existingEvents = data.map(event => ({
                        ...event,
                        backgroundColor: '#E0E0E0',
                        borderColor: '#E0E0E0',
                        extendedProps: {
                            ...event.extendedProps,
                            isCurrentProject: false
                        }
                    }));

                    // ã“ã®æ¡ˆä»¶ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨æ—¢å­˜æ¡ˆä»¶ã‚’çµåˆ
                    successCallback([...stepEvents, ...existingEvents]);
                    console.log('âœ“ Calendar loaded:', stepEvents.length, 'steps +', existingEvents.length, 'existing events');
                })
                .catch(error => {
                    console.error('Error loading existing events:', error);
                    // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ã“ã®æ¡ˆä»¶ã®ã‚¹ãƒ†ãƒƒãƒ—ã¯è¡¨ç¤º
                    successCallback(stepEvents);
                });
        },
        eventClick: function(info) {
            const event = info.event;
            const props = event.extendedProps;

            // ã“ã®æ¡ˆä»¶ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼ˆã‚¯ãƒªãƒƒã‚¯ä¸å¯ï¼‰
            if (props.isCurrentProject) {
                return;
            }

            // æ—¢å­˜æ¡ˆä»¶ã®å ´åˆã¯æ¡ˆä»¶è©³ç´°ãƒšãƒ¼ã‚¸ã«é·ç§»
            if (props.project_id) {
                window.open(`/orders/${props.project_id}/`, '_blank');
            }
        }
    });

    formScheduleCalendar.render();

    // ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å³åº§ã«ã‚µã‚¤ã‚ºæ›´æ–°ã€ãã†ã§ãªã‘ã‚Œã°ã‚¿ãƒ–è¡¨ç¤ºæ™‚ã«æ›´æ–°
    if (isScheduleTabVisible) {
        console.log('âœ“ FullCalendar initialized (tab is visible)');
        setTimeout(function() {
            formScheduleCalendar.updateSize();
        }, 100);
    } else {
        console.log('âœ“ FullCalendar initialized (will be resized when tab is shown)');
    }
}

// ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚µã‚¤ã‚ºã‚’æ›´æ–°
$(document).ready(function() {
    // Bootstrap 5ã®ã‚¿ãƒ–ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ï¼ˆbuttonã¾ãŸã¯aè¦ç´ ï¼‰
    const scheduleTabTrigger = document.querySelector('button[data-bs-toggle="tab"][data-bs-target="#schedule"]') ||
                                document.querySelector('a[data-bs-toggle="tab"][href="#schedule"]');

    if (scheduleTabTrigger) {
        console.log('âœ“ Schedule tab trigger found:', scheduleTabTrigger.tagName);

        scheduleTabTrigger.addEventListener('shown.bs.tab', function (event) {
            if (formScheduleCalendar) {
                console.log('ğŸ“… Schedule tab shown, updating calendar size');
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰è¤‡æ•°å›ã‚µã‚¤ã‚ºã‚’æ›´æ–°ï¼ˆç¢ºå®Ÿã«æç”»ã•ã›ã‚‹ãŸã‚ï¼‰
                setTimeout(function() {
                    formScheduleCalendar.updateSize();
                    console.log('ğŸ“… Calendar size updated (50ms)');
                }, 50);
                setTimeout(function() {
                    formScheduleCalendar.updateSize();
                    console.log('ğŸ“… Calendar size updated (200ms)');
                }, 200);
                setTimeout(function() {
                    formScheduleCalendar.updateSize();
                    console.log('ğŸ“… Calendar size updated (400ms)');
                }, 400);
            }
        });

        // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚‚ç›£è¦–ï¼ˆå¿µã®ãŸã‚ï¼‰
        scheduleTabTrigger.addEventListener('click', function (event) {
            if (formScheduleCalendar) {
                console.log('ğŸ“… Schedule tab clicked');
                setTimeout(function() {
                    formScheduleCalendar.updateSize();
                }, 300);
            }
        });
    } else {
        console.error('âŒ Schedule tab trigger not found');
    }

    // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚µã‚¤ã‚ºæ™‚ã‚‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
    let resizeTimeout;
    window.addEventListener('resize', function() {
        if (formScheduleCalendar) {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                formScheduleCalendar.updateSize();
            }, 200);
        }
    });

    // è¦‹ç©æ›¸ä¸è¦ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã‚‚ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æ›´æ–°
    const estimateNotRequiredCheckbox = document.getElementById('{{ form.estimate_not_required.id_for_label }}');
    if (estimateNotRequiredCheckbox) {
        estimateNotRequiredCheckbox.addEventListener('change', function() {
            console.log('ğŸ“‹ è¦‹ç©æ›¸ä¸è¦ã®çŠ¶æ…‹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', this.checked);
            if (typeof updateFormCalendar === 'function') {
                updateFormCalendar();
            }
        });
    }
});

// ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°ï¼ˆã‚¹ãƒ†ãƒƒãƒ—ã®æ—¥ä»˜ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãï¼‰
window.updateFormCalendar = function() {
    if (formScheduleCalendar) {
        formScheduleCalendar.refetchEvents();
        // ã‚µã‚¤ã‚ºã‚‚å†è¨ˆç®—ï¼ˆå¿µã®ãŸã‚ï¼‰
        setTimeout(function() {
            formScheduleCalendar.updateSize();
        }, 100);
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('click', function(e) {
    if (e.target.closest('.add-form-step-btn')) {
        const btn = e.target.closest('.add-form-step-btn');
        const stepKey = btn.dataset.stepKey;

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã¨è¿½åŠ å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã®ä¸¡æ–¹ã‹ã‚‰æ¤œç´¢
        const allAvailableSteps = [...formDefaultSteps, ...formAvailableSteps];
        const stepData = allAvailableSteps.find(s => s.key === stepKey);

        if (stepData) {
            // ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
            const container = document.getElementById('formActiveSteps');
            container.insertAdjacentHTML('beforeend', generateFormStepHTML(stepData));

            // æ–°ã—ãè¿½åŠ ã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‰ã˜ãŸçŠ¶æ…‹ã«ã™ã‚‹
            const newStep = container.lastElementChild;
            const newContent = newStep ? newStep.querySelector('.progress-step-content') : null;
            if (newContent) {
                newContent.style.display = 'none';
            }

            // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’å†æç”»
            renderFormAvailableSteps();

            // Sortableã‚’å†åˆæœŸåŒ–
            initializeFormSortable();

            // ãƒˆã‚°ãƒ«ã‚’å†åˆæœŸåŒ–
            initializeFormStepToggles();

            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            updateFormScheduleData();

            console.log(`âœ“ Added step: ${stepData.name}`);
        }
    }
});

// ã‚¹ãƒ†ãƒƒãƒ—è©³ç´°ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè¦‹ç©ã‚‚ã‚Šã‚¹ãƒ†ãƒƒãƒ—ç”¨ï¼‰
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.toggle-step-details-btn');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();

        const step = btn.closest('.progress-step');
        if (!step) {
            console.error('âŒ progress-step not found');
            return;
        }

        const detailsArea = step.querySelector('.step-details-area');
        if (!detailsArea) {
            console.error('âŒ step-details-area not found');
            return;
        }

        // è©³ç´°ã‚¨ãƒªã‚¢ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        if (detailsArea.style.display === 'none') {
            detailsArea.style.display = 'block';
            btn.innerHTML = '<i class="fas fa-minus" style="font-size: 0.6rem;"></i> è©³ç´°';
            btn.classList.remove('btn-outline-secondary');
            btn.classList.add('btn-secondary');
        } else {
            detailsArea.style.display = 'none';
            btn.innerHTML = '<i class="fas fa-plus" style="font-size: 0.6rem;"></i> è©³ç´°';
            btn.classList.remove('btn-secondary');
            btn.classList.add('btn-outline-secondary');
        }
    }
}, true); // useCapture = true ã§ç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒƒãƒ

// ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.remove-form-step-btn');
    if (btn) {
        e.preventDefault();
        e.stopPropagation(); // ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢

        const step = btn.closest('.progress-step');
        if (!step) {
            console.error('âŒ progress-step not found');
            return;
        }

        const stepKey = step.dataset.step;
        console.log(`ğŸ—‘ï¸ Removing step: ${stepKey}`);

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤
        step.remove();

        // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’å†æç”»
        renderFormAvailableSteps();

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        updateFormScheduleData();

        console.log(`âœ… Step removed: ${stepKey}`);

        if (typeof toastr !== 'undefined') {
            toastr.info('ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }
    }
}, true); // useCapture = true ã§ç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ã‚­ãƒ£ãƒƒãƒ

// å®Ÿæ–½æ—¥è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.add-actual-date-btn');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();

        const step = btn.closest('.progress-step');
        if (!step) {
            console.error('âŒ progress-step not found');
            return;
        }

        const actualDateField = step.querySelector('.actual-date-field');
        if (actualDateField) {
            actualDateField.style.display = 'block';
            console.log('âœ“ å®Ÿæ–½æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
        }
    }
}, true);

// å®Ÿæ–½æ—¥å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.remove-actual-date-btn');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();

        const step = btn.closest('.progress-step');
        if (!step) {
            console.error('âŒ progress-step not found');
            return;
        }

        const actualDateField = step.querySelector('.actual-date-field');
        const actualDateInput = step.querySelector('.actual-date-input');

        if (actualDateField) {
            actualDateField.style.display = 'none';
            if (actualDateInput) {
                actualDateInput.value = '';
            }
            console.log('âœ“ å®Ÿæ–½æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
        }
    }
}, true);

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('click', function(e) {
    const btn = e.target.closest('.upload-estimate-file-btn');
    if (btn) {
        e.preventDefault();
        e.stopPropagation();

        const step = btn.closest('.progress-step');
        if (!step) {
            console.error('âŒ progress-step not found');
            return;
        }

        const fileInput = step.querySelector('.estimate-file-input');
        if (fileInput) {
            fileInput.click();
        }
    }
}, true);

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('change', function(e) {
    if (e.target.classList.contains('estimate-file-input')) {
        const fileInput = e.target;
        const step = fileInput.closest('.progress-step');
        if (!step) return;

        const filesList = step.querySelector('.estimate-files-list');
        if (!filesList) return;

        const files = fileInput.files;
        if (files.length > 0) {
            let html = '';
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileSize = (file.size / 1024 / 1024).toFixed(2); // MB
                html += `
                    <div class="alert alert-info py-1 px-2 mb-1 d-flex justify-content-between align-items-center" style="font-size: 0.85rem;">
                        <span><i class="fas fa-file me-2"></i>${file.name} (${fileSize} MB)</span>
                        <button type="button" class="btn btn-sm btn-outline-danger py-0 px-1" onclick="this.parentElement.remove()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }
            filesList.innerHTML = html;
            console.log('âœ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¾ã—ãŸ:', files.length, 'ä»¶');
        }
    }
});

// ã‚¹ãƒ†ãƒƒãƒ—ã®å®Œäº†ã‚¯ãƒ©ã‚¹ã‚’æ›´æ–°ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®çŠ¶æ…‹ã«å¿œã˜ã¦ï¼‰
function updateStepCompletedClass(checkbox) {
    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¦ªã®ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ ã‚’å–å¾—
    const stepElement = checkbox.closest('.progress-step');
    if (stepElement) {
        if (checkbox.checked) {
            stepElement.classList.add('completed');
        } else {
            stepElement.classList.remove('completed');
        }
    }
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜
function updateFormScheduleData() {
    const steps = document.querySelectorAll('#formActiveSteps .progress-step');
    const stepsData = [];

    steps.forEach((step, index) => {
        const stepKey = step.dataset.step;

        // ã‚µãƒ¼ãƒãƒ¼å´ã¯step_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—ã®ã‚­ãƒ¼ã‚’æœŸå¾…ã—ã¦ã„ã‚‹ãŸã‚ã€ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
        const sanitizedKey = stepKey && stepKey.startsWith('step_')
            ? stepKey.replace('step_', '')
            : stepKey;

        const scheduledDate = step.querySelector(`input[name="${stepKey}_scheduled_date"]`)?.value || '';
        const completed = step.querySelector(`input[name="${stepKey}_completed"]`)?.checked || false;

        stepsData.push({
            key: sanitizedKey,
            order: index + 1,
            scheduled_date: scheduledDate,
            completed: completed
        });
    });

    const hiddenField = document.getElementById('formScheduleStepsData');
    if (hiddenField) {
        hiddenField.value = JSON.stringify(stepsData);
        console.log('âœ“ Schedule data updated:', stepsData.length, 'steps');
        console.log('ğŸ“‹ Sanitized keys:', stepsData.map(s => s.key));
    }
}

// å…¥åŠ›å¤‰æ›´æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
document.addEventListener('change', function(e) {
    if (e.target.matches('#formActiveSteps input[type="date"]') ||
        e.target.matches('#formActiveSteps input[type="checkbox"]')) {
        updateFormScheduleData();
    }
});

// ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
const formToggleBtn = document.getElementById('formToggleAllSteps');
if (formToggleBtn) {
    formToggleBtn.addEventListener('click', formToggleAllSteps);
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸåŒ–
initializeFormDefaultSteps();

});
</script>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>


<style>
/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.schedule-steps-container {
    max-height: 600px;
    overflow-y: auto;
}

.progress-steps-list {
    position: relative;
    padding-left: 20px;
}

.progress-step {
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.progress-step-header {
    font-weight: 600;
    color: #495057;
    transition: color 0.3s ease;
    cursor: pointer;
}

.progress-step.completed .progress-step-header {
    color: #28a745;
}

.progress-step-label {
    font-size: 1rem;
    font-weight: 500;
}

.progress-step-date {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 4px;
    margin-bottom: 8px;
}

.progress-step.completed .progress-step-date {
    color: #28a745;
    font-weight: 600;
}

.progress-step-content {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 12px;
    margin-top: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.progress-step:hover {
    transform: translateX(3px);
}

.toggle-icon {
    transition: transform 0.3s ease;
    font-size: 0.8rem;
}

.btn-xs {
    padding: 0.1rem 0.3rem;
    font-size: 0.7rem;
    line-height: 1.2;
}
</style>

<!-- ========================================
     ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
     ======================================== -->
<script>
// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('projectFileInput');
    const newFilesPreview = document.getElementById('newFilesPreview');
    let selectedFiles = [];

    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            selectedFiles = Array.from(e.target.files);
            displayFilePreview();
        });
    }

    function displayFilePreview() {
        if (selectedFiles.length === 0) {
            newFilesPreview.innerHTML = '';
            return;
        }

        let html = '<div class="card border-info mt-2"><div class="card-header bg-info text-white py-2">';
        html += '<small><i class="fas fa-upload me-1"></i>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰äºˆå®šã®ãƒ•ã‚¡ã‚¤ãƒ« (' + selectedFiles.length + 'ä»¶)</small>';
        html += '</div><div class="card-body p-2"><ul class="list-group list-group-flush">';

        selectedFiles.forEach((file, index) => {
            const sizeInKB = (file.size / 1024).toFixed(2);
            const sizeInMB = (file.size / (1024 * 1024)).toFixed(2);
            const displaySize = file.size > 1024 * 1024 ? sizeInMB + ' MB' : sizeInKB + ' KB';

            html += '<li class="list-group-item d-flex justify-content-between align-items-center py-2">';
            html += '<span><i class="fas fa-file me-2"></i>' + file.name + ' <small class="text-muted">(' + displaySize + ')</small></span>';
            html += '<button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFileFromPreview(' + index + ')">';
            html += '<i class="fas fa-times"></i></button></li>';
        });

        html += '</ul></div></div>';
        newFilesPreview.innerHTML = html;
    }

    window.removeFileFromPreview = function(index) {
        selectedFiles.splice(index, 1);
        displayFilePreview();

        // FileListã‚’å†ä½œæˆï¼ˆinputè¦ç´ ã‚’æ›´æ–°ï¼‰
        const dataTransfer = new DataTransfer();
        selectedFiles.forEach(file => dataTransfer.items.add(file));
        fileInput.files = dataTransfer.files;
    };
});

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤æ©Ÿèƒ½
window.deleteProjectFile = function(fileId) {
    if (!confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
        return;
    }

    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch(`/orders/file/${fileId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
            const fileElement = document.querySelector(`button[onclick="deleteProjectFile(${fileId})"]`).closest('li');
            if (fileElement) {
                fileElement.remove();
            }

            // ãƒªã‚¹ãƒˆãŒç©ºã«ãªã£ãŸã‚‰ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’å‰Šé™¤
            const uploadedFilesList = document.getElementById('uploadedFilesList');
            const remainingFiles = uploadedFilesList.querySelectorAll('li');
            if (remainingFiles.length === 0) {
                uploadedFilesList.innerHTML = '';
            }

            if (typeof toastr !== 'undefined') {
                toastr.success('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        } else {
            if (typeof toastr !== 'undefined') {
                toastr.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        if (typeof toastr !== 'undefined') {
            toastr.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    });
};

// ==================== ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£é–¢æ•° ====================

// æ¥­è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæ—¢ã« window.contractors_json ã¨ã—ã¦å®šç¾©ã•ã‚Œã¦ã„ã‚‹ï¼‰
const contractorsData = {};
if (window.contractors_json) {
    window.contractors_json.forEach(contractor => {
        contractorsData[contractor.id] = contractor;
    });
}

// è¿½åŠ å·¥ç¨‹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã®ãƒãƒ³ãƒ‰ãƒ©
function handleAdditionalStepsChange() {
    const checkedBoxes = $('.additional-step-checkbox:checked');

    if (checkedBoxes.length > 0) {
        // ç¾èª¿ï¼ˆstep_surveyï¼‰ãŒãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ã«è¿½åŠ 
        const surveyCheckbox = $('#addStep_step_survey');
        if (surveyCheckbox.is(':checked')) {
            // ç¾èª¿ã‚¹ãƒ†ãƒƒãƒ—ãŒæ—¢ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            // ãƒšãƒ¼ã‚¸å†…ã«ç¾èª¿ã‚«ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ ãŒå¿…è¦
            const surveyStepExists = $('[data-step-key="step_survey"]').length > 0 ||
                                     $('.step-card:contains("ç¾èª¿")').length > 0;

            if (!surveyStepExists) {
                // ç¾èª¿ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‹•çš„ã«è¿½åŠ 
                if (typeof toastr !== 'undefined') {
                    toastr.info('ç¾èª¿ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã—ã¦ã„ã¾ã™...', '', {timeOut: 2000});
                }

                // ã“ã“ã§å®Ÿéš›ã«ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã™ã‚‹å‡¦ç†
                // ç°¡æ˜“çš„ãªå®Ÿè£…ï¼šãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°ã‚’åæ˜ 
                // ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸå®Ÿè£…ã§ã¯ã€AJAXçµŒç”±ã§ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦DOMã‚’æ›´æ–°
                console.log('Survey step will be added when saving the subcontract');
            }
        }

        // 1ã¤ä»¥ä¸Šã®å·¥ç¨‹ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã€é‡‘é¡è¨­å®šæ–¹æ³•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        $('#costAllocationSection').show();

        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ã«å¿œã˜ã¦å…¥åŠ›æ¬„ã‚’æ›´æ–°
        updatePerStepAmountsInputs();

        // å·¥ç¨‹ã”ã¨ã®é‡‘é¡è¨­å®šãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€ç·ã‚³ã‚¹ãƒˆè¨ˆç®—
        const method = $('input[name="cost_allocation_method"]:checked').val();
        if (method === 'per_step') {
            calculatePerStepTotalCost();
        }
    } else {
        // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã¯éè¡¨ç¤º
        $('#costAllocationSection').hide();
        $('#perStepAmountsSection').hide();
    }
}

// å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›æ¬„ã‚’ç”Ÿæˆ
function updatePerStepAmountsInputs() {
    const checkedBoxes = $('.additional-step-checkbox:checked');
    const currentStepKey = $('#subcontractStep').val();

    console.log('ğŸ’° å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›æ¬„ã‚’ç”Ÿæˆ:', {
        currentStepKey,
        checkedBoxesCount: checkedBoxes.length
    });

    // ç¾åœ¨ã®å·¥ç¨‹åã‚’å–å¾—ï¼ˆãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—ã¨ã‚ã‚Šã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
    const stepNames = {
        'attendance': 'ç«‹ã¡ä¼šã„',
        'survey': 'ç¾èª¿',
        'construction_start': 'ç€å·¥',
        'estimate': 'è¦‹ç©æ›¸ç™ºè¡Œ',
        'completion': 'å®Œå·¥',
        'step_attendance': 'ç«‹ã¡ä¼šã„',
        'step_survey': 'ç¾èª¿',
        'step_construction_start': 'ç€å·¥',
        'step_estimate': 'è¦‹ç©æ›¸ç™ºè¡Œ',
        'step_completion': 'å®Œå·¥'
    };
    const currentStepName = stepNames[currentStepKey] || '';

    let inputsHtml = '';

    // ç¾åœ¨ã®å·¥ç¨‹ã®å…¥åŠ›æ¬„
    if (currentStepName) {
        inputsHtml += `
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-calendar-check me-1"></i>${currentStepName}ï¼ˆãƒ¡ã‚¤ãƒ³å·¥ç¨‹ï¼‰
                </label>
                <input type="number" class="form-control bg-light step-amount-input-all" id="currentStepAmount"
                       placeholder="ä¸Šéƒ¨ã®å¥‘ç´„é‡‘é¡ãŒè‡ªå‹•åæ˜ ã•ã‚Œã¾ã™" min="0" step="1000" readonly>
            </div>
        `;
    }

    // è¿½åŠ å·¥ç¨‹ã®å…¥åŠ›æ¬„ï¼ˆãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã‚’é™¤å¤–ï¼‰
    checkedBoxes.each(function() {
        const stepKey = $(this).val();
        const stepLabel = $(this).data('label');

        // ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã¨ã—ã¦æ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        // stepKeyã€currentStepKeyã¨ã‚‚ã« "step_attendance" ã®ã‚ˆã†ãªå½¢å¼ã«æ­£è¦åŒ–
        const normalizedStepKey = stepKey.startsWith('step_') ? stepKey : `step_${stepKey}`;
        const normalizedCurrentKey = currentStepKey.startsWith('step_') ? currentStepKey : `step_${currentStepKey}`;

        if (normalizedStepKey === normalizedCurrentKey) {
            console.log(`â­ï¸ ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã¨ã—ã¦ã‚¹ã‚­ãƒƒãƒ—: ${stepLabel} (${stepKey})`);
            return; // continue to next iteration
        }

        console.log(`â• è¿½åŠ å·¥ç¨‹ã¨ã—ã¦è¡¨ç¤º: ${stepLabel} (${stepKey})`);


        inputsHtml += `
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-calendar-check me-1"></i>${stepLabel}
                </label>
                <input type="number" class="form-control step-amount-input step-amount-input-all"
                       name="step_amounts[${stepKey}]"
                       data-step="${stepKey}"
                       placeholder="å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›" min="0" step="1000" required>
            </div>
        `;
    });

    $('#perStepAmountsInputs').html(inputsHtml);

    // ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®é‡‘é¡ã‚’å¥‘ç´„é‡‘é¡ã¨é€£å‹•ã•ã›ã‚‹
    syncMainStepAmount();

    // å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–
    $('.step-amount-input').off('input').on('input', calculatePerStepTotalCost);
}

// ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®é‡‘é¡ã‚’å¥‘ç´„é‡‘é¡ã¨é€£å‹•
function syncMainStepAmount() {
    const contractAmount = $('#subcontractContractAmount').val();
    const currentStepAmountInput = $('#currentStepAmount');

    if (currentStepAmountInput.length && contractAmount) {
        currentStepAmountInput.val(contractAmount);
        console.log('âœ… ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®é‡‘é¡ã‚’å¥‘ç´„é‡‘é¡ã¨é€£å‹•:', contractAmount);

        // ç·ã‚³ã‚¹ãƒˆè¨ˆç®—ã‚’å®Ÿè¡Œ
        calculatePerStepTotalCost();
    }
}

// å·¥ç¨‹ã”ã¨ã®ç·ã‚³ã‚¹ãƒˆè¨ˆç®—
function calculatePerStepTotalCost() {
    let total = 0;
    const breakdown = [];

    // ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®é‡‘é¡ã‚’å–å¾—
    const currentAmount = parseFloat($('#currentStepAmount').val()) || 0;
    if (currentAmount > 0) {
        const currentStepKey = $('#subcontractStep').val();
        const stepNames = {
            'attendance': 'ç«‹ã¡ä¼šã„',
            'survey': 'ç¾èª¿',
            'construction_start': 'ç€å·¥',
            'estimate': 'è¦‹ç©æ›¸ç™ºè¡Œ',
            'completion': 'å®Œå·¥',
            'step_attendance': 'ç«‹ã¡ä¼šã„',
            'step_survey': 'ç¾èª¿',
            'step_construction_start': 'ç€å·¥',
            'step_estimate': 'è¦‹ç©æ›¸ç™ºè¡Œ',
            'step_completion': 'å®Œå·¥'
        };
        const currentStepName = stepNames[currentStepKey] || currentStepKey;
        breakdown.push(`<strong>${currentStepName}ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰:</strong> Â¥${currentAmount.toLocaleString()}`);
        total += currentAmount;
    }

    // ãã®ä»–ã®å·¥ç¨‹ã®é‡‘é¡ã‚’å–å¾—
    $('.step-amount-input').each(function() {
        const amount = parseFloat($(this).val()) || 0;
        if (amount > 0) {
            const stepLabel = $(this).prev('label').find('i').length > 0
                ? $(this).prev('label').text().trim().replace(/\s+/g, ' ')
                : $(this).data('step');
            breakdown.push(`<strong>${stepLabel}:</strong> Â¥${amount.toLocaleString()}`);
            total += amount;
        }
    });

    // åˆè¨ˆè¡¨ç¤ºã‚’æ›´æ–°
    $('#perStepTotalCost').text(total.toLocaleString());

    // å†…è¨³è¡¨ç¤ºã‚’æ›´æ–°
    if (breakdown.length > 0) {
        $('#perStepCostBreakdown').html(breakdown.join('<br>'));
    } else {
        $('#perStepCostBreakdown').html('<span class="text-muted">é‡‘é¡ã‚’å…¥åŠ›ã™ã‚‹ã¨å†…è¨³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</span>');
    }

    console.log('ğŸ’° ç·ã‚³ã‚¹ãƒˆè¨ˆç®—å®Œäº†:', {
        total: total,
        breakdown: breakdown
    });
}

// é‡‘é¡è¨­å®šæ–¹æ³•ã®å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
$(document).on('change', 'input[name="cost_allocation_method"]', function() {
    const method = $(this).val();

    if (method === 'per_step') {
        // å·¥ç¨‹ã”ã¨ã«é‡‘é¡ã‚’è¨­å®šã™ã‚‹å ´åˆ
        updatePerStepAmountsInputs();
        $('#perStepAmountsSection').show();

        // ä¸Šéƒ¨ã®å¥‘ç´„é‡‘é¡ã¯ç·¨é›†å¯èƒ½ã®ã¾ã¾
        // ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¸Šéƒ¨ã®å€¤ã‚’åæ˜ 
        const contractAmount = $('#subcontractContractAmount').val();
        $('#currentStepAmount').val(contractAmount);

        // ç·ã‚³ã‚¹ãƒˆè¨ˆç®—
        calculatePerStepTotalCost();
    } else {
        // ä¸€å¼ã®å ´åˆã¯éè¡¨ç¤º
        $('#perStepAmountsSection').hide();
    }
});

// ä¸Šéƒ¨ã®å¥‘ç´„é‡‘é¡ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã€ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•åæ˜ 
$(document).on('input', '#subcontractContractAmount', function() {
    const method = $('input[name="cost_allocation_method"]:checked').val();

    // å·¥ç¨‹ã”ã¨ã«é‡‘é¡ã‚’è¨­å®šã™ã‚‹å ´åˆã®ã¿ã€ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã«åæ˜ 
    if (method === 'per_step') {
        const contractAmount = $(this).val();
        $('#currentStepAmount').val(contractAmount);

        // ç·ã‚³ã‚¹ãƒˆè¨ˆç®—
        calculatePerStepTotalCost();
    }
});

// å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›æ¬„ãŒå¤‰æ›´ã•ã‚ŒãŸã¨ãã«ç·ã‚³ã‚¹ãƒˆè¨ˆç®—
$(document).on('input', '.step-amount-input-all', function() {
    const method = $('input[name="cost_allocation_method"]:checked').val();
    if (method === 'per_step') {
        calculatePerStepTotalCost();
    }
});

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
function showModalError(message) {
    // æ—¢å­˜ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    $('#subcontractModalError').remove();

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒœãƒ‡ã‚£ã®å…ˆé ­ã«æŒ¿å…¥
    const errorHtml = `
        <div id="subcontractModalError" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    $('#subcontractModal .modal-body').prepend(errorHtml);

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('#subcontractModal .modal-body').scrollTop(0);
}

// ä¸‹è«‹ã‘ã‚’ä¿å­˜
window.saveSubcontract = function() {
    const form = $('#subcontractForm');
    const formData = new FormData(form[0]);

    // å‹•çš„ãƒ‡ãƒ¼ã‚¿ã‚’FormDataã«è¿½åŠ 
    formData.set('dynamic_materials_data', $('#modalDynamicMaterialsData').val() || '[]');
    formData.set('additional_costs_data', $('#modalAdditionalCostsData').val() || '[]');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
    $('#subcontractModalError').remove();

    // æ¥­è€…ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const contractorId = $('#subcontractContractor').val();
    if (!contractorId) {
        showModalError('ä¸‹è«‹ã‘ç®¡ç†ãƒœã‚¿ãƒ³ã‹ã‚‰æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    // å·¥ç¨‹ã”ã¨ã®é‡‘é¡è¨­å®šã®å ´åˆã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const costMethod = $('input[name="cost_allocation_method"]:checked').val();
    // è¿½åŠ å·¥ç¨‹ãŒ1ã¤ä»¥ä¸Šé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
    const hasAdditionalSteps = $('.additional-step-checkbox:checked').length > 0;

    // costMethodãŒ'per_step'ã§ã€è¿½åŠ å·¥ç¨‹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (costMethod === 'per_step' && hasAdditionalSteps) {
        // ç¾åœ¨ã®å·¥ç¨‹ã®é‡‘é¡ã‚’å–å¾—ï¼ˆ0å††ã‚‚è¨±å¯ã™ã‚‹ãŸã‚ã€ç©ºã‹ã©ã†ã‹ã®ã¿ãƒã‚§ãƒƒã‚¯ï¼‰
        const currentStepAmount = $('#currentStepAmount').val();
        if (currentStepAmount === '' || currentStepAmount === null || currentStepAmount === undefined) {
            showModalError('ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // å„è¿½åŠ å·¥ç¨‹ã®é‡‘é¡ã‚’åé›†ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆ0å††ã‚‚è¨±å¯ï¼‰
        const stepAmounts = {};
        let hasError = false;
        let errorMessage = '';
        $('.step-amount-input').each(function() {
            const stepKey = $(this).data('step');
            const amount = $(this).val();
            if (amount === '' || amount === null || amount === undefined) {
                errorMessage = `${$(this).prev('label').text().replace(/ï¼ˆ.*ï¼‰/, '')}ã®å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                hasError = true;
                return false;
            }
            stepAmounts[stepKey] = amount;
        });

        if (hasError) {
            showModalError(errorMessage);
            return;
        }

        // ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®é‡‘é¡ã‚‚ stepAmounts ã«è¿½åŠ 
        stepAmounts[$('#subcontractStep').val()] = currentStepAmount;

        // JSONå½¢å¼ã§é€ä¿¡
        formData.set('step_amounts', JSON.stringify(stepAmounts));

        // ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®å¥‘ç´„é‡‘é¡ã¯ä¸Šéƒ¨ã®å¥‘ç´„é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å–å¾—
    }

    // é‡‘é¡è¨­å®šæ–¹æ³•ã‚’è¿½åŠ 
    if ($('#costAllocationSection').is(':visible')) {
        formData.set('cost_allocation_method', costMethod);
    }

    // éè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®requiredå±æ€§ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤ï¼ˆHTML5ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
    const hiddenRequiredFields = [];
    form.find('input[required], select[required], textarea[required]').each(function() {
        const $field = $(this);
        // éè¡¨ç¤ºã€ã¾ãŸã¯è¦ªè¦ç´ ãŒéè¡¨ç¤ºã®å ´åˆ
        if (!$field.is(':visible') || $field.closest(':hidden').length > 0) {
            hiddenRequiredFields.push($field);
            $field.removeAttr('required');
        }
    });

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!form[0].checkValidity()) {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã€requiredå±æ€§ã‚’å¾©å…ƒ
        hiddenRequiredFields.forEach(function($field) {
            $field.attr('required', 'required');
        });
        form[0].reportValidity();
        return;
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸå¾Œã€requiredå±æ€§ã‚’å¾©å…ƒ
    hiddenRequiredFields.forEach(function($field) {
        $field.attr('required', 'required');
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’å–å¾—ï¼ˆæ–°è¦ä½œæˆã®å ´åˆã¯ä¸€æ™‚çš„ã«ä¿å­˜ã—ã¦ã‹ã‚‰subcontractã‚’ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
    const projectId = $('input[name="project_id"]').val();

    if (!projectId) {
        showModalError('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å…ˆã«ä¿å­˜ã—ã¦ã‹ã‚‰ä½œæ¥­è€…ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
        return;
    }

    // AJAXé€ä¿¡
    $.ajax({
        url: `/subcontracts/project/${projectId}/create/`,
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            const modalInstance = bootstrap.Modal.getInstance(document.getElementById('subcontractModal'));
            if (modalInstance) {
                modalInstance.hide();
            }

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (typeof toastr !== 'undefined') {
                toastr.success(response.message || 'ä½œæ¥­è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }

            // processWorkersã«è¿½åŠ ã—ã¦ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã‚’é¿ã‘ã‚‹ï¼‰
            console.log('ğŸ“¦ Response:', response);
            console.log('ğŸ‘¥ Current processWorkers:', window.processWorkers);

            // ä½œæˆã•ã‚ŒãŸã™ã¹ã¦ã® subcontract ã‚’ processWorkers ã«è¿½åŠ 
            if (typeof window.processWorkers !== 'undefined') {
                // subcontractsï¼ˆè¤‡æ•°å½¢ï¼‰ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã° subcontractï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
                const subcontractsToAdd = response.subcontracts || (response.subcontract ? [response.subcontract] : []);

                console.log('âœ… Adding workers:', subcontractsToAdd);

                subcontractsToAdd.forEach(function(subcontract) {
                    // subcontract.stepãŒæ—¢ã«step_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    const stepKey = subcontract.step.startsWith('step_') ? subcontract.step : 'step_' + subcontract.step;

                    console.log('âœ… Adding worker to step:', stepKey, subcontract);

                    // stepKeyãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
                    if (!window.processWorkers[stepKey]) {
                        window.processWorkers[stepKey] = [];
                    }

                    // æ–°ã—ã„ä½œæ¥­è€…ã‚’è¿½åŠ 
                    window.processWorkers[stepKey].push({
                        subcontractId: subcontract.id,
                        contractorId: subcontract.contractor_id,
                        contractorName: subcontract.contractor_name,
                        contractAmount: parseFloat(subcontract.contract_amount) || 0,
                        billedAmount: parseFloat(subcontract.billed_amount) || 0,
                        paymentDueDate: subcontract.payment_due_date || '',
                        paymentStatus: subcontract.payment_status || '',
                        workDescription: subcontract.work_description || '',
                        step: subcontract.step
                    });
                });

                console.log('ğŸ‘¥ Updated processWorkers:', window.processWorkers);

                // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’å†ç”Ÿæˆ
                if (typeof generateImplementationTimeline === 'function') {
                    console.log('ğŸ”„ Calling generateImplementationTimeline()');
                    generateImplementationTimeline();
                    console.log('âœ… Timeline regenerated');
                } else {
                    console.error('âŒ generateImplementationTimeline is not a function!');
                }

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                $('#subcontractForm')[0].reset();
                $('#selectedContractorDisplay').val('');
                $('#subcontractContractor').val('');
            } else {
                console.log('âš ï¸ No subcontract data in response or processWorkers not defined, reloading...');
                console.log('response.subcontract:', response.subcontract);
                console.log('window.processWorkers:', window.processWorkers);
                // responseã«subcontractãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒªãƒ­ãƒ¼ãƒ‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            }
        },
        error: function(xhr, status, error) {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON) {
                if (xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }

                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã”ã¨ã®ã‚¨ãƒ©ãƒ¼ã‚’å‡¦ç†
                if (xhr.responseJSON.errors) {
                    const errors = xhr.responseJSON.errors;
                    const errorList = [];

                    for (const field in errors) {
                        const fieldErrors = errors[field];
                        if (Array.isArray(fieldErrors)) {
                            fieldErrors.forEach(err => errorList.push(err));
                        } else {
                            errorList.push(fieldErrors);
                        }
                    }

                    if (errorList.length > 0) {
                        errorMessage = errorList.join('<br>');
                    }
                }
            } else if (xhr.responseText) {
                errorMessage = xhr.responseText;
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã«ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
            showModalError(errorMessage);

            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    });
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ç·ã‚³ã‚¹ãƒˆè‡ªå‹•è¨ˆç®—
$(document).ready(function() {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç·ã‚³ã‚¹ãƒˆè‡ªå‹•è¨ˆç®—ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼‰
    window.calculateModalTotalCost = function() {
        var material1 = parseFloat($('#subcontractMaterialCost1').val()) || 0;
        var material2 = parseFloat($('#subcontractMaterialCost2').val()) || 0;
        var material3 = parseFloat($('#subcontractMaterialCost3').val()) || 0;
        var billed = parseFloat($('#subcontractBilledAmount').val()) || 0;
        var contract = parseFloat($('#subcontractContractAmount').val()) || 0;

        // è¢«è«‹æ±‚é¡ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°å¥‘ç´„é‡‘é¡ã‚’ä½¿ç”¨
        var baseAmount = billed > 0 ? billed : contract;

        // å›ºå®šéƒ¨æè²»
        var fixedMaterial = material1 + material2 + material3;

        // å‹•çš„éƒ¨æè²»
        var dynamicMaterial = 0;
        $('#modalDynamicMaterialsContainer .row').each(function() {
            var cost = parseFloat($(this).find('.dynamic-material-cost').val()) || 0;
            dynamicMaterial += cost;
        });

        // è¿½åŠ è²»ç”¨
        var additionalCosts = 0;
        $('#modalAdditionalCostsContainer .row').each(function() {
            var cost = parseFloat($(this).find('.additional-cost-amount').val()) || 0;
            additionalCosts += cost;
        });

        var totalMaterial = fixedMaterial + dynamicMaterial;
        var totalCost = baseAmount + totalMaterial + additionalCosts;

        // ãƒ©ãƒ™ãƒ«æ›´æ–°
        if (billed > 0) {
            $('#modalCostBaseLabel').text('è«‹æ±‚é‡‘é¡');
        } else {
            $('#modalCostBaseLabel').text('å¥‘ç´„é‡‘é¡');
        }

        // é‡‘é¡ã‚’æ›´æ–°
        $('#modalMaterialTotalAmount').text(totalMaterial.toLocaleString());
        $('#modalTotalCostAmount').text(totalCost.toLocaleString());
    };

    // é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–
    $('#subcontractMaterialCost1, #subcontractMaterialCost2, #subcontractMaterialCost3, #subcontractBilledAmount, #subcontractContractAmount').on('input', function() {
        window.calculateModalTotalCost();

        // å·¥ç¨‹ã”ã¨ã®é‡‘é¡è¨­å®šã®å ´åˆã€ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®é‡‘é¡ã‚’åŒæœŸ
        const method = $('input[name="cost_allocation_method"]:checked').val();
        if (method === 'per_step' && typeof syncMainStepAmount === 'function') {
            syncMainStepAmount();
        }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ãŸã¨ãã«åˆæœŸè¨ˆç®—
    $('#subcontractModal').on('shown.bs.modal', function() {
        window.calculateModalTotalCost();

        // å·¥ç¨‹ã”ã¨ã«é‡‘é¡ã‚’è¨­å®šã™ã‚‹å ´åˆã€ä¸Šéƒ¨ã®å¥‘ç´„é‡‘é¡ã‚’ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«åæ˜ 
        const method = $('input[name="cost_allocation_method"]:checked').val();
        if (method === 'per_step' && typeof syncMainStepAmount === 'function') {
            syncMainStepAmount();
        }
    });

    // é‡‘é¡è¨­å®šæ–¹æ³•ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³å¤‰æ›´ã‚’ç›£è¦–
    $('input[name="cost_allocation_method"]').on('change', function() {
        const method = $(this).val();
        if (method === 'per_step') {
            // å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›æ¬„ã‚’ç”Ÿæˆ
            if (typeof updatePerStepAmountsInputs === 'function') {
                updatePerStepAmountsInputs();
            }
        }
    });

    // ===================================
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼šå‹•çš„è¿½åŠ è²»ç”¨ç®¡ç†
    // ===================================
    let modalAdditionalCostCounter = 0;

    window.addModalAdditionalCostRow = function() {
        modalAdditionalCostCounter++;
        const rowId = `modal_additional_cost_${modalAdditionalCostCounter}`;

        const row = $(`
            <div class="row mb-2" id="${rowId}">
                <div class="col-md-5">
                    <input type="text" class="form-control additional-cost-item" placeholder="è²»ç”¨é …ç›®å" data-row="${rowId}">
                </div>
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text">Â¥</span>
                        <input type="number" class="form-control additional-cost-amount" placeholder="0" data-row="${rowId}">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeModalAdditionalCostRow('${rowId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `);

        $('#modalAdditionalCostsContainer').append(row);
        updateModalAdditionalCostsData();

        row.find('input').on('input', function() {
            updateModalAdditionalCostsData();
            window.calculateModalTotalCost();
        });
    };

    window.removeModalAdditionalCostRow = function(rowId) {
        $(`#${rowId}`).remove();
        updateModalAdditionalCostsData();
        window.calculateModalTotalCost();
    };

    function updateModalAdditionalCostsData() {
        const costs = [];
        let totalAdditional = 0;

        $('#modalAdditionalCostsContainer .row').each(function() {
            const item = $(this).find('.additional-cost-item').val();
            const amount = parseFloat($(this).find('.additional-cost-amount').val()) || 0;

            if (item && amount > 0) {
                costs.push({item, cost: amount});
                totalAdditional += amount;
            }
        });

        $('#modalAdditionalCostsData').val(JSON.stringify(costs));
        $('#modal_additional_total_amount').text(totalAdditional.toLocaleString());

        if (totalAdditional > 0) {
            $('#modal_additional_total_display').show();
        } else {
            $('#modal_additional_total_display').hide();
        }
    }

    // ===================================
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼šå‹•çš„éƒ¨æè²»ç®¡ç†
    // ===================================
    let modalMaterialCounter = 0;

    window.addModalMaterialRow = function() {
        modalMaterialCounter++;
        const rowId = `modal_material_${modalMaterialCounter}`;

        const row = $(`
            <div class="row mb-2" id="${rowId}">
                <div class="col-md-5">
                    <input type="text" class="form-control dynamic-material-item" placeholder="éƒ¨æè²»é …ç›®å" data-row="${rowId}">
                </div>
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text">Â¥</span>
                        <input type="number" class="form-control dynamic-material-cost" placeholder="0" data-row="${rowId}">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeModalMaterialRow('${rowId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `);

        $('#modalDynamicMaterialsContainer').append(row);
        updateModalDynamicMaterialsData();

        row.find('input').on('input', function() {
            updateModalDynamicMaterialsData();
            window.calculateModalTotalCost();
        });
    };

    window.removeModalMaterialRow = function(rowId) {
        $(`#${rowId}`).remove();
        updateModalDynamicMaterialsData();
        window.calculateModalTotalCost();
    };

    function updateModalDynamicMaterialsData() {
        const materials = [];

        $('#modalDynamicMaterialsContainer .row').each(function() {
            const item = $(this).find('.dynamic-material-item').val();
            const cost = parseFloat($(this).find('.dynamic-material-cost').val()) || 0;

            if (item && cost > 0) {
                materials.push({item, cost});
            }
        });

        $('#modalDynamicMaterialsData').val(JSON.stringify(materials));
    }

    // ===================================
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ï¼šå‡ºé‡‘äºˆå®šæ—¥è¨ˆç®—
    // ===================================

    // å‡ºé‡‘äºˆå®šæ—¥ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
    function calculatePaymentDueDateForModal(contractDate, closingDay, paymentOffsetMonths, paymentDay) {
        console.log('ğŸ§® calculatePaymentDueDateForModal é–‹å§‹');
        console.log('  - åŸºæº–æ—¥:', contractDate);
        console.log('  - ç· æ—¥:', closingDay);
        console.log('  - æ”¯æ‰•æœˆã‚ªãƒ•ã‚»ãƒƒãƒˆ:', paymentOffsetMonths);
        console.log('  - æ”¯æ‰•æ—¥:', paymentDay);

        if (!contractDate || closingDay === null || paymentOffsetMonths === null || paymentDay === null) {
            console.error('  âŒ å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
            return null;
        }

        const date = new Date(contractDate);
        console.log('  - åŸºæº–æ—¥ã®Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ:', date);

        // ç· æ—¥ã‚’åŸºæº–ã«ã—ã¦ã€ã©ã®æœˆã®ç· ã‚ã«å«ã¾ã‚Œã‚‹ã‹ã‚’åˆ¤å®š
        let closingMonth;
        if (date.getDate() <= closingDay) {
            // å½“æœˆç· ã‚
            closingMonth = new Date(date.getFullYear(), date.getMonth(), 1);
            console.log('  - å½“æœˆç· ã‚:', closingMonth);
        } else {
            // ç¿Œæœˆç· ã‚
            closingMonth = new Date(date.getFullYear(), date.getMonth() + 1, 1);
            console.log('  - ç¿Œæœˆç· ã‚:', closingMonth);
        }

        // æ”¯æ‰•ã„æœˆã‚’è¨ˆç®—ï¼ˆç· ã‚æœˆ + payment_offset_monthsï¼‰
        const paymentMonth = new Date(closingMonth.getFullYear(), closingMonth.getMonth() + paymentOffsetMonths, 1);
        console.log('  - æ”¯æ‰•ã„æœˆ:', paymentMonth);

        // æ”¯æ‰•æ—¥ã‚’è¨­å®š
        let paymentDueDate;
        try {
            paymentDueDate = new Date(paymentMonth.getFullYear(), paymentMonth.getMonth(), paymentDay);
            console.log('  - è¨ˆç®—ã•ã‚ŒãŸæ”¯æ‰•æ—¥:', paymentDueDate);

            // 31æ—¥ãŒå­˜åœ¨ã—ãªã„æœˆã®å ´åˆã¯æœˆæœ«æ—¥ã«ã™ã‚‹
            if (paymentDueDate.getMonth() !== paymentMonth.getMonth()) {
                paymentDueDate = new Date(paymentMonth.getFullYear(), paymentMonth.getMonth() + 1, 0);
                console.log('  - æœˆæœ«æ—¥ã«èª¿æ•´:', paymentDueDate);
            }
        } catch (e) {
            console.error('  âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', e);
            // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯æœˆæœ«æ—¥ã«ã™ã‚‹
            paymentDueDate = new Date(paymentMonth.getFullYear(), paymentMonth.getMonth() + 1, 0);
        }

        return paymentDueDate;
    }

    // æ¥­è€…é¸æŠæ™‚ã«æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è¡¨ç¤º
    $(document).on('change', '#subcontractContractor', function() {
        const contractorId = $(this).val();
        if (contractorId && contractorsData[contractorId]) {
            const contractor = contractorsData[contractorId];
            const { closing_day, payment_offset_months, payment_day, payment_cycle } = contractor;

            // ãƒ©ãƒ™ãƒ«å®šç¾©
            const paymentCycleLabels = {
                'monthly': 'æœˆ1å›',
                'bimonthly': 'æœˆ2å›',
                'weekly': 'é€±1å›',
                'custom': 'ãã®ä»–'
            };
            const monthLabels = {
                0: 'å½“æœˆ',
                1: 'ç¿Œæœˆ',
                2: 'ç¿Œã€…æœˆ',
                3: '3ãƒ¶æœˆå¾Œ'
            };

            if (closing_day !== null && payment_offset_months !== null && payment_day !== null) {
                // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«
                const cycleLabel = paymentCycleLabels[payment_cycle] || 'æœˆ1å›';
                $('#modalDisplayPaymentCycle').text(cycleLabel);

                // ç· ã‚æ—¥
                const closingDayText = closing_day + 'æ—¥' + (closing_day == 31 ? ' (æœˆæœ«)' : '');
                $('#modalDisplayClosingDay').text(closingDayText);

                // æ”¯æ‰•æœˆ
                const offsetLabel = monthLabels[payment_offset_months] || payment_offset_months + 'ãƒ¶æœˆå¾Œ';
                $('#modalDisplayPaymentOffsetMonths').text(offsetLabel);

                // æ”¯æ‰•æ—¥
                const paymentDayText = payment_day + 'æ—¥';
                $('#modalDisplayPaymentDay').text(paymentDayText);

                $('#contractorPaymentInfo').show();
                // è¨ˆç®—ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                $('#modalCalculatePaymentDueDate').prop('disabled', false);
            } else {
                $('#contractorPaymentInfo').hide();
                // è¨ˆç®—ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãªã—ï¼‰
                $('#modalCalculatePaymentDueDate').prop('disabled', true);
            }
        } else {
            $('#contractorPaymentInfo').hide();
            // è¨ˆç®—ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ¥­è€…æœªé¸æŠï¼‰
            $('#modalCalculatePaymentDueDate').prop('disabled', true);
        }
    });

    // ã€Œä»–ã®å·¥ç¨‹ã«ã‚‚è¿½åŠ ã€ã§é¸æŠã•ã‚ŒãŸå·¥ç¨‹ã®ä¸­ã§æœ€ã‚‚é…ã„æ—¥ä»˜ã®å·¥ç¨‹ã‚’åŸºæº–æ—¥ã¨ã—ã¦é¸æŠ
    window.syncBaseDateCheckboxes = function() {
        console.log('ğŸ”„ åŸºæº–æ—¥ã‚’è‡ªå‹•é¸æŠé–‹å§‹');

        // ã¾ãšã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
        const baseDateSelect = $('#modalBaseDateType');
        if (!baseDateSelect.length) {
            console.error('âŒ åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•°ã‚’ç¢ºèª
        const optionCount = baseDateSelect.find('option').length;
        console.log('ğŸ“Š ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ç¾åœ¨ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•°:', optionCount);

        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå°‘ãªã„å ´åˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®2ã¤ã®ã¿ï¼‰ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†ç”Ÿæˆ
        if (optionCount <= 2) {
            console.log('âš ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå°‘ãªã„ãŸã‚ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†ç”Ÿæˆã—ã¾ã™');
            if (typeof window.populateModalBaseDateOptions === 'function') {
                window.populateModalBaseDateOptions(null);
            }
        }

        // ã€Œä»–ã®å·¥ç¨‹ã«ã‚‚è¿½åŠ ã€ã§ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å·¥ç¨‹ã‚’å–å¾—
        const selectedSteps = [];
        $('.additional-step-checkbox:checked').each(function() {
            selectedSteps.push($(this).val());
        });

        console.log('ğŸ“‹ é¸æŠã•ã‚ŒãŸå·¥ç¨‹:', selectedSteps);

        if (selectedSteps.length === 0) {
            console.log('âš ï¸ é¸æŠã•ã‚ŒãŸå·¥ç¨‹ãŒã‚ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®Œå·¥ã‚’é¸æŠ');
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œå®Œå·¥ã€ã‚’é¸æŠï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            if (baseDateSelect.find('option[value="step_completion"]').length) {
                baseDateSelect.val('step_completion');
                if (typeof updateModalBaseDate === 'function') {
                    updateModalBaseDate();
                }
                console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®Œå·¥ã‚’é¸æŠ');
            }
            return;
        }

        // å„å·¥ç¨‹ã®æ—¥ä»˜ã‚’å–å¾—
        const stepDates = [];
        selectedSteps.forEach(stepValue => {
            const stepKey = stepValue.replace('step_', '');
            const stepDateInput = document.querySelector(`input[name="step_${stepKey}_scheduled_date"]`);

            console.log(`ğŸ” å·¥ç¨‹ ${stepKey} ã®æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:`, stepDateInput ? 'ã‚ã‚Š' : 'ãªã—', stepDateInput?.value || '(æœªå…¥åŠ›)');

            if (stepDateInput && stepDateInput.value) {
                stepDates.push({
                    stepValue: stepValue,
                    stepKey: stepKey,
                    date: new Date(stepDateInput.value),
                    dateString: stepDateInput.value
                });
                console.log('ğŸ“… å·¥ç¨‹æ—¥ä»˜ã‚’è¿½åŠ :', stepValue, stepDateInput.value);
            }
        });

        console.log('ğŸ“Š åé›†ã—ãŸæ—¥ä»˜:', stepDates);

        // æœ€ã‚‚é…ã„æ—¥ä»˜ã‚’è¦‹ã¤ã‘ã‚‹
        if (stepDates.length > 0) {
            // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
            stepDates.sort((a, b) => b.date - a.date);
            const latestStep = stepDates[0];

            console.log('âœ… æœ€ã‚‚é…ã„å·¥ç¨‹:', latestStep.stepValue, latestStep.dateString);

            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è©²å½“ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
            const optionExists = baseDateSelect.find(`option[value="${latestStep.stepValue}"]`).length > 0;
            console.log(`ğŸ” ã‚ªãƒ—ã‚·ãƒ§ãƒ³ "${latestStep.stepValue}" ã®å­˜åœ¨:`, optionExists);

            if (optionExists) {
                baseDateSelect.val(latestStep.stepValue);
                console.log('âœ… åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¨­å®š:', latestStep.stepValue);

                // åŸºæº–æ—¥ã®è¡¨ç¤ºã‚’æ›´æ–°
                if (typeof updateModalBaseDate === 'function') {
                    updateModalBaseDate();
                }
            } else {
                console.warn('âš ï¸ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆ©ç”¨å¯èƒ½ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³:', baseDateSelect.find('option').map(function() { return $(this).val(); }).get());
            }
        } else {
            console.log('âš ï¸ æ—¥ä»˜ãŒå…¥åŠ›ã•ã‚ŒãŸå·¥ç¨‹ãŒã‚ã‚Šã¾ã›ã‚“ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®Œå·¥ã‚’é¸æŠ');
            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œå®Œå·¥ã€ã‚’é¸æŠï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
            if (baseDateSelect.find('option[value="step_completion"]').length) {
                baseDateSelect.val('step_completion');
                if (typeof updateModalBaseDate === 'function') {
                    updateModalBaseDate();
                }
                console.log('âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å®Œå·¥ã‚’é¸æŠ');
            }
        }

        console.log('âœ… åŸºæº–æ—¥è‡ªå‹•é¸æŠå®Œäº† - æœ€çµ‚é¸æŠå€¤:', baseDateSelect.val());
    };

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
    window.populateModalBaseDateOptions = function(currentStepKey) {
        console.log('ğŸ”§ populateModalBaseDateOptions é–‹å§‹', { currentStepKey });
        const baseDateSelect = $('#modalBaseDateType');
        console.log('ğŸ“ baseDateSelect è¦ç´ :', baseDateSelect.length, baseDateSelect);
        if (!baseDateSelect.length) {
            console.error('âŒ åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - DOMæœªæ§‹ç¯‰ã®å¯èƒ½æ€§');
            // DOMãŒæ§‹ç¯‰ã•ã‚Œã‚‹ã¾ã§å¾…æ©Ÿã—ã¦å†è©¦è¡Œ
            setTimeout(function() {
                console.log('ğŸ”„ å†è©¦è¡Œ: ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ¢ã—ã¦ã„ã¾ã™...');
                const retrySelect = $('#modalBaseDateType');
                if (retrySelect.length) {
                    console.log('âœ… å†è©¦è¡ŒæˆåŠŸ - ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ');
                    window.populateModalBaseDateOptions(currentStepKey);
                } else {
                    console.error('âŒ å†è©¦è¡Œå¤±æ•— - ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            }, 200);
            return;
        }

        // ç¾åœ¨ã®é¸æŠå€¤ã‚’ä¿å­˜
        const currentValue = baseDateSelect.val();

        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ä»»æ„æ—¥ã¯æ®‹ã™ï¼‰
        baseDateSelect.find('option').each(function() {
            const val = $(this).val();
            if (val !== '' && val !== 'contract' && val !== 'custom' && !val.startsWith('step_')) {
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ä»¥å¤–ã¯ä¸€æ—¦å‰Šé™¤å¯¾è±¡ï¼ˆå¾Œã§å†è¿½åŠ ï¼‰
            } else if (val.startsWith('step_')) {
                // å·¥ç¨‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤
                $(this).remove();
            }
        });

        // å¥‘ç´„æ—¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚‚å‰Šé™¤ï¼ˆå¾Œã§å†è¿½åŠ ï¼‰
        baseDateSelect.find('option[value="contract"]').remove();

        console.log('ğŸ“ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å·¥ç¨‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');

        // å¥‘ç´„æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ ï¼ˆä»»æ„æ—¥ã®å‰ã«æŒ¿å…¥ï¼‰
        const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
        const customOption = baseDateSelect.find('option[value="custom"]');
        if (contractDateInput) {
            if (customOption.length) {
                customOption.before('<option value="contract">å¥‘ç´„æ—¥</option>');
            } else {
                baseDateSelect.append('<option value="contract">å¥‘ç´„æ—¥</option>');
            }
        }

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ã®å…¨å·¥ç¨‹ã‚’DOMã‹ã‚‰ç›´æ¥å–å¾—
        const activeSteps = [];

        console.log('ğŸ” å·¥ç¨‹æ¤œå‡ºã‚’é–‹å§‹...');

        // ãƒ‡ãƒãƒƒã‚°: ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚³ãƒ³ãƒ†ãƒŠã®å­˜åœ¨ç¢ºèª
        const formActiveStepsContainer = $('#formActiveSteps');
        console.log(`ğŸ“¦ #formActiveSteps ã®å­˜åœ¨: ${formActiveStepsContainer.length > 0}`);
        if (formActiveStepsContainer.length > 0) {
            console.log(`ğŸ“¦ #formActiveSteps ã®å­è¦ç´ æ•°: ${formActiveStepsContainer.children().length}`);
            console.log(`ğŸ“¦ #formActiveSteps ã® HTML (æœ€åˆã®500æ–‡å­—):`, formActiveStepsContainer.html().substring(0, 500));
        }

        // ãƒ‡ãƒãƒƒã‚°: ã™ã¹ã¦ã®inputãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
        console.log('ğŸ“‹ ãƒšãƒ¼ã‚¸å†…ã®å…¨inputãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ (type=date):');
        $('input[type="date"]').each(function(index) {
            const name = $(this).attr('name');
            const id = $(this).attr('id');
            const value = $(this).val();
            console.log(`  ${index + 1}. name="${name}", id="${id}", value="${value}"`);
        });

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ã®å·¥ç¨‹ã‚’å–å¾—
        console.log('ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ã®å·¥ç¨‹ã‚’æ¤œç´¢ä¸­...');
        const progressSteps = $('#formActiveSteps .progress-step');
        console.log(`  è¦‹ã¤ã‹ã£ãŸ .progress-step è¦ç´ æ•°: ${progressSteps.length}`);

        progressSteps.each(function(index) {
            const stepKey = $(this).data('step');
            const stepName = $(this).find('.progress-step-label').text().trim();
            console.log(`  ${index + 1}. æ¤œå‡º: stepKey="${stepKey}", stepName="${stepName}"`);
            if (stepKey && stepName) {
                activeSteps.push({key: stepKey, name: stepName});
            }
        });

        // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ã®ã™ã¹ã¦ã®æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰å·¥ç¨‹ã‚’å–å¾—
        console.log('ğŸ” ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å·¥ç¨‹ã®æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œç´¢ä¸­...');

        // ã‚ˆã‚Šç¢ºå®Ÿãªæ–¹æ³•: .step-date-inputã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨
        const dateFields = $('#formActiveSteps .step-date-input');
        console.log(`  è¦‹ã¤ã‹ã£ãŸæ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°: ${dateFields.length}`);

        dateFields.each(function(index) {
            const name = $(this).attr('name');
            const value = $(this).val();
            console.log(`  ${index + 1}. ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ name="${name}", value="${value}"`);

            // "step_survey_scheduled_date" ã‹ã‚‰ "survey" ã‚’æŠ½å‡º
            const match = name.match(/^step_(.+)_scheduled_date$/);
            if (match) {
                const stepKey = match[1];

                // å¯¾å¿œã™ã‚‹ãƒ©ãƒ™ãƒ«ã‚’æ¢ã™ï¼ˆè¤‡æ•°ã®æ–¹æ³•ã‚’è©¦ã™ï¼‰
                let stepLabel = '';

                // æ–¹æ³•1: labelã‚¿ã‚°ã®forå±æ€§
                const labelByFor = $(`label[for="${$(this).attr('id')}"]`);
                if (labelByFor.length) {
                    stepLabel = labelByFor.text().trim();
                    console.log(`    ãƒ©ãƒ™ãƒ«å–å¾—æˆåŠŸ (æ–¹æ³•1 - forå±æ€§): "${stepLabel}"`);
                }

                // æ–¹æ³•2: è¦ªè¦ç´ å†…ã®ãƒ©ãƒ™ãƒ«ç³»è¦ç´ 
                if (!stepLabel) {
                    const parentLabel = $(this).closest('.step-card, .card, .progress-step, .mb-3, .col-md-6')
                                              .find('.step-label, .progress-step-label, h6, strong, label')
                                              .first()
                                              .text()
                                              .trim();
                    if (parentLabel) {
                        stepLabel = parentLabel;
                        console.log(`    ãƒ©ãƒ™ãƒ«å–å¾—æˆåŠŸ (æ–¹æ³•2 - è¦ªè¦ç´ ): "${stepLabel}"`);
                    }
                }

                // æ–¹æ³•3: stepKeyã‚’ãã®ã¾ã¾ä½¿ç”¨
                if (!stepLabel) {
                    stepLabel = stepKey;
                    console.log(`    ãƒ©ãƒ™ãƒ«å–å¾—å¤±æ•— - stepKeyã‚’ä½¿ç”¨: "${stepLabel}"`);
                }

                // æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿è¿½åŠ 
                if (!activeSteps.find(s => s.key === stepKey)) {
                    activeSteps.push({key: stepKey, name: stepLabel});
                    console.log(`  âœ… å·¥ç¨‹è¿½åŠ : key="${stepKey}", name="${stepLabel}"`);
                } else {
                    console.log(`  â­ï¸  å·¥ç¨‹ã‚¹ã‚­ãƒƒãƒ— (æ—¢å­˜): key="${stepKey}"`);
                }
            } else {
                console.log(`  âš ï¸  ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒå¤±æ•—: name="${name}"`);
            }
        });

        console.log('ğŸ“Š æ¤œå‡ºã•ã‚ŒãŸå…¨å·¥ç¨‹:', activeSteps);

        // é‡è¤‡ã‚’å‰Šé™¤
        const uniqueSteps = [];
        const seenKeys = new Set();
        activeSteps.forEach(step => {
            if (!seenKeys.has(step.key)) {
                seenKeys.add(step.key);
                uniqueSteps.push(step);
            }
        });

        // å·¥ç¨‹ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ ï¼ˆä»»æ„æ—¥ã®å‰ã«æŒ¿å…¥ï¼‰
        console.log('ğŸ“‹ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ ã™ã‚‹å·¥ç¨‹:', uniqueSteps);
        const customOptionForSteps = baseDateSelect.find('option[value="custom"]');
        console.log(`ğŸ” "ä»»æ„æ—¥"ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å­˜åœ¨: ${customOptionForSteps.length > 0}`);

        if (uniqueSteps.length === 0) {
            console.warn('âš ï¸ è¿½åŠ ã™ã‚‹å·¥ç¨‹ãŒã‚ã‚Šã¾ã›ã‚“ï¼');
        } else {
            uniqueSteps.forEach((step, index) => {
                const optionHtml = `<option value="step_${step.key}">${step.name}</option>`;
                console.log(`  ${index + 1}. è¿½åŠ : ${optionHtml}`);

                if (customOptionForSteps.length) {
                    customOptionForSteps.before(optionHtml);
                } else {
                    baseDateSelect.append(optionHtml);
                }
            });
            console.log('âœ… å·¥ç¨‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', uniqueSteps.length, 'ä»¶');
        }

        // å·¥ç¨‹åãƒãƒƒãƒ—ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆupdateModalBaseDateã§ä½¿ç”¨ï¼‰
        // ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãªã—ã®ã‚­ãƒ¼ã§ä¿å­˜
        if (!window.stepNameMap) {
            window.stepNameMap = {};
        }
        uniqueSteps.forEach(step => {
            const keyWithoutPrefix = step.key.startsWith('step_') ? step.key.replace('step_', '') : step.key;
            window.stepNameMap[keyWithoutPrefix] = step.name;
        });

        // æœ€çµ‚ç¢ºèªï¼šãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•°ã‚’ç¢ºèª
        const totalOptions = baseDateSelect.find('option').length;
        console.log('ğŸ“Š ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ç·ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ•°:', totalOptions);
        console.log('ğŸ“‹ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®å…¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³:', baseDateSelect.html());

        // disabledå±æ€§ã‚’æ˜ç¤ºçš„ã«å‰Šé™¤ï¼ˆå¿µã®ãŸã‚ï¼‰
        baseDateSelect.prop('disabled', false);
        console.log('âœ… ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æœ‰åŠ¹åŒ–ã—ã¾ã—ãŸ');

        // ãƒ‡ãƒãƒƒã‚°ç”¨: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        if (typeof toastr !== 'undefined') {
            if (uniqueSteps.length > 0) {
                toastr.info(`åŸºæº–æ—¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã—ã¾ã—ãŸ (${uniqueSteps.length}ä»¶ã®å·¥ç¨‹ã‚’æ¤œå‡º)`);
            } else {
                toastr.warning('ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–ã§å·¥ç¨‹ã®äºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            }
        }

        // ä»¥å‰ã®é¸æŠå€¤ã‚’å¾©å…ƒã€ã¾ãŸã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œä»–ã®å·¥ç¨‹ã«ã‚‚è¿½åŠ ã€ã®æœ€ã‚‚é…ã„å·¥ç¨‹ã‚’é¸æŠ
        if (currentValue) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä»¥å‰ã«é¸æŠã—ãŸå€¤ã‚’å„ªå…ˆ
            console.log('ğŸ” åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³: ä»¥å‰ã®é¸æŠå€¤ã‚’å¾©å…ƒ', currentValue);
            if (baseDateSelect.find(`option[value="${currentValue}"]`).length) {
                baseDateSelect.val(currentValue);
                updateModalBaseDate();
                console.log('âœ… åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³: ä»¥å‰ã®å€¤ã‚’å¾©å…ƒ', currentValue);
            }
        } else {
            // ã€Œä»–ã®å·¥ç¨‹ã«ã‚‚è¿½åŠ ã€ã§é¸æŠã•ã‚ŒãŸå·¥ç¨‹ã®ä¸­ã§æœ€ã‚‚é…ã„æ—¥ä»˜ã®å·¥ç¨‹ã‚’é¸æŠ
            syncBaseDateCheckboxes();
        }
    };

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®åŸºæº–æ—¥è¡¨ç¤ºã‚’æ›´æ–°
    window.updateModalBaseDate = function() {
        console.log('ğŸ“… updateModalBaseDate() called');

        const baseDateType = $('#modalBaseDateType').val();
        const customDateInput = $('#modalReferenceDate');
        const baseDateDisplay = $('#modalBaseDateDisplay');

        console.log('  - baseDateType:', baseDateType);
        console.log('  - customDateInput element:', customDateInput.length);

        // ä»»æ„æ—¥é¸æŠæ™‚ã®ã¿ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜å…¥åŠ›ã‚’è¡¨ç¤º
        if (baseDateType === 'custom') {
            customDateInput.show();
        } else {
            customDateInput.hide();
        }

        // åŸºæº–æ—¥ã‚’å–å¾—ã—ã¦è¡¨ç¤º
        let baseDate = null;
        let baseDateText = 'æœªé¸æŠ';

        if (!baseDateType) {
            baseDateText = 'æœªé¸æŠ';
            console.log('  - åŸºæº–æ—¥æœªé¸æŠ');
        } else if (baseDateType === 'contract') {
            const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
            if (contractDateInput && contractDateInput.value) {
                baseDate = contractDateInput.value;
                baseDateText = baseDate + ' (å¥‘ç´„æ—¥)';
                customDateInput.val(baseDate);
                console.log('  - å¥‘ç´„æ—¥ã‚’åŸºæº–æ—¥ã«è¨­å®š:', baseDate);
            } else {
                baseDateText = 'æœªå…¥åŠ› (å¥‘ç´„æ—¥)';
                console.log('  - å¥‘ç´„æ—¥ãŒæœªå…¥åŠ›');
            }
        } else if (baseDateType.startsWith('step_')) {
            const stepKey = baseDateType.replace('step_', '');
            const stepDateInput = document.querySelector(`input[name="step_${stepKey}_scheduled_date"]`);

            // å‹•çš„ã«å·¥ç¨‹åã‚’å–å¾—
            const stepName = (window.stepNameMap && window.stepNameMap[stepKey]) || stepKey;

            console.log('  - å·¥ç¨‹é¸æŠ:', stepKey, stepName);
            console.log('  - å·¥ç¨‹ã®æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', stepDateInput);
            console.log('  - å·¥ç¨‹ã®æ—¥ä»˜å€¤:', stepDateInput ? stepDateInput.value : 'null');

            if (stepDateInput && stepDateInput.value) {
                baseDate = stepDateInput.value;
                baseDateText = baseDate + ' (' + stepName + ')';
                customDateInput.val(baseDate);
                console.log('  âœ… å·¥ç¨‹ã®æ—¥ä»˜ã‚’åŸºæº–æ—¥ã«è¨­å®š:', baseDate);
            } else {
                baseDateText = 'æœªå…¥åŠ› (' + stepName + ')';
                console.log('  âŒ å·¥ç¨‹ã®æ—¥ä»˜ãŒæœªå…¥åŠ›');
            }
        } else if (baseDateType === 'custom') {
            if (customDateInput.val()) {
                baseDate = customDateInput.val();
                baseDateText = baseDate + ' (ä»»æ„æ—¥)';
                console.log('  - ä»»æ„æ—¥ã‚’åŸºæº–æ—¥ã«è¨­å®š:', baseDate);
            } else {
                baseDateText = 'æœªé¸æŠ (ä»»æ„æ—¥)';
                console.log('  - ä»»æ„æ—¥ãŒæœªé¸æŠ');
            }
        }

        baseDateDisplay.text(baseDateText);
        console.log('  - æœ€çµ‚åŸºæº–æ—¥è¡¨ç¤º:', baseDateText);
        console.log('  - modalReferenceDate value:', customDateInput.val());
    };

    // å‡ºé‡‘äºˆå®šæ—¥è¨ˆç®—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#modalCalculatePaymentDueDate').on('click', function() {
        console.log('ğŸ’° å‡ºé‡‘äºˆå®šæ—¥è¨ˆç®—ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');

        // å‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        hideModalPaymentError();

        const contractorId = $('#subcontractContractor').val();
        console.log('  - æ¥­è€…ID:', contractorId);

        // åŸºæº–æ—¥ã‚’å–å¾—ï¼ˆhidden input modalReferenceDateã‹ã‚‰ï¼‰
        const referenceDate = $('#modalReferenceDate').val();
        console.log('  - åŸºæº–æ—¥ (modalReferenceDate):', referenceDate);

        const baseDateType = $('#modalBaseDateType').val();
        console.log('  - åŸºæº–æ—¥ç¨®é¡ (modalBaseDateType):', baseDateType);

        // åŸºæº–æ—¥ãŒæœªå…¥åŠ›ã®å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
        if (!referenceDate) {
            console.error('âŒ åŸºæº–æ—¥ãŒæœªå…¥åŠ›ã§ã™');
            showModalPaymentError('åŸºæº–æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        if (!contractorId) {
            console.error('âŒ æ¥­è€…ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
            showModalPaymentError('æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
            return;
        }

        const contractor = contractorsData[contractorId];
        console.log('  - æ¥­è€…ãƒ‡ãƒ¼ã‚¿:', contractor);

        if (!contractor) {
            console.error('âŒ æ¥­è€…ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            showModalPaymentError('æ¥­è€…ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        const { closing_day, payment_offset_months, payment_day } = contractor;
        console.log('  - ç· æ—¥:', closing_day);
        console.log('  - æ”¯æ‰•æœˆã‚ªãƒ•ã‚»ãƒƒãƒˆ:', payment_offset_months);
        console.log('  - æ”¯æ‰•æ—¥:', payment_day);

        // å‡ºé‡‘äºˆå®šæ—¥ã‚’è¨ˆç®—
        console.log('ğŸ“Š calculatePaymentDueDateForModal ã‚’å‘¼ã³å‡ºã—ã¾ã™');
        const paymentDueDate = calculatePaymentDueDateForModal(referenceDate, closing_day, payment_offset_months, payment_day);
        console.log('  - è¨ˆç®—çµæœ:', paymentDueDate);

        if (paymentDueDate) {
            // YYYY-MM-DDå½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã§ï¼‰
            const year = paymentDueDate.getFullYear();
            const month = String(paymentDueDate.getMonth() + 1).padStart(2, '0');
            const day = String(paymentDueDate.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            console.log('  - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¸ˆã¿æ—¥ä»˜:', formattedDate);

            // å‡ºé‡‘äºˆå®šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•å…¥åŠ›
            $('#subcontractPaymentDueDate').val(formattedDate);
            console.log('âœ… å‡ºé‡‘äºˆå®šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®šã—ã¾ã—ãŸ');

            // æˆåŠŸé€šçŸ¥
            const displayDate = `${year}å¹´${paymentDueDate.getMonth() + 1}æœˆ${paymentDueDate.getDate()}æ—¥`;
            if (typeof toastr !== 'undefined') {
                toastr.success(`å‡ºé‡‘äºˆå®šæ—¥ã‚’ ${displayDate} ã«è¨­å®šã—ã¾ã—ãŸ`);
            }
        } else {
            console.error('âŒ å‡ºé‡‘äºˆå®šæ—¥ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            showModalPaymentError('å‡ºé‡‘äºˆå®šæ—¥ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    });

    // ãƒãƒƒãƒ—ã‚ªãƒ¼ãƒãƒ¼ã®åˆæœŸåŒ–ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®è¦ç´ ç”¨ï¼‰
    $('#subcontractModal').on('shown.bs.modal', function() {
        $('[data-bs-toggle="popover"]').popover();
    });
});

// ========================================
// ä¸‹æ›¸ãè‡ªå‹•ä¿å­˜æ©Ÿèƒ½
// ========================================
let autoSaveTimer = null;
// formChangedã¯æ—¢ã«ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å®£è¨€æ¸ˆã¿ï¼ˆ2409è¡Œç›®ï¼‰
let isAutoSaving = false;

// ãƒ•ã‚©ãƒ¼ãƒ ã®å¤‰æ›´ã‚’æ¤œçŸ¥
$(document).ready(function() {
    $('#projectForm input, #projectForm select, #projectForm textarea').on('change input', function() {
        formChanged = true;
        updateAutoSaveStatus('å¤‰æ›´ã‚’æ¤œå‡ºã—ã¾ã—ãŸ', 'warning');
    });

    // 30ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜
    setInterval(function() {
        if (formChanged && !isAutoSaving) {
            autoSaveDraft();
        }
    }, 30000);
});

// è‡ªå‹•ä¿å­˜ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
function updateAutoSaveStatus(message, type) {
    const statusElement = $('#autoSaveStatus');
    let iconClass = 'fas fa-circle';
    let textClass = 'text-muted';

    if (type === 'saving') {
        iconClass = 'fas fa-spinner fa-spin';
        textClass = 'text-primary';
    } else if (type === 'success') {
        iconClass = 'fas fa-check-circle';
        textClass = 'text-success';
    } else if (type === 'warning') {
        iconClass = 'fas fa-exclamation-circle';
        textClass = 'text-warning';
    } else if (type === 'error') {
        iconClass = 'fas fa-times-circle';
        textClass = 'text-danger';
    }

    statusElement.html(`<i class="${iconClass} ${textClass}"></i> ${message}`);
}

// è‡ªå‹•ä¿å­˜å®Ÿè¡Œ
function autoSaveDraft() {
    if (isAutoSaving) return;

    isAutoSaving = true;
    updateAutoSaveStatus('è‡ªå‹•ä¿å­˜ä¸­...', 'saving');

    const formData = new FormData($('#projectForm')[0]);
    // hidden inputã‹ã‚‰ç¾åœ¨ã®project_idã‚’å–å¾—ï¼ˆå‹•çš„ã«æ›´æ–°ã•ã‚Œã‚‹ï¼‰
    const currentProjectId = $('input[name="project_id"]').val();
    const saveUrl = currentProjectId ?
        "{% url 'order_management:project_save_as_draft_edit' 0 %}".replace('0', currentProjectId) :
        "{% url 'order_management:project_save_as_draft' %}";

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ 
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(saveUrl, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            formChanged = false;
            const now = new Date(data.updated_at);
            const timeStr = now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
            updateAutoSaveStatus(`è‡ªå‹•ä¿å­˜å®Œäº† (${timeStr})`, 'success');

            // æ–°è¦ä½œæˆã®å ´åˆã€project_idã‚’æ›´æ–°
            if (!currentProjectId && data.project_id) {
                // hidden inputã«project_idã‚’è¨­å®š
                $('input[name="project_id"]').val(data.project_id);

                // URLã‚’æ›´æ–°ï¼ˆãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
                const newUrl = `/orders/${data.project_id}/update/`;
                window.history.replaceState({}, '', newUrl);

                console.log('âœ… Project ID updated:', data.project_id);
            }
        } else {
            updateAutoSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
            console.error('Auto-save error:', data.error);
        }
    })
    .catch(error => {
        updateAutoSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
        console.error('Auto-save error:', error);
    })
    .finally(() => {
        isAutoSaving = false;
    });
}

// æ‰‹å‹•ã§ä¸‹æ›¸ãä¿å­˜
window.saveDraft = function() {
    if (isAutoSaving) {
        toastr.info('ä¿å­˜å‡¦ç†ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
    }

    isAutoSaving = true;
    updateAutoSaveStatus('ä¿å­˜ä¸­...', 'saving');

    const formData = new FormData($('#projectForm')[0]);
    const projectId = "{% if project %}{{ project.pk }}{% endif %}";
    const saveUrl = projectId ?
        "{% url 'order_management:project_save_as_draft_edit' 0 %}".replace('0', projectId) :
        "{% url 'order_management:project_save_as_draft' %}";

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’è¿½åŠ 
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch(saveUrl, {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            formChanged = false;
            const now = new Date(data.updated_at);
            const timeStr = now.toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'});
            updateAutoSaveStatus(`ä¸‹æ›¸ãä¿å­˜å®Œäº† (${timeStr})`, 'success');
            toastr.success('ä¸‹æ›¸ãã¨ã—ã¦ä¿å­˜ã—ã¾ã—ãŸ');

            // æ–°è¦ä½œæˆå¾Œã€ä¸‹æ›¸ãä¸€è¦§ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
            // window.location.href = "{% url 'order_management:project_draft_list' %}";
        } else {
            updateAutoSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
            toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
        }
    })
    .catch(error => {
        updateAutoSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
        toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        console.error('Save draft error:', error);
    })
    .finally(() => {
        isAutoSaving = false;
    });
};

</script>

<!-- ========================================
     ä¸‹è«‹ã‘ç®¡ç†ãƒ‘ãƒãƒ«ï¼ˆPhase 1.2ã§è¿½åŠ ï¼‰
     ======================================== -->
{# å¤ã„contractor_management_panel.htmlã¯ç„¡åŠ¹åŒ– - project_form.htmlå†…ã®æ–°ã—ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨ #}
{# {% include 'order_management/includes/contractor_management_panel.html' %} #}
{# contractor_management_panel_script.htmlã¯å¤ã„ãŸã‚ç„¡åŠ¹åŒ– - project_form.htmlå†…ã®æ–°ã—ã„é–¢æ•°ã‚’ä½¿ç”¨ #}
{# {% include 'order_management/includes/contractor_management_panel_script.html' %} #}

{% endblock %}
