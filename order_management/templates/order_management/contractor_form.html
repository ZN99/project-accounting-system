{% extends "order_management/base.html" %}
{% load static %}

{% block title %}
{% if contractor %}
業者情報編集 - {{ contractor.name }} - 建築派遣管理システム
{% else %}
{{ page_title }} - 建築派遣管理システム
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .form-card {
        border-radius: 10px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        border: none;
    }

    .form-header {
        border-radius: 10px 10px 0 0;
        padding: 20px;
        margin: 0;
        color: white;
    }

    .external-header {
        background: linear-gradient(135deg, #42a5f5 0%, #1e88e5 100%);
    }
    .supplier-header {
        background: linear-gradient(135deg, #ffa726 0%, #ff9800 100%);
    }
    .receiving-header {
        background: linear-gradient(135deg, #66bb6a 0%, #43a047 100%);
    }
    .general-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .form-control, .form-select, .form-check-input {
        border-radius: 0.375rem;
        border: 1px solid #ddd;
        transition: all 0.2s;
    }

    .form-control:focus, .form-select:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }

    .form-label {
        font-weight: 500;
        color: #495057;
        margin-bottom: 8px;
    }

    .form-check-label {
        font-weight: 500;
        color: #495057;
    }

    .required-asterisk {
        color: #dc3545;
        font-weight: bold;
    }

    .btn-save {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        border: none;
        padding: 12px 30px;
        font-weight: 600;
        border-radius: 8px;
        transition: all 0.2s;
    }

    .btn-save:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
    }

    /* ドラッグアンドドロップ用スタイル */
    .sortable-ghost {
        opacity: 0.4;
        background: #f8f9fa;
    }

    .drag-handle {
        cursor: move;
        transition: color 0.2s;
    }

    .drag-handle:hover {
        color: #667eea !important;
    }

    .list-group-item {
        transition: background-color 0.2s;
    }

    .list-group-item:hover .drag-handle {
        color: #667eea !important;
    }

</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">

    {% if contractor %}
    <!-- 編集モード: ヘッダー -->
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
        <h1 class="h2">
            <i class="fas fa-edit me-2"></i>業者情報編集 - {{ contractor.name }}
        </h1>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group me-2">
                <a href="javascript:window.history.back();" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>戻る
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- メインフォーム -->
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card form-card">
                {% if not contractor %}
                <!-- 新規作成モード: カラフルヘッダー -->
                <div class="form-header {% if contractor_type == 'individual' %}external-header{% elif contractor_type == 'material' %}supplier-header{% elif contractor_type == 'company' %}general-header{% else %}general-header{% endif %}">
                    <h5 class="mb-0">
                        {% if contractor_type == 'individual' %}
                            <i class="fas fa-user me-2"></i>個人職人情報
                        {% elif contractor_type == 'material' %}
                            <i class="fas fa-boxes me-2"></i>資材業者情報
                        {% elif contractor_type == 'company' %}
                            <i class="fas fa-building me-2"></i>協力会社情報
                        {% else %}
                            <i class="fas fa-users me-2"></i>業者情報
                        {% endif %}
                    </h5>
                </div>
                {% endif %}
                <div class="card-body p-4">
                    <form method="post">
                        {% csrf_token %}

                        <!-- 基本情報 -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.name.id_for_label }}" class="form-label">
                                    <i class="fas fa-building me-1"></i>業者名 <span class="required-asterisk">*</span>
                                </label>
                                {{ form.name }}
                                {% if form.name.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.name.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.contact_person.id_for_label }}" class="form-label">
                                    <i class="fas fa-user me-1"></i>担当者名
                                </label>
                                {{ form.contact_person }}
                                {% if form.contact_person.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.contact_person.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.phone.id_for_label }}" class="form-label">
                                    <i class="fas fa-phone me-1"></i>電話番号
                                </label>
                                {{ form.phone }}
                                {% if form.phone.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.phone.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.email.id_for_label }}" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>メールアドレス
                                </label>
                                {{ form.email }}
                                {% if form.email.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.email.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.address.id_for_label }}" class="form-label">
                                <i class="fas fa-map-marker-alt me-1"></i>住所 <span class="text-danger">*</span>
                            </label>
                            {{ form.address }}
                            {% if form.address.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.address.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label for="{{ form.specialties.id_for_label }}" class="form-label">
                                <i class="fas fa-tools me-1"></i>専門分野
                            </label>
                            {{ form.specialties }}
                            {% if form.specialties.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.specialties.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">例：建築工事、電気工事、内装工事など</div>
                        </div>

                        <!-- 業者種別 -->
                        <div class="mb-4">
                            <label for="{{ form.contractor_type.id_for_label }}" class="form-label">
                                <i class="fas fa-user-tag me-1"></i>業者種別 <span class="required-asterisk">*</span>
                            </label>
                            {{ form.contractor_type }}
                            {% if form.contractor_type.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.contractor_type.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">協力会社、個人職人、または資材を選択してください</div>
                        </div>

                        <!-- 時給単価（折りたたみ可能） -->
                        <div class="mb-4">
                            <!-- 折りたたみトグルボタン -->
                            <div class="d-flex align-items-center mb-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleHourlyRateSection()" id="hourlyRateToggleBtn">
                                    <i class="fas fa-plus me-1" id="hourlyRateToggleIcon"></i>
                                    <i class="fas fa-yen-sign me-1"></i>時給単価を追加
                                </button>
                                <small class="text-muted ms-2">（個人職人の場合は入力してください）</small>
                            </div>

                            <!-- 折りたたみ可能な設定エリア -->
                            <div id="hourlyRateSection" style="display: none;">
                                <label for="{{ form.hourly_rate.id_for_label }}" class="form-label">
                                    <i class="fas fa-yen-sign me-1"></i>時給単価
                                </label>
                                {{ form.hourly_rate }}
                                {% if form.hourly_rate.errors %}
                                    <div class="text-danger mt-1">
                                        {% for error in form.hourly_rate.errors %}
                                            <small>{{ error }}</small>
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <div class="form-text">時給単価を円単位で入力してください</div>
                            </div>
                        </div>

                        <!-- 支払い情報 -->
                        <hr class="my-4">
                        <h6 class="mb-3">
                            <i class="fas fa-money-bill me-2"></i>支払い情報
                        </h6>

                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.payment_cycle.id_for_label }}" class="form-label">支払サイクル</label>
                                    {{ form.payment_cycle }}
                                    {% if form.payment_cycle.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.payment_cycle.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">月払い、隔月払いなど</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.closing_day.id_for_label }}" class="form-label">締日</label>
                                    {{ form.closing_day }}
                                    {% if form.closing_day.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.closing_day.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">毎月の締日（1-31）</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.payment_offset_months.id_for_label }}" class="form-label">支払月</label>
                                    {{ form.payment_offset_months }}
                                    {% if form.payment_offset_months.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.payment_offset_months.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">当月、翌月、翌々月</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label for="{{ form.payment_day.id_for_label }}" class="form-label">支払日</label>
                                    {{ form.payment_day }}
                                    {% if form.payment_day.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.payment_day.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">毎月の支払日（1-31）</small>
                                </div>
                            </div>
                        </div>

                        <!-- 銀行口座情報 -->
                        <hr class="my-4">
                        <h6 class="mb-3">
                            <i class="fas fa-university me-2"></i>銀行口座情報
                        </h6>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.bank_name.id_for_label }}" class="form-label">銀行名</label>
                                    {{ form.bank_name }}
                                    {% if form.bank_name.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.bank_name.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.branch_name.id_for_label }}" class="form-label">支店名</label>
                                    {{ form.branch_name }}
                                    {% if form.branch_name.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.branch_name.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.account_type.id_for_label }}" class="form-label">口座種別</label>
                                    {{ form.account_type }}
                                    {% if form.account_type.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.account_type.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.account_number.id_for_label }}" class="form-label">口座番号</label>
                                    {{ form.account_number }}
                                    {% if form.account_number.errors %}
                                        <div class="text-danger mt-1">
                                            {% for error in form.account_number.errors %}
                                                <small>{{ error }}</small>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.account_holder.id_for_label }}" class="form-label">口座名義</label>
                            {{ form.account_holder }}
                            {% if form.account_holder.errors %}
                                <div class="text-danger mt-1">
                                    {% for error in form.account_holder.errors %}
                                        <small>{{ error }}</small>
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <small class="form-text text-muted">任意: カタカナで入力（例: カ）マルマルケンセツ）</small>
                        </div>

                        <!-- カスタムフィールド -->
                        <hr class="my-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">
                                <i class="fas fa-star me-2"></i>追加情報
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#fieldManagementModal">
                                <i class="fas fa-cog me-1"></i>項目を管理
                            </button>
                        </div>

                        {% if custom_fields_by_category %}
                        {% for cat_data in custom_fields_by_category %}
                        <div class="card mb-3">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">{{ cat_data.category.name }}</h6>
                                {% if cat_data.category.description %}
                                <small class="text-muted">{{ cat_data.category.description }}</small>
                                {% endif %}
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    {% for field in cat_data.fields %}
                                    <div class="{% if field.definition.field_type == 'textarea' or field.definition.slug == 'has_wholesale_contract' %}col-md-12{% else %}col-md-6{% endif %} mb-3 {% if field.definition.slug == 'wholesale_contract_details' %}d-none{% endif %} {% if field.definition.slug == 'scaffolding_whole_house_cost' %}d-none{% endif %}"
                                         {% if field.definition.slug == 'wholesale_contract_details' %}id="wholesale_contract_details_wrapper"{% endif %}
                                         {% if field.definition.slug == 'scaffolding_whole_house_cost' %}id="scaffolding_whole_house_cost_wrapper"{% endif %}>
                                        {% if field.definition.field_type == 'text' %}
                                            <label class="form-label">
                                                {{ field.definition.name }}
                                                {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            <input type="text"
                                                   name="custom_{{ field.definition.slug }}"
                                                   class="form-control"
                                                   value="{{ field.current_value }}"
                                                   placeholder="{{ field.definition.placeholder }}"
                                                   {% if field.definition.is_required %}required{% endif %}>
                                            {% if field.definition.help_text %}
                                                <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                            {% endif %}

                                        {% elif field.definition.field_type == 'number' %}
                                            <label class="form-label">
                                                {{ field.definition.name }}
                                                {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            <input type="number"
                                                   name="custom_{{ field.definition.slug }}"
                                                   class="form-control"
                                                   value="{{ field.current_value }}"
                                                   placeholder="{{ field.definition.placeholder }}"
                                                   {% if field.definition.min_value %}min="{{ field.definition.min_value }}"{% endif %}
                                                   {% if field.definition.max_value %}max="{{ field.definition.max_value }}"{% endif %}
                                                   {% if field.definition.is_required %}required{% endif %}>
                                            {% if field.definition.help_text %}
                                                <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                            {% endif %}

                                        {% elif field.definition.field_type == 'date' %}
                                            <label class="form-label">
                                                {{ field.definition.name }}
                                                {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            <input type="date"
                                                   name="custom_{{ field.definition.slug }}"
                                                   class="form-control"
                                                   value="{{ field.current_value }}"
                                                   {% if field.definition.is_required %}required{% endif %}>
                                            {% if field.definition.help_text %}
                                                <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                            {% endif %}

                                        {% elif field.definition.field_type == 'textarea' %}
                                            <label class="form-label">
                                                {{ field.definition.name }}
                                                {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            <textarea name="custom_{{ field.definition.slug }}"
                                                      class="form-control"
                                                      rows="3"
                                                      placeholder="{{ field.definition.placeholder }}"
                                                      {% if field.definition.is_required %}required{% endif %}>{{ field.current_value }}</textarea>
                                            {% if field.definition.help_text %}
                                                <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                            {% endif %}

                                        {% elif field.definition.field_type == 'select' %}
                                            <label class="form-label">
                                                {{ field.definition.name }}
                                                {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                            </label>
                                            <select name="custom_{{ field.definition.slug }}"
                                                    class="form-select"
                                                    {% if field.definition.is_required %}required{% endif %}>
                                                <option value="">選択してください</option>
                                                {% for choice in field.definition.choices %}
                                                    <option value="{{ choice }}" {% if field.current_value == choice %}selected{% endif %}>
                                                        {{ choice }}
                                                    </option>
                                                {% endfor %}
                                            </select>
                                            {% if field.definition.help_text %}
                                                <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                            {% endif %}

                                        {% elif field.definition.field_type == 'multiselect' %}
                                            <label class="form-label d-block">
                                                {{ field.definition.name }}
                                                {% if field.definition.is_required %}<span class="text-danger">*</span>{% endif %}
                                            </label>

                                            {% if field.definition.slug == 'service_areas' or field.definition.slug == 'travel_expense_areas' %}
                                                <!-- 地方ごとの一括選択機能付き表示 -->
                                                <div class="checkbox-group-regions" id="{{ field.definition.slug }}_container">
                                                    {% for region, prefectures in regions_mapping.items %}
                                                    <div class="region-group mb-3 border-start border-primary border-3 ps-3">
                                                        <div class="form-check mb-2">
                                                            <input type="checkbox"
                                                                   class="form-check-input region-toggle"
                                                                   id="region_{{ field.definition.slug }}_{{ forloop.counter }}"
                                                                   data-region="{{ region }}"
                                                                   data-field-slug="{{ field.definition.slug }}"
                                                                   onchange="toggleRegionPrefectures(this)">
                                                            <label class="form-check-label fw-bold" for="region_{{ field.definition.slug }}_{{ forloop.counter }}">
                                                                <i class="fas fa-map-marked-alt me-1"></i>{{ region }}（全選択/解除）
                                                            </label>
                                                        </div>
                                                        <div class="prefecture-checkboxes ps-4">
                                                            {% for prefecture in prefectures %}
                                                            <div class="form-check form-check-inline">
                                                                <input type="checkbox"
                                                                       class="form-check-input prefecture-checkbox"
                                                                       name="custom_{{ field.definition.slug }}"
                                                                       value="{{ prefecture }}"
                                                                       id="custom_{{ field.definition.slug }}_{{ prefecture }}"
                                                                       data-region="{{ region }}"
                                                                       data-field-slug="{{ field.definition.slug }}"
                                                                       {% if prefecture in field.current_value %}checked{% endif %}>
                                                                <label class="form-check-label" for="custom_{{ field.definition.slug }}_{{ prefecture }}">
                                                                    {{ prefecture }}
                                                                </label>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <!-- 通常のmultiselect表示 -->
                                                <div class="checkbox-group">
                                                    {% for choice in field.definition.choices %}
                                                    <div class="form-check form-check-inline">
                                                        <input type="checkbox"
                                                               class="form-check-input"
                                                               name="custom_{{ field.definition.slug }}"
                                                               value="{{ choice }}"
                                                               id="custom_{{ field.definition.slug }}_{{ forloop.counter }}"
                                                               {% if choice in field.current_value %}checked{% endif %}>
                                                        <label class="form-check-label" for="custom_{{ field.definition.slug }}_{{ forloop.counter }}">
                                                            {{ choice }}
                                                        </label>
                                                    </div>
                                                    {% endfor %}
                                                </div>
                                            {% endif %}

                                            {% if field.definition.help_text %}
                                                <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                            {% endif %}

                                        {% elif field.definition.field_type == 'checkbox' %}
                                            <div class="form-check">
                                                <input type="checkbox"
                                                       name="custom_{{ field.definition.slug }}"
                                                       class="form-check-input"
                                                       {% if field.current_value %}checked{% endif %}>
                                                <label class="form-check-label">
                                                    {{ field.definition.name }}
                                                </label>
                                            </div>
                                            {% if field.definition.help_text %}
                                                <small class="form-text text-muted">{{ field.definition.help_text }}</small>
                                            {% endif %}
                                        {% endif %}
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        {% endif %}

                        <hr class="my-4">

                        <!-- アクティブ状態 -->
                        <div class="mb-4">
                            <div class="form-check">
                                {{ form.is_active }}
                                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">
                                    <i class="fas fa-check-circle me-1"></i>アクティブ状態
                                </label>
                            </div>
                            <div class="form-text">チェックを外すと業者一覧に表示されなくなります</div>
                        </div>

                        <!-- 送信ボタン -->
                        <div class="d-flex gap-3 justify-content-center">
                            <button type="submit" class="btn btn-primary btn-save">
                                <i class="fas fa-save me-2"></i>
                                {% if contractor %}業者を更新{% else %}業者を登録{% endif %}
                            </button>
                            {% if contractor %}
                            <a href="javascript:window.history.back();" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>キャンセル
                            </a>
                            {% else %}
                            <a href="{{ back_url }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>キャンセル
                            </a>
                            {% endif %}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- カスタムフィールド管理モーダル -->
<div class="modal fade" id="fieldManagementModal" tabindex="-1" aria-labelledby="fieldManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="fieldManagementModalLabel">
                    <i class="fas fa-cog me-2"></i>カスタムフィールド管理
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- タブナビゲーション -->
                <ul class="nav nav-tabs mb-3" id="fieldManagementTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="categories-tab" data-bs-toggle="tab" data-bs-target="#categories" type="button" role="tab">
                            <i class="fas fa-folder me-1"></i>カテゴリ管理
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="fields-tab" data-bs-toggle="tab" data-bs-target="#fields" type="button" role="tab">
                            <i class="fas fa-list me-1"></i>フィールド管理
                        </button>
                    </li>
                </ul>

                <!-- タブコンテンツ -->
                <div class="tab-content" id="fieldManagementTabsContent">
                    <!-- カテゴリ管理タブ -->
                    <div class="tab-pane fade show active" id="categories" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>カテゴリ一覧</h6>
                                <div id="categoriesList" class="list-group mb-3">
                                    <!-- カテゴリがここに動的に追加されます -->
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>カテゴリ追加/編集</h6>
                                <form id="categoryForm">
                                    <input type="hidden" id="categoryId">
                                    <div class="mb-3">
                                        <label class="form-label">カテゴリ名 <span class="text-danger">*</span></label>
                                        <input type="text" id="categoryName" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">スラッグ <span class="text-danger">*</span></label>
                                        <input type="text" id="categorySlug" class="form-control" required>
                                        <small class="text-muted">英数字とハイフンのみ</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">説明</label>
                                        <textarea id="categoryDescription" class="form-control" rows="2"></textarea>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>保存
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="cancelCategoryEdit">
                                            <i class="fas fa-times me-1"></i>キャンセル
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- フィールド管理タブ -->
                    <div class="tab-pane fade" id="fields" role="tabpanel">
                        <div class="row">
                            <div class="col-md-8">
                                <h6>フィールド一覧</h6>
                                <div class="mb-3">
                                    <label class="form-label">カテゴリでフィルター</label>
                                    <select id="fieldFilterCategory" class="form-select">
                                        <option value="">すべてのカテゴリ</option>
                                    </select>
                                </div>
                                <div id="fieldsList" class="list-group mb-3">
                                    <!-- フィールドがここに動的に追加されます -->
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>フィールド追加/編集</h6>
                                <form id="fieldForm">
                                    <input type="hidden" id="fieldId">
                                    <div class="mb-3">
                                        <label class="form-label">カテゴリ <span class="text-danger">*</span></label>
                                        <select id="fieldCategory" class="form-select" required>
                                            <option value="">選択してください</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">フィールド名 <span class="text-danger">*</span></label>
                                        <input type="text" id="fieldName" class="form-control" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">スラッグ <span class="text-danger">*</span></label>
                                        <input type="text" id="fieldSlug" class="form-control" required>
                                        <small class="text-muted">英数字とアンダースコアのみ</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">フィールドタイプ <span class="text-danger">*</span></label>
                                        <select id="fieldType" class="form-select" required>
                                            <option value="text">テキスト</option>
                                            <option value="number">数値</option>
                                            <option value="date">日付</option>
                                            <option value="select">選択肢</option>
                                            <option value="multiselect">複数選択</option>
                                            <option value="checkbox">チェックボックス</option>
                                            <option value="textarea">テキストエリア</option>
                                        </select>
                                    </div>
                                    <div class="mb-3" id="choicesGroup" style="display: none;">
                                        <label class="form-label">選択肢（カンマ区切り）</label>
                                        <input type="text" id="fieldChoices" class="form-control" placeholder="例: ○,×,△">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">プレースホルダー</label>
                                        <input type="text" id="fieldPlaceholder" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">ヘルプテキスト</label>
                                        <input type="text" id="fieldHelpText" class="form-control">
                                    </div>
                                    <div class="form-check mb-3">
                                        <input type="checkbox" id="fieldRequired" class="form-check-input">
                                        <label class="form-check-label" for="fieldRequired">必須フィールド</label>
                                    </div>
                                    <div class="d-grid gap-2">
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-save me-1"></i>保存
                                        </button>
                                        <button type="button" class="btn btn-secondary" id="cancelFieldEdit">
                                            <i class="fas fa-times me-1"></i>キャンセル
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- 確認ダイアログモーダル -->
<div class="modal fade" id="confirmDialog" tabindex="-1" aria-labelledby="confirmDialogLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDialogLabel">確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmDialogBody">
                <!-- メッセージがここに表示されます -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-danger" id="confirmDialogOkBtn">削除</button>
            </div>
        </div>
    </div>
</div>

<!-- 通知トーストエリア -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
    <div id="notificationToast" class="toast align-items-center border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body" id="toastBody">
                <!-- メッセージがここに表示されます -->
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- SortableJS for drag and drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// 時給単価セクションのトグル
window.toggleHourlyRateSection = function() {
    const section = document.getElementById('hourlyRateSection');
    const toggleBtn = document.getElementById('hourlyRateToggleBtn');
    const toggleIcon = document.getElementById('hourlyRateToggleIcon');

    if (section.style.display === 'none') {
        // 展開
        section.style.display = 'block';
        toggleIcon.classList.remove('fa-plus');
        toggleIcon.classList.add('fa-minus');
        toggleBtn.innerHTML = '<i class="fas fa-minus me-1" id="hourlyRateToggleIcon"></i><i class="fas fa-yen-sign me-1"></i>時給単価を閉じる';
    } else {
        // 折りたたみ
        section.style.display = 'none';
        toggleIcon.classList.remove('fa-minus');
        toggleIcon.classList.add('fa-plus');
        toggleBtn.innerHTML = '<i class="fas fa-plus me-1" id="hourlyRateToggleIcon"></i><i class="fas fa-yen-sign me-1"></i>時給単価を追加';
    }
};

document.addEventListener('DOMContentLoaded', function() {
    // ========================================
    // ユーティリティ関数
    // ========================================

    // 通知トーストを表示
    function showToast(message, type = 'success') {
        const toastEl = document.getElementById('notificationToast');
        const toastBody = document.getElementById('toastBody');
        const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });

        // タイプに応じて背景色を変更
        toastEl.classList.remove('bg-success', 'bg-danger', 'bg-warning', 'text-white');
        if (type === 'success') {
            toastEl.classList.add('bg-success', 'text-white');
        } else if (type === 'error') {
            toastEl.classList.add('bg-danger', 'text-white');
        } else if (type === 'warning') {
            toastEl.classList.add('bg-warning', 'text-white');
        }

        toastBody.textContent = message;
        toast.show();
    }

    // 確認ダイアログを表示
    function showConfirmDialog(message, onConfirm) {
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmBody = document.getElementById('confirmDialogBody');
        const confirmBtn = document.getElementById('confirmDialogOkBtn');

        // 改行を<br>に変換
        confirmBody.innerHTML = message.replace(/\n/g, '<br>');

        // 既存のイベントリスナーを削除
        const newConfirmBtn = confirmBtn.cloneNode(true);
        confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);

        // 新しいイベントリスナーを追加
        newConfirmBtn.addEventListener('click', function() {
            const modal = bootstrap.Modal.getInstance(confirmDialog);
            modal.hide();
            onConfirm();
        });

        const modal = new bootstrap.Modal(confirmDialog);
        modal.show();
    }

    // 時給単価の初期状態チェック（値があれば展開）
    const hourlyRateField = document.getElementById('{{ form.hourly_rate.id_for_label }}');
    const hourlyRateSection = document.getElementById('hourlyRateSection');
    if (hourlyRateField && hourlyRateField.value && hourlyRateField.value !== '') {
        toggleHourlyRateSection();
    }

    // ========================================
    // インボイス番号の自動フォーマット
    // ========================================
    const invoiceField = document.querySelector('input[name="custom_invoice_number"]');
    if (invoiceField) {
        invoiceField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^0-9T]/g, ''); // T と数字のみ

            if (value.startsWith('T')) {
                let numbers = value.substring(1);
                // 最大12桁まで
                numbers = numbers.substring(0, 12);

                if (numbers.length > 8) {
                    value = 'T' + numbers.substring(0, 4) + '-' + numbers.substring(4, 8) + '-' + numbers.substring(8);
                } else if (numbers.length > 4) {
                    value = 'T' + numbers.substring(0, 4) + '-' + numbers.substring(4);
                } else {
                    value = 'T' + numbers;
                }
            } else if (value.length > 0) {
                // T がない場合は先頭に追加
                value = 'T' + value.replace(/[^0-9]/g, '').substring(0, 12);
            }

            e.target.value = value;
        });
    }

    // ========================================
    // 問屋契約の条件付き表示
    // ========================================
    const wholesaleContractSelect = document.querySelector('select[name="custom_has_wholesale_contract"]');
    if (wholesaleContractSelect) {
        function toggleWholesaleDetails() {
            const detailsField = document.getElementById('wholesale_contract_details_wrapper');
            if (detailsField) {
                if (wholesaleContractSelect.value === 'あり') {
                    detailsField.classList.remove('d-none');
                } else {
                    detailsField.classList.add('d-none');
                }
            }
        }

        wholesaleContractSelect.addEventListener('change', toggleWholesaleDetails);
        toggleWholesaleDetails(); // 初期状態を設定
    }

    // ========================================
    // 足場契約の条件付き表示
    // ========================================
    const scaffoldingCheckbox = document.querySelector('input[name="custom_scaffolding_contract"]');
    if (scaffoldingCheckbox) {
        function toggleScaffoldingCost() {
            const costField = document.getElementById('scaffolding_whole_house_cost_wrapper');
            if (costField) {
                if (scaffoldingCheckbox.checked) {
                    costField.classList.remove('d-none');
                } else {
                    costField.classList.add('d-none');
                }
            }
        }

        scaffoldingCheckbox.addEventListener('change', toggleScaffoldingCost);
        toggleScaffoldingCost(); // 初期状態を設定
    }

    // ========================================
    // カスタムフィールド管理モーダル
    // ========================================

    const fieldManagementModal = document.getElementById('fieldManagementModal');
    let categoriesData = [];
    let fieldsData = [];

    // モーダルが開いたときにデータを読み込む
    if (fieldManagementModal) {
        fieldManagementModal.addEventListener('show.bs.modal', function() {
            loadCategories();
            loadFields();
        });
    }

    // CSRFトークンを取得
    function getCsrfToken() {
        return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }

    // ========================================
    // カテゴリ管理
    // ========================================

    function loadCategories() {
        fetch('/orders/api/contractor-field-categories/')
            .then(response => response.json())
            .then(data => {
                categoriesData = data.categories || [];
                renderCategories();
                updateCategorySelects();
            })
            .catch(error => {
                console.error('カテゴリの読み込みエラー:', error);
                showToast('カテゴリの読み込みに失敗しました', 'error');
            });
    }

    function renderCategories() {
        const categoriesList = document.getElementById('categoriesList');
        if (!categoriesList) return;

        if (categoriesData.length === 0) {
            categoriesList.innerHTML = '<div class="text-muted text-center p-3">カテゴリがありません</div>';
            return;
        }

        categoriesList.innerHTML = categoriesData.map(cat => `
            <div class="list-group-item d-flex justify-content-between align-items-center" data-id="${cat.id}">
                <div class="d-flex align-items-center flex-grow-1">
                    <i class="fas fa-grip-vertical text-muted me-3 drag-handle" style="cursor: move;" title="ドラッグして並び替え"></i>
                    <div>
                        <strong>${cat.name}</strong>
                        <br>
                        <small class="text-muted">スラッグ: ${cat.slug}</small>
                        ${cat.description ? '<br><small class="text-muted">' + cat.description + '</small>' : ''}
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="editCategory(${cat.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCategory(${cat.id}, '${cat.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');

        // Sortableを初期化
        initCategorySortable();
    }

    function updateCategorySelects() {
        // フィールド作成フォームのカテゴリ選択肢を更新
        const fieldCategory = document.getElementById('fieldCategory');
        const fieldFilterCategory = document.getElementById('fieldFilterCategory');

        if (fieldCategory) {
            fieldCategory.innerHTML = '<option value="">選択してください</option>' +
                categoriesData.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }

        if (fieldFilterCategory) {
            fieldFilterCategory.innerHTML = '<option value="">すべてのカテゴリ</option>' +
                categoriesData.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
        }
    }

    // カテゴリフォーム送信
    const categoryForm = document.getElementById('categoryForm');
    if (categoryForm) {
        categoryForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const categoryId = document.getElementById('categoryId').value;
            const name = document.getElementById('categoryName').value.trim();
            const slug = document.getElementById('categorySlug').value.trim();
            const description = document.getElementById('categoryDescription').value.trim();

            if (!name || !slug) {
                showToast('カテゴリ名とスラッグは必須です', 'warning');
                return;
            }

            const url = categoryId ?
                `/orders/api/contractor-field-categories/${categoryId}/update/` :
                '/orders/api/contractor-field-categories/create/';

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({ name, slug, description })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(categoryId ? 'カテゴリを更新しました' : 'カテゴリを作成しました', 'success');
                    resetCategoryForm();
                    loadCategories();
                } else {
                    showToast('エラー: ' + (data.error || '保存に失敗しました'), 'error');
                }
            })
            .catch(error => {
                console.error('カテゴリ保存エラー:', error);
                showToast('カテゴリの保存に失敗しました', 'error');
            });
        });
    }

    // カテゴリ編集
    window.editCategory = function(categoryId) {
        const category = categoriesData.find(c => c.id === categoryId);
        if (!category) return;

        document.getElementById('categoryId').value = category.id;
        document.getElementById('categoryName').value = category.name;
        document.getElementById('categorySlug').value = category.slug;
        document.getElementById('categoryDescription').value = category.description || '';
    };

    // カテゴリ削除
    window.deleteCategory = function(categoryId, categoryName) {
        showConfirmDialog(
            `カテゴリ「${categoryName}」を削除してもよろしいですか？\n\nこのカテゴリに紐づくフィールドもすべて削除されます。`,
            function() {
                fetch(`/orders/api/contractor-field-categories/${categoryId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('カテゴリを削除しました', 'success');
                        loadCategories();
                        loadFields();
                    } else {
                        showToast('エラー: ' + (data.error || '削除に失敗しました'), 'error');
                    }
                })
                .catch(error => {
                    console.error('カテゴリ削除エラー:', error);
                    showToast('カテゴリの削除に失敗しました', 'error');
                });
            }
        );
    };

    // カテゴリフォームリセット
    const cancelCategoryEdit = document.getElementById('cancelCategoryEdit');
    if (cancelCategoryEdit) {
        cancelCategoryEdit.addEventListener('click', resetCategoryForm);
    }

    function resetCategoryForm() {
        document.getElementById('categoryId').value = '';
        document.getElementById('categoryName').value = '';
        document.getElementById('categorySlug').value = '';
        document.getElementById('categoryDescription').value = '';
    }

    // ========================================
    // フィールド管理
    // ========================================

    function loadFields() {
        fetch('/orders/api/contractor-field-definitions/')
            .then(response => response.json())
            .then(data => {
                fieldsData = data.fields || [];
                renderFields();
            })
            .catch(error => {
                console.error('フィールドの読み込みエラー:', error);
                showToast('フィールドの読み込みに失敗しました', 'error');
            });
    }

    function renderFields() {
        const fieldsList = document.getElementById('fieldsList');
        const filterCategoryId = document.getElementById('fieldFilterCategory')?.value;

        if (!fieldsList) return;

        let filteredFields = fieldsData;
        if (filterCategoryId) {
            filteredFields = fieldsData.filter(f => f.category_id == filterCategoryId);
        }

        if (filteredFields.length === 0) {
            fieldsList.innerHTML = '<div class="text-muted text-center p-3">フィールドがありません</div>';
            return;
        }

        // カテゴリごとにフィールドをグループ化
        const fieldsByCategory = {};
        filteredFields.forEach(field => {
            if (!fieldsByCategory[field.category_id]) {
                fieldsByCategory[field.category_id] = [];
            }
            fieldsByCategory[field.category_id].push(field);
        });

        // カテゴリごとに表示
        let html = '';
        categoriesData.forEach(category => {
            const categoryFields = fieldsByCategory[category.id];
            if (!categoryFields || categoryFields.length === 0) {
                // フィルターなしの場合は空のカテゴリも表示
                if (!filterCategoryId) {
                    html += `
                        <div class="mb-4">
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-folder me-1"></i>${category.name}
                            </h6>
                            <div class="text-muted ps-3 small">フィールドがありません</div>
                        </div>
                    `;
                }
                return;
            }

            html += `
                <div class="mb-4">
                    <h6 class="text-primary mb-2">
                        <i class="fas fa-folder me-1"></i>${category.name}
                    </h6>
                    <div class="list-group sortable-field-list" data-category-id="${category.id}">
                        ${categoryFields.map((field, index) => `
                            <div class="list-group-item" data-id="${field.id}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="d-flex align-items-start flex-grow-1">
                                        <i class="fas fa-grip-vertical text-muted me-3 drag-handle" style="cursor: move; margin-top: 4px;" title="ドラッグして並び替え"></i>
                                        <div>
                                            <strong>${field.name}</strong>
                                            <span class="badge bg-secondary ms-2">${field.field_type}</span>
                                            ${field.is_required ? '<span class="badge bg-danger ms-1">必須</span>' : ''}
                                            <br>
                                            <small class="text-muted">スラッグ: ${field.slug}</small>
                                            ${field.help_text ? '<br><small class="text-muted">' + field.help_text + '</small>' : ''}
                                            ${field.choices && field.choices.length > 0 ? '<br><small class="text-muted">選択肢: ' + field.choices.join(', ') + '</small>' : ''}
                                        </div>
                                    </div>
                                    <div class="btn-group">
                                        <button class="btn btn-sm btn-outline-primary" onclick="editField(${field.id})" title="編集">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" onclick="deleteField(${field.id}, '${field.name}')" title="削除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });

        fieldsList.innerHTML = html;

        // Sortableを初期化（各カテゴリのフィールドリストに対して）
        initFieldSortable();
    }

    // フィールドタイプ変更時に選択肢入力の表示/非表示を切り替え
    const fieldType = document.getElementById('fieldType');
    if (fieldType) {
        fieldType.addEventListener('change', function() {
            const choicesGroup = document.getElementById('choicesGroup');
            if (this.value === 'select' || this.value === 'multiselect') {
                choicesGroup.style.display = 'block';
            } else {
                choicesGroup.style.display = 'none';
            }
        });
    }

    // フィールドフィルター変更時
    const fieldFilterCategory = document.getElementById('fieldFilterCategory');
    if (fieldFilterCategory) {
        fieldFilterCategory.addEventListener('change', renderFields);
    }

    // フィールドフォーム送信
    const fieldForm = document.getElementById('fieldForm');
    if (fieldForm) {
        fieldForm.addEventListener('submit', function(e) {
            e.preventDefault();

            const fieldId = document.getElementById('fieldId').value;
            const category_id = document.getElementById('fieldCategory').value;
            const name = document.getElementById('fieldName').value.trim();
            const slug = document.getElementById('fieldSlug').value.trim();
            const field_type = document.getElementById('fieldType').value;
            const placeholder = document.getElementById('fieldPlaceholder').value.trim();
            const help_text = document.getElementById('fieldHelpText').value.trim();
            const is_required = document.getElementById('fieldRequired').checked;

            let choices = [];
            if (field_type === 'select' || field_type === 'multiselect') {
                const choicesInput = document.getElementById('fieldChoices').value.trim();
                if (choicesInput) {
                    choices = choicesInput.split(',').map(c => c.trim()).filter(c => c);
                }
            }

            if (!category_id || !name || !slug) {
                showToast('カテゴリ、フィールド名、スラッグは必須です', 'warning');
                return;
            }

            const url = fieldId ?
                `/orders/api/contractor-field-definitions/${fieldId}/update/` :
                '/orders/api/contractor-field-definitions/create/';

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCsrfToken()
                },
                body: JSON.stringify({
                    category_id,
                    name,
                    slug,
                    field_type,
                    placeholder,
                    help_text,
                    is_required,
                    choices
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast(fieldId ? 'フィールドを更新しました' : 'フィールドを作成しました', 'success');
                    resetFieldForm();
                    loadFields();
                } else {
                    showToast('エラー: ' + (data.error || '保存に失敗しました'), 'error');
                }
            })
            .catch(error => {
                console.error('フィールド保存エラー:', error);
                showToast('フィールドの保存に失敗しました', 'error');
            });
        });
    }

    // フィールド編集
    window.editField = function(fieldId) {
        const field = fieldsData.find(f => f.id === fieldId);
        if (!field) return;

        document.getElementById('fieldId').value = field.id;
        document.getElementById('fieldCategory').value = field.category_id;
        document.getElementById('fieldName').value = field.name;
        document.getElementById('fieldSlug').value = field.slug;
        document.getElementById('fieldType').value = field.field_type;
        document.getElementById('fieldPlaceholder').value = field.placeholder || '';
        document.getElementById('fieldHelpText').value = field.help_text || '';
        document.getElementById('fieldRequired').checked = field.is_required || false;

        // 選択肢がある場合
        if (field.choices && field.choices.length > 0) {
            document.getElementById('fieldChoices').value = field.choices.join(', ');
        } else {
            document.getElementById('fieldChoices').value = '';
        }

        // 選択肢入力の表示/非表示
        const choicesGroup = document.getElementById('choicesGroup');
        if (field.field_type === 'select' || field.field_type === 'multiselect') {
            choicesGroup.style.display = 'block';
        } else {
            choicesGroup.style.display = 'none';
        }

        // フィールドタブに切り替え
        const fieldsTab = document.getElementById('fields-tab');
        if (fieldsTab) {
            fieldsTab.click();
        }
    };

    // フィールド削除
    window.deleteField = function(fieldId, fieldName) {
        showConfirmDialog(
            `フィールド「${fieldName}」を削除してもよろしいですか？`,
            function() {
                fetch(`/orders/api/contractor-field-definitions/${fieldId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken()
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('フィールドを削除しました', 'success');
                        loadFields();
                    } else {
                        showToast('エラー: ' + (data.error || '削除に失敗しました'), 'error');
                    }
                })
                .catch(error => {
                    console.error('フィールド削除エラー:', error);
                    showToast('フィールドの削除に失敗しました', 'error');
                });
            }
        );
    };

    // ========================================
    // Sortable初期化関数
    // ========================================

    // カテゴリリストのSortableを初期化
    function initCategorySortable() {
        const categoriesList = document.getElementById('categoriesList');
        if (!categoriesList || categoriesList.children.length === 0) return;

        new Sortable(categoriesList, {
            handle: '.drag-handle',
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function(evt) {
                // 新しい順序を取得
                const items = Array.from(categoriesList.children).map((el, index) => ({
                    id: parseInt(el.dataset.id),
                    order: index
                }));

                // サーバーに送信
                fetch('/orders/api/contractor-field-reorder/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify({
                        type: 'category',
                        items: items
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showToast('カテゴリの並び替えを保存しました', 'success');
                        loadCategories();
                    } else {
                        showToast('エラー: ' + (data.error || '並び替えに失敗しました'), 'error');
                    }
                })
                .catch(error => {
                    console.error('並び替えエラー:', error);
                    showToast('並び替えに失敗しました', 'error');
                });
            }
        });
    }

    // フィールドリストのSortableを初期化
    function initFieldSortable() {
        const fieldLists = document.querySelectorAll('.sortable-field-list');

        fieldLists.forEach(list => {
            new Sortable(list, {
                handle: '.drag-handle',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    const categoryId = parseInt(list.dataset.categoryId);

                    // このカテゴリのフィールドの新しい順序を取得
                    const items = Array.from(list.children).map((el, index) => ({
                        id: parseInt(el.dataset.id),
                        order: index
                    }));

                    // サーバーに送信
                    fetch('/orders/api/contractor-field-reorder/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify({
                            type: 'field',
                            items: items
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showToast('フィールドの並び替えを保存しました', 'success');
                            loadFields();
                        } else {
                            showToast('エラー: ' + (data.error || '並び替えに失敗しました'), 'error');
                        }
                    })
                    .catch(error => {
                        console.error('並び替えエラー:', error);
                        showToast('並び替えに失敗しました', 'error');
                    });
                }
            });
        });
    }

    // フィールドフォームリセット
    const cancelFieldEdit = document.getElementById('cancelFieldEdit');
    if (cancelFieldEdit) {
        cancelFieldEdit.addEventListener('click', resetFieldForm);
    }

    function resetFieldForm() {
        document.getElementById('fieldId').value = '';
        document.getElementById('fieldCategory').value = '';
        document.getElementById('fieldName').value = '';
        document.getElementById('fieldSlug').value = '';
        document.getElementById('fieldType').value = 'text';
        document.getElementById('fieldPlaceholder').value = '';
        document.getElementById('fieldHelpText').value = '';
        document.getElementById('fieldRequired').checked = false;
        document.getElementById('fieldChoices').value = '';
        document.getElementById('choicesGroup').style.display = 'none';
    }

    // モーダルを閉じたときにページをリロード（カスタムフィールドを反映）
    if (fieldManagementModal) {
        fieldManagementModal.addEventListener('hidden.bs.modal', function() {
            // 変更があった場合のみリロード
            if (categoriesData.length > 0 || fieldsData.length > 0) {
                location.reload();
            }
        });
    }

    // ========================================
    // 地方ごとの都道府県一括選択/解除機能
    // ========================================

    /**
     * 地方チェックボックスの切り替え時に、その地方の全都道府県をチェック/解除
     */
    window.toggleRegionPrefectures = function(regionCheckbox) {
        const region = regionCheckbox.dataset.region;
        const fieldSlug = regionCheckbox.dataset.fieldSlug;
        const isChecked = regionCheckbox.checked;

        // 同じ地方の都道府県チェックボックスを取得
        const prefectureCheckboxes = document.querySelectorAll(
            `input.prefecture-checkbox[data-region="${region}"][data-field-slug="${fieldSlug}"]`
        );

        // すべての都道府県チェックボックスを一括で変更
        prefectureCheckboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    };

    /**
     * ページ読み込み時に、既にチェックされている都道府県に基づいて地方チェックボックスの状態を更新
     */
    function updateRegionCheckboxStates() {
        const regionToggles = document.querySelectorAll('.region-toggle');

        regionToggles.forEach(regionToggle => {
            const region = regionToggle.dataset.region;
            const fieldSlug = regionToggle.dataset.fieldSlug;

            // この地方の都道府県チェックボックスを取得
            const prefectureCheckboxes = document.querySelectorAll(
                `input.prefecture-checkbox[data-region="${region}"][data-field-slug="${fieldSlug}"]`
            );

            // すべての都道府県がチェックされているか確認
            const allChecked = Array.from(prefectureCheckboxes).every(cb => cb.checked);
            const someChecked = Array.from(prefectureCheckboxes).some(cb => cb.checked);

            // 地方チェックボックスの状態を更新
            if (allChecked && prefectureCheckboxes.length > 0) {
                regionToggle.checked = true;
                regionToggle.indeterminate = false;
            } else if (someChecked) {
                regionToggle.checked = false;
                regionToggle.indeterminate = true;  // 一部のみチェックされている場合は不確定状態
            } else {
                regionToggle.checked = false;
                regionToggle.indeterminate = false;
            }
        });
    }

    // ページ読み込み時に地方チェックボックスの状態を初期化
    updateRegionCheckboxStates();

    // 都道府県チェックボックスの変更を監視して、地方チェックボックスの状態を更新
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('prefecture-checkbox')) {
            updateRegionCheckboxStates();
        }
    });
});
</script>
{% endblock %}