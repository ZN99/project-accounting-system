{% extends "order_management/base.html" %}
{% load humanize %}
{# CACHE_CLEAR_20251129_002531 #}
{% block title %}{{ title }} - å»ºç¯‰æ´¾é£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<style>
    .form-section {
        border-radius: 12px;
        border: 1px solid #e3e6f0;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
        transition: all 0.3s ease;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .form-section:hover {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        transform: translateY(-1px);
    }
    .section-header {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        border-radius: 12px 12px 0 0;
        padding: 1rem 1.5rem;
        margin: 0;
        border-bottom: 1px solid #e3e6f0;
    }
    .section-header h5 {
        margin: 0;
        font-weight: 600;
    }
    .form-label {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 0.5rem;
    }
    .form-control, .form-select {
        border-radius: 8px;
        border: 1px solid #d1d3e2;
        transition: all 0.2s ease;
    }
    .form-control:focus, .form-select:focus {
        border-color: #4e73df;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    .btn-primary {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        border: none;
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(78, 115, 223, 0.4);
    }
    .btn-secondary {
        border-radius: 8px;
        padding: 12px 30px;
        font-weight: 600;
    }
    .revenue-preview {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
        margin-top: 1rem;
        border: 1px solid #dee2e6;
    }
    .revenue-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #e9ecef;
    }
    .revenue-item:last-child {
        border-bottom: none;
        font-weight: 600;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®z-indexèª¿æ•´ */
    #staffManagementModal {
        z-index: 9999 !important;
    }
    #staffManagementModal .modal-backdrop {
        z-index: 9998 !important;
    }
    #salesStaffManagementModal {
        z-index: 9999 !important;
    }
    /* æ–°è¦å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆè¦ªãƒ¢ãƒ¼ãƒ€ãƒ«ã®ä¸Šã«è¡¨ç¤ºï¼‰ */
    #addSalesStaffModal {
        z-index: 10050 !important;
    }
    #addSalesStaffModal + .modal-backdrop {
        z-index: 10040 !important;
    }
    #craftsmanManagementModal {
        z-index: 9999 !important;
    }
    #contractorManagementModal {
        z-index: 2050 !important;
    }
    #contractorManagementModal .modal-backdrop {
        z-index: 2049 !important;
    }

    /* èƒŒæ™¯ãƒšãƒ¼ã‚¸ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ */
    body.modal-open {
        overflow: hidden !important;
        position: fixed !important;
        width: 100% !important;
    }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ */
    #contractorManagementModal .modal-body {
        max-height: 70vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã®70% */
        overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹ */
        padding: 1rem;
        -webkit-overflow-scrolling: touch; /* iOSã§ã®ã‚¹ãƒ ãƒ¼ã‚ºã‚¹ã‚¯ãƒ­ãƒ¼ãƒ« */
    }

    #contractorManagementModal .modal-dialog {
        max-height: 90vh; /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…¨ä½“ã®æœ€å¤§é«˜ã• */
        display: flex;
        flex-direction: column;
    }

    /* å…¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åˆ¶å¾¡ã‚’çµ±ä¸€ */
    .modal .modal-body {
        max-height: 70vh;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
    }

    #contractorManagementModal .modal-content {
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    #contractorModal {
        z-index: 2060 !important;
    }
    #contractorModal .modal-backdrop {
        z-index: 2059 !important;
    }
    #addImplementationModal {
        z-index: 1055 !important;
    }
    .modal-backdrop.show {
        z-index: 1054 !important;
    }

    /* èƒŒæ™¯ã®é‡è¤‡ã‚’é˜²ã */
    .modal.show {
        background-color: rgba(0,0,0,0.5) !important;
    }

    /* æ¥­è€…ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã®å›ºå®šåˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
    .contractor-table-wrapper {
        position: relative;
        overflow: hidden;
    }

    .contractor-table-scroll {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 50vh; /* ãƒ“ãƒ¥ãƒ¼ãƒãƒ¼ãƒˆé«˜ã•ã®50%ã«èª¿æ•´ */
        margin-right: 160px; /* å›ºå®šåˆ—ã®å¹…åˆ†ãƒãƒ¼ã‚¸ãƒ³ã‚’ç¢ºä¿ */
    }

    .contractor-table-fixed {
        position: absolute;
        top: 0;
        right: 0;
        width: 160px;
        max-height: 50vh; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸã¨åŒã˜é«˜ã• */
        overflow-y: auto; /* ç¸¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ‰åŠ¹åŒ– */
        background: white;
        border-left: 2px solid #dee2e6;
        z-index: 10;
    }

    .contractor-table-scroll table,
    .contractor-table-fixed table {
        margin-bottom: 0;
        table-layout: fixed !important;
        width: 100% !important;
    }

    .contractor-table-fixed th,
    .contractor-table-fixed td {
        text-align: center;
        white-space: nowrap;
        height: 60px !important;
        vertical-align: middle !important;
        padding: 8px 8px !important;
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®é«˜ã•ã‚‚çµ±ä¸€ */
    .contractor-table thead th {
        height: 50px !important;
        vertical-align: middle !important;
        padding: 8px 8px !important;
    }

    /* æ¥­è€…åˆ†é¡ã«ã‚ˆã‚‹è¡Œã®è‰²åˆ†ã‘ */
    .contractor-table tbody tr.bg-success.bg-opacity-10 {
        background-color: rgba(25, 135, 84, 0.1) !important;
    }
    .contractor-table tbody tr.bg-warning.bg-opacity-10 {
        background-color: rgba(255, 193, 7, 0.1) !important;
    }
    .contractor-table tbody tr.bg-success.bg-opacity-10:hover {
        background-color: rgba(25, 135, 84, 0.2) !important;
    }
    .contractor-table tbody tr.bg-warning.bg-opacity-10:hover {
        background-color: rgba(255, 193, 7, 0.2) !important;
    }
        padding: 8px 4px;
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®é«˜ã•ã‚’çµ±ä¸€ - ã‚ˆã‚Šå¼·åˆ¶çš„ã«é©ç”¨ */
    .contractor-table tbody tr {
        height: 60px !important;
        min-height: 60px !important;
        max-height: 60px !important;
    }

    .contractor-table tbody td {
        vertical-align: middle !important;
        white-space: nowrap;
        height: 60px !important;
        line-height: 1.2 !important;
        padding: 8px 8px !important;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    /* ãƒãƒƒã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
    .contractor-table .badge {
        font-size: 0.7em;
        margin-right: 2px;
        margin-bottom: 2px;
        display: inline-block;
    }

    /* æ“ä½œãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«çµ±ä¸€ */
    .contractor-table .btn {
        height: 32px !important;
        min-height: 32px !important;
        padding: 4px 8px !important;
        font-size: 0.75em !important;
        line-height: 1.2 !important;
        margin: 2px !important;
        display: inline-block !important;
        vertical-align: middle !important;
    }

    /* ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .contractor-table tbody tr.clickable-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .contractor-table tbody tr.clickable-row:hover {
        background-color: #e3f2fd !important;
    }

    .contractor-table tbody tr.clickable-row.active {
        background-color: #f0f8ff !important;
        border-left: 3px solid #007bff;
    }

    .contractor-table tbody tr.inactive-row {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .contractor-table tbody tr.inactive-row:hover {
        background-color: #f8f9fa !important;
    }

    /* ã‚¿ãƒ–UIã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #projectFormTabs .nav-link {
        color: #6c757d;
        font-weight: 500;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 1rem 1.5rem;
        transition: all 0.3s ease;
    }

    #projectFormTabs .nav-link:hover {
        color: #0d6efd;
        background: #f8f9fa;
        border-bottom-color: #dee2e6;
    }

    #projectFormTabs .nav-link.active {
        color: #0d6efd;
        background: white;
        border-bottom-color: #0d6efd;
        font-weight: 600;
    }

    /* è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .btn-group .btn-light.active {
        background-color: #0d6efd;
        color: white;
        border-color: #0d6efd;
    }

    .btn-group .btn-light {
        transition: all 0.3s ease;
    }

    .btn-group .btn-light:hover:not(.active) {
        background-color: #e9ecef;
    }

    /* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    #projectFormTabsContent .tab-pane {
        /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ– */
    }

    #projectFormTabsContent.full-view-mode .tab-pane {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: white;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
    }

    #projectFormTabsContent.full-view-mode .tab-pane:last-child {
        margin-bottom: 0;
    }

    #projectFormTabsContent.full-view-mode .tab-pane::before {
        content: attr(data-section-title);
        display: block;
        font-size: 1.25rem;
        font-weight: 600;
        color: #0d6efd;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #0d6efd;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
</style>

<!-- Toastr CSS -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="card">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                <h3 class="mb-0"><i class="fas fa-edit me-2"></i>{{ title }}</h3>
                <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-light active" id="tabViewBtn" onclick="switchFormViewMode('tab')">
                        <i class="fas fa-th-large me-1"></i>ã‚¿ãƒ–è¡¨ç¤º
                    </button>
                    <button type="button" class="btn btn-light" id="fullViewBtn" onclick="switchFormViewMode('full')">
                        <i class="fas fa-list me-1"></i>å…¨ä½“è¡¨ç¤º
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <form method="post" id="projectForm">
                    {% csrf_token %}

                    <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                    <ul class="nav nav-tabs" id="projectFormTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                                <i class="fas fa-info-circle me-1"></i>åŸºæœ¬æƒ…å ±
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">
                                <i class="fas fa-calendar-alt me-1"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="order-tab" data-bs-toggle="tab" data-bs-target="#order" type="button" role="tab">
                                <i class="fas fa-file-invoice-dollar me-1"></i>è¦‹ç©ãƒ»è«‹æ±‚
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="staff-tab" data-bs-toggle="tab" data-bs-target="#staff" type="button" role="tab">
                                <i class="fas fa-users me-1"></i>æ¥­è€…ãƒ»æ‹…å½“
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                                <i class="fas fa-sticky-note me-1"></i>å‚™è€ƒ
                            </button>
                        </li>
                    </ul>

                    <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                    <div class="tab-content p-4" id="projectFormTabsContent">
                        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ– -->
                        <div class="tab-pane show active" id="basic" role="tabpanel" data-section-title="ğŸ“‹ åŸºæœ¬æƒ…å ±">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-info-circle me-2"></i>åŸºæœ¬æƒ…å ±</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.site_name.id_for_label }}" class="form-label">
                                        ç¾å ´å <span class="text-danger">*</span>
                                    </label>
                                    {{ form.site_name }}
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.work_type.id_for_label }}" class="form-label">
                                        ç¨®åˆ¥ <span class="text-danger">*</span>
                                    </label>
                                    <div class="d-flex gap-2">
                                        {{ form.work_type }}
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openWorkTypeManagementModal()" title="å·¥äº‹ç¨®åˆ¥ã‚’ç®¡ç†">
                                            <i class="fas fa-tools"></i> ç¨®åˆ¥ç®¡ç†
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.site_address.id_for_label }}" class="form-label">
                                    ç¾å ´ä½æ‰€
                                </label>
                                {{ form.site_address }}
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">å…ƒè«‹å <span class="text-danger">*</span></label>
                                    <div class="d-flex gap-2">
                                        <select name="client_company" class="form-select" id="clientCompanySelect">
                                            <option value="">-- å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                            {% for company in client_companies %}
                                            <option value="{{ company.id }}"
                                                    {% if project.client_company_id == company.id %}selected{% endif %}
                                                    data-name="{{ company.company_name }}"
                                                    data-address="{{ company.address }}"
                                                    data-payment-cycle="{{ company.payment_cycle }}"
                                                    data-closing-day="{{ company.closing_day|default:'' }}"
                                                    data-payment-offset-months="{{ company.payment_offset_months|default:'' }}"
                                                    data-payment-day="{{ company.payment_day|default:'' }}">
                                                {{ company.company_name }}{% if company.address %} - {{ company.address }}{% endif %}
                                            </option>
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openClientCompanyManagementPanel()" title="å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠãƒ»ç®¡ç†">
                                            <i class="fas fa-building"></i> å…ƒè«‹ç®¡ç†
                                        </button>
                                    </div>
                                    <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šsurvey_status -->
                                    <input type="hidden" name="survey_status" value="{{ project.survey_status|default:'not_required' }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">æ¡ˆä»¶æ‹…å½“è€…ï¼ˆå–¶æ¥­ï¼‰ <span class="text-danger">*</span></label>
                                    <div class="d-flex gap-2">
                                        <select name="sales_manager" class="form-select" id="salesManagerSelect">
                                            <option value="">-- å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                            {% for worker in internal_workers %}
                                            {% if worker.department == 'sales' or worker.department == 'marketing' %}
                                            <option value="{{ worker.id }}"
                                                    {% if project and worker.name == project.project_manager %}selected{% endif %}
                                                    data-name="{{ worker.name }}"
                                                    data-department="{{ worker.get_department_display }}">
                                                {{ worker.name }} ({{ worker.get_department_display }})
                                            </option>
                                            {% endif %}
                                            {% endfor %}
                                        </select>
                                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openSalesStaffManagementPanel()">
                                            <i class="fas fa-chart-line"></i> å–¶æ¥­ç®¡ç†
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- éµå—ã‘æ¸¡ã—è¨­å®šï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <!-- æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
                                    <div class="d-flex align-items-center mb-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="toggleKeyHandoverSection()" id="keyHandoverToggleBtn">
                                            <i class="fas fa-plus me-1" id="keyHandoverToggleIcon"></i>
                                            <i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’è¿½åŠ 
                                        </button>
                                        <small class="text-muted ms-2">ï¼ˆå¿…è¦ã«å¿œã˜ã¦è¨­å®šã—ã¦ãã ã•ã„ï¼‰</small>
                                    </div>

                                    <!-- æŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ãªè¨­å®šã‚¨ãƒªã‚¢ -->
                                    <div id="keyHandoverSection" style="display: none;">
                                        <div class="alert alert-info small mb-3">
                                            <i class="fas fa-info-circle me-1"></i>
                                            å…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ãŒã€æ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ã§ã™ã€‚
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.key_handover_location.id_for_label }}" class="form-label">
                                                    éµå—ã‘æ¸¡ã—å ´æ‰€
                                                </label>
                                                {{ form.key_handover_location }}
                                                <div class="form-text">éµã®å—ã‘æ¸¡ã—å ´æ‰€ã‚’è¨˜å…¥ã—ã¦ãã ã•ã„ï¼ˆå…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‹ã‚‰è‡ªå‹•å…¥åŠ›ï¼‰</div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="{{ form.key_handover_date.id_for_label }}" class="form-label">
                                                    éµå—ã‘æ¸¡ã—æ—¥æ™‚
                                                </label>
                                                {{ form.key_handover_date }}
                                                <div class="form-text">éµã®å—ã‘æ¸¡ã—äºˆå®šæ—¥æ™‚</div>
                                            </div>
                                            <div class="col-12 mb-3">
                                                <label for="{{ form.key_handover_notes.id_for_label }}" class="form-label">
                                                    éµå—ã‘æ¸¡ã—ãƒ¡ãƒ¢
                                                </label>
                                                {{ form.key_handover_notes }}
                                                <div class="form-text">éµå—ã‘æ¸¡ã—ã«é–¢ã™ã‚‹ç‰¹è¨˜äº‹é …ã‚„ãƒ¡ãƒ¢</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å—æ³¨çŠ¶æ³ -->
                            <div class="row mt-4 mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-handshake me-2"></i>å—æ³¨çŠ¶æ³
                                    </h6>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">å—æ³¨ãƒ¨ãƒŸ <span class="text-danger">*</span></label>
                                    <div class="d-flex gap-2">
                                        <select name="project_status" id="{{ form.project_status.id_for_label }}" class="form-select" required>
                                            <option value="">-- å—æ³¨ãƒ¨ãƒŸã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
                                            <option value="ãƒã‚¿" {% if project and project.project_status == 'ãƒã‚¿' %}selected{% endif %}>ãƒã‚¿ï¼ˆè¦‹è¾¼ã¿æ¡ˆä»¶ï¼‰</option>
                                            <option value="A" {% if project and project.project_status == 'A' %}selected{% endif %}>Aï¼ˆå—æ³¨ç¢ºåº¦é«˜ï¼‰</option>
                                            <option value="B" {% if project and project.project_status == 'B' %}selected{% endif %}>Bï¼ˆå—æ³¨ç¢ºåº¦ä¸­ï¼‰</option>
                                            <option value="å—æ³¨ç¢ºå®š" {% if project and project.project_status == 'å—æ³¨ç¢ºå®š' %}selected{% endif %}>å—æ³¨ç¢ºå®š</option>
                                            <option value="NG" {% if project and project.project_status == 'NG' %}selected{% endif %}>NGï¼ˆå—æ³¨ã§ããšï¼‰</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="{{ form.contract_date.id_for_label }}" class="form-label">
                                        å¥‘ç´„æ—¥
                                    </label>
                                    {{ form.contract_date }}
                                    <small class="text-muted d-block">å—æ³¨ç¢ºå®šæ™‚ã«å…¥åŠ›</small>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- åŸºæœ¬æƒ…å ±ã‚¿ãƒ–çµ‚äº† -->

                        <!-- è¦‹ç©ãƒ»è«‹æ±‚ã‚¿ãƒ– -->
                        <div class="tab-pane" id="order" role="tabpanel" data-section-title="ğŸ’° è¦‹ç©ãƒ»è«‹æ±‚">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-file-invoice-dollar me-2"></i>è¦‹ç©ãƒ»è«‹æ±‚</h5>
                        </div>
                        <div class="card-body">
                            <!-- è¦‹ç©ãƒ»é‡‘é¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-calculator me-2"></i>è¦‹ç©ãƒ»é‡‘é¡
                            </h6>

                            <!-- è¦‹ç©æƒ…å ± -->
                            <div class="row mb-3">
                                <div class="col-md-4 mb-3">
                                    <label for="{{ form.estimate_issued_date.id_for_label }}" class="form-label">
                                        è¦‹ç©æ›¸ç™ºè¡Œæ—¥
                                    </label>
                                    {{ form.estimate_issued_date }}
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">è¦‹ç©æ›¸ã«ã¤ã„ã¦</label>
                                    <div class="form-check mt-2">
                                        <input type="checkbox" class="form-check-input" id="{{ form.estimate_not_required.id_for_label }}" name="{{ form.estimate_not_required.html_name }}" {% if form.estimate_not_required.value %}checked{% endif %}>
                                        <label class="form-check-label" for="{{ form.estimate_not_required.id_for_label }}">
                                            è¦‹ç©æ›¸ä¸è¦
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <!-- å—æ³¨é‡‘é¡ã‚«ãƒ¼ãƒ‰ -->
                            <div class="card border-success mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="fas fa-yen-sign me-2"></i>å—æ³¨é‡‘é¡</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.order_amount.id_for_label }}" class="form-label">
                                                å—æ³¨é‡‘é¡(ç¨æŠœ) <span class="text-danger">*</span>
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">Â¥</span>
                                                {{ form.order_amount }}
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.parking_fee.id_for_label }}" class="form-label">
                                                é§è»Šå ´ä»£
                                            </label>
                                            <div class="input-group">
                                                <span class="input-group-text">Â¥</span>
                                                {{ form.parking_fee }}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-12">
                                            <div class="alert alert-success mb-0">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="fw-bold">å—æ³¨é‡‘é¡ å°è¨ˆ:</span>
                                                    <span class="fs-5 fw-bold">Â¥<span id="orderAmountSubtotal">0</span></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- çµŒè²»é …ç›®ã‚«ãƒ¼ãƒ‰ï¼ˆãƒˆã‚°ãƒ«å¼ï¼‰ -->
                            <div class="card border-warning mb-4">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0" style="cursor: pointer;" onclick="toggleExpenseSection()">
                                            <i class="fas fa-receipt me-2"></i>çµŒè²»ãƒ»è«¸çµŒè²»é …ç›®
                                            <i class="fas fa-chevron-down ms-2" id="expenseToggleIcon"></i>
                                        </h6>
                                        <button type="button" class="btn btn-sm btn-warning" onclick="addExpenseItem()">
                                            <i class="fas fa-plus me-1"></i>é …ç›®è¿½åŠ 
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body" id="expenseSection" style="display: none;">
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 50%;">é …ç›®å</th>
                                                    <th style="width: 40%;">é‡‘é¡</th>
                                                    <th style="width: 10%;">æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="expenseItemsTableBody">
                                                <!-- åˆæœŸé …ç›®ï¼ˆæ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿æŒï¼‰ -->
                                                <tr data-expense-index="1">
                                                    <td>
                                                        {{ form.expense_item_1 }}
                                                    </td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text">Â¥</span>
                                                            {{ form.expense_amount_1 }}
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExpenseItem(this)" title="å‰Šé™¤">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                                <tr data-expense-index="2">
                                                    <td>
                                                        {{ form.expense_item_2 }}
                                                    </td>
                                                    <td>
                                                        <div class="input-group input-group-sm">
                                                            <span class="input-group-text">Â¥</span>
                                                            {{ form.expense_amount_2 }}
                                                        </div>
                                                    </td>
                                                    <td>
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeExpenseItem(this)" title="å‰Šé™¤">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <!-- çµŒè²»åˆè¨ˆï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
                                <div class="card-footer bg-warning bg-opacity-10">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-bold">çµŒè²»åˆè¨ˆ:</span>
                                        <span class="fs-5 fw-bold">Â¥<span id="expenseTotalAmount">0</span></span>
                                    </div>
                                </div>
                            </div>

                            <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆè¿½åŠ é …ç›®ç”¨ï¼‰ -->
                            <div id="additionalExpenseFields"></div>

                            <!-- è«‹æ±‚ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                            <div class="card border-info mb-4">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-invoice me-2"></i>è«‹æ±‚
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ± -->
                                    <div class="row mb-3">
                                        <div class="col-md-12 mb-2">
                                            <small class="text-muted">å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®ä¼šç¤¾ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«è¨­å®šãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ã€‚ä»»æ„ã§ç·¨é›†å¯èƒ½ã§ã™ã€‚</small>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ form.payment_cycle.id_for_label }}" class="form-label">
                                                æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«
                                            </label>
                                            {{ form.payment_cycle }}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ form.closing_day.id_for_label }}" class="form-label">
                                                ç· ã‚æ—¥
                                            </label>
                                            {{ form.closing_day }}
                                            <small class="text-muted d-block">æœˆæœ«ç· ã‚ã®å ´åˆã¯31</small>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ form.payment_offset_months.id_for_label }}" class="form-label">
                                                æ”¯æ‰•æœˆ
                                            </label>
                                            {{ form.payment_offset_months }}
                                            <small class="text-muted d-block">ç· æ—¥ã‹ã‚‰ä½•ãƒ¶æœˆå¾Œ</small>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ form.payment_day.id_for_label }}" class="form-label">
                                                æ”¯æ‰•æ—¥
                                            </label>
                                            {{ form.payment_day }}
                                            <small class="text-muted d-block">ä¾‹: 25</small>
                                        </div>
                                    </div>

                                    <!-- å…¥é‡‘äºˆå®šæ—¥ -->
                                    <div class="row mb-3">
                                        <div class="col-md-6 mb-3">
                                            <label for="{{ form.payment_due_date.id_for_label }}" class="form-label">
                                                å…¥é‡‘äºˆå®šæ—¥ <span class="text-danger">*</span>
                                            </label>

                                            <!-- åŸºæº–æ—¥é¸æŠ -->
                                            <div class="mb-2 p-2 bg-light rounded">
                                                <label class="form-label small mb-1">
                                                    <i class="fas fa-calendar me-1"></i>ç· æ—¥ã®åŸºæº–æ—¥
                                                </label>
                                                <div class="d-flex gap-2 align-items-center flex-wrap">
                                                    <select class="form-select form-select-sm" id="incomingPaymentBaseDateType" style="max-width: 150px;" onchange="updateIncomingPaymentBaseDate()">
                                                        <option value="contract">å¥‘ç´„æ—¥</option>
                                                        <option value="completion">å®Œå·¥æ—¥</option>
                                                        <option value="custom">ä»»æ„æ—¥</option>
                                                    </select>
                                                    <input type="date" class="form-control form-control-sm"
                                                           id="incomingPaymentCustomBaseDate"
                                                           style="max-width: 200px; display: none;"
                                                           onchange="updateIncomingPaymentBaseDate()">
                                                    <span class="text-muted small">
                                                        åŸºæº–æ—¥: <strong id="incomingPaymentBaseDateDisplay">-</strong>
                                                    </span>
                                                </div>
                                                <small class="text-muted d-block mt-1">
                                                    <i class="fas fa-info-circle me-1"></i>ã“ã®æ—¥ä»˜ãŒå…ƒè«‹ä¼šç¤¾ã®ç· æ—¥ã«å…¥ã‚‹ã‹ã©ã†ã‹ã‚’è¨ˆç®—ã—ã¾ã™
                                                </small>
                                            </div>

                                            <div class="input-group">
                                                {{ form.payment_due_date }}
                                                <button type="button" class="btn btn-outline-primary" onclick="autoCalculatePaymentDueDateFromContract()" title="åŸºæº–æ—¥ã‹ã‚‰è‡ªå‹•è¨ˆç®—">
                                                    <i class="fas fa-calculator me-1"></i>è‡ªå‹•è¨ˆç®—
                                                </button>
                                            </div>
                                            <small class="text-muted">æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ã¯å…ƒè«‹ä¼šç¤¾ã®è¨­å®šå€¤ã§ã™ã€‚ç· æ—¥ã«å…¥ã‚‹ã‹ã¯åŸºæº–æ—¥ã§å¤‰ã‚ã‚Šã¾ã™ã€‚</small>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label class="form-label">è«‹æ±‚æ›¸çŠ¶æ³</label>
                                            <div class="form-check mt-2">
                                                <input type="checkbox" class="form-check-input" id="{{ form.invoice_issued.id_for_label }}" name="{{ form.invoice_issued.html_name }}" {% if form.invoice_issued.value %}checked{% endif %}>
                                                <label class="form-check-label" for="{{ form.invoice_issued.id_for_label }}">
                                                    è«‹æ±‚æ›¸ç™ºè¡Œæ¸ˆã¿
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                        </div>
                        <!-- å—æ³¨ãƒ»è¦‹ç©ãƒ»è«‹æ±‚ã‚¿ãƒ–çµ‚äº† -->

                        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
                        <div class="tab-pane" id="schedule" role="tabpanel" data-section-title="ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«">
                            <div class="form-section mb-4">
                                <div class="card shadow-sm">
                                    <div class="card-header bg-gradient-primary text-white py-2">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0"><i class="fas fa-cog me-2"></i>ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†</h6>
                                            <button type="button" class="btn btn-sm btn-light" id="formToggleAllSteps">
                                                <i class="fas fa-expand-alt"></i> <span id="formToggleButtonText">å…¨éƒ¨é–‹ã</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body p-3">
                                        <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéš -->
                                        <div id="formActiveSteps">
                                            <!-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                                        </div>

                                        <!-- åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ— -->
                                        <div id="formStepInventory" class="mt-3">
                                            <hr>
                                            <h6><i class="fas fa-box me-2"></i>åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—</h6>
                                            <div class="row" id="formAvailableSteps">
                                                <!-- åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ãƒœã‚¿ãƒ³ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                                            </div>
                                        </div>

                                        <!-- ã‚¹ãƒ†ãƒƒãƒ—é †åºã¨ãƒ‡ãƒ¼ã‚¿ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                                        <input type="hidden" name="schedule_steps_data" id="formScheduleStepsData" value="">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ–çµ‚äº† -->

                        <!-- æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ– -->
                        <div class="tab-pane" id="staff" role="tabpanel" data-section-title="ğŸ‘¥ æ¥­è€…ãƒ»æ‹…å½“">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-users me-2"></i>å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…æƒ…å ±</h5>
                        </div>
                        <div class="card-body">
                            <!-- è¿½åŠ æ¸ˆã¿å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…ä¸€è¦§ -->
                            <div class="row mb-4">
                                <div class="col-md-12">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-user-cog me-2"></i>å®Ÿæ–½ä½“åˆ¶ä¸€è¦§
                                    </h6>
                                    <div id="implementationList">
                                        <!-- å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹å®Ÿæ–½ä½“åˆ¶ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                                    </div>
                                </div>
                            </div>

                            <!-- å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…è¿½åŠ ãƒœã‚¿ãƒ³ -->
                            <div class="row">
                                <div class="col-md-12 text-center">
                                    <button type="button" class="btn btn-primary btn-lg" onclick="console.log('å®Ÿæ–½ä½“åˆ¶ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ'); try { openAddImplementationModal(); } catch(e) { console.error('å®Ÿæ–½ä½“åˆ¶é–¢æ•°å®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', e); toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message); }">
                                        <i class="fas fa-plus me-2"></i>å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…ã‚’è¿½åŠ 
                                    </button>
                                    <small class="d-block text-muted mt-2">å¤–æ³¨å…ˆã€ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã€ã¾ãŸã¯å¾Œã§æ±ºå®šã‚’è¿½åŠ ã§ãã¾ã™</small>
                                </div>
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ–çµ‚äº† -->

                        <!-- å‚™è€ƒã‚¿ãƒ– -->
                        <div class="tab-pane" id="notes" role="tabpanel" data-section-title="ğŸ“ å‚™è€ƒ">
                            <div class="form-section mb-4">
                        <div class="section-header">
                            <h5><i class="fas fa-sticky-note me-2"></i>å‚™è€ƒ</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="{{ form.notes.id_for_label }}" class="form-label">å‚™è€ƒ</label>
                                {{ form.notes }}
                            </div>
                        </div>
                    </div>
                        </div>
                        <!-- å‚™è€ƒã‚¿ãƒ–çµ‚äº† -->
                    </div>
                    <!-- ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„çµ‚äº† -->

                    <!-- ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒœã‚¿ãƒ³ -->
                    <div class="row mt-4">
                        <div class="col-md-12 text-center">
                            <button type="submit" class="btn btn-success btn-lg me-3" id="submitBtn">
                                <i class="fas fa-save"></i>
                                {% if project %}æ¡ˆä»¶ã‚’æ›´æ–°{% else %}æ¡ˆä»¶ã‚’ç™»éŒ²{% endif %}
                            </button>
                            <a href="{% if project %}{% url 'order_management:project_detail' project.pk %}{% else %}{% url 'order_management:project_list' %}{% endif %}"
                               class="btn btn-secondary btn-lg" id="cancelBtn">
                                <i class="fas fa-times"></i>
                                {% if project %}æˆ»ã‚‹{% else %}ã‚­ãƒ£ãƒ³ã‚»ãƒ«{% endif %}
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>


<!-- æ”¹å–„ç‰ˆ å®Ÿæ–½ä½“åˆ¶ãƒ»æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆPhase 5ã§è¿½åŠ ï¼‰ -->
{% include "order_management/includes/improved_implementation_modal.html" %}
{% include "order_management/includes/improved_implementation_modal_script.html" %}

<!-- æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰ -->
<div class="modal fade" id="staffManagementModalInvalid" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true" style="z-index: 1060; display: none !important;">

                                            <!-- å°‚é–€åˆ†é‡ -->
                                            <div class="mb-3">
                                                <label class="form-label">å°‚é–€åˆ†é‡</label>
                                                <input type="text" name="internal_specialties" class="form-control" id="internalSpecialties" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                                            </div>

                                            <!-- ç¨¼åƒçŠ¶æ³ -->
                                            <div class="mb-3">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" name="internal_is_active" id="internalIsActive" checked>
                                                    <label class="form-check-label" for="internalIsActive">
                                                        ç¨¼åƒä¸­
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- å¾Œã§æ±ºå®šæƒ…å ± -->
                            <div class="row mb-4" id="later_info" style="display: none;">
                                <div class="col-md-12">
                                    <div class="alert alert-warning border-warning">
                                        <div class="d-flex align-items-center mb-2">
                                            <i class="fas fa-clock text-warning me-2"></i>
                                            <strong>å¾Œã§æ±ºå®šï¼ˆè©³ç´°ç”»é¢ï¼‰</strong>
                                        </div>
                                        <small class="text-muted">
                                            è©³ç´°ç”»é¢ã§ã¯ä»¥ä¸‹ã®å®Ÿæ–½ä½“åˆ¶ã‹ã‚‰é¸æŠã§ãã¾ã™ï¼š
                                        </small>
                                        <div class="mt-2 p-2 bg-light rounded">
                                            <div class="form-check mb-1">
                                                <input class="form-check-input" type="radio" disabled>
                                                <label class="form-check-label">
                                                    <i class="fas fa-building me-1"></i>å¤–æ³¨å…ˆã«ç™ºæ³¨
                                                </label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" disabled>
                                                <label class="form-check-label">
                                                    <i class="fas fa-users me-1"></i>ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹
                                                </label>
                                            </div>
                                            <small class="text-muted d-block mt-2">
                                                â€¢ è¤‡æ•°ã®å¤–æ³¨å…ˆã¨ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®çµ„ã¿åˆã‚ã›ã‚‚å¯èƒ½<br>
                                                â€¢ å·¥ç¨‹ã”ã¨ã«ç•°ãªã‚‹å®Ÿæ–½ä½“åˆ¶ã‚’è¨­å®šå¯èƒ½
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffManagementModal" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffManagementModalLabel">
                    <i class="fas fa-users"></i> æ‹…å½“è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">æ‹…å½“è€…ä¸€è¦§</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewStaff()">
                        <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>éƒ¨ç½²</th>
                                <th>æ™‚çµ¦</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç·¨é›†/è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalTitle">æ‹…å½“è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    <div class="mb-3">
                        <label for="staffName" class="form-label">æ‹…å½“è€…å <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="staffName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staffDepartment" class="form-label">éƒ¨ç½²</label>
                        <input type="text" class="form-control" id="staffDepartment" name="department" placeholder="ä¾‹: æ–½å·¥éƒ¨">
                    </div>
                    <div class="mb-3">
                        <label for="staffHourlyRate" class="form-label">æ™‚çµ¦</label>
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control" id="staffHourlyRate" name="hourly_rate" placeholder="ä¾‹: 3000">
                            <span class="input-group-text">/æ™‚é–“</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="staffSpecialties" name="specialties" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="staffActive" name="active" checked>
                        <label class="form-check-label" for="staffActive">
                            æœ‰åŠ¹
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="salesStaffManagementModal" tabindex="-1" aria-labelledby="salesStaffManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="salesStaffManagementModalLabel">
                    <i class="fas fa-chart-line"></i> å–¶æ¥­æ‹…å½“è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">å–¶æ¥­æ‹…å½“è€…ä¸€è¦§</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="openAddSalesStaffModal()">
                        <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                    </button>
                </div>

                <!-- å–¶æ¥­æ‹…å½“è€…ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>éƒ¨ç½²</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="salesStaffTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- å®Ÿç¸¾æ¨ç§»ã‚°ãƒ©ãƒ•äºˆå®šåœ° (ç®¡ç†è€…ã®ã¿è¡¨ç¤º) -->
                {% if user.is_staff or user.is_superuser %}
                <div class="mt-4" style="opacity: 0.6;">
                    <h6 class="mb-3">å®Ÿç¸¾æ¨ç§»</h6>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">åˆ©ç›Šç‡æ¨ç§»</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">æ¡ˆä»¶æ•°æ¨ç§»</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ–°è¦å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="addSalesStaffModal" tabindex="-1" aria-labelledby="addSalesStaffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSalesStaffModalLabel">
                    <i class="fas fa-user-plus"></i> æ–°è¦å–¶æ¥­æ‹…å½“è€…è¿½åŠ 
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSalesStaffForm">
                    <div class="mb-3">
                        <label for="salesStaffName" class="form-label">åå‰ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="salesStaffName" name="name" required placeholder="ä¾‹: ç”°ä¸­ å¤ªéƒ">
                    </div>
                    <div class="mb-3">
                        <label for="salesStaffDepartment" class="form-label">éƒ¨ç½² <span class="text-danger">*</span></label>
                        <select class="form-select" id="salesStaffDepartment" name="department" required>
                            <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
                            <option value="sales">å–¶æ¥­éƒ¨</option>
                            <option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="salesStaffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="salesStaffSpecialties" name="specialties" placeholder="ä¾‹: ä½å®…å–¶æ¥­ã€æ³•äººå–¶æ¥­">
                        <small class="form-text text-muted">ä»»æ„: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥åŠ›å¯</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="submitNewSalesStaff()">
                    <i class="fas fa-save"></i> è¿½åŠ 
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="editSalesStaffModal" tabindex="-1" aria-labelledby="editSalesStaffModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editSalesStaffModalLabel">
                    <i class="fas fa-user-edit"></i> å–¶æ¥­æ‹…å½“è€…ç·¨é›†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editSalesStaffForm">
                    <input type="hidden" id="editSalesStaffId">
                    <div class="mb-3">
                        <label for="editSalesStaffName" class="form-label">åå‰ <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editSalesStaffName" name="name" required placeholder="ä¾‹: ç”°ä¸­ å¤ªéƒ">
                    </div>
                    <div class="mb-3">
                        <label for="editSalesStaffDepartment" class="form-label">éƒ¨ç½² <span class="text-danger">*</span></label>
                        <select class="form-select" id="editSalesStaffDepartment" name="department" required>
                            <option value="">-- éƒ¨ç½²ã‚’é¸æŠ --</option>
                            <option value="sales">å–¶æ¥­éƒ¨</option>
                            <option value="marketing">ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editSalesStaffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="editSalesStaffSpecialties" name="specialties" placeholder="ä¾‹: ä½å®…å–¶æ¥­ã€æ³•äººå–¶æ¥­">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="editSalesStaffIsActive" name="is_active" checked>
                            <label class="form-check-label" for="editSalesStaffIsActive">
                                æœ‰åŠ¹
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="submitEditSalesStaff()">
                    <i class="fas fa-save"></i> ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteSalesStaffModal" tabindex="-1" aria-labelledby="deleteSalesStaffModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deleteSalesStaffModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> å‰Šé™¤ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong id="deleteSalesStaffName"></strong>ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-circle"></i> ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </div>
                <input type="hidden" id="deleteSalesStaffId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" onclick="confirmDeleteSalesStaff()">
                    <i class="fas fa-trash"></i> å‰Šé™¤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ±ç”¨å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="confirmDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle"></i> å‰Šé™¤ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3" id="confirmDeleteMessage">ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-exclamation-circle"></i> ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">
                    <i class="fas fa-trash"></i> å‰Šé™¤
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="craftsmanManagementModal" tabindex="-1" aria-labelledby="craftsmanManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="craftsmanManagementModalLabel">
                    <i class="fas fa-tools"></i> è·äººç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">è·äººä¸€è¦§</h6>
                    <div class="d-flex gap-2">
                        <span class="badge bg-warning">â€» ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å®Ÿè£…äºˆå®š</span>
                        <button type="button" class="btn btn-primary btn-sm" onclick="toastr.info('æ–°è¦è¿½åŠ æ©Ÿèƒ½ã¯å¾Œæ—¥å®Ÿè£…äºˆå®šã§ã™')" disabled>
                            <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- è·äººã‚¹ã‚­ãƒ«ãƒ»å®Ÿç¸¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive" style="opacity: 0.6;">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>è·ç¨®</th>
                                <th>ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>è³‡æ ¼</th>
                                <th>çµŒé¨“å¹´æ•°</th>
                                <th>å®Œäº†æ¡ˆä»¶æ•°</th>
                                <th>å¹³å‡è©•ä¾¡</th>
                                <th>æ™‚çµ¦å˜ä¾¡</th>
                                <th>ç¨¼åƒçŠ¶æ³</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><strong>å±±ç”° è·äºº</strong></td>
                                <td>é›»æ°—å·¥äº‹å£«</td>
                                <td><span class="badge bg-success">ä¸Šç´š</span></td>
                                <td>é«˜åœ§é›»æ°—å·¥äº‹ã€åˆ¶å¾¡ç›¤</td>
                                <td>ç¬¬ä¸€ç¨®é›»æ°—å·¥äº‹å£«ã€é«˜åœ§é›»æ°—å·¥äº‹æŠ€å¸«</td>
                                <td>15å¹´</td>
                                <td><span class="badge bg-primary">245</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜†</span> 4.2</td>
                                <td><strong>Â¥4,500/æ™‚</strong></td>
                                <td><span class="badge bg-success">ç¨¼åƒä¸­</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>é«˜æ©‹ é…ç®¡</strong></td>
                                <td>é…ç®¡å·¥</td>
                                <td><span class="badge bg-info">ä¸­ç´š</span></td>
                                <td>çµ¦æ’æ°´é…ç®¡ã€ç©ºèª¿é…ç®¡</td>
                                <td>é…ç®¡æŠ€èƒ½å£«1ç´šã€ç®¡å·¥äº‹æ–½å·¥ç®¡ç†æŠ€å£«</td>
                                <td>8å¹´</td>
                                <td><span class="badge bg-primary">112</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜†</span> 3.8</td>
                                <td><strong>Â¥3,200/æ™‚</strong></td>
                                <td><span class="badge bg-warning">ç©ºã</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr>
                                <td><strong>ä¼Šè—¤ å¤§å·¥</strong></td>
                                <td>å¤§å·¥</td>
                                <td><span class="badge bg-success">ä¸Šç´š</span></td>
                                <td>æœ¨é€ å»ºç¯‰ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ã€å†…è£…</td>
                                <td>å»ºç¯‰å¤§å·¥æŠ€èƒ½å£«1ç´šã€å»ºç¯‰æ–½å·¥ç®¡ç†æŠ€å£«</td>
                                <td>20å¹´</td>
                                <td><span class="badge bg-primary">320</span></td>
                                <td><span class="text-warning">â˜…â˜…â˜…â˜…â˜…</span> 4.7</td>
                                <td><strong>Â¥4,000/æ™‚</strong></td>
                                <td><span class="badge bg-success">ç¨¼åƒä¸­</span></td>
                                <td>
                                    <button class="btn btn-sm btn-outline-secondary" disabled>
                                        <i class="fas fa-edit"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ã‚¹ã‚­ãƒ«çµ±è¨ˆ -->
                <div class="mt-4" style="opacity: 0.6;">
                    <h6 class="mb-3">ã‚¹ã‚­ãƒ«çµ±è¨ˆ</h6>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">è·ç¨®åˆ¥åˆ†å¸ƒ</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">å††ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ã‚¹ã‚­ãƒ«ãƒ¬ãƒ™ãƒ«åˆ†å¸ƒ</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">æ£’ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">ç¨¼åƒçŠ¶æ³</h6>
                                </div>
                                <div class="card-body">
                                    <div style="height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center;">
                                        <span class="text-muted">ç¨¼åƒçŠ¶æ³ã‚°ãƒ©ãƒ•è¡¨ç¤ºäºˆå®š</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="contractorManagementModal" tabindex="-1" aria-labelledby="contractorManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog" style="max-width: 95vw; width: 95vw;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorManagementModalLabel">
                    <i class="fas fa-building"></i> æ¥­è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <h6 class="mb-2">æ¥­è€…ä¸€è¦§</h6>
                        <div class="d-flex gap-3">
                            <span class="badge bg-success bg-opacity-25 text-success border border-success">
                                <i class="fas fa-circle me-1"></i>å—æ³¨æ¥­è€…
                            </span>
                            <span class="badge bg-warning bg-opacity-25 text-warning border border-warning">
                                <i class="fas fa-circle me-1"></i>ç™ºæ³¨æ¥­è€…
                            </span>
                            <span class="badge bg-light text-dark border">
                                <i class="fas fa-circle me-1"></i>ãã®ä»–
                            </span>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewContractor()">
                        <i class="fas fa-plus"></i> æ–°è¦æ¥­è€…è¿½åŠ 
                    </button>
                </div>

                <!-- æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="text" id="contractorSearch" class="form-control" placeholder="æ¥­è€…åãƒ»é›»è©±ãƒ»ãƒ¡ãƒ¼ãƒ«ã§æ¤œç´¢" onkeyup="filterContractors()">
                    </div>
                    <div class="col-md-3">
                        <select id="contractorTypeFilter" class="form-select" onchange="filterContractors()">
                            <option value="">å…¨ã‚¿ã‚¤ãƒ—</option>
                            <option value="ordering">ç™ºæ³¨æ¥­è€…</option>
                            <option value="receiving">å—æ³¨æ¥­è€…</option>
                            <option value="supplier">è³‡æå±‹</option>
                            <option value="other">ãã®ä»–</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="contractorStatusFilter" class="form-select" onchange="filterContractors()">
                            <option value="">å…¨çŠ¶æ…‹</option>
                            <option value="active">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
                            <option value="inactive">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="clearContractorFilters()">
                            <i class="fas fa-times"></i> ã‚¯ãƒªã‚¢
                        </button>
                    </div>
                </div>

                <!-- æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive" style="max-height: 60vh; overflow-y: auto;">
                    <table class="table table-hover contractor-table">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th style="min-width: 200px; cursor: pointer;" onclick="sortContractorTable('name')">
                                    æ¥­è€…å <i class="fas fa-sort"></i>
                                </th>
                                <th style="min-width: 200px;">æ¥­è€…ã‚¿ã‚¤ãƒ—</th>
                                <th style="min-width: 150px;">å°‚é–€åˆ†é‡</th>
                                <th style="min-width: 300px;">ä½æ‰€</th>
                                <th style="min-width: 140px;">é›»è©±ç•ªå·</th>
                                <th style="min-width: 200px;">ãƒ¡ãƒ¼ãƒ«</th>
                                <th style="min-width: 120px;">æ‹…å½“è€…</th>
                                <th style="min-width: 100px; cursor: pointer;" onclick="sortContractorTable('status')">
                                    çŠ¶æ…‹ <i class="fas fa-sort"></i>
                                </th>
                                <th style="min-width: 100px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="contractorTableBody">
                            <!-- æ¥­è€…æƒ…å ±ãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>

                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆ/orders/contractors/new/ ã¨åŒã˜ãƒ•ã‚©ãƒ¼ãƒ ï¼‰ -->
<div class="modal fade" id="contractorModal" tabindex="-1" aria-labelledby="contractorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorModalTitle">æ¥­è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="contractorForm">
                    <input type="hidden" id="contractorId" name="id">

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div class="mb-3">
                        <label for="contractorName" class="form-label">æ¥­è€…å <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="contractorName" name="name" required>
                    </div>

                    <div class="mb-3">
                        <label for="contractorType" class="form-label">æ¥­è€…ç¨®åˆ¥ <span class="text-danger">*</span></label>
                        <select class="form-select" id="contractorType" name="contractor_type" required onchange="toggleModalHourlyRateField()">
                            <option value="">-- æ¥­è€…ç¨®åˆ¥ã‚’é¸æŠ --</option>
                            <option value="individual">å€‹äººè·äºº</option>
                            <option value="company">å”åŠ›ä¼šç¤¾</option>
                            <option value="material">è³‡æ</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="contractorAddress" class="form-label">ä½æ‰€</label>
                        <input type="text" class="form-control" id="contractorAddress" name="address">
                    </div>

                    <div class="mb-3">
                        <label for="contractorPhone" class="form-label">é›»è©±ç•ªå·</label>
                        <input type="tel" class="form-control" id="contractorPhone" name="phone">
                    </div>

                    <div class="mb-3">
                        <label for="contractorEmail" class="form-label">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</label>
                        <input type="email" class="form-control" id="contractorEmail" name="email">
                    </div>

                    <div class="mb-3">
                        <label for="contractorContactPerson" class="form-label">æ‹…å½“è€…å</label>
                        <input type="text" class="form-control" id="contractorContactPerson" name="contact_person">
                    </div>

                    <div class="mb-3" id="modalHourlyRateField" style="display: none;">
                        <label for="contractorHourlyRate" class="form-label">æ™‚çµ¦å˜ä¾¡ï¼ˆå††ï¼‰</label>
                        <input type="number" class="form-control" id="contractorHourlyRate" name="hourly_rate" min="0" step="100">
                        <small class="form-text text-muted">ä»»æ„: ã‚³ã‚¹ãƒˆè¨ˆç®—ç”¨ï¼ˆå€‹äººè·äººã®ã¿ï¼‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="contractorSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="contractorSpecialties" name="specialties" placeholder="ä¾‹: æœ¨é€ å»ºç¯‰ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ">
                        <small class="form-text text-muted">ä»»æ„: ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§è¤‡æ•°å…¥åŠ›å¯</small>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="contractorActive" name="is_active" checked>
                        <label class="form-check-label" for="contractorActive">
                            ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                        </label>
                    </div>

                    <!-- æ”¯æ‰•ã„æƒ…å ± -->
                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="fas fa-money-bill me-2"></i>æ”¯æ‰•ã„æƒ…å ±
                    </h6>

                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="contractorPaymentCycle" class="form-label">æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«</label>
                                <select class="form-select" id="contractorPaymentCycle" name="payment_cycle">
                                    <option value="">-- é¸æŠ --</option>
                                    <option value="monthly">æœˆæ‰•ã„</option>
                                    <option value="bimonthly">éš”æœˆæ‰•ã„</option>
                                    <option value="quarterly">å››åŠæœŸæ‰•ã„</option>
                                    <option value="custom">ãã®ä»–</option>
                                </select>
                                <small class="form-text text-muted">æœˆæ‰•ã„ã€éš”æœˆæ‰•ã„ãªã©</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="contractorClosingDay" class="form-label">ç· æ—¥</label>
                                <input type="number" class="form-control" id="contractorClosingDay" name="closing_day" min="1" max="31">
                                <small class="form-text text-muted">æ¯æœˆã®ç· æ—¥ï¼ˆ1-31ï¼‰</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="contractorPaymentOffsetMonths" class="form-label">æ”¯æ‰•æœˆ</label>
                                <select class="form-select" id="contractorPaymentOffsetMonths" name="payment_offset_months">
                                    <option value="">-- é¸æŠ --</option>
                                    <option value="0">å½“æœˆ</option>
                                    <option value="1">ç¿Œæœˆ</option>
                                    <option value="2">ç¿Œã€…æœˆ</option>
                                    <option value="3">3ãƒ¶æœˆå¾Œ</option>
                                </select>
                                <small class="form-text text-muted">å½“æœˆã€ç¿Œæœˆã€ç¿Œã€…æœˆãªã©</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="contractorPaymentDay" class="form-label">æ”¯æ‰•æ—¥</label>
                                <input type="number" class="form-control" id="contractorPaymentDay" name="payment_day" min="1" max="31">
                                <small class="form-text text-muted">æ¯æœˆã®æ”¯æ‰•æ—¥ï¼ˆ1-31ï¼‰</small>
                            </div>
                        </div>
                    </div>

                    <!-- éŠ€è¡Œå£åº§æƒ…å ± -->
                    <hr class="my-4">
                    <h6 class="mb-3">
                        <i class="fas fa-university me-2"></i>éŠ€è¡Œå£åº§æƒ…å ±
                    </h6>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractorBankName" class="form-label">éŠ€è¡Œå</label>
                                <input type="text" class="form-control" id="contractorBankName" name="bank_name">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractorBranchName" class="form-label">æ”¯åº—å</label>
                                <input type="text" class="form-control" id="contractorBranchName" name="branch_name">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractorAccountType" class="form-label">å£åº§ç¨®åˆ¥</label>
                                <select class="form-select" id="contractorAccountType" name="account_type">
                                    <option value="">-- é¸æŠ --</option>
                                    <option value="ordinary">æ™®é€š</option>
                                    <option value="current">å½“åº§</option>
                                    <option value="savings">è²¯è“„</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="contractorAccountNumber" class="form-label">å£åº§ç•ªå·</label>
                                <input type="text" class="form-control" id="contractorAccountNumber" name="account_number">
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="contractorAccountHolder" class="form-label">å£åº§åç¾©</label>
                        <input type="text" class="form-control" id="contractorAccountHolder" name="account_holder">
                        <small class="form-text text-muted">ä»»æ„: ã‚«ã‚¿ã‚«ãƒŠã§å…¥åŠ›ï¼ˆä¾‹: ã‚«ï¼‰ãƒãƒ«ãƒãƒ«ã‚±ãƒ³ã‚»ãƒ„ï¼‰</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveContractor()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Toastr JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

<!-- Sortable.js for drag-and-drop -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

<script>
// Phase 2.2ã§è¿½åŠ : contractorsãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã§åˆ©ç”¨å¯èƒ½ã«ã™ã‚‹
window.contractors_json = {{ contractors_json|safe }};
console.log('âœ… contractors_json loaded:', window.contractors_json ? window.contractors_json.length : 0, 'contractors');

// ãƒ•ã‚©ãƒ¼ãƒ å¤‰æ›´çŠ¶æ…‹ã®ç®¡ç†
let formChanged = false;
let originalFormData = {};
let hasFormBeenModified = false; // ã‚·ãƒ³ãƒ—ãƒ«ãªãƒ•ãƒ©ã‚°

// ãƒ•ã‚©ãƒ¼ãƒ ã®åˆæœŸå€¤ã‚’ä¿å­˜
function saveOriginalFormData() {
    const form = document.querySelector('form');
    if (!form) return;

    const formData = new FormData(form);
    originalFormData = {};
    for (let [key, value] of formData.entries()) {
        originalFormData[key] = value;
    }
    console.log('Original form data saved:', Object.keys(originalFormData).length, 'fields');
}

// ãƒ•ã‚©ãƒ¼ãƒ ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
function checkFormChanges() {
    const form = document.querySelector('form');
    if (!form) return false;

    const currentFormData = new FormData(form);
    let hasChanges = false;

    // ç¾åœ¨ã®å€¤ã¨åˆæœŸå€¤ã‚’æ¯”è¼ƒ
    for (let [key, value] of currentFormData.entries()) {
        if (originalFormData[key] !== value) {
            hasChanges = true;
            break;
        }
    }

    // å‰Šé™¤ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒã‚§ãƒƒã‚¯
    if (!hasChanges) {
        for (let key in originalFormData) {
            if (!currentFormData.has(key)) {
                hasChanges = true;
                break;
            }
        }
    }

    return hasChanges;
}

// ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
function updateButtonText() {
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const isEdit = {{ project|yesno:"true,false" }};

    if (!isEdit) return; // æ–°è¦ä½œæˆã®å ´åˆã¯å¤‰æ›´ã—ãªã„

    const hasChanges = checkFormChanges();

    if (hasChanges) {
        submitBtn.innerHTML = '<i class="fas fa-save"></i> æ¡ˆä»¶ã‚’æ›´æ–°';
        submitBtn.className = 'btn btn-warning btn-lg me-3';
        submitBtn.disabled = false;
        formChanged = true;
    } else {
        submitBtn.innerHTML = '<i class="fas fa-check"></i> ä¿å­˜æ¸ˆã¿';
        submitBtn.className = 'btn btn-success btn-lg me-3';
        submitBtn.disabled = true;
        formChanged = false;
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æˆåŠŸæ™‚ã®å‡¦ç†
function handleFormSubmitSuccess() {
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    submitBtn.innerHTML = '<i class="fas fa-check"></i> æ›´æ–°å®Œäº†';
    submitBtn.className = 'btn btn-success btn-lg me-3';
    submitBtn.disabled = true;

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’ã€Œæˆ»ã‚‹ã€ã«å¤‰æ›´
    cancelBtn.innerHTML = '<i class="fas fa-arrow-left"></i> æˆ»ã‚‹';

    // ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ï¼ˆé€ä¿¡æˆåŠŸãªã®ã§ä¸è¦ï¼‰
    clearSavedFormValues();

    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
    setTimeout(() => {
        saveOriginalFormData(); // æ–°ã—ã„çŠ¶æ…‹ã‚’åˆæœŸå€¤ã¨ã—ã¦ä¿å­˜
        updateButtonText();
    }, 2000);
}

$(document).ready(function() {
    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ ãŒå®Œå…¨ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã¾ã§ï¼‰
    setTimeout(function() {
        // åˆæœŸå€¤ã‚’ä¿å­˜
        saveOriginalFormData();

        // åˆæœŸçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
        updateButtonText();

        // ãƒ•ã‚©ãƒ¼ãƒ å…¨ä½“ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ï¼‰
        const isEdit = {{ project|yesno:"true,false" }};

        if (isEdit) {
            // ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’ç›´æ¥å–å¾—ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const $form = $('form');

            // ãƒ•ã‚©ãƒ¼ãƒ å†…ã®å…¨è¦ç´ ã«ç›´æ¥ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
            $form.find('input, select, textarea').on('input change', function(e) {
                // å°‘ã—é…å»¶ã•ã›ã¦ã‹ã‚‰æ›´æ–°ï¼ˆé€£ç¶šã—ãŸå¤‰æ›´ã‚’ã¾ã¨ã‚ã‚‹ï¼‰
                clearTimeout(window.formChangeTimeout);
                window.formChangeTimeout = setTimeout(function() {
                    updateButtonText();
                }, 100);
            });
        }
    }, 100);

    // å—æ³¨ãƒ¨ãƒŸã®å¤‰æ›´ã‚’å‡¦ç†ï¼ˆNGæ™‚ã®é€²æ—ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã®ãŸã‚ï¼‰
    $('select[name="project_status"]').on('change', function(e) {
        const projectId = {{ project.pk|default:"null" }};
        const newValue = $(this).val();

        // æ–°è¦ä½œæˆã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
        if (!projectId) {
            return;
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€NGã«å¤‰æ›´ã—ãŸæ™‚ã®ã¿å³åº§ã«AJAXä¿å­˜
        // ï¼ˆé€²æ—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ï¼‰
        if (newValue === 'NG') {
            const csrfToken = $('[name=csrfmiddlewaretoken]').val();

            $.ajax({
                url: '/orders/' + projectId + '/update-forecast/',
                method: 'POST',
                data: {
                    project_status: newValue,
                    csrfmiddlewaretoken: csrfToken
                },
                success: function(response) {
                    if (response.success) {
                        // åˆæœŸå€¤ã‚’æ›´æ–°
                        originalFormData['project_status'] = newValue;
                        // ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
                        updateButtonText();
                        toastr.warning('NGã«è¨­å®šã—ã€é–¢é€£ã™ã‚‹é€²æ—ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
                    } else {
                        toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                    }
                },
                error: function() {
                    toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            });
        }
        // NGä»¥å¤–ã®å ´åˆã¯ã€é€šå¸¸ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã§ä¿å­˜
    });

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®å‡¦ç†
    $('#projectForm').on('submit', function(e) {
        e.preventDefault(); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é€ä¿¡ã‚’é˜²ã

        const form = this;
        const submitBtn = document.getElementById('submitBtn');
        const formData = new FormData(form);

        // é€ä¿¡ä¸­ã®è¡¨ç¤º
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> æ›´æ–°ä¸­...';
        submitBtn.disabled = true;

        // AJAXé€ä¿¡
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒJSONã§ãªã„å ´åˆã®å‡¦ç†
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                return response.text().then(text => {
                    throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰äºˆæœŸã—ãªã„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒè¿”ã•ã‚Œã¾ã—ãŸã€‚');
                });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // æˆåŠŸæ™‚ã®å‡¦ç†
                handleFormSubmitSuccess();

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                if (data.message) {
                    // Bootstrap toast ã¾ãŸã¯ alert ã§æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                    showSuccessMessage(data.message);
                }

                // 2ç§’å¾Œã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
                setTimeout(() => {
                    if (data.redirect_url) {
                        window.location.href = data.redirect_url;
                    }
                }, 2000);
            } else {
                // ã‚¨ãƒ©ãƒ¼æ™‚ã®å‡¦ç†
                submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                submitBtn.className = 'btn btn-danger btn-lg me-3';
                submitBtn.disabled = false;

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorMessage = data.message || 'ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                if (data.errors) {
                    console.log('Form errors:', data.errors);
                    // ã‚¨ãƒ©ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
                    const errorDetails = Object.entries(data.errors).map(([field, errors]) =>
                        `${field}: ${Array.isArray(errors) ? errors.join(', ') : errors}`
                    ).join('\n');
                    errorMessage += '\nè©³ç´°:\n' + errorDetails;
                }
                showErrorMessage(errorMessage);

                // 3ç§’å¾Œã«å…ƒã«æˆ»ã™
                setTimeout(() => {
                    updateButtonText();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> é€šä¿¡ã‚¨ãƒ©ãƒ¼';
            submitBtn.className = 'btn btn-danger btn-lg me-3';
            submitBtn.disabled = false;

            // 3ç§’å¾Œã«å…ƒã«æˆ»ã™
            setTimeout(() => {
                updateButtonText();
            }, 3000);
        });
    });

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showSuccessMessage(message) {
        // ç°¡å˜ãªã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦Bootstrap toastã«å¤‰æ›´å¯èƒ½ï¼‰
        const alertDiv = $(`
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('.container').first().prepend(alertDiv);

        // 5ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            alertDiv.alert('close');
        }, 5000);
    }

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showErrorMessage(message) {
        const alertDiv = $(`
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('.container').first().prepend(alertDiv);

        // 10ç§’å¾Œã«è‡ªå‹•ã§éè¡¨ç¤º
        setTimeout(() => {
            alertDiv.alert('close');
        }, 10000);
    }
});
</script>
<script>
console.log('ğŸ”¥ JavaScript loading...');

// å¿…é ˆé–¢æ•°ã‚’å®šç¾©
window.openBasicInfoContractorManagementPanel = function() {
    console.log('âœ… openBasicInfoContractorManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#contractorManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆå—æ³¨æ¥­è€…å„ªå…ˆï¼‰
            refreshContractorListForBasicInfo();

            console.log('âœ… æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ contractorManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.openAddImplementationModal = function() {
    console.log('âœ… openAddImplementationModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#addImplementationModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            clearImplementationModalForms();

            // åˆæœŸçŠ¶æ…‹ã‚’å¤–æ³¨å…ˆã«è¨­å®š
            $('input[name="modal_implementation_type"][value="outsource"]').prop('checked', true);
            toggleImplementationType();

            // æ¥­è€…é¸æŠæ–¹æ³•ã‚’æ—¢å­˜ã‹ã‚‰é¸æŠã«åˆæœŸè¨­å®š
            $('input[name="modal_contractor_input_type"][value="existing"]').prop('checked', true);
            toggleContractorInputType();

            // ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•ã‚’æ—¢å­˜ã‹ã‚‰é¸æŠã«åˆæœŸè¨­å®š
            $('input[name="modal_internal_input_type"][value="existing"]').prop('checked', true);
            toggleInternalInputType();

            console.log('âœ… å®Ÿæ–½ä½“åˆ¶ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ addImplementationModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚HTMLã«ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.closeModal = function(modalId) {
    if (modalId) {
        $(`#${modalId}`).removeClass('show').css('display', 'none');
    } else {
        $('.modal').removeClass('show').css('display', 'none');
    }
    $('.modal-backdrop').remove();

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
    $('body').removeClass('modal-open').css('overflow', '');

    console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ:', modalId || 'all');
};

// è¿½åŠ ã®å¿…é ˆé–¢æ•°ã‚’å®šç¾©
window.openSalesStaffManagementPanel = function() {
    console.log('âœ… openSalesStaffManagementPanel called');

    try {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modalElement = document.getElementById('salesStaffManagementModal');
        if (modalElement) {
            // Bootstrap Modal APIã‚’ä½¿ç”¨ã—ã¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: true,
                keyboard: true
            });
            modal.show();

            // å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            refreshSalesStaffList();

            console.log('âœ… å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ salesStaffManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.refreshSalesStaffList = function() {
    console.log('âœ… refreshSalesStaffList called');

    // jQueryãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof $ === 'undefined') {
        console.error('jQuery is not loaded in refreshSalesStaffList');
        return;
    }

    const tbody = $('#salesStaffTableBody');
    tbody.html('<tr><td colspan="5" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td></tr>');

    // AJAXã§æœ€æ–°ã®å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    $.ajax({
        url: '{% url "order_management:staff_api" %}',
        method: 'GET',
        success: function(response) {
            if (response.success && response.workers) {
                // å–¶æ¥­æ‹…å½“è€…ï¼ˆdepartment ãŒ sales ã¾ãŸã¯ marketingï¼‰ã®ã¿ãƒ•ã‚£ãƒ«ã‚¿
                const salesStaff = response.workers.filter(worker =>
                    worker.department === 'sales' || worker.department === 'marketing'
                );

                if (salesStaff.length === 0) {
                    tbody.html('<tr><td colspan="5" class="text-center text-muted">å–¶æ¥­æ‹…å½“è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>');
                    return;
                }

                let html = '';
                salesStaff.forEach(function(staff) {
                    const departmentDisplay = staff.department === 'sales' ? 'å–¶æ¥­éƒ¨' :
                                             staff.department === 'marketing' ? 'ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°éƒ¨' : staff.department;
                    const statusBadge = staff.is_active ?
                        '<span class="badge bg-success">æœ‰åŠ¹</span>' :
                        '<span class="badge bg-secondary">ç„¡åŠ¹</span>';
                    const specialties = staff.specialties || '-';

                    html += `
                        <tr style="cursor: pointer;" onclick="selectSalesStaff(${staff.id})" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                            <td><strong>${staff.name}</strong></td>
                            <td>${departmentDisplay}</td>
                            <td>${specialties}</td>
                            <td>${statusBadge}</td>
                            <td onclick="event.stopPropagation()">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editSalesStaff(${staff.id})" title="ç·¨é›†">
                                    <i class="fas fa-edit"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });

                tbody.html(html);
                console.log('âœ… å–¶æ¥­æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã—ã¾ã—ãŸ:', salesStaff.length + 'ä»¶');
            } else {
                tbody.html('<tr><td colspan="5" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>');
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);
            tbody.html('<tr><td colspan="5" class="text-center text-danger">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</td></tr>');
        }
    });
};

// å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
window.selectSalesStaff = function(staffId) {
    console.log('âœ… selectSalesStaff called', staffId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹ï¼ˆBootstrap Modal APIã‚’ä½¿ç”¨ï¼‰
    const modalElement = document.getElementById('salesStaffManagementModal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«é¸æŠã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹IDãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
    const selectElement = $('#salesManagerSelect');
    const existingOption = selectElement.find(`option[value="${staffId}"]`);

    if (existingOption.length === 0) {
        // å­˜åœ¨ã—ãªã„å ´åˆã€APIã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¿½åŠ 
        console.log('âš ï¸ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«å–¶æ¥­æ‹…å½“è€…ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€å–å¾—ä¸­...', staffId);

        $.ajax({
            url: '{% url "order_management:staff_api" %}',
            method: 'GET',
            success: function(response) {
                if (response.success && response.workers) {
                    // é¸æŠã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹å–¶æ¥­æ‹…å½“è€…ã‚’æ¢ã™
                    const staff = response.workers.find(w => w.id == staffId);
                    if (staff) {
                        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
                        const newOption = $('<option></option>')
                            .val(staff.id)
                            .text(staff.name)
                            .data('name', staff.name)
                            .data('department', staff.department)
                            .data('hourly-rate', staff.hourly_rate);

                        selectElement.append(newOption);
                        selectElement.val(staffId).trigger('change');

                        console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ã—ã¦é¸æŠã—ã¾ã—ãŸ:', staff.name);
                    } else {
                        console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ:', staffId);
                        toastr.error('å–¶æ¥­æ‹…å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ å–¶æ¥­æ‹…å½“è€…ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', error);
                toastr.error('å–¶æ¥­æ‹…å½“è€…ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        });
    } else {
        // æ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯é€šå¸¸é€šã‚Šé¸æŠ
        selectElement.val(staffId).trigger('change');
        console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’é¸æŠã—ã¾ã—ãŸ:', staffId);
    }
};

window.openAddSalesStaffModal = function() {
    console.log('âœ… openAddSalesStaffModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢/ãƒªã‚»ãƒƒãƒˆ
    const form = document.getElementById('addSalesStaffForm');
    if (form) form.reset();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modalElement = document.getElementById('addSalesStaffModal');
    const modal = new bootstrap.Modal(modalElement);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã€backdropã®z-indexã‚’èª¿æ•´
    modalElement.addEventListener('shown.bs.modal', function() {
        // æœ€å¾Œã«è¿½åŠ ã•ã‚ŒãŸbackdropï¼ˆã“ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã®backdropï¼‰ã®z-indexã‚’èª¿æ•´
        const backdrops = document.querySelectorAll('.modal-backdrop');
        if (backdrops.length > 0) {
            const lastBackdrop = backdrops[backdrops.length - 1];
            lastBackdrop.style.zIndex = '10040';
        }
    }, { once: true });

    modal.show();
};

window.submitNewSalesStaff = function() {
    console.log('âœ… submitNewSalesStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const nameEl = document.getElementById('salesStaffName');
    const departmentEl = document.getElementById('salesStaffDepartment');
    const hourlyRateEl = document.getElementById('salesStaffHourlyRate');
    const specialtiesEl = document.getElementById('salesStaffSpecialties');

    const name = nameEl ? nameEl.value.trim() : '';
    const department = departmentEl ? departmentEl.value : '';
    const hourlyRateStr = hourlyRateEl ? hourlyRateEl.value : '';
    const hourlyRate = hourlyRateStr ? parseFloat(hourlyRateStr) : 0;
    const specialties = specialtiesEl ? specialtiesEl.value.trim() : '';

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name) {
        if (typeof toastr !== 'undefined') {
            toastr.error('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        } else {
            alert('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        }
        return;
    }

    if (!department) {
        if (typeof toastr !== 'undefined') {
            toastr.error('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        } else {
            alert('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        }
        return;
    }

    // æ–°è¦å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ 
    addNewSalesStaff({
        name: name,
        department: department,
        hourly_rate: hourlyRate,
        specialties: specialties
    });
};

window.addNewSalesStaff = function(staffData) {
    console.log('âœ… addNewSalesStaff called', staffData);

    // jQueryãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
    if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
        console.error('jQuery is not loaded');
        alert('ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
        return;
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ–°è¦å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ï¼ˆAJAXï¼‰
    $.ajax({
        url: '{% url "subcontract_management:add_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            name: staffData.name,
            department: staffData.department,
            hourly_rate: staffData.hourly_rate,
            specialties: staffData.specialties,
            is_active: true
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('addSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${staffData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                refreshSalesStaffList();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«æ–°ã—ã„å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ãªã—ï¼‰
                const newStaffId = response.staff_id;
                const newOption = $('<option></option>')
                    .val(newStaffId)
                    .text(staffData.name)
                    .data('name', staffData.name)
                    .data('department', staffData.department)
                    .data('hourly-rate', staffData.hourly_rate);

                $('#salesManagerSelect').append(newOption);

                // æ–°ã—ãè¿½åŠ ã—ãŸå–¶æ¥­æ‹…å½“è€…ã‚’è‡ªå‹•é¸æŠ
                $('#salesManagerSelect').val(newStaffId).trigger('change');

                console.log('âœ… å–¶æ¥­æ‹…å½“è€…ã‚’è¿½åŠ ã—ã€è‡ªå‹•é¸æŠã—ã¾ã—ãŸ');
            } else {
                toastr.error(response.message || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†
window.editSalesStaff = function(staffId) {
    console.log('âœ… editSalesStaff called for ID:', staffId);

    // ã‚¹ã‚¿ãƒƒãƒ•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const allInternalWorkers = {{ internal_workers_json|safe }};
    const staff = allInternalWorkers.find(w => w.id === staffId);

    if (!staff) {
        toastr.error('ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    $('#editSalesStaffId').val(staff.id);
    $('#editSalesStaffName').val(staff.name);
    $('#editSalesStaffDepartment').val(staff.department);
    $('#editSalesStaffHourlyRate').val(staff.hourly_rate || '');
    $('#editSalesStaffSpecialties').val(staff.specialties || '');
    $('#editSalesStaffIsActive').prop('checked', staff.is_active);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('editSalesStaffModal'));
    modal.show();
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ã‚’ä¿å­˜
window.submitEditSalesStaff = function() {
    console.log('âœ… submitEditSalesStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const staffId = $('#editSalesStaffId').val();
    const name = $('#editSalesStaffName').val().trim();
    const department = $('#editSalesStaffDepartment').val();
    const hourlyRateStr = $('#editSalesStaffHourlyRate').val();
    const hourlyRate = hourlyRateStr ? parseFloat(hourlyRateStr) : 0;
    const specialties = $('#editSalesStaffSpecialties').val().trim();
    const isActive = $('#editSalesStaffIsActive').is(':checked');

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name) {
        toastr.error('åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    if (!department) {
        toastr.error('éƒ¨ç½²ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    $.ajax({
        url: '{% url "subcontract_management:update_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            staff_id: staffId,
            name: name,
            department: department,
            hourly_rate: hourlyRate,
            specialties: specialties,
            is_active: isActive
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('editSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${name}ã®æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(response.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
window.deleteSalesStaff = function(staffId, staffName) {
    console.log('âœ… deleteSalesStaff called for ID:', staffId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    $('#deleteSalesStaffId').val(staffId);
    $('#deleteSalesStaffName').text(staffName);

    // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('deleteSalesStaffModal'));
    modal.show();
};

// å–¶æ¥­ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤ã‚’å®Ÿè¡Œ
window.confirmDeleteSalesStaff = function() {
    console.log('âœ… confirmDeleteSalesStaff called');

    const staffId = $('#deleteSalesStaffId').val();
    const staffName = $('#deleteSalesStaffName').text();

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
    $.ajax({
        url: '{% url "subcontract_management:delete_internal_worker" %}',
        method: 'POST',
        data: {
            csrfmiddlewaretoken: csrftoken,
            staff_id: staffId
        },
        success: function(response) {
            if (response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('deleteSalesStaffModal'));
                if (modal) {
                    modal.hide();
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                toastr.success(`${staffName}ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);

                // ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(response.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (error) {
                errorMessage = `å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error}`;
            }

            toastr.error(errorMessage);
        }
    });
};

window.openContractorManagementPanel = function() {
    console.log('âœ… openContractorManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#contractorManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆç™ºæ³¨æ¥­è€…å„ªå…ˆï¼‰
            refreshContractorListForImplementation();

            console.log('âœ… å·¥äº‹æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ contractorManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('å·¥äº‹æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.openCraftsmanManagementPanel = function() {
    console.log('âœ… openCraftsmanManagementPanel called');

    try {
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚’å‰Šé™¤
        $('.modal-backdrop').remove();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã‚’å–å¾—
        const modal = $('#craftsmanManagementModal');
        if (modal.length > 0) {
            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
            $('body').addClass('modal-open').css('overflow', 'hidden');

            modal.css('display', 'block').addClass('show');
            $('body').append('<div class="modal-backdrop fade show"></div>');

            // è·äººãƒªã‚¹ãƒˆã‚’æ›´æ–°
            refreshCraftsmanList();

            console.log('âœ… è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ');
        } else {
            console.error('âŒ craftsmanManagementModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('è·äººç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
        }
    } catch(e) {
        console.error('Error:', e);
        toastr.error('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
};

window.addImplementationItem = function() {
    console.log('âœ… addImplementationItem called');

    const implementationType = $('input[name="modal_implementation_type"]:checked').val();

    if (!implementationType) {
        toastr.warning('å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    let itemData = {
        type: implementationType,
        id: Date.now() // ç°¡æ˜“çš„ãªID
    };

    if (implementationType === 'outsource') {
        // å¤–æ³¨å…ˆã®æƒ…å ±ã‚’å–å¾—
        const contractorInputType = $('input[name="modal_contractor_input_type"]:checked').val();
        let contractorName = '';

        if (contractorInputType === 'existing') {
            // æ—¢å­˜æ¥­è€…ã‹ã‚‰é¸æŠ
            const selectedOption = $('#modalContractorSelect option:selected');
            contractorName = selectedOption.data('name') || selectedOption.text();
        } else {
            // æ–°è¦æ¥­è€…
            contractorName = $('input[name="modal_new_client_name"]').val();
        }

        const workDescription = $('textarea[name="modal_work_description"]').val();
        const contractAmount = $('input[name="modal_contract_amount"]').val();

        if (!contractorName || !workDescription) {
            toastr.warning('æ¥­è€…åã¨ä½œæ¥­å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        itemData.contractorName = contractorName;
        itemData.workDescription = workDescription;
        itemData.contractAmount = contractAmount || 0;
        itemData.additionalCosts = [...window.modalAdditionalCosts];
        itemData.additionalCostTotal = window.modalAdditionalCosts.reduce((sum, item) => sum + item.amount, 0);

    } else if (implementationType === 'internal') {
        // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®æƒ…å ±ã‚’å–å¾—
        const internalInputType = $('input[name="modal_internal_input_type"]:checked').val();
        let staffName = '';
        let department = '';

        if (internalInputType === 'existing') {
            // æ—¢å­˜æ‹…å½“è€…ã‹ã‚‰é¸æŠ
            const selectedOption = $('#modalInternalSelect option:selected');
            staffName = selectedOption.data('name') || selectedOption.text();
            department = selectedOption.data('department') || '';
        } else {
            // æ–°è¦æ‹…å½“è€…
            staffName = $('input[name="modal_new_internal_name"]').val();
            department = $('input[name="modal_internal_department"]').val();
        }

        if (!staffName) {
            toastr.warning('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        itemData.staffName = staffName;
        itemData.department = department;

    } else if (implementationType === 'later') {
        itemData.description = 'å¾Œã§æ±ºå®š';
    }

    // å®Ÿæ–½ä½“åˆ¶ãƒªã‚¹ãƒˆã«è¿½åŠ 
    addToImplementationList(itemData);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#addImplementationModal').removeClass('show').css('display', 'none');
    $('.modal-backdrop').remove();

    toastr.success('å®Ÿæ–½ä½“åˆ¶ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
};

window.addNewStaff = function() {
    console.log('âœ… addNewStaff called');

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
    $('body').addClass('modal-open').css('overflow', 'hidden');

    // ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const modal = $('#staffModal');
    modal.css('display', 'block').addClass('show');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#staffForm')[0].reset();
    $('#staffModalTitle').text('æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ ');
    $('#staffId').val('');

    // z-indexã‚’èª¿æ•´
    modal.css('z-index', '2060');
    $('.modal-backdrop').css('z-index', '2059');

    console.log('æ–°è¦ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ');
};

window.saveStaff = function() {
    console.log('âœ… saveStaff called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const formData = {
        name: $('#staffName').val(),
        department: $('#staffDepartment').val(),
        hourlyRate: $('#staffHourlyRate').val(),
        specialties: $('#staffSpecialties').val(),
        active: $('#staffActive').is(':checked')
    };

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.name) {
        toastr.warning('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã«è¿½åŠ 
    addStaffToList(formData);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#staffModal').removeClass('show').css('display', 'none');

    toastr.success('ã‚¹ã‚¿ãƒƒãƒ•ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
};

window.addNewContractor = function() {
    console.log('âœ… addNewContractor called');

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’é˜²ã
    $('body').addClass('modal-open').css('overflow', 'hidden');

    // æ¥­è€…ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    const modal = $('#contractorModal');
    modal.css('display', 'block').addClass('show');

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#contractorForm')[0].reset();
    $('#contractorModalTitle').text('æ–°ã—ã„æ¥­è€…ã‚’è¿½åŠ ');

    // æ–°è¦è¿½åŠ æ™‚ã¯æ¥­è€…é¸æŠæ–¹æ³•ã‚’éè¡¨ç¤ºã«ã—ã¦ã€ç›´æ¥æ–°è¦å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    $('.contractor-input-method').hide();
    $('#existingContractorDiv').hide();
    $('#newContractorDiv').show();

    // z-indexã‚’èª¿æ•´ï¼ˆæ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ˆã‚Šå‰é¢ã«ï¼‰
    modal.css('z-index', '2060');
    $('.modal-backdrop').css('z-index', '2059');

    console.log('æ–°è¦æ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ');
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ™‚çµ¦å˜ä¾¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
window.toggleModalHourlyRateField = function() {
    const contractorType = $('#contractorType').val();
    const hourlyRateField = $('#modalHourlyRateField');

    if (contractorType === 'individual') {
        hourlyRateField.show();
    } else {
        hourlyRateField.hide();
        $('#contractorHourlyRate').val('');
    }
};

window.saveContractor = function() {
    console.log('âœ… saveContractor called');

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆæ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã§ï¼‰
    const formData = {
        name: $('#contractorName').val(),
        contractor_type: $('#contractorType').val(),
        address: $('#contractorAddress').val(),
        phone: $('#contractorPhone').val(),
        email: $('#contractorEmail').val(),
        contact_person: $('#contractorContactPerson').val(),
        hourly_rate: $('#contractorHourlyRate').val(),
        specialties: $('#contractorSpecialties').val(),
        is_active: $('#contractorActive').is(':checked'),
        payment_cycle: $('#contractorPaymentCycle').val(),
        closing_day: $('#contractorClosingDay').val(),
        payment_offset_months: $('#contractorPaymentOffsetMonths').val(),
        payment_day: $('#contractorPaymentDay').val(),
        bank_name: $('#contractorBankName').val(),
        branch_name: $('#contractorBranchName').val(),
        account_type: $('#contractorAccountType').val(),
        account_number: $('#contractorAccountNumber').val(),
        account_holder: $('#contractorAccountHolder').val()
    };

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.name) {
        toastr.warning('æ¥­è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    // æ¥­è€…ä¸€è¦§ã«è¿½åŠ ï¼ˆç°¡æ˜“å®Ÿè£…ï¼‰
    addContractorToList(formData);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#contractorModal').removeClass('show').css('display', 'none');

    toastr.success('æ¥­è€…ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸï¼');
};

// æ¥­è€…ä¸€è¦§ã«è¿½åŠ 
window.addContractorToList = function(contractorData) {
    const tableBody = $('#contractorTableBody');
    const id = Date.now(); // ç°¡æ˜“ID

    const newRow = `
        <tr data-contractor-id="${id}">
            <td><strong>${contractorData.name}</strong></td>
            <td><span class="badge bg-primary me-1">æ–°è¦</span></td>
            <td title="${contractorData.specialties}" class="text-wrap" style="max-width: 150px;">${contractorData.specialties || '-'}</td>
            <td title="${contractorData.address}" class="text-wrap" style="max-width: 300px;">${contractorData.address || '-'}</td>
            <td>${contractorData.phone || '-'}</td>
            <td title="${contractorData.email}" style="max-width: 200px;">${contractorData.email || '-'}</td>
            <td>-</td>
            <td><span class="badge bg-success">æœ‰åŠ¹</span></td>
            <td>
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        onclick="editContractor(${id})" title="ç·¨é›†">
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `;

    tableBody.append(newRow);

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚‚è¿½åŠ ï¼ˆã“ã®æ©Ÿèƒ½ã¯ç¾åœ¨æœªä½¿ç”¨ï¼‰
    // const option = `<option value="${id}" data-name="${contractorData.name}">${contractorData.name}</option>`;
    // $('#clientCompanySelect').append(option);
    // $('#modalContractorSelect').append(option);
};

// ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿å®šç¾©
window.dummyContractors = [
    {
        id: 1,
        name: 'ç”°ä¸­å»ºè¨­æ ªå¼ä¼šç¤¾',
        classification: ['ç™ºæ³¨æ¥­è€…'],
        type: 'å»ºè¨­æ¥­',
        address: 'æ±äº¬éƒ½æ¸¯åŒºå…­æœ¬æœ¨1-2-3',
        phone: '03-1234-5678',
        email: 'tanaka@construction.com',
        specialties: 'æœ¨é€ å»ºç¯‰ã€ãƒªãƒ•ã‚©ãƒ¼ãƒ ',
        active: true
    },
    {
        id: 2,
        name: 'å±±ç”°é›»æ°—å·¥äº‹',
        classification: ['å—æ³¨æ¥­è€…'],
        type: 'é›»æ°—å·¥äº‹æ¥­',
        address: 'æ±äº¬éƒ½æ–°å®¿åŒºè¥¿æ–°å®¿2-3-4',
        phone: '03-2345-6789',
        email: 'yamada@electric.com',
        specialties: 'é«˜åœ§é›»æ°—ã€åˆ¶å¾¡ç›¤',
        active: true
    },
    {
        id: 3,
        name: 'ä½è—¤é…ç®¡ã‚µãƒ¼ãƒ“ã‚¹',
        classification: ['å—æ³¨æ¥­è€…', 'è³‡æå±‹'],
        type: 'ç®¡å·¥äº‹æ¥­',
        address: 'æ±äº¬éƒ½æ¸‹è°·åŒºæ¸‹è°·1-5-6',
        phone: '03-3456-7890',
        email: 'sato@piping.com',
        specialties: 'çµ¦æ’æ°´ã€ç©ºèª¿é…ç®¡',
        active: true
    },
    {
        id: 4,
        name: 'éˆ´æœ¨å¡—è£…å·¥æ¥­',
        classification: ['å—æ³¨æ¥­è€…'],
        type: 'å¡—è£…æ¥­',
        address: 'æ±äº¬éƒ½ä¸–ç”°è°·åŒºä¸‹åŒ—æ²¢2-1-3',
        phone: '03-4567-8901',
        email: 'suzuki@painting.com',
        specialties: 'å¤–å£å¡—è£…ã€é˜²æ°´å·¥äº‹',
        active: false
    },
    {
        id: 5,
        name: 'é«˜æ©‹å†…è£…',
        classification: ['å—æ³¨æ¥­è€…'],
        type: 'å†…è£…æ¥­',
        address: 'æ±äº¬éƒ½ä¸­é‡åŒºä¸­é‡3-4-5',
        phone: '03-5678-9012',
        email: 'takahashi@interior.com',
        specialties: 'å†…è£…ä»•ä¸Šã’ã€åºŠå·¥äº‹',
        active: true
    }
];

window.dummyCraftsmen = [
    {
        id: 1,
        name: 'ä¼Šè—¤è·äºº',
        specialties: 'å¤§å·¥å·¥äº‹ã€æœ¨å·¥',
        experience: '15å¹´',
        hourlyRate: 3500,
        phone: '090-1234-5678',
        active: true
    },
    {
        id: 2,
        name: 'æ¸¡è¾ºå¡—è£…',
        specialties: 'å¡—è£…å·¥äº‹',
        experience: '10å¹´',
        hourlyRate: 3000,
        phone: '090-2345-6789',
        active: true
    },
    {
        id: 3,
        name: 'ä¸­æ‘é›»å·¥',
        specialties: 'é›»æ°—å·¥äº‹',
        experience: '8å¹´',
        hourlyRate: 3200,
        phone: '090-3456-7890',
        active: true
    }
];

window.dummyInternalStaff = [
    {
        id: 1,
        name: 'ç”°ä¸­å¤ªéƒ',
        department: 'å·¥äº‹éƒ¨',
        hourlyRate: 2500,
        specialties: 'ç¾å ´ç®¡ç†ã€å“è³ªç®¡ç†',
        active: true
    },
    {
        id: 2,
        name: 'ä½è—¤èŠ±å­',
        department: 'å–¶æ¥­éƒ¨',
        hourlyRate: 2800,
        specialties: 'å–¶æ¥­ã€é¡§å®¢å¯¾å¿œ',
        active: true
    },
    {
        id: 3,
        name: 'å±±ç”°æ¬¡éƒ',
        department: 'è¨­è¨ˆéƒ¨',
        hourlyRate: 3000,
        specialties: 'è¨­è¨ˆã€CAD',
        active: true
    }
];

// æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°
window.refreshContractorList = function() {
    console.log('æ¥­è€…ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderContractorTable(window.dummyContractors);
};

// åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆå—æ³¨æ¥­è€…å„ªå…ˆï¼‰
window.refreshContractorListForBasicInfo = function() {
    console.log('åŸºæœ¬æƒ…å ±ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆå—æ³¨æ¥­è€…å„ªå…ˆï¼‰');
    const sortedContractors = [...window.dummyContractors].sort((a, b) => {
        if (a.active && !b.active) return -1;
        if (!a.active && b.active) return 1;
        if (a.classification.includes('å—æ³¨æ¥­è€…') && !b.classification.includes('å—æ³¨æ¥­è€…')) return -1;
        if (!a.classification.includes('å—æ³¨æ¥­è€…') && b.classification.includes('å—æ³¨æ¥­è€…')) return 1;
        return a.name.localeCompare(b.name);
    });
    renderContractorTable(sortedContractors);
};

// å®Ÿæ–½ä½“åˆ¶ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆç™ºæ³¨æ¥­è€…å„ªå…ˆï¼‰
window.refreshContractorListForImplementation = function() {
    console.log('å®Ÿæ–½ä½“åˆ¶ç”¨æ¥­è€…ãƒªã‚¹ãƒˆæ›´æ–°ï¼ˆç™ºæ³¨æ¥­è€…å„ªå…ˆï¼‰');
    const sortedContractors = [...window.dummyContractors].sort((a, b) => {
        if (a.active && !b.active) return -1;
        if (!a.active && b.active) return 1;
        if (a.classification.includes('ç™ºæ³¨æ¥­è€…') && !b.classification.includes('ç™ºæ³¨æ¥­è€…')) return -1;
        if (!a.classification.includes('ç™ºæ³¨æ¥­è€…') && b.classification.includes('ç™ºæ³¨æ¥­è€…')) return 1;
        return a.name.localeCompare(b.name);
    });
    renderContractorTable(sortedContractors);
};

// è·äººãƒªã‚¹ãƒˆæ›´æ–°
window.refreshCraftsmanList = function() {
    console.log('è·äººãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderCraftsmanTable(window.dummyCraftsmen);
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆæ›´æ–°
window.refreshStaffList = function() {
    console.log('ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’æ›´æ–°ä¸­...');
    renderStaffTable(window.dummyInternalStaff);
};

// ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
window.filterContractors = function() {
    const searchTerm = $('#contractorSearch').val().toLowerCase();
    const typeFilter = $('#contractorTypeFilter').val();
    const statusFilter = $('#contractorStatusFilter').val();

    let filteredContractors = [...window.dummyContractors];

    // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿
    if (searchTerm) {
        filteredContractors = filteredContractors.filter(contractor =>
            contractor.name.toLowerCase().includes(searchTerm) ||
            (contractor.phone && contractor.phone.includes(searchTerm)) ||
            (contractor.email && contractor.email.toLowerCase().includes(searchTerm))
        );
    }

    // ã‚¿ã‚¤ãƒ—ãƒ•ã‚£ãƒ«ã‚¿
    if (typeFilter) {
        const typeMap = {
            'ordering': 'ç™ºæ³¨æ¥­è€…',
            'receiving': 'å—æ³¨æ¥­è€…',
            'supplier': 'è³‡æå±‹',
            'other': 'ãã®ä»–'
        };
        filteredContractors = filteredContractors.filter(contractor =>
            contractor.classification.includes(typeMap[typeFilter])
        );
    }

    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
    if (statusFilter) {
        const isActive = statusFilter === 'active';
        filteredContractors = filteredContractors.filter(contractor => contractor.active === isActive);
    }

    renderContractorTable(filteredContractors);
};

// ãƒ•ã‚£ãƒ«ã‚¿ã‚¯ãƒªã‚¢
window.clearContractorFilters = function() {
    $('#contractorSearch').val('');
    $('#contractorTypeFilter').val('');
    $('#contractorStatusFilter').val('');
    filterContractors();
};

// ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½
let currentSortColumn = '';
let currentSortDirection = 'asc';

window.sortContractorTable = function(column) {
    if (currentSortColumn === column) {
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }

    let sortedContractors = [...window.dummyContractors];

    sortedContractors.sort((a, b) => {
        let aValue, bValue;

        switch(column) {
            case 'name':
                aValue = a.name.toLowerCase();
                bValue = b.name.toLowerCase();
                break;
            case 'status':
                aValue = a.active ? 1 : 0;
                bValue = b.active ? 1 : 0;
                break;
            default:
                return 0;
        }

        if (currentSortDirection === 'asc') {
            return aValue > bValue ? 1 : -1;
        } else {
            return aValue < bValue ? 1 : -1;
        }
    });

    renderContractorTable(sortedContractors);

    // ã‚½ãƒ¼ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’æ›´æ–°
    $('.contractor-table th i').removeClass('fa-sort-up fa-sort-down').addClass('fa-sort');
    $(`th[onclick*="${column}"] i`).removeClass('fa-sort')
        .addClass(currentSortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down');
};

// æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderContractorTable = function(contractors) {
    const tbody = $('#contractorTableBody');

    if (tbody.length === 0) {
        console.log('æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    contractors.forEach((contractor) => {
        const statusBadge = contractor.active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        const classificationBadges = contractor.classification.map(c => {
            const badgeClass = c.includes('å—æ³¨æ¥­è€…') ? 'bg-success' :
                             c.includes('ç™ºæ³¨æ¥­è€…') ? 'bg-primary' :
                             c.includes('è³‡æå±‹') ? 'bg-warning text-dark' : 'bg-secondary';
            return `<span class="badge ${badgeClass} me-1">${c}</span>`;
        }).join('');

        let rowClass = contractor.active ? 'clickable-row' : 'inactive-row';

        // å—æ³¨æ¥­è€…ãƒ»ç™ºæ³¨æ¥­è€…ã®è‰²åˆ†ã‘
        const isReceivingContractor = contractor.classification.some(c => c.includes('å—æ³¨æ¥­è€…'));
        const isOrderingContractor = contractor.classification.some(c => c.includes('ç™ºæ³¨æ¥­è€…'));

        if (isReceivingContractor) {
            rowClass += ' bg-success bg-opacity-10';
        } else if (isOrderingContractor) {
            rowClass += ' bg-warning bg-opacity-10';
        }

        const row = `
            <tr data-contractor-id="${contractor.id}" class="${rowClass}">
                <td><strong>${contractor.name}</strong></td>
                <td>${classificationBadges}</td>
                <td title="${contractor.specialties}" class="text-wrap" style="max-width: 150px;">${contractor.specialties || '-'}</td>
                <td title="${contractor.address}" class="text-wrap" style="max-width: 300px;">${contractor.address || '-'}</td>
                <td>${contractor.phone || '-'}</td>
                <td title="${contractor.email}" style="max-width: 200px;">${contractor.email || '-'}</td>
                <td>${contractor.contact_person || '-'}</td>
                <td>${statusBadge}</td>
                <td>
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                            onclick="editContractor(${contractor.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;

        tbody.append(row);
    });

    console.log(`æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ«ã«${contractors.length}ä»¶ã®æ¥­è€…ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ`);
};

// ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸ
function setupScrollSync() {
    const scrollContainer = $('.contractor-table-scroll');
    const fixedContainer = $('.contractor-table-fixed');

    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«åŒæœŸã‚’è¨­å®šï¼ˆé‡è¤‡ã‚¤ãƒ™ãƒ³ãƒˆã‚’é˜²ããŸã‚ã€ä¸€åº¦å‰Šé™¤ã—ã¦ã‹ã‚‰è¨­å®šï¼‰
    scrollContainer.off('scroll.sync');
    fixedContainer.off('scroll.sync');

    scrollContainer.on('scroll.sync', function() {
        fixedContainer.scrollTop(this.scrollTop);
    });

    fixedContainer.on('scroll.sync', function() {
        scrollContainer.scrollTop(this.scrollTop);
    });

    // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šè¡Œã®é«˜ã•ã‚’ãƒã‚§ãƒƒã‚¯
    console.log('ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œã®é«˜ã•èª¿æ•´å®Œäº†');
    setTimeout(() => {
        const scrollRows = $('.contractor-table-scroll tbody tr');
        const fixedRows = $('.contractor-table-fixed tbody tr');
        console.log(`ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å´è¡Œæ•°: ${scrollRows.length}, å›ºå®šå´è¡Œæ•°: ${fixedRows.length}`);
        if (scrollRows.length > 0 && fixedRows.length > 0) {
            const scrollHeight = scrollRows.first().outerHeight();
            const fixedHeight = fixedRows.first().outerHeight();
            console.log(`è¡Œã®é«˜ã• - ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å´: ${scrollHeight}px, å›ºå®šå´: ${fixedHeight}px`);
        }
    }, 100);
}

// è·äººãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderCraftsmanTable = function(craftsmen) {
    const tbody = $('#craftsmanTableBody');

    if (tbody.length === 0) {
        console.log('è·äººãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    craftsmen.forEach((craftsman) => {
        const statusBadge = craftsman.active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        tbody.append(`
            <tr data-craftsman-id="${craftsman.id}">
                <td><strong>${craftsman.name}</strong></td>
                <td>${craftsman.specialties}</td>
                <td>${craftsman.experience}</td>
                <td>Â¥${craftsman.hourlyRate.toLocaleString()}/æ™‚é–“</td>
                <td>${craftsman.phone}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editCraftsman(${craftsman.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteCraftsman(${craftsman.id})" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
window.renderStaffTable = function(staff) {
    const tbody = $('#staffTableBody');

    if (tbody.length === 0) {
        console.log('ã‚¹ã‚¿ãƒƒãƒ•ãƒ†ãƒ¼ãƒ–ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    tbody.empty();

    staff.forEach((member) => {
        const statusBadge = member.active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        tbody.append(`
            <tr data-staff-id="${member.id}">
                <td><strong>${member.name}</strong></td>
                <td>${member.department}</td>
                <td>Â¥${member.hourlyRate.toLocaleString()}/æ™‚é–“</td>
                <td>${member.specialties}</td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editStaff(${member.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteStaff(${member.id})" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `);
    });
};

// ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã«è¿½åŠ 
window.addStaffToList = function(staffData) {
    const id = Date.now(); // ç°¡æ˜“ID
    const newStaff = {
        id: id,
        name: staffData.name,
        department: staffData.department,
        hourlyRate: staffData.hourlyRate || 0,
        specialties: staffData.specialties,
        active: staffData.active
    };

    window.dummyInternalStaff.push(newStaff);

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã‚‚è¿½åŠ 
    const option = `<option value="${id}" data-name="${staffData.name}" data-department="${staffData.department}" data-hourly-rate="${staffData.hourlyRate}">${staffData.name} (${staffData.department})</option>`;
    $('#modalInternalSelect').append(option);

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
    renderStaffTable(window.dummyInternalStaff);
};

// ç·¨é›†ãƒ»å‰Šé™¤é–¢æ•°ã®ã‚¹ã‚¿ãƒ–
// æ¥­è€…é¸æŠæ©Ÿèƒ½
window.selectContractor = function(id) {
    console.log(`æ¥­è€…ID ${id} ã‚’é¸æŠ`);

    // é¸æŠã•ã‚ŒãŸæ¥­è€…æƒ…å ±ã‚’å–å¾—
    const contractor = window.dummyContractors.find(c => c.id === id);
    if (!contractor) {
        toastr.error('æ¥­è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // ã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢: ClientCompanyã¯å°‚ç”¨ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã§ç®¡ç†ã—ã¾ã™
    // å¿…è¦ã«å¿œã˜ã¦å…ƒè«‹ä¼šç¤¾ç®¡ç†ãƒšãƒ¼ã‚¸ï¼ˆ/orders/client-companies/ï¼‰ã‹ã‚‰ç™»éŒ²ã—ã¦ãã ã•ã„
    console.warn('ã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸã€‚å…ƒè«‹ä¼šç¤¾ã¯å°‚ç”¨ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã§ç®¡ç†ã—ã¦ãã ã•ã„ã€‚');

    // æ¥­è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $('#contractorManagementModal').removeClass('show').css('display', 'none');
    $('.modal-backdrop').remove();

    // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
    $('body').removeClass('modal-open').css('overflow', '');

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿ï¼‰
    console.log(`${contractor.name} ã‚’æ¥­è€…ã¨ã—ã¦è¨­å®šã—ã¾ã—ãŸ`);
};

window.editContractor = function(id) {
    // æ¥­è€…ç·¨é›†ãƒšãƒ¼ã‚¸ã«é·ç§»
    window.open(`/orders/contractors/${id}/edit/`, '_blank');
};

// æ±ç”¨å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
window.showConfirmDelete = function(message, onConfirm) {
    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨­å®š
    $('#confirmDeleteMessage').text(message);

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢
    $('#confirmDeleteButton').off('click');

    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    $('#confirmDeleteButton').on('click', function() {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
        if (modal) {
            modal.hide();
        }

        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’å®Ÿè¡Œ
        if (onConfirm && typeof onConfirm === 'function') {
            onConfirm();
        }
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
    modal.show();
};

window.deleteContractor = function(id) {
    showConfirmDelete('ã“ã®æ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        window.dummyContractors = window.dummyContractors.filter(c => c.id !== id);
        refreshContractorList();
        toastr.success('æ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });
};

window.editCraftsman = function(id) {
    toastr.info(`è·äººID ${id} ã®ç·¨é›†æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰`);
};

window.deleteCraftsman = function(id) {
    showConfirmDelete('ã“ã®è·äººã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        window.dummyCraftsmen = window.dummyCraftsmen.filter(c => c.id !== id);
        refreshCraftsmanList();
        toastr.success('è·äººã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });
};

window.editStaff = function(id) {
    toastr.info(`ã‚¹ã‚¿ãƒƒãƒ•ID ${id} ã®ç·¨é›†æ©Ÿèƒ½ï¼ˆæœªå®Ÿè£…ï¼‰`);
};

window.deleteStaff = function(id) {
    showConfirmDelete('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {
        window.dummyInternalStaff = window.dummyInternalStaff.filter(s => s.id !== id);
        refreshStaffList();
        toastr.success('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
    });
};

// å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
window.toggleImplementationType = function() {
    const selectedType = $('input[name="modal_implementation_type"]:checked').val();

    // å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
    $('.implementation-form').hide();

    // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
    switch(selectedType) {
        case 'outsource':
            $('#modalContractorForm').show();
            break;
        case 'internal':
            $('#modalInternalForm').show();
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ãŒé¸æŠã•ã‚ŒãŸæ™‚ã€æ–™é‡‘ä½“ç³»ã‚‚åˆæœŸåŒ–
            $('input[name="modal_internal_pricing_type"][value="hourly"]').prop('checked', true);
            togglePricingType();
            break;
        case 'later':
            $('#modalLaterForm').show();
            break;
    }

    console.log('å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ:', selectedType);
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ©Ÿèƒ½
window.clearImplementationModalForms = function() {
    $('#addImplementationModal input[type="text"]').val('');
    $('#addImplementationModal input[type="number"]').val('');
    $('#addImplementationModal textarea').val('');
    $('#addImplementationModal select').val('');

    // è¿½åŠ è²»ç”¨ã‚‚ã‚¯ãƒªã‚¢
    clearModalAdditionalCosts();

    console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
};

// å®Ÿæ–½ä½“åˆ¶ãƒªã‚¹ãƒˆã«è¿½åŠ 
window.addToImplementationList = function(itemData) {
    const listContainer = $('#implementationList');

    let html = '';
    if (itemData.type === 'outsource') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-handshake text-primary me-2"></i>å¤–æ³¨å…ˆ: ${itemData.contractorName}
                            </h6>
                            <p class="card-text mb-1">
                                <strong>ä½œæ¥­å†…å®¹:</strong> ${itemData.workDescription}
                            </p>
                            <p class="card-text mb-1">
                                <strong>å¥‘ç´„é¡:</strong> Â¥${Number(itemData.contractAmount).toLocaleString()}
                            </p>
                            ${itemData.additionalCostTotal > 0 ? `
                            <p class="card-text mb-0">
                                <strong>è¿½åŠ è²»ç”¨:</strong> Â¥${Number(itemData.additionalCostTotal).toLocaleString()}
                                <small class="text-muted">(${itemData.additionalCosts.length}é …ç›®)</small>
                            </p>
                            ` : ''}
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else if (itemData.type === 'internal') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-users text-success me-2"></i>ç¤¾å†…: ${itemData.staffName}
                            </h6>
                            <p class="card-text mb-0">
                                <strong>éƒ¨ç½²:</strong> ${itemData.department || '-'}
                            </p>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    } else if (itemData.type === 'later') {
        html = `
            <div class="card mb-2" data-item-id="${itemData.id}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="card-title mb-1">
                                <i class="fas fa-clock text-warning me-2"></i>å¾Œã§æ±ºå®š
                            </h6>
                            <p class="card-text mb-0">è©³ç´°ç”»é¢ã§å®Ÿæ–½ä½“åˆ¶ã‚’è¨­å®šã—ã¾ã™</p>
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeImplementationItem(${itemData.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    listContainer.append(html);
};

// å®Ÿæ–½ä½“åˆ¶ã‚¢ã‚¤ãƒ†ãƒ å‰Šé™¤
window.removeImplementationItem = function(itemId) {
    $(`[data-item-id="${itemId}"]`).remove();
};

// æ¥­è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
window.toggleContractorInputType = function() {
    const inputType = $('input[name="modal_contractor_input_type"]:checked').val();
    console.log('æ¥­è€…é¸æŠæ–¹æ³•åˆ‡ã‚Šæ›¿ãˆ:', inputType);

    if (inputType === 'existing') {
        $('#modalExistingContractorDiv').show();
        $('#modalNewContractorDiv').hide();
        console.log('æ—¢å­˜æ¥­è€…é¸æŠè¡¨ç¤º');
    } else {
        $('#modalExistingContractorDiv').hide();
        $('#modalNewContractorDiv').show();
        console.log('æ–°è¦æ¥­è€…å…¥åŠ›è¡¨ç¤º');
    }
};

// ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
window.toggleInternalInputType = function() {
    const inputType = $('input[name="modal_internal_input_type"]:checked').val();
    console.log('ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•åˆ‡ã‚Šæ›¿ãˆ:', inputType);

    if (inputType === 'existing') {
        $('#modalExistingInternalDiv').show();
        $('#modalNewInternalDiv').hide();
        console.log('æ—¢å­˜æ‹…å½“è€…é¸æŠè¡¨ç¤º');
    } else {
        $('#modalExistingInternalDiv').hide();
        $('#modalNewInternalDiv').show();
        console.log('æ–°è¦æ‹…å½“è€…å…¥åŠ›è¡¨ç¤º');
    }
};

// æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆ
window.togglePricingType = function() {
    const pricingType = $('input[name="modal_internal_pricing_type"]:checked').val();
    console.log('========================');
    console.log('ğŸ”¥ æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆ:', pricingType);

    const hourlyFields = $('#modalHourlyPricingFields');
    const projectFields = $('#modalProjectPricingFields');

    console.log('ğŸ”§ Before changes:');
    console.log('  - modalHourlyPricingFields visible:', hourlyFields.is(':visible'));
    console.log('  - modalProjectPricingFields visible:', projectFields.is(':visible'));

    if (pricingType === 'hourly') {
        console.log('ğŸ”§ Setting to hourly mode');
        hourlyFields.show();
        projectFields.hide();
    } else if (pricingType === 'project') {
        console.log('ğŸ”§ Setting to project mode');
        hourlyFields.hide();
        projectFields.show();
    }

    console.log('ğŸ”§ After changes:');
    console.log('  - modalHourlyPricingFields visible:', hourlyFields.is(':visible'));
    console.log('  - modalProjectPricingFields visible:', projectFields.is(':visible'));
    console.log('========================');
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹è²»ç”¨è‡ªå‹•è¨ˆç®—
window.calculateModalInternalCost = function() {
    const pricingType = $('input[name="modal_internal_pricing_type"]:checked').val();

    if (pricingType === 'hourly') {
        const hourlyRate = parseFloat($('input[name="modal_internal_hourly_rate"]').val()) || 0;
        const hours = parseFloat($('input[name="modal_estimated_hours"]').val()) || 0;
        const totalCost = hourlyRate * hours;

        console.log('ğŸ’° æ™‚çµ¦ãƒ™ãƒ¼ã‚¹è¨ˆç®—:', {
            æ™‚çµ¦: hourlyRate,
            å·¥æ•°: hours,
            åˆè¨ˆ: totalCost
        });

        // è¨ˆç®—çµæœã‚’è¡¨ç¤ºã™ã‚‹å ´æ‰€ãŒã‚ã‚Œã°æ›´æ–°
        // (ç¾åœ¨ã®HTMLã«è¡¨ç¤ºé ˜åŸŸãŒãªã„å ´åˆã¯ã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ç¢ºèªã®ã¿)
        if ($('#modalInternalTotalCost').length) {
            $('#modalInternalTotalCost').text(totalCost.toLocaleString());
        }

        return totalCost;
    }
};

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
$(document).ready(function() {
    // å®Ÿæ–½ä½“åˆ¶ã‚¿ã‚¤ãƒ—å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_implementation_type"]', toggleImplementationType);

    // æ¥­è€…é¸æŠæ–¹æ³•å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_contractor_input_type"]', toggleContractorInputType);

    // ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•å¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_internal_input_type"]', toggleInternalInputType);

    // æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_internal_pricing_type"]', togglePricingType);

    // æ—¢å­˜æ‹…å½“è€…é¸æŠæ™‚ã®æ™‚çµ¦è‡ªå‹•å…¥åŠ›
    $(document).on('change', '#modalInternalSelect', function() {
        const selectedOption = $(this).find('option:selected');
        const hourlyRate = selectedOption.data('hourly-rate');

        if (hourlyRate) {
            $('input[name="modal_internal_hourly_rate"]').val(hourlyRate);
            console.log('ğŸ¯ æ‹…å½“è€…æ™‚çµ¦è‡ªå‹•å…¥åŠ›:', selectedOption.data('name'), 'Â¥' + hourlyRate + '/æ™‚é–“');

            // æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€è‡ªå‹•è¨ˆç®—ã‚’å®Ÿè¡Œ
            if ($('input[name="modal_internal_pricing_type"]:checked').val() === 'hourly') {
                calculateModalInternalCost();
            }
        }
    });

    // æ™‚çµ¦ãƒ»å·¥æ•°å¤‰æ›´æ™‚ã®è‡ªå‹•è¨ˆç®—
    $(document).on('input', 'input[name="modal_internal_hourly_rate"], input[name="modal_estimated_hours"]', function() {
        if ($('input[name="modal_internal_pricing_type"]:checked').val() === 'hourly') {
            calculateModalInternalCost();
        }
    });

    // Phase 3.2ã§è¿½åŠ : å·¥ç¨‹é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', '.modal-step-checkbox', handleModalStepSelection);

    // Phase 3.2ã§è¿½åŠ : é‡‘é¡è¨­å®šæ–¹æ³•ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('change', 'input[name="modal_cost_allocation_method"]', handleModalCostAllocationMethod);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('click', '[data-bs-dismiss="modal"]', function() {
        const modal = $(this).closest('.modal');
        modal.removeClass('show').css('display', 'none');
        $('.modal-backdrop').remove();

        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
        $('body').removeClass('modal-open').css('overflow', '');

        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    $(document).on('click', '.modal-backdrop', function() {
        $('.modal').removeClass('show').css('display', 'none');
        $('.modal-backdrop').remove();

        // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
        $('body').removeClass('modal-open').css('overflow', '');

        console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
    });

    // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    $(document).on('keydown', function(e) {
        if (e.key === 'Escape') {
            $('.modal.show').removeClass('show').css('display', 'none');
            $('.modal-backdrop').remove();

            // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¾©å…ƒ
            $('body').removeClass('modal-open').css('overflow', '');
            console.log('ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¾ã—ãŸ');
        }
    });

    // åˆæœŸåŒ–æ™‚ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
    initializeDropdowns();

    console.log('ğŸ“Œ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè¨­å®šã•ã‚Œã¾ã—ãŸ');
});

// ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ï¼ˆã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢ï¼‰
window.initializeDropdowns = function() {
    // å…ƒè«‹ä¼šç¤¾ã¯å°‚ç”¨ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã§ç®¡ç†ã—ã¾ã™
    // ã“ã®é–¢æ•°ã¯å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚ã«æ®‹ã—ã¦ã„ã¾ã™ãŒã€ä½•ã‚‚å®Ÿè¡Œã—ã¾ã›ã‚“
    console.log('initializeDropdowns: ã“ã®æ©Ÿèƒ½ã¯å»ƒæ­¢ã•ã‚Œã¾ã—ãŸ');

    // ç¤¾å†…ã‚¹ã‚¿ãƒƒãƒ•ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
    const internalSelect = $('#modalInternalSelect');

    window.dummyInternalStaff.filter(s => s.active).forEach(staff => {
        const option = `<option value="${staff.id}" data-name="${staff.name}" data-department="${staff.department}" data-hourly-rate="${staff.hourlyRate}">${staff.name} (${staff.department})</option>`;
        internalSelect.append(option);
    });

    console.log('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…è¿½åŠ è²»ç”¨ç®¡ç†
window.modalAdditionalCosts = [];

window.addModalCostItem = function() {
    console.log('âœ… addModalCostItem called');

    // jQuery ãƒã‚§ãƒƒã‚¯
    if (typeof $ === 'undefined') {
        console.error('âŒ jQuery not loaded');
        return;
    }

    // è¦ç´ ã®å­˜åœ¨ç¢ºèªã¨å€¤å–å¾—
    const nameEl = $('#modalNewCostItemName');
    const amountEl = $('#modalNewCostItemAmount');
    const descriptionEl = $('#modalNewCostItemDescription');

    if (nameEl.length === 0 || amountEl.length === 0 || descriptionEl.length === 0) {
        console.error('âŒ Cost item input fields not found');
        if (typeof toastr !== 'undefined') {
            toastr.error('å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        return;
    }

    const nameValue = nameEl.val();
    const amountValue = amountEl.val();
    const descriptionValue = descriptionEl.val();

    const name = nameValue ? nameValue.trim() : '';
    const amount = parseFloat(amountValue) || 0;
    const description = descriptionValue ? descriptionValue.trim() : '';

    console.log('ğŸ“ Cost item values:', { name, amount, description });

    if (!name || amount <= 0) {
        if (typeof toastr !== 'undefined') {
            toastr.warning('è²»ç”¨é …ç›®åã¨é‡‘é¡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        }
        return;
    }

    const costItem = {
        id: Date.now(),
        name: name,
        amount: amount,
        description: description
    };

    window.modalAdditionalCosts.push(costItem);
    renderModalCostList();
    updateModalCostTotal();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    nameEl.val('');
    amountEl.val('');
    descriptionEl.val('');

    console.log('âœ… è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', costItem);
};

window.removeModalCostItem = function(id) {
    window.modalAdditionalCosts = window.modalAdditionalCosts.filter(item => item.id !== id);
    renderModalCostList();
    updateModalCostTotal();
    console.log('è¿½åŠ è²»ç”¨é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', id);
};

window.renderModalCostList = function() {
    const listContainer = $('#modalAdditionalCostList');
    listContainer.empty();

    window.modalAdditionalCosts.forEach(item => {
        const html = `
            <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2" data-cost-id="${item.id}">
                <div class="flex-grow-1">
                    <strong>${item.name}</strong>
                    <span class="text-muted ms-2">Â¥${item.amount.toLocaleString()}</span>
                    ${item.description ? `<br><small class="text-muted">${item.description}</small>` : ''}
                </div>
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeModalCostItem(${item.id})">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        listContainer.append(html);
    });
};

window.updateModalCostTotal = function() {
    const total = window.modalAdditionalCosts.reduce((sum, item) => sum + item.amount, 0);
    $('#modalAdditionalCostTotal').text('Â¥' + total.toLocaleString());

    // æ–™é‡‘ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    if (typeof calculateModalTotal === 'function') {
        calculateModalTotal();
    }
};

window.clearModalAdditionalCosts = function() {
    window.modalAdditionalCosts = [];
    renderModalCostList();
    updateModalCostTotal();
};

// ==========================================
// Phase 2.2ã§è¿½åŠ : æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã¨éƒ¨æè²»ç®¡ç†
// ==========================================

// å¤–æ³¨å…ˆé¸æŠæ™‚ã®å‡¦ç†ï¼ˆæ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã®è‡ªå‹•å…¥åŠ›ï¼‰
window.onModalContractorChange = function(selectElement) {
    const contractorId = selectElement.value;
    const contractorInfoSection = document.getElementById('modalSelectedContractorInfo');

    if (!contractorId) {
        console.log('æ¥­è€…é¸æŠãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
        // æ¥­è€…æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        if (contractorInfoSection) {
            contractorInfoSection.style.display = 'none';
        }
        return;
    }

    // é¸æŠã•ã‚ŒãŸæ¥­è€…ã®dataå±æ€§ã‹ã‚‰å€¤ã‚’å–å¾—
    const selectedOption = selectElement.options[selectElement.selectedIndex];
    const contractorName = selectedOption.getAttribute('data-name') || '';
    const paymentCycleRaw = selectedOption.getAttribute('data-payment-cycle') || '';
    const closingDayRaw = selectedOption.getAttribute('data-closing-day') || '';
    const paymentOffsetRaw = selectedOption.getAttribute('data-payment-offset-months') || '';
    const paymentDayRaw = selectedOption.getAttribute('data-payment-day') || '';

    console.log('âœ… æ¥­è€…ã‚’é¸æŠã—ã¾ã—ãŸ:', contractorName);

    // ã‚¹ãƒ†ãƒƒãƒ—3ã®æ¥­è€…æƒ…å ±è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’æ›´æ–°
    if (contractorInfoSection) {
        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ã‚’æ—¥æœ¬èªã«å¤‰æ›
        const paymentCycleMap = {
            'monthly': 'æœˆæ‰•ã„',
            'bimonthly': 'éš”æœˆæ‰•ã„',
            'quarterly': 'å››åŠæœŸæ‰•ã„',
            'custom': 'ãã®ä»–'
        };
        const paymentCycleDisplay = paymentCycleRaw ? (paymentCycleMap[paymentCycleRaw] || paymentCycleRaw) : '-';

        // æ”¯æ‰•æœˆã‚’æ—¥æœ¬èªã«å¤‰æ›
        const paymentOffsetMap = {
            '0': 'å½“æœˆ',
            '1': 'ç¿Œæœˆ',
            '2': 'ç¿Œã€…æœˆ',
            '3': '3ãƒ¶æœˆå¾Œ'
        };
        const paymentOffsetDisplay = paymentOffsetRaw !== '' ? (paymentOffsetMap[paymentOffsetRaw] || paymentOffsetRaw) : '-';

        // ç· ã‚æ—¥ã¨æ”¯æ‰•æ—¥ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        const closingDayDisplay = closingDayRaw ? `${closingDayRaw}æ—¥` : '-';
        const paymentDayDisplay = paymentDayRaw ? `${paymentDayRaw}æ—¥` : '-';

        // è¡¨ç¤ºã‚’æ›´æ–°
        const contractorNameEl = document.getElementById('modalSelectedContractorName');
        const paymentCycleEl = document.getElementById('modalSelectedPaymentCycle');
        const closingDayEl = document.getElementById('modalSelectedClosingDay');
        const paymentOffsetEl = document.getElementById('modalSelectedPaymentOffset');
        const paymentDayEl = document.getElementById('modalSelectedPaymentDay');

        if (contractorNameEl) contractorNameEl.textContent = contractorName;
        if (paymentCycleEl) paymentCycleEl.textContent = paymentCycleDisplay;
        if (closingDayEl) closingDayEl.textContent = closingDayDisplay;
        if (paymentOffsetEl) paymentOffsetEl.textContent = paymentOffsetDisplay;
        if (paymentDayEl) paymentDayEl.textContent = paymentDayDisplay;

        // æ¥­è€…æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        contractorInfoSection.style.display = 'block';

        console.log('ğŸ“Š æ¥­è€…æƒ…å ±ã‚’è¡¨ç¤º:', {
            name: contractorName,
            paymentCycle: paymentCycleDisplay,
            closingDay: closingDayDisplay,
            paymentOffset: paymentOffsetDisplay,
            paymentDay: paymentDayDisplay
        });
    }
};

// éƒ¨æè²»ç®¡ç†
window.modalMaterialCosts = [];

window.addModalMaterialCostRow = function() {
    const name = $('#modalNewMaterialName').val().trim();
    const unitPrice = parseFloat($('#modalNewMaterialUnitPrice').val()) || 0;
    const quantity = parseFloat($('#modalNewMaterialQuantity').val()) || 0;

    if (!name || unitPrice <= 0 || quantity <= 0) {
        toastr.warning('éƒ¨æåã€å˜ä¾¡ã€æ•°é‡ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
    }

    const subtotal = unitPrice * quantity;

    const materialItem = {
        id: Date.now(),
        name: name,
        unit_price: unitPrice,
        quantity: quantity,
        subtotal: subtotal
    };

    window.modalMaterialCosts.push(materialItem);
    renderModalMaterialCostTable();
    calculateModalMaterialCostTotal();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
    $('#modalNewMaterialName').val('');
    $('#modalNewMaterialUnitPrice').val('');
    $('#modalNewMaterialQuantity').val('');

    console.log('éƒ¨æè²»é …ç›®ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', materialItem);
};

window.removeModalMaterialCostRow = function(id) {
    window.modalMaterialCosts = window.modalMaterialCosts.filter(item => item.id !== id);
    renderModalMaterialCostTable();
    calculateModalMaterialCostTotal();
    console.log('éƒ¨æè²»é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', id);
};

window.renderModalMaterialCostTable = function() {
    const tableBody = $('#modalMaterialCostTableBody');
    tableBody.empty();

    window.modalMaterialCosts.forEach(item => {
        const row = `
            <tr data-material-id="${item.id}">
                <td>${item.name}</td>
                <td class="text-end">Â¥${item.unit_price.toLocaleString()}</td>
                <td class="text-end">${item.quantity}</td>
                <td class="text-end material-subtotal" data-subtotal="${item.subtotal}">Â¥${item.subtotal.toLocaleString()}</td>
                <td class="text-center">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeModalMaterialCostRow(${item.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </td>
            </tr>
        `;
        tableBody.append(row);
    });
};

window.calculateModalMaterialCostTotal = function() {
    const total = window.modalMaterialCosts.reduce((sum, item) => sum + item.subtotal, 0);
    $('#modalMaterialCostTotal').text('Â¥' + total.toLocaleString());

    // æ–™é‡‘ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    if (typeof calculateModalTotal === 'function') {
        calculateModalTotal();
    }

    console.log('âœ… éƒ¨æè²»åˆè¨ˆã‚’æ›´æ–°ã—ã¾ã—ãŸ:', total);
};

window.clearModalMaterialCosts = function() {
    window.modalMaterialCosts = [];
    renderModalMaterialCostTable();
    calculateModalMaterialCostTotal();
};

// å‡ºé‡‘äºˆå®šæ—¥ã®è‡ªå‹•è¨ˆç®—
window.autoCalculatePaymentDueDate = function() {
    console.log('âœ… autoCalculatePaymentDueDate called');

    // æ¥­è€…ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
    const contractorSelect = document.getElementById('modalContractorSelect');
    if (!contractorSelect || !contractorSelect.value) {
        if (typeof toastr !== 'undefined') {
            toastr.warning('æ¥­è€…ã‚’é¸æŠã—ã¦ãã ã•ã„');
        }
        return;
    }

    // é¸æŠã•ã‚ŒãŸæ¥­è€…ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—
    const selectedOption = contractorSelect.options[contractorSelect.selectedIndex];
    const closingDayRaw = selectedOption.getAttribute('data-closing-day');
    const paymentOffsetRaw = selectedOption.getAttribute('data-payment-offset-months');
    const paymentDayRaw = selectedOption.getAttribute('data-payment-day');

    console.log('ğŸ“ æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±:', {
        closingDayRaw,
        paymentOffsetRaw,
        paymentDayRaw
    });

    // å¿…è¦ãªæƒ…å ±ãŒæƒã£ã¦ã„ã‚‹ã‹ç¢ºèªï¼ˆpaymentOffsetRawã¯ç©ºæ–‡å­—åˆ—ã§ã‚‚OK = 0ã¨ã—ã¦æ‰±ã†ï¼‰
    if (!closingDayRaw || paymentOffsetRaw === null || paymentOffsetRaw === undefined || !paymentDayRaw) {
        if (typeof toastr !== 'undefined') {
            toastr.warning('é¸æŠã•ã‚ŒãŸæ¥­è€…ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãŒä¸å®Œå…¨ã§ã™ï¼ˆç· æ—¥ãƒ»æ”¯æ‰•æ—¥ãŒå¿…è¦ã§ã™ï¼‰');
        }
        console.error('âŒ æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãŒä¸è¶³:', {
            closingDayRaw,
            paymentOffsetRaw,
            paymentDayRaw
        });
        return;
    }

    const closingDay = parseInt(closingDayRaw);
    // ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯0ï¼ˆå½“æœˆï¼‰ã¨ã—ã¦æ‰±ã†
    const paymentOffsetMonths = paymentOffsetRaw === '' ? 0 : parseInt(paymentOffsetRaw);
    const paymentDay = parseInt(paymentDayRaw);

    console.log('ğŸ“ ãƒ‘ãƒ¼ã‚¹å¾Œã®å€¤:', {
        closingDay,
        paymentOffsetMonths,
        paymentDay
    });

    // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—
    const today = new Date();
    const currentYear = today.getFullYear();
    const currentMonth = today.getMonth(); // 0-11
    const currentDay = today.getDate();

    // æ¬¡ã®ç· æ—¥ã‚’è¨ˆç®—
    let closingDate;
    if (currentDay <= closingDay) {
        // ä»Šæœˆã®ç· æ—¥ãŒã¾ã æ¥ã¦ã„ãªã„
        closingDate = new Date(currentYear, currentMonth, closingDay);
    } else {
        // ä»Šæœˆã®ç· æ—¥ã‚’éãã¦ã„ã‚‹ â†’ æ¥æœˆã®ç· æ—¥
        closingDate = new Date(currentYear, currentMonth + 1, closingDay);
    }

    console.log('ğŸ“… ç· æ—¥:', closingDate.toISOString().split('T')[0]);

    // æ”¯æ‰•æœˆã‚’è¨ˆç®—ï¼ˆç· æ—¥ + ã‚ªãƒ•ã‚»ãƒƒãƒˆæœˆï¼‰
    const paymentDate = new Date(
        closingDate.getFullYear(),
        closingDate.getMonth() + paymentOffsetMonths,
        paymentDay
    );

    console.log('ğŸ’° å‡ºé‡‘äºˆå®šæ—¥:', paymentDate.toISOString().split('T')[0]);

    // æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®šï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
    const paymentDueDateInput = document.getElementById('modalPaymentDueDate');
    if (paymentDueDateInput) {
        const dateStr = paymentDate.toISOString().split('T')[0];
        paymentDueDateInput.value = dateStr;

        if (typeof toastr !== 'undefined') {
            toastr.success(`å‡ºé‡‘äºˆå®šæ—¥ã‚’ ${dateStr} ã«è¨­å®šã—ã¾ã—ãŸ`);
        }
    }
};

// ==========================================
// Phase 2.2ã§è¿½åŠ ã“ã“ã¾ã§
// ==========================================

// ==========================================
// Phase 3.2ã§è¿½åŠ : å·¥ç¨‹é¸æŠã¨é‡‘é¡è¨­å®š
// ==========================================

// å·¥ç¨‹é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ãƒãƒ³ãƒ‰ãƒ«
window.handleModalStepSelection = function() {
    const checkedSteps = $('.modal-step-checkbox:checked');
    const costAllocationSection = $('#modalCostAllocationSection');
    const perStepAmountsSection = $('#modalPerStepAmountsSection');

    if (checkedSteps.length > 1) {
        // è¤‡æ•°ã®å·¥ç¨‹ãŒé¸æŠã•ã‚ŒãŸå ´åˆã€é‡‘é¡è¨­å®šæ–¹æ³•ã‚’è¡¨ç¤º
        costAllocationSection.show();
    } else {
        // 1ã¤ä»¥ä¸‹ã®å ´åˆã¯éè¡¨ç¤º
        costAllocationSection.hide();
        perStepAmountsSection.hide();
        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’ä¸€å¼ã«ãƒªã‚»ãƒƒãƒˆ
        $('#modalCostLumpSum').prop('checked', true);
    }

    // å·¥ç¨‹ã”ã¨ã®é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    updateModalPerStepAmountFields();
};

// é‡‘é¡è¨­å®šæ–¹æ³•ã®å¤‰æ›´ã‚’ãƒãƒ³ãƒ‰ãƒ«
window.handleModalCostAllocationMethod = function() {
    const method = $('input[name="modal_cost_allocation_method"]:checked').val();
    const perStepAmountsSection = $('#modalPerStepAmountsSection');

    if (method === 'per_step') {
        perStepAmountsSection.show();
        updateModalPerStepAmountFields();
    } else {
        perStepAmountsSection.hide();
    }
};

// å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‹•çš„ç”Ÿæˆ
window.updateModalPerStepAmountFields = function() {
    const checkedSteps = $('.modal-step-checkbox:checked');
    const container = $('#modalPerStepAmountFields');
    container.empty();

    const stepNames = {
        'survey': 'ç¾èª¿',
        'construction_start': 'ç€å·¥',
        'attendance': 'ç«‹ã¡ä¼šã„'
    };

    const stepIcons = {
        'survey': 'fas fa-clipboard-list text-info',
        'construction_start': 'fas fa-hard-hat text-warning',
        'attendance': 'fas fa-user-check text-success'
    };

    checkedSteps.each(function() {
        const stepKey = $(this).val();
        const stepName = stepNames[stepKey];
        const stepIcon = stepIcons[stepKey];

        const fieldHtml = `
            <div class="mb-3">
                <label class="form-label">
                    <i class="${stepIcon} me-1"></i>${stepName}ã®é‡‘é¡
                </label>
                <div class="input-group">
                    <span class="input-group-text">Â¥</span>
                    <input type="number"
                           name="modal_step_amount_${stepKey}"
                           class="form-control modal-step-amount"
                           data-step="${stepKey}"
                           placeholder="0"
                           min="0">
                </div>
            </div>
        `;
        container.append(fieldHtml);
    });
};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¯ãƒªã‚¢æ™‚ã«å·¥ç¨‹é¸æŠã‚‚ãƒªã‚»ãƒƒãƒˆ
window.clearModalStepSelection = function() {
    $('.modal-step-checkbox').prop('checked', false);
    $('#modalCostAllocationSection').hide();
    $('#modalPerStepAmountsSection').hide();
    $('#modalCostLumpSum').prop('checked', true);
    $('#modalPerStepAmountFields').empty();
};

// ==========================================
// Phase 3.2ã§è¿½åŠ ã“ã“ã¾ã§
// ==========================================

console.log('âœ… All functions loaded:', {
    fn1: typeof window.openBasicInfoContractorManagementPanel,
    fn2: typeof window.openAddImplementationModal,
    fn3: typeof window.closeModal,
    fn4: typeof window.toggleImplementationType,
    fn5: typeof window.clearImplementationModalForms,
    fn6: typeof window.addToImplementationList,
    fn7: typeof window.removeImplementationItem
});

// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
function switchFormViewMode(mode) {
    const tabViewBtn = document.getElementById('tabViewBtn');
    const fullViewBtn = document.getElementById('fullViewBtn');
    const tabNav = document.getElementById('projectFormTabs');
    const tabContent = document.getElementById('projectFormTabsContent');
    const tabPanes = document.querySelectorAll('#projectFormTabsContent .tab-pane');

    if (mode === 'tab') {
        // ã‚¿ãƒ–è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        tabViewBtn.classList.add('active');
        fullViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        tabNav.style.display = 'flex';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        tabContent.classList.remove('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // æœ€åˆã®ã‚¿ãƒ–ã‚’è¡¨ç¤º
        const firstPane = document.getElementById('basic');
        if (firstPane) {
            firstPane.classList.add('show', 'active');
        }

        // æœ€åˆã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        const tabButtons = document.querySelectorAll('#projectFormTabs .nav-link');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        const firstButton = document.getElementById('basic-tab');
        if (firstButton) {
            firstButton.classList.add('active');
        }

    } else if (mode === 'full') {
        // å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        fullViewBtn.classList.add('active');
        tabViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        tabNav.style.display = 'none';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        tabContent.classList.add('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        tabPanes.forEach(pane => {
            pane.classList.add('show', 'active');
        });
    }

    // é¸æŠçŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('projectFormViewMode', mode);
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«æ“ä½œæ™‚ã®å€¤ä¿æŒç”¨ï¼‰
function saveFormValues() {
    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    if (siteNameField && siteNameField.value) {
        localStorage.setItem('project_form_site_name', siteNameField.value);
    }
    if (siteAddressField && siteAddressField.value) {
        localStorage.setItem('project_form_site_address', siteAddressField.value);
    }

    console.log('ğŸ“ ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', {
        site_name: siteNameField?.value || '(ç©º)',
        site_address: siteAddressField?.value || '(ç©º)'
    });
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’å¾©å…ƒã™ã‚‹é–¢æ•°
function restoreFormValues() {
    const savedSiteName = localStorage.getItem('project_form_site_name');
    const savedSiteAddress = localStorage.getItem('project_form_site_address');

    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    // ç¾åœ¨ã®å€¤ãŒç©ºã®å ´åˆã®ã¿å¾©å…ƒ
    if (savedSiteName && siteNameField && !siteNameField.value) {
        siteNameField.value = savedSiteName;
        console.log('âœ… site_name ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', savedSiteName);
    }
    if (savedSiteAddress && siteAddressField && !siteAddressField.value) {
        siteAddressField.value = savedSiteAddress;
        console.log('âœ… site_address ã‚’å¾©å…ƒã—ã¾ã—ãŸ:', savedSiteAddress);
    }
}

// ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ã™ã‚‹é–¢æ•°ï¼ˆãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æˆåŠŸæ™‚ç”¨ï¼‰
function clearSavedFormValues() {
    localStorage.removeItem('project_form_site_name');
    localStorage.removeItem('project_form_site_address');
    console.log('ğŸ—‘ï¸ ä¿å­˜ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
document.addEventListener('DOMContentLoaded', function() {
    const savedMode = localStorage.getItem('projectFormViewMode');
    if (savedMode === 'full') {
        switchFormViewMode('full');
    }

    // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’å¾©å…ƒï¼ˆãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰å¾Œï¼‰
    restoreFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›æ™‚ã«è‡ªå‹•ä¿å­˜
    const siteNameField = document.querySelector('input[name="site_name"]');
    const siteAddressField = document.querySelector('input[name="site_address"]');

    if (siteNameField) {
        siteNameField.addEventListener('input', saveFormValues);
    }
    if (siteAddressField) {
        siteAddressField.addEventListener('input', saveFormValues);
    }

    // å…ƒè«‹ä¼šç¤¾é¸æŠæ™‚ã«æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•ã‚³ãƒ”ãƒ¼
    const clientCompanySelect = document.getElementById('clientCompanySelect');
    if (clientCompanySelect) {
        clientCompanySelect.addEventListener('change', function() {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption && selectedOption.value) {
                // ãƒ‡ãƒ¼ã‚¿å±æ€§ã‹ã‚‰æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—
                const paymentCycle = selectedOption.getAttribute('data-payment-cycle');
                const closingDay = selectedOption.getAttribute('data-closing-day');
                const paymentDay = selectedOption.getAttribute('data-payment-day');

                // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
                const paymentCycleField = document.getElementById('{{ form.payment_cycle.id_for_label }}');
                const closingDayField = document.getElementById('{{ form.closing_day.id_for_label }}');
                const paymentDayField = document.getElementById('{{ form.payment_day.id_for_label }}');

                // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ï¼ˆç©ºæ–‡å­—åˆ—ã§ã‚‚è¨­å®šï¼‰
                if (paymentCycleField) {
                    paymentCycleField.value = paymentCycle || '';
                }

                // ç· ã‚æ—¥ï¼ˆå€¤ãŒã‚ã‚‹å ´åˆã®ã¿è¨­å®šã€ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¯ãƒªã‚¢ï¼‰
                if (closingDayField) {
                    if (closingDay && closingDay !== '' && closingDay !== 'null' && closingDay !== 'None') {
                        closingDayField.value = closingDay;
                    } else {
                        closingDayField.value = '';
                    }
                }

                // æ”¯æ‰•ã„æ—¥ï¼ˆå€¤ãŒã‚ã‚‹å ´åˆã®ã¿è¨­å®šã€ç©ºæ–‡å­—åˆ—ã®å ´åˆã¯ã‚¯ãƒªã‚¢ï¼‰
                if (paymentDayField) {
                    if (paymentDay && paymentDay !== '' && paymentDay !== 'null' && paymentDay !== 'None') {
                        paymentDayField.value = paymentDay;
                    } else {
                        paymentDayField.value = '';
                    }
                }

                console.log('âœ… æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã—ãŸ:', {
                    paymentCycle: paymentCycle || '(æœªè¨­å®š)',
                    closingDay: closingDay || '(æœªè¨­å®š)',
                    paymentDay: paymentDay || '(æœªè¨­å®š)'
                });
            }
        });
    }
});

// ============================================
// å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«
// ============================================

// å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã
window.openClientCompanyManagementPanel = function() {
    console.log('âœ… openClientCompanyManagementPanel called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('clientCompanyManagementModal'));
    modal.show();

    // å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    refreshClientCompanyList();

    // æ¤œç´¢æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
    setTimeout(function() {
        const searchInput = $('#clientCompanySearchInput');
        if (searchInput.length) {
            searchInput.off('input').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterClientCompanyList(searchTerm);
            });
        }
    }, 100);
};

// å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°
window.refreshClientCompanyList = function() {
    console.log('âœ… refreshClientCompanyList called');

    const tbody = $('#clientCompanyTableBody');
    tbody.html('<tr><td colspan="10" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>èª­ã¿è¾¼ã¿ä¸­...</td></tr>');

    // AJAXã§æœ€æ–°ã®å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’å–å¾—
    $.ajax({
        url: '{% url "order_management:client_company_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (!response.success || !response.companies) {
                tbody.html('<tr><td colspan="10" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</td></tr>');
                return;
            }

            const allClientCompanies = response.companies;

    // ãƒ‡ãƒãƒƒã‚°: ãƒ‡ãƒ¼ã‚¿ã®å†…å®¹ã‚’ç¢ºèª
    console.log('ğŸ“‹ å…ƒè«‹ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿:', allClientCompanies);
    if (allClientCompanies && allClientCompanies.length > 0) {
        console.log('ğŸ“‹ æœ€åˆã®å…ƒè«‹ä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿è©³ç´°:', allClientCompanies[0]);
    }

    if (!allClientCompanies || allClientCompanies.length === 0) {
        tbody.html('<tr><td colspan="10" class="text-center text-muted">å…ƒè«‹ä¼šç¤¾ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>');
        return;
    }

    let html = '';
    allClientCompanies.forEach(function(company) {
        const statusBadge = company.is_active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        const paymentCycleText = company.payment_cycle_label || '-';

        // ç· ã‚æ—¥: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ0ã¯ç„¡åŠ¹ãªå€¤ãªã®ã§é™¤å¤–ï¼‰
        const closingDayText = (company.closing_day !== null && company.closing_day !== undefined)
            ? `${company.closing_day}æ—¥` : '-';

        // æ”¯æ‰•æœˆ: payment_offset_monthsã®å€¤ã‚’è¡¨ç¤º
        const paymentOffsetMonthsText = company.payment_offset_months_label || '-';

        // æ”¯æ‰•ã„æ—¥: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ0ã¯ç„¡åŠ¹ãªå€¤ãªã®ã§é™¤å¤–ï¼‰
        const paymentDayText = (company.payment_day !== null && company.payment_day !== undefined)
            ? `${company.payment_day}æ—¥` : '-';

        // ãƒ‡ãƒãƒƒã‚°: å„ä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        console.log(`  - ${company.company_name}: ç· ã‚æ—¥=${company.closing_day}, æ”¯æ‰•æœˆ=${company.payment_offset_months}, æ”¯æ‰•ã„æ—¥=${company.payment_day}`);

        html += `
            <tr style="cursor: pointer;" onclick="selectClientCompany(${company.id})" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                <td><strong>${escapeHtml(company.company_name)}</strong></td>
                <td>${escapeHtml(company.address || '-')}</td>
                <td>${escapeHtml(company.phone || '-')}</td>
                <td>${escapeHtml(company.contact_person || '-')}</td>
                <td class="text-center">${paymentCycleText}</td>
                <td class="text-center">${closingDayText}</td>
                <td class="text-center">${paymentOffsetMonthsText}</td>
                <td class="text-center">${paymentDayText}</td>
                <td class="text-center">${statusBadge}</td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-outline-primary" onclick="editClientCompany(${company.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.html(html);
        },
        error: function(xhr, status, error) {
            console.error('âŒ å…ƒè«‹ä¼šç¤¾ä¸€è¦§å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            tbody.html('<tr><td colspan="10" class="text-center text-danger">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error + '</td></tr>');
        }
    });
};

// å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
window.selectClientCompany = function(companyId) {
    console.log('âœ… selectClientCompany called', companyId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const modal = bootstrap.Modal.getInstance(document.getElementById('clientCompanyManagementModal'));
    if (modal) modal.hide();

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠ
    $('#clientCompanySelect').val(companyId);

    // allClientCompaniesé…åˆ—ã‹ã‚‰é¸æŠã•ã‚ŒãŸä¼šç¤¾ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const allClientCompanies = {{ client_companies_json|safe }};
    const selectedCompany = allClientCompanies.find(c => c.id === companyId);

    if (selectedCompany) {
        console.log('âœ… é¸æŠã•ã‚ŒãŸå…ƒè«‹ä¼šç¤¾:', selectedCompany);

        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’ç›´æ¥è¨­å®š
        const paymentCycleField = document.getElementById('{{ form.payment_cycle.id_for_label }}');
        const closingDayField = document.getElementById('{{ form.closing_day.id_for_label }}');
        const paymentDayField = document.getElementById('{{ form.payment_day.id_for_label }}');

        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«
        if (paymentCycleField) {
            paymentCycleField.value = selectedCompany.payment_cycle || '';
            console.log('  - æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«:', selectedCompany.payment_cycle || '(æœªè¨­å®š)');
        }

        // ç· ã‚æ—¥
        if (closingDayField) {
            if (selectedCompany.closing_day !== null && selectedCompany.closing_day !== undefined && selectedCompany.closing_day !== '') {
                closingDayField.value = selectedCompany.closing_day;
                console.log('  - ç· ã‚æ—¥:', selectedCompany.closing_day + 'æ—¥');
            } else {
                closingDayField.value = '';
                console.log('  - ç· ã‚æ—¥: (æœªè¨­å®š)');
            }
        }

        // æ”¯æ‰•ã„æ—¥
        if (paymentDayField) {
            if (selectedCompany.payment_day !== null && selectedCompany.payment_day !== undefined && selectedCompany.payment_day !== '') {
                paymentDayField.value = selectedCompany.payment_day;
                console.log('  - æ”¯æ‰•ã„æ—¥:', selectedCompany.payment_day + 'æ—¥');
            } else {
                paymentDayField.value = '';
                console.log('  - æ”¯æ‰•ã„æ—¥: (æœªè¨­å®š)');
            }
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (typeof toastr !== 'undefined') {
            toastr.success(`ã€Œ${selectedCompany.company_name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
        }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã®å…ˆé ­ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('html, body').animate({
        scrollTop: $('#clientCompanySelect').offset().top - 100
    }, 500);
};

// å…ƒè«‹ä¼šç¤¾ç·¨é›†ï¼ˆåˆ¥ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼‰
window.editClientCompany = function(companyId) {
    window.open(`/orders/client-companies/${companyId}/edit/`, '_blank');
};

// å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
window.filterClientCompanyList = function(searchTerm) {
    console.log('ğŸ” Filtering client companies:', searchTerm);

    const rows = $('#clientCompanyTableBody tr');

    if (!searchTerm || searchTerm.trim() === '') {
        rows.show();
        return;
    }

    rows.each(function() {
        const row = $(this);
        const companyName = row.find('td:first strong').text().toLowerCase();
        const address = row.find('td:nth-child(2)').text().toLowerCase();
        const phone = row.find('td:nth-child(3)').text().toLowerCase();

        if (companyName.includes(searchTerm) ||
            address.includes(searchTerm) ||
            phone.includes(searchTerm)) {
            row.show();
        } else {
            row.hide();
        }
    });

    // æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const visibleRows = rows.filter(':visible').length;
    if (visibleRows === 0) {
        const tbody = $('#clientCompanyTableBody');
        if (tbody.find('.no-results-row').length === 0) {
            tbody.append('<tr class="no-results-row"><td colspan="10" class="text-center text-muted py-4"><i class="fas fa-search me-2"></i>ã€Œ' + escapeHtml(searchTerm) + 'ã€ã«ä¸€è‡´ã™ã‚‹å…ƒè«‹ä¼šç¤¾ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>');
        }
    } else {
        $('#clientCompanyTableBody .no-results-row').remove();
    }
};

// æ–°è¦å…ƒè«‹ä¼šç¤¾è¿½åŠ ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã§ä½œæˆï¼‰
window.addNewClientCompany = function() {
    openClientCompanyCreateModal();
};

// éµå—ã‘æ¸¡ã—è¨­å®šã®æŠ˜ã‚ŠãŸãŸã¿åˆ‡ã‚Šæ›¿ãˆ
window.toggleKeyHandoverSection = function() {
    const section = document.getElementById('keyHandoverSection');
    const toggleBtn = document.getElementById('keyHandoverToggleBtn');
    const toggleIcon = document.getElementById('keyHandoverToggleIcon');

    if (section.style.display === 'none') {
        // å±•é–‹
        section.style.display = 'block';
        toggleIcon.classList.remove('fa-plus');
        toggleIcon.classList.add('fa-minus');
        toggleBtn.innerHTML = '<i class="fas fa-minus me-1" id="keyHandoverToggleIcon"></i><i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’é–‰ã˜ã‚‹';
    } else {
        // æŠ˜ã‚ŠãŸãŸã¿
        section.style.display = 'none';
        toggleIcon.classList.remove('fa-minus');
        toggleIcon.classList.add('fa-plus');
        toggleBtn.innerHTML = '<i class="fas fa-plus me-1" id="keyHandoverToggleIcon"></i><i class="fas fa-key me-1"></i>éµå—ã‘æ¸¡ã—è¨­å®šã‚’è¿½åŠ ';
    }
};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼šéµå—ã‘æ¸¡ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•å±•é–‹
document.addEventListener('DOMContentLoaded', function() {
    const keyLocation = document.getElementById('{{ form.key_handover_location.id_for_label }}');
    const keyDate = document.getElementById('{{ form.key_handover_date.id_for_label }}');
    const keyNotes = document.getElementById('{{ form.key_handover_notes.id_for_label }}');

    // ã„ãšã‚Œã‹ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ãŒã‚ã‚‹å ´åˆã¯è‡ªå‹•å±•é–‹
    if ((keyLocation && keyLocation.value) ||
        (keyDate && keyDate.value) ||
        (keyNotes && keyNotes.value)) {
        toggleKeyHandoverSection();
    }
});

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>

<!-- å…ƒè«‹ç®¡ç†ãƒ‘ãƒãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="clientCompanyManagementModal" tabindex="-1" aria-labelledby="clientCompanyManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="clientCompanyManagementModalLabel">
                    <i class="fas fa-building"></i> å…ƒè«‹ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">ç™»éŒ²å…ƒè«‹ä¼šç¤¾ä¸€è¦§</h6>
                    <div class="d-flex gap-2">
                        <input type="text" id="clientCompanySearchInput" class="form-control form-control-sm" placeholder="å…ƒè«‹ä¼šç¤¾åã§æ¤œç´¢..." style="width: 250px;">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewClientCompany()">
                            <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- å…ƒè«‹ä¼šç¤¾ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>ä¼šç¤¾å</th>
                                <th>ä½æ‰€</th>
                                <th>é›»è©±ç•ªå·</th>
                                <th>æ‹…å½“è€…</th>
                                <th class="text-center">æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«</th>
                                <th class="text-center">ç· ã‚æ—¥</th>
                                <th class="text-center">æ”¯æ‰•æœˆ</th>
                                <th class="text-center">æ”¯æ‰•ã„æ—¥</th>
                                <th class="text-center">çŠ¶æ…‹</th>
                                <th style="width: 140px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="clientCompanyTableBody">
                            <tr>
                                <td colspan="10" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- å·¥äº‹ç¨®åˆ¥ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="workTypeManagementModal" tabindex="-1" aria-labelledby="workTypeManagementModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <h5 class="modal-title" id="workTypeManagementModalLabel">
                    <i class="fas fa-tools me-2"></i>å·¥äº‹ç¨®åˆ¥ç®¡ç†
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <!-- æ—¢å­˜ã®å·¥äº‹ç¨®åˆ¥ä¸€è¦§ -->
                <div class="mb-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-list me-2"></i>ç™»éŒ²æ¸ˆã¿å·¥äº‹ç¨®åˆ¥
                    </h6>
                    <div id="workTypeList" class="mb-3">
                        <div class="text-center text-muted py-3">
                            <i class="fas fa-spinner fa-spin me-2"></i>èª­ã¿è¾¼ã¿ä¸­...
                        </div>
                    </div>
                </div>

                <!-- æ–°è¦è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="border-top pt-4">
                    <h6 class="border-bottom pb-2 mb-3">
                        <i class="fas fa-plus-circle me-2"></i>æ–°ã—ã„å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ 
                    </h6>
                    <form id="workTypeForm">
                        {% csrf_token %}
                        <input type="hidden" id="workTypeId" name="id" value="">

                        <div class="mb-3">
                            <label for="workTypeName" class="form-label">
                                ç¨®åˆ¥å <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="workTypeName" name="name" required maxlength="100">
                        </div>

                        <div class="mb-3">
                            <label for="workTypeDescription" class="form-label">èª¬æ˜</label>
                            <textarea class="form-control" id="workTypeDescription" name="description" rows="2"></textarea>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-success" id="workTypeSubmitBtn">
                                <i class="fas fa-save me-2"></i>ä¿å­˜ã™ã‚‹
                            </button>
                            <button type="button" class="btn btn-secondary" id="workTypeCancelBtn" style="display: none;" onclick="cancelWorkTypeEdit()">
                                <i class="fas fa-times me-2"></i>ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </form>

                    <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                    <div id="workTypeError" class="alert alert-danger mt-3" style="display: none;"></div>
                    <div id="workTypeSuccess" class="alert alert-success mt-3" style="display: none;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>é–‰ã˜ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å·¥äº‹ç¨®åˆ¥å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="workTypeDeleteConfirmModal" tabindex="-1" aria-hidden="true" style="z-index: 10050 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>å‰Šé™¤ã®ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-2">å·¥äº‹ç¨®åˆ¥ã€Œ<strong id="deleteWorkTypeName"></strong>ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning mb-0">
                    <i class="fas fa-info-circle me-2"></i>æ¡ˆä»¶ã§ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å‰Šé™¤ã§ãã¾ã›ã‚“ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteWorkTypeBtn">
                    <i class="fas fa-trash me-2"></i>å‰Šé™¤ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- å…ƒè«‹ä¼šç¤¾æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="clientCompanyCreateModal" tabindex="-1" aria-labelledby="clientCompanyCreateModalLabel" aria-hidden="true" style="z-index: 10000 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white;">
                <h5 class="modal-title" id="clientCompanyCreateModalLabel">
                    <i class="fas fa-building me-2"></i>å…ƒè«‹ä¼šç¤¾æ–°è¦ç™»éŒ²
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                <form id="clientCompanyCreateForm" enctype="multipart/form-data">
                    {% csrf_token %}

                    <!-- å…ƒè«‹æ¥­è€…ã¨ã¯ï¼ˆèª¬æ˜ï¼‰ -->
                    <div class="alert alert-info mb-4">
                        <h6><i class="fas fa-info-circle me-2"></i>å…ƒè«‹æ¥­è€…ã¨ã¯</h6>
                        <p class="mb-2">
                            ã“ã®ç”»é¢ã§ã¯<strong>æ¡ˆä»¶ã‚’ãã‚Œã‚‹ä¼šç¤¾ï¼ˆå…ƒè«‹æ¥­è€…ï¼‰</strong>ã‚’ç™»éŒ²ã—ã¾ã™ã€‚
                        </p>
                        <ul class="mb-0" style="font-size: 0.9rem;">
                            <li>å…ƒè«‹æ¥­è€…: æ¡ˆä»¶ã‚’ç™ºæ³¨ã—ã¦ãã‚Œã‚‹ä¼šç¤¾</li>
                            <li>è·äººãƒ»ä¸‹è«‹ã‘æ¥­è€…: æ¡ˆä»¶ä½œæˆæ™‚ã®ã€Œä½œæ¥­è€…è¿½åŠ ã€ã¾ãŸã¯ã€Œæ¥­è€…ç®¡ç†ã€ç”»é¢ã§ç™»éŒ²ã—ã¦ãã ã•ã„</li>
                        </ul>
                    </div>

                    <!-- åŸºæœ¬æƒ…å ± -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-info-circle me-2"></i>åŸºæœ¬æƒ…å ±
                        </h6>
                    </div>

                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="newCompanyName" class="form-label" style="font-weight: 500;">
                                ä¼šç¤¾å <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control" id="newCompanyName" name="company_name" required>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="newContactPerson" class="form-label" style="font-weight: 500;">
                                æ‹…å½“è€…å
                            </label>
                            <input type="text" class="form-control" id="newContactPerson" name="contact_person">
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="newEmail" class="form-label" style="font-weight: 500;">
                                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
                            </label>
                            <input type="email" class="form-control" id="newEmail" name="email">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="newPhone" class="form-label" style="font-weight: 500;">
                                é›»è©±ç•ªå·
                            </label>
                            <input type="tel" class="form-control" id="newPhone" name="phone">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="newAddress" class="form-label" style="font-weight: 500;">
                            ä½æ‰€
                        </label>
                        <textarea class="form-control" id="newAddress" name="address" rows="2"></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="newWebsite" class="form-label" style="font-weight: 500;">
                            ãƒ›ãƒ¼ãƒ ãƒšãƒ¼ã‚¸
                        </label>
                        <input type="url" class="form-control" id="newWebsite" name="website">
                        <small class="text-muted">ä¼šç¤¾ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆURLï¼ˆä¾‹ï¼šhttps://example.comï¼‰</small>
                    </div>

                    <!-- æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«è¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-money-bill-wave me-2"></i>æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«è¨­å®š
                        </h6>
                    </div>

                    <div class="alert alert-secondary mb-3">
                        <small>ã“ã“ã§è¨­å®šã—ãŸæ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ã¯ã€æ¡ˆä»¶ç™»éŒ²æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã¨ã—ã¦ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚æ¡ˆä»¶ã”ã¨ã«å€‹åˆ¥ã«å¤‰æ›´ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</small>
                    </div>

                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="newPaymentCycle" class="form-label" style="font-weight: 500;">
                                æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«
                            </label>
                            <select class="form-select" id="newPaymentCycle" name="payment_cycle">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                <option value="monthly">æœˆæ‰•ã„</option>
                                <option value="bimonthly">éš”æœˆæ‰•ã„</option>
                                <option value="quarterly">å››åŠæœŸæ‰•ã„</option>
                                <option value="half_yearly">åŠå¹´æ‰•ã„</option>
                                <option value="yearly">å¹´æ‰•ã„</option>
                                <option value="other">ãã®ä»–</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="newClosingDay" class="form-label" style="font-weight: 500;">
                                ç· ã‚æ—¥
                            </label>
                            <input type="number" class="form-control" id="newClosingDay" name="closing_day" min="1" max="31">
                            <small class="text-muted">æœˆæœ«ç· ã‚ã®å ´åˆã¯31ã€20æ—¥ç· ã‚ã®å ´åˆã¯20</small>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="newPaymentDay" class="form-label" style="font-weight: 500;">
                                æ”¯æ‰•æ—¥
                            </label>
                            <input type="number" class="form-control" id="newPaymentDay" name="payment_day" min="1" max="31">
                            <small class="text-muted">æ¯æœˆã®æ”¯æ‰•æ—¥ï¼ˆ1-31ï¼‰ã€‚ä¾‹ï¼š25æ—¥æ‰•ã„ã®å ´åˆã¯25</small>
                        </div>
                    </div>

                    <!-- éµå—ã‘æ¸¡ã—è¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-key me-2"></i>éµå—ã‘æ¸¡ã—è¨­å®š
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newDefaultKeyHandoverLocation" class="form-label" style="font-weight: 500;">
                            ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå—ã‘æ¸¡ã—å ´æ‰€
                        </label>
                        <input type="text" class="form-control" id="newDefaultKeyHandoverLocation" name="default_key_handover_location">
                        <small class="text-muted">æ¡ˆä»¶ç™»éŒ²æ™‚ã«è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆæ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ï¼‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="newKeyHandoverNotes" class="form-label" style="font-weight: 500;">
                            ç‰¹è¨˜äº‹é …
                        </label>
                        <textarea class="form-control" id="newKeyHandoverNotes" name="key_handover_notes" rows="2"></textarea>
                    </div>

                    <!-- å®Œäº†å ±å‘Šè¨­å®š -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-file-alt me-2"></i>å®Œäº†å ±å‘Šè¨­å®š
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newCompletionReportTemplate" class="form-label" style="font-weight: 500;">
                            å®Œäº†å ±å‘Šã‚·ãƒ¼ãƒˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
                        </label>
                        <input type="file" class="form-control" id="newCompletionReportTemplate" name="completion_report_template" accept=".xlsx,.xls,.pdf,.doc,.docx">
                        <small class="text-muted">Excel/PDFå½¢å¼ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</small>
                    </div>

                    <div class="mb-3">
                        <label for="newCompletionReportNotes" class="form-label" style="font-weight: 500;">
                            å®Œäº†å ±å‘Šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹
                        </label>
                        <textarea class="form-control" id="newCompletionReportNotes" name="completion_report_notes" rows="3"></textarea>
                        <small class="text-muted">æ¡ˆä»¶ç™»éŒ²æ™‚ã«å®Œäº†å ±å‘Šå†…å®¹ã¨ã—ã¦è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆæ¡ˆä»¶ã”ã¨ã«å¤‰æ›´å¯èƒ½ï¼‰</small>
                    </div>

                    <!-- é‹ç”¨ãƒ«ãƒ¼ãƒ«ãƒ»ç‰¹è¨˜äº‹é … -->
                    <div style="border-bottom: 2px solid #3b82f6; padding-bottom: 0.5rem; margin-bottom: 1.5rem; margin-top: 2rem;">
                        <h6 class="mb-0" style="font-weight: 600; color: #374151;">
                            <i class="fas fa-clipboard-list me-2"></i>é‹ç”¨ãƒ«ãƒ¼ãƒ«ãƒ»ç‰¹è¨˜äº‹é …
                        </h6>
                    </div>

                    <div class="mb-3">
                        <label for="newSpecialNotes" class="form-label" style="font-weight: 500;">
                            ç‰¹è¨˜äº‹é …
                        </label>
                        <textarea class="form-control" id="newSpecialNotes" name="special_notes" rows="3"></textarea>
                        <small class="text-muted">ã“ã®ä¼šç¤¾ã¨ã®å–å¼•ã«ãŠã‘ã‚‹æ³¨æ„äº‹é …ã‚„é‹ç”¨ãƒ«ãƒ¼ãƒ«ã‚’è¨˜è¼‰</small>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="newIsActive" name="is_active" checked>
                        <label class="form-check-label" for="newIsActive">
                            ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
                        </label>
                    </div>
                </form>

                <!-- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
                <div id="clientCompanyCreateError" class="alert alert-danger mt-3" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-primary" id="submitClientCompanyBtn" onclick="submitNewClientCompany()">
                    <i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// å…ƒè«‹ä¼šç¤¾æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
window.openClientCompanyCreateModal = function() {
    console.log('âœ… openClientCompanyCreateModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä¿å­˜
    saveFormValues();

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('clientCompanyCreateForm').reset();

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#clientCompanyCreateError').hide();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('clientCompanyCreateModal'));
    modal.show();
};

// å…ƒè«‹ä¼šç¤¾ã‚’æ–°è¦ä½œæˆ
window.submitNewClientCompany = function() {
    console.log('âœ… submitNewClientCompany called');

    const form = document.getElementById('clientCompanyCreateForm');
    const formData = new FormData(form);

    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#clientCompanyCreateError').hide();

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆIDçµŒç”±ã§å–å¾—ï¼‰
    const submitBtn = document.getElementById('submitClientCompanyBtn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...';

    $.ajax({
        url: '{% url "order_management:client_company_create_ajax" %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            if (response.success) {
                console.log('âœ… å…ƒè«‹ä¼šç¤¾ä½œæˆæˆåŠŸ:', response.company);

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('clientCompanyCreateModal'));
                if (modal) modal.hide();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«æ–°ã—ã„å…ƒè«‹ä¼šç¤¾ã‚’è¿½åŠ 
                const select = $('#clientCompanySelect');
                const newOption = new Option(
                    response.company.company_name + (response.company.address ? ' - ' + response.company.address : ''),
                    response.company.id,
                    false,
                    true
                );
                $(newOption).attr('data-name', response.company.company_name);
                $(newOption).attr('data-address', response.company.address || '');
                $(newOption).attr('data-payment-cycle', response.company.payment_cycle || '');
                $(newOption).attr('data-closing-day', response.company.closing_day || '');
                $(newOption).attr('data-payment-day', response.company.payment_day || '');
                select.append(newOption);

                // æ–°ã—ã„å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠ
                select.val(response.company.id).trigger('change');

                // å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°ï¼ˆç®¡ç†ãƒ‘ãƒãƒ«ãŒé–‹ã„ã¦ã„ã‚‹å ´åˆï¼‰
                if (typeof refreshClientCompanyList === 'function') {
                    console.log('âœ… å…ƒè«‹ä¼šç¤¾ä¸€è¦§ã‚’æ›´æ–°ä¸­...');
                    setTimeout(function() {
                        refreshClientCompanyList();
                    }, 100);
                }

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (typeof toastr !== 'undefined') {
                    toastr.success('å…ƒè«‹ä¼šç¤¾ã€Œ' + response.company.company_name + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
                } else {
                    alert('å…ƒè«‹ä¼šç¤¾ã€Œ' + response.company.company_name + 'ã€ã‚’ä½œæˆã—ã¾ã—ãŸ');
                }

                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
            } else {
                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                let errorHtml = '<strong>ã‚¨ãƒ©ãƒ¼:</strong><ul class="mb-0">';
                if (response.errors) {
                    for (let field in response.errors) {
                        response.errors[field].forEach(function(error) {
                            errorHtml += '<li>' + error + '</li>';
                        });
                    }
                } else {
                    errorHtml += '<li>' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ') + '</li>';
                }
                errorHtml += '</ul>';
                $('#clientCompanyCreateError').html(errorHtml).show();

                // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
            }
        },
        error: function(xhr, status, error) {
            console.error('âŒ å…ƒè«‹ä¼šç¤¾ä½œæˆã‚¨ãƒ©ãƒ¼:', error);
            $('#clientCompanyCreateError').html('<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + (xhr.responseJSON?.error || 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();

            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-save me-2"></i>ç™»éŒ²ã™ã‚‹';
        }
    });
};

// ===== å·¥äº‹ç¨®åˆ¥ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« =====
// ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
window.openWorkTypeManagementModal = function() {
    console.log('âœ… openWorkTypeManagementModal called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('workTypeManagementModal'));
    modal.show();

    // å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    loadWorkTypeList();
};

// å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
function loadWorkTypeList() {
    $.ajax({
        url: '{% url "order_management:work_type_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                renderWorkTypeList(response.work_types);
            } else {
                $('#workTypeList').html('<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
            }
        },
        error: function() {
            $('#workTypeList').html('<div class="alert alert-danger">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>');
        }
    });
}

// å·¥äº‹ç¨®åˆ¥ä¸€è¦§ã‚’æç”»
function renderWorkTypeList(workTypes) {
    if (workTypes.length === 0) {
        $('#workTypeList').html('<div class="text-muted text-center py-3">ç™»éŒ²æ¸ˆã¿ã®å·¥äº‹ç¨®åˆ¥ã¯ã‚ã‚Šã¾ã›ã‚“</div>');
        return;
    }

    let html = '<div class="list-group">';
    workTypes.forEach(function(workType, index) {
        const escapedName = $('<div>').text(workType.name).html();
        const escapedDesc = $('<div>').text(workType.description || '').html();

        html += `
            <div class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <i class="fas fa-tools me-2"></i>${escapedName}
                        </h6>
                        ${workType.description ? `<p class="mb-1 small text-muted">${escapedDesc}</p>` : ''}
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="moveWorkType(${workType.id}, 'up')" ${index === 0 ? 'disabled' : ''} title="ä¸Šã¸ç§»å‹•">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="moveWorkType(${workType.id}, 'down')" ${index === workTypes.length - 1 ? 'disabled' : ''} title="ä¸‹ã¸ç§»å‹•">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button type="button" class="btn btn-outline-primary"
                                data-id="${workType.id}"
                                data-name="${escapedName}"
                                data-description="${escapedDesc}"
                                onclick="editWorkTypeFromButton(this)"
                                title="ç·¨é›†">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button type="button" class="btn btn-outline-danger"
                                data-id="${workType.id}"
                                data-name="${escapedName}"
                                onclick="deleteWorkTypeFromButton(this)"
                                title="å‰Šé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';

    $('#workTypeList').html(html);
}

// ãƒœã‚¿ãƒ³ã‹ã‚‰å·¥äº‹ç¨®åˆ¥ã‚’ç·¨é›†ï¼ˆdataå±æ€§ã‚’ä½¿ç”¨ï¼‰
window.editWorkTypeFromButton = function(button) {
    const id = $(button).data('id');
    const name = $(button).data('name');
    const description = $(button).data('description');
    editWorkType(id, name, description);
};

// å·¥äº‹ç¨®åˆ¥ã‚’ç·¨é›†
window.editWorkType = function(id, name, description) {
    console.log('âœ… editWorkType called:', id, name);

    // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
    $('#workTypeId').val(id);
    $('#workTypeName').val(name);
    $('#workTypeDescription').val(description);

    // ãƒœã‚¿ãƒ³ã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«
    $('#workTypeSubmitBtn').html('<i class="fas fa-save me-2"></i>æ›´æ–°ã™ã‚‹');
    $('#workTypeCancelBtn').show();

    // ãƒ•ã‚©ãƒ¼ãƒ ä½ç½®ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('#workTypeForm')[0].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
};

// ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
window.cancelWorkTypeEdit = function() {
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#workTypeForm')[0].reset();
    $('#workTypeId').val('');

    // ãƒœã‚¿ãƒ³ã‚’æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰ã«
    $('#workTypeSubmitBtn').html('<i class="fas fa-save me-2"></i>ä¿å­˜ã™ã‚‹');
    $('#workTypeCancelBtn').hide();

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#workTypeError').hide();
    $('#workTypeSuccess').hide();
};

// ãƒœã‚¿ãƒ³ã‹ã‚‰å·¥äº‹ç¨®åˆ¥ã‚’å‰Šé™¤ï¼ˆdataå±æ€§ã‚’ä½¿ç”¨ï¼‰
window.deleteWorkTypeFromButton = function(button) {
    const id = $(button).data('id');
    const name = $(button).data('name');
    deleteWorkType(id, name);
};

// å·¥äº‹ç¨®åˆ¥ã‚’å‰Šé™¤
window.deleteWorkType = function(id, name) {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
    $('#deleteWorkTypeName').text(name);

    // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('workTypeDeleteConfirmModal'));
    modal.show();

    // backdropã®z-indexã‚’èª¿æ•´ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã«å®Ÿè¡Œï¼‰
    setTimeout(function() {
        $('.modal-backdrop').last().css('z-index', 10049);
    }, 10);

    // å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆæ—¢å­˜ã®ãƒãƒ³ãƒ‰ãƒ©ã‚’å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ ï¼‰
    $('#confirmDeleteWorkTypeBtn').off('click').on('click', function() {
        // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
        $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>å‰Šé™¤ä¸­...');

        $.ajax({
            url: '{% url "order_management:work_type_delete_ajax" %}',
            type: 'POST',
            data: {
                id: id,
                csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    modal.hide();

                    $('#workTypeSuccess').html('<i class="fas fa-check-circle me-2"></i>' + response.message).show();
                    setTimeout(function() { $('#workTypeSuccess').hide(); }, 3000);

                    // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                    loadWorkTypeList();

                    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                    refreshWorkTypeDropdown();
                } else {
                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                    modal.hide();

                    $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
                }
            },
            error: function(xhr) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                modal.hide();

                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
            },
            complete: function() {
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                $('#confirmDeleteWorkTypeBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>å‰Šé™¤ã™ã‚‹');
            }
        });
    });
};

// å·¥äº‹ç¨®åˆ¥ã‚’ä¸¦ã³æ›¿ãˆ
window.moveWorkType = function(id, direction) {
    $.ajax({
        url: '{% url "order_management:work_type_reorder_ajax" %}',
        type: 'POST',
        data: {
            id: id,
            direction: direction,
            csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                loadWorkTypeList();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                refreshWorkTypeDropdown();
            } else {
                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
            }
        },
        error: function(xhr) {
            $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
        }
    });
};

// ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
$(document).ready(function() {
$('#workTypeForm').on('submit', function(e) {
    e.preventDefault();

    const workTypeId = $('#workTypeId').val();
    const isUpdate = workTypeId !== '';
    const url = isUpdate
        ? '{% url "order_management:work_type_update_ajax" %}'
        : '{% url "order_management:work_type_create_ajax" %}';

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
    $('#workTypeError').hide();
    $('#workTypeSuccess').hide();

    // ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const submitBtn = $('#workTypeSubmitBtn');
    submitBtn.prop('disabled', true);
    submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>ä¿å­˜ä¸­...');

    // ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    const formData = {
        name: $('#workTypeName').val(),
        description: $('#workTypeDescription').val(),
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    };

    if (isUpdate) {
        formData.id = workTypeId;
    }

    $.ajax({
        url: url,
        type: 'POST',
        data: formData,
        success: function(response) {
            if (response.success) {
                const message = isUpdate ? 'å·¥äº‹ç¨®åˆ¥ã‚’æ›´æ–°ã—ã¾ã—ãŸ' : 'å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ ã—ã¾ã—ãŸ';
                $('#workTypeSuccess').html('<i class="fas fa-check-circle me-2"></i>' + message).show();
                setTimeout(function() { $('#workTypeSuccess').hide(); }, 3000);

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                cancelWorkTypeEdit();

                // ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                loadWorkTypeList();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
                refreshWorkTypeDropdown(response.work_type.id);
            } else {
                $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + response.error).show();
            }
        },
        error: function(xhr) {
            $('#workTypeError').html('<i class="fas fa-exclamation-circle me-2"></i>' + (xhr.responseJSON?.error || 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ')).show();
        },
        complete: function() {
            // ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            submitBtn.prop('disabled', false);
            const buttonText = isUpdate ? 'æ›´æ–°ã™ã‚‹' : 'ä¿å­˜ã™ã‚‹';
            submitBtn.html('<i class="fas fa-save me-2"></i>' + buttonText);
        }
    });
});
});

// å·¥äº‹ç¨®åˆ¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
function refreshWorkTypeDropdown(selectedId) {
    $.ajax({
        url: '{% url "order_management:work_type_list_ajax" %}',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                const select = $('[name="work_type"]');
                const currentValue = selectedId || select.val();

                // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†æ§‹ç¯‰
                select.empty();
                select.append('<option value="">-- å·¥äº‹ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>');

                // å·¥äº‹ç¨®åˆ¥ã‚’è¿½åŠ ï¼ˆè¡¨ç¤ºé †ã§æ—¢ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹ï¼‰
                response.work_types.forEach(function(workType) {
                    const option = new Option(workType.name, workType.name);
                    select.append(option);
                });

                // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
                if (currentValue) {
                    select.val(currentValue);
                }
            }
        }
    });
}

// å…ƒè«‹ä¼šç¤¾é¸æŠæ™‚ã«æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›
$(document).ready(function() {
$('#clientCompanySelect').on('change', function() {
    const selectedOption = $(this).find('option:selected');

    if (selectedOption.val()) {
        // dataå±æ€§ã‹ã‚‰å€¤ã‚’å–å¾—
        const paymentCycle = selectedOption.data('payment-cycle') || '';
        const closingDay = selectedOption.data('closing-day') || '';
        const paymentOffsetMonths = selectedOption.data('payment-offset-months');
        const paymentDay = selectedOption.data('payment-day') || '';

        // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
        $('[name="payment_cycle"]').val(paymentCycle);
        $('[name="closing_day"]').val(closingDay);
        $('[name="payment_offset_months"]').val(paymentOffsetMonths !== undefined && paymentOffsetMonths !== '' ? paymentOffsetMonths : '');
        $('[name="payment_day"]').val(paymentDay);

        // å…ƒè«‹åã¨ä½æ‰€ã‚‚è‡ªå‹•å…¥åŠ›
        const companyName = selectedOption.data('name') || '';
        const companyAddress = selectedOption.data('address') || '';
        $('[name="client_name"]').val(companyName);
        $('[name="client_address"]').val(companyAddress);

        console.log('âœ… å…ƒè«‹ä¼šç¤¾ã®æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›ã—ã¾ã—ãŸ');
    } else {
        // é¸æŠã‚’è§£é™¤ã—ãŸå ´åˆã¯ã‚¯ãƒªã‚¢
        $('[name="payment_cycle"]').val('');
        $('[name="closing_day"]').val('');
        $('[name="payment_offset_months"]').val('');
        $('[name="payment_day"]').val('');
        $('[name="client_name"]').val('');
        $('[name="client_address"]').val('');
    }
});

// ========================================
// çµŒè²»é …ç›®ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»åˆè¨ˆè¨ˆç®—
// ========================================
let expenseItemCounter = 2; // æ—¢å­˜ã®2ã¤ãŒã‚ã‚‹ã®ã§3ã‹ã‚‰é–‹å§‹

// çµŒè²»é …ç›®ã‚’è¿½åŠ 
window.addExpenseItem = function() {
    expenseItemCounter++;
    const tbody = document.getElementById('expenseItemsTableBody');
    const newRow = document.createElement('tr');
    newRow.setAttribute('data-expense-index', expenseItemCounter);

    newRow.innerHTML = `
        <td>
            <input type="text" class="form-control form-control-sm"
                   name="expense_item_${expenseItemCounter}"
                   placeholder="ä¾‹: è«¸çµŒè²»">
        </td>
        <td>
            <div class="input-group input-group-sm">
                <span class="input-group-text">Â¥</span>
                <input type="number" class="form-control expense-amount-input"
                       name="expense_amount_${expenseItemCounter}"
                       value="0" min="0" step="1000"
                       onchange="calculateExpenseTotal()">
            </div>
        </td>
        <td>
            <button type="button" class="btn btn-sm btn-outline-danger"
                    onclick="removeExpenseItem(this)" title="å‰Šé™¤">
                <i class="fas fa-trash"></i>
            </button>
        </td>
    `;

    tbody.appendChild(newRow);
    calculateExpenseTotal();
};

// çµŒè²»é …ç›®ã‚’å‰Šé™¤
window.removeExpenseItem = function(button) {
    const row = button.closest('tr');
    const index = row.getAttribute('data-expense-index');

    // æœ€ä½1ã¤ã¯æ®‹ã™
    const tbody = document.getElementById('expenseItemsTableBody');
    if (tbody.querySelectorAll('tr').length <= 1) {
        alert('æœ€ä½1ã¤ã®çµŒè²»é …ç›®ãŒå¿…è¦ã§ã™');
        return;
    }

    row.remove();
    calculateExpenseTotal();
};

// çµŒè²»åˆè¨ˆã‚’è¨ˆç®—
window.calculateExpenseTotal = function() {
    let total = 0;

    // expense_amount_1, expense_amount_2ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã‚’å–å¾—
    const amount1Input = document.getElementById('{{ form.expense_amount_1.id_for_label }}');
    const amount2Input = document.getElementById('{{ form.expense_amount_2.id_for_label }}');

    if (amount1Input && amount1Input.value) {
        total += parseFloat(amount1Input.value) || 0;
    }
    if (amount2Input && amount2Input.value) {
        total += parseFloat(amount2Input.value) || 0;
    }

    // å‹•çš„ã«è¿½åŠ ã•ã‚ŒãŸçµŒè²»é …ç›®ã®åˆè¨ˆ
    const dynamicAmounts = document.querySelectorAll('#expenseItemsTableBody .expense-amount-input');
    dynamicAmounts.forEach(input => {
        if (input.value) {
            total += parseFloat(input.value) || 0;
        }
    });

    // åˆè¨ˆã‚’è¡¨ç¤º
    const totalElement = document.getElementById('expenseTotalAmount');
    if (totalElement) {
        totalElement.textContent = total.toLocaleString();
    }
};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã¨å…¥åŠ›æ™‚ã«åˆè¨ˆã‚’è¨ˆç®—
document.addEventListener('DOMContentLoaded', function() {
    // æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    const amount1Input = document.getElementById('{{ form.expense_amount_1.id_for_label }}');
    const amount2Input = document.getElementById('{{ form.expense_amount_2.id_for_label }}');

    if (amount1Input) {
        amount1Input.addEventListener('input', calculateExpenseTotal);
        amount1Input.addEventListener('change', calculateExpenseTotal);
    }
    if (amount2Input) {
        amount2Input.addEventListener('input', calculateExpenseTotal);
        amount2Input.addEventListener('change', calculateExpenseTotal);
    }

    // åˆå›è¨ˆç®—
    calculateExpenseTotal();
});

// ========================================
// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã®è¿½åŠ ãƒ»å‰Šé™¤ãƒ»ä¸¦ã³æ›¿ãˆ
// ========================================
let scheduleSteps = [];
let scheduleStepCounter = 0;

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
window.addScheduleStep = function(stepData = null) {
    scheduleStepCounter++;
    const stepId = stepData ? stepData.id : `step_${scheduleStepCounter}`;
    const stepName = stepData ? stepData.name : '';
    const stepDate = stepData ? stepData.date : '';
    const stepCompleted = stepData ? stepData.completed : false;

    const step = {
        id: stepId,
        name: stepName,
        date: stepDate,
        completed: stepCompleted,
        order: scheduleSteps.length
    };

    scheduleSteps.push(step);
    renderScheduleSteps();
    updateScheduleStepsData();
};

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤
window.removeScheduleStep = function(stepId) {
    scheduleSteps = scheduleSteps.filter(s => s.id !== stepId);
    renderScheduleSteps();
    updateScheduleStepsData();
};

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¸Šã«ç§»å‹•
window.moveScheduleStepUp = function(stepId) {
    const index = scheduleSteps.findIndex(s => s.id === stepId);
    if (index > 0) {
        [scheduleSteps[index - 1], scheduleSteps[index]] = [scheduleSteps[index], scheduleSteps[index - 1]];
        renderScheduleSteps();
        updateScheduleStepsData();
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¸‹ã«ç§»å‹•
window.moveScheduleStepDown = function(stepId) {
    const index = scheduleSteps.findIndex(s => s.id === stepId);
    if (index < scheduleSteps.length - 1) {
        [scheduleSteps[index], scheduleSteps[index + 1]] = [scheduleSteps[index + 1], scheduleSteps[index]];
        renderScheduleSteps();
        updateScheduleStepsData();
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±ã‚’æ›´æ–°
window.updateScheduleStep = function(stepId, field, value) {
    const step = scheduleSteps.find(s => s.id === stepId);
    if (step) {
        step[field] = value;
        updateScheduleStepsData();
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰
function renderScheduleSteps() {
    const container = document.getElementById('scheduleStepsList');
    if (!container) return;

    if (scheduleSteps.length === 0) {
        container.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="fas fa-info-circle me-2"></i>ã€Œã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦å·¥ç¨‹ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
            </div>
        `;
        return;
    }

    let html = '<div class="progress-steps-list">';

    scheduleSteps.forEach((step, index) => {
        const stepClass = step.completed ? 'completed' : '';
        const statusHtml = step.completed
            ? '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†</div>'
            : '<div class="progress-step-date">æœªå®Œäº†</div>';

        html += `
            <div class="progress-step ${stepClass} card border" data-step-id="${step.id}" style="margin-bottom: 12px;">
                <div class="card-body p-2">
                    <div class="progress-step-header d-flex justify-content-between align-items-center" onclick="toggleStepContent('${step.id}')">
                        <div class="d-flex align-items-center flex-grow-1">
                            <span class="badge bg-primary me-2">${index + 1}</span>
                            <span class="progress-step-label flex-grow-1">${step.name || 'ã‚¹ãƒ†ãƒƒãƒ—åæœªè¨­å®š'}</span>
                            <i class="fas fa-chevron-down toggle-icon ms-2" id="toggle-icon-${step.id}"></i>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="event.stopPropagation(); moveScheduleStepUp('${step.id}')"
                                    ${index === 0 ? 'disabled' : ''}
                                    title="ä¸Šã«ç§»å‹•">
                                <i class="fas fa-arrow-up"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary"
                                    onclick="event.stopPropagation(); moveScheduleStepDown('${step.id}')"
                                    ${index === scheduleSteps.length - 1 ? 'disabled' : ''}
                                    title="ä¸‹ã«ç§»å‹•">
                                <i class="fas fa-arrow-down"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger"
                                    onclick="event.stopPropagation(); removeScheduleStep('${step.id}')"
                                    title="å‰Šé™¤">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    ${statusHtml}
                    <div class="progress-step-content" id="step-content-${step.id}" style="display: none;">
                        <div class="mb-2">
                            <label class="form-label small mb-1">ã‚¹ãƒ†ãƒƒãƒ—å</label>
                            <input type="text" class="form-control form-control-sm"
                                   value="${step.name}"
                                   onchange="updateScheduleStep('${step.id}', 'name', this.value)"
                                   placeholder="ä¾‹: ç€å·¥æº–å‚™">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small mb-1">äºˆå®šæ—¥</label>
                            <input type="date" class="form-control form-control-sm"
                                   value="${step.date}"
                                   onchange="updateScheduleStep('${step.id}', 'date', this.value)">
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox"
                                   ${step.completed ? 'checked' : ''}
                                   onchange="updateScheduleStep('${step.id}', 'completed', this.checked)"
                                   id="completed-${step.id}">
                            <label class="form-check-label small" for="completed-${step.id}">
                                <i class="fas fa-check me-1"></i>å®Œäº†
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// ã‚¹ãƒ†ãƒƒãƒ—ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
window.toggleStepContent = function(stepId) {
    const content = document.getElementById(`step-content-${stepId}`);
    const icon = document.getElementById(`toggle-icon-${stepId}`);

    if (content && icon) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
};

// çµŒè²»ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
window.toggleExpenseSection = function() {
    const content = document.getElementById('expenseSection');
    const icon = document.getElementById('expenseToggleIcon');

    if (content && icon) {
        if (content.style.display === 'none') {
            content.style.display = 'block';
            icon.classList.remove('fa-chevron-down');
            icon.classList.add('fa-chevron-up');
        } else {
            content.style.display = 'none';
            icon.classList.remove('fa-chevron-up');
            icon.classList.add('fa-chevron-down');
        }
    }
};

// éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã« JSON ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
function updateScheduleStepsData() {
    const dataField = document.getElementById('scheduleStepsData');
    if (dataField) {
        dataField.value = JSON.stringify(scheduleSteps);
    }
}

// ========================================
// å—æ³¨é‡‘é¡å°è¨ˆã®è¨ˆç®—
// ========================================
window.calculateOrderAmountSubtotal = function() {
    const orderAmountInput = document.getElementById('{{ form.order_amount.id_for_label }}');
    const parkingFeeInput = document.getElementById('{{ form.parking_fee.id_for_label }}');
    const subtotalElement = document.getElementById('orderAmountSubtotal');

    if (!orderAmountInput || !parkingFeeInput || !subtotalElement) return;

    const orderAmount = parseFloat(orderAmountInput.value) || 0;
    const parkingFee = parseFloat(parkingFeeInput.value) || 0;
    const subtotal = orderAmount + parkingFee;

    subtotalElement.textContent = subtotal.toLocaleString();
};

// ========================================
// å¥‘ç´„æ—¥ã‹ã‚‰å…¥é‡‘äºˆå®šæ—¥ã‚’è‡ªå‹•è¨ˆç®—
// ========================================
// å…¥é‡‘äºˆå®šæ—¥ã®åŸºæº–æ—¥é¸æŠå‡¦ç†
// ========================================
window.updateIncomingPaymentBaseDate = function() {
    const baseDateType = document.getElementById('incomingPaymentBaseDateType').value;
    const customDateInput = document.getElementById('incomingPaymentCustomBaseDate');
    const baseDateDisplay = document.getElementById('incomingPaymentBaseDateDisplay');

    // ä»»æ„æ—¥é¸æŠæ™‚ã®ã¿ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜å…¥åŠ›ã‚’è¡¨ç¤º
    if (baseDateType === 'custom') {
        customDateInput.style.display = 'block';
    } else {
        customDateInput.style.display = 'none';
    }

    // åŸºæº–æ—¥ã‚’å–å¾—ã—ã¦è¡¨ç¤º
    let baseDate = null;
    let baseDateText = '-';

    if (baseDateType === 'contract') {
        const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
        if (contractDateInput && contractDateInput.value) {
            baseDate = contractDateInput.value;
            baseDateText = baseDate + ' (å¥‘ç´„æ—¥)';
        } else {
            baseDateText = 'æœªå…¥åŠ› (å¥‘ç´„æ—¥)';
        }
    } else if (baseDateType === 'completion') {
        const completionDateInput = document.getElementById('{{ form.completion_date.id_for_label }}');
        if (completionDateInput && completionDateInput.value) {
            baseDate = completionDateInput.value;
            baseDateText = baseDate + ' (å®Œå·¥æ—¥)';
        } else {
            baseDateText = 'æœªå…¥åŠ› (å®Œå·¥æ—¥)';
        }
    } else if (baseDateType === 'custom') {
        if (customDateInput.value) {
            baseDate = customDateInput.value;
            baseDateText = baseDate + ' (ä»»æ„æ—¥)';
        } else {
            baseDateText = 'æœªé¸æŠ (ä»»æ„æ—¥)';
        }
    }

    baseDateDisplay.textContent = baseDateText;
};

// ========================================
window.autoCalculatePaymentDueDateFromContract = function() {
    // åŸºæº–æ—¥ã‚’å–å¾—
    const baseDateType = document.getElementById('incomingPaymentBaseDateType').value;
    let baseDate = null;

    if (baseDateType === 'contract') {
        const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
        if (!contractDateInput || !contractDateInput.value) {
            alert('å¥‘ç´„æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        baseDate = new Date(contractDateInput.value);
    } else if (baseDateType === 'completion') {
        const completionDateInput = document.getElementById('{{ form.completion_date.id_for_label }}');
        if (!completionDateInput || !completionDateInput.value) {
            alert('å®Œå·¥æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        baseDate = new Date(completionDateInput.value);
    } else if (baseDateType === 'custom') {
        const customDateInput = document.getElementById('incomingPaymentCustomBaseDate');
        if (!customDateInput || !customDateInput.value) {
            alert('ä»»æ„ã®åŸºæº–æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        baseDate = new Date(customDateInput.value);
    }

    // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’å–å¾—
    const closingDayInput = document.getElementById('{{ form.closing_day.id_for_label }}');
    const paymentOffsetInput = document.getElementById('{{ form.payment_offset_months.id_for_label }}');
    const paymentDayInput = document.getElementById('{{ form.payment_day.id_for_label }}');

    if (!closingDayInput || !closingDayInput.value) {
        alert('ç· ã‚æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    if (!paymentDayInput || !paymentDayInput.value) {
        alert('æ”¯æ‰•æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    const closingDay = parseInt(closingDayInput.value);
    const paymentOffsetMonths = parseInt(paymentOffsetInput.value) || 0;
    const paymentDay = parseInt(paymentDayInput.value);

    // è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯:
    // 1. åŸºæº–æ—¥ã®æœˆã®ç· ã‚æ—¥ã‚’è¨ˆç®—
    // 2. åŸºæº–æ—¥ãŒç· ã‚æ—¥ã‚ˆã‚Šå¾Œãªã‚‰ã€æ¬¡ã®æœˆã®ç· ã‚æ—¥ã¨ã™ã‚‹
    // 3. ç· ã‚æ—¥ + ã‚ªãƒ•ã‚»ãƒƒãƒˆæœˆ + æ”¯æ‰•æ—¥ã§å…¥é‡‘äºˆå®šæ—¥ã‚’è¨ˆç®—

    let closingDate = new Date(baseDate.getFullYear(), baseDate.getMonth(), closingDay);

    // åŸºæº–æ—¥ãŒç· ã‚æ—¥ã‚ˆã‚Šå¾Œã®å ´åˆã€æ¬¡ã®æœˆã®ç· ã‚æ—¥ã«ã™ã‚‹
    if (baseDate.getDate() > closingDay) {
        closingDate.setMonth(closingDate.getMonth() + 1);
    }

    // æ”¯æ‰•æœˆã‚’è¨ˆç®—ï¼ˆç· ã‚æ—¥ã‹ã‚‰ã‚ªãƒ•ã‚»ãƒƒãƒˆæœˆå¾Œï¼‰
    const paymentDate = new Date(closingDate);
    paymentDate.setMonth(paymentDate.getMonth() + paymentOffsetMonths);
    paymentDate.setDate(paymentDay);

    // å…¥é‡‘äºˆå®šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
    const paymentDueDateInput = document.getElementById('{{ form.payment_due_date.id_for_label }}');
    if (paymentDueDateInput) {
        const year = paymentDate.getFullYear();
        const month = String(paymentDate.getMonth() + 1).padStart(2, '0');
        const day = String(paymentDate.getDate()).padStart(2, '0');
        paymentDueDateInput.value = `${year}-${month}-${day}`;

        console.log('âœ… å…¥é‡‘äºˆå®šæ—¥ã‚’è‡ªå‹•è¨ˆç®—ã—ã¾ã—ãŸ:', paymentDueDateInput.value);
    }
};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å—æ³¨é‡‘é¡å°è¨ˆã‚’è¨ˆç®—ï¼ˆè¦ªã®DOMContentLoadedã«çµ±åˆï¼‰
const orderAmountInput = document.getElementById('{{ form.order_amount.id_for_label }}');
const parkingFeeInput = document.getElementById('{{ form.parking_fee.id_for_label }}');

if (orderAmountInput) {
    orderAmountInput.addEventListener('input', calculateOrderAmountSubtotal);
    orderAmountInput.addEventListener('change', calculateOrderAmountSubtotal);
}
if (parkingFeeInput) {
    parkingFeeInput.addEventListener('input', calculateOrderAmountSubtotal);
    parkingFeeInput.addEventListener('change', calculateOrderAmountSubtotal);
}

// åˆå›è¨ˆç®—
calculateOrderAmountSubtotal();

// å…¥é‡‘äºˆå®šæ—¥ã®åŸºæº–æ—¥è¡¨ç¤ºã‚’åˆæœŸåŒ–
const incomingBaseDateTypeSelect = document.getElementById('incomingPaymentBaseDateType');
if (incomingBaseDateTypeSelect) {
    // åˆæœŸè¡¨ç¤ºã‚’æ›´æ–°
    updateIncomingPaymentBaseDate();

    // å¥‘ç´„æ—¥ãƒ»å®Œå·¥æ—¥ãŒå¤‰æ›´ã•ã‚ŒãŸæ™‚ã‚‚åŸºæº–æ—¥è¡¨ç¤ºã‚’æ›´æ–°
    const contractDateInput = document.getElementById('{{ form.contract_date.id_for_label }}');
    const completionDateInput = document.getElementById('{{ form.completion_date.id_for_label }}');

    if (contractDateInput) {
        contractDateInput.addEventListener('change', updateIncomingPaymentBaseDate);
    }
    if (completionDateInput) {
        completionDateInput.addEventListener('change', updateIncomingPaymentBaseDate);
    }
}

// ========================================
// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚»ã‚¯ã‚·ãƒ§ãƒ³ (ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†)
// ========================================

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã®å®šç¾© (formç”¨ã®ç°¡æ˜“ç‰ˆ)
const formDefaultSteps = [
    { name: 'ç«‹ã¡ä¼šã„æ—¥', icon: 'fas fa-user-check', key: 'attendance' },
    { name: 'ç¾èª¿æ—¥', icon: 'fas fa-clipboard-list', key: 'survey' },
    { name: 'è¦‹ç©æ›¸ç™ºè¡Œæ—¥', icon: 'fas fa-file-invoice', key: 'estimate' },
    { name: 'ç€å·¥æ—¥', icon: 'fas fa-hard-hat', key: 'construction_start' },
    { name: 'å®Œå·¥æ—¥', icon: 'fas fa-check-circle', key: 'completion' }
];

// è¿½åŠ å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã®å®šç¾©
const formAvailableSteps = [
    { name: 'å¥‘ç´„', icon: 'fas fa-handshake', key: 'contract' },
    { name: 'è«‹æ±‚æ›¸ç™ºè¡Œ', icon: 'fas fa-file-invoice-dollar', key: 'invoice' },
    { name: 'è¨±å¯ç”³è«‹', icon: 'fas fa-file-signature', key: 'permit_application' },
    { name: 'è³‡æç™ºæ³¨', icon: 'fas fa-boxes', key: 'material_order' },
    { name: 'æ¤œæŸ»', icon: 'fas fa-clipboard-check', key: 'inspection' }
];

let formSortable = null;

// ã‚¹ãƒ†ãƒƒãƒ—HTMLã‚’ç”Ÿæˆï¼ˆã‚«ãƒ¼ãƒ‰å½¢å¼ï¼‰
function generateFormStepHTML(stepData) {
    return `
        <div class="card shadow-sm mb-2 progress-step" data-step="${stepData.key}">
            <div class="card-header p-2 progress-step-header" style="cursor: pointer;">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2 text-muted" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ" style="cursor: grab;"></i>
                        <span style="font-size: 0.9rem;"><i class="${stepData.icon} me-2"></i><span class="progress-step-label">${stepData.name}</span></span>
                    </div>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-secondary">æœªè¨­å®š</span>
                        <button type="button" class="btn btn-outline-danger btn-sm remove-form-step-btn"
                                data-step="${stepData.key}" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤"
                                style="font-size: 0.7rem; padding: 0.15rem 0.4rem;"
                                onclick="event.stopPropagation();">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-2 progress-step-content" style="display: none;">
                <div class="mb-2">
                    <label class="form-label mb-1 small">äºˆå®šæ—¥</label>
                    <input type="date" class="form-control form-control-sm"
                           name="step_${stepData.key}_scheduled_date"
                           placeholder="äºˆå®šæ—¥ã‚’å…¥åŠ›">
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox"
                           name="step_${stepData.key}_completed"
                           id="formStep_${stepData.key}_completed">
                    <label class="form-check-label small" for="formStep_${stepData.key}_completed">
                        å®Œäº†
                    </label>
                </div>
            </div>
        </div>
    `;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸåŒ– (å…¨ã¦é–‰ã˜ãŸçŠ¶æ…‹ã§)
function initializeFormDefaultSteps() {
    const container = document.getElementById('formActiveSteps');
    if (!container) return;

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
    formDefaultSteps.forEach(step => {
        container.insertAdjacentHTML('beforeend', generateFormStepHTML(step));
    });

    // å…¨ã¦ã®.progress-step-contentã‚’éè¡¨ç¤ºã«ã™ã‚‹ (é–‰ã˜ãŸçŠ¶æ…‹)
    document.querySelectorAll('#formActiveSteps .progress-step-content').forEach(content => {
        content.style.display = 'none';
    });

    // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
    renderFormAvailableSteps();

    // Sortableã‚’åˆæœŸåŒ–
    initializeFormSortable();

    // ã‚¹ãƒ†ãƒƒãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚¯ãƒªãƒƒã‚¯ã§é–‹é–‰
    initializeFormStepToggles();

    console.log('âœ“ Default schedule steps initialized (all closed)');
}

// åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
function renderFormAvailableSteps() {
    const container = document.getElementById('formAvailableSteps');
    if (!container) return;

    container.innerHTML = '';

    formAvailableSteps.forEach(step => {
        // ã™ã§ã«è¿½åŠ ã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—
        const existingStep = document.querySelector(`#formActiveSteps .progress-step[data-step="${step.key}"]`);
        if (existingStep) return;

        const stepHTML = `
            <div class="col-auto mb-2">
                <button type="button" class="btn btn-sm btn-outline-primary add-form-step-btn"
                        data-step-key="${step.key}">
                    <i class="${step.icon} me-1"></i>${step.name}+
                </button>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', stepHTML);
    });
}

// Sortableã‚’åˆæœŸåŒ–
function initializeFormSortable() {
    const container = document.getElementById('formActiveSteps');
    if (!container) return;

    if (formSortable) {
        formSortable.destroy();
    }

    formSortable = Sortable.create(container, {
        animation: 150,
        handle: '.drag-handle',
        filter: 'button, .btn, input, select, textarea',
        preventOnFilter: false,
        onEnd: function() {
            updateFormScheduleData();
            console.log('âœ“ Step order changed');
        }
    });
}

// ã‚¹ãƒ†ãƒƒãƒ—ã®é–‹é–‰ã‚’åˆæœŸåŒ–
function initializeFormStepToggles() {
    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã™ã‚‹ãŸã‚ã€cloneNodeã§ç½®ãæ›ãˆ
    const steps = document.querySelectorAll('#formActiveSteps .progress-step-header');
    steps.forEach(header => {
        const newHeader = header.cloneNode(true);
        header.parentNode.replaceChild(newHeader, header);

        newHeader.addEventListener('click', function(e) {
            // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
            if (e.target.closest('button')) return;

            const step = this.closest('.progress-step');
            const content = step.querySelector('.progress-step-content');

            if (content.style.display === 'none' || !content.style.display) {
                content.style.display = 'block';
                step.classList.add('expanded');
            } else {
                content.style.display = 'none';
                step.classList.remove('expanded');
            }
        });
    });
}

// å…¨éƒ¨é–‹ã/å…¨éƒ¨é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®å‡¦ç†
window.formToggleAllSteps = function() {
    const btn = document.getElementById('formToggleAllSteps');
    const btnText = document.getElementById('formToggleButtonText');
    const steps = document.querySelectorAll('#formActiveSteps .progress-step');
    const contents = document.querySelectorAll('#formActiveSteps .progress-step-content');

    // å…¨ã¦å±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const allExpanded = Array.from(steps).every(step => step.classList.contains('expanded'));

    if (allExpanded) {
        // å…¨ã¦é–‰ã˜ã‚‹
        steps.forEach(step => step.classList.remove('expanded'));
        contents.forEach(content => content.style.display = 'none');
        btnText.textContent = 'å…¨éƒ¨é–‹ã';
        btn.querySelector('i').classList.remove('fa-compress-alt');
        btn.querySelector('i').classList.add('fa-expand-alt');
    } else {
        // å…¨ã¦é–‹ã
        steps.forEach(step => step.classList.add('expanded'));
        contents.forEach(content => content.style.display = 'block');
        btnText.textContent = 'å…¨éƒ¨é–‰ã˜ã‚‹';
        btn.querySelector('i').classList.remove('fa-expand-alt');
        btn.querySelector('i').classList.add('fa-compress-alt');
    }
};

// ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('click', function(e) {
    if (e.target.closest('.add-form-step-btn')) {
        const btn = e.target.closest('.add-form-step-btn');
        const stepKey = btn.dataset.stepKey;
        const stepData = formAvailableSteps.find(s => s.key === stepKey);

        if (stepData) {
            // ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
            const container = document.getElementById('formActiveSteps');
            container.insertAdjacentHTML('beforeend', generateFormStepHTML(stepData));

            // æ–°ã—ãè¿½åŠ ã—ãŸã‚¹ãƒ†ãƒƒãƒ—ã‚’é–‰ã˜ãŸçŠ¶æ…‹ã«ã™ã‚‹
            const newStep = container.lastElementChild;
            const newContent = newStep.querySelector('.progress-step-content');
            newContent.style.display = 'none';

            // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’å†æç”»
            renderFormAvailableSteps();

            // Sortableã‚’å†åˆæœŸåŒ–
            initializeFormSortable();

            // ãƒˆã‚°ãƒ«ã‚’å†åˆæœŸåŒ–
            initializeFormStepToggles();

            // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
            updateFormScheduleData();

            console.log(`âœ“ Added step: ${stepData.name}`);
        }
    }
});

// ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('click', function(e) {
    if (e.target.closest('.remove-form-step-btn')) {
        const btn = e.target.closest('.remove-form-step-btn');
        const step = btn.closest('.progress-step');
        const stepKey = step.dataset.step;

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã¯å‰Šé™¤ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
        const isDefaultStep = formDefaultSteps.some(s => s.key === stepKey);
        if (isDefaultStep) {
            if (typeof toastr !== 'undefined') {
                toastr.warning('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¹ãƒ†ãƒƒãƒ—ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
            }
            return;
        }

        step.remove();

        // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’å†æç”»
        renderFormAvailableSteps();

        // ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        updateFormScheduleData();

        console.log(`âœ“ Removed step: ${stepKey}`);
    }
});

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’JSONå½¢å¼ã§éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ä¿å­˜
function updateFormScheduleData() {
    const steps = document.querySelectorAll('#formActiveSteps .progress-step');
    const stepsData = [];

    steps.forEach((step, index) => {
        const stepKey = step.dataset.step;
        const scheduledDate = step.querySelector(`input[name="step_${stepKey}_scheduled_date"]`)?.value || '';
        const completed = step.querySelector(`input[name="step_${stepKey}_completed"]`)?.checked || false;

        stepsData.push({
            key: stepKey,
            order: index + 1,
            scheduled_date: scheduledDate,
            completed: completed
        });
    });

    const hiddenField = document.getElementById('formScheduleStepsData');
    if (hiddenField) {
        hiddenField.value = JSON.stringify(stepsData);
        console.log('âœ“ Schedule data updated:', stepsData);
    }
}

// å…¥åŠ›å¤‰æ›´æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
document.addEventListener('change', function(e) {
    if (e.target.matches('#formActiveSteps input[type="date"]') ||
        e.target.matches('#formActiveSteps input[type="checkbox"]')) {
        updateFormScheduleData();
    }
});

// ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®š
const formToggleBtn = document.getElementById('formToggleAllSteps');
if (formToggleBtn) {
    formToggleBtn.addEventListener('click', formToggleAllSteps);
}

// ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸåŒ–
initializeFormDefaultSteps();

});
</script>

<style>
/* ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.schedule-steps-container {
    max-height: 600px;
    overflow-y: auto;
}

.progress-steps-list {
    position: relative;
    padding-left: 20px;
}

.progress-step {
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.progress-step-header {
    font-weight: 600;
    color: #495057;
    transition: color 0.3s ease;
    cursor: pointer;
}

.progress-step.completed .progress-step-header {
    color: #28a745;
}

.progress-step-label {
    font-size: 1rem;
    font-weight: 500;
}

.progress-step-date {
    font-size: 0.85rem;
    color: #6c757d;
    margin-top: 4px;
    margin-bottom: 8px;
}

.progress-step.completed .progress-step-date {
    color: #28a745;
    font-weight: 600;
}

.progress-step-content {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 12px;
    margin-top: 8px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.progress-step:hover {
    transform: translateX(3px);
}

.toggle-icon {
    transition: transform 0.3s ease;
    font-size: 0.8rem;
}

.btn-xs {
    padding: 0.1rem 0.3rem;
    font-size: 0.7rem;
    line-height: 1.2;
}
</style>

<!-- ========================================
     ä¸‹è«‹ã‘ç®¡ç†ãƒ‘ãƒãƒ«ï¼ˆPhase 1.2ã§è¿½åŠ ï¼‰
     ======================================== -->
{% include 'order_management/includes/contractor_management_panel.html' %}
{% include 'order_management/includes/contractor_management_panel_script.html' %}

{% endblock %}
