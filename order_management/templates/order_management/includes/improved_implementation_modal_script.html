<style>
/* ステップインジケーター */
.step-indicator {
    margin-bottom: 2rem;
}

.step-item {
    text-align: center;
    position: relative;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.step-item.active .step-number {
    background: #0d6efd;
    color: white;
}

.step-item.completed .step-number {
    background: #198754;
    color: white;
}

.step-label {
    font-size: 0.875rem;
    color: #6c757d;
}

.step-item.active .step-label {
    color: #0d6efd;
    font-weight: 600;
}

/* 料金カード */
.pricing-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.pricing-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.pricing-card.selected {
    border-color: #0d6efd !important;
    background-color: #f0f8ff;
}

/* セクション背景 */
.bg-light.bg-opacity-50 {
    background-color: rgba(248, 249, 250, 0.5);
}
</style>

<script>
// 改善版モーダル: ステップナビゲーション
$(document).ready(function() {
    let currentModalStep = 1;
    const totalModalSteps = 4;

    // ステップ表示関数
    window.showModalStep = function(step) {
        // ステップコンテンツの表示/非表示
        $('.step-content').addClass('d-none');
        $(`#step${step}`).removeClass('d-none');

        // ステップインジケーターの更新
        $('.step-item').removeClass('active completed');
        for (let i = 1; i < step; i++) {
            $(`.step-item[data-step="${i}"]`).addClass('completed');
        }
        $(`.step-item[data-step="${step}"]`).addClass('active');

        // プログレスバーの更新
        const progress = (step / totalModalSteps) * 100;
        $('.progress-bar').css('width', `${progress}%`);

        // ボタンの表示/非表示
        $('#modalPrevStep').toggle(step > 1);
        $('#modalNextStep').toggle(step < totalModalSteps);
        $('#modalSubmitBtn').toggleClass('d-none', step !== totalModalSteps);

        currentModalStep = step;
    };

    // 次へボタン
    $('#modalNextStep').click(function() {
        if (validateModalStep(currentModalStep)) {
            showModalStep(currentModalStep + 1);
        }
    });

    // 前へボタン
    $('#modalPrevStep').click(function() {
        showModalStep(currentModalStep - 1);
    });

    // ステップバリデーション
    function validateModalStep(step) {
        if (step === 1) {
            const resourceType = $('input[name="modal_implementation_type"]:checked').val();
            if (resourceType === 'outsource') {
                const contractorId = $('#modalContractorSelect').val();
                if (!contractorId) {
                    toastr.warning('業者を選択してください');
                    return false;
                }
            } else if (resourceType === 'internal') {
                const workerId = $('#modalInternalSelect').val();
                if (!workerId) {
                    toastr.warning('担当者を選択してください');
                    return false;
                }
            }
            const workDesc = $('textarea[name="modal_work_description"]').val();
            if (!workDesc && resourceType !== 'later') {
                toastr.warning('作業内容を入力してください');
                return false;
            }
        }
        return true;
    }

    // リソースタイプ切り替え
    $('input[name="modal_implementation_type"]').change(function() {
        const type = $(this).val();
        $('#modalContractorSection').toggleClass('d-none', type !== 'outsource');
        $('#modalInternalSection').toggleClass('d-none', type !== 'internal');
        $('#modalLaterSection').toggleClass('d-none', type !== 'later');
    });


    // 料金体系切り替え
    $('input[name="modal_pricing_type"]').change(function() {
        const isHourly = $(this).val() === 'hourly';
        $('#modalHourlySettings').toggleClass('d-none', !isHourly);
        $('#modalProjectSettings').toggleClass('d-none', isHourly);

        // カードのハイライト
        $('.pricing-card').removeClass('selected');
        $(this).closest('.pricing-card').addClass('selected');

        calculateModalTotal();
    });

    // 時給・工数変更時の自動計算
    $('#modalHourlyRate, #modalEstimatedHours').on('input', function() {
        const rate = parseFloat($('#modalHourlyRate').val()) || 0;
        const hours = parseFloat($('#modalEstimatedHours').val()) || 0;
        const base = rate * hours;
        $('#modalBaseAmount').val(base.toLocaleString());
        calculateModalTotal();
    });

    // 部材費トグル
    window.toggleModalMaterialCosts = function() {
        const isChecked = $('#modalShowMaterialCosts').is(':checked');
        $('#modalMaterialCostSection').toggleClass('d-none', !isChecked);
        calculateModalTotal();
    };

    // 合計金額の計算
    function calculateModalTotal() {
        const pricingType = $('input[name="modal_pricing_type"]:checked').val();
        let base = 0;

        if (pricingType === 'hourly') {
            const rate = parseFloat($('#modalHourlyRate').val()) || 0;
            const hours = parseFloat($('#modalEstimatedHours').val()) || 0;
            base = rate * hours;
        } else {
            base = parseFloat($('#modalContractAmount').val()) || 0;
        }

        // 追加費用の計算（既存のaddModalCostItem機能を利用）
        let additional = 0;
        $('#modalAdditionalCostList .cost-item-row').each(function() {
            const amount = parseFloat($(this).find('input[name="cost_amount[]"]').val()) || 0;
            additional += amount;
        });

        // 部材費の計算
        let materials = 0;
        if ($('#modalShowMaterialCosts').is(':checked')) {
            $('#modalMaterialCostTableBody tr').each(function() {
                const subtotal = parseFloat($(this).find('.material-subtotal').text().replace(/[¥,]/g, '')) || 0;
                materials += subtotal;
            });
        }

        const total = base + additional + materials;

        $('#modalSummaryBase').text(base.toLocaleString());
        $('#modalSummaryAdditional').text(additional.toLocaleString());
        $('#modalSummaryMaterials').text(materials.toLocaleString());
        $('#modalSummaryTotal').text(total.toLocaleString());
    }

    // 金額入力時の自動計算
    $(document).on('input', '#modalContractAmount, #modalAdditionalCostList input', calculateModalTotal);

    // 社内リソース選択時の自動入力
    $('#modalInternalSelect').change(function() {
        const selectedOption = $(this).find('option:selected');
        const department = selectedOption.data('department') || '';
        const hourlyRate = selectedOption.data('hourly-rate') || '';
        $('#modalInternalDepartment').val(department);
        if (hourlyRate) {
            $('#modalHourlyRate').val(hourlyRate);
            calculateModalTotal();
        }
    });

    // モーダルリセット
    $('#addImplementationModal').on('hidden.bs.modal', function() {
        showModalStep(1);
        $('#improvedImplementationForm')[0].reset();
        $('#modalAdditionalCostList').empty();
        $('#modalMaterialCostTableBody').empty();
        $('#modalShowMaterialCosts').prop('checked', false);
        $('#modalMaterialCostSection').addClass('d-none');
        calculateModalTotal();

        // 工程選択のリセット
        clearModalStepSelection();
    });

    // 初期化
    showModalStep(1);
});
</script>
