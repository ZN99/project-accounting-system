<style>
/* ã‚¹ãƒ†ãƒƒãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
.step-indicator {
    margin-bottom: 2rem;
}

.step-item {
    text-align: center;
    position: relative;
    flex: 1;
}

.step-item.clickable {
    cursor: pointer;
    transition: transform 0.2s ease;
}

.step-item.clickable:hover .step-number {
    transform: scale(1.1);
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.step-item.clickable:hover .step-number {
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.step-item.active .step-number {
    background: #0d6efd;
    color: white;
}

.step-item.completed .step-number {
    background: #198754;
    color: white;
}

.step-label {
    font-size: 0.875rem;
    color: #6c757d;
}

.step-item.active .step-label {
    color: #0d6efd;
    font-weight: 600;
}

/* æ–™é‡‘ã‚«ãƒ¼ãƒ‰ */
.pricing-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.pricing-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.pricing-card.selected {
    border-color: #0d6efd !important;
    background-color: #f0f8ff;
}

/* ã‚»ã‚¯ã‚·ãƒ§ãƒ³èƒŒæ™¯ */
.bg-light.bg-opacity-50 {
    background-color: rgba(248, 249, 250, 0.5);
}

/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - å·¥ç¨‹åˆ¥å®Ÿæ–½ä½“åˆ¶ç®¡ç† */
.progress-timeline {
    position: relative;
    padding-left: 2rem;
}

.progress-timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #dee2e6;
}

.vertical-progress {
    position: relative;
    padding-left: 40px;
    min-height: 400px;
}

.vertical-progress::before {
    content: '';
    position: absolute;
    left: 20px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.progress-step {
    position: relative;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.25rem 0.4rem;
    background-color: #fff;
    max-width: 800px;
}

.progress-step::before {
    content: '';
    position: absolute;
    left: -28px;
    top: 8px;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #6c757d;
    border: 3px solid #fff;
    box-shadow: 0 0 0 2px #6c757d;
    transition: all 0.3s ease;
}

.progress-step.completed::before {
    background: #28a745;
    box-shadow: 0 0 0 2px #28a745;
}

.progress-step.active::before {
    background: #007bff;
    box-shadow: 0 0 0 2px #007bff, 0 0 0 6px rgba(0, 123, 255, 0.2);
    transform: scale(1.2);
}

.progress-step:hover {
    background-color: #f8f9fa;
    transform: translateY(-1px);
    border-color: #adb5bd;
}

.progress-step.expanded {
    background-color: #fff;
    border-color: #dee2e6;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.progress-step-header {
    font-weight: 600;
    color: #495057;
    margin-bottom: 5px;
    transition: color 0.3s ease;
}

.progress-step.completed .progress-step-header {
    color: #28a745;
}

.progress-step.active .progress-step-header {
    color: #007bff;
}

.progress-step-label {
    font-size: 1.05rem;
    font-weight: 500;
}

.progress-step-date {
    font-size: 0.85rem;
    color: #6c757d;
    line-height: 1.2;
}

.progress-step.completed .progress-step-date {
    color: #28a745;
    font-weight: 500;
}

.progress-step-content {
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    padding: 12px;
    margin-top: 8px;
    display: none;
    box-shadow: 0 1px 3px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    font-size: 0.9rem;
    line-height: 1.3;
}

.progress-step.expanded .progress-step-content {
    display: block;
    background: #fff;
    border-color: #dee2e6;
}

/* ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼ˆå¤–æ³¨ç„¡é–¢ä¿‚ã®å·¥ç¨‹ï¼‰ */
.progress-step.disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: #f8f9fa;
}

.progress-step.disabled:hover {
    transform: none;
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

.progress-step.disabled .progress-step-header {
    color: #adb5bd;
}

.progress-step.disabled::before {
    background: #dee2e6;
    box-shadow: 0 0 0 2px #dee2e6;
}

/* ä½œæ¥­è€…è¿½åŠ ãƒœã‚¿ãƒ³ */
.add-worker-btn {
    font-size: 0.875rem;
    padding: 0.4rem 0.8rem;
}

/* ç™»éŒ²æ¸ˆã¿ä½œæ¥­è€…ã‚«ãƒ¼ãƒ‰ */
.worker-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    font-size: 0.85rem;
}

.worker-card:hover {
    background: #e9ecef;
    border-color: #adb5bd;
}

.worker-card .worker-name {
    font-weight: 600;
    color: #495057;
}

.worker-card .worker-cost {
    color: #6c757d;
}
</style>

<script>
// æ”¹å–„ç‰ˆãƒ¢ãƒ¼ãƒ€ãƒ«: ã‚¹ãƒ†ãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
console.log('ğŸš€ improved_implementation_modal_script.html ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ');

// jQueryã®èª­ã¿è¾¼ã¿ã‚’å¾…ã¤
function initializeModalScript() {
    if (typeof $ === 'undefined' || typeof jQuery === 'undefined') {
        console.log('â³ jQueryãŒã¾ã èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚100mså¾Œã«å†è©¦è¡Œã—ã¾ã™...');
        setTimeout(initializeModalScript, 100);
        return;
    }

    console.log('âœ… jQueryãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸã€‚ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åˆæœŸåŒ–ã—ã¾ã™ã€‚');

    // ==========================================
    // å·¥ç¨‹åˆ¥å®Ÿæ–½ä½“åˆ¶ç®¡ç†: ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ãƒ™ãƒ¼ã‚¹
    // ==========================================

    // å¤–æ³¨é–¢é€£ã‚’åˆ¤å®šã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
    const outsourcingKeywords = ['ç¾èª¿', 'ç«‹ã¡ä¼šã„', 'ç€å·¥', 'æ–½å·¥', 'å·¥äº‹', 'è§£ä½“', 'æ’¤å»', 'è¨­ç½®'];

    // å·¥ç¨‹åã‹ã‚‰å¤–æ³¨å¿…è¦æ€§ã‚’åˆ¤å®š
    function isOutsourcingProcess(stepName) {
        if (!stepName) return false;
        return outsourcingKeywords.some(keyword => stepName.includes(keyword));
    }

    // å·¥ç¨‹åã‹ã‚‰ã‚¢ã‚¤ã‚³ãƒ³ã‚’æ¨å®š
    function getProcessIcon(stepName) {
        if (!stepName) return 'fa-circle';
        if (stepName.includes('è¦‹ç©')) return 'fa-file-invoice';
        if (stepName.includes('ç¾èª¿')) return 'fa-clipboard-list';
        if (stepName.includes('ç«‹ã¡ä¼šã„')) return 'fa-user-check';
        if (stepName.includes('ç€å·¥') || stepName.includes('æ–½å·¥')) return 'fa-hard-hat';
        if (stepName.includes('å·¥äº‹')) return 'fa-tools';
        if (stepName.includes('å®Œå·¥') || stepName.includes('å®Œäº†')) return 'fa-check-circle';
        if (stepName.includes('æ¤œæŸ»')) return 'fa-clipboard-check';
        if (stepName.includes('å¼•æ¸¡')) return 'fa-handshake';
        return 'fa-circle';
    }

    // å·¥ç¨‹ã”ã¨ã®ä½œæ¥­è€…ãƒ‡ãƒ¼ã‚¿ï¼ˆproject_form.htmlã§åˆæœŸåŒ–ã•ã‚Œã‚‹ï¼‰
    // window.processWorkers ã®åˆæœŸåŒ–ã¯ project_form.html ã®
    // all_subcontracts_by_step_json ã‚’ä½¿ã£ã¦è¡Œã‚ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
    if (typeof window.processWorkers === 'undefined') {
        window.processWorkers = {};
        console.log('âš ï¸ processWorkers ãŒæœªå®šç¾©ã®ãŸã‚ã€ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§åˆæœŸåŒ–ã—ã¾ã—ãŸ');
    }

    // ç¾åœ¨ç·¨é›†ä¸­ã®å·¥ç¨‹
    let currentEditingProcess = null;

    // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®å·¥ç¨‹ã‚’ä½¿ç”¨ï¼‰
    window.generateImplementationTimeline = function() {
        console.log('ğŸ”„ generateImplementationTimeline() called');
        console.log('ğŸ‘¥ Current window.processWorkers:', window.processWorkers);

        const timeline = $('#implementationTimeline');
        timeline.empty();

        let allSteps = [];

        // 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ã®å·¥ç¨‹ã‚’å–å¾—ï¼ˆDOMã‹ã‚‰ï¼‰
        $('#formActiveSteps .progress-step').each(function() {
            const stepKey = $(this).data('step');
            const stepName = $(this).find('.progress-step-label').text().trim();
            // stepKeyãŒæ—¢ã«step_ã§å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã¯äºŒé‡ã«ã—ãªã„
            const stepKeyForInput = stepKey.startsWith('step_') ? stepKey : `step_${stepKey}`;
            const stepDateInput = $(this).find(`input[name="${stepKeyForInput}_scheduled_date"]`);
            const stepDate = stepDateInput.val();
            const stepCompleted = $(this).find(`input[name="${stepKeyForInput}_completed"]`).is(':checked');

            if (stepKey && stepName) {
                allSteps.push({
                    id: stepKey,
                    name: stepName,
                    date: stepDate,
                    completed: stepCompleted,
                    source: 'formActiveSteps'
                });
            }
        });

        // 2. å·¥ç¨‹ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆscheduleStepsï¼‰ã‚’å–å¾—
        let scheduleSteps = [];
        if (typeof window.scheduleSteps !== 'undefined' && window.scheduleSteps) {
            scheduleSteps = window.scheduleSteps;
        } else if (window.parent && typeof window.parent.scheduleSteps !== 'undefined') {
            scheduleSteps = window.parent.scheduleSteps;
        }

        // scheduleStepsã‚’è¿½åŠ 
        scheduleSteps.forEach(step => {
            allSteps.push({
                id: step.id,
                name: step.name,
                date: step.date,
                completed: step.completed,
                source: 'scheduleSteps'
            });
        });

        console.log('ğŸ“‹ å–å¾—ã—ãŸå…¨å·¥ç¨‹ãƒ‡ãƒ¼ã‚¿:', allSteps);

        // å·¥ç¨‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (allSteps.length === 0) {
            // å·¥ç¨‹ãŒãªã„å ´åˆã§ã‚‚ã€ä½œæ¥­è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            let hasWorkers = false;
            for (const key in window.processWorkers) {
                if (window.processWorkers[key] && window.processWorkers[key].length > 0) {
                    hasWorkers = true;
                    break;
                }
            }

            if (hasWorkers) {
                // ä½œæ¥­è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€å·¥ç¨‹ãªã—ã§è¡¨ç¤º
                console.log('âš ï¸ å·¥ç¨‹ãªã—ã ãŒä½œæ¥­è€…ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š - ä½œæ¥­è€…ã®ã¿è¡¨ç¤º');
                displayWorkersWithoutSteps();
                return;
            }

            // å·¥ç¨‹ã‚‚ä½œæ¥­è€…ã‚‚ãªã„å ´åˆ
            timeline.html(`
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    å·¥ç¨‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚å…ˆã«ã€Œå·¥ç¨‹ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚¿ãƒ–ã§å·¥ç¨‹ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚
                </div>
            `);
            return;
        }

        // å„å·¥ç¨‹ã‚’ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã«è¡¨ç¤º
        allSteps.forEach(step => {
            // step.idãŒæ—¢ã«step_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’æŒã£ã¦ã„ã‚‹å ´åˆã¯äºŒé‡ã«ã—ãªã„
            const processKey = step.id.startsWith('step_') ? step.id : `step_${step.id}`;
            const processName = step.name || 'å·¥ç¨‹åæœªè¨­å®š';
            const processIcon = getProcessIcon(processName);
            const isOutsourcing = isOutsourcingProcess(processName);
            const workers = window.processWorkers[processKey] || [];
            const disabledClass = !isOutsourcing ? 'disabled' : '';
            const expandedClass = isOutsourcing ? 'expanded' : '';

            console.log(`ğŸ“Œ Processing step: ${processKey} (${processName}), isOutsourcing: ${isOutsourcing}, workers:`, workers);

            // å·¥ç¨‹ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
            if (!window.processWorkers[processKey]) {
                window.processWorkers[processKey] = [];
            }

            let workersHtml = '';
            if (isOutsourcing && workers.length > 0) {
                console.log(`ğŸ‘· Rendering ${workers.length} workers for ${processKey}`);

                workersHtml = '<div class="mt-2">';
                workers.forEach((worker, index) => {
                    workersHtml += `
                        <div class="worker-card d-flex justify-content-between align-items-center">
                            <div>
                                <div class="worker-name">${worker.contractorName || 'æœªè¨­å®š'}</div>
                                <div class="worker-cost text-muted">Â¥${(worker.contractAmount || 0).toLocaleString()}</div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeWorkerFromProcess('${processKey}', ${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                workersHtml += '</div>';
            }

            const addButtonHtml = isOutsourcing ? `
                <button type="button" class="btn btn-sm btn-outline-primary add-worker-btn mt-2" onclick="event.stopPropagation(); openWorkerSubmodal('${processKey}', '${processName}')">
                    <i class="fas fa-user-plus me-1"></i>ä½œæ¥­è€…ã‚’è¿½åŠ 
                </button>
            ` : '';

            // æ—¥ä»˜è¡¨ç¤º
            let dateDisplay = '<span class="text-muted" style="opacity: 0.6;">æ—¥ä»˜æœªè¨­å®š</span>';
            if (step.date) {
                dateDisplay = `<span class="text-muted" style="opacity: 0.6;">${step.date}</span>`;
            }

            const stepHtml = `
                <div class="progress-step ${disabledClass} ${expandedClass}" data-process="${processKey}" onclick="toggleProcess('${processKey}', ${isOutsourcing})">
                    <div class="progress-step-header">
                        <i class="fas ${processIcon} me-2"></i>
                        <span class="progress-step-label">${processName}</span>
                        ${!isOutsourcing ? '<span class="badge bg-secondary ms-2" style="font-size: 0.7rem;">å¤–æ³¨ä¸è¦</span>' : ''}
                        ${step.completed ? '<span class="badge bg-success ms-2" style="font-size: 0.7rem;">å®Œäº†</span>' : ''}
                    </div>
                    <div class="progress-step-date">${dateDisplay}</div>
                    <div class="progress-step-content">
                        ${workersHtml}
                        ${addButtonHtml}
                    </div>
                </div>
            `;

            timeline.append(stepHtml);
        });

        console.log('âœ… generateImplementationTimeline() completed');

        // formActiveStepsã®ä½œæ¥­è€…ã‚‚æ›´æ–°
        updateFormActiveStepsWorkers();
    }

    // å·¥ç¨‹ãªã—ã§ä½œæ¥­è€…ã®ã¿è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function displayWorkersWithoutSteps() {
        const timeline = $('#implementationTimeline');
        timeline.empty();

        console.log('ğŸ”„ displayWorkersWithoutSteps() called');
        console.log('ğŸ‘¥ Current window.processWorkers:', window.processWorkers);

        const stepNames = {
            'step_attendance': 'ç«‹ã¡ä¼šã„',
            'step_survey': 'ç¾åœ°èª¿æŸ»',
            'step_construction_start': 'ç€å·¥',
            'step_completion': 'å®Œå·¥',
            'step_material_order': 'è³‡æç™ºæ³¨',
            'step_estimate': 'è¦‹ç©æ›¸ç™ºè¡Œ',
            'step_contract': 'å¥‘ç´„',
            'step_invoice': 'è«‹æ±‚æ›¸ç™ºè¡Œ',
            'step_permit_application': 'è¨±å¯ç”³è«‹',
            'step_inspection': 'æ¤œæŸ»'
        };

        let workersDisplayed = false;

        for (const stepKey in window.processWorkers) {
            const workers = window.processWorkers[stepKey];
            if (workers && workers.length > 0) {
                workersDisplayed = true;
                const stepName = stepNames[stepKey] || stepKey.replace('step_', '').replace(/_/g, ' ');

                console.log(`ğŸ‘· Displaying ${workers.length} workers for ${stepKey} (${stepName})`);

                let workersHtml = '<div class="mt-2">';
                workers.forEach((worker, index) => {
                    workersHtml += `
                        <div class="worker-card d-flex justify-content-between align-items-center">
                            <div>
                                <div class="worker-name">${worker.contractorName || 'æœªè¨­å®š'}</div>
                                <div class="worker-cost text-muted">Â¥${(worker.contractAmount || 0).toLocaleString()}</div>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeWorkerFromProcess('${stepKey}', ${index})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                });
                workersHtml += '</div>';

                const stepHtml = `
                    <div class="progress-step expanded" data-process="${stepKey}">
                        <div class="progress-step-header">
                            <i class="fas fa-users me-2"></i>
                            <span class="progress-step-label">${stepName}</span>
                            <span class="badge bg-warning ms-2" style="font-size: 0.7rem;">å·¥ç¨‹æœªç™»éŒ²</span>
                        </div>
                        <div class="progress-step-content">
                            ${workersHtml}
                        </div>
                    </div>
                `;

                timeline.append(stepHtml);
            }
        }

        if (workersDisplayed) {
            // å·¥ç¨‹ãŒæœªç™»éŒ²ã§ã‚ã‚‹ã“ã¨ã‚’é€šçŸ¥ã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            timeline.prepend(`
                <div class="alert alert-warning mb-3">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>æ³¨æ„:</strong> ä½œæ¥­è€…ã¯ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã™ãŒã€å·¥ç¨‹ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                    ã€Œå·¥ç¨‹ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ã‚¿ãƒ–ã§å·¥ç¨‹ã‚’ç™»éŒ²ã™ã‚‹ã¨ã€ä½œæ¥­è€…ãŒé©åˆ‡ãªå·¥ç¨‹ã«é–¢é€£ä»˜ã‘ã‚‰ã‚Œã¾ã™ã€‚
                </div>
            `);
        }

        console.log('âœ… displayWorkersWithoutSteps() completed');
    }

    // formActiveStepsã®å„å·¥ç¨‹ã«ä½œæ¥­è€…ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
    function updateFormActiveStepsWorkers() {
        console.log('ğŸ”„ Updating workers in formActiveSteps and activeSteps');

        // formActiveStepsã¨activeStepsã®ä¸¡æ–¹ã®å„å·¥ç¨‹ã‚’å–å¾—ï¼ˆproject_form.htmlã¨project_detail.htmlã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
        $('#formActiveSteps .progress-step, #activeSteps .progress-step').each(function() {
            const stepElement = $(this);
            const stepKey = stepElement.data('step');

            // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ãŒã©ã®ã‚³ãƒ³ãƒ†ãƒŠã«ã‚ã‚‹ã‹åˆ¤å®š
            const isInFormActiveSteps = stepElement.closest('#formActiveSteps').length > 0;
            const isInActiveSteps = stepElement.closest('#activeSteps').length > 0;

            console.log(`ğŸ“ Step ${stepKey}: isInFormActiveSteps=${isInFormActiveSteps}, isInActiveSteps=${isInActiveSteps}`);

            // update/create ãƒšãƒ¼ã‚¸ï¼ˆ#formActiveStepsï¼‰ã§ã¯ä½œæ¥­è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤ºã—ãªã„
            // ã€Œæ¥­è€…ãƒ»æ‹…å½“ã€ã‚¿ãƒ–ã§ç®¡ç†ã™ã‚‹ãŸã‚
            if (isInFormActiveSteps) {
                console.log(`â­ï¸ Skipping worker section for ${stepKey} in formActiveSteps (managed in æ¥­è€…ãƒ»æ‹…å½“ tab)`);
                // æ—¢å­˜ã®ä½œæ¥­è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‰Šé™¤
                stepElement.find(`#workers-${stepKey}`).remove();
                return; // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸
            }

            // ä»¥ä¸‹ã¯ detail ãƒšãƒ¼ã‚¸ï¼ˆ#activeStepsï¼‰ã®ã¿å®Ÿè¡Œ

            // stepKeyã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’çµ±ä¸€
            const stepKeyForWorkers = stepKey.startsWith('step_') ? stepKey : `step_${stepKey}`;
            const workers = window.processWorkers[stepKeyForWorkers] || window.processWorkers[stepKey] || [];

            console.log(`ğŸ“Œ Updating workers for ${stepKey} (${stepKeyForWorkers}):`, workers);

            // ä½œæ¥­è€…ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
            let workersSection = stepElement.find(`#workers-${stepKey}`);
            if (workersSection.length === 0) {
                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒãªã„å ´åˆã¯ä½œæˆ
                workersSection = $(`
                    <div class="workers-section mt-2" style="border-top: 1px solid #dee2e6; padding-top: 10px;" id="workers-${stepKey}">
                    </div>
                `);
                stepElement.find('.card-body').append(workersSection);
            }

            // ä½œæ¥­è€…HTMLã‚’ç”Ÿæˆ
            let workersHtml = '';
            if (workers.length > 0) {
                workersHtml = '<div class="mb-2"><small class="text-muted fw-bold">ä½œæ¥­è€…:</small></div>';
                workers.forEach((worker, index) => {
                    workersHtml += `
                        <div class="card mb-2 border-start border-primary border-3">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="fw-bold" style="font-size: 0.9rem;">${worker.contractorName || 'æ¥­è€…åæœªè¨­å®š'}</div>
                                        <div class="text-muted small">Â¥${(worker.contractAmount || 0).toLocaleString()}</div>
                                    </div>
                                    <span class="badge bg-${worker.paymentStatus === 'paid' ? 'success' : 'warning'}" style="font-size: 0.75rem;">
                                        ${worker.paymentStatus === 'paid' ? 'æ”¯æ‰•æ¸ˆã¿' : 'æœªæ‰•ã„'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                });

                // ä½œæ¥­è€…è¿½åŠ ãƒœã‚¿ãƒ³ï¼ˆdetail pageã®ã¿ï¼‰
                workersHtml += `
                    <button type="button" class="btn btn-sm btn-outline-primary mt-1" onclick="event.stopPropagation(); openWorkerSubmodal('${stepKeyForWorkers}', '${stepElement.find('.progress-step-label').text()}')">
                        <i class="fas fa-user-plus me-1"></i>ä½œæ¥­è€…ã‚’è¿½åŠ 
                    </button>
                `;
            } else {
                // ä½œæ¥­è€…ãŒã„ãªã„å ´åˆï¼ˆdetail pageã®ã¿ï¼‰
                workersHtml = `
                    <div class="text-muted small mb-2">ä½œæ¥­è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); openWorkerSubmodal('${stepKeyForWorkers}', '${stepElement.find('.progress-step-label').text()}')">
                        <i class="fas fa-user-plus me-1"></i>ä½œæ¥­è€…ã‚’è¿½åŠ 
                    </button>
                `;
            }

            // HTMLã‚’æ›´æ–°
            workersSection.html(workersHtml);
        });

        console.log('âœ… Workers updated in both formActiveSteps and activeSteps');
    }

    // å·¥ç¨‹ã®å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
    window.toggleProcess = function(processKey, isOutsourcing) {
        if (!isOutsourcing) return; // å¤–æ³¨ç„¡é–¢ä¿‚ã®å·¥ç¨‹ã¯ã‚¯ãƒªãƒƒã‚¯ä¸å¯

        const step = $(`.progress-step[data-process="${processKey}"]`);
        step.toggleClass('expanded');
    };

    // ä½œæ¥­è€…ã‚µãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãï¼ˆæ—¢å­˜ã®ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨ï¼‰
    window.openWorkerSubmodal = function(processKey, processName) {
        currentEditingProcess = processKey;

        console.log('ğŸ“ ä½œæ¥­è€…è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã:', { processKey, processName });

        // project_idã‚’ç¢ºèª
        let projectId = $('input[name="project_id"]').val();
        // ã‚«ãƒ³ãƒã‚’é™¤å»ï¼ˆæ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã‚‹å ´åˆã®å¯¾ç­–ï¼‰
        if (projectId) {
            projectId = projectId.replace(/,/g, '');
        }

        // project_idãŒãªã„å ´åˆã¯ã€å…ˆã«ä¸‹æ›¸ãä¿å­˜ã‚’å®Ÿè¡Œ
        if (!projectId) {
            console.log('âš ï¸ Project ID not found. Saving draft first...');

            // ä¸‹æ›¸ãä¿å­˜ã‚’å®Ÿè¡Œ
            if (typeof updateAutoSaveStatus === 'function') {
                updateAutoSaveStatus('ä¿å­˜ä¸­...', 'saving');
            }

            const formData = new FormData($('#projectForm')[0]);
            const saveUrl = '/orders/save-draft/';

            fetch(saveUrl, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.project_id) {
                    // project_idã‚’è¨­å®š
                    $('input[name="project_id"]').val(data.project_id);

                    // URLã‚’æ›´æ–°
                    const newUrl = `/orders/${data.project_id}/update/`;
                    window.history.replaceState({}, '', newUrl);

                    if (typeof updateAutoSaveStatus === 'function') {
                        updateAutoSaveStatus('ä¿å­˜å®Œäº†', 'success');
                    }
                    console.log('âœ… Project saved. ID:', data.project_id);

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‡¦ç†ã‚’å†å®Ÿè¡Œ
                    openWorkerSubmodal(processKey, processName);
                } else {
                    if (typeof updateAutoSaveStatus === 'function') {
                        updateAutoSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
                    }
                    if (typeof toastr !== 'undefined') {
                        toastr.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            })
            .catch(error => {
                if (typeof updateAutoSaveStatus === 'function') {
                    updateAutoSaveStatus('ä¿å­˜ã‚¨ãƒ©ãƒ¼', 'error');
                }
                if (typeof toastr !== 'undefined') {
                    toastr.error('ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                console.error('Save error:', error);
            });

            return; // ä¿å­˜å®Œäº†å¾Œã«å†åº¦å‘¼ã³å‡ºã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§çµ‚äº†
        }

        // ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        const subcontractModal = document.getElementById('subcontractModal');
        if (subcontractModal) {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            const form = document.getElementById('subcontractForm');
            if (form) {
                form.reset();
            }

            // å…¨ã¦ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
            $('#subcontractModalError').remove();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
            const modalTitle = subcontractModal.querySelector('#subcontractModalLabel');
            if (modalTitle) {
                modalTitle.innerHTML = `<i class="fas fa-user-plus me-2"></i>ä½œæ¥­è€…ã‚’è¿½åŠ  (${processName})`;
            }

            // å·¥ç¨‹ã‚­ãƒ¼ã‚’hidden inputã«è¨­å®šï¼ˆstep_ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ï¼‰
            const stepInput = subcontractModal.querySelector('#subcontractStep');
            if (stepInput) {
                // processKeyã‹ã‚‰ step_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤
                const stepValue = processKey.replace(/^step_/, '');
                stepInput.value = stepValue;
                console.log('ğŸ“ Step value set:', stepValue, '(original:', processKey, ')');
            }

            // ç™ºæ³¨å…ˆè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
            const selectedContractorDisplay = document.getElementById('selectedContractorDisplay');
            if (selectedContractorDisplay) {
                selectedContractorDisplay.value = '';
            }

            // ç™ºæ³¨å…ˆhidden inputã‚’ãƒªã‚»ãƒƒãƒˆ
            $('#subcontractContractor').val('');

            // ç™ºæ³¨å…ˆæƒ…å ±ã‚’ãƒªã‚»ãƒƒãƒˆ
            const contractorPaymentInfo = document.getElementById('contractorPaymentInfo');
            if (contractorPaymentInfo) {
                contractorPaymentInfo.style.display = 'none';
            }

            // é‡‘é¡è¨­å®šæ–¹æ³•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
            $('#costAllocationSection').hide();
            $('#perStepAmountsSection').hide();
            $('#costMethodLumpSum').prop('checked', true);

            // å¥‘ç´„é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç·¨é›†å¯èƒ½ã«æˆ»ã™ï¼‰
            $('#subcontractContractAmount').prop('readonly', false);
            $('#subcontractContractAmount').removeClass('bg-light');
            $('#subcontractContractAmount').attr('placeholder', '');
            $('#subcontractContractAmount').val('');

            // åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’åˆæœŸåŒ–ï¼ˆç¾åœ¨ã®å·¥ç¨‹ã‚’è‡ªå‹•é¸æŠï¼‰
            console.log('ğŸ” åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯ - populateModalBaseDateOptions å­˜åœ¨:', typeof window.populateModalBaseDateOptions);
            if (typeof window.populateModalBaseDateOptions === 'function') {
                console.log('âœ… populateModalBaseDateOptions ã‚’å‘¼ã³å‡ºã—ã¾ã™ - processKey:', processKey);
                window.populateModalBaseDateOptions(processKey);
            } else {
                console.error('âŒ populateModalBaseDateOptions é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }

            // è¨ˆç®—ãƒœã‚¿ãƒ³ã‚’åˆæœŸçŠ¶æ…‹ã§ç„¡åŠ¹åŒ–ï¼ˆæ¥­è€…æœªé¸æŠï¼‰
            $('#modalCalculatePaymentDueDate').prop('disabled', true);

            // è¨ˆç®—çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
            $('#modalCalculationResult').hide();

            // ä»–ã®å·¥ç¨‹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
            // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§å®Ÿéš›ã«å­˜åœ¨ã™ã‚‹å·¥ç¨‹ã‚’å–å¾—
            let allSteps = [];

            // 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ã®å·¥ç¨‹ã‚’å–å¾—ï¼ˆDOMã‹ã‚‰ï¼‰
            $('#formActiveSteps .progress-step').each(function() {
                const stepKey = $(this).data('step');
                const stepName = $(this).find('.progress-step-label').text().trim();
                if (stepKey && stepName) {
                    // stepKeyãŒæ—¢ã«step_ã§å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã¯äºŒé‡ã«ã—ãªã„
                    const normalizedKey = stepKey.startsWith('step_') ? stepKey : `step_${stepKey}`;
                    allSteps.push({
                        key: normalizedKey,
                        label: stepName
                    });
                }
            });

            // 2. ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å·¥ç¨‹ã‚’å–å¾—
            if (typeof window.scheduleSteps !== 'undefined' && window.scheduleSteps) {
                window.scheduleSteps.forEach(step => {
                    // step.idãŒæ—¢ã«step_ã§å§‹ã¾ã£ã¦ã„ã‚‹å ´åˆã¯äºŒé‡ã«ã—ãªã„
                    const normalizedKey = step.id.startsWith('step_') ? step.id : `step_${step.id}`;
                    allSteps.push({
                        key: normalizedKey,
                        label: step.name || 'å·¥ç¨‹åæœªè¨­å®š'
                    });
                });
            }

            // å¤–æ³¨ãŒå¿…è¦ãªå·¥ç¨‹ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const outsourcingSteps = allSteps.filter(step => isOutsourcingProcess(step.label));

            // å¤–æ³¨ãŒå¿…è¦ãªå·¥ç¨‹ã§ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆï¼ˆç¾åœ¨ã®å·¥ç¨‹ã¯ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ï¼†ã‚°ãƒ¬ãƒ¼ã‚¢ã‚¦ãƒˆï¼‰
            if (outsourcingSteps.length > 0) {
                let checkboxesHtml = '<div class="row">';
                outsourcingSteps.forEach(step => {
                    const isCurrentStep = step.key === processKey;
                    const disabledAttr = isCurrentStep ? 'disabled' : '';
                    const checkedAttr = isCurrentStep ? 'checked' : '';
                    const grayedClass = isCurrentStep ? 'text-muted' : '';

                    checkboxesHtml += `
                        <div class="col-md-6 mb-2">
                            <div class="form-check">
                                <input class="form-check-input additional-step-checkbox"
                                       type="checkbox"
                                       name="additional_steps[]"
                                       value="${step.key}"
                                       id="addStep_${step.key}"
                                       data-label="${step.label}"
                                       ${disabledAttr}
                                       ${checkedAttr}>
                                <label class="form-check-label ${grayedClass}" for="addStep_${step.key}">
                                    <i class="fas fa-calendar-check me-1"></i>${step.label}
                                    ${isCurrentStep ? '<small class="ms-1">(é¸æŠä¸­)</small>' : ''}
                                </label>
                            </div>
                        </div>
                    `;
                });
                checkboxesHtml += '</div>';

                $('#additionalStepsCheckboxes').html(checkboxesHtml);
                $('#additionalStepsSection').show();

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
                $('.additional-step-checkbox').on('change', function() {
                    console.log('ğŸ”” å·¥ç¨‹ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«');

                    if (typeof handleAdditionalStepsChange === 'function') {
                        handleAdditionalStepsChange();
                    }

                    // æ”¯æ‰•ã„ç®¡ç†ã®åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¨é€£å‹•
                    // å°‘ã—é…å»¶ã•ã›ã¦ã€DOMæ›´æ–°ãŒå®Œäº†ã—ã¦ã‹ã‚‰å®Ÿè¡Œ
                    setTimeout(function() {
                        console.log('â° åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³åŒæœŸã‚’é–‹å§‹');
                        if (typeof window.syncBaseDateCheckboxes === 'function') {
                            window.syncBaseDateCheckboxes();
                        } else {
                            console.error('âŒ syncBaseDateCheckboxes é–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                        }
                    }, 100);
                });
            } else {
                $('#additionalStepsSection').hide();
            }

            // é‡‘é¡è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç¢ºå®Ÿã«éè¡¨ç¤ºã«ã™ã‚‹ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ç”Ÿæˆå¾Œã«å†åº¦å®Ÿè¡Œï¼‰
            $('#costAllocationSection').hide();
            $('#perStepAmountsSection').hide();

            // ç·ã‚³ã‚¹ãƒˆè¨ˆç®—ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãå‰ã«å®Ÿè¡Œï¼‰
            if (typeof window.calculateModalTotalCost === 'function') {
                // å°‘ã—é…å»¶ã•ã›ã¦ç¢ºå®Ÿã«å®Ÿè¡Œ
                setTimeout(function() {
                    window.calculateModalTotalCost();
                }, 100);
            }

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            const bsModal = new bootstrap.Modal(subcontractModal);

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒå®Œå…¨ã«è¡¨ç¤ºã•ã‚ŒãŸå¾Œã«åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†åˆæœŸåŒ–
            $(subcontractModal).one('shown.bs.modal', function() {
                console.log('ğŸ¯ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå®Œäº† - åŸºæº–æ—¥ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’å†åˆæœŸåŒ–');

                // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’éè¡¨ç¤º
                if (typeof window.hideModalPaymentError === 'function') {
                    window.hideModalPaymentError();
                }

                if (typeof window.populateModalBaseDateOptions === 'function') {
                    window.populateModalBaseDateOptions(processKey);
                }

                // æ—¢ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å·¥ç¨‹ãŒã‚ã‚Œã°ã€åŸºæº–æ—¥ã‚’è‡ªå‹•é¸æŠ
                setTimeout(function() {
                    console.log('ğŸ” ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå¾Œã®è‡ªå‹•é¸æŠãƒã‚§ãƒƒã‚¯');
                    if (typeof window.syncBaseDateCheckboxes === 'function') {
                        window.syncBaseDateCheckboxes();
                    }
                }, 200);
            });

            bsModal.show();

            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸå¾Œã€æ—¢ã«ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å·¥ç¨‹ã«å¿œã˜ã¦é‡‘é¡è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
            // ï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®changeã‚¤ãƒ™ãƒ³ãƒˆã¯æ—¢ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã®é …ç›®ã§ã¯ç™ºç«ã—ãªã„ãŸã‚ï¼‰
            setTimeout(function() {
                if (typeof handleAdditionalStepsChange === 'function') {
                    console.log('ğŸ“Š åˆæœŸçŠ¶æ…‹ã®é‡‘é¡è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºãƒã‚§ãƒƒã‚¯');
                    handleAdditionalStepsChange();
                }
            }, 150);

            console.log('âœ… ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸ');
        } else {
            console.error('âŒ subcontractModal ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            alert('ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
        }
    };

    // å·¥ç¨‹ã‹ã‚‰ä½œæ¥­è€…å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.removeWorkerFromProcess = function(processKey, workerIndex) {
        const worker = window.processWorkers[processKey][workerIndex];
        const workerName = worker ? worker.contractorName : 'ä¸æ˜ãªä½œæ¥­è€…';

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æƒ…å ±ã‚’ã‚»ãƒƒãƒˆ
        $('#workerNameToDelete').text(workerName);
        $('#workerProcessKeyToDelete').val(processKey);
        $('#workerIndexToDelete').val(workerIndex);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        const modal = new bootstrap.Modal(document.getElementById('deleteWorkerModal'));
        modal.show();
    };

    // ä½œæ¥­è€…å‰Šé™¤ã‚’å®Ÿè¡Œ
    window.confirmDeleteWorker = function() {
        const processKey = $('#workerProcessKeyToDelete').val();
        const workerIndex = parseInt($('#workerIndexToDelete').val());

        // ä½œæ¥­è€…æƒ…å ±ã‚’å–å¾—
        const worker = window.processWorkers[processKey][workerIndex];
        if (!worker || !worker.subcontractId) {
            console.error('âŒ å‰Šé™¤å¯¾è±¡ã®ä½œæ¥­è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            toastr.error('å‰Šé™¤å¯¾è±¡ã®ä½œæ¥­è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        const subcontractId = worker.subcontractId;
        console.log('ğŸ—‘ï¸ ä½œæ¥­è€…å‰Šé™¤é–‹å§‹:', {processKey, workerIndex, subcontractId, worker});

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteWorkerModal'));
        if (modal) {
            modal.hide();
        }

        // ã‚µãƒ¼ãƒãƒ¼ã«å‰Šé™¤ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        $.ajax({
            url: `/subcontracts/${subcontractId}/delete/`,
            type: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                console.log('âœ… å‰Šé™¤æˆåŠŸ:', response);

                // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®é…åˆ—ã‹ã‚‰ã‚‚å‰Šé™¤
                window.processWorkers[processKey].splice(workerIndex, 1);

                // UIã‚’æ›´æ–°
                generateImplementationTimeline();

                toastr.success('ä½œæ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            },
            error: function(xhr, status, error) {
                console.error('âŒ å‰Šé™¤å¤±æ•—:', {xhr, status, error});
                toastr.error('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (xhr.responseJSON?.error || error));
            }
        });
    };

    // ==========================================
    // ä½œæ¥­è€…ã‚µãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«: æ—¢å­˜ã®ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨
    // ==========================================
    // æ³¨: ã‚µãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ãƒ†ãƒƒãƒ—ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¯ä¸è¦
    // æ—¢å­˜ã®ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ãŒç‹¬è‡ªã®UIã‚’æŒã£ã¦ã„ã‚‹ãŸã‚

    // ãƒªã‚½ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="modal_implementation_type"]').change(function() {
        const type = $(this).val();
        $('#modalContractorSection').toggleClass('d-none', type !== 'outsource');
        $('#modalInternalSection').toggleClass('d-none', type !== 'internal');
        $('#modalLaterSection').toggleClass('d-none', type !== 'later');
    });


    // æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="modal_pricing_type"]').change(function() {
        const isHourly = $(this).val() === 'hourly';
        $('#modalHourlySettings').toggle(isHourly);
        $('#modalProjectSettings').toggle(!isHourly);

        // ã‚«ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        $('.pricing-card').removeClass('selected');
        $(this).closest('.pricing-card').addClass('selected');
    });

    // æ™‚çµ¦ãƒ»å·¥æ•°å¤‰æ›´æ™‚ã®è‡ªå‹•è¨ˆç®—
    $('#modalHourlyRate, #modalEstimatedHours').on('input', function() {
        const rate = parseFloat($('#modalHourlyRate').val()) || 0;
        const hours = parseFloat($('#modalEstimatedHours').val()) || 0;
        const base = rate * hours;
        $('#modalBaseAmount').val(base.toLocaleString());
    });

    // è¢«è«‹æ±‚é¡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ãƒˆã‚°ãƒ«
    window.toggleBilledAmountSection = function() {
        const section = $('#billedAmountSection');
        const icon = $('#billedAmountToggleIcon');
        const btn = $('#billedAmountToggleBtn');

        if (section.is(':visible')) {
            section.slideUp(200);
            icon.removeClass('fa-minus').addClass('fa-plus');
            btn.removeClass('btn-outline-primary').addClass('btn-outline-secondary');
        } else {
            section.slideDown(200);
            icon.removeClass('fa-plus').addClass('fa-minus');
            btn.removeClass('btn-outline-secondary').addClass('btn-outline-primary');
        }
    };

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹é¸æŠæ™‚ã®è‡ªå‹•å…¥åŠ›
    $('#modalInternalSelect').change(function() {
        const selectedOption = $(this).find('option:selected');
        const department = selectedOption.data('department') || '';
        const hourlyRate = selectedOption.data('hourly-rate') || '';
        $('#modalInternalDepartment').val(department);
        if (hourlyRate) {
            $('#modalHourlyRate').val(hourlyRate);
            calculateModalTotal();
        }
    });

    // ç· æ—¥ã®åŸºæº–æ—¥ã®å‡¦ç†
    function updatePaymentBaseDate() {
        const baseDateType = $('#modalPaymentBaseDateType').val();
        let baseDate = null;

        if (baseDateType === 'contract') {
            // å¥‘ç´„æ—¥ã‚’å–å¾—ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ï¼‰
            baseDate = $('#id_contract_date').val() || $('#contract_date').val();
        } else if (baseDateType === 'completion') {
            // å®Œå·¥æ—¥ã‚’å–å¾—ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ï¼‰
            baseDate = $('#id_completion_date').val() || $('#completion_date').val();
        } else if (baseDateType === 'custom') {
            // ä»»æ„æ—¥ã‚’å–å¾—
            baseDate = $('#modalPaymentCustomBaseDate').val();
        }

        // åŸºæº–æ—¥ã®è¡¨ç¤ºã‚’æ›´æ–°
        if (baseDate) {
            $('#modalPaymentBaseDateDisplay').text(baseDate);
        } else {
            $('#modalPaymentBaseDateDisplay').text('-');
        }
    }

    // åŸºæº–æ—¥ã‚¿ã‚¤ãƒ—ã®å¤‰æ›´
    $('#modalPaymentBaseDateType').change(function() {
        const type = $(this).val();
        if (type === 'custom') {
            $('#modalPaymentCustomBaseDate').show();
        } else {
            $('#modalPaymentCustomBaseDate').hide();
        }
        updatePaymentBaseDate();
    });

    // ä»»æ„æ—¥ã®å¤‰æ›´
    $('#modalPaymentCustomBaseDate').change(function() {
        updatePaymentBaseDate();
    });

    // ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚ŒãŸã¨ãã®åˆæœŸåŒ–ï¼ˆæ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ - å‰Šé™¤äºˆå®šï¼‰
    $('#addImplementationModal').on('shown.bs.modal', function() {
        console.log('ğŸš€ å®Ÿæ–½ä½“åˆ¶ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã‹ã‚Œã¾ã—ãŸ - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ');
        generateImplementationTimeline();
    });

    // ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒªã‚»ãƒƒãƒˆï¼ˆæ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³ - å‰Šé™¤äºˆå®šï¼‰
    $('#addImplementationModal').on('hidden.bs.modal', function() {
        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚¯ãƒªã‚¢
        $('#implementationTimeline').empty();
    });

    // æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚ŒãŸã¨ãã«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’ç”Ÿæˆ
    $(document).on('shown.bs.tab', '#staff-tab', function() {
        console.log('ğŸš€ æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ–ãŒè¡¨ç¤ºã•ã‚Œã¾ã—ãŸ - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ');
        if (typeof generateImplementationTimeline === 'function') {
            generateImplementationTimeline();
        }
    });

    // ã‚µãƒ–ãƒ¢ãƒ¼ãƒ€ãƒ«ãƒªã‚»ãƒƒãƒˆï¼ˆæ—¢å­˜ã®ã‚µãƒ–ã‚³ãƒ³ãƒˆãƒ©ã‚¯ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ä¸è¦ï¼‰

    // å®Ÿæ–½ä½“åˆ¶ãƒ—ãƒ©ãƒ³ä¿å­˜
    window.saveImplementationPlan = function() {
        console.log('ğŸ’¾ å®Ÿæ–½ä½“åˆ¶ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜:', window.processWorkers);

        // ä½œæ¥­è€…ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        let totalWorkers = 0;
        for (const key in window.processWorkers) {
            totalWorkers += window.processWorkers[key].length;
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (typeof toastr !== 'undefined') {
            toastr.success(`å®Ÿæ–½ä½“åˆ¶ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼ˆ${totalWorkers}ä»¶ã®ä½œæ¥­è€…ï¼‰`);
        } else {
            alert('å®Ÿæ–½ä½“åˆ¶ãƒ—ãƒ©ãƒ³ãŒä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚');
        }

        $('#addImplementationModal').modal('hide');
    };

    // æ¡ˆä»¶å˜ä¾¡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤º
    $('#modalHourlySettings').hide();
    $('#modalProjectSettings').show();

    // åˆæœŸã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ
    console.log('âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸ');

    // DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸå¾Œã«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’åˆæœŸåŒ–
    $(document).ready(function() {
        console.log('ğŸ” DOMèª­ã¿è¾¼ã¿å®Œäº† - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³åˆæœŸåŒ–ãƒã‚§ãƒƒã‚¯');

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’åˆæœŸåŒ–ï¼ˆæ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ´åˆï¼‰
        setTimeout(function() {
            if ($('#staff').hasClass('active') || $('#staff').hasClass('show')) {
                console.log('ğŸš€ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ - æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ– - ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç”Ÿæˆ');
                if (typeof generateImplementationTimeline === 'function') {
                    generateImplementationTimeline();
                }
            } else {
                console.log('ğŸ“Œ æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ–ã¯éã‚¢ã‚¯ãƒ†ã‚£ãƒ– - ã‚¿ãƒ–ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ç”Ÿæˆã•ã‚Œã¾ã™');
            }
        }, 500);
    });
}

// åˆæœŸåŒ–é–¢æ•°ã‚’å®Ÿè¡Œ
initializeModalScript();
</script>
