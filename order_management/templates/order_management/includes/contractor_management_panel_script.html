<script>
/**
 * æ¥­è€…ç®¡ç†ãƒ‘ãƒãƒ« - JavaScript
 * å–¶æ¥­ç®¡ç†ãƒ‘ãƒãƒ«ã¨åŒã˜UI/UXãƒ‘ã‚¿ãƒ¼ãƒ³
 */

// æ¥­è€…ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã
window.openContractorManagementPanel = function() {
    console.log('âœ… openContractorManagementPanel called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('contractorManagementModal'));
    modal.show();

    // æ¥­è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    refreshContractorList();

    // æ¤œç´¢æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
    setTimeout(function() {
        const searchInput = $('#contractorSearchInput');
        if (searchInput.length) {
            searchInput.off('input').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterContractorList(searchTerm);
            });
        }
    }, 100);
};

// ä¸‹è«‹ã‘æ¥­è€…ä¸€è¦§ã‚’æ›´æ–°
window.refreshContractorList = function() {
    console.log('âœ… refreshContractorList called');

    const tbody = $('#contractorTableBody');
    tbody.html('<tr><td colspan="6" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td></tr>');

    // ã™ã¹ã¦ã®ä¸‹è«‹ã‘æ¥­è€…ã‚’å–å¾—ï¼ˆDjangoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ï¼‰
    const allContractors = {{ contractors_json|safe }};

    if (!allContractors || allContractors.length === 0) {
        tbody.html('<tr><td colspan="6" class="text-center text-muted">ä¸‹è«‹ã‘æ¥­è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>');
        return;
    }

    let html = '';
    allContractors.forEach(function(contractor) {
        const statusBadge = contractor.is_active ?
            '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>' :
            '<span class="badge bg-secondary"><i class="fas fa-times-circle me-1"></i>éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>';

        // é€£çµ¡å…ˆæƒ…å ±
        let contactInfo = '';
        if (contractor.phone) {
            contactInfo += `<div class="mb-1"><i class="fas fa-phone me-1 text-primary"></i>${escapeHtml(contractor.phone)}</div>`;
        }
        if (contractor.email) {
            contactInfo += `<div><i class="fas fa-envelope me-1 text-primary"></i>${escapeHtml(contractor.email)}</div>`;
        }
        if (!contractor.phone && !contractor.email) {
            contactInfo = '<span class="text-muted">-</span>';
        }

        html += `
            <tr>
                <td><strong style="color: #1f2937;">${escapeHtml(contractor.name)}</strong></td>
                <td><span class="text-muted">${escapeHtml(contractor.specialties || '-')}</span></td>
                <td><span class="text-muted">${escapeHtml(contractor.contact_person || '-')}</span></td>
                <td style="font-size: 0.875rem;">${contactInfo}</td>
                <td class="text-center">${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-success me-1" onclick="selectContractor(${contractor.id})" title="ã“ã®æ¥­è€…ã‚’é¸æŠ">
                        <i class="fas fa-check"></i> é¸æŠ
                    </button>
                    <button class="btn btn-sm btn-outline-primary" onclick="openEditContractorModal(${contractor.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.html(html);
};

// æ¥­è€…ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
window.openEditContractorModal = function(contractorId) {
    console.log('âœ… openEditContractorModal called', contractorId);

    const allContractors = {{ contractors_json|safe }};
    const contractor = allContractors.find(c => c.id === contractorId);

    if (!contractor) {
        toastr.error('æ¥­è€…æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã«å€¤ã‚’è¨­å®š
    $('#editContractorId').val(contractor.id);
    $('#editContractorName').val(contractor.name);
    $('#editContractorType').val(contractor.contractor_type);
    $('#editContractorAddress').val(contractor.address || '');
    $('#editContractorPhone').val(contractor.phone || '');
    $('#editContractorEmail').val(contractor.email || '');
    $('#editContractorContactPerson').val(contractor.contact_person || '');
    $('#editContractorHourlyRate').val(contractor.hourly_rate || '');
    $('#editContractorSpecialties').val(contractor.specialties || '');
    $('#editContractorIsActive').prop('checked', contractor.is_active);

    // æ™‚çµ¦å˜ä¾¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤º
    toggleEditHourlyRateField();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('editContractorModal'));
    modal.show();
};

// ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ™‚çµ¦å˜ä¾¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
window.toggleEditHourlyRateField = function() {
    const contractorType = $('#editContractorType').val();
    const hourlyRateField = $('#editHourlyRateField');

    if (contractorType === 'individual') {
        hourlyRateField.show();
    } else {
        hourlyRateField.hide();
        $('#editContractorHourlyRate').val('');
    }
};

// æ¥­è€…æƒ…å ±ã‚’æ›´æ–°
window.submitEditContractor = function() {
    console.log('âœ… submitEditContractor called');

    const contractorId = $('#editContractorId').val();
    const name = $('#editContractorName').val().trim();
    const contractorType = $('#editContractorType').val();
    const address = $('#editContractorAddress').val().trim();
    const phone = $('#editContractorPhone').val().trim();
    const email = $('#editContractorEmail').val().trim();
    const contactPerson = $('#editContractorContactPerson').val().trim();
    const hourlyRateStr = $('#editContractorHourlyRate').val();
    const hourlyRate = hourlyRateStr ? parseFloat(hourlyRateStr) : 0;
    const specialties = $('#editContractorSpecialties').val().trim();
    const isActive = $('#editContractorIsActive').is(':checked');

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!name) {
        toastr.error('æ¥­è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        $('#editContractorName').focus();
        return;
    }

    if (!contractorType) {
        toastr.error('æ¥­è€…ç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
        $('#editContractorType').focus();
        return;
    }

    if (email && !isValidEmail(email)) {
        toastr.error('æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        $('#editContractorEmail').focus();
        return;
    }

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    $.ajax({
        url: `/subcontract/contractors/${contractorId}/update/`,
        method: 'POST',
        dataType: 'json',
        data: {
            csrfmiddlewaretoken: csrftoken,
            name: name,
            contractor_type: contractorType,
            address: address,
            phone: phone,
            email: email,
            contact_person: contactPerson,
            hourly_rate: hourlyRate,
            specialties: specialties,
            is_active: isActive,
            ajax_request: true
        },
        success: function(response) {
            if (response && response.success) {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
                const modal = bootstrap.Modal.getInstance(document.getElementById('editContractorModal'));
                if (modal) modal.hide();

                toastr.success(response.message || 'æ¥­è€…æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸ');

                // ä¸€è¦§ã‚’æ›´æ–°
                refreshContractorList();

                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(response.message || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (xhr.status === 0) {
                errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
            } else if (xhr.status === 400) {
                errorMessage = xhr.responseJSON?.message || 'å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„';
            } else if (xhr.status === 403) {
                errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
            } else if (xhr.status === 404) {
                errorMessage = 'æ¥­è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            } else if (xhr.status === 500) {
                errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
            }

            toastr.error(errorMessage);
        }
    });
};

// æ¥­è€…ã‚’å‰Šé™¤
window.deleteContractor = function(contractorId, contractorName) {
    console.log('âœ… deleteContractor called', contractorId, contractorName);

    if (!confirm(`æœ¬å½“ã«ã€Œ${contractorName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
    }

    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    $.ajax({
        url: `/subcontract/contractors/${contractorId}/delete/`,
        method: 'POST',
        dataType: 'json',
        data: {
            csrfmiddlewaretoken: csrftoken,
            ajax_request: true
        },
        success: function(response) {
            if (response && response.success) {
                toastr.success(response.message || 'æ¥­è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');

                // ä¸€è¦§ã‚’æ›´æ–°
                refreshContractorList();

                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°ï¼‰
                setTimeout(function() {
                    location.reload();
                }, 1000);
            } else {
                toastr.error(response.message || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }
        },
        error: function(xhr, status, error) {
            console.error('Error:', error);
            let errorMessage = 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';

            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (xhr.status === 404) {
                errorMessage = 'æ¥­è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            } else if (xhr.status === 500) {
                errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
            }

            toastr.error(errorMessage);
        }
    });
};

// ä¸‹è«‹ã‘æ¥­è€…ä¸€è¦§ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
window.filterContractorList = function(searchTerm) {
    console.log('ğŸ” Filtering contractors:', searchTerm);

    const rows = $('#contractorTableBody tr');

    if (!searchTerm || searchTerm.trim() === '') {
        // æ¤œç´¢èªãŒç©ºã®å ´åˆã€ã™ã¹ã¦è¡¨ç¤º
        rows.show();
        return;
    }

    rows.each(function() {
        const row = $(this);
        const contractorName = row.find('td:first strong').text().toLowerCase();
        const specialties = row.find('td:nth-child(2)').text().toLowerCase();
        const contactPerson = row.find('td:nth-child(3)').text().toLowerCase();
        const contactInfo = row.find('td:nth-child(4)').text().toLowerCase();

        if (contractorName.includes(searchTerm) ||
            specialties.includes(searchTerm) ||
            contactPerson.includes(searchTerm) ||
            contactInfo.includes(searchTerm)) {
            row.show();
        } else {
            row.hide();
        }
    });

    // æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const visibleRows = rows.filter(':visible').length;
    if (visibleRows === 0) {
        const tbody = $('#contractorTableBody');
        if (tbody.find('.no-results-row').length === 0) {
            tbody.append('<tr class="no-results-row"><td colspan="6" class="text-center text-muted py-4"><i class="fas fa-search me-2"></i>ã€Œ' + escapeHtml(searchTerm) + 'ã€ã«ä¸€è‡´ã™ã‚‹ä¸‹è«‹ã‘æ¥­è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>');
        }
    } else {
        $('#contractorTableBody .no-results-row').remove();
    }
};

// æ¥­è€…ã‚’é¸æŠã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
window.selectContractor = function(contractorId) {
    console.log('âœ… selectContractor called', contractorId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const modal = bootstrap.Modal.getInstance(document.getElementById('contractorManagementModal'));
    if (modal) modal.hide();

    // å¤–æ³¨å…ˆãƒ•ã‚©ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆ
    const externalCard = $('.worker-type-card[data-type="external"]');
    $('.worker-type-card').removeClass('active');
    externalCard.addClass('active');
    externalCard.find('input[type="radio"]').prop('checked', true);
    $('.conditional-section').removeClass('active');
    $('#external-form').addClass('active');

    // æ—¢å­˜æ¥­è€…ã‚’é¸æŠ
    $('#existing_contractor').prop('checked', true).trigger('change');

    // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã§æ¥­è€…ã‚’é¸æŠ
    $('#contractorSelect').val(contractorId).trigger('change');

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const selectedOption = $('#contractorSelect option:selected');
    const contractorName = selectedOption.data('name');

    if (typeof toastr !== 'undefined') {
        toastr.success(`ã€Œ${contractorName}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã®å…ˆé ­ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    $('html, body').animate({
        scrollTop: $('#external-form').offset().top - 100
    }, 500);
};

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}
</script>
