{% extends "order_management/base.html" %}
{% load humanize %}
{% load role_tags %}
{% load custom_filters %}
{# ‚úÖ COMMENT_SYSTEM_V2.0_20251129_020500 #}

{% block title %}{{ project.site_name }} - Âª∫ÁØâÊ¥æÈÅ£ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†{% endblock %}

{% block extra_css %}
<style>
/* ÂÖ®‰ΩìÁöÑ„Å´ÊñáÂ≠ó„ÇíÂ§ß„Åç„Åè */
.content {
    font-size: 1.1rem;
}

/* ÊñôÈáë‰ΩìÁ≥ªÈÅ∏Êäû„Ç´„Éº„Éâ„ÅÆ„Çπ„Çø„Ç§„É´ */
.pricing-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.pricing-type-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
}

.pricing-type-card.border-primary {
    border-color: #0d6efd !important;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.25);
}

.pricing-type-card.bg-light {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.pricing-type-card .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
.progress-enhanced {
    border-radius: 4px;
    background-color: #e9ecef;
}

.progress-enhanced .progress-bar {
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: width 0.6s ease;
    color: #fff;
}

/* ÈÄ≤Êçó„Éê„ÉÉ„Ç∏„ÅÆËâ≤ */
.bg-verified {
    background-color: #155724 !important; /* ÊøÉ„ÅÑÁ∑ëÔºöÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„ÉÅ„Çß„ÉÉ„ÇØ */
}

/* „Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫„ÅÆÁµ±‰∏ÄÁöÑ„Å™Êã°Â§ß - „Ç§„É≥„É©„Ç§„É≥„Çπ„Çø„Ç§„É´„Çí‰∏äÊõ∏„Åç */
.content [style*="font-size: 0.6rem"],
.content [style*="font-size: 0.65rem"] {
    font-size: 0.8rem !important;
}

.content [style*="font-size: 0.7rem"],
.content [style*="font-size: 0.75rem"] {
    font-size: 0.9rem !important;
}

.content [style*="font-size: 0.8rem"],
.content [style*="font-size: 0.85rem"] {
    font-size: 1rem !important;
}

/* „Éú„Çø„É≥„ÅÆ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫ */
.content .btn {
    font-size: 0.9rem !important;
}

.content .btn-sm {
    font-size: 0.85rem !important;
}

/* „Éê„ÉÉ„Ç∏„ÅÆ„Éï„Ç©„É≥„Éà„Çµ„Ç§„Ç∫ */
.content .badge {
    font-size: 0.8rem !important;
}

/* „Éï„Ç©„Éº„É†Ë¶ÅÁ¥† */
.content .form-control,
.content .form-select {
    font-size: 0.9rem !important;
}

/* „ÉÜ„Éº„Éñ„É´ */
.content .table {
    font-size: 0.9rem !important;
}

/* Â∞è„Åï„ÅÑ„ÉÜ„Ç≠„Çπ„Éà */
.content small,
.content .small,
.content .text-muted {
    font-size: 0.85rem !important;
}
</style>
<!-- Sortable.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
    .progress-status-card {
        border: 2px solid;
        border-radius: 10px;
        transition: all 0.3s;
    }
    .progress-status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .action-button {
        min-width: 120px;
        margin: 0.25rem;
    }
    .status-selector {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1rem;
    }
    .progress-timeline {
        position: relative;
        padding-left: 2rem;
    }
    .progress-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -26px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d; /* „Ç∞„É¨„ÉºÔºö‰Ωï„ÇÇÂÖ•Âäõ„Å™„Åó */
    }
    .timeline-item.scheduled::before {
        background: #ffc107; /* ÈªÑËâ≤Ôºö‰∫àÂÆöÊó•„ÅÆ„ÅøÂÖ•Âäõ */
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }
    .timeline-item.completed::before {
        background: #28a745; /* Á∑ëÔºöÂÆå‰∫ÜÊó•„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çã */
    }
    .timeline-item.verified::before {
        background: #155724; /* ÊøÉ„ÅÑÁ∑ëÔºöÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„ÉÅ„Çß„ÉÉ„ÇØ */
        box-shadow: 0 0 0 4px rgba(21, 87, 36, 0.3);
    }
    .timeline-item.current::before {
        background: #ffc107; /* ÈªÑËâ≤ÔºöÁèæÂú®„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºà‰∫àÂÆöÊó•„ÅÆ„Åø„Å®Âêå„ÅòÔºâ */
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }

    /* Á∏¶Âûã„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº */
    .vertical-progress {
        position: relative;
        padding-left: 40px;
        min-height: 400px;
    }

    .vertical-progress::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }

    .progress-step {
        position: relative;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .progress-step::before {
        content: '';
        position: absolute;
        left: -28px;
        top: 8px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #6c757d;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #6c757d;
        transition: all 0.3s ease;
    }

    .progress-step.completed::before {
        background: #28a745;
        box-shadow: 0 0 0 2px #28a745;
    }

    .progress-step.active::before {
        background: #007bff;
        box-shadow: 0 0 0 2px #007bff, 0 0 0 6px rgba(0, 123, 255, 0.2);
        transform: scale(1.2);
    }

    .progress-step.overdue::before {
        background: #dc3545;
        box-shadow: 0 0 0 2px #dc3545, 0 0 0 6px rgba(220, 53, 69, 0.2);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 2px #dc3545, 0 0 0 6px rgba(220, 53, 69, 0.2);
        }
        50% {
            box-shadow: 0 0 0 2px #dc3545, 0 0 0 10px rgba(220, 53, 69, 0.4);
        }
    }

    .progress-step.overdue .progress-step-header {
        color: #dc3545;
    }

    .progress-step.overdue .progress-step-date {
        color: #dc3545;
        font-weight: 600;
    }

    .progress-step.overdue {
        background-color: rgba(220, 53, 69, 0.05);
        border-color: rgba(220, 53, 69, 0.3);
    }

    .progress-step:hover {
        transform: translateX(5px);
    }

    .progress-step-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        transition: color 0.3s ease;
    }

    .progress-step.completed .progress-step-header {
        color: #28a745;
    }

    .progress-step.active .progress-step-header {
        color: #007bff;
    }

    .progress-step-label {
        font-size: 1.05rem;
        font-weight: 500;
    }

    .progress-step-content {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 6px 8px;
        margin-top: 5px;
        display: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        font-size: 0.9rem;
        line-height: 1.3;
    }

    .progress-step.expanded .progress-step-content {
        max-height: 5000px;
        opacity: 1;
        border-color: #dee2e6;
        background: #fff;
    }

    .progress-step-content {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out;
    }

    .progress-step {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 0.25rem 0.4rem;
        margin-bottom: 0.3rem;
        background-color: #fff;
        max-width: 800px;
    }

    .progress-step:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        border-color: #adb5bd;
    }

    .progress-step.expanded {
        background-color: #fff;
        border-color: #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .progress-step-date {
        font-size: 0.85rem;
        color: #6c757d;
        line-height: 1.2;
    }

    /* „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÁÆ°ÁêÜ„Éë„Éç„É´ÂÜÖ„ÅÆ„Éï„Ç©„Éº„É†Ë¶ÅÁ¥†„ÇíÂ∞è„Åï„Åè„Åô„Çã */
    #activeSteps .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.2rem;
        line-height: 1.2;
    }

    #activeSteps .form-control,
    #activeSteps .form-select {
        font-size: 0.85rem;
        padding: 0.25rem 0.4rem;
        height: auto;
        min-height: 28px;
    }

    #activeSteps .form-check {
        font-size: 0.7rem;
        margin-bottom: 0.3rem;
        line-height: 1.2;
    }

    #activeSteps .form-check-input {
        width: 14px;
        height: 14px;
        margin-top: 0.1rem;
    }

    #activeSteps .btn {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        line-height: 1.2;
    }

    #activeSteps .mb-3 {
        margin-bottom: 0.5rem !important;
    }

    #activeSteps .mb-2 {
        margin-bottom: 0.3rem !important;
    }

    #activeSteps .input-group {
        font-size: 0.7rem;
    }

    #activeSteps .input-group .btn {
        padding: 0.2rem 0.4rem;
    }

    /* „Çπ„ÉÜ„ÉÉ„Éó„Éò„ÉÉ„ÉÄ„Éº„ÅÆ„Çµ„Ç§„Ç∫Ë™øÊï¥ */
    #activeSteps .progress-step-header {
        font-size: 0.75rem;
        line-height: 1.2;
    }

    #activeSteps .progress-step-header i {
        font-size: 0.7rem;
    }

    /* „Ç§„É≥„Éô„É≥„Éà„É™„Ç´„Éº„Éâ */
    .border-dashed {
        border: 2px dashed #dee2e6 !important;
        transition: all 0.3s ease;
    }
    .border-dashed:hover {
        border-color: #007bff !important;
        background-color: #f8f9fa;
    }

    /* „Éâ„É©„ÉÉ„Ç∞„Ç¢„É≥„Éâ„Éâ„É≠„ÉÉ„Éó */
    .progress-step.sortable-ghost {
        opacity: 0.5;
        background: #e9ecef;
    }
    .progress-step.sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .progress-step.sortable-chosen {
        cursor: grab;
    }
    .progress-step {
        transition: all 0.3s ease;
    }
    .progress-step:hover {
        transform: translateX(5px);
    }
    .drag-handle {
        cursor: grab;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .progress-step:hover .drag-handle {
        opacity: 1;
    }
    .drag-handle:active {
        cursor: grabbing;
    }

    .progress-step.completed .progress-step-date {
        color: #28a745;
        font-weight: 500;
    }

    /* Ë©≥Á¥∞ÈÄ≤ÊçóÁÆ°ÁêÜ„Çø„Ç§„É†„É©„Ç§„É≥ - Phase 11 */
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 28px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #e9ecef 0%, #dee2e6 100%);
    }

    .timeline-item {
        position: relative;
        padding-left: 70px;
        padding-bottom: 30px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-marker {
        position: absolute;
        left: 0;
        top: 0;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        z-index: 1;
    }

    .timeline-marker.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .timeline-marker.bg-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
    }

    .timeline-content {
        background: #ffffff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .timeline-content:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        transform: translateX(5px);
    }

    .timeline-content h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .badge.bg-light.text-dark {
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
    }

    /* FullCalendar „Çπ„Çø„Ç§„É´Ë™øÊï¥ */
    #projectCalendar {
        max-width: 100%;
        margin: 0 auto;
    }
</style>

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css' rel='stylesheet' />
{% endblock %}

{% block content %}
<!-- ‰øùÂ≠òÁä∂ÊÖã„Éê„Éä„Éº -->
<div id="savingStatusBanner" class="alert alert-info alert-dismissible fade show d-none" role="alert" style="position: fixed; top: 60px; right: 20px; z-index: 10000; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="d-flex align-items-center">
        <div id="savingStatusIcon" class="me-2">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <div id="savingStatusText">
            ‰øùÂ≠ò‰∏≠...
        </div>
    </div>
</div>

<!-- Êñ∞„Åó„ÅÑ1„Éñ„É≠„ÉÉ„ÇØÁõÆ: Ê°à‰ª∂„Éò„ÉÉ„ÉÄ„ÉºÔºàÊ®™Èï∑„ÄÅ100pxÈ´ò„ÅïÔºâ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card shadow-sm" style="min-height: 100px;">
            <div class="card-body p-2 d-flex align-items-center justify-content-between">
                <!-- Â∑¶ÂÅ¥: Ê°à‰ª∂Âêç„Å®ÁÆ°ÁêÜÁï™Âè∑ -->
                <div class="flex-grow-1 overflow-hidden" style="min-width: 0;">
                    <div class="d-flex align-items-center mb-1">
                        <h5 class="mb-0 me-2 text-truncate" style="font-size: 1rem; max-width: 60%;"><i class="fas fa-building me-1" style="font-size: 0.9rem;"></i>{{ project.site_name }}</h5>
                        <span class="badge project-status-badge {% if project.project_status == 'ÂèóÊ≥®Á¢∫ÂÆö' %}bg-success{% elif project.project_status == 'A' %}bg-danger{% elif project.project_status == 'B' %}bg-warning text-dark{% elif project.project_status == 'NG' %}bg-secondary{% else %}text-dark{% endif %}"
                              style="{% if project.project_status == '„Éç„Çø' %}background-color: #e9d5ff;{% endif %} cursor: help; font-size: 0.7rem;"
                              title="{% if project.project_status == 'ÂèóÊ≥®Á¢∫ÂÆö' %}Ê≠£Âºè„Å´Â•ëÁ¥Ñ„ÅåÊ±∫ÂÆö„Åó„ÅüÊ°à‰ª∂„ÄÇÊñΩÂ∑•Ê∫ñÂÇô„ÉªÂÆüÊñΩÊÆµÈöé{% elif project.project_status == 'A' %}ÂèóÊ≥®Á¢∫Â∫¶„ÄêÈ´ò„ÄëË¶ãÁ©çÊèêÂá∫Ê∏à„Åø„Åß„ÄÅÂ•ëÁ¥Ñ„ÅÆÊÑèÂêë„ÅåÂº∑„ÅèÁ¢∫Ë™ç„Åß„Åç„Å¶„ÅÑ„ÇãÊ°à‰ª∂{% elif project.project_status == 'B' %}ÂèóÊ≥®Á¢∫Â∫¶„Äê‰∏≠„ÄëË¶ãÁ©çÊèêÂá∫Ê∏à„Åø„Å†„Åå„ÄÅ‰ªñÁ§æ„Å®„ÅÆÁ´∂Âêà„ÇÑ‰∏çÁ¢∫ÂÆöË¶ÅÁ¥†„Åå„ÅÇ„ÇãÊ°à‰ª∂{% elif project.project_status == 'NG' %}Â§±Ê≥®„Åæ„Åü„ÅØÂèñ„Çä‰∏ã„Åí„ÅüÊ°à‰ª∂„ÄÇ‰ªñÁ§æÂèóÊ≥®„ÇÑ‰∫àÁÆó‰∏çÊàêÁ´ã„Å™„Å©{% else %}ÂàùÊúüÊÆµÈöé„ÅÆË¶ãËæº„ÅøÊ°à‰ª∂„ÄÇÂÖÉË´ã„Åã„Çâ„ÅÆÂïè„ÅÑÂêà„Çè„Åõ„ÇÑÂºï„ÅçÂêà„ÅÑ„Åå„ÅÇ„Å£„ÅüÊÆµÈöé{% endif %}">
                            {{ project.get_project_status_display }}
                        </span>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2" style="font-size: 0.7rem;">
                        <span class="text-muted"><strong>No:</strong> {{ project.management_no }}</span>
                        <span class="text-muted">|</span>
                        <span class="text-truncate" style="max-width: 150px;"><strong>ÂÖÉË´ã:</strong>
                            {% if project.client_company %}
                                {{ project.client_company.company_name }}
                            {% elif project.client_name %}
                                {{ project.client_name }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                        <span class="text-muted">|</span>
                        <span><strong>Â∑•‰∫ã:</strong> <span class="badge bg-secondary" style="font-size: 0.65rem;">{{ project.work_type }}</span></span>
                        <span class="text-muted">|</span>
                        <span class="text-muted" style="opacity: 0.7;">Â£≤‰∏ä</span>
                        <span class="text-success fw-bold">¬•{{ financial_info.revenue|floatformat:0|intcomma }}</span>
                        <span class="text-muted mx-1">|</span>
                        <span class="text-muted" style="opacity: 0.7;">Âéü‰æ°</span>
                        <span class="text-warning">¬•{{ financial_info.cost_of_sales|floatformat:0|intcomma }}</span>
                        <span class="text-muted mx-1">|</span>
                        <span class="text-muted" style="opacity: 0.7;">Âà©Áõä</span>
                        <span class="text-primary fw-bold">¬•{{ financial_info.gross_profit|floatformat:0|intcomma }}</span>
                        <small class="text-info">({{ financial_info.gross_profit_rate|floatformat:1 }}%)</small>
                        <span class="text-muted mx-1">|</span>
                        {% with stage=project.get_current_project_stage %}
                        <span><strong>ÈÄ≤Êçó:</strong> <span class="badge bg-{{ stage.color }}" style="font-size: 0.65rem;">{{ stage.stage }}</span></span>
                        {% endwith %}
                        <span class="text-muted">|</span>
                        <span><strong>ÈñãÂßã:</strong> {{ project.work_start_date|date:"Y/m/d"|default:"-" }}</span>
                        <span class="text-muted">|</span>
                        <span><strong>ÁµÇ‰∫Ü:</strong> {{ project.work_end_date|date:"Y/m/d"|default:"-" }}</span>
                    </div>
                </div>
                <!-- Âè≥ÂÅ¥: „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥ -->
                <div class="d-flex gap-1 ms-2 flex-shrink-0">
                    <a href="{% url 'order_management:project_update' project.pk %}" class="btn btn-warning btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="Á∑®ÈõÜ">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{% url 'subcontract_management:project_subcontract_list' project.pk %}" class="btn btn-success btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="Áô∫Ê≥®ÁÆ°ÁêÜ">
                        <i class="fas fa-file-contract"></i>
                    </a>
                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="ÂâäÈô§">
                        <i class="fas fa-trash"></i>
                    </button>
                    <a href="{% url 'order_management:project_list' %}" class="btn btn-secondary btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="‰∏ÄË¶ß">
                        <i class="fas fa-list"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Ë©≥Á¥∞ÊÉÖÂ†± (ÊîπÂñÑÁâà - „Çø„ÉñUI) -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center py-1" style="cursor: pointer;" onclick="toggleDetailInfo()">
                <div class="d-flex align-items-center">
                    <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;">
                        <i class="fas fa-info-circle me-2"></i>Ê°à‰ª∂Ë©≥Á¥∞ÊÉÖÂ†±
                    </h6>
                    <i class="fas fa-chevron-down ms-2" id="detailInfoToggleIcon" style="font-size: 0.75rem; transition: transform 0.3s ease;"></i>
                </div>
                <!-- Ë°®Á§∫Âàá„ÇäÊõø„Åà„Éú„Çø„É≥ -->
                <div class="btn-group btn-group-sm" role="group" onclick="event.stopPropagation();">
                    <button type="button" class="btn btn-light active" id="tabViewBtn" onclick="switchViewMode('tab')" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-th-large me-1"></i>„Çø„ÉñË°®Á§∫
                    </button>
                    <button type="button" class="btn btn-light" id="fullViewBtn" onclick="switchViewMode('full')" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-list me-1"></i>ÂÖ®‰ΩìË°®Á§∫
                    </button>
                </div>
            </div>
            <div class="card-body p-0" id="detailInfoBody" style="display: none;">
                <!-- „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥ -->
                <ul class="nav nav-tabs" id="projectDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="basic-tab" data-bs-toggle="tab" data-bs-target="#basic" type="button" role="tab">
                            <i class="fas fa-info-circle me-1"></i>Âü∫Êú¨ÊÉÖÂ†±
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">
                            <i class="fas fa-calendar-alt me-1"></i>„Çπ„Ç±„Ç∏„É•„Éº„É´
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="finance-tab" data-bs-toggle="tab" data-bs-target="#finance" type="button" role="tab">
                            <i class="fas fa-file-invoice-dollar me-1"></i>Ë´ãÊ±Ç
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="calendar-tab" data-bs-toggle="tab" data-bs-target="#calendar" type="button" role="tab">
                            <i class="fas fa-calendar me-1"></i>„Ç´„É¨„É≥„ÉÄ„Éº
                        </button>
                    </li>
                </ul>

                <!-- „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ -->
                <div class="tab-content p-3" id="projectDetailTabsContent">
                    <!-- Âü∫Êú¨ÊÉÖÂ†±„Çø„Éñ -->
                    <div class="tab-pane fade show active" id="basic" role="tabpanel" data-section-title="üìã Âü∫Êú¨ÊÉÖÂ†±">
                        <!-- Âü∫Êú¨ÊÉÖÂ†±„Å®ÂèóÊ≥®ÈáëÈ°çÊÉÖÂ†±„ÇíÊ®™‰∏¶„Å≥ -->
                        <div class="row">
                            <div class="col-lg-6">
                                <!-- Âü∫Êú¨ÊÉÖÂ†±„Ç´„Éº„Éâ -->
                                <div class="card shadow-sm mb-3" style="font-size: 0.9rem;">
                                    <div class="card-header bg-primary text-white py-2">
                                        <h6 class="mb-0" style="font-size: 0.95rem;"><i class="fas fa-info-circle me-2"></i>Âü∫Êú¨ÊÉÖÂ†±</h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <!-- ÁÆ°ÁêÜNoÔºàË™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®Ôºâ -->
                                        <div class="mb-3">
                                            <label class="form-label fw-bold" style="font-size: 0.85rem;">ÁÆ°ÁêÜNo</label>
                                            <div class="form-control-plaintext">{{ project.management_no }}</div>
                                        </div>

                                        <!-- ÂÖÉË´ãÂêç„Å®Ê°à‰ª∂ÊãÖÂΩìËÄÖ„ÇíÊúÄÂÑ™ÂÖà -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">ÂÖÉË´ãÂêç</label>
                                                <div class="d-flex gap-2">
                                                    <div class="form-control-plaintext">
                                                        {{ project.client_company.company_name|default:"-" }}
                                                    </div>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openClientCompanyManagementPanel()" title="ÂÖÉË´ã‰ºöÁ§æ„ÇíÈÅ∏Êäû„ÉªÁÆ°ÁêÜ">
                                                        <i class="fas fa-building"></i> ÂÖÉË´ãÁÆ°ÁêÜ
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">Ê°à‰ª∂ÊãÖÂΩìËÄÖÔºàÂñ∂Ê•≠Ôºâ</label>
                                                <div class="d-flex gap-2">
                                                    <div class="form-control-plaintext">
                                                        {{ project.project_manager|default:"-" }}
                                                    </div>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openSalesStaffManagementPanel()">
                                                        <i class="fas fa-chart-line"></i> Âñ∂Ê•≠ÁÆ°ÁêÜ
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ÁèæÂ†¥Âêç„ÉªÁ®ÆÂà•„Éª‰ΩèÊâÄ -->
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">ÁèæÂ†¥Âêç</label>
                                                <div class="form-control-plaintext editable-field" data-field="site_name" data-type="text">
                                                    <span class="field-value">{{ project.site_name }}</span>
                                                    <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">Á®ÆÂà•</label>
                                                <div class="d-flex gap-2 align-items-center">
                                                    <div class="editable-field" data-field="work_type" data-type="work_type">
                                                        <span class="field-value"><span class="badge bg-secondary">{{ project.work_type }}</span></span>
                                                        <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                                    </div>
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openWorkTypeManagementModal()" title="Â∑•‰∫ãÁ®ÆÂà•„ÇíÁÆ°ÁêÜ">
                                                        <i class="fas fa-tools"></i> Á®ÆÂà•ÁÆ°ÁêÜ
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">
                                                    ÊùêÂ∑•/ÊâãÈñì
                                                    <i class="fas fa-info-circle text-muted ms-1"
                                                       data-bs-toggle="tooltip"
                                                       data-bs-placement="top"
                                                       title="ÊùêÂ∑•=Ë≥áÊùê„ÅÆÁô∫Ê≥®„ÇÇËá™Á§æ„ÅßË°å„ÅÜ„ÄÅÊâãÈñì=ÊùêÊñô„ÅØÂÖÉË´ã„Åã„ÇâÊîØÁµ¶„Åï„ÇåÂä¥ÂÉçÂäõ„ÅÆ„ÅøÊèê‰æõ"></i>
                                                </label>
                                                <div>
                                                    {% if project.material_labor_type == 'material_labor' %}
                                                        <span class="badge bg-primary">ÊùêÂ∑•</span>
                                                    {% elif project.material_labor_type == 'labor_only' %}
                                                        <span class="badge bg-info">ÊâãÈñì</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">-</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label" style="font-size: 0.85rem;">ÁèæÂ†¥‰ΩèÊâÄ</label>
                                            <div class="form-control-plaintext editable-field" data-field="site_address" data-type="text">
                                                <span class="field-value">{{ project.site_address|default:"-" }}</span>
                                                <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                            </div>
                                        </div>

                                        <!-- ÈçµÂèó„ÅëÊ∏°„ÅóË®≠ÂÆö -->
                                        {% if project.key_handover_location or project.key_handover_date or project.key_handover_notes %}
                                        <div class="row mt-3">
                                            <div class="col-12">
                                                <div class="alert alert-info" style="font-size: 0.85rem;">
                                                    <h6 style="font-size: 0.9rem;"><i class="fas fa-key me-2"></i>ÈçµÂèó„ÅëÊ∏°„ÅóË®≠ÂÆö</h6>
                                                    {% if project.key_handover_location %}
                                                    <p class="mb-1"><strong>Â†¥ÊâÄ:</strong> {{ project.key_handover_location }}</p>
                                                    {% endif %}
                                                    {% if project.key_handover_date %}
                                                    <p class="mb-1"><strong>Êó•ÊôÇ:</strong> {{ project.key_handover_date }}</p>
                                                    {% endif %}
                                                    {% if project.key_handover_notes %}
                                                    <p class="mb-0"><strong>„É°„É¢:</strong> {{ project.key_handover_notes }}</p>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <!-- ÂèóÊ≥®ÈáëÈ°çÊÉÖÂ†±„Ç´„Éº„Éâ -->
                                <div class="card shadow-sm mb-3" style="font-size: 0.9rem;">
                                    <div class="card-header bg-success text-white py-2">
                                        <h6 class="mb-0" style="font-size: 0.95rem;"><i class="fas fa-yen-sign me-2"></i>ÂèóÊ≥®ÈáëÈ°çÊÉÖÂ†±</h6>
                                    </div>
                                    <div class="card-body p-3">
                                        <div class="row">
                                            <div class="col-md-12 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">ÂèóÊ≥®„É®„Éü</label>
                                                <div class="d-flex gap-2 align-items-center">
                                                    <select class="form-select order-forecast-select-detail"
                                                            data-project-id="{{ project.pk }}">
                                                        {% for value, label in project.PROJECT_STATUS_CHOICES %}
                                                        <option value="{{ value }}" {% if value == project.project_status %}selected{% endif %}>
                                                            {{ label }}
                                                        </option>
                                                        {% endfor %}
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">ÂèóÊ≥®ÈáëÈ°ç(Á®éÊäú)</label>
                                                <div class="text-primary fw-bold editable-field" data-field="order_amount" data-type="number">
                                                    <span class="field-value">¬•{{ project.order_amount|floatformat:0|intcomma }}</span>
                                                    <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">ÈáëÈ°ç„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                                <div>
                                                    {% if project.order_amount_status == 'estimated' %}
                                                        <span class="badge bg-warning">Ë¶ãÁ©ç„ÇÇ„ÇäÂæåÁ¢∫ÂÆö</span>
                                                    {% elif project.order_amount_status == 'planned' %}
                                                        <span class="badge bg-info">‰∫àÂÆö</span>
                                                    {% elif project.order_amount_status == 'confirmed' %}
                                                        <span class="badge bg-success">Á¢∫ÂÆö</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">-</span>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">ÂÆüË´ãÊ±ÇÈ°ç</label>
                                                <div class="text-success fw-bold editable-field" data-field="billing_amount" data-type="number">
                                                    <span class="field-value">¬•{{ project.billing_amount|floatformat:0|intcomma }}</span>
                                                    <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">ÈßêËªäÂ†¥‰ª£</label>
                                                <div class="editable-field" data-field="parking_fee" data-type="number">
                                                    <span class="field-value">¬•{{ project.parking_fee|floatformat:0|intcomma }}</span>
                                                    <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">Â¢óÊ∏õÈ°ç</label>
                                                <div class="{% if project.amount_difference > 0 %}text-success{% elif project.amount_difference < 0 %}text-danger{% endif %} fw-bold">
                                                    ¬•{{ project.amount_difference|floatformat:0|intcomma }}
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label class="form-label" style="font-size: 0.85rem;">Ê°à‰ª∂ÈÄ≤Êçó</label>
                                                <div>
                                                    {% with stage=project.get_current_project_stage %}
                                                    <span class="badge bg-{{ stage.color }}">{{ stage.stage }}</span>
                                                    {% endwith %}
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ÁµåË≤ª„ÉªË´∏ÁµåË≤ªÈ†ÖÁõÆ„ÅÆË°®Á§∫ -->
                                        {% if project.expense_item_1 or project.expense_item_2 %}
                                        <div class="mt-3">
                                            <div class="card border-warning" style="font-size: 0.85rem;">
                                                <div class="card-header bg-warning bg-opacity-10">
                                                    <h6 class="mb-0" style="font-size: 0.9rem;"><i class="fas fa-receipt me-2"></i>ÁµåË≤ª„ÉªË´∏ÁµåË≤ªÈ†ÖÁõÆ</h6>
                                                </div>
                                                <div class="card-body">
                                                    <table class="table table-sm mb-0">
                                                        <thead class="table-light">
                                                            <tr>
                                                                <th>È†ÖÁõÆÂêç</th>
                                                                <th>ÈáëÈ°ç</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {% if project.expense_item_1 %}
                                                            <tr>
                                                                <td>{{ project.expense_item_1 }}</td>
                                                                <td>¬•{{ project.expense_amount_1|floatformat:0|intcomma }}</td>
                                                            </tr>
                                                            {% endif %}
                                                            {% if project.expense_item_2 %}
                                                            <tr>
                                                                <td>{{ project.expense_item_2 }}</td>
                                                                <td>¬•{{ project.expense_amount_2|floatformat:0|intcomma }}</td>
                                                            </tr>
                                                            {% endif %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÂÇôËÄÉ„ÉªÊ∑ª‰ªò„Éï„Ç°„Ç§„É´„Ç´„Éº„Éâ -->
                        <div class="card shadow-sm mb-3" style="font-size: 0.9rem;">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0" style="font-size: 0.95rem;"><i class="fas fa-sticky-note me-2"></i>ÂÇôËÄÉ„ÉªÊ∑ª‰ªò„Éï„Ç°„Ç§„É´</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="mb-3">
                                    <label class="form-label" style="font-size: 0.85rem;">ÂÇôËÄÉ</label>
                                    <div class="form-control-plaintext editable-field" data-field="notes" data-type="textarea">
                                        <span class="field-value">{{ project.notes|default:"-"|linebreaks }}</span>
                                        <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" style="font-size: 0.85rem;">
                                        <i class="fas fa-paperclip me-1"></i>Ê∑ª‰ªò„Éï„Ç°„Ç§„É´
                                    </label>

                                    <!-- „Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ∏à„Åø„Éï„Ç°„Ç§„É´‰∏ÄË¶ß -->
                                    {% if project.files.exists %}
                                    <div class="card" style="font-size: 0.85rem;">
                                        <div class="card-header bg-light py-2">
                                            <small class="text-muted" style="font-size: 0.8rem;"><i class="fas fa-file me-1"></i>„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ∏à„Åø„Éï„Ç°„Ç§„É´</small>
                                        </div>
                                        <div class="card-body p-2">
                                            <ul class="list-group list-group-flush">
                                                {% for file in project.files.all %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center py-2" style="font-size: 0.85rem;">
                                                    <span>
                                                        <i class="fas fa-file-{% if file.is_pdf %}pdf{% elif file.is_image %}image{% else %}alt{% endif %} me-2"></i>
                                                        {{ file.file_name }}
                                                        <small class="text-muted">({{ file.get_file_size_display }})</small>
                                                    </span>
                                                    <div>
                                                        {% if file.file %}
                                                        <a href="{{ file.file.url }}" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                                                            <i class="fas fa-download"></i>
                                                        </a>
                                                        {% else %}
                                                        <span class="btn btn-sm btn-outline-secondary me-1 disabled" title="„Éï„Ç°„Ç§„É´„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì">
                                                            <i class="fas fa-exclamation-triangle"></i>
                                                        </span>
                                                        {% endif %}
                                                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteProjectFile({{ file.id }})">
                                                            <i class="fas fa-trash"></i>
                                                        </button>
                                                    </div>
                                                </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    </div>
                                    {% else %}
                                    <p class="text-muted">Ê∑ª‰ªò„Éï„Ç°„Ç§„É´„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ -->
                    <div class="tab-pane fade" id="calendar" role="tabpanel" data-section-title="üìÖ „Ç´„É¨„É≥„ÉÄ„Éº">
                        <div class="card shadow-sm">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="mb-0" style="font-size: 0.95rem;"><i class="fas fa-calendar me-2"></i>Ê°à‰ª∂„Çπ„Ç±„Ç∏„É•„Éº„É´</h6>
                            </div>
                            <div class="card-body p-3">
                                <div id="projectCalendar"></div>
                            </div>
                        </div>
                    </div>

                    <!-- „Çπ„Ç±„Ç∏„É•„Éº„É´„Çø„Éñ -->
                    <div class="tab-pane fade" id="schedule" role="tabpanel" data-section-title="üìÖ „Çπ„Ç±„Ç∏„É•„Éº„É´">
                        <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÁÆ°ÁêÜÂèÇÁÖß„Ç´„Éº„Éâ -->
                        <div class="card shadow-sm mb-3" style="font-size: 0.9rem;">
                            <div class="card-header bg-gradient-primary text-white py-2">
                                <h6 class="mb-0" style="font-size: 0.95rem;"><i class="fas fa-cog me-2"></i>‰∏ªË¶ÅÊó•Á®ã</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="alert alert-info mb-3" style="font-size: 0.85rem;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Ë©≥Á¥∞„Å™„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÁÆ°ÁêÜ„ÅØ„ÄÅ„Éö„Éº„Ç∏‰∏ãÈÉ®„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                                </div>

                                <!-- ‰∏ªË¶ÅÊó•Á®ã„Çµ„Éû„É™„Éº -->
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">Â•ëÁ¥ÑÊó•</label>
                                        <div class="editable-field" data-field="contract_date" data-type="date">
                                            <span class="field-value">{{ project.contract_date|date:"YÂπ¥mÊúàdÊó•"|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">ÂÖ•Èáë‰∫àÂÆöÊó•</label>
                                        <div class="editable-field" data-field="payment_due_date" data-type="date">
                                            <span class="field-value">{{ project.payment_due_date|date:"YÂπ¥mÊúàdÊó•"|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">Â∑•‰∫ãÈñãÂßãÊó•</label>
                                        <div style="font-size: 0.9rem;">
                                            {{ project.work_start_date|date:"YÂπ¥mÊúàdÊó•"|default:"-" }}
                                            <small class="text-muted d-block" style="font-size: 0.75rem;"><i class="fas fa-info-circle"></i> ÁùÄÂ∑•Êó•„Åã„ÇâËá™ÂãïÂêåÊúü</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">Â∑•‰∫ãÁµÇ‰∫ÜÊó•</label>
                                        <div style="font-size: 0.9rem;">
                                            {{ project.work_end_date|date:"YÂπ¥mÊúàdÊó•"|default:"-" }}
                                            <small class="text-muted d-block" style="font-size: 0.75rem;"><i class="fas fa-info-circle"></i> ÂÆåÂ∑•Êó•„Åã„ÇâËá™ÂãïÂêåÊúü</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ÂÆå‰∫ÜÂ†±Âëä„Ç´„Éº„Éâ -->
                        <div class="card shadow-sm" style="font-size: 0.9rem;">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0" style="font-size: 0.95rem;"><i class="fas fa-clipboard-check me-2"></i>ÂÆå‰∫ÜÂ†±Âëä</h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">ÂÆå‰∫ÜÂ†±Âëä„Çπ„ÉÜ„Éº„Çø„Çπ</label>
                                        <div>
                                            {% if project.completion_report_completed %}
                                            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">ÂÆå‰∫ÜÂ†±ÂëäÊó•</label>
                                        <div>{{ project.completion_report_date|date:"YÂπ¥mÊúàdÊó•"|default:"-" }}</div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">ÂÖÉË´ã„ÉÜ„É≥„Éó„É¨„Éº„Éà</label>
                                        <div>
                                            {% if project.client_company and project.client_company.completion_report_template %}
                                            <a href="{{ project.client_company.completion_report_template.url }}" class="btn btn-sm btn-outline-primary" download>
                                                <i class="fas fa-download me-1"></i>„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                                            </a>
                                            {% else %}
                                            <span class="text-muted" style="font-size: 0.85rem;">„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å™„Åó</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">ÂÆå‰∫ÜÂ†±Âëä„Éï„Ç°„Ç§„É´</label>
                                        <div>
                                            {% if project.completion_report_file %}
                                            <a href="{{ project.completion_report_file.url }}" class="btn btn-sm btn-success" download>
                                                <i class="fas fa-file-download me-1"></i>„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                                            </a>
                                            <small class="text-muted ms-2" style="font-size: 0.75rem;">{{ project.completion_report_file.name|slice:"19:" }}</small>
                                            {% else %}
                                            <span class="text-muted" style="font-size: 0.85rem;">Êú™„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% if project.completion_report_content %}
                                <div class="row">
                                    <div class="col-12 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">ÂÆå‰∫ÜÂ†±ÂëäÂÜÖÂÆπ</label>
                                        <div class="p-2 bg-light rounded" style="white-space: pre-wrap; font-size: 0.85rem;">{{ project.completion_report_content }}</div>
                                    </div>
                                </div>
                                {% endif %}
                                {% if project.completion_report_notes %}
                                <div class="row">
                                    <div class="col-12">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">„É°„É¢</label>
                                        <div class="p-2 bg-light rounded" style="white-space: pre-wrap; font-size: 0.85rem;">{{ project.completion_report_notes }}</div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Ë´ãÊ±Ç„Çø„Éñ -->
                    <div class="tab-pane fade" id="finance" role="tabpanel" data-section-title="üí∞ Ë´ãÊ±Ç">
                        <!-- Ë´ãÊ±Ç„Çª„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="card shadow-sm" style="font-size: 0.9rem;">
                            <div class="card-header bg-info text-white py-2">
                                <h6 class="mb-0" style="font-size: 0.95rem;">
                                    <i class="fas fa-file-invoice me-2"></i>Ë´ãÊ±ÇÊÉÖÂ†±
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <!-- ÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´ÊÉÖÂ†±ÔºàË™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®„Ç´„Éº„ÉâÔºâ -->
                                {% if project.client_company %}
                                <div class="alert alert-info mb-3" style="font-size: 0.85rem;">
                                    <h6 class="mb-2" style="font-size: 0.9rem;">
                                        <i class="fas fa-info-circle me-2"></i>ÂÖÉË´ã‰ºöÁ§æ„ÅÆÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>ÊîØÊâï„Çµ„Ç§„ÇØ„É´:</strong><br>
                                            <span>{{ project.client_company.payment_cycle|default:"-" }}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Á∑†„ÇÅÊó•:</strong><br>
                                            <span>{% if project.client_company.closing_day is not None %}{{ project.client_company.closing_day }}Êó•{% else %}-{% endif %}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>ÊîØÊâïÊúà:</strong><br>
                                            <span>{% if project.client_company.payment_offset_months is not None %}{{ project.client_company.payment_offset_months }}„É∂ÊúàÂæå{% else %}-{% endif %}</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>ÊîØÊâïÊó•:</strong><br>
                                            <span>{% if project.client_company.payment_day is not None %}{{ project.client_company.payment_day }}Êó•{% else %}-{% endif %}</span>
                                        </div>
                                    </div>
                                </div>
                                {% endif %}

                                <!-- ÂÖ•Èáë‰∫àÂÆöÊó• -->
                                <div class="row mb-2">
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">
                                            ÂÖ•Èáë‰∫àÂÆöÊó•ÔºàËá™Á§æ‚ÜêÂÖÉË´ãÔºâ
                                        </label>
                                        <div>
                                            {{ project.payment_due_date|date:"YÂπ¥mÊúàdÊó•"|default:"-" }}
                                        </div>
                                        <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">ÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´„ÅØÂÖÉË´ã‰ºöÁ§æ„ÅÆË®≠ÂÆöÂÄ§„Åß„Åô</small>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="form-label fw-bold" style="font-size: 0.85rem;">Ë´ãÊ±ÇÊõ∏Áä∂Ê≥ÅÔºàËá™Á§æ‚ÜíÂÖÉË´ãÔºâ</label>
                                        <div class="mt-2">
                                            {% if project.invoice_issued %}
                                            <span class="badge bg-success">Ë´ãÊ±ÇÊõ∏Áô∫Ë°åÊ∏à„Åø</span>
                                            {% else %}
                                            <span class="badge bg-secondary">Êú™Áô∫Ë°å</span>
                                            {% endif %}
                                        </div>

                                        <!-- Ë´ãÊ±ÇÊõ∏„Éï„Ç°„Ç§„É´ -->
                                        <div class="mt-2">
                                            <label class="form-label small" style="font-size: 0.8rem;">
                                                <i class="fas fa-file-invoice me-1"></i>Ë´ãÊ±ÇÊõ∏„Éï„Ç°„Ç§„É´ÔºàËá™Á§æ‚ÜíÂÖÉË´ãÔºâ
                                            </label>
                                            {% if project.invoice_file %}
                                            <div class="mt-2">
                                                <a href="{{ project.invoice_file.url }}" target="_blank" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-file-pdf me-1"></i>Ë´ãÊ±ÇÊõ∏„ÇíÁ¢∫Ë™ç
                                                </a>
                                                <small class="text-muted ms-2" style="font-size: 0.75rem;">{{ project.invoice_file.name|slice:"19:" }}</small>
                                            </div>
                                            {% else %}
                                            <p class="text-muted small mb-0" style="font-size: 0.8rem;">Ë´ãÊ±ÇÊõ∏„Éï„Ç°„Ç§„É´„ÅØÊú™„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åß„Åô</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</div>

<!-- 1„Ç´„É©„É†: „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÁÆ°ÁêÜ & „Ç≥„É°„É≥„Éà -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-gradient-primary text-white py-1">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;"><i class="fas fa-cog"></i> „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÁÆ°ÁêÜ</h6>
                    <button type="button" class="btn btn-sm btn-light" id="toggleAllSteps" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-compress-alt"></i> <span id="toggleButtonText">ÂÖ®ÈÉ®Èñâ„Åò„Çã</span>
                    </button>
                </div>
            </div>
            <div class="card-body p-2" style="overflow-y: auto; overflow-x: visible;">
                <form method="post" action="{% url 'order_management:update_progress' project.pk %}">
                    {% csrf_token %}

                    <!-- ÂÖ®‰Ωì„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº -->
                    <div class="mb-3">
                        {% if project.project_status == 'ng' %}
                        <!-- NGÊ°à‰ª∂„ÅÆÂ†¥Âêà„ÅØ„Ç≠„É£„É≥„Çª„É´Ê∏à„ÇíË°®Á§∫ -->
                        <div class="d-flex justify-content-center align-items-center" style="padding: 2rem 1rem;">
                            <div class="text-center">
                                <i class="fas fa-ban text-danger" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h5 class="text-danger mb-0">„Ç≠„É£„É≥„Çª„É´Ê∏à</h5>
                                <small class="text-muted d-block mt-2" style="font-size: 0.75rem;">„Åì„ÅÆÊ°à‰ª∂„ÅØ„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü</small>
                            </div>
                        </div>
                        {% else %}
                        <!-- ÈÄöÂ∏∏„ÅÆÈÄ≤ÊçóË°®Á§∫ -->
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted" style="font-size: 0.7rem;">
                                <i class="fas fa-chart-line me-1"></i>ÈÄ≤Êçó
                                <i class="fas fa-question-circle ms-1" style="font-size: 0.6rem; cursor: help;" title="ÈÄ≤Êçó„ÅÆÂà§ÂÆö„É≠„Ç∏„ÉÉ„ÇØÔºö&#10;1. ÂÆåÂ∑•Êó•„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„ÄåÂÆåÂ∑•„Äç&#10;2. ÁùÄÂ∑•Êó•„ÅåÂÆå‰∫Ü„Åæ„Åü„ÅØÂÆüÊñΩÊó•„Åå„ÅÇ„Çå„Å∞„ÄåÂ∑•‰∫ã‰∏≠„Äç&#10;3. ÁùÄÂ∑•Êó•„ÅÆ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„Å™„Çâ„ÄåÂ∑•‰∫ã‰∏≠„ÅÆ‰∫àÂÆö„Äç&#10;4. ÁùÄÂ∑•Êó•„ÅÆ‰∫àÂÆöÊó•„ÅåÊú™Êù•„Å™„Çâ„ÄåÁùÄÂ∑•Êó•ÂæÖ„Å°„Äç&#10;5. Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„Åå„ÅÇ„Çå„Å∞„ÄåË¶ãÁ©ç„ÇÇ„ÇäÂØ©Êüª‰∏≠„Äç&#10;6. ÁèæË™ø„ÅåÂÆå‰∫Ü„Åæ„Åü„ÅØ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„Å™„Çâ„ÄåÁèæË™øÊ∏à„Åø„Äç&#10;7. ÁèæË™ø„ÅÆ‰∫àÂÆöÊó•„Åå„ÅÇ„Çå„Å∞„ÄåÁèæË™øÂæÖ„Å°„Äç&#10;8. Á´ã„Å°‰ºö„ÅÑ„ÅåÂÆå‰∫Ü„Åæ„Åü„ÅØ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„Å™„Çâ„ÄåÁ´ã„Å°‰ºö„ÅÑÊ∏à„Åø„Äç&#10;9. Á´ã„Å°‰ºö„ÅÑ„ÅÆ‰∫àÂÆöÊó•„Åå„ÅÇ„Çå„Å∞„ÄåÁ´ã„Å°‰ºö„ÅÑÂæÖ„Å°„Äç&#10;10. „Åù„Çå‰ª•Â§ñ„ÅØ„ÄåÊú™ÈñãÂßã„Äç"></i>
                                <span id="overallPhase" class="badge bg-{{ stage.color }}" style="font-size: 0.6rem; margin-left: 0.3rem;">{{ stage.stage }}</span>
                                <span id="overallStepCount" style="font-size: 0.65rem; margin-left: 0.3rem;">0/0</span>
                            </small>
                        </div>

                        <div class="progress progress-enhanced" style="height: 15px;">
                            <div class="progress-bar bg-warning" id="overallProgressBar" style="width: 0%">
                                <span id="overallProgressText">0/0</span>
                            </div>
                        </div>

                        <!-- Next Action -->
                        <div class="mt-1">
                            <small class="text-muted d-block" style="font-size: 0.65rem; line-height: 1.2;">
                                <i class="fas fa-arrow-right me-1" style="font-size: 0.6rem;"></i><strong>Next Action:</strong><br><span id="overallNextAction">-</span>
                            </small>
                        </div>
                        {% endif %}
                    </div>

                    <!-- „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÔºàÂÖ®„Å¶Â±ïÈñãÔºâ -->
                    <div class="mb-1">
                        <label class="form-label fw-bold mb-1" style="font-size: 0.8rem; line-height: 1.2;">„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöé</label>
                        <div class="vertical-progress" id="activeSteps" style="font-size: 0.75rem;">
                            <!-- ÂãïÁöÑ„Å´„Çπ„ÉÜ„ÉÉ„Éó„ÅåÊßãÁØâ„Åï„Çå„Çã -->
                        </div>

                        <!-- Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„ÉóÔºàÂ∏∏„Å´Ë°®Á§∫Ôºâ -->
                        <div id="stepInventory" class="mt-3">
                            <hr>
                            <h6 style="font-size: 0.8rem;"><i class="fas fa-box"></i> Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó</h6>
                            <div class="row" id="availableSteps">
                                <!-- Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó„Çí„Åì„Åì„Å´ÂãïÁöÑ„Å´Ë°®Á§∫ -->
                            </div>
                        </div>

                        <!-- step_orderÈñ¢ÈÄ£„ÅÆÈö†„Åó„Éï„Ç£„Éº„É´„Éâ„ÅØ‰∏çË¶ÅÔºàProjectProgressStep„Çí‰ΩøÁî®Ôºâ -->
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                        <i class="fas fa-save"></i> ÈÄ≤ÊçóÊõ¥Êñ∞
                    </button>
                </form>
            </div>
        </div>
    </div>
    <!-- Âè≥ÂÅ¥: Ê°à‰ª∂„Ç≥„É°„É≥„Éà„Éª„ÉÅ„É£„ÉÉ„Éà -->
    <div class="col-md-4">
        <div class="card shadow-sm" style="height: 100%;">
            <div class="card-header bg-primary text-white py-1">
                <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;">
                    <i class="fas fa-comments me-2"></i>Ê°à‰ª∂„Ç≥„É°„É≥„Éà
                </h6>
            </div>
            <div class="card-body p-2">
                <!-- „Ç≥„É°„É≥„Éà‰∏ÄË¶ß -->
                <div id="comments-container" class="mb-3">
                    <!-- „Ç≥„É°„É≥„Éà„ÅØJavaScript„ÅßÂãïÁöÑ„Å´Ë™≠„ÅøËæº„Åø -->
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2" style="font-size: 0.75rem;">„Ç≥„É°„É≥„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...</p>
                    </div>
                </div>

                <!-- „Ç≥„É°„É≥„ÉàÊäïÁ®ø„Éï„Ç©„Éº„É† -->
                <div class="comment-form">
                    <form id="comment-form" onsubmit="return false;">
                        <div class="mb-2">
                            <textarea
                                id="comment-content"
                                class="form-control form-control-sm"
                                rows="3"
                                placeholder="„Ç≥„É°„É≥„Éà„ÇíÂÖ•Âäõ..."
                                required
                                style="font-size: 0.75rem;"
                            ></textarea>
                        </div>

                        <!-- „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Çª„ÇØ„Ç∑„Éß„É≥ -->
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 0.75rem;">
                                <i class="fas fa-paperclip me-1"></i>„Éï„Ç°„Ç§„É´Ê∑ª‰ªò
                            </label>
                            <input
                                type="file"
                                class="form-control form-control-sm"
                                id="comment-files"
                                multiple
                                accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                                style="font-size: 0.7rem;"
                            >
                            <small class="form-text text-muted" style="font-size: 0.65rem;">
                                ÊúÄÂ§ß10MB/„Éï„Ç°„Ç§„É´
                            </small>
                            <!-- ÈÅ∏Êäû„Åó„Åü„Éï„Ç°„Ç§„É´„ÅÆ„Éó„É¨„Éì„É•„Éº -->
                            <div id="file-preview" class="mt-1"></div>
                        </div>

                        <div class="form-check mb-2">
                            <input
                                type="checkbox"
                                class="form-check-input"
                                id="comment-important"
                            >
                            <label class="form-check-label" for="comment-important" style="font-size: 0.75rem;">
                                <i class="fas fa-exclamation-triangle text-warning"></i> ÈáçË¶Å
                            </label>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm w-100" onclick="postComment()" style="font-size: 0.75rem;">
                            <i class="fas fa-paper-plane me-1"></i>ÊäïÁ®ø
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2„Ç´„É©„É†: ÁµåÁêÜÊÉÖÂ†± & ‰∏ãË´ã„ÅëÊâãÈÖçÁä∂Ê≥Å -->
<div class="row mb-4">
    <!-- Â∑¶: ÁµåÁêÜÊÉÖÂ†± -->
    <div class="col-md-6">
        <div class="card border-info shadow-sm" style="height: 100%;">
            <div class="card-header bg-info text-white py-1">
                <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;"><i class="fas fa-calculator"></i> ÁµåÁêÜÊÉÖÂ†±</h6>
            </div>
            <div class="card-body p-2">
                <!-- Ë¶ñË¶öÁöÑÂà©ÁõäÂàÜÊûê„ÉÅ„É£„Éº„ÉàÔºà„Ç≥„É≥„Éë„ÇØ„ÉàÁâàÔºâ -->
                <div class="text-center mb-2 p-2 bg-light rounded">
                    <div class="d-flex align-items-end justify-content-center" style="height: 120px;">
                        <!-- Â£≤‰∏ä„Éê„Éº -->
                        <div class="text-center">
                            <div style="width: 50px; height: 110px; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 8px; background: linear-gradient(135deg, #198754, #20c997); color: white; margin-right: 2px;">
                                <div style="font-size: 0.6rem; font-weight: bold;">Â£≤‰∏ä</div>
                                <div style="font-size: 0.55rem; line-height: 1.1; margin-top: 2px;">¬•{{ financial_info.revenue|floatformat:0|intcomma }}</div>
                            </div>
                        </div>

                        <!-- Â£≤‰∏äÁ∑èÂà©Áõä„Éê„Éº -->
                        {% widthratio financial_info.gross_profit financial_info.revenue 100 as profit_percentage %}
                        {% widthratio financial_info.cost_of_sales financial_info.revenue 100 as cost_percentage %}
                        <div class="text-center">
                            <div style="width: 50px; height: 110px; position: relative; margin-left: 2px; border-radius: 6px; overflow: hidden; display: flex; flex-direction: column;">
                                <!-- Â£≤‰∏äÂéü‰æ°ÈÉ®ÂàÜÔºà‰∏äÈÉ®Ôºâ -->
                                <div style="width: 100%; height: {{ cost_percentage }}%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 4px; background: linear-gradient(135deg, #dc3545, #fd7e14); color: white; border-radius: 6px 6px 0 0;">
                                    <div style="font-size: 0.55rem; font-weight: bold;">Âéü‰æ°</div>
                                    <div style="font-size: 0.5rem; line-height: 1.1;">¬•{{ financial_info.cost_of_sales|floatformat:0|intcomma }}</div>
                                </div>
                                <!-- Á≤óÂà©ÈÉ®ÂàÜÔºà‰∏ãÈÉ®Ôºâ -->
                                <div style="width: 100%; height: {{ profit_percentage }}%; background: linear-gradient(135deg, #0d6efd, #6f42c1); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 4px; color: white; border-radius: 0 0 6px 6px;">
                                    <div style="font-size: 0.55rem; font-weight: bold;">Á≤óÂà©</div>
                                    <div style="font-size: 0.5rem; line-height: 1.1;">¬•{{ financial_info.gross_profit|floatformat:0|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <small class="d-block text-primary fw-bold mt-1" style="font-size: 0.65rem;">Á≤óÂà©Áéá: {{ financial_info.gross_profit_rate|floatformat:1 }}%</small>
                </div>

                <!-- Êö´ÂÆöÂà©ÁõäÁéáÂàÜÊûê„ÉÜ„Éº„Éñ„É´ -->
                <div class="table-responsive">
                    <table class="table table-sm mb-0" style="font-size: 0.7rem;">
                        <tbody>
                            <tr style="background-color: rgba(25, 135, 84, 0.1);">
                                <td><strong>Â£≤‰∏äÔºàÂèóÊ≥®È°çÔºâ</strong></td>
                                <td class="text-end"><strong>¬•{{ financial_info.revenue|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            <tr class="table-secondary">
                                <td colspan="2"><strong>ÊîØÂá∫ÂÜÖË®≥</strong></td>
                            </tr>
                            <!-- Êó¢Â≠ò‰ΩúÊ•≠Ë≤ªÁî® -->
                            {% if subcontracts %}
                                {% for subcontract in subcontracts %}
                                <tr class="small text-muted">
                                    <td style="padding-left: 15px;">
                                        ‚îî {% if subcontract.worker_type == 'external' %}
                                            {% if subcontract.contractor %}{{ subcontract.contractor.name }}{% else %}Â§ñÊ≥®ÂÖàÊú™Ë®≠ÂÆö{% endif %}
                                        {% else %}
                                            {% if subcontract.internal_worker %}{{ subcontract.internal_worker.name }}ÔºàÁ§æÂÜÖÔºâ{% elif subcontract.internal_worker_name %}{{ subcontract.internal_worker_name }}ÔºàÁ§æÂÜÖÔºâ{% else %}Á§æÂÜÖÊãÖÂΩìËÄÖÊú™Ë®≠ÂÆö{% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-end">¬•{{ subcontract.contract_amount|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            <tr class="table-light">
                                <td style="padding-left: 10px;">ÊùêÊñôË≤ª</td>
                                <td class="text-end">¬•{% widthratio financial_info.material_cost|add:financial_info.material_order_cost 1 1 as total_material %}{{ total_material|floatformat:0|intcomma }}</td>
                            </tr>
                            <!-- Ë≥áÊùêÁô∫Ê≥®Ë≤ªÁî® -->
                            {% if project.material_orders.exists %}
                                {% for material_order in project.material_orders.all %}
                                <tr class="small text-muted">
                                    <td style="padding-left: 15px;">
                                        ‚îî Ë≥áÊùêÁô∫Ê≥®: {% if material_order.contractor %}{{ material_order.contractor.name }}{% else %}Ê•≠ËÄÖÊú™Ë®≠ÂÆö{% endif %}
                                    </td>
                                    <td class="text-end">¬•{{ material_order.total_amount|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            {% if financial_info.additional_cost > 0 %}
                            <tr class="table-light">
                                <td style="padding-left: 10px;">ËøΩÂä†Ë≤ªÁî®</td>
                                <td class="text-end">¬•{{ financial_info.additional_cost|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}
                            <tr style="background-color: rgba(220, 53, 69, 0.1);">
                                <td><strong>Á∑èÊîØÂá∫</strong></td>
                                <td class="text-end"><strong>¬•{{ financial_info.cost_of_sales|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            <tr style="background-color: rgba(13, 110, 253, 0.1);">
                                <td><strong>Á≤óÂà©Áõä</strong></td>
                                <td class="text-end"><strong>¬•{{ financial_info.gross_profit|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>Âà©ÁõäÁéá</strong></td>
                                <td class="text-end">
                                    <strong class="{% if financial_info.gross_profit_rate >= 30 %}text-success{% elif financial_info.gross_profit_rate >= 15 %}text-warning{% else %}text-danger{% endif %}">{{ financial_info.gross_profit_rate|floatformat:1 }}%</strong>
                                    <div class="progress mt-1" style="height: 6px;">
                                        <div class="progress-bar {% if financial_info.gross_profit_rate >= 30 %}bg-success{% elif financial_info.gross_profit_rate >= 15 %}bg-warning{% else %}bg-danger{% endif %}"
                                             role="progressbar" style="width: {{ financial_info.gross_profit_rate|floatformat:0 }}%;" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Âè≥: ‰∏ãË´ã„ÅëÊâãÈÖçÁä∂Ê≥Å & Ë≥áÊùêÁô∫Ê≥®Áä∂Ê≥Å -->
    <div class="col-md-6">
        <!-- ‰∏ãË´ã„ÅëÊâãÈÖçÁä∂Ê≥Å -->
        <div class="card border-primary shadow-sm mb-2">
            <div class="card-header bg-primary text-white py-1">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;">
                        <i class="fas fa-file-contract"></i> ‰∏ãË´ã„ÅëÊâãÈÖçÁä∂Ê≥Å
                        <span class="badge bg-light text-dark ms-2">{{ subcontracts|length }}‰ª∂</span>
                    </h6>
                    <a href="{% url 'subcontract_management:project_subcontract_list' project.pk %}" class="btn btn-sm btn-light" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-file-contract"></i> Áô∫Ê≥®ÁÆ°ÁêÜ
                    </a>
                </div>
            </div>
            <div class="card-body p-2">
                {% if subcontracts %}
                    <!-- ÁôªÈå≤Ê∏à„ÅøÁô∫Ê≥®ÂÖà„É™„Çπ„ÉàÔºà„Ç≥„É≥„Éë„ÇØ„ÉàÁâàÔºâ -->
                    <div>
                        {% for subcontract in subcontracts %}
                        <div class="mb-2 p-2 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.75rem; font-weight: bold;">
                                        {{ subcontract.contractor.name }}
                                        <span class="badge bg-light text-dark border ms-1" style="font-size: 0.6rem;">
                                            {% if subcontract.step == 'attendance' %}Á´ã„Å°‰ºö„ÅÑ
                                            {% elif subcontract.step == 'survey' %}ÁèæË™ø
                                            {% elif subcontract.step == 'construction_start' %}ÁùÄÂ∑•
                                            {% elif subcontract.step == 'completion' %}ÂÆåÂ∑•
                                            {% elif subcontract.step == 'estimate' %}Ë¶ãÁ©çÊõ∏Áô∫Ë°å
                                            {% elif subcontract.step == 'contract' %}Â•ëÁ¥Ñ
                                            {% elif subcontract.step == 'invoice' %}Ë´ãÊ±ÇÊõ∏Áô∫Ë°å
                                            {% else %}{{ subcontract.get_step_display }}{% endif %}
                                        </span>
                                    </div>
                                </div>
                                <span class="badge bg-{{ subcontract.get_payment_status_color }}" style="font-size: 0.6rem;">
                                    {{ subcontract.get_payment_status_display }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <div style="font-size: 0.65rem;">
                                    <span class="text-muted">Â•ëÁ¥Ñ:</span> ¬•{{ subcontract.contract_amount|floatformat:0|intcomma }}<br>
                                    <span class="text-muted">Ë´ãÊ±Ç:</span> ¬•{{ subcontract.billed_amount|floatformat:0|intcomma }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-2">
                        <i class="fas fa-file-contract fa-2x text-muted mb-2"></i>
                        <p style="font-size: 0.7rem; color: #6c757d;" class="mb-0">Áô∫Ê≥®ÂÖàÊú™ÁôªÈå≤</p>
                    </div>
                {% endif %}
                <!-- ‰ΩúÊ•≠ËÄÖËøΩÂä†„Éú„Çø„É≥ -->
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-primary w-100" style="font-size: 0.65rem;" onclick="openSubcontractModal()">
                        <i class="fas fa-user-plus"></i> ‰ΩúÊ•≠ËÄÖ„ÇíËøΩÂä†
                    </button>
                </div>
            </div>
        </div>

        <!-- Ë≥áÊùêÁô∫Ê≥®Áä∂Ê≥Å -->
        <div class="card border-warning shadow-sm">
            <div class="card-header bg-warning text-white py-1">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;">
                        <i class="fas fa-box-open"></i> Ë≥áÊùêÁô∫Ê≥®Áä∂Ê≥Å
                        <span class="badge bg-light text-dark ms-2">{{ project.material_orders.count }}‰ª∂</span>
                    </h6>
                    <a href="{% url 'order_management:material_order_list' project.id %}" class="btn btn-sm btn-light" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-list"></i> Ë≥áÊùêÁÆ°ÁêÜ
                    </a>
                </div>
            </div>
            <div class="card-body p-2">
                {% if project.material_orders.exists %}
                    <!-- ÁôªÈå≤Ê∏à„ÅøË≥áÊùêÁô∫Ê≥®„É™„Çπ„ÉàÔºà„Ç≥„É≥„Éë„ÇØ„ÉàÁâàÔºâ -->
                    <div>
                        {% for material_order in project.material_orders.all %}
                        <div class="mb-2 p-2 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.75rem; font-weight: bold;">
                                        {% if material_order.contractor %}
                                            {{ material_order.contractor.name }}
                                        {% else %}
                                            Áô∫Ê≥®ÂÖàÊú™Ë®≠ÂÆö
                                        {% endif %}
                                    </div>
                                    {% if material_order.items.exists %}
                                    <div style="font-size: 0.65rem; color: #6c757d;">
                                        {{ material_order.items.first.material_name|truncatechars:25 }}
                                        {% if material_order.items.count > 1 %}
                                            ‰ªñ{{ material_order.items.count|add:"-1" }}‰ª∂
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <div style="font-size: 0.65rem;">
                                    <span class="text-muted">ÈáëÈ°ç:</span> ¬•{{ material_order.total_amount|floatformat:0|intcomma }}<br>
                                    <span class="text-muted">Áô∫Ê≥®Êó•:</span> {{ material_order.order_date|date:"Y/m/d" }}
                                </div>
                                <span class="badge
                                    {% if material_order.status == 'completed' %}bg-success
                                    {% elif material_order.status == 'delivered' %}bg-info
                                    {% elif material_order.status == 'ordered' %}bg-warning
                                    {% else %}bg-secondary
                                    {% endif %}"
                                    style="font-size: 0.6rem;">
                                    {{ material_order.get_status_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-2">
                        <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                        <p style="font-size: 0.7rem; color: #6c757d;" class="mb-0">Ë≥áÊùêÁô∫Ê≥®Êú™ÁôªÈå≤</p>
                    </div>
                {% endif %}
                <!-- Ë≥áÊùêÁô∫Ê≥®„ÇíËøΩÂä†„Éú„Çø„É≥ -->
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-warning w-100" style="font-size: 0.65rem;" onclick="openMaterialOrderModal()">
                        <i class="fas fa-plus"></i> Ë≥áÊùêÁô∫Ê≥®„ÇíËøΩÂä†
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ÁèæÂú∞Ë™øÊüª -->
<!-- DEPRECATED: This section is now handled by ProjectProgressStep in activeSteps area -->
<!-- Hidden for SSOT Architecture migration (Phase 4) -->
<div class="row mb-4" id="surveyContentArea" style="display:none;">
    <div class="col-lg-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>ÁèæÂú∞Ë™øÊüª
                        {% if surveys %}
                            <span class="badge bg-white text-primary ms-2">{{ surveys|length }}‰ª∂</span>
                        {% endif %}
                    </h5>
                    <div class="btn-group">
                        {% comment %}
                        <a href="#" class="btn btn-sm btn-light">
                            <i class="fas fa-list"></i> Ë™øÊüª‰∏ÄË¶ß
                        </a>
                        <a href="#" class="btn btn-sm btn-light">
                            <i class="fas fa-plus"></i> Ë™øÊüªËøΩÂä†
                        </a>
                        {% endcomment %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if surveys %}
                    <!-- ÊúÄÊñ∞„ÅÆË™øÊüªÊÉÖÂ†± -->
                    {% with latest_survey=surveys.first %}
                    {% if latest_survey %}
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="alert {% if latest_survey.status == 'completed' %}alert-success{% elif latest_survey.status == 'in_progress' %}alert-warning{% else %}alert-info{% endif %} mb-0">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-1">
                                            {% if latest_survey.status == 'completed' %}
                                                <i class="fas fa-check-circle me-1"></i>ÊúÄÊñ∞Ë™øÊüªÂÆå‰∫Ü
                                            {% elif latest_survey.status == 'in_progress' %}
                                                <i class="fas fa-spinner fa-spin me-1"></i>Ë™øÊüªÂÆüÊñΩ‰∏≠
                                            {% else %}
                                                <i class="fas fa-calendar-alt me-1"></i>Ê¨°ÂõûË™øÊüª‰∫àÂÆö
                                            {% endif %}
                                        </h6>
                                        <div class="small">
                                            <strong>Êó•ÊôÇ:</strong> {{ latest_survey.scheduled_date|date:"YÂπ¥mÊúàdÊó•" }} {{ latest_survey.scheduled_start_time|time:"H:i" }}<br>
                                            <strong>ÊãÖÂΩì:</strong> {{ latest_survey.surveyor.name }} ({{ latest_survey.surveyor.employee_id }})
                                            {% if latest_survey.status == 'completed' and latest_survey.rooms.count > 0 %}
                                            <br><strong>Ë™øÊüªÁµêÊûú:</strong> {{ latest_survey.rooms.count }}ÈÉ®Â±ã / {{ latest_survey.damages.count }}‰ª∂„ÅÆÊêçÂÇ∑Ë®òÈå≤ / {{ latest_survey.photos.count }}Êûö„ÅÆÂÜôÁúü
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% if latest_survey.status == 'completed' %}
{#                                             <a href="#" class="btn btn-sm btn-success">
                                                <i class="fas fa-file-pdf"></i> „É¨„Éù„Éº„Éà
                                            </a>
                                        {% elif latest_survey.status == 'in_progress' %}
{#                                             <a href="#" class="btn btn-sm btn-warning">
                                                <i class="fas fa-play"></i> Á∂ö„Åë„Çã
                                            </a>
                                        {% else %}
{#                                             <a href="#" class="btn btn-sm btn-primary">
                                                <i class="fas fa-play"></i> ÈñãÂßã
                                            </a>
                                        {% endif %}
{#                                         <a href="#" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-eye"></i> Ë©≥Á¥∞
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}

                    <!-- Ë™øÊüªÂ±•Ê≠¥ -->
                    {% if surveys|length > 1 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th width="20%">ÂÆüÊñΩÊó•</th>
                                    <th width="20%">ÊãÖÂΩìËÄÖ</th>
                                    <th width="15%">„Çπ„ÉÜ„Éº„Çø„Çπ</th>
                                    <th width="25%">Ë™øÊüªÂÜÖÂÆπ</th>
                                    <th width="20%" class="text-end">Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for survey in surveys %}
                                <tr>
                                    <td>{{ survey.scheduled_date|date:"m/d" }} {{ survey.scheduled_start_time|time:"H:i" }}</td>
                                    <td>{{ survey.surveyor.name }} ({{ survey.surveyor.employee_id }})</td>
                                    <td>
                                        <span class="badge {% if survey.status == 'completed' %}bg-success{% elif survey.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ survey.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if survey.status == 'completed' %}
                                            <small>{{ survey.rooms.count }}ÈÉ®Â±ã / {{ survey.damages.count }}ÊêçÂÇ∑ / {{ survey.photos.count }}ÂÜôÁúü</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
{#                                         <a href="#" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if survey.status == 'completed' %}
{#                                             <a href="#" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-file-pdf"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                {% else %}
                    <!-- Ë™øÊüªÊú™ÂÆüÊñΩ„ÅÆÂ†¥Âêà -->
                    <div class="alert alert-warning">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <div class="col-md-8">
                                <h6 class="mb-1">ÁèæÂú∞Ë™øÊüª„ÅåÊú™ÂÆüÊñΩ„Åß„Åô</h6>
                                <small>„Åì„ÅÆÊ°à‰ª∂„ÅÆÁèæÂú∞Ë™øÊüª„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇÊ≠£Á¢∫„Å™Ë¶ãÁ©ç„ÇÇ„Çä„Å®ÊñΩÂ∑•Ë®àÁîª„ÅÆ„Åü„ÇÅ„Å´ÂøÖË¶Å„Åß„Åô„ÄÇ</small>
                            </div>
                            <div class="col-md-3 text-end">
                                {% comment %}
                                <a href="#" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>Ë™øÊüª„Çí„Çπ„Ç±„Ç∏„É•„Éº„É´
                                </a>
                                {% endcomment %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- ÁèæË™øÊãÖÂΩìËÄÖ„ÅÆË°®Á§∫ -->
                {% if project.survey_assignees %}
                <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted d-block mb-1"><i class="fas fa-users me-1"></i>ÁèæË™øÊãÖÂΩìËÄÖ:</small>
                    {% for assignee in project.survey_assignees %}
                    <span class="badge bg-primary me-1">{{ assignee }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- ‰ΩúÊ•≠ËÄÖËøΩÂä†„Éú„Çø„É≥ -->
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-info w-100" onclick="openSubcontractModal('survey')">
                        <i class="fas fa-user-plus"></i> ‰ΩúÊ•≠ËÄÖ„ÇíËøΩÂä†ÔºàÁèæË™øÔºâ
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>





<style>
/* Ë©≥Á¥∞ÊÉÖÂ†±„Çø„Éñ„ÅÆ„Çπ„Çø„Ç§„É´ */
#projectDetailTabs .nav-link {
    color: #6c757d;
    font-weight: 500;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    transition: all 0.15s ease;
}

/* „Çø„Éñ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÅÆÂàá„ÇäÊõø„Åà„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÇíÈ´òÈÄüÂåñ */
.tab-content > .tab-pane {
    transition: opacity 0.1s ease-in-out;
}

.tab-content > .tab-pane:not(.active) {
    opacity: 0;
}

.tab-content > .tab-pane.active {
    opacity: 1;
}

#projectDetailTabs .nav-link:hover {
    color: #0d6efd;
    background: #f8f9fa;
    border-bottom-color: #dee2e6;
}

#projectDetailTabs .nav-link.active {
    color: #0d6efd;
    background: white;
    border-bottom-color: #0d6efd;
    font-weight: 600;
}

.info-group {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 0.5rem;
    height: 100%;
    position: relative;
}

.info-group h6 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
}

.info-group dl {
    margin-bottom: 0;
}

.info-group dt {
    font-size: 0.7rem;
    padding: 0.25rem 0 0.25rem 0.5rem;
}

.info-group dd {
    font-size: 0.7rem;
    padding: 0.25rem 0;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* Ë°®Á§∫Âàá„ÇäÊõø„Åà„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
.btn-group .btn-light.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.btn-group .btn-light {
    transition: all 0.3s ease;
}

.btn-group .btn-light:hover:not(.active) {
    background-color: #e9ecef;
}

/* ÂÖ®‰ΩìË°®Á§∫„É¢„Éº„Éâ„Åß„ÅÆ„Çø„Éñ„Éë„Éç„É´„ÅÆ„Çπ„Çø„Ç§„É´ */
#projectDetailTabsContent .tab-pane {
    transition: all 0.3s ease;
}

/* ÂÖ®‰ΩìË°®Á§∫„É¢„Éº„Éâ„Åß„Çø„Éñ„Éë„Éç„É´Èñì„Å´„Éû„Éº„Ç∏„É≥„ÇíËøΩÂä† */
#projectDetailTabsContent.full-view-mode .tab-pane {
    margin-bottom: 1rem;
    padding: 0.5rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

#projectDetailTabsContent.full-view-mode .tab-pane:last-child {
    margin-bottom: 0;
}

/* ÂÖ®‰ΩìË°®Á§∫„É¢„Éº„Éâ„Åß„ÅÆ„Çª„ÇØ„Ç∑„Éß„É≥„Éò„ÉÉ„ÉÄ„Éº */
#projectDetailTabsContent.full-view-mode .tab-pane::before {
    content: attr(data-section-title);
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: #0d6efd;
    margin-bottom: 0.5rem;
    padding-bottom: 0.25rem;
    border-bottom: 2px solid #0d6efd;
}
</style>

<!-- ÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ê°à‰ª∂ÂâäÈô§„ÅÆÁ¢∫Ë™ç</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>‰ª•‰∏ã„ÅÆÊ°à‰ª∂„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü</p>
                <p class="text-danger">
                    <strong>{{ project.management_no }} - {{ project.site_name }}</strong>
                </p>
                <p class="text-muted">„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ</p>
            </div>
            <div class="modal-footer">
                <form method="post" action="{% url 'order_management:project_delete' project.pk %}">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                    <button type="submit" class="btn btn-danger">ÂâäÈô§„Åô„Çã</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Ê±éÁî®„Ç®„É©„Éº„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="genericErrorModal" tabindex="-1" aria-labelledby="genericErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="genericErrorModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i><span id="genericErrorModalTitle">„Ç®„É©„Éº</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="genericErrorModalMessage">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>
</div>

<!-- Ê±éÁî®Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="genericConfirmModal" tabindex="-1" aria-labelledby="genericConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-white" id="genericConfirmModalHeader">
                <h5 class="modal-title" id="genericConfirmModalLabel">
                    <i class="me-2" id="genericConfirmModalIcon"></i><span id="genericConfirmModalTitle">Á¢∫Ë™ç</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="genericConfirmModalMessage">„Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" id="genericConfirmModalOkBtn">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- „Çπ„ÉÜ„ÉÉ„ÉóÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="stepDeleteModal" tabindex="-1" aria-labelledby="stepDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="stepDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>„Çπ„ÉÜ„ÉÉ„ÉóÂâäÈô§„ÅÆÁ¢∫Ë™ç
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong id="stepDeleteName"></strong> „Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    ÂâäÈô§Âæå„ÅØ„ÄåÁ∑®ÈõÜÂÆå‰∫Ü„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>„Ç≠„É£„É≥„Çª„É´
                </button>
                <button type="button" class="btn btn-danger" id="confirmStepDelete">
                    <i class="fas fa-trash-alt me-2"></i>ÂâäÈô§„Åô„Çã
                </button>
            </div>
        </div>
    </div>
</div>

<!-- „Çπ„ÉÜ„ÉÉ„ÉóÂâäÈô§ÂÆå‰∫ÜÈÄöÁü•„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="stepDeleteSuccessModal" tabindex="-1" aria-labelledby="stepDeleteSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="stepDeleteSuccessModalLabel">
                    <i class="fas fa-check-circle me-2"></i>ÂâäÈô§ÂÆå‰∫Ü
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0"><strong id="stepDeleteSuccessName"></strong> „Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ</p>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    „ÄåÁ∑®ÈõÜÂÆå‰∫Ü„Äç„Éú„Çø„É≥„ÇíÊäº„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>OK
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„ÅÆÂàùÊúüÂåñ
var editMode = true; // Â∏∏„Å´Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíON
var sortable = null;
var projectStatus = '{{ project.project_status }}'; // Ê°à‰ª∂„Çπ„ÉÜ„Éº„Çø„Çπ

// „Çπ„ÉÜ„ÉÉ„ÉóÁ∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂàá„ÇäÊõø„ÅàÔºà„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞Ôºâ
function toggleEditMode() {
    editMode = !editMode;
    const btn = $('#editStepsBtn');

    if (editMode) {
        // Á∑®ÈõÜ„É¢„Éº„ÉâON
        btn.html('<i class="fas fa-check"></i> Á∑®ÈõÜÂÆå‰∫Ü');
        btn.removeClass('btn-outline-primary').addClass('btn-success');
        $('.remove-step-btn').show();
        $('.drag-handle').show();
        $('#stepInventory').show();
        if (typeof loadAvailableSteps === 'function') {
            loadAvailableSteps();
        }
    } else {
        // Á∑®ÈõÜ„É¢„Éº„ÉâOFF - Â§âÊõ¥„Çí‰øùÂ≠ò

        // „Çπ„ÉÜ„ÉÉ„ÉóÈ†ÜÂ∫è„Çí‰øùÂ≠ò
        if (typeof saveStepOrder === 'function') {
            saveStepOrder();
        }

        // „Åô„Åπ„Å¶„ÅÆÂãïÁöÑ„Éï„Ç£„Éº„É´„Éâ„ÇíÂèéÈõÜ
        const dynamicFields = {};
        $('.progress-step[data-step]').each(function() {
            const stepKey = $(this).data('step');
            const stepElement = $(this);

            // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÊé¢„Åô
            stepElement.find('input, select, textarea').each(function() {
                const fieldElement = $(this);
                const fieldName = fieldElement.attr('name');

                // „Éï„Ç£„Éº„É´„ÉâÂêç„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (!fieldName) return;

                let fieldValue;

                // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å®„É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆÂ†¥Âêà
                if (fieldElement.is(':checkbox')) {
                    fieldValue = fieldElement.is(':checked') ? 'on' : '';
                } else if (fieldElement.is(':radio')) {
                    // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅØÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
                    if (!fieldElement.is(':checked')) return;
                    fieldValue = fieldElement.val();
                } else {
                    fieldValue = fieldElement.val();
                }

                // Âü∫Êú¨„Éï„Ç£„Éº„É´„ÉâÔºàestimate, contract, work_start, work_end, invoiceÔºâ
                const isBasicField = ['estimate_issued_date', 'estimate_not_required', 'estimate_notes',
                                     'contractor_estimate_amount', 'contract_date',
                                     'work_start_date', 'work_start_completed', 'work_end_date',
                                     'work_end_completed', 'invoice_issued'].includes(fieldName);

                // „Åô„Åπ„Å¶„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÁ©∫„Åß„ÇÇPOSTÔºàÂâäÈô§„Éª„ÇØ„É™„Ç¢Êìç‰Ωú„ÇíÂèØËÉΩ„Å´„Åô„Çã„Åü„ÇÅÔºâ
                // dynamic_field_ „Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÅØÂü∫Êú¨„Éï„Ç£„Éº„É´„Éâ‰ª•Â§ñ„Å´ËøΩÂä†
                const finalFieldName = isBasicField ? fieldName :
                                      (fieldName.startsWith('dynamic_field_') ? fieldName : `dynamic_field_${fieldName}`);
                dynamicFields[finalFieldName] = fieldValue;

                // „Éá„Éê„ÉÉ„Ç∞: estimateÈñ¢ÈÄ£„Éï„Ç£„Éº„É´„Éâ„Çí„É≠„Ç∞Âá∫Âäõ
                if (fieldName.includes('estimate')) {
                    console.log(`DEBUG: ${fieldName} = "${fieldValue}" (type: ${typeof fieldValue}, is checkbox: ${fieldElement.is(':checkbox')}, checked: ${fieldElement.is(':checked')})`);
                }
            });
        });

        console.log('Saving dynamic fields:', dynamicFields);
        console.log('DEBUG: estimate_not_required in POST?', 'estimate_not_required' in dynamicFields);
        console.log('DEBUG: estimate_not_required value:', dynamicFields.estimate_not_required);

        // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠òÔºàAJAX - Áµ±‰∏Ä„Ç®„É≥„Éâ„Éù„Ç§„É≥„ÉàÔºâ
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
            data: $.extend({
                csrfmiddlewaretoken: '{{ csrf_token }}',
                ajax_save: 'true'  // AJAX‰øùÂ≠ò„Éï„É©„Ç∞
            }, dynamicFields),
            success: function(response) {
                console.log('‰øùÂ≠òÊàêÂäü:', response);

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                if (response && response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success(response.message || 'Â§âÊõ¥„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                    }
                    // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÊúÄÊñ∞„ÅÆÁä∂ÊÖã„ÇíË°®Á§∫
                    setTimeout(function() {
                        location.reload();
                    }, 500);  // 500msÂæÖ„Å£„Å¶„Åã„Çâ„É™„É≠„Éº„ÉâÔºàtoastrË°®Á§∫„ÅÆ„Åü„ÇÅÔºâ
                } else {
                    console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                let errorMessage = '‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                } else if (xhr.status === 403) {
                    errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status === 404) {
                    errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status >= 500) {
                    errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                }
            }
        });

        // UI„ÇíÁ∑®ÈõÜ„É¢„Éº„ÉâOFF„Å´
        btn.html('<i class="fas fa-edit"></i> „Çπ„ÉÜ„ÉÉ„ÉóÁ∑®ÈõÜ');
        btn.removeClass('btn-success').addClass('btn-outline-primary');
        $('.remove-step-btn').hide();
        $('.drag-handle').hide();
        $('#stepInventory').hide();
    }

    // Sortable„ÅÆÊúâÂäπ/ÁÑ°Âäπ„ÇíÂàá„ÇäÊõø„Åà
    if (sortable) {
        sortable.option("disabled", !editMode);
    }
}

// Ê±éÁî®„Ç®„É©„Éº„É¢„Éº„ÉÄ„É´Ë°®Á§∫Èñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„ÉóÔºâ
function showErrorModal(message, title = '„Ç®„É©„Éº') {
    $('#genericErrorModalTitle').text(title);
    $('#genericErrorModalMessage').text(message);
    const modal = new bootstrap.Modal(document.getElementById('genericErrorModal'));
    modal.show();
}

// Ê±éÁî®Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´Ë°®Á§∫Èñ¢Êï∞Ôºà„Ç∞„É≠„Éº„Éê„É´„Çπ„Ç≥„Éº„ÉóÔºâ
// ‰ΩøÁî®‰æã: showConfirmModal('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', function() { /* OK„ÅÆÂá¶ÁêÜ */ });
function showConfirmModal(message, onConfirm, title = 'Á¢∫Ë™ç') {
    $('#genericConfirmModalTitle').text(title);
    $('#genericConfirmModalMessage').text(message);

    // „Çø„Ç§„Éà„É´„Å´„ÄåÂâäÈô§„Äç„ÅåÂê´„Åæ„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËµ§ÔºàdangerÔºâ„Çπ„Çø„Ç§„É´„ÇíÈÅ©Áî®
    const isDanger = title.includes('ÂâäÈô§');
    const header = $('#genericConfirmModalHeader');
    const icon = $('#genericConfirmModalIcon');
    const okBtn = $('#genericConfirmModalOkBtn');

    if (isDanger) {
        header.removeClass('bg-primary').addClass('bg-danger');
        icon.removeClass('fa-question-circle').addClass('fas fa-exclamation-triangle');
        okBtn.removeClass('btn-primary').addClass('btn btn-danger');
    } else {
        header.removeClass('bg-danger').addClass('bg-primary');
        icon.removeClass('fa-exclamation-triangle').addClass('fas fa-question-circle');
        okBtn.removeClass('btn-danger').addClass('btn btn-primary');
    }

    const modal = new bootstrap.Modal(document.getElementById('genericConfirmModal'));

    // Êó¢Â≠ò„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÂâäÈô§
    okBtn.off('click');

    // Êñ∞„Åó„ÅÑ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíËøΩÂä†
    okBtn.on('click', function() {
        modal.hide();
        if (typeof onConfirm === 'function') {
            onConfirm();
        }
    });

    modal.show();
}

$(document).ready(function() {
    // Ê°à‰ª∂Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆÁä∂ÊÖã„ÇíÂæ©ÂÖÉ
    if (localStorage.getItem('detailInfoOpen') === 'true') {
        toggleDetailInfo();
        localStorage.removeItem('detailInfoOpen');
    }

    // „Çπ„ÉÜ„ÉÉ„ÉóÁ∑®ÈõÜ„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆöÔºàÂ∏∏„Å´Á∑®ÈõÜ„É¢„Éº„Éâ„Å™„ÅÆ„Åß‰∏çË¶ÅÔºâ
    // $('#editStepsBtn').on('click', function(e) {
    //     e.preventDefault();
    //     e.stopPropagation();
    //     toggleEditMode();
    // });

    // ‰æùÂ≠ò„Éï„Ç£„Éº„É´„Éâ„ÅÆË°®Á§∫/ÈùûË°®Á§∫Âàá„ÇäÊõø„Åà
    $(document).on('change', 'input[type="radio"]', function() {
        const fieldName = $(this).attr('name');
        const selectedValue = $(this).val();

        // „Åì„ÅÆÂ§âÊõ¥„Å´„Çà„Å£„Å¶ÂΩ±Èüø„ÇíÂèó„Åë„Çã‰æùÂ≠ò„Éï„Ç£„Éº„É´„Éâ„ÇíÊé¢„Åô
        $(`[data-dependency-field="${fieldName}"]`).each(function() {
            const requiredValue = $(this).data('dependency-value');
            if (selectedValue === requiredValue) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // ÂàùÊúüÁä∂ÊÖã„ÅßÊñôÈáë‰ΩìÁ≥ª„ÇíË®≠ÂÆöÔºà„Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´ÂÆüË°åÔºâ
    setTimeout(function() {
        console.log('üîÑ Initializing pricing type on page load');
        console.log('üîç All pricing elements exist at start:', {
            hourly: $('#hourlyPricingFields').length,
            project: $('#projectPricingFields').length,
            hourlyCard: $('#hourlyCard').length,
            projectCard: $('#projectCard').length
        });

        // ÂàùÊúüÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã‰ΩúÊ•≠ËÄÖ„Çø„Ç§„Éó„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        var selectedWorkerType = $('input[name="worker_type"]:checked').val();
        console.log('üîç Selected worker type:', selectedWorkerType);

        // Á§æÂÜÖ„É™„ÇΩ„Éº„Çπ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅÊñôÈáë‰ΩìÁ≥ª„ÇíÂàùÊúüÂåñ
        if (selectedWorkerType === 'internal') {
            $('#internalWorkerSection').show();
            console.log('üîç Internal section shown');

            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂàùÊúüÂåñÔºàDOMÊõ¥Êñ∞ÂæåÔºâ
            setTimeout(function() {
                initializePricingType();

                var checkedRadio = $('input[name="internal_pricing_type"]:checked');
                console.log('üîç Checked pricing radio found:', checkedRadio.length);
                if (checkedRadio.length > 0) {
                    checkedRadio.trigger('change');
                }
            }, 50);
        }
    }, 100);

    // „É¢„Éº„ÉÄ„É´„ÅÆARIAÂ±ûÊÄßÁÆ°ÁêÜ
    $('#staffManagementModal, #staffModal').on('show.bs.modal', function() {
        console.log('üìã Modal showing - removing aria-hidden');
        $(this).removeAttr('aria-hidden');
    }).on('hide.bs.modal', function() {
        console.log('üìã Modal hiding - adding aria-hidden');
        $(this).attr('aria-hidden', 'true');
    }).on('shown.bs.modal', function() {
        console.log('üìã Modal shown - ensuring proper focus management');
        // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÊúÄÂàù„ÅÆ„Éï„Ç©„Éº„Ç´„ÇπÂèØËÉΩ„Å™Ë¶ÅÁ¥†„Å´„Éï„Ç©„Éº„Ç´„Çπ
        var firstFocusableElement = $(this).find('input, select, textarea, button').filter(':visible').first();
        if (firstFocusableElement.length) {
            setTimeout(function() {
                firstFocusableElement.focus();
            }, 100);
        }
    });

    // ‰ΩúÊ•≠ËÄÖ„Çø„Ç§„Éó„ÅÆÂàá„ÇäÊõø„Åà
    $('input[name="worker_type"]').on('change', function() {
        if ($(this).val() === 'external') {
            $('#externalWorkerSection').show();
            $('#internalWorkerSection').hide();
            $('#submitButtonText').text('Áô∫Ê≥®ÂÖàËøΩÂä†');

            // Â§ñÊ≥®ÂÖà„Éï„Ç£„Éº„É´„Éâ„ÇíÂøÖÈ†à„Å´
            $('#contractorSelect').attr('required', true);
            $('input[name="client_name"]').attr('required', false);

            // Á§æÂÜÖ„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûÂøÖÈ†à„Å´
            $('input[name="internal_worker_name"]').attr('required', false);
        } else {
            $('#externalWorkerSection').hide();
            $('#internalWorkerSection').show();
            $('#submitButtonText').text('Á§æÂÜÖ„É™„ÇΩ„Éº„ÇπËøΩÂä†');

            // Á§æÂÜÖ„Éï„Ç£„Éº„É´„Éâ„ÇíÂøÖÈ†à„Å´
            $('input[name="internal_worker_name"]').attr('required', true);

            // ÊñôÈáë‰ΩìÁ≥ª„ÅÆÂàùÊúüÂåñ„ÇíÂÆüË°å
            setTimeout(function() {
                console.log('üîÑ Initializing pricing type after internal switch');
                console.log('üîç Internal section visible:', $('#internalWorkerSection').is(':visible'));
                console.log('üîç Pricing elements exist:', $('#hourlyPricingFields').length, $('#projectPricingFields').length);

                initializePricingType();
                // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÊñôÈáë‰ΩìÁ≥ª„ÇíÂº∑Âà∂ÁöÑ„Å´ÈÅ©Áî®
                var checkedRadio = $('input[name="internal_pricing_type"]:checked');
                console.log('üîç Checked radio found:', checkedRadio.length);
                if (checkedRadio.length > 0) {
                    checkedRadio.trigger('change');
                }
            }, 200);

            // Â§ñÊ≥®ÂÖà„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûÂøÖÈ†à„Å´
            $('#contractorSelect').attr('required', false);
            $('input[name="client_name"]').attr('required', false);
        }
        updateCostBreakdown();
        updateProfitPreview();
    });

    // Á§æÂÜÖÊãÖÂΩìËÄÖÈÅ∏ÊäûÊñπÊ≥ï„ÅÆÂàá„ÇäÊõø„Åà
    $('input[name="internal_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existingInternalDiv').show();
            $('#newInternalDiv').hide();
            $('#internalSelect').attr('required', true);
            $('input[name="internal_worker_name"]').attr('required', false);
        } else {
            $('#existingInternalDiv').hide();
            $('#newInternalDiv').show();
            $('#internalSelect').attr('required', false);
            $('input[name="internal_worker_name"]').attr('required', true);
        }
    });

    // Êó¢Â≠òÁ§æÂÜÖÊãÖÂΩìËÄÖÈÅ∏ÊäûÊôÇ„ÅÆÊÉÖÂ†±Ëá™ÂãïÂÖ•Âäõ
    $('#internalSelect').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var department = selectedOption.data('department') || '';
        var hourlyRate = selectedOption.data('hourly-rate') || '';

        $('#internalDepartment').val(department);
        $('#internalHourlyRate').val(hourlyRate);

        // Â∑•Êï∞„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çå„Å∞Ëá™ÂãïË®àÁÆó
        calculateInternalCost();
    });

    // Ê•≠ËÄÖÈÅ∏ÊäûÊñπÊ≥ï„ÅÆÂàá„ÇäÊõø„Åà
    $('input[name="contractor_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existingContractorDiv').show();
            $('#newContractorDiv').hide();
            $('#contractorSelect').attr('required', true);
            $('input[name="client_name"]').attr('required', false);
        } else {
            $('#existingContractorDiv').hide();
            $('#newContractorDiv').show();
            $('#contractorSelect').attr('required', false);
            $('input[name="client_name"]').attr('required', true);
        }
    });

    // Êó¢Â≠òÊ•≠ËÄÖÈÅ∏ÊäûÊôÇ„ÅÆ‰ΩèÊâÄËá™ÂãïÂÖ•Âäõ
    $('#contractorSelect').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var address = selectedOption.data('address') || '';
        $('#contractorAddress').val(address);
    });

    // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆÊñôÈáë‰ΩìÁ≥ª„ÅÆÂàá„ÇäÊõø„ÅàÔºà‰øÆÊ≠£ÁâàÔºâ
    $(document).on('change', 'input[name="modal_internal_pricing_type"]', function() {
        var pricingType = $(this).val();
        console.log('========================');
        console.log('üî• Modal Pricing type changed to:', pricingType);
        console.log('üîç Event target element:', $(this)[0]);
        console.log('üîç Parent modal visible:', $(this).closest('#addImplementationModal').is(':visible'));

        // „É¢„Éº„ÉÄ„É´Áî®Ë¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
        var hourlyFields = $('#modalHourlyPricingFields');
        var projectFields = $('#modalProjectPricingFields');

        console.log('üéØ Modal Elements found:');
        console.log('  - modalHourlyPricingFields:', hourlyFields.length, 'visible:', hourlyFields.is(':visible'));
        console.log('  - modalProjectPricingFields:', projectFields.length, 'visible:', projectFields.is(':visible'));

        console.log('üîß Before changes:');
        console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
        console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));

        if (pricingType === 'hourly') {
            console.log('üîß Setting modal to hourly mode');
            $('#modalHourlyPricingFields').show();
            $('#modalProjectPricingFields').hide();
            console.log('üîß After hourly changes:');
            console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
            console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));
        } else {
            console.log('üîß Setting modal to project mode');
            $('#modalHourlyPricingFields').hide();
            $('#modalProjectPricingFields').show();
            console.log('üîß After project changes:');
            console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
            console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));
        }
        console.log('========================');
    });

    // „Éö„Éº„Ç∏ÂÜÖ„Éï„Ç©„Éº„É†„ÅÆÊñôÈáë‰ΩìÁ≥ª„ÅÆÂàá„ÇäÊõø„ÅàÔºàË©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞‰ªò„ÅçÔºâ
    $(document).on('change', 'input[name="internal_pricing_type"]', function() {
        var pricingType = $(this).val();
        console.log('========================');
        console.log('üî• Pricing type changed to:', pricingType);
        console.log('üîç Event target element:', $(this)[0]);
        console.log('üîç Parent container visible:', $(this).closest('#internalWorkerSection').is(':visible'));

        // Ë¶ÅÁ¥†„ÅÆÂ≠òÂú®Á¢∫Ë™ç
        var hourlyFields = $('#hourlyPricingFields');
        var projectFields = $('#projectPricingFields');
        var hourlyCard = $('#hourlyCard');
        var projectCard = $('#projectCard');

        console.log('üéØ Elements found:');
        console.log('  - hourlyPricingFields:', hourlyFields.length, 'visible:', hourlyFields.is(':visible'));
        console.log('  - projectPricingFields:', projectFields.length, 'visible:', projectFields.is(':visible'));
        console.log('  - hourlyCard:', hourlyCard.length, 'visible:', hourlyCard.is(':visible'));
        console.log('  - projectCard:', projectCard.length, 'visible:', projectCard.is(':visible'));

        // „Ç´„Éº„Éâ„ÅÆ„Éè„Ç§„É©„Ç§„Éà
        $('.pricing-type-card').removeClass('border-primary bg-light');
        console.log('üîß Before changes:');
        console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
        console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));

        if (pricingType === 'hourly') {
            console.log('üîß Setting to hourly mode');
            $('#hourlyCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
            console.log('üîß After hourly changes:');
            console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
            console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));
            $('#contractAmountHint').text('ÊôÇÁµ¶„Éô„Éº„Çπ„ÅÆÂ†¥Âêà„ÅØÊôÇÁµ¶ √ó Â∑•Êï∞ + ËøΩÂä†Ë≤ªÁî®„ÅßËá™ÂãïË®àÁÆó„Åï„Çå„Åæ„Åô');
            $('#internalContractAmount').prop('readonly', true);
            $('#costItemsLabel').text('ËøΩÂä†Ë≤ªÁî®È†ÖÁõÆ');
            $('#addCostItemText').text('ËøΩÂä†Ë≤ªÁî®È†ÖÁõÆ„ÇíËøΩÂä†');
            $('#costItemsLabel2').text('ËøΩÂä†Ë≤ªÁî®ÂêàË®à: ¬•');
            $('#contractAmountLabel').text('‰ΩúÊ•≠Ë≤ªÁî®ÔºàÂü∫Êú¨ÊñôÈáë + ËøΩÂä†Ë≤ªÁî®Ôºâ');
        } else {
            console.log('üîß Setting to project mode');
            $('#projectCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
            console.log('üîß After project changes:');
            console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
            console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));
            $('#contractAmountHint').text('Ê°à‰ª∂Âçò‰Ωç„ÅÆÂ†¥Âêà„ÅØÂ•ëÁ¥ÑÈáëÈ°ç + ËøΩÂä†Ë≤ªÁî®„ÅßË®àÁÆó„Åï„Çå„Åæ„Åô');
            $('#internalContractAmount').prop('readonly', true);
            $('#costItemsLabel').text('ËøΩÂä†Ë≤ªÁî®È†ÖÁõÆ');
            $('#addCostItemText').text('ËøΩÂä†Ë≤ªÁî®È†ÖÁõÆ„ÇíËøΩÂä†');
            $('#costItemsLabel2').text('ËøΩÂä†Ë≤ªÁî®ÂêàË®à: ¬•');
            $('#contractAmountLabel').text('‰ΩúÊ•≠Ë≤ªÁî®ÔºàÂ•ëÁ¥ÑÈáëÈ°ç + ËøΩÂä†Ë≤ªÁî®Ôºâ');
        }
        calculateInternalCost();
        updateProfitPreview();
        console.log('========================');
    });

    // ÊâãÂãï„Éá„Éê„ÉÉ„Ç∞Áî®„ÅÆÈñ¢Êï∞„Çí„Ç∞„É≠„Éº„Éê„É´„Å´ËøΩÂä†
    window.debugPricingSystem = function() {
        console.log('üêõ Manual Pricing System Debug:');
        console.log('  - Internal section visible:', $('#internalWorkerSection').is(':visible'));
        console.log('  - Pricing radio buttons found:', $('input[name="internal_pricing_type"]').length);
        console.log('  - Currently checked:', $('input[name="internal_pricing_type"]:checked').val());
        console.log('  - hourlyPricingFields exists:', $('#hourlyPricingFields').length, 'visible:', $('#hourlyPricingFields').is(':visible'));
        console.log('  - projectPricingFields exists:', $('#projectPricingFields').length, 'visible:', $('#projectPricingFields').is(':visible'));
        console.log('  - hourlyCard exists:', $('#hourlyCard').length);
        console.log('  - projectCard exists:', $('#projectCard').length);

        // Âº∑Âà∂ÁöÑ„Å´Âàá„ÇäÊõø„Åà„ÉÜ„Çπ„Éà
        console.log('üß™ Testing force toggle to project mode:');
        $('#projectPricing').prop('checked', true).trigger('change');
    };

    window.debugModalPricingSystem = function() {
        console.log('üêõ Modal Pricing System Debug:');
        console.log('  - Modal visible:', $('#addImplementationModal').is(':visible'));
        console.log('  - Modal pricing radio buttons found:', $('input[name="modal_internal_pricing_type"]').length);
        console.log('  - Currently checked:', $('input[name="modal_internal_pricing_type"]:checked').val());
        console.log('  - modalHourlyPricingFields exists:', $('#modalHourlyPricingFields').length, 'visible:', $('#modalHourlyPricingFields').is(':visible'));
        console.log('  - modalProjectPricingFields exists:', $('#modalProjectPricingFields').length, 'visible:', $('#modalProjectPricingFields').is(':visible'));

        // Âº∑Âà∂ÁöÑ„Å´Âàá„ÇäÊõø„Åà„ÉÜ„Çπ„Éà
        console.log('üß™ Testing force toggle to modal project mode:');
        $('#modalProjectPricing').prop('checked', true).trigger('change');
    };

    window.testToggleToProject = function() {
        console.log('üß™ Manually triggering project mode');
        $('#projectPricing').prop('checked', true).trigger('change');
    };

    window.testToggleToHourly = function() {
        console.log('üß™ Manually triggering hourly mode');
        $('#hourlyPricing').prop('checked', true).trigger('change');
    };

    window.testModalToggleToProject = function() {
        console.log('üß™ Manually triggering modal project mode');
        $('#modalProjectPricing').prop('checked', true).trigger('change');
    };

    window.testModalToggleToHourly = function() {
        console.log('üß™ Manually triggering modal hourly mode');
        $('#modalHourlyPricing').prop('checked', true).trigger('change');
    };

    // Á§æÂÜÖ„É™„ÇΩ„Éº„Çπ„ÅÆ‰ΩúÊ•≠Ë≤ªÁî®Ëá™ÂãïË®àÁÆó
    function calculateInternalCost() {
        var pricingType = $('input[name="internal_pricing_type"]:checked').val();

        if (pricingType === 'hourly') {
            // ÊôÇÁµ¶„Éô„Éº„ÇπÔºöÂü∫Êú¨ÊñôÈáë + ËøΩÂä†Ë≤ªÁî®
            var hourlyRate = parseFloat($('input[name="internal_hourly_rate"]').val()) || 0;
            var hours = parseFloat($('input[name="estimated_hours"]').val()) || 0;
            var baseAmount = hourlyRate * hours;

            var additionalCost = 0;
            $('.cost-item-input').each(function() {
                additionalCost += parseFloat($(this).val()) || 0;
            });

            var total = baseAmount + additionalCost;
            $('#internalContractAmount').val(total);

            // ÂÜÖË®≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
            $('#baseAmount').text(baseAmount.toLocaleString());
            $('#additionalAmount').text(additionalCost.toLocaleString());
            $('#workSubtotal').text(total.toLocaleString());
            $('#hourlyBreakdown').show();
            $('#projectBreakdown').hide();
        } else if (pricingType === 'project') {
            // Ê°à‰ª∂Âçò‰ΩçÔºöÂ•ëÁ¥ÑÈáëÈ°ç + ËøΩÂä†Ë≤ªÁî®
            var contractAmount = parseFloat($('#projectContractAmount').val()) || 0;

            var additionalCost = 0;
            $('.cost-item-input').each(function() {
                additionalCost += parseFloat($(this).val()) || 0;
            });

            var total = contractAmount + additionalCost;
            $('#internalContractAmount').val(total);

            // ÂÜÖË®≥Ë°®Á§∫„ÇíÊõ¥Êñ∞
            $('#projectBaseAmount').text(contractAmount.toLocaleString());
            $('#projectAdditionalAmount').text(additionalCost.toLocaleString());
            $('#projectSubtotal').text(total.toLocaleString());
            $('#hourlyBreakdown').hide();
            $('#projectBreakdown').show();
        }

        updateCostBreakdown();
        updateProfitPreview();
    }

    // Ë≤ªÁî®ÂÜÖË®≥„ÅÆÊõ¥Êñ∞
    function updateCostBreakdown() {
        var workerType = $('input[name="worker_type"]:checked').val();
        var materialCost = 0;
        var workCost = 0;

        if (workerType === 'external') {
            // Â§ñÊ≥®ÂÖà„ÅÆÂ†¥Âêà
            workCost = parseFloat($('input[name="contract_amount"]').val()) || 0;
            var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;
            $('.external-material-cost-input').each(function() {
                materialCost += parseFloat($(this).val()) || 0;
            });

            $('#externalContractAmount').text(workCost.toLocaleString());
            $('#externalBilledAmount').text(billedAmount.toLocaleString());
            $('#externalMaterialSubtotal').text(materialCost.toLocaleString());
            $('#externalGrandTotal').text((Math.max(workCost, billedAmount) + materialCost).toLocaleString());
        } else {
            // Á§æÂÜÖ„É™„ÇΩ„Éº„Çπ„ÅÆÂ†¥Âêà
            workCost = parseFloat($('#internalContractAmount').val()) || 0;
            $('.internal-material-cost-input').each(function() {
                materialCost += parseFloat($(this).val()) || 0;
            });
        }

        // ÂÖ±ÈÄö„ÅÆÈÉ®ÊùêË≤ªË°®Á§∫Êõ¥Êñ∞
        $('#materialSubtotal').text(materialCost.toLocaleString());

        // Á∑èÂêàË®à„ÅÆÊõ¥Êñ∞
        var grandTotal = workCost + materialCost;
        $('#grandTotal').text(grandTotal.toLocaleString());
    }

    // ÊôÇÁµ¶„Å®Â∑•Êï∞„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $('input[name="internal_hourly_rate"], input[name="estimated_hours"]').on('input', calculateInternalCost);

    // Ê°à‰ª∂Âçò‰Ωç„ÅÆÂ•ëÁ¥ÑÈáëÈ°çÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $('#projectContractAmount').on('input', calculateInternalCost);

    // ÂàùÊúüÁä∂ÊÖã„ÅÆË®≠ÂÆö
    function initializePricingType() {
        var pricingType = $('input[name="internal_pricing_type"]:checked').val();
        console.log('üîß Initializing pricing type:', pricingType);
        console.log('üéØ Hourly fields element:', $('#hourlyPricingFields').length);
        console.log('üéØ Project fields element:', $('#projectPricingFields').length);
        console.log('üéØ Hourly card element:', $('#hourlyCard').length);
        console.log('üéØ Project card element:', $('#projectCard').length);

        $('.pricing-type-card').removeClass('border-primary bg-light');

        if (pricingType === 'hourly') {
            console.log('üîß Initializing as hourly');
            $('#hourlyCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
        } else if (pricingType === 'project') {
            console.log('üîß Initializing as project');
            $('#projectCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
        } else {
            console.log('‚ö†Ô∏è Unknown pricing type:', pricingType);
        }
    }

    // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂàùÊúüÂåñÂÆüË°å
    initializePricingType();

    // „Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØ„ÅßÊñôÈáë‰ΩìÁ≥ªÂàá„ÇäÊõø„Åà
    $(document).on('click', '.pricing-type-card', function() {
        console.log('üéØ Card clicked');
        var targetRadio = $(this).find('input[type="radio"]');
        console.log('üìª Radio found:', targetRadio.length);
        targetRadio.prop('checked', true).trigger('change');
    });

    // Êö´ÂÆöÂà©ÁõäÁéá„ÅÆË®àÁÆó„Å®Ë°®Á§∫ÔºàË©≥Á¥∞ÁâàÔºâ
    function updateProfitPreview() {
        var revenue = parseFloat("{{ project.billing_amount|default:0 }}".replace(/,/g, '')) || 0;
        var newWorkCost = 0;
        var newMaterialCost = 0;

        // ÁèæÂú®ÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çã‰ΩúÊ•≠Ë≤ªÁî®„ÇíÂèñÂæó
        if ($('input[name="worker_type"]:checked').val() === 'external') {
            newWorkCost = parseFloat($('input[name="contract_amount"]').val()) || 0;
            var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;
            newWorkCost = Math.max(newWorkCost, billedAmount); // „Çà„ÇäÈ´ò„ÅÑÊñπ„Çí‰ΩøÁî®

            // Â§ñÊ≥®ÂÖà„ÅÆÈÉ®ÊùêË≤ªÂêàË®à
            $('.external-material-cost-input').each(function() {
                newMaterialCost += parseFloat($(this).val()) || 0;
            });
        } else {
            newWorkCost = parseFloat($('#internalContractAmount').val()) || 0;
            // Á§æÂÜÖ„É™„ÇΩ„Éº„Çπ„ÅÆÈÉ®ÊùêË≤ªÂêàË®à
            $('.internal-material-cost-input').each(function() {
                newMaterialCost += parseFloat($(this).val()) || 0;
            });
        }

        var existingCost = parseFloat("{{ existing_total_cost|default:0 }}".replace(/,/g, '')) || 0;
        var totalCost = existingCost + newWorkCost + newMaterialCost;
        var grossProfit = revenue - totalCost;
        var profitRate = revenue > 0 ? (grossProfit / revenue * 100) : 0;

        // Ë©≥Á¥∞Ë°®Á§∫„ÇíÊõ¥Êñ∞
        $('#previewRevenue').text(revenue.toLocaleString());
        $('#previewExistingCost').text(existingCost.toLocaleString());
        $('#previewNewWorkCost').text(newWorkCost.toLocaleString());
        $('#previewNewMaterialCost').text(newMaterialCost.toLocaleString());
        $('#previewTotalCost').text(totalCost.toLocaleString());
        $('#previewGrossProfit').text(grossProfit.toLocaleString());
        $('#previewProfitRate').text(profitRate.toFixed(1) + '%');

        // Âà©ÁõäÁéá„Å´Âøú„Åò„Å¶Ëâ≤„Å®„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂ§âÊõ¥
        var rateElement = $('#previewProfitRate');
        var progressBar = $('#profitRateBar');

        rateElement.removeClass('text-success text-warning text-danger');
        progressBar.removeClass('bg-success bg-warning bg-danger');

        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆÂπÖ„ÇíË®≠ÂÆöÔºàÊúÄÂ§ß50%„Åæ„ÅßË°®Á§∫Ôºâ
        var displayRate = Math.min(profitRate, 50);
        progressBar.css('width', displayRate + '%');

        // Âà©ÁõäÁéá„Å´Âøú„Åò„ÅüËâ≤ÂàÜ„Åë
        if (profitRate >= 30) {
            rateElement.addClass('text-success');
            progressBar.addClass('bg-success');
        } else if (profitRate >= 15) {
            rateElement.addClass('text-warning');
            progressBar.addClass('bg-warning');
        } else {
            rateElement.addClass('text-danger');
            progressBar.addClass('bg-danger');
        }

        // Êñ∞Ë¶èË≤ªÁî®„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøË°å„ÇíË°®Á§∫
        if (newWorkCost > 0) {
            $('#newCostRow').show();
        } else {
            $('#newCostRow').hide();
        }

        if (newMaterialCost > 0) {
            $('#newMaterialRow').show();
        } else {
            $('#newMaterialRow').hide();
        }

        // Âà©ÁõäÁéá„Éó„É¨„Éì„É•„Éº„ÅØÂ∏∏„Å´Ë°®Á§∫ÔºàÂÜÖÂÆπ„ÇíÂãïÁöÑ„Å´Êõ¥Êñ∞Ôºâ
        // ÂÖ•Âäõ„Åå„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇÁèæÂú®„ÅÆÁä∂Ê≥Å„ÇíË°®Á§∫
    }

    // ÈáëÈ°ç„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñÔºàÂ§ñÊ≥®ÂÖàÁî®Ôºâ
    $('input[name="contract_amount"], input[name="billed_amount"]').on('input', function() {
        updateCostBreakdown();
        updateProfitPreview();
    });

    // ÈÉ®ÊùêË≤ªÂêàË®à„ÅÆËá™ÂãïË®àÁÆó
    function calculateMaterialTotal() {
        var total = 0;
        $('.material-cost').each(function() {
            var value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#totalMaterialCost').val(total);
    }

    // ÈÉ®ÊùêË≤ª„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $('.material-cost').on('input', calculateMaterialTotal);

    // ÂàùÊúüË®àÁÆó
    calculateMaterialTotal();

    // ÂãïÁöÑÈÉ®ÊùêË≤ªÈ†ÖÁõÆÁÆ°ÁêÜ
    let materialItemCounter = 0;
    let externalMaterialItemCounter = 0;

    // Á§æÂÜÖ„É™„ÇΩ„Éº„ÇπÁî®ÈÉ®ÊùêË≤ªÈ†ÖÁõÆ„ÇíËøΩÂä†„Åô„ÇãÈñ¢Êï∞
    function addMaterialItem(item = '', cost = 0) {
        materialItemCounter++;
        const itemHtml = `
            <div class="material-item mb-2" data-item-id="${materialItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="internal_material_items[]" class="form-control"
                               placeholder="ÈÉ®ÊùêË≤ªÈ†ÖÁõÆ" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">¬•</span>
                            <input type="number" name="internal_material_costs[]" class="form-control internal-material-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-material-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#materialCostSection').append(itemHtml);
        updateInternalMaterialTotal();
    }

    // Â§ñÊ≥®ÂÖàÁî®ÈÉ®ÊùêË≤ªÈ†ÖÁõÆ„ÇíËøΩÂä†„Åô„ÇãÈñ¢Êï∞
    function addExternalMaterialItem(item = '', cost = 0) {
        externalMaterialItemCounter++;
        const itemHtml = `
            <div class="external-material-item mb-2" data-item-id="${externalMaterialItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="material_items[]" class="form-control"
                               placeholder="ÈÉ®ÊùêË≤ªÈ†ÖÁõÆ" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">¬•</span>
                            <input type="number" name="material_costs[]" class="form-control external-material-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-external-material-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#externalMaterialCostSection').append(itemHtml);
        updateExternalMaterialTotal();
    }

    // Á§æÂÜÖ„É™„ÇΩ„Éº„ÇπÈÉ®ÊùêË≤ªÂêàË®à„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function updateInternalMaterialTotal() {
        let total = 0;
        $('.internal-material-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#materialTotal').text(total.toLocaleString());
        updateCostBreakdown();
        updateProfitPreview();
    }

    // Â§ñÊ≥®ÂÖàÈÉ®ÊùêË≤ªÂêàË®à„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function updateExternalMaterialTotal() {
        let total = 0;
        $('.external-material-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#externalMaterialTotal').text(total.toLocaleString());
        $('#externalMaterialSubtotal').text(total.toLocaleString());
        updateExternalCostBreakdown();
        updateProfitPreview();
    }

    // Â§ñÊ≥®ÂÖàÁî®ËøΩÂä†Ë≤ªÁî®È†ÖÁõÆ„Ç´„Ç¶„É≥„Çø„Éº
    let externalAdditionalCostItemCounter = 0;

    // Â§ñÊ≥®ÂÖàÁî®ËøΩÂä†Ë≤ªÁî®È†ÖÁõÆ„ÇíËøΩÂä†„Åô„ÇãÈñ¢Êï∞
    function addExternalAdditionalCostItem(item = '', cost = 0) {
        externalAdditionalCostItemCounter++;
        const itemHtml = `
            <div class="external-additional-cost-item mb-2" data-item-id="${externalAdditionalCostItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="additional_cost_items[]" class="form-control"
                               placeholder="ËøΩÂä†Ë≤ªÁî®È†ÖÁõÆ" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">¬•</span>
                            <input type="number" name="additional_cost_amounts[]" class="form-control external-additional-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-external-additional-cost-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#externalAdditionalCostSection').append(itemHtml);
        updateExternalAdditionalCostTotal();
    }

    // Â§ñÊ≥®ÂÖàËøΩÂä†Ë≤ªÁî®ÂêàË®à„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function updateExternalAdditionalCostTotal() {
        let total = 0;
        $('.external-additional-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#externalAdditionalCostTotal').text(total.toLocaleString());
        $('#externalAdditionalCostSubtotal').text(total.toLocaleString());
        updateExternalCostBreakdown();
        updateProfitPreview();
    }

    // Â§ñÊ≥®ÂÖàË≤ªÁî®ÂÜÖË®≥„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function updateExternalCostBreakdown() {
        var contractAmount = parseFloat($('input[name="contract_amount"]').val()) || 0;
        var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;

        var materialCost = 0;
        $('.external-material-cost-input').each(function() {
            materialCost += parseFloat($(this).val()) || 0;
        });

        var additionalCost = 0;
        $('.external-additional-cost-input').each(function() {
            additionalCost += parseFloat($(this).val()) || 0;
        });

        $('#externalContractAmount').text(contractAmount.toLocaleString());
        $('#externalBilledAmount').text(billedAmount.toLocaleString());
        $('#externalMaterialSubtotal').text(materialCost.toLocaleString());
        $('#externalAdditionalCostSubtotal').text(additionalCost.toLocaleString());

        var grandTotal = Math.max(contractAmount, billedAmount) + materialCost + additionalCost;
        $('#externalGrandTotal').text(grandTotal.toLocaleString());
    }

    // Á§æÂÜÖ„É™„ÇΩ„Éº„ÇπÈÉ®ÊùêË≤ªÈ†ÖÁõÆËøΩÂä†„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    $('#addMaterialBtn').on('click', function() {
        addMaterialItem();
    });

    // Â§ñÊ≥®ÂÖàÈÉ®ÊùêË≤ªÈ†ÖÁõÆËøΩÂä†„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    $('#addExternalMaterialBtn').on('click', function() {
        addExternalMaterialItem();
    });

    // Â§ñÊ≥®ÂÖàËøΩÂä†Ë≤ªÁî®È†ÖÁõÆËøΩÂä†„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    $('#addExternalAdditionalCostBtn').on('click', function() {
        addExternalAdditionalCostItem();
    });

    // Á§æÂÜÖ„É™„ÇΩ„Éº„ÇπÈÉ®ÊùêË≤ªÈ†ÖÁõÆÂâäÈô§„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
    $(document).on('click', '.remove-material-btn', function() {
        $(this).closest('.material-item').remove();
        updateInternalMaterialTotal();
    });

    // Â§ñÊ≥®ÂÖàÈÉ®ÊùêË≤ªÈ†ÖÁõÆÂâäÈô§„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
    $(document).on('click', '.remove-external-material-btn', function() {
        $(this).closest('.external-material-item').remove();
        updateExternalMaterialTotal();
    });

    // Â§ñÊ≥®ÂÖàËøΩÂä†Ë≤ªÁî®È†ÖÁõÆÂâäÈô§„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
    $(document).on('click', '.remove-external-additional-cost-btn', function() {
        $(this).closest('.external-additional-cost-item').remove();
        updateExternalAdditionalCostTotal();
    });

    // Á§æÂÜÖ„É™„ÇΩ„Éº„ÇπÈÉ®ÊùêË≤ªÈáëÈ°ç„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('input', '.internal-material-cost-input', function() {
        updateInternalMaterialTotal();
    });

    // Â§ñÊ≥®ÂÖàÈÉ®ÊùêË≤ªÈáëÈ°ç„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('input', '.external-material-cost-input', function() {
        updateExternalMaterialTotal();
    });

    // Â§ñÊ≥®ÂÖàËøΩÂä†Ë≤ªÁî®ÈáëÈ°ç„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('input', '.external-additional-cost-input', function() {
        updateExternalAdditionalCostTotal();
    });

    // Â§ñÊ≥®ÂÖàÂ•ëÁ¥ÑÈáëÈ°ç„ÉªË¢´Ë´ãÊ±ÇÈ°ç„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('input', 'input[name="contract_amount"], input[name="billed_amount"]', function() {
        updateExternalCostBreakdown();
        updateProfitPreview();
    });

    // ÊãÖÂΩìËÄÖÈÅ∏ÊäûËøΩÂä†„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    $(document).on('click', '.add-staff-select-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const containerId = $(this).data('container-id');
        const fieldName = $(this).data('field-name');
        const container = $(`#${containerId}`);

        // „Çπ„Çø„ÉÉ„Éï„Ç™„Éó„Ç∑„Éß„É≥„ÇíÁîüÊàê
        const staffOptions = generateStaffOptions();
        let optionsHtml = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
        if (staffOptions && Array.isArray(staffOptions)) {
            staffOptions.forEach(option => {
                optionsHtml += `<option value="${option.value}">${option.text}</option>`;
            });
        }

        // Êñ∞„Åó„ÅÑselect„Éú„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†
        const newSelect = `
            <div class="staff-select-item mb-1">
                <select name="${fieldName}" class="form-select d-inline-block" style="width: calc(100% - 35px); font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                    ${optionsHtml}
                </select>
                <button type="button" class="btn btn-outline-danger remove-staff-select-btn" style="font-size: 0.65rem; padding: 0.2rem 0.35rem; line-height: 1;">
                    √ó
                </button>
            </div>
        `;
        container.append(newSelect);

        // ÂâäÈô§„Éú„Çø„É≥„ÇíË°®Á§∫Ôºà2„Å§‰ª•‰∏ä„ÅÆÂ†¥ÂêàÔºâ
        if (container.find('.staff-select-item').length > 1) {
            container.find('.remove-staff-select-btn').show();
        }
    });

    // ÊãÖÂΩìËÄÖÈÅ∏ÊäûÂâäÈô§„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    $(document).on('click', '.remove-staff-select-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const item = $(this).closest('.staff-select-item');
        const container = item.closest('.staff-select-container');

        item.remove();

        // 1„Å§„Åó„Åã„Å™„ÅÑÂ†¥Âêà„ÅØÂâäÈô§„Éú„Çø„É≥„ÇíÈùûË°®Á§∫
        if (container.find('.staff-select-item').length <= 1) {
            container.find('.remove-staff-select-btn').hide();
        }
    });

    // ‰øùÂ≠òÁä∂ÊÖãÁÆ°ÁêÜÈñ¢Êï∞
    let saveTimeout = null;
    function showSavingStatus(status) {
        const banner = $('#savingStatusBanner');
        const icon = $('#savingStatusIcon');
        const text = $('#savingStatusText');

        banner.removeClass('d-none alert-info alert-success alert-warning');

        if (status === 'saving') {
            banner.addClass('alert-info');
            icon.html('<i class="fas fa-spinner fa-spin"></i>');
            text.text('‰øùÂ≠ò‰∏≠...');
        } else if (status === 'saved') {
            banner.addClass('alert-success');
            icon.html('<i class="fas fa-check-circle"></i>');
            text.text('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
            // 2ÁßíÂæå„Å´ÈùûË°®Á§∫
            setTimeout(() => {
                banner.addClass('d-none');
            }, 2000);
        } else if (status === 'error') {
            banner.addClass('alert-warning');
            icon.html('<i class="fas fa-exclamation-triangle"></i>');
            text.text('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
    }

    // ÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éï„Ç£„Éº„É´„Éâ‰øùÂ≠òÈñ¢Êï∞
    function saveStepField(stepKey, stepElement) {
        // Êó¢Â≠ò„ÅÆ‰øùÂ≠ò„Çø„Ç§„Éû„Éº„Çí„ÇØ„É™„Ç¢
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }

        // 500ms„ÅÆ„Éá„Éê„Ç¶„É≥„ÇπÔºàÈÄ£Á∂öÂÖ•Âäõ„ÇíÂæÖ„Å§Ôºâ
        saveTimeout = setTimeout(() => {
            showSavingStatus('saving');

            if (stepElement.length === 0) {
                console.error('Step element not found:', stepKey);
                showSavingStatus('error');
                return;
            }

            // „Åì„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÂèéÈõÜ
            const dynamicFields = {};
        stepElement.find('input, select, textarea').each(function() {
            const fieldElement = $(this);
            const fieldName = fieldElement.attr('name');

            // „Éï„Ç£„Éº„É´„ÉâÂêç„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
            if (!fieldName) return;

            let fieldValue;

            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å®„É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆÂ†¥Âêà
            if (fieldElement.is(':checkbox')) {
                fieldValue = fieldElement.is(':checked') ? 'true' : 'false';
            } else if (fieldElement.is(':radio')) {
                // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅØÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
                if (!fieldElement.is(':checked')) return;
                fieldValue = fieldElement.val();
            } else if (fieldElement.is('select[multiple]')) {
                // Ë§áÊï∞ÈÅ∏Êäû„ÅÆÂ†¥Âêà
                const selectedValues = fieldElement.val();
                if (selectedValues && selectedValues.length > 0) {
                    fieldValue = selectedValues.join(',');
                } else {
                    return; // ‰Ωï„ÇÇÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                }
            } else {
                fieldValue = fieldElement.val();
            }

            // ÂÄ§„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
            if (fieldValue !== undefined && fieldValue !== '') {
                // dynamic_field_ „Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†Ôºà„Åæ„Å†„Å™„ÅÑÂ†¥ÂêàÔºâ
                const finalFieldName = fieldName.startsWith('dynamic_field_') ? fieldName : `dynamic_field_${fieldName}`;
                dynamicFields[finalFieldName] = fieldValue;
            }
        });

        console.log('Saving step:', stepKey, dynamicFields);

        // „Çµ„Éº„Éê„Éº„Å´‰øùÂ≠òÔºàAJAXÔºâ
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
            data: $.extend({
                csrfmiddlewaretoken: '{{ csrf_token }}',
                ajax_save: 'true'  // AJAX‰øùÂ≠ò„Éï„É©„Ç∞
            }, dynamicFields),
            success: function(response) {
                console.log('‰øùÂ≠òÊàêÂäü:', response);

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                if (response && response.success) {
                    // „É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫„Åó„Å™„ÅÑÔºà„É¶„Éº„Ç∂„Éº„ÅÆË¶ÅÊúõÔºâ
                    // if (typeof toastr !== 'undefined') {
                    //     toastr.success(response.message || `${stepKey}„Çπ„ÉÜ„ÉÉ„Éó„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
                    // } else {
                    //     showErrorModal(`${stepKey}„Çπ„ÉÜ„ÉÉ„Éó„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü`);
                    // }
                    // ÈÄ≤ÊçóÁä∂Ê≥Å„ÇíÊõ¥Êñ∞
                    updateProgressTimeline();
                    updateProgressStatus();
                } else {
                    console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    } else {
                        showErrorModal('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                let errorMessage = '‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                } else if (xhr.status === 403) {
                    errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status === 404) {
                    errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status >= 500) {
                    errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                } else {
                    showErrorModal(errorMessage);
                }
            }
        });
        }, 500);
    }

    // ÂàùÊúüÈÉ®ÊùêË≤ªÈ†ÖÁõÆ„Çí1„Å§ËøΩÂä†
    addMaterialItem();
    addExternalMaterialItem();
    addExternalAdditionalCostItem();

    // ÂãïÁöÑË≤ªÁî®È†ÖÁõÆÁÆ°ÁêÜ
    let costItemCounter = 0;

    // Ë≤ªÁî®È†ÖÁõÆ„ÇíËøΩÂä†„Åô„ÇãÈñ¢Êï∞
    function addCostItem(item = '', cost = 0) {
        costItemCounter++;
        const itemHtml = `
            <div class="cost-item mb-2" data-item-id="${costItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="cost_items[]" class="form-control"
                               placeholder="Ë≤ªÁî®È†ÖÁõÆÂêç" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">¬•</span>
                            <input type="number" name="cost_amounts[]" class="form-control cost-item-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-cost-item-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#costItemsSection').append(itemHtml);
        updateCostItemsTotal();
    }

    // Ë≤ªÁî®È†ÖÁõÆÂêàË®à„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function updateCostItemsTotal() {
        let total = 0;
        $('.cost-item-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#costItemsTotal').text(total.toLocaleString());
        calculateInternalCost(); // „Åì„Çå„Åå updateCostBreakdown „Å® updateProfitPreview „ÇíÂëº„Å∂
    }

    // Ë≤ªÁî®È†ÖÁõÆËøΩÂä†„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
    $('#addCostItemBtn').on('click', function() {
        addCostItem();
    });

    // Ë≤ªÁî®È†ÖÁõÆÂâäÈô§„Éú„Çø„É≥„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„ÉàÔºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
    $(document).on('click', '.remove-cost-item-btn', function() {
        $(this).closest('.cost-item').remove();
        updateCostItemsTotal();
    });

    // Ë≤ªÁî®È†ÖÁõÆÈáëÈ°ç„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('input', '.cost-item-input', function() {
        updateCostItemsTotal();
    });

    // ÂàùÊúüË≤ªÁî®È†ÖÁõÆ„Çí1„Å§ËøΩÂä†
    addCostItem();

    // ÂàùÊúüË°®Á§∫ÊôÇ„Å´Âà©ÁõäÁéá„ÇíË®àÁÆó„ÉªË°®Á§∫
    updateProfitPreview();

    // Á∏¶Âûã„Éó„É≠„Ç∞„É¨„Çπ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„ÇØ„É™„ÉÉ„ÇØÂá¶ÁêÜÔºà„Éà„Ç∞„É´Âºè - „Éá„Éï„Ç©„É´„Éà„ÅØÂ±ïÈñãÁä∂ÊÖãÔºâ
    $(document).on('click', '.progress-step', function(e) {
        // ÂâäÈô§„Éú„Çø„É≥„ÄÅÁ∑®ÈõÜ„Éú„Çø„É≥„ÄÅ„Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´„ÄÅ„Éï„Ç©„Éº„É†Ë¶ÅÁ¥†„ÅÆ„ÇØ„É™„ÉÉ„ÇØ„ÅØÈô§Â§ñ
        if ($(e.target).hasClass('remove-step-btn') || $(e.target).closest('.remove-step-btn').length ||
            $(e.target).hasClass('btn') || $(e.target).closest('.btn').length ||
            $(e.target).hasClass('drag-handle') || $(e.target).closest('.drag-handle').length ||
            $(e.target).is('input, select, textarea') || $(e.target).closest('input, select, textarea').length) {
            return;
        }

        const $clickedStep = $(this);
        const isCurrentlyExpanded = $clickedStep.hasClass('expanded');

        // „ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Çπ„ÉÜ„ÉÉ„Éó„Çí„Éà„Ç∞„É´ÔºàCSS transition„ÅßÊªë„Çâ„Åã„Å´Â±ïÈñãÔºâ
        if (isCurrentlyExpanded) {
            $clickedStep.removeClass('expanded');
        } else {
            $clickedStep.addClass('expanded');
        }
    });

    // „Éâ„É©„ÉÉ„Ç∞„Éè„É≥„Éâ„É´„ÇíÊúÄÂàù„ÅØÈùûË°®Á§∫
    $('.drag-handle').hide();

    // SortableÊ©üËÉΩ„ÇíÂàùÊúüÂåñÔºà„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÉºË®≠ÂÆöÂæåÔºâ
    initializeSortable();

    // ÂàùÊúüË°®Á§∫ÊôÇ„Å´ÂÖ®„Å¶„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂ±ïÈñãÔºàCSS transition„ÅßÂà∂Âæ°Ôºâ
    $('.progress-step').addClass('expanded');
    // „Éà„Ç∞„É´„Éú„Çø„É≥„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇÇÊõ¥Êñ∞Ôºà„Éú„Çø„É≥„ÅØÂâäÈô§„Åï„Çå„Åü„ÅÆ„Åß„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„ÉàÔºâ
    // $('#toggleAllSteps').find('i').removeClass('fa-expand-alt').addClass('fa-compress-alt');
    // $('#toggleButtonText').text('ÂÖ®„Å¶Èñâ„Åò„Çã');

    // ‰∏ÄÊã¨ÈñãÈñâ„Éà„Ç∞„É´„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÉºÔºà„Éú„Çø„É≥„ÅØÂâäÈô§„Åï„Çå„Åü„ÅÆ„Åß„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„ÉàÔºâ
    // $('#toggleAllSteps').on('click', function() {
    //     // ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂà§ÂÆöÔºà„Åô„Åπ„Å¶Â±ïÈñã„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºâ
    //     const allExpanded = $('.progress-step.expanded').length === $('.progress-step').length;

    //     if (allExpanded) {
    //         // ÂÖ®„Å¶Èñâ„Åò„Çã
    //         $('.progress-step').removeClass('expanded');
    //         $('.progress-step-content').slideUp(200);
    //         // „Éú„Çø„É≥„Çí„ÄåÂÖ®„Å¶Èñã„Åè„Äç„Å´Â§âÊõ¥
    //         $(this).find('i').removeClass('fa-compress-alt').addClass('fa-expand-alt');
    //         $('#toggleButtonText').text('ÂÖ®„Å¶Èñã„Åè');
    //     } else {
    //         // ÂÖ®„Å¶Èñã„Åè
    //         $('.progress-step').addClass('expanded');
    //         $('.progress-step-content').slideDown(200);
    //         // „Éú„Çø„É≥„Çí„ÄåÂÖ®„Å¶Èñâ„Åò„Çã„Äç„Å´Â§âÊõ¥
    //         $(this).find('i').removeClass('fa-expand-alt').addClass('fa-compress-alt');
    //         $('#toggleButtonText').text('ÂÖ®„Å¶Èñâ„Åò„Çã');
    //     }
    // });

    // ÂÖ®ÈÉ®Èñã„Åè/ÂÖ®ÈÉ®Èñâ„Åò„Çã„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÉºÔºà„Éà„Ç∞„É´ÂºèÔºâ
    $('#toggleAllSteps').on('click', function() {
        // ÁèæÂú®„ÅÆÁä∂ÊÖã„ÇíÂà§ÂÆöÔºà„Åô„Åπ„Å¶Â±ïÈñã„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØÔºâ
        const allExpanded = $('.progress-step.expanded').length === $('.progress-step').length;

        if (allExpanded) {
            // ÂÖ®„Å¶Èñâ„Åò„Çã
            console.log('ÂÖ®„Å¶Èñâ„Åò„Çã');
            $('.progress-step').removeClass('expanded');
            $('.progress-step-content').slideUp(200);
            // „Éú„Çø„É≥„Çí„ÄåÂÖ®ÈÉ®Èñã„Åè„Äç„Å´Â§âÊõ¥
            $(this).find('i').removeClass('fa-compress-alt').addClass('fa-expand-alt');
            $('#toggleButtonText').text('ÂÖ®ÈÉ®Èñã„Åè');
        } else {
            // ÂÖ®„Å¶Èñã„Åè
            console.log('ÂÖ®„Å¶Èñã„Åè');
            $('.progress-step').addClass('expanded');
            $('.progress-step-content').slideDown(200);
            // „Éú„Çø„É≥„Çí„ÄåÂÖ®ÈÉ®Èñâ„Åò„Çã„Äç„Å´Â§âÊõ¥
            $(this).find('i').removeClass('fa-expand-alt').addClass('fa-compress-alt');
            $('#toggleButtonText').text('ÂÖ®ÈÉ®Èñâ„Åò„Çã');
        }
    });

    // ÂÆüÊñΩÊó•ËøΩÂä†„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
    $(document).on('click', '.add-actual-date-btn', function(e) {
        e.stopPropagation();
        const $step = $(this).closest('.progress-step');
        const $actualDateField = $step.find('.actual-date-field');

        // ÂÆüÊñΩÊó•„Éï„Ç£„Éº„É´„Éâ„ÇíË°®Á§∫
        $actualDateField.slideDown();
        $(this).prop('disabled', true).addClass('disabled');
    });

    // ÂÆüÊñΩÊó•ÂâäÈô§„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº
    $(document).on('click', '.remove-actual-date-btn', function(e) {
        e.stopPropagation();
        const $step = $(this).closest('.progress-step');
        const $actualDateField = $step.find('.actual-date-field');
        const $actualDateInput = $step.find('.actual-date-input');
        const $addBtn = $step.find('.add-actual-date-btn');

        // ÂÆüÊñΩÊó•„ÅÆÂÄ§„Çí„ÇØ„É™„Ç¢
        $actualDateInput.val('');

        // ÂÆüÊñΩÊó•„Éï„Ç£„Éº„É´„Éâ„ÇíÈùûË°®Á§∫
        $actualDateField.slideUp();
        $addBtn.prop('disabled', false).removeClass('disabled');
    });

    // ‰∫àÂÆöÊó•„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ„Åó„Å¶„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
    $(document).on('change', '.scheduled-date-input', function() {
        checkOverdueSteps();
    });

    // ‰∫àÂÆöÊó•Ë∂ÖÈÅé„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞Ôºà‰∫àÂÆöÊó•Ë∂ÖÈÅéÊôÇ„Å´Ëá™ÂãïÂÆå‰∫ÜÔºâ
    function checkOverdueSteps() {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // ÊôÇÂàª„Çí„É™„Çª„ÉÉ„Éà

        $('.progress-step').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');

            // üîß FIX: Ë¶ãÁ©çÊõ∏Áô∫Ë°å„Çπ„ÉÜ„ÉÉ„Éó„ÅØ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅßÂÆå‰∫ÜÁä∂ÊÖã„ÇíÁÆ°ÁêÜ„Åô„Çã„Åü„ÇÅ„Çπ„Ç≠„ÉÉ„Éó
            const complexStepsWithCheckbox = ['estimate', 'step_estimate', 'step_attendance', 'step_survey', 'step_construction_start', 'step_completion'];
            if (complexStepsWithCheckbox.includes(stepKey)) {
                return; // continue
            }

            const $scheduledInput = $step.find('.scheduled-date-input');
            const $actualInput = $step.find('.actual-date-input');
            const $completedCheckbox = $step.find('input[type="checkbox"][name$="_completed"], input[type="checkbox"][id$="Completed"]');

            const scheduledDate = $scheduledInput.val();
            const actualDate = $actualInput.val();
            const isManuallyCompleted = $completedCheckbox.length > 0 && $completedCheckbox.is(':checked');

            // ÂÆüÊñΩÊó•„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„Çå„ÇíÂÑ™ÂÖà
            if (actualDate) {
                $step.removeClass('overdue auto-completed');
                $step.addClass('completed');
                $step.find('.progress-step-date').html(
                    `<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(actualDate)}`
                );
                return;
            }

            // ÊâãÂãï„ÅßÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (isManuallyCompleted) {
                $step.removeClass('overdue auto-completed');
                $step.addClass('completed');
                $step.find('.progress-step-date').html(
                    `<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${scheduledDate ? formatDate(scheduledDate) : 'ÂÆå‰∫ÜÊ∏à„Åø'}`
                );
                return;
            }

            // ‰∫àÂÆöÊó•„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Åø„ÉÅ„Çß„ÉÉ„ÇØ
            if (scheduledDate) {
                const scheduled = new Date(scheduledDate);
                scheduled.setHours(0, 0, 0, 0);

                // ‰∫àÂÆöÊó•„ÅåÈÅé„Åé„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØËá™ÂãïÁöÑ„Å´ÂÆå‰∫ÜÊâ±„ÅÑ
                if (scheduled < today) {
                    $step.removeClass('overdue');
                    $step.addClass('completed auto-completed');

                    // „Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂÆå‰∫ÜÔºà‰∫àÂÆöÊó•„Éô„Éº„ÇπÔºâ„Å´Êõ¥Êñ∞
                    const daysAgo = Math.floor((today - scheduled) / (1000 * 60 * 60 * 24));
                    $step.find('.progress-step-date').html(
                        `<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(scheduledDate)} <small class="text-muted">(${daysAgo}Êó•Ââç)</small>`
                    );
                } else {
                    // ‰∫àÂÆöÊó•„ÅåÊú™Êù•„ÅÆÂ†¥Âêà
                    $step.removeClass('overdue completed auto-completed');
                    $step.find('.progress-step-date').html(
                        `<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(scheduledDate)}`
                    );
                }
            } else {
                // ‰∫àÂÆöÊó•„Åå„Å™„ÅÑÂ†¥Âêà
                $step.removeClass('overdue completed auto-completed');
            }
        });
    }

    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ„Åó„Å¶„É™„Ç¢„É´„Çø„Ç§„É†„ÅßÈÄ≤Êçó„Éê„Éº„ÅÆËâ≤„ÇíÊõ¥Êñ∞
    $('#workStartCompleted').on('change', function() {
        var step = $('.progress-step[data-step="work_start"]');
        if ($(this).is(':checked')) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate($('input[name="work_start_date"]').val()));

            // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºàÂ∑•‰∫ãÁµÇ‰∫ÜÔºâ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');

            // Â∑•‰∫ãÁµÇ‰∫Ü„Çπ„ÉÜ„ÉÉ„Éó„Åã„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇíÂâäÈô§ÔºàÂ∑•‰∫ãÁµÇ‰∫Ü„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.removeClass('active');
            }
        }
        // ÈÄ≤ÊçóÁä∂Ê≥Å„ÇÇÊõ¥Êñ∞
        updateProgressTimeline();
        updateProgressStatus();
    });

    $('#workEndCompleted').on('change', function() {
        var step = $('.progress-step[data-step="work_end"]');
        if ($(this).is(':checked')) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate($('input[name="work_end_date"]').val()));

            // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºàË´ãÊ±ÇÊõ∏Áô∫Ë°åÔºâ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');

            // Ë´ãÊ±ÇÊõ∏Áô∫Ë°å„Çπ„ÉÜ„ÉÉ„Éó„Åã„Çâ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„ÇíÂâäÈô§ÔºàË´ãÊ±ÇÊõ∏„ÅåÊú™Áô∫Ë°å„ÅÆÂ†¥ÂêàÔºâ
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.removeClass('active');
            }
        }
        // ÈÄ≤ÊçóÁä∂Ê≥Å„ÇÇÊõ¥Êñ∞
        updateProgressTimeline();
        updateProgressStatus();
    });

    // „Éï„Ç©„Éº„É†ÂÄ§„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ„Åó„Å¶ÈÄ≤ÊçóÁä∂Ê≥Å„ÇíËá™ÂãïÊõ¥Êñ∞
    // Ê±éÁî®„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñÔºàÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã„Çπ„ÉÜ„ÉÉ„Éó„ÇÇÂê´„ÇÄÔºâ
    // _date„ÅßÁµÇ„Çè„Çã„Éï„Ç£„Éº„É´„ÉâÔºàestimate_issued_date, contract_date, dynamic_field_*„ÅØÈô§Â§ñÔºâ
    $(document).on('change', 'input[name$="_date"]:not([name="estimate_issued_date"]):not([name="contract_date"]):not([name^="dynamic_field_"]), input[name$="_completed"]:not([name^="dynamic_field_"]), select[name="invoice_issued"]', function() {
        // ‰øùÂ≠òÁä∂ÊÖã„ÇíË°®Á§∫
        showSavingStatus('saving');

        // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠òÔºàÊ±éÁî®Ôºâ
        var fieldName = $(this).attr('name');
        var fieldValue;

        if ($(this).is(':checkbox')) {
            fieldValue = $(this).is(':checked');
        } else {
            fieldValue = $(this).val();
        }

        var data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ajax_save: 'true'
        };
        data[fieldName] = fieldValue;

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
            data: data,
            success: function(response) {
                console.log('‰øùÂ≠òÊàêÂäü:', response);

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                if (response && response.success) {
                    console.log(fieldName + '„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', fieldValue);

                    // ‰øùÂ≠òÊàêÂäü„ÇíË°®Á§∫
                    showSavingStatus('saved');

                    // projectData„ÇíÊõ¥Êñ∞
                    projectData[fieldName] = fieldValue;

                    // UIÂÖ®‰Ωì„ÇíÊõ¥Êñ∞
                    updateProgressTimeline();
                    updateProgressStatus();
                } else {
                    console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    showSavingStatus('error');
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || fieldName + '„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                    field: fieldName,
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                // ‰øùÂ≠ò„Ç®„É©„Éº„ÇíË°®Á§∫
                showSavingStatus('error');

                let errorMessage = fieldName + '„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                } else if (xhr.status === 403) {
                    errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status === 404) {
                    errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status >= 500) {
                    errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                }
            }
        });
    });

    // Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name="estimate_issued_date"]', function() {
        console.log('=== Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà„ÅåÁô∫ÁÅ´„Åó„Åæ„Åó„Åü ===');
        var step = $('.progress-step[data-step="estimate"]');
        var notRequiredChecked = $('#estimateNotRequired').is(':checked');
        var dateValue = $(this).val();

        console.log('„Çπ„ÉÜ„ÉÉ„ÉóË¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åó„Åü:', step.length > 0);
        console.log('Ë¶ãÁ©çÊõ∏‰∏çË¶Å„ÉÅ„Çß„ÉÉ„ÇØ:', notRequiredChecked);
        console.log('ÂÖ•Âäõ„Åï„Çå„ÅüÊó•‰ªò:', dateValue);

        // ‰øùÂ≠òÁä∂ÊÖã„ÇíË°®Á§∫
        showSavingStatus('saving');

        // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
        console.log('AJAX‰øùÂ≠ò„ÇíÈñãÂßã„Åó„Åæ„Åô - URL:', '{% url "order_management:update_progress" project.pk %}');
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
            data: {
                estimate_issued_date: dateValue,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('‰øùÂ≠òÊàêÂäü:', response);

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                if (response && response.success) {
                    console.log('‚úì Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„ÅÆ‰øùÂ≠ò„Å´ÊàêÂäü„Åó„Åæ„Åó„Åü');
                    console.log('‰øùÂ≠ò„Åï„Çå„ÅüÊó•‰ªò:', dateValue);

                    // ‰øùÂ≠òÊàêÂäü„ÇíË°®Á§∫
                    showSavingStatus('saved');

                    // projectData„ÇíÊõ¥Êñ∞
                    projectData.estimate_issued_date = dateValue;
                    console.log('projectData„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü:', projectData.estimate_issued_date);

                    // üîß FIX: UI„ÇíÊõ¥Êñ∞ÔºàÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÁ¢∫Ë™çÔºâ
                    const isEstimateCompleted = $('#estimateCompleted').is(':checked');

                    console.log('üîß estimate_issued_date change handler:', {
                        dateValue: dateValue,
                        notRequiredChecked: notRequiredChecked,
                        isEstimateCompleted: isEstimateCompleted
                    });

                    if (dateValue && !notRequiredChecked) {
                        if (isEstimateCompleted) {
                            console.log('„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂÆå‰∫ÜÁä∂ÊÖã„Å´„Åó„Åæ„Åô');
                            step.addClass('completed');
                            step.removeClass('active');
                            step.find('.progress-step-date').html('<span class="badge bg-success">Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊ∏à„Åø</span> ' + formatDate(dateValue));
                        } else {
                            console.log('„Çπ„ÉÜ„ÉÉ„Éó„Çí‰∫àÂÆöÁä∂ÊÖã„Å´„Åó„Åæ„Åô');
                            step.removeClass('completed');
                            step.addClass('active');
                            step.find('.progress-step-date').html('<span class="badge bg-warning">Ë¶ãÁ©çÊõ∏ÂæÖ„Å°</span> ' + formatDate(dateValue));
                        }
                    } else if (!notRequiredChecked) {
                        console.log('„Çπ„ÉÜ„ÉÉ„Éó„ÇíÊú™ÂÆå‰∫ÜÁä∂ÊÖã„Å´„Åó„Åæ„Åô');
                        step.removeClass('completed');
                        step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
                    }

                    // ÈÄ≤ÊçóÁä∂Ê≥ÅÂÖ®‰Ωì„ÇíÊõ¥Êñ∞
                    console.log('ÈÄ≤ÊçóÁä∂Ê≥Å„ÇíÊõ¥Êñ∞„Åó„Åæ„Åô');
                    updateProgressTimeline();
                    updateProgressStatus();
                    updateActiveStep();
                    updateAllStepStatuses();
                } else {
                    console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    showSavingStatus('error');
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    } else {
                        showErrorModal('Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                // ‰øùÂ≠ò„Ç®„É©„Éº„ÇíË°®Á§∫
                showSavingStatus('error');

                let errorMessage = 'Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                } else if (xhr.status === 403) {
                    errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status === 404) {
                    errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status >= 500) {
                    errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                } else {
                    showErrorModal(errorMessage);
                }
            }
        });
    });

    // Ë¶ãÁ©çÊõ∏ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©Ôºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
    // üîß FIX: ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„ÇãË¶ÅÁ¥†„Å™„ÅÆ„Åß„Ç§„Éô„É≥„ÉàÂßîË≠≤„Çí‰ΩøÁî®
    $(document).on('change', '#estimateCompleted', function() {
        var isChecked = $(this).is(':checked');
        var step = $('.progress-step[data-step="estimate"]');
        var scheduledDate = $('input[name="estimate_issued_date"]').val();

        console.log('Ë¶ãÁ©çÊõ∏ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü:', isChecked);

        // UI„ÇíÊõ¥Êñ∞
        if (isChecked) {
            step.addClass('completed');
            step.removeClass('active');
            if (scheduledDate) {
                step.find('.progress-step-date').html(`<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(scheduledDate)}`);
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü');
            }
        } else {
            step.removeClass('completed');
            if (scheduledDate) {
                step.find('.progress-step-date').html(`<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(scheduledDate)}`);
            } else {
                step.find('.progress-step-date').html('<div class="progress-step-date">Êú™ÂÆå‰∫Ü</div>');
            }
        }

        // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠òÔºàSSOT: ProjectProgressStepÔºâ
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',
            data: {
                dynamic_field_estimate_completed: isChecked ? 'true' : '',
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('‚úì Ë¶ãÁ©çÊõ∏ÂÆå‰∫ÜÁä∂ÊÖã„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', isChecked);
                // ÈÄ≤ÊçóÁä∂Ê≥Å„ÇíÊõ¥Êñ∞
                updateProgressStatus();
            },
            error: function(xhr, status, error) {
                console.error('‚ùå ‰øùÂ≠ò„Ç®„É©„Éº:', error);
                console.error('Response:', xhr.responseText);
            }
        });
    });

    // Ë¶ãÁ©çÊõ∏‰∏çË¶Å„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂá¶ÁêÜ„Çí„Ç∞„É≠„Éº„Éê„É´Èñ¢Êï∞„Å®„Åó„Å¶ÂÆöÁæ©
    window.handleEstimateNotRequiredChange = function() {
        var isChecked = $('#estimateNotRequired').is(':checked');
        console.log('Ë¶ãÁ©çÊõ∏‰∏çË¶Å„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü:', isChecked);
        var step = $('.progress-step[data-step="estimate"]');
        var dateInput = $('input[name="estimate_issued_date"]');

        // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
            data: {
                estimate_not_required: isChecked ? 'on' : '',
                estimate_issued_date: isChecked ? '' : dateInput.val(),
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('‰øùÂ≠òÊàêÂäü:', response);

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                if (response && response.success) {
                    console.log('Ë¶ãÁ©çÊõ∏‰∏çË¶Å„Éï„É©„Ç∞„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', isChecked);

                    // projectData„ÇíÊõ¥Êñ∞
                    projectData.estimate_not_required = isChecked;
                    if (isChecked) {
                        projectData.estimate_issued_date = null;
                    }

                    // UI„ÇíÊõ¥Êñ∞
                    if (isChecked) {
                        // Ë¶ãÁ©çÊõ∏‰∏çË¶Å„Å´„ÉÅ„Çß„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<span class="badge bg-success">Ë¶ãÁ©çÊõ∏‰∏çË¶Å</span>');
                    dateInput.prop('disabled', true).val('');
                } else {
                    // Ë¶ãÁ©çÊõ∏‰∏çË¶Å„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂ§ñ„Åó„ÅüÂ†¥Âêà
                    dateInput.prop('disabled', false);

                    // üîß FIX: ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åã„ÇâÂÆå‰∫ÜÁä∂ÊÖã„ÇíË®≠ÂÆö
                    const isEstimateCompleted = $('#estimateCompleted').is(':checked');

                    console.log('üîß handleEstimateNotRequiredChange - estimate not required unchecked:', {
                        dateValue: dateInput.val(),
                        isEstimateCompleted: isEstimateCompleted,
                        currentClasses: step.attr('class')
                    });

                    if (!dateInput.val()) {
                        step.removeClass('completed');
                        step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
                    } else if (isEstimateCompleted) {
                        // ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåON„ÅÆÂ†¥Âêà„ÅÆ„ÅøÂÆå‰∫ÜÁä∂ÊÖã„Å´„Åô„Çã
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<span class="badge bg-success">Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊ∏à„Åø</span> ' + formatDate(dateInput.val()));
                    } else {
                        // Êó•‰ªò„Åå„ÅÇ„Çã„ÅåÊú™ÂÆå‰∫Ü„ÅÆÂ†¥Âêà„ÅØ‰∫àÂÆö„Å®„Åó„Å¶Ë°®Á§∫
                        step.removeClass('completed');
                        step.addClass('active');
                        step.find('.progress-step-date').html('<span class="badge bg-warning">Ë¶ãÁ©çÊõ∏ÂæÖ„Å°</span> ' + formatDate(dateInput.val()));
                    }

                    console.log('üîß handleEstimateNotRequiredChange - after update:', {
                        newClasses: step.attr('class')
                    });
                }

                    // ÈÄ≤ÊçóÁä∂Ê≥ÅÂÖ®‰Ωì„ÇíÊõ¥Êñ∞
                    updateActiveStep();
                    updateProgressTimeline();
                    updateProgressStatus();
                } else {
                    console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'Ë¶ãÁ©çÊõ∏‰∏çË¶Å„Éï„É©„Ç∞„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    } else {
                        showErrorModal('Ë¶ãÁ©çÊõ∏‰∏çË¶Å„Éï„É©„Ç∞„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                let errorMessage = 'Ë¶ãÁ©çÊõ∏‰∏çË¶Å„Éï„É©„Ç∞„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                } else if (xhr.status === 403) {
                    errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status === 404) {
                    errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status >= 500) {
                    errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                } else {
                    showErrorModal(errorMessage);
                }
            }
        });
    };

    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíË®≠ÂÆöÔºà„Ç§„Éô„É≥„Éà„Éá„É™„Ç≤„Éº„Ç∑„Éß„É≥‰ΩøÁî®Ôºâ
    // ‚ÄªÁõ¥Êé•„ÅÆ„Ç§„Éô„É≥„Éà„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„ÅØÂâäÈô§ÔºàDOMË¶ÅÁ¥†„Åå„Åæ„Å†Â≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅÔºâ
    $(document).off('change', '#estimateNotRequired').on('change', '#estimateNotRequired', window.handleEstimateNotRequiredChange);

    // ÂàùÊúüÁä∂ÊÖã„ÅÆË®≠ÂÆö„ÅØ initializeSteps() „ÅÆÂæå„ÅßË°å„Çè„Çå„Åæ„ÅôÔºà3882-3887Ë°åÁõÆÔºâ

    // ============================================
    // Ë¶ãÁ©ç„ÇÇ„Çä„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊ©üËÉΩ
    // ============================================

    // Ë¶ãÁ©ç„ÇÇ„Çä„Éï„Ç°„Ç§„É´„Éá„Éº„ÇøÔºà„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„ÇâÂèñÂæóÔºâ
    let estimateFilesData = {{ estimate_files_json|safe }};

    // Ë¶ãÁ©ç„ÇÇ„Çä„Éï„Ç°„Ç§„É´„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„ÇÄ
    function loadEstimateFiles() {
        renderEstimateFiles(estimateFilesData);
    }

    // Ë¶ãÁ©ç„ÇÇ„Çä„Éï„Ç°„Ç§„É´„É™„Çπ„Éà„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
    function renderEstimateFiles(files) {
        const container = $('.estimate-files-list');
        if (!container.length) return;

        if (files.length === 0) {
            container.html('<small class="text-muted">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</small>');
            return;
        }

        let html = '<div class="list-group list-group-flush">';
        files.forEach(file => {
            const fileIcon = getFileIcon(file.file_type);
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-0" data-file-id="${file.id}">
                    <div class="d-flex align-items-center flex-grow-1">
                        <i class="${fileIcon} me-2"></i>
                        <div class="flex-grow-1">
                            <div class="small fw-bold">${file.file_name}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">
                                ${file.file_size} ‚Ä¢ ${file.uploaded_at}
                            </div>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'order_management:project_file_download' project.pk 0 %}".replace('/0/', '/${file.id}/')
                           class="btn btn-outline-primary btn-sm" title="„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">
                            <i class="fas fa-download"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-sm delete-estimate-file-btn"
                                data-file-id="${file.id}" title="ÂâäÈô§">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.html(html);
    }

    // „Éï„Ç°„Ç§„É´„Çø„Ç§„Éó„Å´Âøú„Åò„Åü„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
    function getFileIcon(fileType) {
        if (!fileType) return 'fas fa-file';
        if (fileType.includes('pdf')) return 'fas fa-file-pdf text-danger';
        if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel text-success';
        if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word text-primary';
        if (fileType.includes('image')) return 'fas fa-file-image text-info';
        return 'fas fa-file';
    }

    // „Éï„Ç°„Ç§„É´ÈÅ∏Êäû„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ
    $(document).on('click', '.upload-estimate-file-btn', function() {
        $(this).closest('.estimate-files-section').find('.estimate-file-input').click();
    });

    // „Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Åü„Çâ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
    $(document).on('change', '.estimate-file-input', function() {
        const fileInput = this;
        const file = fileInput.files[0];

        if (!file) return;

        // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØ (10MB)
        if (file.size > 10 * 1024 * 1024) {
            if (typeof toastr !== 'undefined') {
                toastr.error('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅØ10MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            } else {
                showErrorModal('„Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÅØ10MB‰ª•‰∏ã„Å´„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            }
            fileInput.value = '';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('related_step', 'estimate');
        formData.append('description', 'Ë¶ãÁ©ç„ÇÇ„ÇäÊõ∏È°û');

        const uploadBtn = $(fileInput).closest('.estimate-files-section').find('.upload-estimate-file-btn');
        uploadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠...');

        $.ajax({
            url: '{% url "order_management:step_file_upload_ajax" project.pk %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success('„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
                    }
                    // „Éï„Ç°„Ç§„É´„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
                    estimateFilesData.unshift(response.file);  // ÂÖàÈ†≠„Å´ËøΩÂä†
                    renderEstimateFiles(estimateFilesData);
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                if (typeof toastr !== 'undefined') {
                    toastr.error(error);
                } else {
                    showErrorModal(error);
                }
            },
            complete: function() {
                uploadBtn.prop('disabled', false).html('<i class="fas fa-upload me-1"></i>„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû');
                fileInput.value = '';
            }
        });
    });

    // „Éï„Ç°„Ç§„É´ÂâäÈô§
    $(document).on('click', '.delete-estimate-file-btn', function() {
        const fileId = $(this).data('file-id');
        const fileItem = $(this).closest('.list-group-item');

        showConfirmModal('„Åì„ÅÆ„Éï„Ç°„Ç§„É´„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü', function() {

        $.ajax({
            url: '{% url "order_management:step_file_delete_ajax" project.pk 0 %}'.replace('/0/', `/${fileId}/`),
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success(response.message);
                    }
                    // „É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                    fileItem.fadeOut(300, function() {
                        $(this).remove();
                        // „Éï„Ç°„Ç§„É´„Åå0‰ª∂„Å´„Å™„Å£„Åü„Çâ„É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
                        if ($('.estimate-files-list .list-group-item').length === 0) {
                            $('.estimate-files-list').html('<small class="text-muted">„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åü„Éï„Ç°„Ç§„É´„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì</small>');
                        }
                    });

                    // „Éá„Éº„Çø„ÇÇÊõ¥Êñ∞
                    estimateFilesData = estimateFilesData.filter(f => f.id !== fileId);
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
                if (typeof toastr !== 'undefined') {
                    toastr.error(error);
                } else {
                    showErrorModal(error);
                }
            }
        });
        }); // showConfirmModal callbackÈñâ„ÅòÊã¨Âºß
    });

    // Â•ëÁ¥ÑÊó•„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name="contract_date"]', function() {
        var step = $('.progress-step[data-step="contract"]');
        var dateValue = $(this).val();

        // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠ò
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
            data: {
                contract_date: dateValue,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('‰øùÂ≠òÊàêÂäü:', response);

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                if (response && response.success) {
                    console.log('Â•ëÁ¥ÑÊó•„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', dateValue);

                    // projectData„ÇíÊõ¥Êñ∞
                    projectData.contract_date = dateValue;

                    // UI„ÇíÊõ¥Êñ∞
                    if (dateValue) {
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(dateValue));

                        // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºàÂ∑•‰∫ãÈñãÂßãÔºâ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
                        var nextStep = $('.progress-step[data-step="work_start"]');
                        if (!nextStep.hasClass('completed')) {
                            nextStep.addClass('active');
                        }
                    } else {
                        step.removeClass('completed');
                        step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
                    }

                    // ÈÄ≤ÊçóÁä∂Ê≥ÅÂÖ®‰Ωì„ÇíÊõ¥Êñ∞
                    updateProgressTimeline();
                    updateProgressStatus();
                    updateActiveStep();
                } else {
                    console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'Â•ëÁ¥ÑÊó•„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    } else {
                        showErrorModal('Â•ëÁ¥ÑÊó•„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                let errorMessage = 'Â•ëÁ¥ÑÊó•„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                } else if (xhr.status === 403) {
                    errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status === 404) {
                    errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status >= 500) {
                    errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                } else {
                    showErrorModal(errorMessage);
                }
            }
        });
    });

    // Ë´ãÊ±ÇÊõ∏Áô∫Ë°å„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name="invoice_issued"], select[name="invoice_issued"]', function() {
        var step = $('.progress-step[data-step="invoice"]');
        if ($(this).val() === 'true') {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>Áô∫Ë°åÊ∏à„Åø');
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('Êú™Áô∫Ë°å');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // Â∑•‰∫ãÈñãÂßãÊó•„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name="work_start_date"]', function() {
        var step = $('.progress-step[data-step="work_start"]');
        var isCompleted = $('input[name="work_start_completed"]').is(':checked');
        var dateValue = $(this).val();

        if (isCompleted && dateValue) {
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Ç™„É≥„ÅßÊó•‰ªò„ÇÇ„ÅÇ„Çå„Å∞ÂÆå‰∫Ü
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(dateValue));
        } else if (dateValue) {
            // Êó•‰ªò„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÅØ‰∫àÂÆö„Å®„Åó„Å¶Ë°®Á§∫
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ' + formatDate(dateValue));
        } else {
            // Êó•‰ªò„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊú™ÂÆå‰∫Ü
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // Â∑•‰∫ãÈñãÂßãÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name="work_start_completed"]', function() {
        var step = $('.progress-step[data-step="work_start"]');
        var workStartDate = $('input[name="work_start_date"]').val();

        if ($(this).is(':checked')) {
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Ç™„É≥„ÅÆÂ†¥Âêà
            step.addClass('completed');
            if (workStartDate) {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(workStartDate));
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü');
            }

            // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºàÂ∑•‰∫ãÁµÇ‰∫ÜÔºâ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Ç™„Éï„ÅÆÂ†¥Âêà
            step.removeClass('completed');
            if (workStartDate) {
                // Êó•‰ªò„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰∫àÂÆö„Å®„Åó„Å¶Ë°®Á§∫
                step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ' + formatDate(workStartDate));
            } else {
                step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
            }
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // Â∑•‰∫ãÁµÇ‰∫ÜÊó•„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name="work_end_date"]', function() {
        var step = $('.progress-step[data-step="work_end"]');
        var isCompleted = $('input[name="work_end_completed"]').is(':checked');
        var dateValue = $(this).val();

        if (isCompleted && dateValue) {
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Ç™„É≥„ÅßÊó•‰ªò„ÇÇ„ÅÇ„Çå„Å∞ÂÆå‰∫Ü
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(dateValue));
        } else if (dateValue) {
            // Êó•‰ªò„ÅÆ„Åø„ÅÆÂ†¥Âêà„ÅØ‰∫àÂÆö„Å®„Åó„Å¶Ë°®Á§∫
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ' + formatDate(dateValue));
        } else {
            // Êó•‰ªò„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÊú™ÂÆå‰∫Ü
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // Â∑•‰∫ãÁµÇ‰∫ÜÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name="work_end_completed"]', function() {
        var step = $('.progress-step[data-step="work_end"]');
        var workEndDate = $('input[name="work_end_date"]').val();

        if ($(this).is(':checked')) {
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Ç™„É≥„ÅÆÂ†¥Âêà
            step.addClass('completed');
            if (workEndDate) {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(workEndDate));
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü');
            }

            // Ê¨°„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºàË´ãÊ±ÇÊõ∏Áô∫Ë°åÔºâ„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„Ç™„Éï„ÅÆÂ†¥Âêà
            step.removeClass('completed');
            if (workEndDate) {
                // Êó•‰ªò„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ‰∫àÂÆö„Å®„Åó„Å¶Ë°®Á§∫
                step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ' + formatDate(workEndDate));
            } else {
                step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
            }
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // ÂÆå‰∫ÜÂ†±Âëä„Éï„Ç°„Ç§„É´„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂá¶ÁêÜ
    $(document).on('change', '#completionReportFileInput', function() {
        const fileInput = this;
        const file = fileInput.files[0];

        if (!file) {
            console.log('„Éï„Ç°„Ç§„É´„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
            return;
        }

        console.log('ÂÆå‰∫ÜÂ†±Âëä„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ‰∏≠:', file.name);

        // FormData„Çí‰Ωø„Å£„Å¶„Éï„Ç°„Ç§„É´„ÇíÈÄÅ‰ø°
        const formData = new FormData();
        formData.append('completion_report_file', file);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('ajax_save', 'true');

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: formData,
            processData: false,  // FormData„Çí‰Ωø„ÅÜÂ†¥Âêà„ÅØÂøÖÈ†à
            contentType: false,  // FormData„Çí‰Ωø„ÅÜÂ†¥Âêà„ÅØÂøÖÈ†à
            success: function(response) {
                console.log('„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÊàêÂäü:', response);
                if (response && response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success('ÂÆå‰∫ÜÂ†±Âëä„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
                    } else {
                        showErrorModal('ÂÆå‰∫ÜÂ†±Âëä„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü');
                    }
                    // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶ÊúÄÊñ∞„ÅÆÁä∂ÊÖã„ÇíË°®Á§∫
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    console.error('„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂ§±Êïó:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || '„Éï„Ç°„Ç§„É´„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    } else {
                        showErrorModal('„Éï„Ç°„Ç§„É´„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('„Éï„Ç°„Ç§„É´„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error);
                } else {
                    showErrorModal('„Éï„Ç°„Ç§„É´„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error);
                }
            }
        });
    });

    // ÂÆå‰∫ÜÂ†±ÂëäÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂá¶ÁêÜ
    $(document).on('change', '#completion_report_completed', function() {
        const isChecked = $(this).is(':checked');
        console.log('ÂÆå‰∫ÜÂ†±ÂëäÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅåÂ§âÊõ¥„Åï„Çå„Åæ„Åó„Åü:', isChecked);

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',
            data: {
                completion_report_completed: isChecked ? 'on' : '',
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('‰øùÂ≠òÊàêÂäü:', response);
                if (response && response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success('ÂÆå‰∫ÜÂ†±Âëä„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                    }
                    // ÈÄ≤ÊçóÁä∂Ê≥Å„ÇíÊõ¥Êñ∞
                    updateProgressTimeline();
                    updateProgressStatus();
                } else {
                    console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error);
                }
            }
        });
    });

    // === ÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„ÉóÁÆ°ÁêÜÊ©üËÉΩ ===

    // ÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÁä∂ÊÖãÂ§âÊõ¥„ÇíÁõ£Ë¶ñ„Åó„Å¶Âç≥Â∫ß„Å´‰øùÂ≠ò
    $(document).on('change', 'input[name$="_date"], input[name$="_completed"], input[name$="_value"]', function() {
        const inputName = $(this).attr('name');
        const stepName = inputName.replace(/_date$|_completed$|_value$/, '');
        const step = $('.progress-step[data-step="' + stepName + '"]');

        if (!step.length) return;

        // „Çπ„ÉÜ„ÉÉ„Éó„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
        updateStepStatus(step, $(this));
    });

    // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éï„Ç£„Éº„É´„ÉâÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name^="dynamic_field_"], select[name^="dynamic_field_"], textarea[name^="dynamic_field_"]', function() {
        const fieldName = $(this).attr('name');
        // dynamic_field_step_attendance_scheduled_date -> step_attendance
        // ÊúÄÂæå„ÅÆ„Éï„Ç£„Éº„É´„ÉâÂêçÔºàscheduled_date, actual_date, completed, valueÔºâ„ÇíÂâäÈô§„Åó„Å¶stepKey„ÇíÂèñÂæó
        const stepKey = fieldName.replace(/^dynamic_field_/, '').replace(/_(scheduled_date|actual_date|completed|value)$/, '');
        const $step = $(`.progress-step[data-step="${stepKey}"]`);

        // ‰øùÂ≠òÁä∂ÊÖã„ÇíË°®Á§∫
        showSavingStatus('saving');

        // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´‰øùÂ≠òÔºàË§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„Éï„Ç£„Éº„É´„ÉâÔºâ
        const fieldValue = $(this).is(':checkbox') ? $(this).is(':checked') : $(this).val();
        const data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ajax_save: 'true'
        };
        data[fieldName] = fieldValue;

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
            data: data,
            success: function(response) {
                console.log('‰øùÂ≠òÊàêÂäü:', response);

                // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                if (response && response.success) {
                    console.log('Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„Éï„Ç£„Éº„É´„Éâ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', fieldName, fieldValue);

                    // ‰øùÂ≠òÊàêÂäü„ÇíË°®Á§∫
                    showSavingStatus('saved');

                    // ‰øùÂ≠òÊàêÂäüÂæå„Å´UI„ÇíÊõ¥Êñ∞
                    if ($step.length > 0) {
                        // availableSteps„Åã„ÇâË©≤ÂΩì„Åô„Çã„Çπ„ÉÜ„ÉÉ„ÉóÂÆöÁæ©„ÇíÂèñÂæó
                        const stepData = availableSteps.find(s => s.key === stepKey);

                        if (stepData && stepData.type === 'complex') {
                            // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÂÜçË®àÁÆó
                            const status = getComplexStepStatus(stepData, $step);

                            // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„ÇíËøΩÂä†/ÂâäÈô§
                            if (status.completed) {
                                $step.addClass('completed');
                                $step.removeClass('active');
                            } else {
                                $step.removeClass('completed');
                            }

                            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
                            $step.find('.progress-step-date').html(status.statusText);

                            // ÈÄ≤Êçó„Çø„Ç§„É†„É©„Ç§„É≥„Å®Áä∂Ê≥Å„Éê„Éº„ÇíÊõ¥Êñ∞
                            updateProgressTimeline();
                            updateProgressStatus();
                        }
                    }
                } else {
                    console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    showSavingStatus('error');
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„Éï„Ç£„Éº„É´„Éâ„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                    field: fieldName,
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                // ‰øùÂ≠ò„Ç®„É©„Éº„ÇíË°®Á§∫
                showSavingStatus('error');

                let errorMessage = 'Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„Éï„Ç£„Éº„É´„Éâ„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                } else if (xhr.status === 403) {
                    errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status === 404) {
                    errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                } else if (xhr.status >= 500) {
                    errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                }
            }
        });
    });

    // „Çπ„ÉÜ„ÉÉ„ÉóÁä∂ÊÖã„ÅÆÊõ¥Êñ∞
    function updateStepStatus(step, input) {
        const inputName = input.attr('name');
        const value = input.val();
        const isChecked = input.is(':checked');
        const stepKey = step.data('step');

        // Âè≥ÂÅ¥„ÅÆË°®Á§∫Êõ¥Êñ∞
        if (inputName.includes('actual_date') && value) {
            // ÂÆüÊñΩÊó•„ÅÆÂ†¥Âêà„ÅØ„ÄåÂÆå‰∫Ü„Äç
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(value));
        } else if (inputName.includes('issued_date') && value) {
            // üîß FIX: Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„ÅÆÂ†¥Âêà„ÅØ„ÄÅÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
            if (inputName === 'estimate_issued_date') {
                const estimateCompletedCheckbox = $('#estimateCompleted');
                const isEstimateCompleted = estimateCompletedCheckbox.is(':checked');

                console.log('üîß updateStepStatus - estimate_issued_date:', {
                    value: value,
                    isEstimateCompleted: isEstimateCompleted,
                    currentClasses: step.attr('class')
                });

                if (isEstimateCompleted) {
                    step.addClass('completed');
                    step.removeClass('active');
                    step.find('.progress-step-date').html('<span class="badge bg-success">Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊ∏à„Åø</span> ' + formatDate(value));
                } else {
                    step.removeClass('completed');
                    step.addClass('active');
                    step.find('.progress-step-date').html('<span class="badge bg-warning">Ë¶ãÁ©çÊõ∏ÂæÖ„Å°</span> ' + formatDate(value));
                }

                console.log('üîß updateStepStatus - after update:', {
                    newClasses: step.attr('class')
                });
            } else {
                // „Åù„ÅÆ‰ªñ„ÅÆÁô∫Ë°åÊó•„Éï„Ç£„Éº„É´„Éâ
                step.addClass('completed');
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(value));
            }
        } else if (inputName.includes('scheduled_date') && value) {
            // ‰∫àÂÆöÊó•„ÅÆÂ†¥Âêà„ÅØ„Äå‰∫àÂÆö„Äç
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ' + formatDate(value));
        } else if (inputName.endsWith('_completed') && isChecked) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü');
        } else if (inputName.endsWith('_value') && value) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + value);
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
        }

        // ÈÄ≤Êçó„Çø„Ç§„É†„É©„Ç§„É≥„ÇÇÊõ¥Êñ∞
        updateProgressTimeline();
        // ÈÄ≤ÊçóÁä∂Ê≥Å„Éê„Éº„ÇÇÊõ¥Êñ∞
        updateProgressStatus();
    }


    // Êó•‰ªò„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÈñ¢Êï∞
    function formatDate(dateString) {
        if (!dateString || dateString === 'undefined' || dateString === undefined) return 'Êó•‰ªòÊú™Ë®≠ÂÆö';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'Êó•‰ªòÊú™Ë®≠ÂÆö';
            // Êó•Êú¨Ë™ûÂΩ¢Âºè„ÅßÊúà/Êó•„ÇíË°®Á§∫
            return date.toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
        } catch (e) {
            return 'Êó•‰ªòÊú™Ë®≠ÂÆö';
        }
    }

    // ÈÄ≤Êçó„Çø„Ç§„É†„É©„Ç§„É≥„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    function updateProgressTimeline() {
        const timeline = $('#progressTimeline');
        timeline.empty();

        // Âè≥ÂÅ¥„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Åã„ÇâÁõ¥Êé•ÊÉÖÂ†±„ÇíÂèñÂæó
        const currentSteps = [];

        // activeStepsÂÜÖ„ÅÆÂÖ®„Çπ„ÉÜ„ÉÉ„Éó„Çí„Çπ„Ç≠„É£„É≥„Åó„Å¶Â∑¶ÂÅ¥„Å´Ë°®Á§∫
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');
            const isCompleted = $step.hasClass('completed');

            // „Çπ„ÉÜ„ÉÉ„ÉóÂêç„ÇíÂèñÂæóÔºà.progress-step-label„ÇØ„É©„Çπ„Åã„ÇâÁõ¥Êé•ÂèñÂæóÔºâ
            const stepNameElement = $step.find('.progress-step-label');
            let stepName = stepNameElement.text().trim();

            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂèñÂæó
            const statusElement = $step.find('.progress-step-date');
            let statusText = null;
            if (statusElement.length > 0) {
                const statusContent = statusElement.text().trim();
                if (statusContent && statusContent !== 'Êú™ÂÆå‰∫Ü' && statusContent !== 'Êú™Ë®≠ÂÆö') {
                    // ÂÆå‰∫Ü„ÄÅ‰∫àÂÆö„ÄÅÈñãÂßã„ÅÆ„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Çí‰øùÊåÅ„Åó„Åü„Åæ„ÅæÂèñÂæó
                    statusText = statusContent;
                }
            }

            currentSteps.push({
                key: stepKey,
                name: stepName,
                completed: isCompleted,
                statusText: statusText
            });
        });

        // ‰ª•‰∏ã„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà - Âè≥ÂÅ¥„Åã„ÇâÁõ¥Êé•Ë™≠„ÅøÂèñ„Çã„Åü„ÇÅ‰∏çË¶Å
        /*
        // Âü∫Êú¨„Çπ„ÉÜ„ÉÉ„Éó„ÇíËøΩÂä†ÔºàÁèæÂú®„ÅÆ„Éï„Ç©„Éº„É†ÂÄ§„Çí‰ΩøÁî®Ôºâ
        const basicSteps = [
        */

        // „Çø„Ç§„É†„É©„Ç§„É≥„ÇíÊßãÁØâ
        let previousCompleted = true;
        currentSteps.forEach(step => {
            // „Çπ„ÉÜ„ÉÉ„ÉóÂêç„ÅåÊúâÂäπ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            if (!step.name || step.name === 'undefined' || step.name === undefined) {
                console.warn('Skipping timeline item with invalid name:', step);
                return;
            }

            // „Çπ„ÉÜ„ÉÉ„Éó„ÅÆÁä∂ÊÖã„ÇíÂà§ÂÆö
            let statusClass = '';
            const stepElement = $(`.progress-step[data-step="${step.key}"]`);

            if (stepElement.length > 0) {
                // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂ†¥Âêà„ÄÅ„Éï„Ç£„Éº„É´„ÉâÂÄ§„ÇíÁ¢∫Ë™ç
                const scheduledDate = stepElement.find(`input[name*="scheduled_date"]`).val();
                const actualDate = stepElement.find(`input[name*="actual_date"]`).val();
                const completedCheckbox = stepElement.find(`input[name*="completed"]`).is(':checked');
                const issuedDate = stepElement.find(`input[name*="issued_date"]`).val();
                const notRequired = stepElement.find(`input[name*="not_required"]`).is(':checked');

                // Áä∂ÊÖã„ÅÆÂÑ™ÂÖàÈ†Ü‰Ωç: verified > completed > scheduled > „Éá„Éï„Ç©„É´„Éà
                if (completedCheckbox) {
                    // ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å´„ÉÅ„Çß„ÉÉ„ÇØ„ÅÇ„Çä ‚Üí ÊøÉ„ÅÑÁ∑ë
                    statusClass = 'verified';
                } else if (actualDate || issuedDate || notRequired) {
                    // ÂÆå‰∫ÜÊó•„Åæ„Åü„ÅØÁô∫Ë°åÊó•„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çã ‚Üí Á∑ë
                    statusClass = 'completed';
                } else if (scheduledDate) {
                    // ‰∫àÂÆöÊó•„ÅÆ„ÅøÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çã ‚Üí ÈªÑËâ≤
                    statusClass = 'scheduled';
                } else if (step.completed) {
                    // Âè≥ÂÅ¥„Åß completed „ÇØ„É©„Çπ„Åå„Å§„ÅÑ„Å¶„ÅÑ„Çã ‚Üí Á∑ë
                    statusClass = 'completed';
                }
                // „Åù„Çå‰ª•Â§ñÔºà‰Ωï„ÇÇÂÖ•Âäõ„Å™„ÅóÔºâ ‚Üí „Ç∞„É¨„ÉºÔºà„ÇØ„É©„Çπ„Å™„ÅóÔºâ
            } else {
                // Ë¶ÅÁ¥†„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑÂ†¥Âêà„ÅØÂæìÊù•„ÅÆ„É≠„Ç∏„ÉÉ„ÇØ
                const isCompleted = step.completed;
                if (isCompleted) {
                    statusClass = 'completed';
                }
            }

            // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÅÆËâ≤„ÇíÊ±∫ÂÆöÔºà‰∫àÂÆö„ÅØÈªÑËâ≤„ÄÅÂÆå‰∫Ü„ÅØÁ∑ëÔºâ
            let statusColor = 'text-success';
            if (step.statusText && step.statusText.includes('‰∫àÂÆö:')) {
                statusColor = 'text-warning';
            }
            const statusHtml = step.statusText ?
                `<small class="${statusColor} d-block">${step.statusText}</small>` : '';

            timeline.append(`
                <div class="timeline-item ${statusClass}">
                    <strong>${step.name}</strong>
                    ${statusHtml}
                </div>
            `);

            if (statusClass === 'completed' || statusClass === 'verified') {
                previousCompleted = true;
            } else {
                previousCompleted = false;
            }
        });
    }

    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çπ„ÉÜ„ÉÉ„Éó„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞ÔºàÊúÄÂàù„ÅÆÊú™ÂÆå‰∫Ü„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Åø„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„ÇãÔºâ
    function updateActiveStep() {
        // „Åô„Åπ„Å¶„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Åã„Çâactive„ÇØ„É©„Çπ„ÇíÂâäÈô§
        $('#activeSteps .progress-step').removeClass('active');

        // ÊúÄÂàù„ÅÆÊú™ÂÆå‰∫Ü„Çπ„ÉÜ„ÉÉ„Éó„ÇíË¶ã„Å§„Åë„Å¶active„ÇØ„É©„Çπ„Çí‰ªò‰∏é
        let foundFirstIncomplete = false;
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            if (!foundFirstIncomplete && !$step.hasClass('completed')) {
                $step.addClass('active');
                foundFirstIncomplete = true;
            }
        });
    }

    // „Åô„Åπ„Å¶„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
    function updateAllStepStatuses() {
        $('.progress-step[data-step]').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');

            // availableSteps„Åã„ÇâË©≤ÂΩì„Åô„Çã„Çπ„ÉÜ„ÉÉ„ÉóÂÆöÁæ©„ÇíÂèñÂæó
            const stepData = availableSteps.find(s => s.key === stepKey);

            if (stepData && stepData.type === 'complex') {
                // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®àÁÆó
                const status = getComplexStepStatus(stepData, $step);

                // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„ÇíËøΩÂä†
                if (status.completed) {
                    $step.addClass('completed');
                } else {
                    $step.removeClass('completed');
                }

                // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
                $step.find('.progress-step-date').html(status.statusText);
            }
        });
    }

    // ÈÄ≤ÊçóÁä∂Ê≥Å„Éê„Éº„Å®„Éï„Çß„Éº„Ç∫„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞
    // Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÊõ¥Êñ∞„Åô„ÇãÈñ¢Êï∞ÔºàÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„ÉóÁÆ°ÁêÜÂØæÂøúÔºâ
    function updateNextActionAndStep(phase, allSteps) {
        let nextAction = 'ÂÆå‰∫Ü';

        // ÂÖ®„Å¶„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóË¶ÅÁ¥†„ÇíÂèñÂæóÔºàË°®Á§∫È†ÜÂ∫èÈ†ÜÔºâ
        const stepElements = $('#activeSteps .progress-step');

        // Êú™ÂÆå‰∫Ü„ÅÆÊúÄÂàù„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÇíË¶ã„Å§„Åë„Çã
        let currentIncompleteStep = null;

        stepElements.each(function() {
            const $step = $(this);
            let isCompleted = $step.hasClass('completed');
            const stepName = $step.find('.progress-step-label').text().trim();
            const stepKey = $step.data('step');

            // üîß FIX: Special handling for estimate step - check BOTH estimate_not_required AND estimate_completed
            if (stepKey === 'estimate' && !isCompleted) {
                const estimateNotRequired = $step.find('#estimateNotRequired').is(':checked');
                const estimateIssuedDate = $step.find('input[name="estimate_issued_date"]').val();
                const estimateCompleted = $step.find('#estimateCompleted').is(':checked');

                console.log('üîß updateNextActionAndStep - estimate check:', {
                    estimateNotRequired: estimateNotRequired,
                    estimateIssuedDate: estimateIssuedDate,
                    estimateCompleted: estimateCompleted
                });

                // Only mark as completed if EITHER:
                // 1. estimate_not_required is checked, OR
                // 2. estimate_completed checkbox is checked
                if (estimateNotRequired || estimateCompleted) {
                    isCompleted = true;
                    // Make sure the step has the completed class
                    if (!$step.hasClass('completed')) {
                        $step.addClass('completed');
                        $step.removeClass('active');
                        console.log('üîß updateNextActionAndStep - marking estimate as completed');
                    }
                }
            }

            // ÊúÄÂàù„ÅÆÊú™ÂÆå‰∫Ü„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Åø„ÇíÊé¢„Åô
            if (!isCompleted && !currentIncompleteStep) {
                currentIncompleteStep = {
                    element: $step,
                    name: stepName,
                    key: stepKey
                };
            }
        });

        // ÁèæÂú®„ÅÆÊú™ÂÆå‰∫Ü„Çπ„ÉÜ„ÉÉ„Éó„Åå„ÅÇ„ÇãÂ†¥Âêà„ÄÅÊ¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÊ±∫ÂÆö
        if (currentIncompleteStep) {
            const $currentStep = currentIncompleteStep.element;
            const stepName = currentIncompleteStep.name;

            // ‰∫àÂÆöÊó•„Éï„Ç£„Éº„É´„Éâ„ÇíÁ¢∫Ë™ç
            const scheduledDateInput = $currentStep.find('input[name*="scheduled_date"]');
            const actualDateInput = $currentStep.find('input[name*="actual_date"]');
            const completedCheckbox = $currentStep.find('input[type="checkbox"][name*="completed"]');

            const hasScheduledDate = scheduledDateInput.length > 0 && scheduledDateInput.val();
            const hasActualDate = actualDateInput.length > 0 && actualDateInput.val();
            const isChecked = completedCheckbox.length > 0 && completedCheckbox.is(':checked');

            // Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂà§ÂÆö
            if (completedCheckbox.length > 0 && !isChecked) {
                // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„ÅÇ„ÇãÂ†¥Âêà
                if (hasActualDate) {
                    nextAction = `${stepName}ÔºöÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
                } else if (hasScheduledDate) {
                    // ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„ÅãÊú™Êù•„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const scheduledDate = scheduledDateInput.val();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const scheduledDateObj = new Date(scheduledDate);

                    if (scheduledDateObj < today) {
                        // ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„ÅÆÂ†¥Âêà„ÅØÂÆå‰∫Ü„Å®Ë¶ã„Å™„Åô
                        nextAction = `${stepName}ÔºöÂÆå‰∫Ü`;
                    } else {
                        // ‰∫àÂÆöÊó•„ÅåÊú™Êù•„ÅÆÂ†¥Âêà„ÅØÂæÖÊ©ü‰∏≠
                        nextAction = `${stepName}Ôºö‰∫àÂÆöÊó•ÂæÖ„Å°Ôºà${scheduledDate}Ôºâ`;
                    }
                } else {
                    nextAction = `${stepName}Ôºö‰∫àÂÆöÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
                }
            } else if (actualDateInput.length > 0 && !hasActualDate) {
                // ÂÆüÊñΩÊó•„Éï„Ç£„Éº„É´„Éâ„Åå„ÅÇ„ÇãÂ†¥Âêà
                if (hasScheduledDate) {
                    nextAction = `${stepName}ÔºöÂÆüÊñΩÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
                } else {
                    nextAction = `${stepName}Ôºö‰∫àÂÆöÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
                }
            } else if (scheduledDateInput.length > 0 && !hasScheduledDate) {
                // ‰∫àÂÆöÊó•„ÅÆ„Åø„ÅÆÂ†¥Âêà
                nextAction = `${stepName}Ôºö‰∫àÂÆöÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
            } else {
                // „Åù„ÅÆ‰ªñ„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Çø„Ç§„Éó
                nextAction = `${stepName}ÔºöÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
            }

        }

        // UI„ÇíÊõ¥Êñ∞Ôºà„Éê„ÉÉ„Ç∏ÂΩ¢Âºè„Åß„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºâ
        $('#nextActionText').html(formatNextActionWithBadge(nextAction));

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÁÆ°ÁêÜ„Ç´„Éº„ÉâÂÜÖ„ÅÆNext Action„ÇÇÊõ¥Êñ∞
        $('#overallNextAction').html(formatNextActionWithBadge(nextAction));

        console.log('üìå Next Action updated:', {
            action: nextAction,
            currentStep: currentIncompleteStep ? currentIncompleteStep.name : 'none'
        });
    }

    // Next Action„Çí„Éê„ÉÉ„Ç∏ÂΩ¢Âºè„Å´„Éï„Ç©„Éº„Éû„ÉÉ„Éà„Åô„ÇãÈñ¢Êï∞
    function formatNextActionWithBadge(value) {
        if (!value || value === 'ÂÆå‰∫Ü' || value === '-' || !value.includes('Ôºö')) {
            return value;
        }

        const parts = value.split('Ôºö');
        const stepName = parts[0];
        const action = parts.slice(1).join('Ôºö'); // Ë§áÊï∞„ÅÆ„ÄåÔºö„Äç„Åå„ÅÇ„ÇãÂ†¥Âêà„Å´ÂØæÂøú

        return `<span class="badge bg-white border text-dark me-1" style="font-size: 0.65rem;">${stepName}</span>${action}`;
    }

    // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÁÆ°ÁêÜ„Ç´„Éº„ÉâÂÜÖ„ÅÆÂÖ®‰Ωì„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÇíÊõ¥Êñ∞
    function updateOverallProgressBar(completedSteps, totalSteps, percentage, phase, color) {
        console.log(`üìä Updating overall progress bar: ${completedSteps}/${totalSteps} = ${percentage}% | Phase: ${phase} (${color})`);

        // NGÊ°à‰ª∂„ÅÆÂ†¥Âêà„ÅØÁâπÂà•Ë°®Á§∫
        if (phase === 'NG') {
            $('#overallProgressBar').css('width', '100%');
            $('#overallProgressText').text('NG');
            $('#overallProgressBar').removeClass('bg-danger bg-warning bg-info bg-success bg-verified').addClass('bg-secondary');
            $('#overallPhase').text('NG').removeClass().addClass('badge bg-secondary').css('font-size', '0.6rem');
            $('#overallStepCount').text(''); // „Ç´„Ç¶„É≥„ÉàÈùûË°®Á§∫
            return;
        }

        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆÂπÖ„ÇíÊõ¥Êñ∞
        $('#overallProgressBar').css('width', `${percentage}%`);

        // „ÉÜ„Ç≠„Çπ„ÉàË°®Á§∫„ÇíÊõ¥Êñ∞Ôºà„ÄåÂÆå‰∫ÜÊï∞/Á∑èÊï∞„ÄçÂΩ¢ÂºèÔºâ
        $('#overallProgressText').text(`${completedSteps}/${totalSteps}`);

        // „Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÅÆËâ≤„ÇíÂ§âÊõ¥ÔºàÈÄ≤ÊçóÁéá„Å´Âøú„Åò„Å¶Ôºâ
        $('#overallProgressBar').removeClass('bg-danger bg-warning bg-info bg-success bg-verified bg-secondary');
        if (percentage === 100) {
            $('#overallProgressBar').addClass('bg-success');
        } else if (percentage >= 70) {
            $('#overallProgressBar').addClass('bg-info');
        } else if (percentage >= 40) {
            $('#overallProgressBar').addClass('bg-warning');
        } else if (percentage > 0) {
            $('#overallProgressBar').addClass('bg-warning');
        } else {
            $('#overallProgressBar').addClass('bg-secondary');
        }

        // „Éï„Çß„Éº„Ç∫ÔºàÈÄ≤ÊçóÁä∂Ê≥ÅÔºâ„ÇíÊõ¥Êñ∞
        $('#overallPhase').text(phase).removeClass().addClass(`badge bg-${color}`).css('font-size', '0.6rem');

        // „Çπ„ÉÜ„ÉÉ„Éó„Ç´„Ç¶„É≥„Éà„ÇíÊõ¥Êñ∞
        $('#overallStepCount').text(`${completedSteps}/${totalSteps}`);
    }

    function updateProgressStatus() {
        // NGÊ°à‰ª∂„ÅÆÂ†¥Âêà„ÅØÁâπÂà•Ë°®Á§∫
        if (projectStatus === 'NG') {
            console.log('NGÊ°à‰ª∂„ÅÆ„Åü„ÇÅ„ÄÅNGË°®Á§∫„ÇíË®≠ÂÆö„Åó„Åæ„Åô');
            updateOverallProgressBar(0, 5, 0, 'NG', 'secondary');
            return;
        }

        // Âè≥ÂÅ¥„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Åã„ÇâÁõ¥Êé•ÂÆå‰∫ÜÁä∂Ê≥Å„ÇíÂèñÂæó
        const allSteps = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // activeStepsÂÜÖ„ÅÆÂÖ®„Çπ„ÉÜ„ÉÉ„Éó„Çí„Çπ„Ç≠„É£„É≥
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');
            let isCompleted = $step.hasClass('completed');

            // üîß FIX: „Çµ„Éº„Éê„ÉºÂÅ¥„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØ - ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„ÅÆÂ†¥Âêà„ÇÇÂÆå‰∫ÜÊâ±„ÅÑ
            // ÂÆå‰∫ÜÂà§ÂÆö: is_completed OR scheduled_date „ÅåÈÅéÂéª
            if (!isCompleted) {
                const scheduledDateInput = $step.find('input[name*="scheduled_date"]');
                if (scheduledDateInput.length > 0 && scheduledDateInput.val()) {
                    const scheduledDate = new Date(scheduledDateInput.val());
                    if (scheduledDate < today) {
                        isCompleted = true;
                        console.log(`üîß Progress check - ${stepKey}: ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„ÅÆ„Åü„ÇÅÂÆå‰∫ÜÊâ±„ÅÑ (${scheduledDateInput.val()})`);
                    }
                }
            }

            console.log(`üîç Progress check - ${stepKey}: completed=${isCompleted}, has class=${$step.hasClass('completed')}`);
            allSteps.push({ key: stepKey, completed: isCompleted });
        });

        // ÂÆå‰∫ÜÁéáË®àÁÆó
        const completedSteps = allSteps.filter(step => step.completed).length;
        const totalSteps = allSteps.length;
        const percentage = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

        console.log(`üìä Progress calculation: ${completedSteps}/${totalSteps} = ${percentage}%`);
        console.log('All steps:', allSteps);

        // „Éï„Çß„Éº„Ç∫Âà§ÂÆöÔºàget_current_project_stage()„Å®Âêå„Åò„É≠„Ç∏„ÉÉ„ÇØÔºâ
        let phase = 'Êú™ÈñãÂßã';
        let color = 'secondary';

        // ÂÆåÂ∑•Êó•„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÊúÄÂÑ™ÂÖàÔºâ
        const completionElement = $('.progress-step[data-step="completion"]');
        const completionCompleted = completionElement.find('input[name*="completed"]').is(':checked');
        const completionActualDate = completionElement.find('input[name*="actual_date"]').val();
        const workEndDate = $('input[name="work_end_date"]').val();

        // Priority 1: Check if completion step has 'completed' class or checkbox is checked
        if (completionElement.hasClass('completed') || completionCompleted || $('#workEndCompleted').is(':checked')) {
            phase = 'ÂÆåÂ∑•';
            color = 'verified';
        }
        // Priority 2: Check if completion actual date or work end date is filled
        else if (completionActualDate || workEndDate) {
            phase = 'ÂÆåÂ∑•';
            color = 'success';
        }
        // ÁùÄÂ∑•Êó•„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        else {
            const constructionElement = $('.progress-step[data-step="step_construction_start"]');
            const constructionCompleted = $('#workStartCompleted').is(':checked');
            const constructionActualDate = constructionElement.find('input[name*="actual_date"]').val();
            const constructionScheduledDate = constructionElement.find('input[name*="scheduled_date"]').val() || $('input[name="work_start_date"]').val();

            if (constructionCompleted) {
                phase = 'Â∑•‰∫ã‰∏≠';
                color = 'verified';
            } else if (constructionActualDate) {
                phase = 'Â∑•‰∫ã‰∏≠';
                color = 'success';
            } else if (constructionScheduledDate) {
                // Check if scheduled date is in the past
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset time to midnight for date-only comparison
                const scheduledDate = new Date(constructionScheduledDate);

                if (scheduledDate < today) {
                    // Past scheduled date - should be in progress
                    phase = 'Â∑•‰∫ã‰∏≠„ÅÆ‰∫àÂÆö';
                    color = 'success';
                } else {
                    // Future scheduled date - waiting
                    phase = 'ÁùÄÂ∑•Êó•ÂæÖ„Å°';
                    color = 'warning';
                }
            }
            // Ë¶ãÁ©ç„ÇÇ„Çä„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            else {
                const estimateIssuedDate = $('input[name="estimate_issued_date"]').val();
                const estimateNotRequired = $('#estimateNotRequired').is(':checked');

                if (estimateIssuedDate) {
                    phase = 'Ë¶ãÁ©ç„ÇÇ„ÇäÂØ©Êüª‰∏≠';
                    color = 'warning';
                } else {
                    // Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊó•„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„ÄÅÂâç„ÅÆÂ∑•Á®ã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    // ÁèæË™ø„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const surveyElement = $('.progress-step[data-step="step_survey"]');
                    const surveyActualDate = surveyElement.find('input[name*="actual_date"]').val();
                    const surveyScheduledDate = surveyElement.find('input[name*="scheduled_date"]').val();
                    const surveyCompleted = surveyElement.find('input[name*="completed"]').is(':checked');

                    // Check if scheduled date is in the past
                    let isSurveyScheduledPast = false;
                    if (surveyScheduledDate) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const scheduledDate = new Date(surveyScheduledDate);
                        isSurveyScheduledPast = scheduledDate < today;
                    }

                    if (surveyActualDate || surveyCompleted || isSurveyScheduledPast) {
                        phase = 'ÁèæË™øÊ∏à„Åø';
                        color = 'success';
                    } else if (surveyScheduledDate) {
                        phase = 'ÁèæË™øÂæÖ„Å°';
                        color = 'warning';
                    } else {
                        // Á´ã„Å°‰ºö„ÅÑ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                        const attendanceElement = $('.progress-step[data-step="step_attendance"]');
                        const attendanceActualDate = attendanceElement.find('input[name*="actual_date"]').val();
                        const attendanceScheduledDate = attendanceElement.find('input[name*="scheduled_date"]').val();
                        const attendanceCompleted = attendanceElement.find('input[name*="completed"]').is(':checked');

                        // Check if scheduled date is in the past
                        let isScheduledPast = false;
                        if (attendanceScheduledDate) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const scheduledDate = new Date(attendanceScheduledDate);
                            isScheduledPast = scheduledDate < today;
                        }

                        if (attendanceActualDate || attendanceCompleted || isScheduledPast) {
                            phase = 'Á´ã„Å°‰ºö„ÅÑÊ∏à„Åø';
                            color = 'success';
                        } else if (attendanceScheduledDate) {
                            phase = 'Á´ã„Å°‰ºö„ÅÑÂæÖ„Å°';
                            color = 'warning';
                        } else {
                            phase = 'Êú™ÈñãÂßã';
                            color = 'secondary';
                        }
                    }
                }
            }
        }

        // UIÊõ¥Êñ∞
        $('#progressPhase').text(phase).removeClass().addClass(`text-${color}`);
        $('#progressBar').removeClass().addClass(`progress-bar bg-${color}`).css('width', `${percentage}%`).attr('aria-valuenow', percentage);
        $('#progressPercentage').text(`${completedSteps}/${totalSteps}`);
        $('#progressStatusCard').removeClass().addClass(`card progress-status-card border-${color}`);
        $('#progressStatusHeader').removeClass().addClass(`card-header bg-${color} text-white`);

        // „Éó„É≠„Ç∏„Çß„ÇØ„ÉàÊÆµÈöéÁÆ°ÁêÜ„Ç´„Éº„ÉâÂÜÖ„ÅÆÂÖ®‰Ωì„Éó„É≠„Ç∞„É¨„Çπ„Éê„Éº„ÇíÊõ¥Êñ∞
        updateOverallProgressBar(completedSteps, totalSteps, percentage, phase, color);

        // Ê¨°„ÅÆ„Ç¢„ÇØ„Ç∑„Éß„É≥„Å®NEXT„Çπ„ÉÜ„ÉÉ„Éó„ÇíÊõ¥Êñ∞
        updateNextActionAndStep(phase, allSteps);

        // „Éá„Éº„Çø„Éô„Éº„Çπ„Å´ÈÄ≤ÊçóÁä∂Ê≥Å„Çí‰øùÂ≠ò
        saveProjectStage(phase, color);
    }

    // ÈÄ≤ÊçóÁä∂Ê≥Å„Çí„Çµ„Éº„Éê„Éº„Å´‰øùÂ≠òÔºà„Éá„Éê„Ç¶„É≥„Çπ‰ªò„ÅçÔºâ
    var saveStageTimeout;
    function saveProjectStage(stage, color) {
        // „Éá„Éê„Ç¶„É≥„ÇπÔºöÈÄ£Á∂ö„Åó„ÅüÂëº„Å≥Âá∫„Åó„Çí500msÈÅÖÂª∂
        clearTimeout(saveStageTimeout);
        saveStageTimeout = setTimeout(function() {
            $.ajax({
                url: '{% url "order_management:update_project_stage" project.pk %}',
                method: 'POST',
                dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
                data: {
                    stage: stage,
                    color: color,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('‰øùÂ≠òÊàêÂäü:', response);

                    // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                    if (response && response.success) {
                        console.log('ÈÄ≤ÊçóÁä∂Ê≥Å„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü:', stage);
                    } else {
                        console.error('‰øùÂ≠òÂ§±Êïó:', response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });

                    let errorMessage = 'ÈÄ≤ÊçóÁä∂Ê≥Å„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                    } else if (xhr.status === 403) {
                        errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    } else if (xhr.status === 404) {
                        errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                    } else if (xhr.status >= 500) {
                        errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                    }

                    console.error(errorMessage);
                }
            });
        }, 500);
    }

    // „Éï„Ç©„Éº„É†„Éï„Ç£„Éº„É´„Éâ„Å® „Çπ„ÉÜ„ÉÉ„ÉóÁä∂ÊÖã„ÇíÂêåÊúü
    function syncFormFieldsToSteps() {
        console.log('Syncing form fields to steps');

        // Âü∫Êú¨„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éï„Ç©„Éº„É†„Éï„Ç£„Éº„É´„Éâ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        const fieldsToCheck = [
            { field: 'estimate_issued_date', step: 'estimate' },
            { field: 'contract_date', step: 'contract' },
            { field: 'work_start_date', step: 'work_start' },
            { field: 'work_end_date', step: 'work_end' }
        ];

        fieldsToCheck.forEach(({ field, step }) => {
            const input = $(`input[name="${field}"]`);
            const stepElement = $(`.progress-step[data-step="${step}"]`);

            if (input.length && stepElement.length) {
                // „Éï„Ç©„Éº„É†„Éï„Ç£„Éº„É´„Éâ„ÅÆÂÄ§„ÇíË™≠„ÅøÂèñ„Å£„Å¶„Çπ„ÉÜ„ÉÉ„ÉóÁä∂ÊÖã„ÇíÊõ¥Êñ∞
                const inputValue = input.val();
                console.log(`Syncing ${field}: ${inputValue}`);

                if (inputValue) {
                    // Â∑•‰∫ãÈñãÂßã„ÉªÂ∑•‰∫ãÂÆå‰∫Ü„ÅØÁâπÂà•Âá¶ÁêÜ
                    if (step === 'work_start' || step === 'work_end') {
                        const completedCheckbox = $(`input[name="${step}_completed"]`);
                        const isCompleted = completedCheckbox.is(':checked');

                        if (isCompleted) {
                            stepElement.addClass('completed');
                            stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(inputValue));
                        } else {
                            stepElement.removeClass('completed');
                            stepElement.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ' + formatDate(inputValue));
                        }
                    } else {
                        updateStepStatus(stepElement, input);
                    }
                } else if (step === 'work_start' || step === 'work_end') {
                    // Êó•‰ªò„Åå„Å™„ÅÑ„Åå„ÄÅ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆÂá¶ÁêÜ
                    const completedCheckbox = $(`input[name="${step}_completed"]`);
                    const isCompleted = completedCheckbox.is(':checked');

                    if (isCompleted) {
                        stepElement.addClass('completed');
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü');
                    } else {
                        stepElement.removeClass('completed');
                        stepElement.find('.progress-step-date').html('<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>');
                    }
                }
            }
        });

        // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Éï„Ç£„Éº„É´„Éâ„ÇÇ„ÉÅ„Çß„ÉÉ„ÇØ
        const checkboxFields = [
            { field: 'estimate_not_required', step: 'estimate' },
            { field: 'work_start_completed', step: 'work_start' },
            { field: 'work_end_completed', step: 'work_end' },
            { field: 'invoice_issued', step: 'invoice' }
        ];

        checkboxFields.forEach(({ field, step }) => {
            const input = $(`input[name="${field}"]`);
            const stepElement = $(`.progress-step[data-step="${step}"]`);

            if (input.length && stepElement.length && input.is(':checked')) {
                console.log(`Syncing checkbox ${field}: checked`);

                // Ë¶ãÁ©çÊõ∏‰∏çË¶Å„ÉªÂ∑•‰∫ãÈñãÂßã„ÉªÂ∑•‰∫ãÂÆå‰∫Ü„ÅØÁâπÂà•Âá¶ÁêÜ
                if (step === 'estimate' && field === 'estimate_not_required') {
                    stepElement.addClass('completed');
                    stepElement.find('.progress-step-date').html('<i class="fas fa-times-circle me-1"></i>Ë¶ãÁ©ç‰∏çË¶Å');
                } else if (step === 'work_start' || step === 'work_end') {
                    const dateInput = $(`input[name="${step}_date"]`);
                    const dateValue = dateInput.val();

                    stepElement.addClass('completed');
                    if (dateValue) {
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(dateValue));
                    } else {
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü');
                    }
                } else {
                    updateStepStatus(stepElement, input);
                }
            }
        });

        // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„Éï„Ç£„Éº„É´„Éâ„ÅÆÂÄ§„ÇíË®≠ÂÆö
        if (complexStepFields && typeof complexStepFields === 'object') {
            console.log('Setting complex step field values:', complexStepFields);
            Object.keys(complexStepFields).forEach(fieldName => {
                const fieldValue = complexStepFields[fieldName];
                // dynamic_field_ „Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†„Åó„Å¶„Éï„Ç£„Éº„É´„Éâ„ÇíÊ§úÁ¥¢
                const fieldElement = $(`[name="dynamic_field_${fieldName}"]`);

                if (fieldElement.length > 0) {
                    if (fieldElement.is(':checkbox') || fieldElement.is(':radio')) {
                        if (fieldValue === 'true' || fieldValue === fieldElement.val()) {
                            fieldElement.prop('checked', true);
                        }
                    } else {
                        fieldElement.val(fieldValue);
                    }
                    console.log(`Set field dynamic_field_${fieldName} to ${fieldValue}`);
                }
            });

            // ‰æùÂ≠ò„Éï„Ç£„Éº„É´„Éâ„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÊõ¥Êñ∞
            $('input[type="radio"]:checked').trigger('change');

            // ÂêÑË§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
            $('.progress-step[data-step]').each(function() {
                const $step = $(this);
                const stepKey = $step.data('step');

                // availableSteps„Åã„ÇâË©≤ÂΩì„Åô„Çã„Çπ„ÉÜ„ÉÉ„ÉóÂÆöÁæ©„ÇíÂèñÂæó
                const stepData = availableSteps.find(s => s.key === stepKey);

                if (stepData && stepData.type === 'complex') {
                    // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíË®àÁÆó
                    const status = getComplexStepStatus(stepData, $step);

                    // „Çπ„ÉÜ„Éº„Çø„Çπ„Å´Âøú„Åò„Å¶„ÇØ„É©„Çπ„ÇíËøΩÂä†
                    if (status.completed) {
                        $step.addClass('completed');
                    } else {
                        $step.removeClass('completed');
                    }

                    // „Çπ„ÉÜ„Éº„Çø„Çπ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞
                    $step.find('.progress-step-date').html(status.statusText);

                    console.log(`Updated status for ${stepKey}:`, status);
                }
            });
        }

        console.log('Form field sync complete');
    }

    // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°Ââç„Å´„Çπ„ÉÜ„ÉÉ„ÉóÈ†ÜÂ∫è„Å®„ÉÄ„Ç§„Éä„Éü„ÉÉ„ÇØ„Éï„Ç£„Éº„É´„Éâ„Çí‰øùÂ≠ò
    $('form').on('submit', function(e) {
        console.log('=== „Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÈñãÂßã ===');
        saveStepOrder();
        collectDynamicFieldData();

        // „Éá„Éê„ÉÉ„Ç∞: ÈÄÅ‰ø°„Åï„Çå„Çã„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç
        const formData = $(this).serializeArray();
        const dynamicFields = formData.filter(item => item.name.startsWith('dynamic_field_'));
        console.log('ÈÄÅ‰ø°„Åï„Çå„Çã dynamic_field_ „ÅÆÊï∞:', dynamicFields.length);
        console.log('dynamic_field_ „Éá„Éº„Çø:', dynamicFields);

        // Á¢∫Ë™ç„ÅÆ„Åü„ÇÅ‰∏ÄÊôÇÂÅúÊ≠¢ÔºàÊú¨Áï™„Åß„ÅØÂâäÈô§„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ
        // e.preventDefault();
        // showErrorModal(`${dynamicFields.length} ÂÄã„ÅÆdynamic_field_„ÇíÈÄÅ‰ø°„Åó„Åæ„Åô„ÄÇ„Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
    });

    // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Éá„Éº„Çø„ÇíÂèéÈõÜ„Åó„Å¶„Éï„Ç©„Éº„É†„Å´ËøΩÂä†
    function collectDynamicFieldData() {
        console.log('Collecting dynamic field data...');

        // „Åæ„ÅöÂÄ§„ÇíÂèéÈõÜÔºàÂâäÈô§„Åô„ÇãÂâç„Å´Ôºâ
        const collectedData = [];

        // ÂêÑË§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éï„Ç£„Éº„É´„ÉâÂÄ§„ÇíÂèéÈõÜ
        $('.progress-step[data-step]').each(function() {
            const stepKey = $(this).data('step');
            const stepElement = $(this);

            // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éï„Ç£„Éº„É´„Éâ„ÇíÊé¢„Åô
            stepElement.find('input, select, textarea').each(function() {
                const fieldElement = $(this);
                const fieldName = fieldElement.attr('name');

                // „Éï„Ç£„Éº„É´„ÉâÂêç„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                if (!fieldName) return;

                // dynamic_field_„ÅßÂßã„Åæ„Çã„Éï„Ç£„Éº„É´„Éâ„ÅÆ„ÅøÂá¶ÁêÜ
                if (!fieldName.startsWith('dynamic_field_')) return;

                let fieldValue;

                // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Å®„É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆÂ†¥Âêà
                if (fieldElement.is(':checkbox')) {
                    fieldValue = fieldElement.is(':checked') ? 'true' : 'false';
                } else if (fieldElement.is(':radio')) {
                    // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅØÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„ÅøÂá¶ÁêÜ
                    if (!fieldElement.is(':checked')) return;
                    fieldValue = fieldElement.val();
                } else if (fieldElement.is('select[multiple]')) {
                    // Ë§áÊï∞ÈÅ∏Êäû„ÅÆÂ†¥Âêà
                    const selectedValues = fieldElement.val();
                    if (selectedValues && selectedValues.length > 0) {
                        fieldValue = selectedValues.join(',');
                    } else {
                        fieldValue = '';
                    }
                } else {
                    fieldValue = fieldElement.val();
                }

                // ÂÄ§„ÇíÂèéÈõÜÔºàÁ©∫„Åß„ÇÇÂèéÈõÜ„Åó„Å¶None„Å®„Åó„Å¶ÈÄÅ‰ø°Ôºâ
                collectedData.push({
                    name: fieldName,
                    value: fieldValue || ''
                });

                console.log(`Collected: ${fieldName} = ${fieldValue}`);
            });
        });

        // Êó¢Â≠ò„ÅÆÈö†„Åó„Éï„Ç£„Éº„É´„Éâ„ÇíÂâäÈô§Ôºàtype=hidden„ÅÆ„ÅøÔºâ
        $('input[type="hidden"][name^="dynamic_field_"]').remove();

        // ÂèéÈõÜ„Åó„Åü„Éá„Éº„Çø„Åã„ÇâÈö†„Åó„Éï„Ç£„Éº„É´„Éâ„Çí‰ΩúÊàê
        collectedData.forEach(item => {
            const hiddenField = $('<input>', {
                type: 'hidden',
                name: item.name,
                value: item.value
            });
            $('form').append(hiddenField);
            console.log(`Added hidden field: ${item.name} = ${item.value}`);
        });

        console.log(`Dynamic field data collection complete. Collected ${collectedData.length} fields.`);
    }

    // „Çµ„Éº„Éê„Éº„Åã„Çâ„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
    const orderedSteps = {{ ordered_steps_json|safe }};
    const dynamicSteps = {{ dynamic_steps_json|safe }};
    const complexStepFields = {{ complex_step_fields_json|safe }};

    console.log('=== Debug Info ===');
    console.log('orderedSteps:', orderedSteps);
    console.log('orderedSteps type:', typeof orderedSteps);
    console.log('orderedSteps length:', orderedSteps ? orderedSteps.length : 'null/undefined');
    if (orderedSteps && orderedSteps.length > 0) {
        orderedSteps.forEach((step, index) => {
            console.log(`orderedStep[${index}]:`, step);
            console.log(`  key: ${step.key} (type: ${typeof step.key})`);
            console.log(`  name: ${step.name} (type: ${typeof step.name})`);
        });
    }
    console.log('dynamicSteps:', dynamicSteps);
    const projectData = {
        estimate_issued_date: '{{ project.estimate_issued_date|date:"Y-m-d"|default:"" }}' || '',
        estimate_not_required: {% if project.estimate_not_required %}true{% else %}false{% endif %},
        estimate_notes: `{{ project.estimate_notes|escapejs }}`,
        contractor_estimate_amount: `{{ project.contractor_estimate_amount|escapejs }}`,
        contract_date: '{{ project.contract_date|date:"Y-m-d"|default:"" }}' || '',
        work_start_date: '{{ project.work_start_date|date:"Y-m-d"|default:"" }}' || '',
        work_start_completed: {% if project.work_start_completed %}true{% else %}false{% endif %},
        work_end_date: '{{ project.work_end_date|date:"Y-m-d"|default:"" }}' || '',
        work_end_completed: {% if project.work_end_completed %}true{% else %}false{% endif %},
        invoice_issued: {% if project.invoice_issued %}true{% else %}false{% endif %}
    };

    // „Åô„Åπ„Å¶„ÅÆÂ∑•Á®ã„ÅÆ‰∏ãË´ã„ÅëÊÉÖÂ†±„ÇíË™≠„ÅøËæº„ÇÄ
    const allSubcontractsByStep = {{ all_subcontracts_by_step_json|safe }};
    console.log('üì¶ All subcontracts by step:', allSubcontractsByStep);

    // Â∑•Á®ã„Åî„Å®„ÅÆ‰ΩúÊ•≠ËÄÖ„Éá„Éº„Çø„ÇíÂàùÊúüÂåñ
    window.processWorkers = {};
    for (const stepKey in allSubcontractsByStep) {
        window.processWorkers[stepKey] = allSubcontractsByStep[stepKey].map(sc => ({
            subcontractId: sc.id,
            contractorName: sc.contractor_name,
            contractAmount: sc.contract_amount || 0,
            paymentStatus: sc.payment_status
        }));
    }
    console.log('üë∑ Initialized processWorkers:', window.processWorkers);

    // „Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂàùÊúüÂåñ
    function initializeSteps() {
        console.log('initializeSteps called');
        const container = $('#activeSteps');
        container.empty();

        try {
            // orderedSteps„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞Âü∫Êú¨„Çπ„ÉÜ„ÉÉ„Éó
            if (orderedSteps && orderedSteps.length > 0) {
                console.log('Using ordered steps:', orderedSteps.length);
                orderedSteps.forEach((step, index) => {
                    const stepHtml = generateStepHtml(step);
                    if (stepHtml) {
                        container.append(stepHtml);
                    }
                });
            } else {
                console.log('Using default basic steps');
                // Âü∫Êú¨„Çπ„ÉÜ„ÉÉ„Éó„ÇíÁõ¥Êé•ÁîüÊàê
                container.append(generateEstimateStepHtml());

                // ÁèæÂú∞Ë™øÊüª„Çπ„ÉÜ„ÉÉ„Éó„ÅØ survey_required „Åå true „ÅÆÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
                {% if project.survey_required %}
                    container.append(generateSurveyStepHtml());
                {% endif %}

                container.append(generateContractStepHtml());
                container.append(generateWorkStartStepHtml());
                container.append(generateWorkEndStepHtml());
                container.append(generateInvoiceStepHtml());
            }

            // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Çπ„ÉÜ„ÉÉ„Éó„ÇíÊ≠£„Åó„ÅèË®≠ÂÆöÔºàÊúÄÂàù„ÅÆÊú™ÂÆå‰∫Ü„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„ÅøÔºâ
            updateActiveStep();

            // ÈÄ≤Êçó„Çø„Ç§„É†„É©„Ç§„É≥„ÇÇÊõ¥Êñ∞ÔºàDOMË¶ÅÁ¥†„ÅåÊ∫ñÂÇô„Åï„Çå„Å¶„Åã„ÇâÔºâ
            setTimeout(() => {
                updateProgressTimeline();
                updateProgressStatus();

                // ÁèæÂú∞Ë™øÊüª„Ç®„É™„Ç¢„ÅÆË°®Á§∫Âà∂Âæ°
                updateSurveyAreaVisibility();

                // ÂÖ®„Å¶„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂ±ïÈñãÁä∂ÊÖã„ÅßË°®Á§∫
                $('.progress-step').addClass('expanded');
                $('.progress-step-content').show();

                // ‰∫àÂÆöÊó•Ë∂ÖÈÅé„ÉÅ„Çß„ÉÉ„ÇØ„ÇíÂÆüË°å
                checkOverdueSteps();

                // Ë¶ãÁ©çÊõ∏‰∏çË¶Å„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂàùÊúüÂåñÔºàDOMË¶ÅÁ¥†„ÅåÁîüÊàê„Åï„Çå„ÅüÂæåÔºâ
                console.log('Ë¶ãÁ©çÊõ∏‰∏çË¶Å„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆË¶ÅÁ¥†Êï∞ÔºàÂàùÊúüÂåñÂæåÔºâ:', $('#estimateNotRequired').length);
                console.log('Ë¶ãÁ©çÊõ∏‰∏çË¶Å„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂàùÊúüÁä∂ÊÖãÔºàÂàùÊúüÂåñÂæåÔºâ:', $('#estimateNotRequired').is(':checked'));
                if ($('#estimateNotRequired').length > 0) {
                    window.handleEstimateNotRequiredChange();
                }

                // „Ç∑„É≥„Éó„É´„Å™Êó•‰ªò„Çπ„ÉÜ„ÉÉ„ÉóÔºàcontractÁ≠âÔºâ„ÅÆÂàùÊúüÂÄ§„ÇíÂèçÊò†„Åó„Å¶„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊõ¥Êñ∞
                // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„ÉóÔºàattendance, survey, construction_start, completionÔºâ„ÅØ
                // getComplexStepStatusÈñ¢Êï∞„ÅßÊó¢„Å´Âá¶ÁêÜ„Åï„Çå„Å¶„ÅÑ„Çã„ÅÆ„Åß„Çπ„Ç≠„ÉÉ„Éó
                $('.progress-step').each(function() {
                    const $step = $(this);
                    const stepKey = $step.data('step');

                    // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„Å®Ë¶ãÁ©çÊõ∏Áô∫Ë°å„Çπ„ÉÜ„ÉÉ„Éó„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºàSSOTÂØæÂøúÔºâ
                    const complexSteps = ['step_attendance', 'step_survey', 'step_estimate', 'estimate', 'step_construction_start', 'step_completion'];
                    if (complexSteps.includes(stepKey)) {
                        return; // continue
                    }

                    // availableSteps„Åã„ÇâÂÆöÁæ©„ÇíÂèñÂæó„Åó„Å¶type„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                    const stepData = availableSteps.find(s => s.key === stepKey);
                    if (stepData && stepData.type === 'complex') {
                        return; // continue - Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅØ„Çπ„Ç≠„ÉÉ„Éó
                    }

                    // „Ç∑„É≥„Éó„É´„Å™Êó•‰ªò„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„ÅøÂá¶ÁêÜ
                    const $dateInput = $step.find('input[type="date"]');
                    if ($dateInput.length > 0 && $dateInput.val()) {
                        const dateValue = $dateInput.val();
                        $step.addClass('completed');
                        $step.removeClass('active');
                        $step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ' + formatDate(dateValue));
                    }

                    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„Éï„Ç£„Éº„É´„Éâ„ÇÇÂá¶ÁêÜ
                    const $checkbox = $step.find('input[type="checkbox"][name$="_completed"]');
                    if ($checkbox.length > 0 && $checkbox.is(':checked')) {
                        $step.addClass('completed');
                        $step.removeClass('active');
                        $step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫ÜÊ∏à„Åø');
                    }
                });
            }, 50);

            console.log('Steps initialized:', container.children().length);
        } catch (error) {
            console.error('Error in initializeSteps:', error);
            // „Ç®„É©„ÉºÊôÇ„ÅØÂü∫Êú¨„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂº∑Âà∂Ë°®Á§∫
            container.append(generateEstimateStepHtml());

            // ÁèæÂú∞Ë™øÊüª„Çπ„ÉÜ„ÉÉ„Éó„ÅØ survey_required „Åå true „ÅÆÂ†¥Âêà„ÅÆ„ÅøËøΩÂä†
            {% if project.survey_required %}
                container.append(generateSurveyStepHtml());
            {% endif %}

            container.append(generateContractStepHtml());
            container.append(generateWorkStartStepHtml());
            container.append(generateWorkEndStepHtml());
            container.append(generateInvoiceStepHtml());
        }
    }

    // ÁèæÂú∞Ë™øÊüª„Ç®„É™„Ç¢„ÅÆË°®Á§∫Âà∂Âæ°
    function updateSurveyAreaVisibility() {
        const surveyStep = $('.progress-step[data-step="step_survey"]');
        const surveyArea = $('#surveyContentArea');

        console.log('Survey step found:', surveyStep.length);
        console.log('Survey area element:', surveyArea.length);

        // survey_required „Éï„É©„Ç∞„Å´Âü∫„Å•„ÅÑ„Å¶Ë°®Á§∫Âà∂Âæ°
        {% if project.survey_required %}
            surveyArea.show();
            console.log('Survey area shown (survey_required=true)');
        {% else %}
            surveyArea.hide();
            console.log('Survey area hidden (survey_required=false)');
        {% endif %}
    }

    // „Çπ„ÉÜ„ÉÉ„ÉóHTML„ÇíÁîüÊàê
    function generateStepHtml(step) {
        // ‰∫åÈáç„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºàstep_step_ -> step_Ôºâ
        if (step.key && step.key.startsWith('step_step_')) {
            step.key = step.key.replace('step_step_', 'step_');
            console.log('üîß ‰∫åÈáç„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Çí‰øÆÊ≠£:', step.key);
        }

        // Âü∫Êú¨„Çπ„ÉÜ„ÉÉ„Éó„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØÔºàÊñ∞Êóß‰∏°Êñπ„ÅÆ„Ç≠„Éº„Å´ÂØæÂøúÔºâ
        const basicSteps = ['estimate', 'survey', 'contract', 'work_start', 'work_end', 'invoice',
                           'step_estimate', 'step_survey', 'step_contract', 'step_work_start', 'step_work_end', 'step_invoice'];
        const isBasicStep = basicSteps.includes(step.key);

        if (isBasicStep) {
            return generateStaticStepHtml(step);
        } else {
            // Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó„Åã„ÇâÂÆöÁæ©„ÇíÂèñÂæó
            const stepDefinition = availableSteps.find(s => s.key === step.key);
            if (stepDefinition) {
                return generateAvailableStepHtml(stepDefinition);
            } else if (step.is_dynamic) {
                return generateDynamicStepHtml(step);
            } else {
                console.warn(`Unknown step: ${step.key}`);
                return '';
            }
        }
    }

    // Â∑¶ÂÅ¥Ë°®Á§∫Áî®„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóHTML„ÇíÁîüÊàê
    function generateLeftDisplayStepHtml(step) {
        // ‰∫åÈáç„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„Çí„ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„ÉóÔºàstep_step_ -> step_Ôºâ
        if (step.key && step.key.startsWith('step_step_')) {
            step.key = step.key.replace('step_step_', 'step_');
        }

        if (step.is_dynamic) {
            return generateLeftDisplayDynamicStepHtml(step);
        } else {
            return generateLeftDisplayStaticStepHtml(step);
        }
    }

    // Â∑¶ÂÅ¥Ë°®Á§∫Áî® - ÈùôÁöÑ„Çπ„ÉÜ„ÉÉ„Éó
    function generateLeftDisplayStaticStepHtml(step) {
        let stepName, stepIcon, isCompleted, statusHtml;

        switch (step.key) {
            case 'estimate':
            case 'step_estimate':
                stepName = 'Ë¶ãÁ©ç‰ΩúÊàê';
                stepIcon = 'fas fa-file-invoice';
                // orderedSteps„Åã„ÇâÂÆå‰∫ÜÁä∂ÊÖã„ÇíÂèñÂæóÔºàSSOTÂØæÂøúÔºâ
                const estimateStepData = orderedSteps.find(s => s.key === 'step_estimate' || s.key === 'estimate');
                isCompleted = estimateStepData ? estimateStepData.completed : (projectData.estimate_issued_date || projectData.estimate_not_required);
                const estimateDate = estimateStepData && estimateStepData.data ? estimateStepData.data.scheduled_date : projectData.estimate_issued_date;

                if (isCompleted) {
                    if (estimateDate) {
                        statusHtml = `<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(estimateDate)}`;
                    } else {
                        statusHtml = '<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü';
                    }
                } else if (projectData.estimate_not_required) {
                    statusHtml = '<i class="fas fa-times-circle me-1"></i>Ë¶ãÁ©ç‰∏çË¶Å';
                } else if (estimateDate) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(estimateDate)}`;
                } else {
                    statusHtml = 'Êú™ÂÆå‰∫Ü';
                }
                break;
            case 'contract':
                stepName = 'Â•ëÁ¥Ñ';
                stepIcon = 'fas fa-handshake';
                isCompleted = projectData.contract_date;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(projectData.contract_date)}`;
                } else {
                    statusHtml = 'Êú™ÂÆå‰∫Ü';
                }
                break;
            case 'work_start':
                stepName = 'Â∑•‰∫ãÈñãÂßã';
                stepIcon = 'fas fa-play-circle';
                isCompleted = projectData.work_start_completed;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(projectData.work_start_date)}`;
                } else if (projectData.work_start_date) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(projectData.work_start_date)}`;
                } else {
                    statusHtml = 'Êú™ÂÆå‰∫Ü';
                }
                break;
            case 'work_end':
                stepName = 'Â∑•‰∫ãÂÆå‰∫Ü';
                stepIcon = 'fas fa-check-circle';
                isCompleted = projectData.work_end_completed;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(projectData.work_end_date)}`;
                } else if (projectData.work_end_date) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(projectData.work_end_date)}`;
                } else {
                    statusHtml = 'Êú™ÂÆå‰∫Ü';
                }
                break;
            case 'invoice':
                stepName = 'Ë´ãÊ±ÇÊõ∏Áô∫Ë°å';
                stepIcon = 'fas fa-file-invoice-dollar';
                isCompleted = projectData.invoice_issued;
                statusHtml = isCompleted ? '<i class="fas fa-check-circle me-1"></i>Áô∫Ë°åÊ∏à„Åø' : 'Êú™Áô∫Ë°å';
                break;
            default:
                return '';
        }

        const completedClass = isCompleted ? 'completed' : '';

        return `
            <div class="progress-step ${completedClass}" data-step="${step.key}">
                <div class="progress-step-header">
                    <i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span>
                </div>
                <div class="progress-step-date">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // Â∑¶ÂÅ¥Ë°®Á§∫Áî® - ÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„Éó
    function generateLeftDisplayDynamicStepHtml(step) {
        const stepData = step.data || {};
        const stepKey = step.key;
        let stepName = stepKey;
        let stepIcon = 'fas fa-circle';

        // „Çπ„ÉÜ„ÉÉ„ÉóÂêç„Å®„Ç¢„Ç§„Ç≥„É≥„ÅÆË®≠ÂÆö
        switch (stepKey) {
            case 'survey':
                stepName = 'ÁèæÂ†¥Ë™øÊüª';
                stepIcon = 'fas fa-search-location';
                break;
            case 'material_order':
                stepName = 'ÈÉ®ÊùêÁô∫Ê≥®';
                stepIcon = 'fas fa-shopping-cart';
                break;
            case 'delivery':
                stepName = 'Á¥çÂìÅ';
                stepIcon = 'fas fa-truck';
                break;
            case 'inspection':
                stepName = 'Ê§úÊüª';
                stepIcon = 'fas fa-clipboard-check';
                break;
            case 'handover':
                stepName = 'Âºï„ÅçÊ∏°„Åó';
                stepIcon = 'fas fa-key';
                break;
            case 'maintenance':
                stepName = '„É°„É≥„ÉÜ„Éä„É≥„Çπ';
                stepIcon = 'fas fa-tools';
                break;
            case 'warranty':
                stepName = '‰øùË®ºÂØæÂøú';
                stepIcon = 'fas fa-shield-alt';
                break;
            case 'final_report':
                stepName = 'ÊúÄÁµÇÂ†±Âëä';
                stepIcon = 'fas fa-file-alt';
                break;
            case 'customer_satisfaction':
                stepName = 'È°ßÂÆ¢Ê∫ÄË∂≥Â∫¶Ë™øÊüª';
                stepIcon = 'fas fa-star';
                break;
            case 'payment_confirmation':
                stepName = 'ÂÖ•ÈáëÁ¢∫Ë™ç';
                stepIcon = 'fas fa-money-check-alt';
                break;
            case 'project_closure':
                stepName = '„Éó„É≠„Ç∏„Çß„ÇØ„ÉàÂÆå‰∫Ü';
                stepIcon = 'fas fa-certificate';
                break;
            default:
                stepName = stepData.name || stepKey;
                break;
        }

        const isCompleted = stepData.completed || stepData.date || stepData.value;
        let statusHtml = 'Êú™ÂÆå‰∫Ü';

        if (stepData.type === 'date' && stepData.date) {
            statusHtml = `<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(stepData.date)}`;
        } else if (stepData.type === 'checkbox' && stepData.completed) {
            statusHtml = '<i class="fas fa-check-circle me-1"></i>ÂÆå‰∫ÜÊ∏à„Åø';
        } else if (stepData.type === 'text' && stepData.value) {
            statusHtml = `<i class="fas fa-check-circle me-1"></i>${stepData.value}`;
        }

        const completedClass = isCompleted ? 'completed' : '';

        return `
            <div class="progress-step ${completedClass}" data-step="${stepKey}">
                <div class="progress-step-header">
                    <i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span>
                </div>
                <div class="progress-step-date">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // ÈùôÁöÑ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆHTMLÁîüÊàêÔºà„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
    function generateStaticStepHtml(step) {
        switch (step.key) {
            case 'estimate':
            case 'step_estimate':
                return generateEstimateStepHtml();
            case 'survey':
            case 'step_survey':
                return generateSurveyStepHtml();
            case 'contract':
            case 'step_contract':
                return generateContractStepHtml();
            case 'work_start':
            case 'step_work_start':
                return generateWorkStartStepHtml();
            case 'work_end':
            case 'step_work_end':
                return generateWorkEndStepHtml();
            case 'invoice':
            case 'step_invoice':
                return generateInvoiceStepHtml();
            default:
                return '';
        }
    }

    // ÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆHTMLÁîüÊàê
    function generateDynamicStepHtml(step) {
        const stepData = step.data || {};
        const stepKey = step.key;

        let stepName = stepKey;
        let stepIcon = 'fas fa-circle';

        // „Çπ„ÉÜ„ÉÉ„ÉóÂêç„Å®„Ç¢„Ç§„Ç≥„É≥„ÅÆË®≠ÂÆö
        switch (stepKey) {
            case 'contract':
            case 'step_contract':
                stepName = 'Â•ëÁ¥Ñ';
                stepIcon = 'fas fa-handshake';
                break;
            case 'invoice':
            case 'step_invoice':
                stepName = 'Ë´ãÊ±ÇÊõ∏Áô∫Ë°å';
                stepIcon = 'fas fa-file-invoice-dollar';
                break;
            case 'survey':
            case 'step_survey':
                stepName = 'ÁèæÂú∞Ë™øÊüª';
                stepIcon = 'fas fa-clipboard-list';
                break;
            case 'attendance':
            case 'step_attendance':
                stepName = 'Á´ã„Å°‰ºö„ÅÑ';
                stepIcon = 'fas fa-user-check';
                break;
            case 'estimate':
            case 'step_estimate':
                stepName = 'Ë¶ãÁ©çÊõ∏Áô∫Ë°å';
                stepIcon = 'fas fa-file-invoice';
                break;
            case 'construction_start':
            case 'step_construction_start':
                stepName = 'ÁùÄÂ∑•';
                stepIcon = 'fas fa-hard-hat';
                break;
            case 'completion':
            case 'step_completion':
                stepName = 'ÂÆåÂ∑•';
                stepIcon = 'fas fa-check-circle';
                break;
            case 'permit_application':
            case 'step_permit_application':
                stepName = 'Ë®±ÂèØÁî≥Ë´ã';
                stepIcon = 'fas fa-file-signature';
                break;
            case 'material_order':
            case 'step_material_order':
                stepName = 'Ë≥áÊùêÁô∫Ê≥®';
                stepIcon = 'fas fa-boxes';
                break;
            case 'safety_training':
            case 'step_safety_training':
                stepName = 'ÂÆâÂÖ®Ë¨õÁøí';
                stepIcon = 'fas fa-hard-hat';
                break;
            case 'final_inspection':
            case 'step_final_inspection':
                stepName = 'ÂÆåÊàêÊ§úÊüª';
                stepIcon = 'fas fa-clipboard-check';
                break;
            case 'handover':
            case 'step_handover':
                stepName = 'ÂºïÊ∏°„Åó';
                stepIcon = 'fas fa-key';
                break;
            case 'warranty_issue':
            case 'step_warranty_issue':
                stepName = '‰øùË®ºÊõ∏Áô∫Ë°å';
                stepIcon = 'fas fa-certificate';
                break;
            case 'inspection':
            case 'step_inspection':
                stepName = 'Ê§úÊüª';
                stepIcon = 'fas fa-clipboard-check';
                break;
        }

        // contract„Å®invoice„ÅØÁâπÂà•„Å™Âá¶ÁêÜ„ÅåÂøÖË¶ÅÔºàprojectData„Åã„ÇâÂèñÂæóÔºâ
        let dateValue, completedValue;
        if (stepKey === 'contract' || stepKey === 'step_contract') {
            dateValue = projectData.contract_date;
        } else if (stepKey === 'invoice' || stepKey === 'step_invoice') {
            completedValue = projectData.invoice_issued;
        } else {
            dateValue = stepData.date;
            completedValue = stepData.completed;
        }

        // üîß FIX: Only use completedValue to determine if step is completed, not presence of date
        const isCompleted = completedValue || false;
        let statusHtml = '<div class="progress-step-date">Êú™ÂÆå‰∫Ü</div>';

        if (stepData.type === 'date' && dateValue) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(dateValue)}</div>`;
        } else if (stepData.type === 'checkbox' && completedValue) {
            statusHtml = '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫ÜÊ∏à„Åø</div>';
        } else if (stepData.type === 'text' && stepData.value) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>${stepData.value}</div>`;
        }

        let fieldHtml = '';
        if (stepData.type === 'date') {
            fieldHtml = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">‰∫àÂÆöÊó•</label>
                    <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="${stepKey}" title="ÂÆüÊñΩÊó•„ÇíËøΩÂä†">
                        <i class="fas fa-plus me-1"></i>ÂÆüÊñΩÊó•
                    </button>
                </div>
                <input type="date" name="${stepKey}_date" class="form-control scheduled-date-input" value="${dateValue || ''}">
                <div class="actual-date-field mt-2" style="display: none;">
                    <label class="form-label">ÂÆüÊñΩÊó•</label>
                    <div class="input-group">
                        <input type="date" name="${stepKey}_actual_date" class="form-control actual-date-input" value="">
                        <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="ÂÆüÊñΩÊó•„ÇíÂâäÈô§">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        } else if (stepData.type === 'checkbox') {
            fieldHtml = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="${stepKey}_completed"
                           id="${stepKey}Completed" ${completedValue ? 'checked' : ''}>
                    <label class="form-check-label" for="${stepKey}Completed">
                        <i class="fas fa-check me-1"></i>${stepName}ÂÆå‰∫Ü
                    </label>
                </div>
            `;
        } else {
            fieldHtml = `
                <label class="form-label">${stepName}</label>
                <input type="text" name="${stepKey}_value" class="form-control" value="${stepData.value || ''}">
            `;
        }

        // attendance, survey, construction_start „ÅÆÂ†¥Âêà„ÅØ‰∏ãË´ã„ÅëÊâãÈÖç„Ç´„Éº„Éâ„ÇíËøΩÂä†
        let additionalCardHtml = '';
        const stepKeyNormalized = stepKey.replace('step_', '');
        if (['attendance', 'survey', 'construction_start'].includes(stepKeyNormalized)) {
            additionalCardHtml = generateStepSubcontractCardHtml(stepKeyNormalized);
        } else if (stepKeyNormalized === 'material_order') {
            additionalCardHtml = generateMaterialOrderCardHtml();
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="${stepKey}">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà"></i>
                        <span><i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="${stepKey}" title="„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    ${fieldHtml}
                    ${additionalCardHtml}
                </div>
            </div>
        `;
    }

    // Ë¶ãÁ©çÊõ∏Áô∫Ë°å„Çπ„ÉÜ„ÉÉ„Éó„ÅÆHTMLÁîüÊàê
    function generateEstimateStepHtml() {
        // orderedSteps„Åã„ÇâË¶ãÁ©çÊõ∏Áô∫Ë°å„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæóÔºàSSOTÂØæÂøúÔºâ
        const estimateStep = orderedSteps.find(s => s.key === 'step_estimate' || s.key === 'estimate');
        // üîß FIX: estimateStep„ÅåÂ≠òÂú®„Åô„ÇãÂ†¥Âêà„ÅØÂøÖ„Åö„Åù„ÅÆcompletedÂÄ§„Çí‰ΩøÁî®Ôºà„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„Å™„ÅóÔºâ
        const isCompleted = estimateStep ? estimateStep.completed : false;
        const scheduledDate = estimateStep && estimateStep.data ? estimateStep.data.scheduled_date : projectData.estimate_issued_date;

        console.log('=== generateEstimateStepHtml Debug ===');
        console.log('estimateStep:', estimateStep);
        console.log('isCompleted:', isCompleted);
        console.log('scheduledDate:', scheduledDate);

        // üîß FIX: ‰ªñ„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Å®Âêå„Åò„Éê„ÉÉ„Ç∏„Çπ„Çø„Ç§„É´„Å´Áµ±‰∏Ä
        let statusHtml = '<div class="progress-step-date"><span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span></div>';

        if (isCompleted) {
            if (scheduledDate) {
                statusHtml = `<div class="progress-step-date"><span class="badge bg-success">Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊ∏à„Åø</span> ${formatDate(scheduledDate)}</div>`;
            } else {
                statusHtml = '<div class="progress-step-date"><span class="badge bg-success">Ë¶ãÁ©çÊõ∏Áô∫Ë°åÊ∏à„Åø</span></div>';
            }
        } else if (projectData.estimate_not_required) {
            statusHtml = '<div class="progress-step-date"><span class="badge bg-success">Ë¶ãÁ©çÊõ∏‰∏çË¶Å</span></div>';
        } else if (scheduledDate) {
            statusHtml = `<div class="progress-step-date"><span class="badge bg-warning">Ë¶ãÁ©çÊõ∏ÂæÖ„Å°</span> ${formatDate(scheduledDate)}</div>`;
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="estimate">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà"></i>
                        <span><i class="fas fa-file-invoice me-2"></i><span class="progress-step-label">Ë¶ãÁ©çÊõ∏Áô∫Ë°å</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="estimate" title="„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">‰∫àÂÆöÊó•</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="estimate" title="ÂÆüÊñΩÊó•„ÇíËøΩÂä†">
                                <i class="fas fa-plus me-1"></i>ÂÆüÊñΩÊó•
                            </button>
                        </div>
                        <input type="date" name="estimate_issued_date" class="form-control scheduled-date-input"
                               value="${projectData.estimate_issued_date || ''}" ${projectData.estimate_not_required ? 'disabled' : ''}>
                        <div class="actual-date-field mt-2" style="display: none;">
                            <label class="form-label">ÂÆüÊñΩÊó•</label>
                            <div class="input-group">
                                <input type="date" name="dynamic_field_estimate_actual_date" class="form-control actual-date-input" value="">
                                <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="ÂÆüÊñΩÊó•„ÇíÂâäÈô§">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="estimate_completed"
                               id="estimateCompleted" ${isCompleted ? 'checked' : ''}>
                        <label class="form-check-label" for="estimateCompleted">
                            <i class="fas fa-check me-1"></i>ÂÆå‰∫Ü
                        </label>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="estimate_not_required"
                               id="estimateNotRequired" ${projectData.estimate_not_required ? 'checked' : ''}>
                        <label class="form-check-label" for="estimateNotRequired">
                            <i class="fas fa-times me-1"></i>Ë¶ãÁ©çÊõ∏‰∏çË¶Å
                        </label>
                    </div>

                    <!-- ‰∏ãË´ãÊ•≠ËÄÖË¶ãÁ©çÈáëÈ°ç -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-yen-sign me-1"></i>‰∏ãË´ãÊ•≠ËÄÖË¶ãÁ©çÈáëÈ°ç
                        </label>
                        <textarea name="contractor_estimate_amount" class="form-control contractor-estimate-amount-input"
                                  rows="3" placeholder="‰∏ãË´ãÊ•≠ËÄÖ„ÅÆË¶ãÁ©çÈáëÈ°ç„Çí„Éï„É™„Éº„ÉÜ„Ç≠„Çπ„Éà„ÅßÂÖ•Âäõ">${projectData.contractor_estimate_amount || ''}</textarea>
                        <small class="text-muted">‰∏ãË´ãÊ•≠ËÄÖ„ÅÆË¶ãÁ©çÈáëÈ°ç„ÇÑÂÜÖË®≥„ÇíËá™Áî±„Å´ÂÖ•Âäõ„Åß„Åç„Åæ„Åô</small>
                    </div>

                    <!-- ÂÇôËÄÉ -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-comment me-1"></i>ÂÇôËÄÉ
                        </label>
                        <textarea name="estimate_notes" class="form-control estimate-notes-input"
                                  rows="3" placeholder="Ë¶ãÁ©ç„ÇÇ„Çä„Å´Èñ¢„Åô„ÇãÂÇôËÄÉ„ÇÑ„É°„É¢„ÇíÂÖ•Âäõ">${projectData.estimate_notes || ''}</textarea>
                        <small class="text-muted">Ë¶ãÁ©ç„ÇÇ„Çä„Å´Èñ¢„Åô„Çã„É°„É¢„ÇÑÁâπË®ò‰∫ãÈ†Ö„ÇíÂÖ•Âäõ„Åß„Åç„Åæ„Åô</small>
                    </div>

                    <!-- „Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ -->
                    <div class="estimate-files-section">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-paperclip me-2"></i>Ë¶ãÁ©ç„ÇÇ„ÇäÊõ∏È°û
                        </label>
                        <div class="mb-2">
                            <input type="file" class="form-control form-control-sm estimate-file-input"
                                   accept=".pdf,.xlsx,.xls,.docx,.doc,.jpg,.jpeg,.png"
                                   style="position: absolute; left: -9999px;">
                            <button type="button" class="btn btn-sm btn-outline-primary upload-estimate-file-btn">
                                <i class="fas fa-upload me-1"></i>„Éï„Ç°„Ç§„É´„ÇíÈÅ∏Êäû
                            </button>
                            <small class="text-muted d-block mt-1">
                                PDF, Excel, Word, ÁîªÂÉè (ÊúÄÂ§ß10MB)
                            </small>
                        </div>
                        <div class="estimate-files-list">
                            <!-- „Éï„Ç°„Ç§„É´„É™„Çπ„Éà„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ÁèæÂú∞Ë™øÊüª„Çπ„ÉÜ„ÉÉ„Éó„ÅÆHTMLÁîüÊàêÔºàProjectProgressStepÂØæÂøúÔºâ
    function generateSurveyStepHtml() {
        // üîß FIX: orderedSteps„Åã„Çâstep_survey„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
        const surveyStep = orderedSteps.find(s => s.key === 'step_survey' || s.key === 'survey');
        const scheduled_date = surveyStep && surveyStep.data ? surveyStep.data.scheduled_date : '';
        const actual_date = surveyStep && surveyStep.data ? surveyStep.data.actual_date : '';
        const isCompleted = surveyStep ? surveyStep.completed : false;

        console.log('=== generateSurveyStepHtml Debug ===');
        console.log('surveyStep:', surveyStep);
        console.log('scheduled_date:', scheduled_date);
        console.log('actual_date:', actual_date);
        console.log('isCompleted:', isCompleted);

        // „Çπ„ÉÜ„Éº„Çø„ÇπHTML„ÅÆÁîüÊàê
        let statusHtml = '<div class="progress-step-date">Êú™ÂÆå‰∫Ü</div>';
        if (isCompleted) {
            if (actual_date) {
                statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(actual_date)}</div>`;
            } else if (scheduled_date) {
                statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(scheduled_date)}</div>`;
            } else {
                statusHtml = '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü</div>';
            }
        } else if (scheduled_date) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(scheduled_date)}</div>`;
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="step_survey">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà"></i>
                        <span><i class="fas fa-clipboard-list me-2"></i><span class="progress-step-label">ÁèæÂú∞Ë™øÊüª</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="step_survey" title="„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <!-- ‰∫àÂÆöÊó•ÂÖ•Âäõ -->
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">‰∫àÂÆöÊó•</label>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="step_survey" title="ÂÆüÊñΩÊó•„ÇíËøΩÂä†">
                            <i class="fas fa-plus me-1"></i>ÂÆüÊñΩÊó•
                        </button>
                    </div>
                    <input type="date" name="dynamic_field_step_survey_scheduled_date" class="form-control scheduled-date-input" value="${scheduled_date || ''}">

                    <!-- ÂÆüÊñΩÊó•ÂÖ•Âäõ -->
                    <div class="actual-date-field mt-2" style="display: ${actual_date ? 'block' : 'none'};">
                        <label class="form-label">ÂÆüÊñΩÊó•</label>
                        <div class="input-group">
                            <input type="date" name="dynamic_field_step_survey_actual_date" class="form-control actual-date-input" value="${actual_date || ''}">
                            <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="ÂÆüÊñΩÊó•„ÇíÂâäÈô§">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- ÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
                    <div class="form-check mt-3 mb-3">
                        <input class="form-check-input" type="checkbox" name="dynamic_field_step_survey_completed" id="surveyCompleted" ${isCompleted ? 'checked' : ''}>
                        <label class="form-check-label" for="surveyCompleted">
                            <i class="fas fa-check me-1"></i>ÂÆå‰∫Ü
                        </label>
                    </div>

                    <!-- ÁèæË™øÊãÖÂΩìËÄÖ„ÅÆË°®Á§∫ -->
                    ${generateStepSubcontractCardHtml('survey')}
                </div>
            </div>
        `;
    }

    // Â•ëÁ¥Ñ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆHTMLÁîüÊàê
    function generateContractStepHtml() {
        const isCompleted = projectData.contract_date;
        const statusHtml = isCompleted
            ? `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(projectData.contract_date)}</div>`
            : '<div class="progress-step-date">Êú™ÂÆå‰∫Ü</div>';

        // üîß FIX: ProjectProgressStep„Åã„ÇâÁèæÂú∞Ë™øÊüª„ÅÆÂÆå‰∫ÜÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
        const surveyStep = orderedSteps.find(s => s.key === 'step_survey' || s.key === 'survey');
        const hasSurveyCompleted = surveyStep ? surveyStep.completed : false;

        return `
            <div class="progress-step ${isCompleted ? 'completed' : hasSurveyCompleted ? 'active' : ''}" data-step="contract">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà"></i>
                        <span><i class="fas fa-handshake me-2"></i><span class="progress-step-label">Â•ëÁ¥Ñ</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="contract" title="„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">‰∫àÂÆöÊó•</label>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="contract" title="ÂÆüÊñΩÊó•„ÇíËøΩÂä†">
                            <i class="fas fa-plus me-1"></i>ÂÆüÊñΩÊó•
                        </button>
                    </div>
                    <input type="date" name="contract_date" class="form-control scheduled-date-input" value="${projectData.contract_date || ''}">
                    <div class="actual-date-field mt-2" style="display: none;">
                        <label class="form-label">ÂÆüÊñΩÊó•</label>
                        <div class="input-group">
                            <input type="date" name="contract_actual_date" class="form-control actual-date-input" value="">
                            <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="ÂÆüÊñΩÊó•„ÇíÂâäÈô§">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // Â∑•‰∫ãÈñãÂßã„Çπ„ÉÜ„ÉÉ„Éó„ÅÆHTMLÁîüÊàê
    function generateWorkStartStepHtml() {
        const isCompleted = projectData.work_start_completed;
        const hasDate = projectData.work_start_date;

        let statusHtml;
        if (isCompleted) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(projectData.work_start_date)}</div>`;
        } else if (hasDate) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(projectData.work_start_date)}</div>`;
        } else {
            statusHtml = '<div class="progress-step-date">Êú™ÂÆå‰∫Ü</div>';
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.contract_date ? 'active' : ''}" data-step="work_start">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà"></i>
                        <span><i class="fas fa-play-circle me-2"></i><span class="progress-step-label">Â∑•‰∫ãÈñãÂßã</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="work_start" title="„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">‰∫àÂÆöÊó•</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="work_start" title="ÂÆüÊñΩÊó•„ÇíËøΩÂä†">
                                <i class="fas fa-plus me-1"></i>ÂÆüÊñΩÊó•
                            </button>
                        </div>
                        <input type="date" name="work_start_date" class="form-control scheduled-date-input" value="${projectData.work_start_date || ''}">
                        <div class="actual-date-field mt-2" style="display: none;">
                            <label class="form-label">ÂÆüÊñΩÊó•</label>
                            <div class="input-group">
                                <input type="date" name="work_start_actual_date" class="form-control actual-date-input" value="">
                                <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="ÂÆüÊñΩÊó•„ÇíÂâäÈô§">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="work_start_completed"
                               id="workStartCompleted" ${projectData.work_start_completed ? 'checked' : ''}>
                        <label class="form-check-label" for="workStartCompleted">
                            <i class="fas fa-check me-1"></i>Â∑•‰∫ãÈñãÂßãÂÆå‰∫Ü
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // Â∑•‰∫ãÁµÇ‰∫Ü„Çπ„ÉÜ„ÉÉ„Éó„ÅÆHTMLÁîüÊàê
    function generateWorkEndStepHtml() {
        const isCompleted = projectData.work_end_completed;
        const hasDate = projectData.work_end_date;

        let statusHtml;
        if (isCompleted) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(projectData.work_end_date)}</div>`;
        } else if (hasDate) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(projectData.work_end_date)}</div>`;
        } else {
            statusHtml = '<div class="progress-step-date">Êú™ÂÆå‰∫Ü</div>';
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.work_start_completed ? 'active' : ''}" data-step="work_end">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà"></i>
                        <span><i class="fas fa-stop-circle me-2"></i><span class="progress-step-label">Â∑•‰∫ãÁµÇ‰∫Ü</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="work_end" title="„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">‰∫àÂÆöÊó•</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="work_end" title="ÂÆüÊñΩÊó•„ÇíËøΩÂä†">
                                <i class="fas fa-plus me-1"></i>ÂÆüÊñΩÊó•
                            </button>
                        </div>
                        <input type="date" name="work_end_date" class="form-control scheduled-date-input" value="${projectData.work_end_date || ''}">
                        <div class="actual-date-field mt-2" style="display: none;">
                            <label class="form-label">ÂÆüÊñΩÊó•</label>
                            <div class="input-group">
                                <input type="date" name="work_end_actual_date" class="form-control actual-date-input" value="">
                                <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="ÂÆüÊñΩÊó•„ÇíÂâäÈô§">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="work_end_completed"
                               id="workEndCompleted" ${projectData.work_end_completed ? 'checked' : ''}>
                        <label class="form-check-label" for="workEndCompleted">
                            <i class="fas fa-check me-1"></i>Â∑•‰∫ãÁµÇ‰∫ÜÂÆå‰∫Ü
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // Ë´ãÊ±ÇÊõ∏Áô∫Ë°å„Çπ„ÉÜ„ÉÉ„Éó„ÅÆHTMLÁîüÊàê
    function generateInvoiceStepHtml() {
        const isCompleted = projectData.invoice_issued;
        const statusHtml = isCompleted
            ? '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>Áô∫Ë°åÊ∏à„Åø</div>'
            : '<div class="progress-step-date">Êú™Áô∫Ë°å</div>';

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.work_end_completed ? 'active' : ''}" data-step="invoice">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà"></i>
                        <span><i class="fas fa-receipt me-2"></i><span class="progress-step-label">Ë´ãÊ±ÇÊõ∏Áô∫Ë°å</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="invoice" title="„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <label class="form-label">Ë´ãÊ±ÇÊõ∏Áô∫Ë°å</label>
                    <select name="invoice_issued" class="form-select">
                        <option value="false" ${!projectData.invoice_issued ? 'selected' : ''}>Êú™Áô∫Ë°å</option>
                        <option value="true" ${projectData.invoice_issued ? 'selected' : ''}>Áô∫Ë°åÊ∏à„Åø</option>
                    </select>
                </div>
            </div>
        `;
    }


    // Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó„Éá„Éº„ÇøÔºà„Éá„Éï„Ç©„É´„Éà„Éó„É™„Çª„ÉÉ„Éà5„Å§ + ËøΩÂä†„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
    const availableSteps = [
        // === „Éá„Éï„Ç©„É´„Éà„Éó„É™„Çª„ÉÉ„ÉàÔºàÂü∫Êú¨5„Çπ„ÉÜ„ÉÉ„ÉóÔºâ ===
        {
            name: 'Á´ã„Å°‰ºö„ÅÑÊó•',
            icon: 'fas fa-user-check',
            key: 'step_attendance',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: '‰∫àÂÆöÊó•',
                    type: 'date',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'Á´ã„Å°‰ºö„ÅÑÂÆå‰∫Ü',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'waiting', label: 'Á´ã„Å°‰ºö„ÅÑÂæÖ„Å°', color: 'warning' },
                { key: 'in_progress', label: 'Á´ã„Å°‰ºö„ÅÑ‰∏≠', color: 'info' },
                { key: 'completed', label: 'Á´ã„Å°‰ºö„ÅÑÊ∏à„Åø', color: 'success' }
            ]
        },
        {
            name: 'ÁèæË™øÊó•',
            icon: 'fas fa-clipboard-list',
            key: 'step_survey',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: '‰∫àÂÆöÊó•',
                    type: 'date',
                    required: false
                },
                {
                    name: 'assignees',
                    label: 'ÊãÖÂΩìËÄÖ',
                    type: 'staff_select_list',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'ÁèæË™øÂÆå‰∫Ü',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'waiting', label: 'ÁèæË™øÂæÖ„Å°', color: 'warning' },
                { key: 'completed', label: 'ÁèæË™øÊ∏à„Åø', color: 'success' }
            ]
        },
        {
            name: 'Ë¶ãÁ©ç„ÇÇ„ÇäÁô∫Ë°åÊó•',
            icon: 'fas fa-calculator',
            key: 'step_estimate',
            type: 'complex',
            fields: [
                {
                    name: 'issued_date',
                    label: 'Áô∫Ë°åÊó•',
                    type: 'date',
                    required: false
                },
                {
                    name: 'not_required',
                    label: 'Ë¶ãÁ©ç„ÇÇ„Çä‰∏çË¶Å',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'pending', label: 'Ë¶ãÁ©ç„ÇÇ„ÇäÊõ∏Áô∫Ë°å', color: 'info' },
                { key: 'under_review', label: 'Ë¶ãÁ©ç„ÇÇ„ÇäÂØ©Êüª‰∏≠', color: 'warning' },
                { key: 'approved', label: 'Ë¶ãÁ©ç„ÇÇ„ÇäÊâøË™çÊ∏à„Åø', color: 'success' }
            ]
        },
        {
            name: 'ÁùÄÂ∑•Êó•',
            icon: 'fas fa-hard-hat',
            key: 'step_construction_start',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: '‰∫àÂÆöÊó•',
                    type: 'date',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'ÁùÄÂ∑•ÂÆå‰∫Ü',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'waiting', label: 'ÁùÄÂ∑•Êó•ÂæÖ„Å°', color: 'warning' },
                { key: 'in_progress', label: 'Â∑•‰∫ã‰∏≠', color: 'primary' },
                { key: 'completed', label: 'Â∑•‰∫ãÂÆå‰∫Ü', color: 'success' }
            ]
        },
        {
            name: 'ÂÆåÂ∑•Êó•',
            icon: 'fas fa-check-circle',
            key: 'step_completion',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: '‰∫àÂÆöÊó•',
                    type: 'date',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'ÂÆåÂ∑•Ê∏à„Åø',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'in_progress', label: 'ÊñΩÂ∑•‰∏≠', color: 'info' },
                { key: 'completed', label: 'ÂÆåÂ∑•', color: 'success' }
            ]
        },

        // === ËøΩÂä†„Ç™„Éó„Ç∑„Éß„É≥„Çπ„ÉÜ„ÉÉ„Éó ===
        {
            name: 'Â•ëÁ¥Ñ',
            icon: 'fas fa-handshake',
            key: 'step_contract',
            type: 'date'
        },
        {
            name: 'Ë´ãÊ±ÇÊõ∏Áô∫Ë°å',
            icon: 'fas fa-file-invoice-dollar',
            key: 'step_invoice',
            type: 'checkbox'
        },
        {
            name: 'Ë®±ÂèØÁî≥Ë´ã',
            icon: 'fas fa-file-signature',
            key: 'step_permit_application',
            type: 'date'
        },
        // Â∞ÜÊù•Êã°ÂºµÁî®„ÉÜ„É≥„Éó„É¨„Éº„Éà‰æãÔºö
        /*
        {
            name: 'ÊùêÊñôÊ§úÊüª',
            icon: 'fas fa-clipboard-check',
            key: 'material_inspection',
            type: 'complex',
            fields: [
                {
                    name: 'inspection_date',
                    label: 'Ê§úÊüªÊó•',
                    type: 'date',
                    required: true
                },
                {
                    name: 'inspector_id',
                    label: 'Ê§úÊüªÂì°',
                    type: 'select',
                    required: true,
                    options: [
                        { value: '', text: 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ' },
                        { value: 'inspector_1', text: 'Ê§úÊüªÂì°A' },
                        { value: 'inspector_2', text: 'Ê§úÊüªÂì°B' }
                    ]
                },
                {
                    name: 'passed',
                    label: 'Ê§úÊüªÂêàÊ†º',
                    type: 'checkbox',
                    required: false
                },
                {
                    name: 'notes',
                    label: 'ÂÇôËÄÉ',
                    type: 'text',
                    required: false
                }
            ]
        },
        */
        {
            name: 'Ë≥áÊùêÁô∫Ê≥®',
            icon: 'fas fa-boxes',
            key: 'step_material_order',
            type: 'date'
        },
        {
            name: 'ÂÆâÂÖ®Ë¨õÁøí',
            icon: 'fas fa-hard-hat',
            key: 'step_safety_training',
            type: 'checkbox'
        },
        {
            name: 'ÂÆåÊàêÊ§úÊüª',
            icon: 'fas fa-clipboard-check',
            key: 'step_final_inspection',
            type: 'date'
        },
        {
            name: 'ÂºïÊ∏°„Åó',
            icon: 'fas fa-key',
            key: 'step_handover',
            type: 'date'
        },
        {
            name: '‰øùË®ºÊõ∏Áô∫Ë°å',
            icon: 'fas fa-certificate',
            key: 'step_warranty_issue',
            type: 'checkbox'
        }
    ];

    // Sortable.js„ÅÆÂàùÊúüÂåñ
    function initializeSortable() {
        const progressContainer = document.getElementById('activeSteps');

        // Ë¶ÅÁ¥†„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØÂàùÊúüÂåñ„Çí„Çπ„Ç≠„ÉÉ„Éó
        if (!progressContainer) {
            console.warn('activeSteps element not found, skipping Sortable initialization');
            return;
        }

        if (sortable) {
            sortable.destroy();
        }

        sortable = Sortable.create(progressContainer, {
            animation: 150,
            disabled: !editMode,
            filter: 'button, .btn, input, select, textarea, .progress-step-content',
            preventOnFilter: false,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: function (evt) {
                // „Éâ„É©„ÉÉ„Ç∞ÈñãÂßãÊôÇ„ÅØÁèæÂú®„ÅÆË°®Á§∫Áä∂ÊÖã„ÇíÁ∂≠ÊåÅÔºà‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºâ
            },
            onEnd: function (evt) {
                // „Éâ„É©„ÉÉ„Ç∞ÁµÇ‰∫ÜÊôÇ„ÅÆÂá¶ÁêÜ
                console.log('„Çπ„ÉÜ„ÉÉ„ÉóÈ†ÜÂ∫èÂ§âÊõ¥:', evt.oldIndex, '->', evt.newIndex);
                // ProjectProgressStep„ÅÆÈ†ÜÂ∫è„ÅØ„ÄÅ„Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÊôÇ„Å´Ëá™ÂãïÁöÑ„Å´Êõ¥Êñ∞„Åï„Çå„Åæ„Åô
            }
        });
    }

    // Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Å´Ë°®Á§∫
    function loadAvailableSteps() {
        const container = $('#availableSteps');
        container.empty();

        availableSteps.forEach(step => {
            // Êó¢„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çπ„ÉÜ„ÉÉ„Éó„ÅØË°®Á§∫„Åó„Å™„ÅÑ
            if ($('.progress-step[data-step="' + step.key + '"]').length > 0) {
                return;
            }

            // ÁâπÂà•Âá¶ÁêÜ„ÅØ‰∏çË¶Å - „Åô„Åπ„Å¶„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„Çí„Ç§„É≥„Éô„É≥„Éà„É™„Éº„Å´Ë°®Á§∫

            const stepHtml = `
                <div class="col-auto mb-1">
                    <button type="button" class="btn btn-outline-success btn-sm add-step-btn"
                            data-step-key="${step.key}"
                            style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="${step.icon}" style="font-size: 0.6rem;"></i> ${step.name}+
                    </button>
                </div>
            `;
            container.append(stepHtml);
        });
    }

    // „Çπ„ÉÜ„ÉÉ„ÉóËøΩÂä†
    $(document).on('click', '.add-step-btn', function() {
        const stepKey = $(this).data('step-key');
        const stepData = availableSteps.find(s => s.key === stepKey);
        const $btn = $(this);

        console.log('Add step button clicked:', stepKey);
        console.log('Edit mode:', editMode);
        console.log('Step data found:', stepData);

        // Â∏∏„Å´Á∑®ÈõÜ„É¢„Éº„Éâ„Å™„ÅÆ„Åß„ÉÅ„Çß„ÉÉ„ÇØ‰∏çË¶Å
        // if (!editMode) {
        //     console.error('Not in edit mode! Cannot add step.');
        //     if (typeof toastr !== 'undefined') {
        //         toastr.warning('„Çπ„ÉÜ„ÉÉ„ÉóÁ∑®ÈõÜ„É¢„Éº„Éâ„Å´ÂÖ•„Å£„Å¶„Åã„Çâ„Çπ„ÉÜ„ÉÉ„Éó„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        //     } else {
        //         showErrorModal('„Çπ„ÉÜ„ÉÉ„ÉóÁ∑®ÈõÜ„É¢„Éº„Éâ„Å´ÂÖ•„Å£„Å¶„Åã„Çâ„Çπ„ÉÜ„ÉÉ„Éó„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        //     }
        //     return;
        // }

        if (!stepData) {
            console.error('Step data not found for key:', stepKey);
            if (typeof toastr !== 'undefined') {
                toastr.error('„Çπ„ÉÜ„ÉÉ„Éó„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
            } else {
                showErrorModal('„Çπ„ÉÜ„ÉÉ„Éó„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ');
            }
            return;
        }

        if (stepData) {
            // „Çπ„ÉÜ„ÉÉ„Éó„ÅåÊó¢„Å´Â≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            const existingStep = $(`.progress-step[data-step="${stepKey}"]`);
            if (existingStep.length > 0) {
                console.log('Step already exists:', stepKey);
                if (typeof toastr !== 'undefined') {
                    toastr.info(`${stepData.name}„ÅØÊó¢„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ`);
                } else {
                    showErrorModal(`${stepData.name}„ÅØÊó¢„Å´ËøΩÂä†„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ`);
                }
                return;
            }

            // ÁèæÂú∞Ë™øÊüª„Çπ„ÉÜ„ÉÉ„Éó„Åß survey_required=false „ÅÆÂ†¥Âêà„ÅØAPI„ÇíÂëº„Å∂
            if ((stepData.key === 'step_survey' || stepData.key === 'survey') && stepData.apiEndpoint && !{% if project.survey_required %}true{% else %}false{% endif %}) {
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> ËøΩÂä†‰∏≠...');

                fetch(stepData.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // ÊàêÂäüÊôÇÔºö„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶Êñ∞„Åó„ÅÑ„Çπ„ÉÜ„ÉÉ„Éó„ÇíË°®Á§∫
                        location.reload();
                    } else {
                        showErrorModal('„Çπ„ÉÜ„ÉÉ„Éó„ÅÆËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + data.error);
                        $btn.prop('disabled', false).html('<i class="fas fa-plus"></i> ËøΩÂä†');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorModal('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
                    $btn.prop('disabled', false).html('<i class="fas fa-plus"></i> ËøΩÂä†');
                });
            } else {
                // ÈÄöÂ∏∏„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂ†¥ÂêàÔºàÂü∫Êú¨„Çπ„ÉÜ„ÉÉ„Éó„ÇÇÂê´„ÇÄÔºâ
                if (stepData.type === 'basic') {
                    // Âü∫Êú¨„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂ†¥Âêà„ÅØÂØæÂøú„Åô„ÇãHTMLÁîüÊàêÈñ¢Êï∞„ÇíÂëº„Å∂
                    let stepHtml = '';
                    switch (stepData.key) {
                        case 'estimate':
                            stepHtml = generateEstimateStepHtml();
                            break;
                        case 'survey':
                            stepHtml = generateSurveyStepHtml();
                            break;
                        case 'contract':
                            stepHtml = generateContractStepHtml();
                            break;
                        case 'work_start':
                            stepHtml = generateWorkStartStepHtml();
                            break;
                        case 'work_end':
                            stepHtml = generateWorkEndStepHtml();
                            break;
                        case 'invoice':
                            stepHtml = generateInvoiceStepHtml();
                            break;
                        default:
                            stepHtml = generateAvailableStepHtml(stepData);
                    }

                    // Ë´ãÊ±ÇÊõ∏Áô∫Ë°å„ÅÆÂâç„Å´ÊåøÂÖ•
                    const invoiceStep = $('.progress-step[data-step="invoice"]');
                    if (invoiceStep.length > 0) {
                        invoiceStep.before(stepHtml);
                        console.log(`Added step ${stepData.key} before invoice step`);
                    } else {
                        $('#activeSteps').append(stepHtml);
                        console.log(`Added step ${stepData.key} to end of active steps`);
                    }

                    // ÈÄöÁü•„ÇíË°®Á§∫Ôºà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§Ôºâ
                    // if (typeof toastr !== 'undefined') {
                    //     toastr.success(`${stepData.name}„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ„ÄåÁ∑®ÈõÜÂÆå‰∫Ü„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    // } else {
                    //     showErrorModal(`${stepData.name}„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ„ÄåÁ∑®ÈõÜÂÆå‰∫Ü„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
                    // }
                } else {
                    addStepToProgress(stepData);
                }

                // „Éú„Çø„É≥„ÇíÂâäÈô§ÔºàÊ≠£„Åó„ÅÑ„Çª„É¨„ÇØ„Çø„Çí‰ΩøÁî®Ôºâ
                $(this).closest('.col-auto').remove();

                // Sortable„ÇíÂÜçÂàùÊúüÂåñÔºàDOM„ÅÆÊõ¥Êñ∞„ÇíÂæÖ„Å§„Åü„ÇÅÂ∞ë„ÅóÈÅÖÂª∂Ôºâ
                setTimeout(() => {
                    initializeSortable();
                    // „Çπ„ÉÜ„ÉÉ„ÉóÈ†ÜÂ∫è„Çí‰øùÂ≠ò
                    saveStepOrder();

                    // ProjectProgressStep„Å∏„ÅÆ‰øùÂ≠ò„ÅØ„ÄÅ„Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÊôÇ„Å´ÂÆüË°å„Åï„Çå„Åæ„Åô
                }, 50);

                // Ë°®Á§∫Âà∂Âæ°„ÇíÊõ¥Êñ∞
                updateSurveyAreaVisibility();

                // Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó„É™„Çπ„Éà„ÇíÂÜçË™≠„ÅøËæº„Åø
                loadAvailableSteps();

                console.log(`Step ${stepData.key} (${stepData.name}) successfully added to progress timeline`);
            }
        }
    });

    // „Çπ„ÉÜ„ÉÉ„ÉóÂâäÈô§ - „É¢„Éº„ÉÄ„É´‰ΩøÁî®
    let pendingDeleteBtn = null;

    $(document).on('click', '.remove-step-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // „Ç¢„Ç§„Ç≥„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÅüÂ†¥Âêà„ÇÇÁ¢∫ÂÆü„Å´„Éú„Çø„É≥Ë¶ÅÁ¥†„ÇíÂèñÂæó
        const $btn = $(e.target).closest('.remove-step-btn');
        const stepKey = $btn.data('step');
        console.log(`Remove button clicked for step: ${stepKey}`);

        if (!stepKey) {
            console.error('Step key not found');
            return;
        }

        // „Çπ„ÉÜ„ÉÉ„ÉóÂêç„ÇíÂèñÂæó
        const stepName = $btn.closest('.progress-step').find('.progress-step-header span').text().trim();

        // „É¢„Éº„ÉÄ„É´„Å´„Çπ„ÉÜ„ÉÉ„ÉóÂêç„ÇíË®≠ÂÆö
        $('#stepDeleteName').text(`„Äê${stepName}„Äë`);

        // ÂâäÈô§„Éú„Çø„É≥„ÅÆÂèÇÁÖß„Çí‰øùÂ≠ò
        pendingDeleteBtn = $btn;

        // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        const deleteModal = new bootstrap.Modal(document.getElementById('stepDeleteModal'));
        deleteModal.show();
    });

    // „É¢„Éº„ÉÄ„É´„ÅÆÂâäÈô§Á¢∫ÂÆö„Éú„Çø„É≥
    $('#confirmStepDelete').on('click', function() {
        if (!pendingDeleteBtn) {
            console.error('No pending delete button');
            return;
        }

        const stepKey = pendingDeleteBtn.data('step');
        const stepName = pendingDeleteBtn.closest('.progress-step').find('.progress-step-header span').text().trim();

        console.log(`Removing step: ${stepKey}`);

        // „Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§
        pendingDeleteBtn.closest('.progress-step').remove();

        // ProjectProgressStep„Å∏„ÅÆ‰øùÂ≠ò„ÅØ„ÄÅ„Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÊôÇ„Å´ÂÆüË°å„Åï„Çå„Åæ„Åô

        loadAvailableSteps(); // „Ç§„É≥„Éô„É≥„Éà„É™„ÇíÂÜçË™≠„ÅøËæº„Åø
        // Sortable„ÇíÂÜçÂàùÊúüÂåñÔºàDOM„ÅÆÊõ¥Êñ∞„ÇíÂæÖ„Å§„Åü„ÇÅÂ∞ë„ÅóÈÅÖÂª∂Ôºâ
        setTimeout(() => {
            initializeSortable();
        }, 50);
        updateSurveyAreaVisibility(); // ÁèæÂú∞Ë™øÊüª„Ç®„É™„Ç¢„ÅÆË°®Á§∫Âà∂Âæ°„ÇíÊõ¥Êñ∞

        console.log(`Step ${stepKey} removed and order updated`);

        // Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('stepDeleteModal'));
        deleteModal.hide();

        // ÊàêÂäü„É¢„Éº„ÉÄ„É´„Å´„Çπ„ÉÜ„ÉÉ„ÉóÂêç„ÇíË®≠ÂÆö
        $('#stepDeleteSuccessName').text(`„Äê${stepName}„Äë`);

        // ÊàêÂäü„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        const successModal = new bootstrap.Modal(document.getElementById('stepDeleteSuccessModal'));
        successModal.show();

        // ÂèÇÁÖß„Çí„ÇØ„É™„Ç¢
        pendingDeleteBtn = null;
    });

    // „Çπ„ÉÜ„ÉÉ„ÉóÂà•„ÅÆ‰∏ãË´ã„ÅëÊâãÈÖç„Ç´„Éº„ÉâHTML„ÇíÁîüÊàê
    function generateStepSubcontractCardHtml(stepKey) {
        // attendance, survey, construction_start „ÅÆ3„Å§„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„ÅøÂØæË±°
        const stepSubcontracts = {
            'attendance': {{ attendance_subcontracts_json|safe }},
            'survey': {{ survey_subcontracts_json|safe }},
            'construction_start': {{ construction_start_subcontracts_json|safe }}
        };

        const subcontracts = stepSubcontracts[stepKey];
        if (!subcontracts) return '';  // ÂØæË±°„Çπ„ÉÜ„ÉÉ„Éó„Åß„Å™„Åë„Çå„Å∞Á©∫ÊñáÂ≠ó„ÇíËøî„Åô

        const stepNames = {
            'attendance': 'Á´ã„Å°‰ºö„ÅÑ',
            'survey': 'ÁèæË™ø',
            'construction_start': 'ÁùÄÂ∑•'
        };

        let subcontractListHtml = '';
        if (subcontracts.length > 0) {
            subcontracts.forEach(sub => {
                subcontractListHtml += `
                    <div class="mb-2 p-2 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; font-weight: bold;">
                                    ${sub.contractor_name}
                                    <span class="badge bg-light text-dark border ms-1" style="font-size: 0.6rem;">${stepNames[stepKey]}</span>
                                </div>
                            </div>
                            <span class="badge bg-${sub.payment_status_color}" style="font-size: 0.6rem;">
                                ${sub.payment_status_display}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <div style="font-size: 0.65rem;">
                                <span class="text-muted">Â•ëÁ¥Ñ:</span> ¬•${sub.contract_amount ? sub.contract_amount.toLocaleString() : 0}<br>
                                <span class="text-muted">Ë´ãÊ±Ç:</span> ¬•${sub.billed_amount ? sub.billed_amount.toLocaleString() : 0}
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            subcontractListHtml = `
                <div class="text-center py-2">
                    <i class="fas fa-file-contract fa-2x text-muted mb-2"></i>
                    <p style="font-size: 0.7rem; color: #6c757d;" class="mb-0">Áô∫Ê≥®ÂÖàÊú™ÁôªÈå≤</p>
                </div>
            `;
        }

        return `
            <div class="card border-primary shadow-sm mb-2 mt-3" style="max-width: 600px;">
                <div class="card-header bg-white text-primary py-1 border-bottom border-primary">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" style="font-size: 0.85rem; line-height: 1.4;">
                            <i class="fas fa-file-contract"></i> ${stepNames[stepKey]}„ÅÆ‰∏ãË´ã„ÅëÊâãÈÖçÁä∂Ê≥Å
                            <span class="badge bg-primary text-white ms-2">${subcontracts.length}‰ª∂</span>
                        </h6>
                    </div>
                </div>
                <div class="card-body p-2">
                    ${subcontractListHtml}
                    <!-- ‰ΩúÊ•≠ËÄÖËøΩÂä†„Éú„Çø„É≥ -->
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary w-100" style="font-size: 0.65rem;" onclick="openSubcontractModal('${stepKey}')">
                            <i class="fas fa-user-plus"></i> ‰ΩúÊ•≠ËÄÖ„ÇíËøΩÂä†
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Ë≥áÊùêÁô∫Ê≥®Áä∂Ê≥Å„Ç´„Éº„ÉâHTML„ÇíÁîüÊàê
    function generateMaterialOrderCardHtml() {
        const materialOrders = {{ material_orders_json|safe }};

        let materialOrderListHtml = '';
        if (materialOrders && materialOrders.length > 0) {
            materialOrders.forEach(order => {
                const statusClass = order.status === 'completed' ? 'bg-success' :
                                  order.status === 'delivered' ? 'bg-info' :
                                  order.status === 'ordered' ? 'bg-warning' : 'bg-secondary';

                materialOrderListHtml += `
                    <div class="mb-2 p-2 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; font-weight: bold;">
                                    ${order.contractor ? order.contractor.name : 'Áô∫Ê≥®ÂÖàÊú™Ë®≠ÂÆö'}
                                </div>
                                ${order.items && order.items.length > 0 ? `
                                    <div style="font-size: 0.65rem; color: #6c757d;">
                                        ${order.items[0].material_name}${order.items.length > 1 ? ' ‰ªñ' + (order.items.length - 1) + '‰ª∂' : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <div style="font-size: 0.65rem;">
                                <span class="text-muted">ÈáëÈ°ç:</span> ¬•${order.total_amount ? order.total_amount.toLocaleString() : 0}<br>
                                <span class="text-muted">Áô∫Ê≥®Êó•:</span> ${order.order_date || '-'}
                            </div>
                            <span class="badge ${statusClass}" style="font-size: 0.6rem;">
                                ${order.status_display || '-'}
                            </span>
                        </div>
                    </div>
                `;
            });
        } else {
            materialOrderListHtml = `
                <div class="text-center py-2">
                    <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                    <p style="font-size: 0.7rem; color: #6c757d;" class="mb-0">Ë≥áÊùêÁô∫Ê≥®Êú™ÁôªÈå≤</p>
                </div>
            `;
        }

        return `
            <div class="card border-warning shadow-sm mb-2 mt-3" style="max-width: 600px;">
                <div class="card-header bg-white text-warning py-1 border-bottom border-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" style="font-size: 0.85rem; line-height: 1.4;">
                            <i class="fas fa-box-open"></i> Ë≥áÊùêÁô∫Ê≥®Áä∂Ê≥Å
                            <span class="badge bg-warning text-white ms-2">${materialOrders ? materialOrders.length : 0}‰ª∂</span>
                        </h6>
                    </div>
                </div>
                <div class="card-body p-2">
                    ${materialOrderListHtml}
                    <!-- Ë≥áÊùêÁô∫Ê≥®„ÇíËøΩÂä†„Éú„Çø„É≥ -->
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-warning w-100" style="font-size: 0.65rem;" onclick="openMaterialOrderModal()">
                            <i class="fas fa-plus"></i> Ë≥áÊùêÁô∫Ê≥®„ÇíËøΩÂä†
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó„Åã„ÇâÂÆåÂÖ®„Å™„Çπ„ÉÜ„ÉÉ„ÉóHTML„ÇíÁîüÊàê
    function generateAvailableStepHtml(stepData) {
        const fieldHtml = generateFieldHtml(stepData);

        // attendance, survey, construction_start „ÅÆÂ†¥Âêà„ÅØ‰∏ãË´ã„ÅëÊâãÈÖç„Ç´„Éº„Éâ„ÇíËøΩÂä†
        // material_order „ÅÆÂ†¥Âêà„ÅØË≥áÊùêÁô∫Ê≥®Áä∂Ê≥Å„Ç´„Éº„Éâ„ÇíËøΩÂä†
        let additionalCardHtml = '';
        // step_„Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíÈô§Âéª„Åó„Å¶Ê≠£Ë¶èÂåñ
        const stepKeyNormalized = stepData.key.replace('step_', '');
        if (['attendance', 'survey', 'construction_start'].includes(stepKeyNormalized)) {
            additionalCardHtml = generateStepSubcontractCardHtml(stepKeyNormalized);
        } else if (stepKeyNormalized === 'material_order') {
            additionalCardHtml = generateMaterialOrderCardHtml();
        }

        // üîß FIX: Generate status HTML based on step's completion state and scheduled date
        let statusHtml = '<div class="progress-step-date"><span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span></div>';

        // Get step data from orderedSteps to check completion and scheduled date
        const orderedStep = orderedSteps.find(s => s.key === stepData.key);
        if (orderedStep && orderedStep.data) {
            const scheduled_date = orderedStep.data.scheduled_date;
            const actual_date = orderedStep.data.actual_date;
            const isCompleted = orderedStep.completed;

            if (isCompleted) {
                if (actual_date) {
                    statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(actual_date)}</div>`;
                } else if (scheduled_date) {
                    statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü: ${formatDate(scheduled_date)}</div>`;
                } else {
                    statusHtml = '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ÂÆå‰∫Ü</div>';
                }
            } else if (scheduled_date) {
                statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>‰∫àÂÆö: ${formatDate(scheduled_date)}</div>`;
            }
        }

        return `
            <div class="progress-step" data-step="${stepData.key}">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="„Éâ„É©„ÉÉ„Ç∞„Åó„Å¶‰∏¶„Å≥Êõø„Åà"></i>
                        <span><i class="${stepData.icon} me-2"></i><span class="progress-step-label">${stepData.name}</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="${stepData.key}" title="„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂâäÈô§">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    ${fieldHtml}
                    ${additionalCardHtml}
                </div>
            </div>
        `;
    }

    // „Éó„É≠„Ç∞„É¨„Çπ„Å´„Çπ„ÉÜ„ÉÉ„Éó„ÇíËøΩÂä†
    function addStepToProgress(stepData) {
        const stepHtml = generateAvailableStepHtml(stepData);

        // Ë´ãÊ±ÇÊõ∏Áô∫Ë°å„ÅÆÂâç„Å´ÊåøÂÖ•
        const invoiceStep = $('.progress-step[data-step="invoice"]');
        let $newStep;
        if (invoiceStep.length > 0) {
            invoiceStep.before(stepHtml);
            $newStep = invoiceStep.prev('.progress-step');
        } else {
            $('#activeSteps').append(stepHtml);
            $newStep = $('#activeSteps .progress-step').last();
        }

        // Êñ∞„Åó„ÅèËøΩÂä†„Åï„Çå„Åü„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂ±ïÈñãÁä∂ÊÖã„Å´„Åô„Çã
        $newStep.addClass('expanded');
        $newStep.find('.progress-step-content').show();

        // Sortable„ÇíÂÜçÂàùÊúüÂåñÔºàDOM„ÅÆÊõ¥Êñ∞„ÇíÂæÖ„Å§„Åü„ÇÅÂ∞ë„ÅóÈÅÖÂª∂Ôºâ
        setTimeout(() => {
            initializeSortable();
            // „Çπ„ÉÜ„ÉÉ„ÉóÈ†ÜÂ∫è„Çí‰øùÂ≠ò
            saveStepOrder();
        }, 50);

        // ÁèæÂú∞Ë™øÊüª„Ç®„É™„Ç¢„ÅÆË°®Á§∫Âà∂Âæ°„ÇíÊõ¥Êñ∞
        updateSurveyAreaVisibility();

        console.log(`Added step: ${stepData.key} (${stepData.name})`);

        // ÈÄöÁü•„ÇíË°®Á§∫Ôºà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§Ôºâ
        // if (typeof toastr !== 'undefined') {
        //     toastr.success(`${stepData.name}„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ„ÄåÁ∑®ÈõÜÂÆå‰∫Ü„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        // } else {
        //     showErrorModal(`${stepData.name}„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü„ÄÇ„ÄåÁ∑®ÈõÜÂÆå‰∫Ü„Äç„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ`);
        // }
    }

    // „Éï„Ç£„Éº„É´„Éâ„Çø„Ç§„Éó„Å´Âøú„Åò„ÅüHTML„ÇíÁîüÊàê
    function generateFieldHtml(stepData) {
        switch (stepData.type) {
            case 'complex':
                return generateComplexFieldHtml(stepData);
            case 'date':
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">‰∫àÂÆöÊó•</label>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="${stepData.key}" title="ÂÆüÊñΩÊó•„ÇíËøΩÂä†">
                            <i class="fas fa-plus me-1"></i>ÂÆüÊñΩÊó•
                        </button>
                    </div>
                    <input type="date" name="${stepData.key}_date" class="form-control scheduled-date-input">
                    <div class="actual-date-field mt-2" style="display: none;">
                        <label class="form-label">ÂÆüÊñΩÊó•</label>
                        <div class="input-group">
                            <input type="date" name="${stepData.key}_actual_date" class="form-control actual-date-input" value="">
                            <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="ÂÆüÊñΩÊó•„ÇíÂâäÈô§">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            case 'checkbox':
                return `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="${stepData.key}_completed"
                               id="${stepData.key}Completed">
                        <label class="form-check-label" for="${stepData.key}Completed">
                            <i class="fas fa-check me-1"></i>${stepData.name}ÂÆå‰∫Ü
                        </label>
                    </div>
                `;
            default:
                return `
                    <label class="form-label">${stepData.name}</label>
                    <input type="text" name="${stepData.key}_value" class="form-control">
                `;
        }
    }

    // Ë§áÂêà„Éï„Ç£„Éº„É´„Éâ„ÅÆHTMLÁîüÊàê
    function generateComplexFieldHtml(stepData) {
        if (!stepData.fields || !Array.isArray(stepData.fields)) {
            return `<p class="text-muted">„Éï„Ç£„Éº„É´„ÉâÂÆöÁæ©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</p>`;
        }

        let html = '';
        stepData.fields.forEach(field => {
            const fieldId = `${stepData.key}_${field.name}`;
            const fieldName = `dynamic_field_${stepData.key}_${field.name}`;  // dynamic_field_ „Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†

            html += `<div class="mb-1">`;

            // dependencyÂ±ûÊÄß„ÇíÂá¶ÁêÜÔºàdependsOn „Å® showWhen „Çí„Çµ„Éù„Éº„ÉàÔºâ
            const dependsOnField = field.dependsOn ? `dynamic_field_${stepData.key}_${field.dependsOn}` : '';
            const showWhenValue = field.showWhen || '';
            const dependencyAttr = dependsOnField ?
                `data-dependency-field="${dependsOnField}" data-dependency-value="${showWhenValue}"` : '';
            const initialDisplay = dependsOnField ? 'style="display: none;"' : '';

            // ‰æùÂ≠ò„Éï„Ç£„Éº„É´„ÉâÔºàÈùûË°®Á§∫„ÅÆÂèØËÉΩÊÄß„Åå„ÅÇ„ÇãÔºâ„ÅØrequired„Å´„Åó„Å™„ÅÑ
            const isRequired = field.required && !dependsOnField;

            switch (field.type) {
                case 'radio':
                    html += `<label class="form-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>`;
                    html += `<div class="d-flex gap-2">`;
                    if (field.options && Array.isArray(field.options)) {
                        field.options.forEach((option, index) => {
                            const isDefault = field.default === option.value;
                            html += `
                                <div class="form-check form-check-inline" style="margin-bottom: 0;">
                                    <input class="form-check-input" type="radio" name="${fieldName}" id="${fieldId}_${index}"
                                           value="${option.value}" ${isDefault ? 'checked' : ''} ${isRequired ? 'required' : ''} style="width: 14px; height: 14px;">
                                    <label class="form-check-label" for="${fieldId}_${index}" style="font-size: 0.7rem;">
                                        ${option.text}
                                    </label>
                                </div>
                            `;
                        });
                    }
                    html += `</div>`;
                    break;
                case 'date':
                    // complex_step_fields„Åã„ÇâÂÄ§„ÇíÂèñÂæó
                    const dateFieldKey = `${stepData.key}_${field.name}`;
                    const dateValue = complexStepFields[dateFieldKey] || '';

                    // scheduled_date„ÅÆÂ†¥Âêà„ÅØ‰∫àÂÆöÊó•+ÂÆüÊñΩÊó•„ÅÆÊßãÈÄ†
                    if (field.name === 'scheduled_date') {
                        const actualDateKey = `${stepData.key}_actual_date`;
                        const actualDateValue = complexStepFields[actualDateKey] || '';
                        const actualDateFieldName = `dynamic_field_${stepData.key}_actual_date`;

                        html += `
                            <div ${dependencyAttr} ${initialDisplay}>
                                <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 0.2rem;">
                                    <label class="form-label mb-0" style="font-size: 0.7rem;">${field.label}</label>
                                    <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="${stepData.key}" title="ÂÆüÊñΩÊó•„ÇíËøΩÂä†" style="font-size: 0.65rem; padding: 0.15rem 0.3rem; line-height: 1;">
                                        <i class="fas fa-plus" style="font-size: 0.6rem;"></i> ÂÆüÊñΩÊó•
                                    </button>
                                </div>
                                <input type="date" name="${fieldName}" id="${fieldId}" class="form-control scheduled-date-input" value="${dateValue}" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                                <div class="actual-date-field mt-1" style="display: ${actualDateValue ? 'block' : 'none'};">
                                    <label class="form-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">ÂÆüÊñΩÊó•</label>
                                    <div class="input-group">
                                        <input type="date" name="${actualDateFieldName}" class="form-control actual-date-input" value="${actualDateValue}" style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                                        <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="ÂÆüÊñΩÊó•„ÇíÂâäÈô§" style="font-size: 0.65rem; padding: 0.2rem 0.35rem; line-height: 1;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // ÈÄöÂ∏∏„ÅÆÊó•‰ªò„Éï„Ç£„Éº„É´„Éâ
                        html += `
                            <div ${dependencyAttr} ${initialDisplay}>
                                <label class="form-label" for="${fieldId}" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                                <input type="date" name="${fieldName}" id="${fieldId}" class="form-control" value="${dateValue}" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                            </div>
                        `;
                    }
                    break;
                case 'select':
                    // „Çπ„Çø„ÉÉ„ÉïÈÅ∏Êäû„ÅÆÂ†¥Âêà„ÅØÂãïÁöÑ„Ç™„Éó„Ç∑„Éß„É≥ÁîüÊàê
                    let options = field.options;
                    if (field.name === 'staff_id') {
                        options = generateStaffOptions();
                    }

                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                            <select name="${fieldName}" id="${fieldId}" class="form-select" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                    `;
                    if (options && Array.isArray(options)) {
                        options.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `</select>`;

                    // „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ„Éú„Çø„É≥„ÇíËøΩÂä†Ôºà„Åô„Åπ„Å¶„ÅÆ„Çπ„ÉÜ„ÉÉ„Éó„ÅßÔºâ
                    if (field.name === 'staff_id') {
                        html += `
                            <button type="button" class="btn btn-outline-secondary mt-1" onclick="openStaffManagementPanel()" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; line-height: 1.2;">
                                <i class="fas fa-users-cog" style="font-size: 0.6rem;"></i> ÊãÖÂΩìËÄÖÁÆ°ÁêÜ
                            </button>
                        `;
                    }
                    html += `</div>`;
                    break;
                case 'multiselect':
                    // Ë§áÊï∞ÈÅ∏Êäû„Éï„Ç£„Éº„É´„ÉâÔºàËÅ∑‰∫∫ÈÅ∏Êäû„Å™„Å©Ôºâ
                    let multioptions = field.options;
                    if (field.name === 'staff_ids') {
                        multioptions = generateStaffOptions();
                    }

                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                            <select name="${fieldName}" id="${fieldId}" class="form-select" multiple size="5" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem;">
                    `;
                    if (multioptions && Array.isArray(multioptions)) {
                        multioptions.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `</select>`;
                    html += `<small class="form-text text-muted" style="font-size: 0.65rem;">Ctrl/Cmd„Ç≠„Éº„ÇíÊäº„Åó„Å™„Åå„Çâ„ÇØ„É™„ÉÉ„ÇØ„ÅßË§áÊï∞ÈÅ∏Êäû</small>`;

                    // „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ„Éú„Çø„É≥„ÇíËøΩÂä†
                    if (field.name === 'staff_ids') {
                        html += `
                            <button type="button" class="btn btn-outline-secondary mt-1" onclick="openStaffManagementPanel()" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; line-height: 1.2;">
                                <i class="fas fa-users-cog" style="font-size: 0.6rem;"></i> ÊãÖÂΩìËÄÖÁÆ°ÁêÜ
                            </button>
                        `;
                    }
                    html += `</div>`;
                    break;
                case 'text':
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                            <input type="text" name="${fieldName}" id="${fieldId}" class="form-control" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                        </div>
                    `;
                    break;
                case 'checkbox':
                    html += `
                        <div class="form-check" ${dependencyAttr} ${initialDisplay}>
                            <input class="form-check-input" type="checkbox" name="${fieldName}" id="${fieldId}" ${isRequired ? 'required' : ''} style="width: 14px; height: 14px;">
                            <label class="form-check-label" for="${fieldId}" style="font-size: 0.7rem;">
                                <i class="fas fa-check me-1" style="font-size: 0.65rem;"></i>${field.label}
                            </label>
                        </div>
                    `;
                    break;
                case 'staff_select_list':
                    // ÂãïÁöÑ„Å´ËøΩÂä†ÂèØËÉΩ„Å™ÊãÖÂΩìËÄÖÈÅ∏Êäû„É™„Çπ„Éà
                    const staffOptions = generateStaffOptions();
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                            <div class="staff-select-container" id="${fieldId}_container">
                                <div class="staff-select-item mb-1">
                                    <select name="${fieldName}" class="form-select d-inline-block" style="width: calc(100% - 35px); font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                                        <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                    `;
                    if (staffOptions && Array.isArray(staffOptions)) {
                        staffOptions.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `
                                    </select>
                                    <button type="button" class="btn btn-outline-danger remove-staff-select-btn" style="display:none; font-size: 0.65rem; padding: 0.2rem 0.35rem; line-height: 1;">
                                        √ó
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex gap-1 mt-1">
                                <button type="button" class="btn btn-outline-primary add-staff-select-btn" data-container-id="${fieldId}_container" data-field-name="${fieldName}" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; line-height: 1.2;">
                                    <i class="fas fa-plus" style="font-size: 0.6rem;"></i> ÊãÖÂΩìËÄÖ„ÇíËøΩÂä†
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="openStaffManagementPanel()" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; line-height: 1.2;">
                                    <i class="fas fa-users-cog" style="font-size: 0.6rem;"></i> ÊãÖÂΩìËÄÖÁÆ°ÁêÜ
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    html += `<p class="text-warning">Êú™ÂØæÂøú„ÅÆ„Éï„Ç£„Éº„É´„Éâ„Çø„Ç§„Éó: ${field.type}</p>`;
            }

            html += `</div>`;
        });

        return html;
    }

    // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂà§ÂÆö
    function getComplexStepStatus(stepData, stepElement) {
        console.log('üîç getComplexStepStatus called for:', stepData.key, {
            hasFields: !!stepData.fields,
            fieldsIsArray: Array.isArray(stepData.fields),
            fieldsLength: stepData.fields ? stepData.fields.length : 0
        });

        if (!stepData.fields || !Array.isArray(stepData.fields)) {
            console.log('‚ö†Ô∏è No fields found for', stepData.key, '- returning Êú™ÂÆå‰∫Ü');
            return { completed: false, statusText: 'Êú™ÂÆå‰∫Ü', status: 'pending' };
        }

        const values = {};
        stepData.fields.forEach(field => {
            const fieldName = `dynamic_field_${stepData.key}_${field.name}`;  // dynamic_field_ „Éó„É¨„Éï„Ç£„ÉÉ„ÇØ„Çπ„ÇíËøΩÂä†
            const input = stepElement.find(`[name="${fieldName}"]`);
            console.log(`üîç Looking for field: ${fieldName}, found: ${input.length}`);

            if (input.length > 0) {
                if (field.type === 'checkbox') {
                    // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅØbooleanÂÄ§„ÇíËøî„Åô
                    values[field.name] = input.is(':checked');
                } else if (field.type === 'radio') {
                    // „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅØÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂÄ§„ÅÆ„Åø
                    if (input.is(':checked')) {
                        values[field.name] = input.val();
                    }
                } else if (field.type === 'multiselect') {
                    // Ë§áÊï∞ÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ - ÈÖçÂàó„ÇíÂá¶ÁêÜ
                    const val = input.val();
                    if (val && Array.isArray(val) && val.length > 0) {
                        values[field.name] = val.join(',');
                    }
                } else {
                    // „ÉÜ„Ç≠„Çπ„Éà„ÇÑÊó•‰ªò„Éï„Ç£„Éº„É´„Éâ - Á©∫ÊñáÂ≠óÂàó„ÅØÂê´„ÇÅ„Å™„ÅÑ
                    const val = input.val();
                    if (val && typeof val === 'string' && val.trim() !== '') {
                        values[field.name] = val.trim();
                    }
                }
            }
        });

        // ÊãÖÂΩìËÄÖÂêç„ÇíÂèñÂæó
        function getStaffInfo() {
            if (values.staff_id) {
                return getStaffName(values.staff_id);
            }
            return '';
        }

        // ‰ªäÊó•„ÅÆÊó•‰ªò„ÇíÂèñÂæóÔºàÊôÇÂàª„Å™„ÅóÔºâ
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        console.log('üîç Extracted values for', stepData.key, ':', values);

        // „Çπ„ÉÜ„ÉÉ„ÉóÂà•„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÂà§ÂÆöÔºà‰∫àÂÆöÊó•„Éô„Éº„ÇπÔºö‰∫àÂÆöÊó•„ÅåÈÅéÂéª„Å™„ÇâËá™ÂãïÂÆå‰∫ÜÔºâ
        switch (stepData.key) {
            case 'attendance':  // Á´ã„Å°‰ºö„ÅÑÊó•
            case 'step_attendance':
                const attCompleted = values.completed;
                const attScheduled = values.scheduled_date;
                const attActual = values.actual_date;
                console.log('üîç attendance status:', { attCompleted, attScheduled, attActual });
                const attStaff = getStaffInfo();

                // Priority 1: ÂÆüÊñΩÊó•„Åå„ÅÇ„Çå„Å∞ÂÆå‰∫ÜÊâ±„ÅÑ
                if (attActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">Á´ã„Å°‰ºö„ÅÑÊ∏à„Åø</span> ${formatDate(attActual)}${attStaff ? ' (' + attStaff + ')' : ''}`
                    };
                }

                // Priority 2: ÂÆå‰∫Ü„Éï„É©„Ç∞„Ååtrue„Å™„ÇâÂÆå‰∫ÜÊâ±„ÅÑ
                if (attCompleted) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">Á´ã„Å°‰ºö„ÅÑÊ∏à„Åø</span> ${attScheduled ? formatDate(attScheduled) : ''}${attStaff ? ' (' + attStaff + ')' : ''}`
                    };
                }

                // Priority 3: ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„Å™„ÇâËá™ÂãïÂÆå‰∫ÜÊâ±„ÅÑ
                if (attScheduled) {
                    const scheduledDate = new Date(attScheduled);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (scheduledDate < today) {
                        return {
                            completed: true,
                            status: 'completed',
                            statusText: `<span class="badge bg-success">Á´ã„Å°‰ºö„ÅÑÊ∏à„Åø</span> ${formatDate(attScheduled)}${attStaff ? ' (' + attStaff + ')' : ''}`
                        };
                    } else {
                        return {
                            completed: false,
                            status: 'waiting',
                            statusText: `<span class="badge bg-warning">Á´ã„Å°‰ºö„ÅÑÂæÖ„Å°</span> ${formatDate(attScheduled)}${attStaff ? ' (' + attStaff + ')' : ''}`
                        };
                    }
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>'
                    };
                }

            case 'survey':  // ÁèæË™øÊó•
            case 'step_survey':
                const surCompleted = values.completed;
                const surScheduled = values.scheduled_date;
                const surActual = values.actual_date;
                const surStaff = getStaffInfo();

                // Priority 1: ÂÆüÊñΩÊó•„Åå„ÅÇ„Çå„Å∞ÂÆå‰∫ÜÊâ±„ÅÑ
                if (surActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">ÁèæË™øÊ∏à„Åø</span> ${formatDate(surActual)}${surStaff ? ' (' + surStaff + ')' : ''}`
                    };
                }

                // Priority 2: ÂÆå‰∫Ü„Éï„É©„Ç∞„Ååtrue„Å™„ÇâÂÆå‰∫ÜÊâ±„ÅÑ
                if (surCompleted) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">ÁèæË™øÊ∏à„Åø</span> ${surScheduled ? formatDate(surScheduled) : ''}${surStaff ? ' (' + surStaff + ')' : ''}`
                    };
                }

                // Priority 3: ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„Å™„ÇâËá™ÂãïÂÆå‰∫ÜÊâ±„ÅÑ
                if (surScheduled) {
                    const scheduledDate = new Date(surScheduled);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (scheduledDate < today) {
                        return {
                            completed: true,
                            status: 'completed',
                            statusText: `<span class="badge bg-success">ÁèæË™øÊ∏à„Åø</span> ${formatDate(surScheduled)}${surStaff ? ' (' + surStaff + ')' : ''}`
                        };
                    } else {
                        return {
                            completed: false,
                            status: 'waiting',
                            statusText: `<span class="badge bg-warning">ÁèæË™øÂæÖ„Å°</span> ${formatDate(surScheduled)}${surStaff ? ' (' + surStaff + ')' : ''}`
                        };
                    }
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>'
                    };
                }

            case 'estimate':  // Ë¶ãÁ©ç„ÇÇ„ÇäÁô∫Ë°åÊó•
                const estIssued = values.issued_date;
                const estNotRequired = values.not_required;

                if (estNotRequired) {
                    return {
                        completed: true,
                        status: 'approved',
                        statusText: '<span class="badge bg-success">Ë¶ãÁ©ç„ÇÇ„Çä‰∏çË¶Å</span>'
                    };
                } else if (estIssued) {
                    return {
                        completed: false,
                        status: 'under_review',
                        statusText: `<span class="badge bg-warning">Ë¶ãÁ©ç„ÇÇ„ÇäÂØ©Êüª‰∏≠</span> ${formatDate(estIssued)}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>'
                    };
                }

            case 'construction_start':  // ÁùÄÂ∑•Êó•ÔºàÂÆüÊñΩÊó•ÂÑ™ÂÖà„ÄÅÂÆå‰∫Ü„Éï„É©„Ç∞„Éô„Éº„ÇπÔºâ
            case 'step_construction_start':
                const csCompleted = values.completed;
                const csScheduled = values.scheduled_date;
                const csActual = values.actual_date;
                const csStaff = getStaffInfo();

                // Priority 1: ÂÆüÊñΩÊó•„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„Çå„ÇíÂÑ™ÂÖà„Åó„Å¶ÂÆå‰∫ÜÊâ±„ÅÑ
                if (csActual) {
                    return {
                        completed: true,
                        status: 'in_progress',
                        statusText: `<span class="badge bg-primary">Â∑•‰∫ã‰∏≠</span> ${formatDate(csActual)}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                }

                // Priority 2: ÂÆå‰∫Ü„Éï„É©„Ç∞„Ååtrue„Å™„ÇâÂÆå‰∫ÜÊâ±„ÅÑ
                if (csCompleted) {
                    return {
                        completed: true,
                        status: 'in_progress',
                        statusText: `<span class="badge bg-primary">Â∑•‰∫ã‰∏≠</span> ${csScheduled ? formatDate(csScheduled) : ''}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                }

                // Priority 3: ‰∫àÂÆöÊó•„ÅåÈÅéÂéª„Å™„ÇâËá™ÂãïÂÆå‰∫ÜÊâ±„ÅÑ
                if (csScheduled) {
                    const scheduledDate = new Date(csScheduled);
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    if (scheduledDate < today) {
                        return {
                            completed: true,
                            status: 'in_progress',
                            statusText: `<span class="badge bg-primary">Â∑•‰∫ã‰∏≠</span> ${formatDate(csScheduled)}${csStaff ? ' (' + csStaff + ')' : ''}`
                        };
                    } else {
                        return {
                            completed: false,
                            status: 'waiting',
                            statusText: `<span class="badge bg-warning">ÁùÄÂ∑•Êó•ÂæÖ„Å°</span> ${formatDate(csScheduled)}${csStaff ? ' (' + csStaff + ')' : ''}`
                        };
                    }
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>'
                    };
                }

            case 'completion':  // ÂÆåÂ∑•Êó•ÔºàÂÆüÊñΩÊó•ÂÑ™ÂÖà„ÄÅÂÆå‰∫Ü„Éï„É©„Ç∞„Éô„Éº„ÇπÔºâ
            case 'step_completion':
                const compCompleted = values.completed;
                const compScheduled = values.scheduled_date;
                const compActual = values.actual_date;

                // üîß FIX: ÂÆüÊñΩÊó•„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„ÄÅ„Åù„Çå„ÇíÂÑ™ÂÖà„Åó„Å¶ÂÆå‰∫ÜÊâ±„ÅÑ
                if (compActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">ÂÆåÂ∑•</span> ${formatDate(compActual)}`
                    };
                }

                // üîß FIX: Only use completed flag, not past date auto-completion
                if (compCompleted) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">ÂÆåÂ∑•</span> ${compScheduled ? formatDate(compScheduled) : ''}`
                    };
                } else if (compScheduled) {
                    // ÁùÄÂ∑•Êó•„ÅÆÁä∂ÊÖã„ÇíÁ¢∫Ë™çÔºàÂÆüÊñΩÊó•„Åæ„Åü„ÅØcompleted„Éô„Éº„ÇπÔºâ
                    const constructionStartStep = $('#activeSteps .progress-step[data-step="step_construction_start"]');
                    let isConstructionStarted = false;

                    if (constructionStartStep.length > 0) {
                        const csActualInput = constructionStartStep.find('input[name*="actual_date"]');
                        const csCompletedInput = constructionStartStep.find('input[name*="completed"]');

                        // ÁùÄÂ∑•Êó•„ÅÆÂÆüÊñΩÊó•„ÅåÂÖ•Âäõ„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
                        const hasActualDate = csActualInput.length > 0 && csActualInput.val();

                        // ÁùÄÂ∑•Êó•„ÅÆÂÆå‰∫Ü„Éï„É©„Ç∞„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                        const csIsCompleted = csCompletedInput.length > 0 && csCompletedInput.is(':checked');

                        // üîß FIX: Remove past date auto-completion logic
                        isConstructionStarted = hasActualDate || csIsCompleted;
                    }

                    if (isConstructionStarted) {
                        return {
                            completed: false,
                            status: 'in_progress',
                            statusText: `<span class="badge bg-info">ÊñΩÂ∑•‰∏≠</span> ‰∫àÂÆö: ${formatDate(compScheduled)}`
                        };
                    } else {
                        return {
                            completed: false,
                            status: 'waiting',
                            statusText: `<span class="badge bg-warning">ÁùÄÂ∑•ÂæÖ„Å°</span> ‰∫àÂÆö: ${formatDate(compScheduled)}`
                        };
                    }
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>'
                    };
                }

            default:
                // üîß FIX: „Åù„ÅÆ‰ªñ„ÅÆ„Çπ„ÉÜ„ÉÉ„ÉóÔºöcompleted „Éï„É©„Ç∞„ÅÆ„Åø„ÅßÂà§ÂÆöÔºàÂÄ§„ÅÆÊúâÁÑ°„Åß„ÅØÂà§ÂÆö„Åó„Å™„ÅÑÔºâ
                const isStepCompleted = values.completed || false;

                if (isStepCompleted) {
                    return { completed: true, status: 'completed', statusText: '<span class="badge bg-success">ÂÆå‰∫Ü</span>' };
                } else {
                    return { completed: false, status: 'pending', statusText: '<span class="badge bg-secondary">Êú™ÂÆå‰∫Ü</span>' };
                }
        }
    }

    // ÊãÖÂΩìËÄÖ„Éû„Çπ„Çø„Éá„Éº„ÇøÔºà„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÂèñÂæóÔºâ
    let staffMaster = [
        {% for worker in internal_workers %}
        {
            id: '{{ worker.id }}',
            name: '{{ worker.name }}',
            department: '{{ worker.get_department_display|default:"" }}',
            phone: '{{ worker.phone|default:"" }}',
            hourly_rate: parseFloat("{{ worker.hourly_rate|default:0 }}".replace(/,/g, '')) || 0,
            specialties: '{{ worker.specialties|default:"" }}',
            active: {% if worker.is_active %}true{% else %}false{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // „Çπ„Çø„ÉÉ„ÉïÂêç„ÇíÂèñÂæó„Åô„Çã„Éò„É´„Éë„ÉºÈñ¢Êï∞
    function getStaffName(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        return staff ? staff.name : '‰∏çÊòé';
    }

    // „Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™„Çπ„Çø„ÉÉ„Éï„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„É™„Çπ„Éà„ÇíÁîüÊàê
    function generateStaffOptions() {
        const activeStaff = staffMaster.filter(s => s.active);
        return [
            { value: '', text: 'ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ' },
            ...activeStaff.map(staff => ({
                value: staff.id,
                text: `${staff.name} (${staff.department})`
            }))
        ];
    }

    // dependencyÊ©üËÉΩ - „É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆÂ§âÊõ¥„Åß„Éï„Ç£„Éº„É´„Éâ„ÅÆË°®Á§∫/ÈùûË°®Á§∫„ÇíÂàá„ÇäÊõø„Åà
    $(document).on('change', 'input[type="radio"]', function() {
        const changedFieldName = $(this).attr('name');
        const selectedValue = $(this).val();

        // „Åì„ÅÆÂ§âÊõ¥„Å´‰æùÂ≠ò„Åô„Çã„Éï„Ç£„Éº„É´„Éâ„ÇíË°®Á§∫/ÈùûË°®Á§∫
        $(`[data-dependency-field="${changedFieldName}"]`).each(function() {
            const dependencyValue = $(this).data('dependency-value');
            if (selectedValue === dependencyValue) {
                $(this).show();
            } else {
                $(this).hide();
                // ÈùûË°®Á§∫„Å´„Å™„Çã„Éï„Ç£„Éº„É´„Éâ„ÅÆÂÄ§„Çí„ÇØ„É™„Ç¢
                $(this).find('input, select').val('');
            }
        });
    });

    // Ë§áÂêà„Çπ„ÉÜ„ÉÉ„Éó„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $(document).on('change', 'input[name^="survey_"], select[name^="survey_"]', function() {
        const stepElement = $('.progress-step[data-step="step_survey"]');
        if (stepElement.length === 0) return;

        // ÁèæÂ†¥Ë™øÊüª„Çπ„ÉÜ„ÉÉ„Éó„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
        const sitesurvey = availableSteps.find(step => step.key === 'step_survey');
        if (!sitesurvey) return;

        const status = getComplexStepStatus(sitesurvey, stepElement);

        if (status.completed) {
            stepElement.addClass('completed');
        } else {
            stepElement.removeClass('completed');
        }

        stepElement.find('.progress-step-date').html(status.statusText);

        // ÈÄ≤ÊçóÊõ¥Êñ∞
        updateProgressTimeline();
        updateProgressStatus();
    });

    // „Çπ„Çø„ÉÉ„ÉïÁÆ°ÁêÜ„Éë„Éç„É´„ÇíÈñã„Åè
    window.openStaffManagementPanel = function() {
        $('#staffManagementModal').modal('show');
        refreshStaffList();
    };

    // „Çπ„Çø„ÉÉ„Éï„É™„Çπ„Éà„ÇíÊõ¥Êñ∞
    function refreshStaffList() {
        const tbody = $('#staffTableBody');
        tbody.empty();

        staffMaster.forEach((staff, index) => {
            const statusBadge = staff.active ?
                '<span class="badge bg-success">ÊúâÂäπ</span>' :
                '<span class="badge bg-secondary">ÁÑ°Âäπ</span>';

            const hourlyRateDisplay = staff.hourly_rate ? `¬•${staff.hourly_rate}/ÊôÇÈñì` : '-';
            tbody.append(`
                <tr data-staff-id="${staff.id}" style="cursor: pointer;" onclick="selectStaff('${staff.id}')" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                    <td><strong>${staff.name}</strong></td>
                    <td>${staff.department}</td>
                    <td>${hourlyRateDisplay}</td>
                    <td>${staff.specialties || '-'}</td>
                    <td>${statusBadge}</td>
                    <td onclick="event.stopPropagation()">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="editStaff('${staff.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    // ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Å´ÂèçÊò†
    window.selectStaff = function(staffId) {
        console.log('‚úÖ selectStaff called', staffId);

        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        const modalElement = document.getElementById('staffManagementModal');
        if (modalElement) {
            $(modalElement).removeClass('show').css('display', 'none');
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('overflow', '');
        }

        // ÊúÄÂæå„Å´„Éï„Ç©„Éº„Ç´„Çπ„Åï„Çå„Å¶„ÅÑ„ÅüÊãÖÂΩìËÄÖÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ„ÇíÊé¢„Åô
        const lastFocusedSelect = $('.staff-select-container select').last();
        if (lastFocusedSelect.length > 0) {
            lastFocusedSelect.val(staffId);
            console.log('‚úÖ ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü:', staffId);
        } else {
            // „Éï„Ç©„Éº„Ç´„Çπ„Åï„Çå„Åü„Éï„Ç£„Éº„É´„Éâ„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅ„Åô„Åπ„Å¶„ÅÆstaff_select_list„Éï„Ç£„Éº„É´„Éâ„ÅÆÊúÄÂàù„ÅÆÁ©∫Ê¨Ñ„ÇíÂüã„ÇÅ„Çã
            $('.staff-select-container select').each(function() {
                if (!$(this).val()) {
                    $(this).val(staffId);
                    console.log('‚úÖ ÊãÖÂΩìËÄÖ„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„ÅüÔºàÁ©∫Ê¨Ñ„Å´Ôºâ:', staffId);
                    return false; // break
                }
            });
        }
    };

    // „Çπ„Çø„ÉÉ„ÉïËøΩÂä†
    window.addNewStaff = function() {
        $('#staffModalTitle').text('Êñ∞„Åó„ÅÑÊãÖÂΩìËÄÖ„ÇíËøΩÂä†');
        $('#staffForm')[0].reset();
        $('#staffId').val('');
        $('#staffModal').modal('show');
    };

    // „Çπ„Çø„ÉÉ„ÉïÁ∑®ÈõÜ
    window.editStaff = function(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        if (!staff) return;

        $('#staffModalTitle').text('ÊãÖÂΩìËÄÖ„ÇíÁ∑®ÈõÜ');
        $('#staffId').val(staff.id);
        $('#staffName').val(staff.name);
        $('#staffDepartment').val(staff.department);
        $('#staffPhone').val(staff.phone || '');
        $('#staffHourlyRate').val(staff.hourly_rate || '');
        $('#staffSpecialties').val(staff.specialties || '');
        $('#staffActive').prop('checked', staff.active);
        $('#staffModal').modal('show');
    };

    // „Çπ„Çø„ÉÉ„ÉïÂâäÈô§
    window.deleteStaff = function(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        if (!staff) return;

        // „É¢„Éº„ÉÄ„É´„Å´ÊãÖÂΩìËÄÖÂêç„ÇíË®≠ÂÆö
        $('#deleteStaffName').text(staff.name);

        // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        const modal = new bootstrap.Modal(document.getElementById('staffDeleteConfirmModal'));
        modal.show();

        // backdrop z-index„ÇíË™øÊï¥
        setTimeout(function() {
            $('.modal-backdrop').last().css('z-index', 10049);
        }, 10);

        // Á¢∫Ë™ç„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÇíË®≠ÂÆö
        $('#confirmDeleteStaffBtn').off('click').on('click', function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>ÂâäÈô§‰∏≠...');

            $.ajax({
                url: `/orders/api/staff/${staffId}/`,
                method: 'DELETE',
                dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
                success: function(response) {
                    console.log('ÂâäÈô§ÊàêÂäü:', response);

                    // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                    if (response && response.success) {
                        staffMaster = staffMaster.filter(s => s.id !== staffId);
                        refreshStaffList();
                        updateStaffSelects();
                        modal.hide();
                        if (typeof toastr !== 'undefined') {
                            toastr.success('ÊãÖÂΩìËÄÖ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü');
                        }
                    } else {
                        console.error('ÂâäÈô§Â§±Êïó:', response);
                        if (typeof toastr !== 'undefined') {
                            toastr.error(response.error || 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                        } else {
                            showErrorModal('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (response.error || ''));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ÂâäÈô§„Ç®„É©„ÉºË©≥Á¥∞:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });

                    let errorMessage = 'ÂâäÈô§‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                    } else if (xhr.status === 403) {
                        errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    } else if (xhr.status === 404) {
                        errorMessage = '„Ç®„É©„Éº: ÊãÖÂΩìËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                    } else if (xhr.status >= 500) {
                        errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                    }

                    if (typeof toastr !== 'undefined') {
                        toastr.error(errorMessage);
                    }
                },
                complete: function() {
                    $('#confirmDeleteStaffBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>ÂâäÈô§„Åô„Çã');
                }
            });
        });
    };

    // „Çπ„Çø„ÉÉ„Éï‰øùÂ≠ò
    window.saveStaff = function() {
        const staffId = $('#staffId').val();
        const name = $('#staffName').val().trim();
        const department = $('#staffDepartment').val().trim();
        const phone = $('#staffPhone').val().trim();
        const hourly_rate = parseFloat($('#staffHourlyRate').val()) || 0;
        const specialties = $('#staffSpecialties').val().trim();
        const active = $('#staffActive').is(':checked');

        if (!name) {
            showErrorModal('ÊãÖÂΩìËÄÖÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
            return;
        }

        const staffData = {
            name: name,
            department: department,
            phone: phone,
            hourly_rate: hourly_rate,
            specialties: specialties,
            active: active
        };

        if (staffId) {
            // Êó¢Â≠ò„Çπ„Çø„ÉÉ„Éï„ÇíÊõ¥Êñ∞
            $.ajax({
                url: `/orders/api/staff/${staffId}/`,
                method: 'PUT',
                dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
                data: JSON.stringify(staffData),
                contentType: 'application/json',
                success: function(response) {
                    console.log('Êõ¥Êñ∞ÊàêÂäü:', response);

                    // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                    if (response && response.success) {
                        const staff = staffMaster.find(s => s.id === staffId);
                        if (staff) {
                            Object.assign(staff, response.staff);
                        }
                        $('#staffModal').modal('hide');
                        refreshStaffList();
                        updateStaffSelects();
                        if (typeof toastr !== 'undefined') {
                            toastr.success('ÊãÖÂΩìËÄÖ„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                        }
                    } else {
                        console.error('Êõ¥Êñ∞Â§±Êïó:', response);
                        if (typeof toastr !== 'undefined') {
                            toastr.error(response.error || 'Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                        } else {
                            showErrorModal('Êõ¥Êñ∞„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (response.error || ''));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Êõ¥Êñ∞„Ç®„É©„ÉºË©≥Á¥∞:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });

                    let errorMessage = 'Êõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                    } else if (xhr.status === 403) {
                        errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    } else if (xhr.status === 404) {
                        errorMessage = '„Ç®„É©„Éº: ÊãÖÂΩìËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                    } else if (xhr.status >= 500) {
                        errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                    }

                    if (typeof toastr !== 'undefined') {
                        toastr.error(errorMessage);
                    } else {
                        showErrorModal(errorMessage);
                    }
                }
            });
        } else {
            // Êñ∞„Åó„ÅÑ„Çπ„Çø„ÉÉ„Éï„ÇíËøΩÂä†
            $.ajax({
                url: '/orders/api/staff/',
                method: 'POST',
                dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
                data: JSON.stringify(staffData),
                contentType: 'application/json',
                success: function(response) {
                    console.log('ËøΩÂä†ÊàêÂäü:', response);

                    // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
                    if (response && response.success) {
                        staffMaster.push(response.staff);
                        $('#staffModal').modal('hide');
                        refreshStaffList();
                        updateStaffSelects();
                        if (typeof toastr !== 'undefined') {
                            toastr.success('ÊãÖÂΩìËÄÖ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
                        }
                    } else {
                        console.error('ËøΩÂä†Â§±Êïó:', response);
                        if (typeof toastr !== 'undefined') {
                            toastr.error(response.error || 'ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                        } else {
                            showErrorModal('ËøΩÂä†„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (response.error || ''));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ËøΩÂä†„Ç®„É©„ÉºË©≥Á¥∞:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });

                    let errorMessage = 'ËøΩÂä†‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
                    } else if (xhr.status === 403) {
                        errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
                    } else if (xhr.status === 404) {
                        errorMessage = '„Ç®„É©„Éº: „É™„ÇΩ„Éº„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
                    } else if (xhr.status >= 500) {
                        errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
                    }

                    if (typeof toastr !== 'undefined') {
                        toastr.error(errorMessage);
                    } else {
                        showErrorModal(errorMessage);
                    }
                }
            });
        }
    };

    // ÂÖ®„Å¶„ÅÆ„Çπ„Çø„ÉÉ„ÉïÈÅ∏Êäû„Éï„Ç£„Éº„É´„Éâ„ÇíÊõ¥Êñ∞
    function updateStaffSelects() {
        const newOptions = generateStaffOptions();
        $('select[name="survey_staff_id"]').each(function() {
            const currentValue = $(this).val();
            $(this).empty();
            newOptions.forEach(option => {
                const selected = option.value === currentValue ? 'selected' : '';
                $(this).append(`<option value="${option.value}" ${selected}>${option.text}</option>`);
            });
        });
    }

    // ÂàùÊúüÂåñÂá¶ÁêÜ
    $(document).ready(function() {
        console.log('Document ready - starting step initialization');

        // ÁèæÂú∞Ë™øÊüª„Ç®„É™„Ç¢„ÅÆÂ≠òÂú®Á¢∫Ë™ç
        console.log('Survey content area exists:', $('#surveyContentArea').length);
        console.log('Survey content area visible:', $('#surveyContentArea').is(':visible'));

        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØË°®Á§∫„Çí„ÇØ„É™„Ç¢„Åó„Å¶„Åã„ÇâÂàùÊúüÂåñ
        setTimeout(function() {
            console.log('Clearing fallback display and initializing steps');
            $('#activeSteps').empty();

            // „Çπ„ÉÜ„ÉÉ„Éó„ÇíÂàùÊúüÂåñ
            initializeSteps();
            // Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó„Çí„É≠„Éº„Éâ
            loadAvailableSteps();
            // „Éï„Ç©„Éº„É†„Éï„Ç£„Éº„É´„Éâ„ÅÆÂàùÊúüÂÄ§„Å´Âü∫„Å•„ÅÑ„Å¶„Çπ„ÉÜ„ÉÉ„ÉóÁä∂ÊÖã„ÇíÂêåÊúü
            syncFormFieldsToSteps();

            // Ë¶ãÁ©ç„ÇÇ„Çä„Éï„Ç°„Ç§„É´„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø
            setTimeout(loadEstimateFiles, 500);  // „Çπ„ÉÜ„ÉÉ„ÉóÁîüÊàêÂÆå‰∫Ü„ÇíÂæÖ„Å§

            // ÂàùÊúüÁä∂ÊÖã„ÅßÁ∑®ÈõÜË¶ÅÁ¥†„ÇíË°®Á§∫ÔºàeditMode = true - Â∏∏„Å´Á∑®ÈõÜ„É¢„Éº„ÉâÔºâ
            console.log('Setting initial edit mode state (ON - always enabled)');
            $('.remove-step-btn').show();
            $('.drag-handle').show();
            $('#stepInventory').show();

            // Âà©Áî®ÂèØËÉΩ„Å™„Çπ„ÉÜ„ÉÉ„Éó„Çí„É≠„Éº„Éâ
            if (typeof loadAvailableSteps === 'function') {
                loadAvailableSteps();
            }

            // ÂàùÊúüÂåñÂÆå‰∫ÜÂæå„Å´ÈÄ≤ÊçóÁä∂Ê≥Å„ÇíÊõ¥Êñ∞
            if (typeof updateProgressStatus === 'function') {
                updateProgressStatus();
            }

            console.log('Step initialization complete');
        }, 100);
    });
});

// „Éï„Ç°„Ç§„É´ÂâäÈô§Á¢∫Ë™ç - Phase 5
function confirmFileDelete(fileId, fileName) {
    showConfirmModal(`„Éï„Ç°„Ç§„É´„Äå${fileName}„Äç„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`, function() {
        const form = document.getElementById('fileDeleteForm');
        form.action = `/orders/projects/${projectId}/files/${fileId}/delete/`;
        form.submit();
    });
}
</script>

<!-- ÊãÖÂΩìËÄÖÁÆ°ÁêÜ„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="staffManagementModal" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffManagementModalLabel">
                    <i class="fas fa-users"></i> ÊãÖÂΩìËÄÖÁÆ°ÁêÜ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">ÊãÖÂΩìËÄÖ‰∏ÄË¶ß</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewStaff()">
                        <i class="fas fa-plus"></i> Êñ∞Ë¶èËøΩÂä†
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ÂêçÂâç</th>
                                <th>ÈÉ®ÁΩ≤</th>
                                <th>ÊôÇÁµ¶</th>
                                <th>Â∞ÇÈñÄÂàÜÈáé</th>
                                <th>Áä∂ÊÖã</th>
                                <th>Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- „Çπ„Çø„ÉÉ„Éï„É™„Çπ„Éà„ÅåÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„Çã -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>
</div>

<!-- ÊãÖÂΩìËÄÖÁ∑®ÈõÜ/ËøΩÂä†„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalTitle">ÊãÖÂΩìËÄÖ„ÇíËøΩÂä†</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    <div class="mb-3">
                        <label for="staffName" class="form-label">ÊãÖÂΩìËÄÖÂêç <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="staffName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staffDepartment" class="form-label">ÈÉ®ÁΩ≤</label>
                        <input type="text" class="form-control" id="staffDepartment" name="department">
                    </div>
                    <div class="mb-3">
                        <label for="staffHourlyRate" class="form-label">ÊôÇÁµ¶</label>
                        <div class="input-group">
                            <span class="input-group-text">¬•</span>
                            <input type="number" class="form-control" id="staffHourlyRate" name="hourly_rate" placeholder="‰æã: 3000">
                            <span class="input-group-text">/ÊôÇÈñì</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staffSpecialties" class="form-label">Â∞ÇÈñÄÂàÜÈáé</label>
                        <input type="text" class="form-control" id="staffSpecialties" name="specialties" placeholder="‰æã: ÈõªÊ∞óÂ∑•‰∫ã„ÄÅÈÖçÁÆ°">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="staffActive" name="active" checked>
                        <label class="form-check-label" for="staffActive">
                            ÊúâÂäπ
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()">‰øùÂ≠ò</button>
            </div>
        </div>
    </div>
</div>

<!-- ÊãÖÂΩìËÄÖÂâäÈô§Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="staffDeleteConfirmModal" tabindex="-1" style="z-index: 10050 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>ÂâäÈô§„ÅÆÁ¢∫Ë™ç
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>ÊãÖÂΩìËÄÖ„Äå<strong id="deleteStaffName"></strong>„Äç„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">„Ç≠„É£„É≥„Çª„É´</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteStaffBtn">
                    <i class="fas fa-trash me-2"></i>ÂâäÈô§„Åô„Çã
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ‰∏ãË´ã„Åë‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="subcontractModal" tabindex="-1" aria-labelledby="subcontractModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="subcontractModalLabel">
                    <i class="fas fa-user-plus me-2"></i>‰ΩúÊ•≠ËÄÖ„ÇíËøΩÂä†
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="subcontractForm">
                    {% csrf_token %}
                    <input type="hidden" id="subcontractStep" name="step">

                    <!-- Â§ñÊ≥®ÂÖàÊÉÖÂ†± -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Â§ñÊ≥®ÂÖàÊÉÖÂ†±</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-0">
                                <label class="form-label">
                                    Áô∫Ê≥®ÂÖà <span class="text-danger">*</span>
                                </label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="hidden" id="subcontractContractor" name="contractor" required>
                                    <input type="text" id="selectedContractorDisplay" class="form-control" readonly placeholder="‰∏ãË´ã„ÅëÁÆ°ÁêÜ„Åã„ÇâÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ" style="flex: 1; background-color: #f8f9fa; cursor: pointer;" onclick="openContractorManagementPanel()">
                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openContractorManagementPanel()" title="‰∏ãË´ã„ÅëÊ•≠ËÄÖ„ÇíÈÅ∏Êäû„ÉªÁÆ°ÁêÜ">
                                        <i class="fas fa-handshake"></i> ‰∏ãË´ã„ÅëÁÆ°ÁêÜ
                                    </button>
                                </div>
                                <small class="form-text text-muted">
                                    ‰∏ãË´ã„ÅëÁÆ°ÁêÜ„Éú„Çø„É≥„Åã„ÇâÊ•≠ËÄÖ„ÇíÈÅ∏Êäû„Åô„Çã„Å®„ÄÅ„Åù„ÅÆÊ•≠ËÄÖ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´„ÅåËá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- ÈáëÈ°çÁÆ°ÁêÜ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">ÈáëÈ°çÁÆ°ÁêÜ</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="subcontractContractAmount" class="form-label">
                                            Â•ëÁ¥ÑÈáëÈ°ç <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">¬•</span>
                                            <input type="number" class="form-control" id="subcontractContractAmount" name="contract_amount">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="subcontractBilledAmount" class="form-label">
                                            Ë¢´Ë´ãÊ±ÇÈ°ç
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text">¬•</span>
                                            <input type="number" class="form-control" id="subcontractBilledAmount" name="billed_amount">
                                        </div>
                                        <small class="form-text text-muted">ÂÆüÈöõ„Å´Ë´ãÊ±Ç„Åï„Çå„ÅüÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºà‰ªªÊÑèÔºâ</small>
                                    </div>
                                </div>
                            </div>

                            <!-- ËøΩÂä†Ë≤ªÁî® -->
                            <hr>
                            <h6 class="mb-3"><i class="fas fa-plus-circle me-1"></i>ËøΩÂä†Ë≤ªÁî®</h6>
                            <div id="modalAdditionalCostsContainer"></div>
                            <button type="button" class="btn btn-sm btn-outline-primary mb-3" onclick="addModalAdditionalCostRow()">
                                <i class="fas fa-plus me-1"></i>Ë≤ªÁî®„ÇíËøΩÂä†
                            </button>
                            <input type="hidden" id="modalAdditionalCostsData" name="additional_costs_data">

                            <!-- ËøΩÂä†Ë≤ªÁî®ÂêàË®àË°®Á§∫ -->
                            <div id="modal_additional_total_display" class="alert alert-secondary mt-2 mb-0" style="display: none;">
                                <strong>ËøΩÂä†Ë≤ªÁî®ÂêàË®à: ¬•<span id="modal_additional_total_amount">0</span></strong>
                            </div>

                            <!-- Ë´ãÊ±ÇÊõ∏„Éï„Ç°„Ç§„É´ -->
                            <hr>
                            <div class="mb-0">
                                <label for="subcontractInvoiceFile" class="form-label">
                                    <i class="fas fa-file-invoice me-1"></i>Ë´ãÊ±ÇÊõ∏„Éï„Ç°„Ç§„É´
                                </label>
                                <input type="file" class="form-control" id="subcontractInvoiceFile" name="invoice_file" accept=".pdf,.jpg,.jpeg,.png">
                                <small class="form-text text-muted">PDF„ÄÅJPG„ÄÅPNG„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂèØËÉΩ</small>
                            </div>
                        </div>
                    </div>

                    <!-- ÊîØÊâï„ÅÑÁÆ°ÁêÜ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">ÊîØÊâï„ÅÑÁÆ°ÁêÜ</h5>
                        </div>
                        <div class="card-body">
                            <!-- ÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´ÊÉÖÂ†±Ë°®Á§∫ -->
                            <div class="alert alert-info mb-3" id="contractorPaymentInfo" style="display: none;">
                                <h6 class="mb-2"><i class="fas fa-info-circle me-1"></i>ÈÅ∏Êäû„Åï„Çå„ÅüÊ•≠ËÄÖ„ÅÆÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´</h6>
                                <p class="mb-0" id="paymentCycleText"></p>
                            </div>

                            <!-- Âá∫Èáë‰∫àÂÆöÊó•Ëá™ÂãïË®àÁÆó -->
                            <div class="card mb-3 border-secondary">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="fas fa-calculator me-1"></i>Âá∫Èáë‰∫àÂÆöÊó•„ÇíËá™ÂãïË®àÁÆó„Åó„Å¶ÂÖ•Âäõ
                                        <i class="fas fa-info-circle ms-1"
                                           data-bs-toggle="popover"
                                           data-bs-placement="top"
                                           data-bs-trigger="hover"
                                           data-bs-content="Âü∫Ê∫ñÊó•„ÇíÈÅ∏Êäû„Åó„Å¶Ë®àÁÆó„Éú„Çø„É≥„ÇíÊäº„Åô„Å®„ÄÅÂá∫Èáë‰∫àÂÆöÊó•„Éï„Ç£„Éº„É´„Éâ„Å´Ëá™ÂãïÁöÑ„Å´ÂÖ•Âäõ„Åï„Çå„Åæ„Åô"
                                           style="cursor: help;"></i>
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <label for="modalReferenceDate" class="form-label">
                                                Âü∫Ê∫ñÊó• <small class="text-muted">ÔºàÂ•ëÁ¥ÑÊó•„ÇÑË´ãÊ±ÇÊó•„Å™„Å©Ôºâ</small>
                                            </label>
                                            <input type="date" id="modalReferenceDate" class="form-control" value="{{ today|date:'Y-m-d' }}">
                                        </div>
                                        <div class="col-md-6 mb-2 d-flex align-items-end">
                                            <button type="button" id="modalCalculatePaymentDueDate" class="btn btn-success w-100">
                                                <i class="fas fa-calculator me-1"></i>Ë®àÁÆó„Åó„Å¶Âá∫Èáë‰∫àÂÆöÊó•„Å´ÂÖ•Âäõ
                                            </button>
                                        </div>
                                    </div>
                                    <div id="modalCalculationResult" class="alert alert-success mt-2" style="display: none;">
                                        <i class="fas fa-check-circle me-1"></i><strong>Ë®àÁÆóÂÆå‰∫Ü:</strong> <span id="modalCalculatedDate"></span> „ÅåÂá∫Èáë‰∫àÂÆöÊó•„Å´ÂÖ•Âäõ„Åï„Çå„Åæ„Åó„Åü
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="subcontractPaymentStatus" class="form-label">
                                        ÊîØÊâï„ÅÑÁä∂Ê≥Å
                                    </label>
                                    <select class="form-select" id="subcontractPaymentStatus" name="payment_status">
                                        <option value="pending">Êú™Êâï„ÅÑ</option>
                                        <option value="processing">Âá¶ÁêÜ‰∏≠</option>
                                        <option value="paid">ÊîØÊâïÊ∏à</option>
                                    </select>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="subcontractPaymentDueDate" class="form-label">
                                        Âá∫Èáë‰∫àÂÆöÊó•
                                    </label>
                                    <input type="date" class="form-control" id="subcontractPaymentDueDate" name="payment_due_date">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="subcontractPaymentDate" class="form-label">
                                        Âá∫ÈáëÊó•
                                    </label>
                                    <input type="date" class="form-control" id="subcontractPaymentDate" name="payment_date">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="subcontractPurchaseOrderIssued" name="purchase_order_issued">
                                        <label class="form-check-label" for="subcontractPurchaseOrderIssued">
                                            Áô∫Ê≥®Êõ∏Áô∫Ë°åÊ∏à„Åø
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="subcontractPurchaseOrderFile" class="form-label">
                                        Áô∫Ê≥®Êõ∏„Éï„Ç°„Ç§„É´
                                    </label>
                                    <input type="file" class="form-control" id="subcontractPurchaseOrderFile" name="purchase_order_file" accept=".pdf,.jpg,.jpeg,.png">
                                    <small class="form-text text-muted">PDF„ÄÅJPG„ÄÅPNG„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâÂèØËÉΩ</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÈÉ®ÊùêË≤ªÁÆ°ÁêÜÔºàÊäò„Çä„Åü„Åü„ÅøÂèØËÉΩÔºâ -->
                    <div class="card mb-3 border-secondary">
                        <div class="card-header bg-light" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#materialCostSection">
                            <h6 class="mb-0">
                                <i class="fas fa-boxes me-2"></i>ÈÉ®ÊùêË≤ªÔºà‰ªªÊÑèÔºâ
                                <i class="fas fa-chevron-down float-end"></i>
                            </h6>
                        </div>
                        <div id="materialCostSection" class="collapse">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem1" class="form-label">ÈÉ®ÊùêË≤ªÈ†ÖÁõÆ‚ë†</label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem1" name="material_item_1" placeholder="‰æãÔºöÊú®Êùê">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost1" class="form-label">ÈÉ®ÊùêË≤ª‰ª£‚ë†</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¬•</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost1" name="material_cost_1">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem2" class="form-label">ÈÉ®ÊùêË≤ªÈ†ÖÁõÆ‚ë°</label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem2" name="material_item_2" placeholder="‰æãÔºöÈáëÂÖ∑">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost2" class="form-label">ÈÉ®ÊùêË≤ª‰ª£‚ë°</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¬•</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost2" name="material_cost_2">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem3" class="form-label">ÈÉ®ÊùêË≤ªÈ†ÖÁõÆ‚ë¢</label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem3" name="material_item_3" placeholder="‰æãÔºöÂ°óÊñô">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost3" class="form-label">ÈÉ®ÊùêË≤ª‰ª£‚ë¢</label>
                                        <div class="input-group">
                                            <span class="input-group-text">¬•</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost3" name="material_cost_3">
                                        </div>
                                    </div>
                                </div>

                                <!-- ÂãïÁöÑÈÉ®ÊùêË≤ªËøΩÂä†„Ç®„É™„Ç¢ -->
                                <hr>
                                <h6 class="mb-3"><i class="fas fa-plus-circle me-1"></i>ËøΩÂä†ÈÉ®ÊùêË≤ª</h6>
                                <div id="modalDynamicMaterialsContainer"></div>
                                <button type="button" class="btn btn-sm btn-outline-success mb-3" onclick="addModalMaterialRow()">
                                    <i class="fas fa-plus me-1"></i>ÈÉ®ÊùêË≤ª„ÇíËøΩÂä†
                                </button>
                                <input type="hidden" id="modalDynamicMaterialsData" name="dynamic_materials_data">

                                <!-- ÈÉ®ÊùêË≤ªÂêàË®àË°®Á§∫ -->
                                <div class="alert alert-info mb-0">
                                    <strong>ÈÉ®ÊùêË≤ªÂêàË®à: ¬•<span id="modalMaterialTotalAmount">0</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÂÇôËÄÉ -->
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">ÂÇôËÄÉ</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-0">
                                <label for="subcontractNotes" class="form-label">ÂÇôËÄÉ</label>
                                <textarea class="form-control" id="subcontractNotes" name="notes" rows="2"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Á∑è„Ç≥„Çπ„ÉàË°®Á§∫ -->
                    <div class="alert alert-warning mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>
                            <strong>Á∑è„Ç≥„Çπ„Éà: ¬•<span id="modalTotalCostAmount">0</span></strong>
                        </h5>
                        <small class="text-muted">Ôºà<span id="modalCostBaseLabel">Â•ëÁ¥ÑÈáëÈ°ç</span> + ÈÉ®ÊùêË≤ªÂêàË®à + ËøΩÂä†Ë≤ªÁî®Ôºâ</small>
                    </div>

                    <!-- ‰ªñ„ÅÆÂ∑•Á®ã„Å´„ÇÇËøΩÂä† -->
                    <div class="mb-3" id="additionalStepsSection" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-clone me-2"></i>‰ªñ„ÅÆÂ∑•Á®ã„Å´„ÇÇËøΩÂä†
                                </h6>
                                <small class="text-muted">Âêå„ÅòÊ•≠ËÄÖ„ÉªÂêå„ÅòÊù°‰ª∂„ÅßË§áÊï∞„ÅÆÂ∑•Á®ã„Å´‰∏ÄÊã¨ÁôªÈå≤„Åß„Åç„Åæ„Åô</small>
                            </div>
                            <div class="card-body">
                                <!-- Â∑•Á®ãÈÅ∏Êäû„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ -->
                                <div id="additionalStepsCheckboxes" class="mb-3">
                                    <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                                </div>

                                <!-- ÈáëÈ°ç„ÅÆË®≠ÂÆöÊñπÊ≥ï„ÇíÈÅ∏Êäû -->
                                <div id="costAllocationSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="mb-3">
                                        <i class="fas fa-yen-sign me-2"></i>ÈáëÈ°ç„ÅÆË®≠ÂÆöÊñπÊ≥ï
                                    </h6>
                                    <div class="mb-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="cost_allocation_method" id="costMethodLumpSum" value="lump_sum" checked>
                                            <label class="form-check-label" for="costMethodLumpSum">
                                                <strong>ÂÖ®Â∑•Á®ã‰∏ÄÂºè„ÅßÁôªÈå≤</strong>
                                                <div class="text-muted small">‰∏äË®ò„ÅÆÂ•ëÁ¥ÑÈáëÈ°ç„ÅßÂÖ®Â∑•Á®ã„Çí„Ç´„Éê„Éº„Åó„Åæ„ÅôÔºàËøΩÂä†Â∑•Á®ã„ÅØ¬•0„ÅßÈñ¢ÈÄ£‰ªò„ÅëÔºâ</div>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="cost_allocation_method" id="costMethodPerStep" value="per_step">
                                            <label class="form-check-label" for="costMethodPerStep">
                                                <strong>Â∑•Á®ã„Åî„Å®„Å´ÈáëÈ°ç„ÇíË®≠ÂÆö</strong>
                                                <div class="text-muted small">ÂêÑÂ∑•Á®ã„ÅÆÈáëÈ°ç„ÇíÂÄãÂà•„Å´ÂÖ•Âäõ„Åó„Åæ„Åô</div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- Â∑•Á®ã„Åî„Å®„ÅÆÈáëÈ°çÂÖ•ÂäõÊ¨Ñ -->
                                    <div id="perStepAmountsSection" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-1"></i>ÂêÑÂ∑•Á®ã„ÅÆÂ•ëÁ¥ÑÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                                        </div>
                                        <div id="perStepAmountsInputs">
                                            <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>„Ç≠„É£„É≥„Çª„É´
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSubcontract()">
                    <i class="fas fa-save me-1"></i>‰øùÂ≠ò
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ë≥áÊùêÁô∫Ê≥®‰ΩúÊàê„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="materialOrderModal" tabindex="-1" aria-labelledby="materialOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="materialOrderModalLabel">
                    <i class="fas fa-box-open me-2"></i>Ë≥áÊùêÁô∫Ê≥®„ÇíËøΩÂä†
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="materialOrderForm">
                    {% csrf_token %}

                    <!-- Ë≥áÊùêÊ•≠ËÄÖÈÅ∏Êäû -->
                    <div class="mb-3">
                        <label for="materialContractor" class="form-label">
                            Ë≥áÊùêÊ•≠ËÄÖ <span class="text-danger">*</span>
                        </label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="materialContractor" name="contractor" required style="flex: 1;">
                                <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
                                {% for contractor in contractors %}
                                <option value="{{ contractor.id }}">{{ contractor.name }}</option>
                                {% endfor %}
                            </select>
                            <a href="{% url 'order_management:contractor_create' %}?back={{ request.path }}" target="_blank" class="btn btn-outline-warning" title="Êñ∞Ë¶èÊ•≠ËÄÖ„ÇíËøΩÂä†">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>Êñ∞„Åó„ÅÑÊ•≠ËÄÖ„ÇíËøΩÂä†„Åô„ÇãÂ†¥Âêà„ÅØ<i class="fas fa-plus"></i>„Éú„Çø„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </small>
                    </div>

                    <!-- Áô∫Ê≥®ÊÉÖÂ†± -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="materialOrderDate" class="form-label">
                                    Áô∫Ê≥®Êó• <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="materialOrderDate" name="order_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="materialDeliveryDate" class="form-label">
                                    Â∏åÊúõÁ¥çÊúü
                                </label>
                                <input type="date" class="form-control" id="materialDeliveryDate" name="delivery_date">
                            </div>
                        </div>
                    </div>

                    <!-- Ë≥áÊùêÈ†ÖÁõÆ -->
                    <div class="mb-3">
                        <h6 class="text-warning border-bottom border-warning pb-2 mb-3">
                            <i class="fas fa-boxes me-1"></i>Ë≥áÊùêÈ†ÖÁõÆ
                        </h6>
                        <div id="materialItems">
                            <!-- ÊúÄÂàù„ÅÆË≥áÊùêÈ†ÖÁõÆ -->
                            <div class="material-item mb-3 p-3 bg-light rounded">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">Ë≥áÊùêÂêç <span class="text-danger">*</span></label>
                                        <input type="text" name="material_name[]" class="form-control" placeholder="‰æã: „Ç≥„É≥„ÇØ„É™„Éº„Éà" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Êï∞Èáè</label>
                                        <input type="number" name="quantity[]" class="form-control material-quantity" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">Âçò‰Ωç</label>
                                        <input type="text" name="unit[]" class="form-control" placeholder="‰æã: m¬≥">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Âçò‰æ°(ÂÜÜ)</label>
                                        <input type="number" name="unit_price[]" class="form-control material-unit-price" step="0.01" placeholder="0.00">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <label class="form-label">‰ªïÊßò„ÉªË¶èÊ†º</label>
                                        <input type="text" name="specification[]" class="form-control" placeholder="‰æã: 24-21-20">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ë≥áÊùêÈ†ÖÁõÆËøΩÂä†„Éú„Çø„É≥ -->
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="addMaterialItem()">
                            <i class="fas fa-plus me-1"></i>Ë≥áÊùêÈ†ÖÁõÆ„ÇíËøΩÂä†
                        </button>
                    </div>

                    <!-- ÂêàË®àÈáëÈ°çÔºàËá™ÂãïË®àÁÆóÔºâ -->
                    <div class="mb-3">
                        <div class="alert alert-warning">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <strong><i class="fas fa-calculator me-1"></i>ÂêàË®àÈáëÈ°ç:</strong>
                                </div>
                                <div class="col-md-6 text-end">
                                    <h4 class="mb-0" id="materialTotalAmount">¬•0</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ÂÇôËÄÉ -->
                    <div class="mb-3">
                        <label for="materialNotes" class="form-label">
                            ÂÇôËÄÉ
                        </label>
                        <textarea class="form-control" id="materialNotes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>„Ç≠„É£„É≥„Çª„É´
                </button>
                <button type="button" class="btn btn-warning" onclick="saveMaterialOrder()">
                    <i class="fas fa-save me-1"></i>‰øùÂ≠ò
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ê°à‰ª∂„Éï„Ç°„Ç§„É´ÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ - Phase 5 -->
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-folder-open me-2"></i>„Éï„Ç°„Ç§„É´ÁÆ°ÁêÜ
                </h5>
                <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-light btn-sm">
                    <i class="fas fa-cloud-upload-alt me-1"></i>„Éï„Ç°„Ç§„É´„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if project.files.all %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="5%">Á®ÆÂà•</th>
                                <th width="35%">„Éï„Ç°„Ç§„É´Âêç</th>
                                <th width="15%">„Çµ„Ç§„Ç∫</th>
                                <th width="20%">„Ç¢„ÉÉ„Éó„É≠„Éº„ÉâËÄÖ</th>
                                <th width="15%">Êó•ÊôÇ</th>
                                <th width="10%" class="text-center">Êìç‰Ωú</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in project.files.all %}
                            <tr {% if file.is_linked_file %}class="table-info"{% endif %}>
                                <td>
                                    {% if file.is_linked_file %}
                                        <span class="badge bg-info" title="„É™„É≥„ÇØ„Éï„Ç°„Ç§„É´">
                                            <i class="fas fa-link"></i>
                                        </span>
                                    {% else %}
                                        <span class="badge bg-success" title="„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Éï„Ç°„Ç§„É´">
                                            <i class="fas fa-upload"></i>
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.is_linked_file %}
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                        <strong>{{ file.file_name }}</strong>
                                        <br><small class="text-muted ms-4">
                                            {% if file.linked_source_type == 'purchase_order' %}
                                                Áô∫Ê≥®Êõ∏ÔºàË§áÊï∞Ê°à‰ª∂Âê´„ÇÄÔºâ
                                            {% elif file.linked_source_type == 'invoice' %}
                                                Ë´ãÊ±ÇÊõ∏ÔºàË§áÊï∞Ê°à‰ª∂Âê´„ÇÄÔºâ
                                            {% endif %}
                                        </small>
                                    {% else %}
                                        {% if 'pdf' in file.file_type %}
                                            <i class="fas fa-file-pdf text-danger me-2"></i>
                                        {% elif 'word' in file.file_type or 'document' in file.file_type %}
                                            <i class="fas fa-file-word text-primary me-2"></i>
                                        {% elif 'excel' in file.file_type or 'spreadsheet' in file.file_type %}
                                            <i class="fas fa-file-excel text-success me-2"></i>
                                        {% elif 'image' in file.file_type or 'jpg' in file.file_type or 'png' in file.file_type %}
                                            <i class="fas fa-file-image text-info me-2"></i>
                                        {% else %}
                                            <i class="fas fa-file text-secondary me-2"></i>
                                        {% endif %}
                                        <strong>{{ file.file_name }}</strong>
                                        {% if file.description %}
                                            <br><small class="text-muted ms-4">{{ file.description }}</small>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if not file.is_linked_file %}
                                        <span class="badge bg-light text-dark">{{ file.get_file_size_display }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.is_linked_file %}
                                        <span class="text-muted">Ëá™Âãï„É™„É≥„ÇØ</span>
                                    {% elif file.uploaded_by %}
                                        <i class="fas fa-user-circle me-1"></i>{{ file.uploaded_by.get_full_name|default:file.uploaded_by.username }}
                                    {% else %}
                                        <span class="text-muted">‰∏çÊòé</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if file.is_linked_file and file.linked_at %}
                                        <small>{{ file.linked_at|date:"Y/m/d H:i:s" }}</small>
                                    {% else %}
                                        <small>{{ file.uploaded_at|date:"Y/m/d H:i:s" }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if file.is_linked_file %}
                                        <a href="/media/{{ file.linked_source_file }}"
                                           class="btn btn-outline-primary btn-sm"
                                           target="_blank"
                                           title="PDF„ÇíÈñã„Åè">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                    {% else %}
                                        <div class="btn-group btn-group-sm" role="group">
                                            <a href="{% url 'order_management:project_file_download' project.pk file.pk %}"
                                               class="btn btn-outline-primary"
                                               title="„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ">
                                                <i class="fas fa-download"></i>
                                            </a>
                                            <button type="button"
                                                    class="btn btn-outline-danger"
                                                    onclick="confirmFileDelete({{ file.pk }}, '{{ file.file_name }}')"
                                                    title="ÂâäÈô§">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p class="mb-2">„Åæ„Å†„Éï„Ç°„Ç§„É´„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</p>
                    <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-info">
                        <i class="fas fa-cloud-upload-alt me-1"></i>ÊúÄÂàù„ÅÆ„Éï„Ç°„Ç§„É´„Çí„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- „Éï„Ç°„Ç§„É´ÂâäÈô§Á¢∫Ë™çÁî®„ÅÆ„Éï„Ç©„Éº„É† (ÈùûË°®Á§∫) - Phase 5 -->
<form id="fileDeleteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

<style>
/* „ÉÅ„É£„ÉÉ„ÉàUI„ÅÆ„Çπ„Çø„Ç§„É´ */
.comment-item {
    position: relative;
    border-left: 3px solid #dee2e6;
    padding: 15px;
    padding-right: 50px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s;
}

.comment-item:hover {
    border-left-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.comment-item.important {
    border-left-color: #ffc107;
    background: #fff3cd;
}

/* „É¶„Éº„Ç∂„Éº„Ç¢„Éê„Çø„Éº„ÅÆ„Çπ„Çø„Ç§„É´ */
.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    color: white;
    flex-shrink: 0;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.user-avatar.initials {
    background: #007bff;
}

.comment-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.comment-author {
    font-weight: 600;
    color: #0d6efd;
    margin-right: 10px;
}

.comment-date {
    color: #6c757d;
    font-size: 0.9em;
}

.comment-content {
    margin-top: 10px;
    line-height: 1.6;
}

.comment-important-badge {
    background: #ffc107;
    color: #000;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    margin-left: 10px;
}

/* Ê∑ª‰ªò„Éï„Ç°„Ç§„É´Èñ¢ÈÄ£„ÅÆ„Çπ„Çø„Ç§„É´ */
.comment-attachments {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-top: 10px;
}

.attachment-item {
    margin-bottom: 10px;
}

.attachment-link {
    display: inline-block;
    padding: 5px 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    text-decoration: none;
    color: #333;
    transition: all 0.2s;
}

.attachment-link:hover {
    background: #e9ecef;
    border-color: #0d6efd;
    color: #0d6efd;
    text-decoration: none;
}

.attachment-name {
    margin: 0 5px;
}

.attachment-size {
    color: #6c757d;
    font-size: 0.85em;
}

.attachment-preview {
    max-width: 300px;
    max-height: 200px;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s;
}

.attachment-preview:hover {
    transform: scale(1.05);
}

/* ÁîªÂÉè„É¢„Éº„ÉÄ„É´ */
.image-modal {
    display: block;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
}

.image-modal-content {
    position: relative;
    margin: auto;
    padding: 20px;
    max-width: 90%;
    max-height: 90%;
    top: 50%;
    transform: translateY(-50%);
}

.image-modal-content img {
    max-width: 100%;
    max-height: 80vh;
    display: block;
    margin: auto;
}

.image-modal-close {
    position: absolute;
    top: 10px;
    right: 25px;
    color: #f1f1f1;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
}

.image-modal-close:hover,
.image-modal-close:focus {
    color: #bbb;
}

/* „Éï„Ç°„Ç§„É´„Éó„É¨„Éì„É•„Éº */
.file-item {
    padding: 5px;
    margin: 2px 0;
    background: #f8f9fa;
    border-radius: 3px;
}

.selected-files {
    margin-bottom: 5px;
    color: #0d6efd;
}

/* „Çπ„É¨„ÉÉ„ÉâË°®Á§∫„ÅÆ„Çπ„Çø„Ç§„É´ */
.comment-reply {
    margin-left: 40px;
    margin-top: 10px;
    border-left-width: 2px;
}

.comment-replies {
    transition: all 0.3s ease;
}

.comment-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 6px;
    align-items: center;
}

.reply-button,
.toggle-replies {
    font-size: 0.7rem;
    padding: 2px 4px;
    transition: color 0.2s;
}

.reply-button:hover,
.toggle-replies:hover {
    color: #0d6efd !important;
    text-decoration: none;
}

.reply-form {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.toggle-replies i {
    transition: transform 0.3s ease;
}
</style>

<script>
// „Ç≥„É°„É≥„ÉàÊ©üËÉΩ„ÅÆJavaScript - Production Version
const projectId = {{ project.id|stringformat:'d' }};

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´„Ç≥„É°„É≥„Éà„ÇíÂèñÂæó
document.addEventListener('DOMContentLoaded', function() {
    loadComments();
});

// „Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„Åø
function loadComments() {
    console.log('[loadComments] Starting to load comments for project:', projectId);
    fetch(`/orders/api/projects/${projectId}/comments/`)
        .then(response => {
            console.log('[loadComments] Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('JSON„É¨„Çπ„Éù„É≥„Çπ„ÅåÊúüÂæÖ„Åï„Çå„Åæ„Åó„Åü„Åå„ÄÅÂà•„ÅÆÂΩ¢Âºè„ÅåËøî„Åï„Çå„Åæ„Åó„Åü');
            }
            return response.json();
        })
        .then(data => {
            console.log('[loadComments] Data received:', data);
            // data.comments„Ååundefined„ÇÑnull„ÅÆÂ†¥Âêà„Å´Á©∫ÈÖçÂàó„Çí„Éá„Éï„Ç©„É´„ÉàÂÄ§„Å®„Åó„Å¶‰ΩøÁî®
            const comments = data.comments || [];
            console.log('[loadComments] Comments loaded:', comments.length);
            displayComments(comments);
        })
        .catch(error => {
            console.error('[loadComments] Error:', error);
            document.getElementById('comments-container').innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p class="small">„Ç≥„É°„É≥„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü</p>
                    <p class="small text-danger">${error.message}</p>
                </div>
            `;
        });
}

// „Ç≥„É°„É≥„Éà„ÇíË°®Á§∫Ôºà„Çπ„É¨„ÉÉ„ÉâÂØæÂøúÔºâ
function displayComments(comments) {
    const container = document.getElementById('comments-container');

    if (!container) {
        console.error('[displayComments] Container not found!');
        return;
    }

    console.log('[displayComments] Displaying comments:', comments ? comments.length : 0);

    if (!comments || !Array.isArray(comments) || comments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-comment-slash fa-3x mb-3"></i>
                <p>„Åæ„Å†„Ç≥„É°„É≥„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>
                <p class="small">ÊúÄÂàù„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø„Åó„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ</p>
            </div>
        `;
        return;
    }

    let html = '';
    comments.forEach((comment) => {
        html += renderComment(comment, false);
    });

    container.innerHTML = html;
}

// 1„Å§„ÅÆ„Ç≥„É°„É≥„Éà„ÇíHTML„Å´Â§âÊèõÔºà„Çπ„É¨„ÉÉ„ÉâÂØæÂøúÔºâ
function renderComment(comment, isReply) {
    // „Ç≥„É°„É≥„ÉàID„ÇíÊï∞ÂÄ§„Å®„Åó„Å¶ÂèñÂæóÔºà„Ç´„É≥„ÉûÂå∫Âàá„ÇäÈò≤Ê≠¢Ôºâ
    const commentId = Number(comment.id);

    const importantClass = comment.is_important ? 'important' : '';
    const importantBadge = comment.is_important ?
        '<span class="comment-important-badge"><i class="fas fa-exclamation-triangle"></i> ÈáçË¶Å</span>' : '';

    // „Ç¢„Éê„Çø„Éº„ÅÆHTMLÁîüÊàê
    let avatarHtml = '';
    if (comment.avatar) {
        if (comment.avatar.type === 'image') {
            avatarHtml = `<div class="user-avatar"><img src="${comment.avatar.url}" alt="${escapeHtml(comment.author)}"></div>`;
        } else {
            avatarHtml = `<div class="user-avatar initials" style="background-color: ${comment.avatar.background_color}">${comment.avatar.initials}</div>`;
        }
    } else {
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: „Ç¢„Éê„Çø„Éº„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà
        const initials = comment.author.substring(0, 2).toUpperCase();
        avatarHtml = `<div class="user-avatar initials" style="background-color: #007bff">${initials}</div>`;
    }

    // Ê∑ª‰ªò„Éï„Ç°„Ç§„É´„ÅÆHTMLÁîüÊàê
    let attachmentsHtml = '';
    if (comment.attachments && comment.attachments.length > 0) {
        attachmentsHtml = '<div class="comment-attachments mt-2">';
        comment.attachments.forEach(attachment => {
            const icon = getFileIcon(attachment);
            attachmentsHtml += `
                <div class="attachment-item">
                    <a href="${attachment.file_url}" target="_blank" class="attachment-link">
                        <i class="${icon}"></i>
                        <span class="attachment-name">${escapeHtml(attachment.file_name)}</span>
                        <span class="attachment-size">(${attachment.file_size})</span>
                    </a>
                    ${attachment.is_image ? `<div class="mt-2"><img src="${attachment.file_url}" class="attachment-preview" onclick="openImageModal('${attachment.file_url}', '${escapeHtml(attachment.file_name)}')"></div>` : ''}
                </div>
            `;
        });
        attachmentsHtml += '</div>';
    }

    // Ëøî‰ø°„ÅÆÊäò„Çä„Åü„Åü„Åø„Éú„Çø„É≥„Å®„Ç´„Ç¶„É≥„Éà
    let replyToggleHtml = '';
    let repliesHtml = '';
    if (comment.replies && comment.replies.length > 0) {
        const replyCount = Number(comment.reply_count);
        replyToggleHtml = `
            <button class="btn btn-link text-muted p-0 toggle-replies" data-comment-id="${commentId}" title="${replyCount}‰ª∂„ÅÆËøî‰ø°">
                <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                <span style="font-size: 0.65rem;">${replyCount}</span>
            </button>
        `;

        // Ëøî‰ø°„ÇíË°®Á§∫Ôºà„Éá„Éï„Ç©„É´„Éà„ÅßË°®Á§∫Ôºâ
        repliesHtml = `<div class="comment-replies" data-parent-id="${commentId}">`;
        comment.replies.forEach(reply => {
            repliesHtml += renderComment(reply, true);
        });
        repliesHtml += '</div>';
    }

    const replyClass = isReply ? 'comment-reply' : '';

    // Á∑®ÈõÜÊ∏à„ÅøË°®Á§∫
    const editedBadge = comment.is_edited ?
        `<div class="text-muted" style="font-size: 0.75rem; margin-top: 4px;">
            <i class="fas fa-edit"></i> Á∑®ÈõÜÊ∏à„Åø (${comment.updated_at})
        </div>` : '';

    return `
        <div class="comment-item ${importantClass} ${replyClass}" data-comment-id="${commentId}">
            <div class="comment-header">
                ${avatarHtml}
                <div style="flex: 1;">
                    <div>
                        <span class="comment-author">
                            ${escapeHtml(comment.author)}
                        </span>
                        <span class="comment-date">
                            <i class="far fa-clock"></i> ${comment.created_at}
                        </span>
                        ${importantBadge}
                    </div>
                    ${editedBadge}
                </div>
            </div>
            <div class="comment-content">
                ${formatCommentContent(comment.content)}
            </div>
            ${attachmentsHtml}
            <div class="comment-actions">
                ${replyToggleHtml}
                <button class="btn btn-link text-muted p-0 reply-button" data-comment-id="${commentId}" data-author="${escapeHtml(comment.author)}" title="Ëøî‰ø°">
                    <i class="fas fa-reply" style="font-size: 0.9rem;"></i>
                </button>
                ${comment.can_edit ? `
                    <button class="btn btn-link text-muted p-0 edit-comment-button" data-comment-id="${commentId}" title="Á∑®ÈõÜ">
                        <i class="fas fa-edit" style="font-size: 0.9rem;"></i>
                    </button>
                ` : ''}
                ${comment.can_delete ? `
                    <button class="btn btn-link text-muted p-0 delete-comment-button" data-comment-id="${commentId}" title="ÂâäÈô§">
                        <i class="fas fa-trash" style="font-size: 0.9rem;"></i>
                    </button>
                ` : ''}
            </div>
            <div class="edit-form-container" id="edit-form-${commentId}" style="display: none;"></div>
            ${repliesHtml}
            <div class="reply-form-container" id="reply-form-${commentId}" style="display: none;"></div>
        </div>
    `;
}

// „Ç≥„É°„É≥„ÉàÂÜÖÂÆπ„Çí„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºàÊîπË°å„Å®„É°„É≥„Ç∑„Éß„É≥„ÇíÂá¶ÁêÜÔºâ
function formatCommentContent(content) {
    const escaped = escapeHtml(content);
    // ÊîπË°å„Çí<br>„Å´Â§âÊèõ
    const withBreaks = escaped.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
    // @„É°„É≥„Ç∑„Éß„É≥„Çí„Éè„Ç§„É©„Ç§„Éà
    return withBreaks.replace(/@(\w+)/g, '<strong class="text-primary">@$1</strong>');
}

// HTML„Ç®„Çπ„Ç±„Éº„Éó
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// „Ç≥„É°„É≥„Éà„ÇíÊäïÁ®ø
function postComment() {
    const content = document.getElementById('comment-content').value.trim();
    const isImportant = document.getElementById('comment-important').checked;
    const filesInput = document.getElementById('comment-files');
    const files = filesInput ? filesInput.files : [];

    if (!content) {
        return;
    }

    // „Éï„Ç°„Ç§„É´„Çµ„Ç§„Ç∫„ÉÅ„Çß„ÉÉ„ÇØÔºà10MBÂà∂ÈôêÔºâ
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) {
            return;
        }
    }

    // CSRF„Éà„Éº„ÇØ„É≥„ÇíÂèñÂæó
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // FormData„Çí‰Ωø„Å£„Å¶„Éï„Ç°„Ç§„É´„Å®„ÉÜ„Ç≠„Çπ„Éà„ÇíÈÄÅ‰ø°
    const formData = new FormData();
    formData.append('content', content);
    formData.append('is_important', isImportant);

    // „Éï„Ç°„Ç§„É´„ÇíËøΩÂä†
    for (let file of files) {
        formData.append('files', file);
    }

    fetch(`/orders/api/projects/${projectId}/comments/post/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('[postComment] Error response:', text);
                throw new Error(`HTTP„Ç®„É©„Éº: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
            document.getElementById('comment-content').value = '';
            document.getElementById('comment-important').checked = false;
            if (filesInput) {
                filesInput.value = '';
            }
            const filePreview = document.getElementById('file-preview');
            if (filePreview) {
                filePreview.innerHTML = '';
            }

            // „Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
            loadComments();
        } else {
            console.error('[postComment] Server returned failure:', data.error);
        }
    })
    .catch(error => {
        console.error('[postComment] Catch error:', error);
    });
}

// „Éà„Éº„Çπ„ÉàÈÄöÁü•„ÇíË°®Á§∫
function showToast(message, type = 'info') {
    // Á∞°ÊòìÁöÑ„Å™„Éà„Éº„Çπ„ÉàË°®Á§∫
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// „Éï„Ç°„Ç§„É´„Ç¢„Ç§„Ç≥„É≥„ÇíÂèñÂæó
function getFileIcon(attachment) {
    if (attachment.is_image) {
        return 'fas fa-file-image text-info';
    } else if (attachment.is_pdf) {
        return 'fas fa-file-pdf text-danger';
    } else if (attachment.file_type.includes('word') || attachment.file_type.includes('document')) {
        return 'fas fa-file-word text-primary';
    } else if (attachment.file_type.includes('excel') || attachment.file_type.includes('spreadsheet')) {
        return 'fas fa-file-excel text-success';
    } else {
        return 'fas fa-file text-secondary';
    }
}

// ÁîªÂÉè„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
function openImageModal(imageUrl, imageName) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `
        <div class="image-modal-content">
            <span class="image-modal-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <img src="${imageUrl}" alt="${imageName}">
            <p class="text-center mt-2">${imageName}</p>
        </div>
    `;
    document.body.appendChild(modal);

    // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// „Éï„Ç°„Ç§„É´ÈÅ∏ÊäûÊôÇ„ÅÆ„Éó„É¨„Éì„É•„ÉºË°®Á§∫
document.getElementById('comment-files').addEventListener('change', function(e) {
    const files = e.target.files;
    const preview = document.getElementById('file-preview');
    preview.innerHTML = '';

    if (files.length === 0) return;

    preview.innerHTML = '<div class="selected-files"><strong>ÈÅ∏Êäû„Åó„Åü„Éï„Ç°„Ç§„É´:</strong></div>';
    for (let file of files) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        const sizeKB = (file.size / 1024).toFixed(1);
        fileItem.innerHTML = `
            <i class="fas fa-file me-2"></i>
            <span>${file.name}</span>
            <span class="text-muted ms-2">(${sizeKB} KB)</span>
        `;
        preview.appendChild(fileItem);
    }
});

// Ëøî‰ø°„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÔºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
$(document).on('click', '.reply-button', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    const authorName = $(this).data('author');
    showReplyForm(commentId, authorName);
});

// Êäò„Çä„Åü„Åü„Åø„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„ÉºÔºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
$(document).on('click', '.toggle-replies', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    toggleReplies(commentId, this);
});

// Ëøî‰ø°„Éï„Ç©„Éº„É†„ÇíË°®Á§∫
function showReplyForm(commentId, authorName) {
    // ‰ªñ„ÅÆËøî‰ø°„Éï„Ç©„Éº„É†„ÇíÈñâ„Åò„Çã
    document.querySelectorAll('.reply-form-container').forEach(container => {
        container.style.display = 'none';
        container.innerHTML = '';
    });

    // Ëøî‰ø°„Éï„Ç©„Éº„É†„ÅÆHTML
    const replyFormHtml = `
        <div class="reply-form p-3 bg-light rounded">
            <div class="mb-2 text-muted small">
                <i class="fas fa-reply"></i> @${authorName} „Å∏„ÅÆËøî‰ø°
            </div>
            <textarea
                class="form-control mb-2"
                id="reply-content-${commentId}"
                rows="2"
                placeholder="Ëøî‰ø°„ÇíÂÖ•Âäõ..."></textarea>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-secondary cancel-reply" data-comment-id="${commentId}">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button class="btn btn-sm btn-primary post-reply" data-comment-id="${commentId}">
                    Ëøî‰ø°„ÇíÊäïÁ®ø
                </button>
            </div>
        </div>
    `;

    const container = document.getElementById(`reply-form-${commentId}`);
    container.innerHTML = replyFormHtml;
    container.style.display = 'block';

    // „Éï„Ç©„Éº„Ç´„Çπ
    document.getElementById(`reply-content-${commentId}`).focus();
}

// Ëøî‰ø°„Éï„Ç©„Éº„É†„Çí„Ç≠„É£„É≥„Çª„É´Ôºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
$(document).on('click', '.cancel-reply', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    const container = $(`#reply-form-${commentId}`);
    container.hide().html('');
});

// Ëøî‰ø°„ÇíÊäïÁ®øÔºà„Ç§„Éô„É≥„ÉàÂßîË≠≤Ôºâ
$(document).on('click', '.post-reply', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    const content = $(`#reply-content-${commentId}`).val().trim();

    if (!content) return;

    postCommentReply(commentId, content);
});

// Ëøî‰ø°„ÇíÊäïÁ®ø„Åô„ÇãÈñ¢Êï∞
function postCommentReply(parentCommentId, content) {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const formData = new FormData();
    formData.append('content', content);
    formData.append('is_important', false);
    formData.append('parent_comment_id', parentCommentId);

    fetch(`/orders/api/projects/${projectId}/comments/post/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('[postCommentReply] Error response:', text);
                throw new Error(`HTTP„Ç®„É©„Éº: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // Ëøî‰ø°„Éï„Ç©„Éº„É†„ÇíÈñâ„Åò„Çã
            const container = document.getElementById(`reply-form-${parentCommentId}`);
            container.style.display = 'none';
            container.innerHTML = '';

            // „Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
            loadComments();
        } else {
            console.error('[postCommentReply] Server returned failure:', data.error);
        }
    })
    .catch(error => {
        console.error('[postCommentReply] Catch error:', error);
    });
}

// Ëøî‰ø°„ÅÆÊäò„Çä„Åü„Åü„Åø„Éà„Ç∞„É´
function toggleReplies(commentId, button) {
    const repliesContainer = document.querySelector(`.comment-replies[data-parent-id="${commentId}"]`);

    if (repliesContainer.style.display === 'none') {
        repliesContainer.style.display = 'block';
        button.querySelector('i').className = 'fas fa-chevron-down';
    } else {
        repliesContainer.style.display = 'none';
        button.querySelector('i').className = 'fas fa-chevron-right';
    }
}

// „Ç≥„É°„É≥„Éà„ÇíÁ∑®ÈõÜ
$(document).on('click', '.edit-comment-button', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    showEditForm(commentId);
});

function showEditForm(commentId) {
    const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
    const contentElement = commentItem.querySelector('.comment-content');
    const currentContent = contentElement.textContent.trim();

    // ‰ªñ„ÅÆÁ∑®ÈõÜ„Éï„Ç©„Éº„É†„ÇíÈñâ„Åò„Çã
    document.querySelectorAll('.edit-form-container').forEach(container => {
        container.style.display = 'none';
        container.innerHTML = '';
    });

    // Á∑®ÈõÜ„Éï„Ç©„Éº„É†„ÅÆHTML
    const editFormHtml = `
        <div class="edit-form mt-2 p-3 bg-light rounded">
            <textarea
                class="form-control mb-2"
                id="edit-content-${commentId}"
                rows="3">${currentContent}</textarea>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-secondary cancel-edit" data-comment-id="${commentId}">
                    „Ç≠„É£„É≥„Çª„É´
                </button>
                <button class="btn btn-sm btn-primary save-edit" data-comment-id="${commentId}">
                    ‰øùÂ≠ò
                </button>
            </div>
        </div>
    `;

    const container = document.getElementById(`edit-form-${commentId}`);
    container.innerHTML = editFormHtml;
    container.style.display = 'block';

    // ÂÖÉ„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíÈùûË°®Á§∫
    contentElement.style.display = 'none';

    // „Éï„Ç©„Éº„Ç´„Çπ
    document.getElementById(`edit-content-${commentId}`).focus();
}

// Á∑®ÈõÜ„Çí„Ç≠„É£„É≥„Çª„É´
document.addEventListener('click', function(e) {
    if (e.target.closest('.cancel-edit')) {
        const button = e.target.closest('.cancel-edit');
        const commentId = button.dataset.commentId;
        const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
        const contentElement = commentItem.querySelector('.comment-content');
        const container = document.getElementById(`edit-form-${commentId}`);

        container.style.display = 'none';
        container.innerHTML = '';
        contentElement.style.display = 'block';
    }
});

// Á∑®ÈõÜ„Çí‰øùÂ≠ò
document.addEventListener('click', function(e) {
    if (e.target.closest('.save-edit')) {
        const button = e.target.closest('.save-edit');
        const commentId = button.dataset.commentId;
        const content = document.getElementById(`edit-content-${commentId}`).value.trim();

        if (!content) return;

        saveEditComment(commentId, content);
    }
});

function saveEditComment(commentId, content) {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    fetch(`/orders/api/comments/${commentId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // „Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
            loadComments();
        } else {
            console.error('[saveEditComment] Error:', data.error);
            alert('Á∑®ÈõÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
        }
    })
    .catch(error => {
        console.error('[saveEditComment] Catch error:', error);
        alert('Á∑®ÈõÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    });
}

// „Ç≥„É°„É≥„Éà„ÇíÂâäÈô§
$(document).on('click', '.delete-comment-button', function(e) {
    e.preventDefault();
    e.stopPropagation();
    const commentId = $(this).data('comment-id');

    showConfirmModal(
        '„Åì„ÅÆ„Ç≥„É°„É≥„Éà„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ',
        function() {
            deleteComment(commentId);
        },
        '„Ç≥„É°„É≥„Éà„ÅÆÂâäÈô§'
    );
});

function deleteComment(commentId) {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    fetch(`/orders/api/comments/${commentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // „Ç≥„É°„É≥„Éà‰∏ÄË¶ß„ÇíÂÜçË™≠„ÅøËæº„Åø
            loadComments();
        } else {
            console.error('[deleteComment] Error:', data.error);
            alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (data.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
        }
    })
    .catch(error => {
        console.error('[deleteComment] Catch error:', error);
        alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    });
}

// Enter„Ç≠„Éº„Åß„ÅÆËá™ÂãïÊäïÁ®ø„ÇíÁÑ°ÂäπÂåñÔºàÊîπË°å„ÇíË®±ÂèØÔºâ
// „Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ„Åß„ÅÆ„ÅøÊäïÁ®ø„Åô„Çã

// „Éï„Ç°„Ç§„É´ÂâäÈô§Á¢∫Ë™ç - Phase 5
function confirmFileDelete(fileId, fileName) {
    showConfirmModal(`„Éï„Ç°„Ç§„É´„Äå${fileName}„Äç„ÇíÂâäÈô§„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü\n\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ`, function() {
        const form = document.getElementById('fileDeleteForm');
        form.action = `/orders/projects/${projectId}/files/${fileId}/delete/`;
        form.submit();
    });
}

// ÂèóÊ≥®„É®„Éü„ÅÆÂ§âÊõ¥„ÇíËá™Âãï‰øùÂ≠òÔºàÊ°à‰ª∂Ë©≥Á¥∞ÁîªÈù¢Ôºâ
$(document).on('change', '.order-forecast-select-detail', function(e) {
    var select = $(this);
    var projectId = select.data('project-id');
    var newValue = select.val();
    var csrfToken = $('[name=csrfmiddlewaretoken]').val() || '{{ csrf_token }}';

    // ‰øùÂ≠ò‰∏≠„ÅÆË°®Á§∫
    select.prop('disabled', true).css('opacity', '0.5');

    $.ajax({
        url: '/orders/' + projectId + '/update-forecast/',
        method: 'POST',
        dataType: 'json',  // JSON„É¨„Çπ„Éù„É≥„Çπ„ÇíÊúüÂæÖ
        data: {
            project_status: newValue,
            csrfmiddlewaretoken: csrfToken
        },
        success: function(response) {
            console.log('‰øùÂ≠òÊàêÂäü:', response);

            // „É¨„Çπ„Éù„É≥„Çπ„ÅÆÊ§úË®º
            if (response && response.success) {
                // ‰øùÂ≠òÊàêÂäüÊôÇ„ÅÆË¶ñË¶ö„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
                select.css('border-color', '#28a745');

                // „Éò„ÉÉ„ÉÄ„Éº„Éê„ÉÉ„Ç∏„ÇÇÊõ¥Êñ∞
                var badge = $('.project-status-badge');
                if (badge.length) {
                    // „Éê„ÉÉ„Ç∏„ÅÆËâ≤„Å®„Çπ„Çø„Ç§„É´„ÇíÂ§âÊõ¥
                    badge.removeClass('bg-primary bg-success bg-danger bg-info bg-warning bg-secondary text-dark');
                    badge.css('background-color', ''); // „Ç´„Çπ„Çø„É†ËÉåÊôØËâ≤„Çí„ÇØ„É™„Ç¢

                    if (newValue === 'ÂèóÊ≥®Á¢∫ÂÆö') {
                        badge.addClass('bg-success');
                    } else if (newValue === 'A') {
                        badge.addClass('bg-danger');
                    } else if (newValue === 'B') {
                        badge.addClass('bg-warning text-dark');
                    } else if (newValue === 'NG') {
                        badge.addClass('bg-secondary');
                    } else if (newValue === '„Éç„Çø') {
                        badge.addClass('text-dark');
                        badge.css('background-color', '#e9d5ff');
                    } else {
                        badge.addClass('bg-info');
                    }

                    // „Éê„ÉÉ„Ç∏„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÊõ¥Êñ∞Ôºàget_project_status_displayÁõ∏ÂΩìÔºâ
                    var displayText = newValue;
                    if (newValue === 'ÂèóÊ≥®Á¢∫ÂÆö') {
                        displayText = 'ÂèóÊ≥®Á¢∫ÂÆö';
                    } else if (newValue === 'A') {
                        displayText = 'A';
                    } else if (newValue === 'B') {
                        displayText = 'B';
                    } else if (newValue === 'NG') {
                        displayText = 'NG';
                    } else if (newValue === '„Éç„Çø') {
                        displayText = '„Éç„Çø';
                    }
                    badge.text(displayText);
                }

                // 1ÁßíÂæå„Å´Á∑ë„ÅÆÊû†Á∑ö„ÇíÊ∂à„Åô
                setTimeout(function() {
                    select.css('border-color', '');
                }, 1000);
            } else {
                console.error('‰øùÂ≠òÂ§±Êïó:', response);
                if (typeof toastr !== 'undefined') {
                    toastr.error(response.error || '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                } else {
                    showErrorModal('‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + (response.error || '‰∏çÊòé„Å™„Ç®„É©„Éº'));
                }
                location.reload();
            }
        },
        error: function(xhr, status, error) {
            console.error('‰øùÂ≠ò„Ç®„É©„ÉºË©≥Á¥∞:', {
                status: status,
                error: error,
                responseText: xhr.responseText,
                statusCode: xhr.status
            });

            let errorMessage = 'ÂèóÊ≥®„É®„Éü„ÅÆ‰øùÂ≠ò‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (xhr.status === 0) {
                errorMessage = '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº: „Çµ„Éº„Éê„Éº„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì';
            } else if (xhr.status === 403) {
                errorMessage = 'Ê®©Èôê„Ç®„É©„Éº: „Åì„ÅÆÊìç‰Ωú„ÇíÂÆüË°å„Åô„ÇãÊ®©Èôê„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
            } else if (xhr.status === 404) {
                errorMessage = '„Ç®„É©„Éº: Ê°à‰ª∂„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì';
            } else if (xhr.status >= 500) {
                errorMessage = '„Çµ„Éº„Éê„Éº„Ç®„É©„Éº: „Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„ÇâÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ';
            }

            if (typeof toastr !== 'undefined') {
                toastr.error(errorMessage);
            } else {
                showErrorModal(errorMessage);
            }
            location.reload();
        },
        complete: function() {
            select.prop('disabled', false).css('opacity', '1');
        }
    });
});

// Ê°à‰ª∂Ë©≥Á¥∞ÊÉÖÂ†±„ÅÆ„Éà„Ç∞„É´Ê©üËÉΩ
function toggleDetailInfo() {
    const body = $('#detailInfoBody');
    const icon = $('#detailInfoToggleIcon');

    body.slideToggle(300, function() {
        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÆå‰∫ÜÂæå„Å´„Ç¢„Ç§„Ç≥„É≥„ÇíÂõûËª¢
        if (body.is(':visible')) {
            icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        } else {
            icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        }
    });
}

// „Ç§„É≥„É©„Ç§„É≥Á∑®ÈõÜÊ©üËÉΩ
function enableEdit(icon) {
    const dd = $(icon).closest('.editable-field');
    const fieldValue = dd.find('.field-value');
    const field = dd.data('field');
    const type = dd.data('type');

    // „Åô„Åß„Å´Á∑®ÈõÜ„É¢„Éº„Éâ„ÅÆÂ†¥Âêà„ÅØ‰Ωï„ÇÇ„Åó„Å™„ÅÑ
    if (dd.find('.edit-controls').length > 0) {
        return;
    }

    // Á∑®ÈõÜ„Ç¢„Ç§„Ç≥„É≥„ÇíÈùûË°®Á§∫
    dd.find('.edit-icon').hide();

    let currentValue;
    let inputHtml = '';

    if (type === 'textarea') {
        // textarea„ÅÆÂ†¥Âêà„ÅØ„ÄÅHTML„Çø„Ç∞„ÇíÈô§Âéª„Åó„Å¶„ÉÜ„Ç≠„Çπ„Éà„Å†„Åë„ÇíÂèñÂæó
        currentValue = fieldValue.text().trim();
        if (currentValue === 'ÂÇôËÄÉ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì') {
            currentValue = '';
        }
        inputHtml = `<textarea class="form-control form-control-sm edit-input" rows="5" style="font-size: 0.7rem; padding: 0.4rem; width: 100%;">${currentValue}</textarea>`;
    } else if (type === 'select') {
        // select„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Çí‰ΩúÊàê
        const currentCompanyId = dd.data('client-company-id') || '';

        // ÂÖÉË´ã‰ºöÁ§æ„É™„Çπ„Éà„Åã„Çâ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÁîüÊàê
        let options = '<option value="">-- ÂÖÉË´ã‰ºöÁ§æ„ÇíÈÅ∏Êäû --</option>';
        clientCompaniesData.forEach(function(company) {
            const selected = company.id == currentCompanyId ? 'selected' : '';
            options += `<option value="${company.id}" ${selected} data-address="${company.address || ''}">${company.company_name}</option>`;
        });

        inputHtml = `<select class="form-select form-select-sm edit-input" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">${options}</select>`;
    } else if (type === 'work_type') {
        // Â∑•‰∫ãÁ®ÆÂà•„ÅÆÂ†¥Âêà„ÅØ„ÄÅWorkType„Éû„Çπ„Çø„Éº„Åã„Çâ„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Çí‰ΩúÊàê
        currentValue = fieldValue.text().trim();

        // Â∑•‰∫ãÁ®ÆÂà•„É™„Çπ„Éà„Åã„Çâ„Ç™„Éó„Ç∑„Éß„É≥„ÇíÁîüÊàê
        let options = '<option value="">-- Â∑•‰∫ãÁ®ÆÂà•„ÇíÈÅ∏Êäû --</option>';
        workTypesData.forEach(function(workType) {
            const selected = workType.name === currentValue ? 'selected' : '';
            options += `<option value="${workType.name}" ${selected}>${workType.name}</option>`;
        });

        inputHtml = `<select class="form-select form-select-sm edit-input" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">${options}</select>`;
    } else {
        currentValue = fieldValue.text().replace('¬•', '').replace(/,/g, '').trim();

        // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Çí‰ΩúÊàê
        if (type === 'date') {
            // Êó•‰ªòÂΩ¢Âºè„ÇíYYYY-MM-DD„Å´Â§âÊèõÔºàY/m/dÂΩ¢Âºè„Åã„ÇâÔºâ
            const dateParts = currentValue.split('/');
            const dateValue = dateParts.length === 3 && currentValue !== '-' ?
                `${dateParts[0]}-${dateParts[1].padStart(2, '0')}-${dateParts[2].padStart(2, '0')}` : '';
            inputHtml = `<input type="date" class="form-control form-control-sm edit-input" value="${dateValue}" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">`;
        } else if (type === 'number') {
            // Êï∞ÂÄ§„Åã„ÇâË®òÂè∑„ÇíÈô§Âéª
            const numValue = currentValue === '-' ? '0' : currentValue;
            inputHtml = `<input type="number" class="form-control form-control-sm edit-input" value="${numValue}" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">`;
        } else {
            inputHtml = `<input type="text" class="form-control form-control-sm edit-input" value="${currentValue}" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">`;
        }
    }

    // ÂÄ§„ÇíÈùûË°®Á§∫„Å´„Åó„Å¶ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å®‰øùÂ≠ò/„Ç≠„É£„É≥„Çª„É´„Éú„Çø„É≥„ÇíË°®Á§∫
    fieldValue.hide();
    const buttonDisplay = type === 'textarea' ? 'd-block mt-2' : 'd-inline-block';
    fieldValue.after(`
        <div class="edit-controls ${type === 'textarea' ? 'd-block' : 'd-inline-block'}">
            ${inputHtml}
            <div class="${buttonDisplay}">
                <button class="btn btn-sm btn-success ms-1" onclick="saveField(this)" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                    <i class="fas fa-check"></i> ‰øùÂ≠ò
                </button>
                <button class="btn btn-sm btn-secondary ms-1" onclick="cancelEdit(this)" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                    <i class="fas fa-times"></i> „Ç≠„É£„É≥„Çª„É´
                </button>
            </div>
        </div>
    `);

    // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´„Éï„Ç©„Éº„Ç´„Çπ
    dd.find('.edit-input').focus();
}

function saveField(button) {
    const dd = $(button).closest('.editable-field');
    const fieldValue = dd.find('.field-value');
    const field = dd.data('field');
    const type = dd.data('type');
    const input = dd.find('.edit-input');
    const newValue = input.val();

    // ‰øùÂ≠òÂá¶ÁêÜ
    $.ajax({
        url: '{% url "order_management:update_project_field" project.pk %}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            field: field,
            value: newValue
        }),
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                // Ë°®Á§∫„ÇíÊõ¥Êñ∞
                let displayValue = newValue;
                if (type === 'select') {
                    // select„ÅÆÂ†¥Âêà„ÅØ„ÄÅÈÅ∏Êäû„Åï„Çå„Åü‰ºöÁ§æÂêç„Å®‰ΩèÊâÄ„ÇíÂèñÂæó
                    const selectedOption = input.find('option:selected');
                    const companyName = selectedOption.text();
                    const companyAddress = selectedOption.data('address') || '-';

                    // ÂÖÉË´ãÂêç„ÇíÊõ¥Êñ∞
                    fieldValue.text(companyName);
                    dd.data('client-company-id', newValue);

                    // ÂÖÉË´ã‰ΩèÊâÄ„ÇÇÊõ¥Êñ∞
                    $('#client-address-display .field-value').text(companyAddress);
                } else if (type === 'work_type') {
                    // Â∑•‰∫ãÁ®ÆÂà•„ÅÆÂ†¥Âêà„ÅØ„ÄÅ„Éê„ÉÉ„Ç∏„ÇíÊõ¥Êñ∞
                    fieldValue.find('.badge').text(newValue);
                } else if (type === 'number') {
                    // Êï∞ÂÄ§„Çí„Éï„Ç©„Éº„Éû„ÉÉ„Éà
                    const num = parseFloat(newValue);
                    displayValue = '¬•' + num.toLocaleString('ja-JP', {maximumFractionDigits: 0});
                } else if (type === 'date') {
                    // Êó•‰ªò„ÇíY/m/dÂΩ¢Âºè„Å´Â§âÊèõ
                    if (newValue) {
                        const dateParts = newValue.split('-');
                        displayValue = `${dateParts[0]}/${parseInt(dateParts[1])}/${parseInt(dateParts[2])}`;
                    } else {
                        displayValue = '-';
                    }
                }

                // „Éê„ÉÉ„Ç∏„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆÂá¶ÁêÜÔºàselect„ÄÅwork_type‰ª•Â§ñÔºâ
                if (type !== 'select' && type !== 'work_type') {
                    if (fieldValue.find('.badge').length > 0) {
                        fieldValue.find('.badge').text(displayValue.replace('¬•', '').replace(/,/g, ''));
                    } else {
                        fieldValue.text(displayValue);
                    }
                }

                // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
                dd.find('.edit-controls').remove();
                fieldValue.show();
                dd.find('.edit-icon').show();

                // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
                if (typeof toastr !== 'undefined') {
                    toastr.success('‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                }
            } else {
                if (typeof toastr !== 'undefined') {
                    toastr.error(response.error || '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                } else {
                    showErrorModal(response.error || '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
                }
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || '‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
            if (typeof toastr !== 'undefined') {
                toastr.error(errorMsg);
            } else {
                showErrorModal(errorMsg);
            }
            console.error('Save error:', xhr);
        }
    });
}

function cancelEdit(button) {
    const dd = $(button).closest('.editable-field');
    const fieldValue = dd.find('.field-value');

    // Á∑®ÈõÜ„É¢„Éº„Éâ„ÇíÁµÇ‰∫Ü
    dd.find('.edit-controls').remove();
    fieldValue.show();
    dd.find('.edit-icon').show();
}

// Ë°®Á§∫„É¢„Éº„ÉâÂàá„ÇäÊõø„ÅàÊ©üËÉΩ
function switchViewMode(mode) {
    const tabViewBtn = document.getElementById('tabViewBtn');
    const fullViewBtn = document.getElementById('fullViewBtn');
    const tabNav = document.getElementById('projectDetailTabs');
    const tabContent = document.getElementById('projectDetailTabsContent');
    const tabPanes = document.querySelectorAll('#projectDetailTabsContent .tab-pane');

    if (mode === 'tab') {
        // „Çø„ÉñË°®Á§∫„É¢„Éº„Éâ
        tabViewBtn.classList.add('active');
        fullViewBtn.classList.remove('active');

        // „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇíË°®Á§∫
        tabNav.style.display = 'flex';

        // full-view-mode„ÇØ„É©„Çπ„ÇíÂâäÈô§
        tabContent.classList.remove('full-view-mode');

        // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éë„Éç„É´„ÇíÈùûË°®Á§∫„Å´„Åô„Çã
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // ÊúÄÂàù„ÅÆ„Çø„Éñ„ÇíË°®Á§∫
        const firstPane = document.getElementById('overview');
        if (firstPane) {
            firstPane.classList.add('show', 'active');
        }

        // ÊúÄÂàù„ÅÆ„Çø„Éñ„Éú„Çø„É≥„Çí„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å´„Åô„Çã
        const tabButtons = document.querySelectorAll('#projectDetailTabs .nav-link');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        const firstButton = document.getElementById('overview-tab');
        if (firstButton) {
            firstButton.classList.add('active');
        }

    } else if (mode === 'full') {
        // ÂÖ®‰ΩìË°®Á§∫„É¢„Éº„Éâ
        fullViewBtn.classList.add('active');
        tabViewBtn.classList.remove('active');

        // „Çø„Éñ„Éä„Éì„Ç≤„Éº„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫
        tabNav.style.display = 'none';

        // full-view-mode„ÇØ„É©„Çπ„ÇíËøΩÂä†
        tabContent.classList.add('full-view-mode');

        // „Åô„Åπ„Å¶„ÅÆ„Çø„Éñ„Éë„Éç„É´„ÇíË°®Á§∫
        tabPanes.forEach(pane => {
            pane.classList.add('show', 'active');
        });
    }

    // ÈÅ∏ÊäûÁä∂ÊÖã„Çí„É≠„Éº„Ç´„É´„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠ò
    localStorage.setItem('projectDetailViewMode', mode);
}

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„Å´ÂâçÂõû„ÅÆË°®Á§∫„É¢„Éº„Éâ„ÇíÂæ©ÂÖÉ
document.addEventListener('DOMContentLoaded', function() {
    const savedMode = localStorage.getItem('projectDetailViewMode');
    if (savedMode === 'full') {
        switchViewMode('full');
    }
});

// ËøΩÂä†Â∑•Á®ã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„ÇπÂ§âÊõ¥„Éè„É≥„Éâ„É©
function handleAdditionalStepsChange() {
    const checkedBoxes = $('.additional-step-checkbox:checked');

    if (checkedBoxes.length > 0) {
        // ÁèæË™øÔºàstep_surveyÔºâ„Åå„ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„ÅüÂ†¥Âêà„ÄÅÂãïÁöÑ„Çπ„ÉÜ„ÉÉ„Éó„Å´ËøΩÂä†
        const surveyCheckbox = $('#addStep_step_survey');
        if (surveyCheckbox.is(':checked')) {
            // ÁèæË™ø„Çπ„ÉÜ„ÉÉ„Éó„ÅåÊó¢„Å´„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´Â≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
            // „Éö„Éº„Ç∏ÂÜÖ„Å´ÁèæË™ø„Ç´„Éº„Éâ„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØËøΩÂä†„ÅåÂøÖË¶Å
            const surveyStepExists = $('[data-step-key="step_survey"]').length > 0 ||
                                     $('.step-card:contains("ÁèæË™ø")').length > 0;

            if (!surveyStepExists) {
                // ÁèæË™ø„Çπ„ÉÜ„ÉÉ„Éó„ÇíÂãïÁöÑ„Å´ËøΩÂä†
                if (typeof toastr !== 'undefined') {
                    toastr.info('ÁèæË™ø„Çπ„ÉÜ„ÉÉ„Éó„Çí„Éó„É≠„Ç∏„Çß„ÇØ„Éà„Å´ËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô...', '', {timeOut: 2000});
                }

                // „Åì„Åì„ÅßÂÆüÈöõ„Å´„Çπ„ÉÜ„ÉÉ„Éó„ÇíËøΩÂä†„Åô„ÇãÂá¶ÁêÜ
                // Á∞°ÊòìÁöÑ„Å™ÂÆüË£ÖÔºö„Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶Êõ¥Êñ∞„ÇíÂèçÊò†
                // „Çà„ÇäÊ¥óÁ∑¥„Åï„Çå„ÅüÂÆüË£Ö„Åß„ÅØ„ÄÅAJAXÁµåÁî±„Åß„Çπ„ÉÜ„ÉÉ„Éó„ÇíËøΩÂä†„Åó„Å¶DOM„ÇíÊõ¥Êñ∞
                console.log('Survey step will be added when saving the subcontract');
            }
        }

        // 1„Å§‰ª•‰∏ä„ÅÆÂ∑•Á®ã„Åå„ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÈáëÈ°çË®≠ÂÆöÊñπÊ≥ï„Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
        $('#costAllocationSection').show();

        // ÁèæÂú®ÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÊñπÊ≥ï„Å´Âøú„Åò„Å¶ÂÖ•ÂäõÊ¨Ñ„ÇíÊõ¥Êñ∞
        updatePerStepAmountsInputs();
    } else {
        // „ÉÅ„Çß„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÈùûË°®Á§∫
        $('#costAllocationSection').hide();
        $('#perStepAmountsSection').hide();
    }
}

// Â∑•Á®ã„Åî„Å®„ÅÆÈáëÈ°çÂÖ•ÂäõÊ¨Ñ„ÇíÁîüÊàê
function updatePerStepAmountsInputs() {
    const checkedBoxes = $('.additional-step-checkbox:checked');
    const currentStepKey = $('#subcontractStep').val();

    // ÁèæÂú®„ÅÆÂ∑•Á®ãÂêç„ÇíÂèñÂæó
    const stepNames = {
        'attendance': 'Á´ã„Å°‰ºö„ÅÑ',
        'survey': 'ÁèæË™ø',
        'construction_start': 'ÁùÄÂ∑•'
    };
    const currentStepName = stepNames[currentStepKey] || '';

    let inputsHtml = '';

    // ÁèæÂú®„ÅÆÂ∑•Á®ã„ÅÆÂÖ•ÂäõÊ¨Ñ
    if (currentStepName) {
        inputsHtml += `
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-calendar-check me-1"></i>${currentStepName}Ôºà„É°„Ç§„É≥Â∑•Á®ãÔºâ
                </label>
                <input type="number" class="form-control step-amount-input-all" id="currentStepAmount"
                       placeholder="Â•ëÁ¥ÑÈáëÈ°ç„ÇíÂÖ•Âäõ" min="0" step="1000" required>
            </div>
        `;
    }

    // ËøΩÂä†Â∑•Á®ã„ÅÆÂÖ•ÂäõÊ¨Ñ
    checkedBoxes.each(function() {
        const stepKey = $(this).val();
        const stepLabel = $(this).data('label');

        inputsHtml += `
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-calendar-check me-1"></i>${stepLabel}
                </label>
                <input type="number" class="form-control step-amount-input step-amount-input-all"
                       name="step_amounts[${stepKey}]"
                       data-step="${stepKey}"
                       placeholder="Â•ëÁ¥ÑÈáëÈ°ç„ÇíÂÖ•Âäõ" min="0" step="1000" required>
            </div>
        `;
    });

    $('#perStepAmountsInputs').html(inputsHtml);

    // ÈáëÈ°çÂÖ•ÂäõÊ¨Ñ„Å´Â§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíËøΩÂä†ÔºàÂêàË®à„ÇíËá™ÂãïË®àÁÆóÔºâ
    $('.step-amount-input-all').on('input', calculateTotalStepAmount);
}

// ÂêÑÂ∑•Á®ã„ÅÆÈáëÈ°çÂêàË®à„ÇíË®àÁÆó„Åó„Å¶„É°„Ç§„É≥Â•ëÁ¥ÑÈáëÈ°ç„Å´ÂèçÊò†
function calculateTotalStepAmount() {
    let total = 0;

    // „Åô„Åπ„Å¶„ÅÆÂ∑•Á®ã„ÅÆÈáëÈ°ç„ÇíÂêàË®à
    $('.step-amount-input-all').each(function() {
        const value = parseInt($(this).val()) || 0;
        total += value;
    });

    // „É°„Ç§„É≥„ÅÆÂ•ëÁ¥ÑÈáëÈ°ç„Éï„Ç£„Éº„É´„Éâ„Å´Ë®≠ÂÆö
    $('#subcontractContractAmount').val(total);
}

// ÈáëÈ°çË®≠ÂÆöÊñπÊ≥ï„ÅÆÂ§âÊõ¥„Éè„É≥„Éâ„É©
$(document).on('change', 'input[name="cost_allocation_method"]', function() {
    const method = $(this).val();

    if (method === 'per_step') {
        // Â∑•Á®ã„Åî„Å®„Å´ÈáëÈ°ç„ÇíË®≠ÂÆö„Åô„ÇãÂ†¥Âêà
        updatePerStepAmountsInputs();
        $('#perStepAmountsSection').show();

        // „É°„Ç§„É≥„ÅÆÂ•ëÁ¥ÑÈáëÈ°ç„Éï„Ç£„Éº„É´„Éâ„ÇíË™≠„ÅøÂèñ„ÇäÂ∞ÇÁî®„Å´„Åô„Çã
        $('#subcontractContractAmount').prop('readonly', true);
        $('#subcontractContractAmount').addClass('bg-light');
        $('#subcontractContractAmount').attr('placeholder', 'ÂêÑÂ∑•Á®ã„ÅÆÂêàË®à„ÅåËá™ÂãïÂÖ•Âäõ„Åï„Çå„Åæ„Åô');

        // ÂêàË®à„ÇíË®àÁÆó
        calculateTotalStepAmount();
    } else {
        // ‰∏ÄÂºè„ÅÆÂ†¥Âêà„ÅØÈùûË°®Á§∫
        $('#perStepAmountsSection').hide();

        // „É°„Ç§„É≥„ÅÆÂ•ëÁ¥ÑÈáëÈ°ç„Éï„Ç£„Éº„É´„Éâ„ÇíÁ∑®ÈõÜÂèØËÉΩ„Å´Êàª„Åô
        $('#subcontractContractAmount').prop('readonly', false);
        $('#subcontractContractAmount').removeClass('bg-light');
        $('#subcontractContractAmount').attr('placeholder', '');
    }
});

// ‰∏ãË´ã„Åë‰ΩúÊàê„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
function openSubcontractModal(stepKey) {
    // step„Éë„É©„É°„Éº„Çø„ÇíË®≠ÂÆö
    if (stepKey) {
        $('#subcontractStep').val(stepKey);

        // „Çπ„ÉÜ„ÉÉ„ÉóÂêç„Çí„É¢„Éº„ÉÄ„É´„Çø„Ç§„Éà„É´„Å´ËøΩÂä†
        const stepNames = {
            'attendance': 'Á´ã„Å°‰ºö„ÅÑ',
            'survey': 'ÁèæË™ø',
            'construction_start': 'ÁùÄÂ∑•',
            'material_order': 'Ë≥áÊùêÁô∫Ê≥®'
        };
        const stepName = stepNames[stepKey] || '';
        $('#subcontractModalLabel').html(`<i class="fas fa-user-plus me-2"></i>‰ΩúÊ•≠ËÄÖ„ÇíËøΩÂä†${stepName ? ' (' + stepName + ')' : ''}`);

        // ‰ªñ„ÅÆÂ∑•Á®ã„ÅÆ„ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÇíÁîüÊàê
        const allSteps = [
            { key: 'attendance', label: 'Á´ã„Å°‰ºö„ÅÑ' },
            { key: 'survey', label: 'ÁèæË™ø' },
            { key: 'construction_start', label: 'ÁùÄÂ∑•' }
        ];

        const otherSteps = allSteps.filter(step => step.key !== stepKey);

        if (otherSteps.length > 0) {
            let checkboxesHtml = '<div class="row">';
            otherSteps.forEach(step => {
                checkboxesHtml += `
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input additional-step-checkbox" type="checkbox" name="additional_steps[]" value="${step.key}" id="addStep_${step.key}" data-label="${step.label}">
                            <label class="form-check-label" for="addStep_${step.key}">
                                <i class="fas fa-calendar-check me-1"></i>${step.label}
                            </label>
                        </div>
                    </div>
                `;
            });
            checkboxesHtml += '</div>';

            $('#additionalStepsCheckboxes').html(checkboxesHtml);
            $('#additionalStepsSection').show();

            // „ÉÅ„Çß„ÉÉ„ÇØ„Éú„ÉÉ„ÇØ„Çπ„ÅÆÂ§âÊõ¥„Ç§„Éô„É≥„Éà„ÇíÁõ£Ë¶ñ
            $('.additional-step-checkbox').on('change', function() {
                if (typeof handleAdditionalStepsChange === 'function') {
                    handleAdditionalStepsChange();
                }
            });
        } else {
            $('#additionalStepsSection').hide();
        }
    } else {
        $('#subcontractStep').val('');
        $('#subcontractModalLabel').html('<i class="fas fa-user-plus me-2"></i>‰ΩúÊ•≠ËÄÖ„ÇíËøΩÂä†');
        $('#additionalStepsSection').hide();
    }

    // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
    $('#subcontractForm')[0].reset();
    $('#subcontractStep').val(stepKey || '');  // hidden field„ÅØÁ∂≠ÊåÅ

    // Áô∫Ê≥®ÂÖàË°®Á§∫„Éï„Ç£„Éº„É´„Éâ„Çí„É™„Çª„ÉÉ„Éà
    $('#selectedContractorDisplay').val('');

    // Áô∫Ê≥®ÂÖàÊÉÖÂ†±„Çí„É™„Çª„ÉÉ„Éà
    document.getElementById('contractorPaymentInfo').style.display = 'none';

    // ÈáëÈ°çË®≠ÂÆöÊñπÊ≥ï„Çª„ÇØ„Ç∑„Éß„É≥„Çí„É™„Çª„ÉÉ„Éà
    $('#costAllocationSection').hide();
    $('#perStepAmountsSection').hide();
    $('#costMethodLumpSum').prop('checked', true);

    // Â•ëÁ¥ÑÈáëÈ°ç„Éï„Ç£„Éº„É´„Éâ„ÅÆÁä∂ÊÖã„Çí„É™„Çª„ÉÉ„ÉàÔºàÁ∑®ÈõÜÂèØËÉΩ„Å´Êàª„ÅôÔºâ
    $('#subcontractContractAmount').prop('readonly', false);
    $('#subcontractContractAmount').removeClass('bg-light');
    $('#subcontractContractAmount').attr('placeholder', '');

    // Âü∫Ê∫ñÊó•„ÇíÁùÄÂ∑•Êó•Ôºàwork_start_dateÔºâ„Å´Ë®≠ÂÆö„ÄÅÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØ‰ªäÊó•
    let referenceDateValue = '';
    const workStartDate = $('input[name="work_start_date"]').val();

    if (workStartDate) {
        // ÁùÄÂ∑•Êó•„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
        referenceDateValue = workStartDate;
        console.log('üí∞ Âü∫Ê∫ñÊó•„ÇíÁùÄÂ∑•Êó•„Å´Ë®≠ÂÆö:', workStartDate);
    } else {
        // ÁùÄÂ∑•Êó•„ÅåÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØ‰ªäÊó•„Çí‰ΩøÁî®
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        referenceDateValue = `${year}-${month}-${day}`;
        console.log('üí∞ ÁùÄÂ∑•Êó•Êú™Ë®≠ÂÆö„ÅÆ„Åü„ÇÅ„ÄÅÂü∫Ê∫ñÊó•„Çí‰ªäÊó•„Å´Ë®≠ÂÆö:', referenceDateValue);
    }

    $('#modalReferenceDate').val(referenceDateValue);

    // Ë®àÁÆó„Éú„Çø„É≥„ÇíÂàùÊúüÁä∂ÊÖã„ÅßÁÑ°ÂäπÂåñÔºàÊ•≠ËÄÖÊú™ÈÅ∏ÊäûÔºâ
    $('#modalCalculatePaymentDueDate').prop('disabled', true);

    // Ë®àÁÆóÁµêÊûú„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈùûË°®Á§∫
    $('#modalCalculationResult').hide();

    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    const modal = new bootstrap.Modal(document.getElementById('subcontractModal'));
    modal.show();
}

// Áô∫Ê≥®ÂÖà„Éá„Éº„Çø„ÇíJavaScript„ÅßÂà©Áî®„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
const contractorsData = {{ contractors_json|safe }};

// ÂÖÉË´ã‰ºöÁ§æ„Éá„Éº„Çø„ÇíJavaScript„ÅßÂà©Áî®„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
const clientCompaniesData = {{ client_companies_json|safe }};

// Â∑•‰∫ãÁ®ÆÂà•„Éá„Éº„Çø„ÇíJavaScript„ÅßÂà©Áî®„Åß„Åç„Çã„Çà„ÅÜ„Å´„Åô„Çã
const workTypesData = {{ work_types_json|safe }};

// „É¢„Éº„ÉÄ„É´Á∑è„Ç≥„Çπ„ÉàËá™ÂãïË®àÁÆó
$(document).ready(function() {
    // „É¢„Éº„ÉÄ„É´Á∑è„Ç≥„Çπ„ÉàËá™ÂãïË®àÁÆó
    function calculateModalTotalCost() {
        var material1 = parseFloat($('#subcontractMaterialCost1').val()) || 0;
        var material2 = parseFloat($('#subcontractMaterialCost2').val()) || 0;
        var material3 = parseFloat($('#subcontractMaterialCost3').val()) || 0;
        var billed = parseFloat($('#subcontractBilledAmount').val()) || 0;
        var contract = parseFloat($('#subcontractContractAmount').val()) || 0;

        // Ë¢´Ë´ãÊ±ÇÈ°ç„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞Â•ëÁ¥ÑÈáëÈ°ç„Çí‰ΩøÁî®
        var baseAmount = billed > 0 ? billed : contract;

        // Âõ∫ÂÆöÈÉ®ÊùêË≤ª
        var fixedMaterial = material1 + material2 + material3;

        // ÂãïÁöÑÈÉ®ÊùêË≤ª
        var dynamicMaterial = 0;
        $('#modalDynamicMaterialsContainer .row').each(function() {
            var cost = parseFloat($(this).find('.dynamic-material-cost').val()) || 0;
            dynamicMaterial += cost;
        });

        // ËøΩÂä†Ë≤ªÁî®
        var additionalCosts = 0;
        $('#modalAdditionalCostsContainer .row').each(function() {
            var cost = parseFloat($(this).find('.additional-cost-amount').val()) || 0;
            additionalCosts += cost;
        });

        var totalMaterial = fixedMaterial + dynamicMaterial;
        var totalCost = baseAmount + totalMaterial + additionalCosts;

        // „É©„Éô„É´Êõ¥Êñ∞
        if (billed > 0) {
            $('#modalCostBaseLabel').text('Ë´ãÊ±ÇÈáëÈ°ç');
        } else {
            $('#modalCostBaseLabel').text('Â•ëÁ¥ÑÈáëÈ°ç');
        }

        // ÈáëÈ°ç„ÇíÊõ¥Êñ∞
        $('#modalMaterialTotalAmount').text(totalMaterial.toLocaleString());
        $('#modalTotalCostAmount').text(totalCost.toLocaleString());
    }

    // ÈáëÈ°ç„Éï„Ç£„Éº„É´„Éâ„ÅÆÂ§âÊõ¥„ÇíÁõ£Ë¶ñ
    $('#subcontractMaterialCost1, #subcontractMaterialCost2, #subcontractMaterialCost3, #subcontractBilledAmount, #subcontractContractAmount').on('input', calculateModalTotalCost);

    // „É¢„Éº„ÉÄ„É´„ÅåÈñã„ÅÑ„Åü„Å®„Åç„Å´ÂàùÊúüË®àÁÆó
    $('#subcontractModal').on('shown.bs.modal', function() {
        calculateModalTotalCost();
    });

    // ===================================
    // „É¢„Éº„ÉÄ„É´Áî®ÔºöÂãïÁöÑËøΩÂä†Ë≤ªÁî®ÁÆ°ÁêÜ
    // ===================================
    let modalAdditionalCostCounter = 0;

    window.addModalAdditionalCostRow = function() {
        modalAdditionalCostCounter++;
        const rowId = `modal_additional_cost_${modalAdditionalCostCounter}`;

        const row = $(`
            <div class="row mb-2" id="${rowId}">
                <div class="col-md-5">
                    <input type="text" class="form-control additional-cost-item" placeholder="Ë≤ªÁî®È†ÖÁõÆÂêç" data-row="${rowId}">
                </div>
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text">¬•</span>
                        <input type="number" class="form-control additional-cost-amount" placeholder="0" data-row="${rowId}">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeModalAdditionalCostRow('${rowId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `);

        $('#modalAdditionalCostsContainer').append(row);
        updateModalAdditionalCostsData();

        row.find('input').on('input', function() {
            updateModalAdditionalCostsData();
            calculateModalTotalCost();
        });
    };

    window.removeModalAdditionalCostRow = function(rowId) {
        $(`#${rowId}`).remove();
        updateModalAdditionalCostsData();
        calculateModalTotalCost();
    };

    function updateModalAdditionalCostsData() {
        const costs = [];
        let totalAdditional = 0;

        $('#modalAdditionalCostsContainer .row').each(function() {
            const item = $(this).find('.additional-cost-item').val();
            const amount = parseFloat($(this).find('.additional-cost-amount').val()) || 0;

            if (item && amount > 0) {
                costs.push({item, cost: amount});
                totalAdditional += amount;
            }
        });

        $('#modalAdditionalCostsData').val(JSON.stringify(costs));
        $('#modal_additional_total_amount').text(totalAdditional.toLocaleString());

        if (totalAdditional > 0) {
            $('#modal_additional_total_display').show();
        } else {
            $('#modal_additional_total_display').hide();
        }
    }

    // ===================================
    // „É¢„Éº„ÉÄ„É´Áî®ÔºöÂãïÁöÑÈÉ®ÊùêË≤ªÁÆ°ÁêÜ
    // ===================================
    let modalMaterialCounter = 0;

    window.addModalMaterialRow = function() {
        modalMaterialCounter++;
        const rowId = `modal_material_${modalMaterialCounter}`;

        const row = $(`
            <div class="row mb-2" id="${rowId}">
                <div class="col-md-5">
                    <input type="text" class="form-control dynamic-material-item" placeholder="ÈÉ®ÊùêË≤ªÈ†ÖÁõÆÂêç" data-row="${rowId}">
                </div>
                <div class="col-md-5">
                    <div class="input-group">
                        <span class="input-group-text">¬•</span>
                        <input type="number" class="form-control dynamic-material-cost" placeholder="0" data-row="${rowId}">
                    </div>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeModalMaterialRow('${rowId}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `);

        $('#modalDynamicMaterialsContainer').append(row);
        updateModalDynamicMaterialsData();

        row.find('input').on('input', function() {
            updateModalDynamicMaterialsData();
            calculateModalTotalCost();
        });
    };

    window.removeModalMaterialRow = function(rowId) {
        $(`#${rowId}`).remove();
        updateModalDynamicMaterialsData();
        calculateModalTotalCost();
    };

    function updateModalDynamicMaterialsData() {
        const materials = [];

        $('#modalDynamicMaterialsContainer .row').each(function() {
            const item = $(this).find('.dynamic-material-item').val();
            const cost = parseFloat($(this).find('.dynamic-material-cost').val()) || 0;

            if (item && cost > 0) {
                materials.push({item, cost});
            }
        });

        $('#modalDynamicMaterialsData').val(JSON.stringify(materials));
    }

    // ===================================
    // „É¢„Éº„ÉÄ„É´Áî®ÔºöÂá∫Èáë‰∫àÂÆöÊó•Ë®àÁÆó
    // ===================================

    // Âá∫Èáë‰∫àÂÆöÊó•„ÇíË®àÁÆó„Åô„ÇãÈñ¢Êï∞
    function calculatePaymentDueDateForModal(contractDate, closingDay, paymentOffsetMonths, paymentDay) {
        if (!contractDate || closingDay === null || paymentOffsetMonths === null || paymentDay === null) {
            return null;
        }

        const date = new Date(contractDate);

        // Á∑†Êó•„ÇíÂü∫Ê∫ñ„Å´„Åó„Å¶„ÄÅ„Å©„ÅÆÊúà„ÅÆÁ∑†„ÇÅ„Å´Âê´„Åæ„Çå„Çã„Åã„ÇíÂà§ÂÆö
        let closingMonth;
        if (date.getDate() <= closingDay) {
            // ÂΩìÊúàÁ∑†„ÇÅ
            closingMonth = new Date(date.getFullYear(), date.getMonth(), 1);
        } else {
            // ÁøåÊúàÁ∑†„ÇÅ
            closingMonth = new Date(date.getFullYear(), date.getMonth() + 1, 1);
        }

        // ÊîØÊâï„ÅÑÊúà„ÇíË®àÁÆóÔºàÁ∑†„ÇÅÊúà + payment_offset_monthsÔºâ
        const paymentMonth = new Date(closingMonth.getFullYear(), closingMonth.getMonth() + paymentOffsetMonths, 1);

        // ÊîØÊâïÊó•„ÇíË®≠ÂÆö
        let paymentDueDate;
        try {
            paymentDueDate = new Date(paymentMonth.getFullYear(), paymentMonth.getMonth(), paymentDay);

            // 31Êó•„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÊúà„ÅÆÂ†¥Âêà„ÅØÊúàÊú´Êó•„Å´„Åô„Çã
            if (paymentDueDate.getMonth() !== paymentMonth.getMonth()) {
                paymentDueDate = new Date(paymentMonth.getFullYear(), paymentMonth.getMonth() + 1, 0);
            }
        } catch (e) {
            // „Ç®„É©„Éº„ÅÆÂ†¥Âêà„ÅØÊúàÊú´Êó•„Å´„Åô„Çã
            paymentDueDate = new Date(paymentMonth.getFullYear(), paymentMonth.getMonth() + 1, 0);
        }

        return paymentDueDate;
    }

    // Ê•≠ËÄÖÈÅ∏ÊäûÊôÇ„Å´ÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´ÊÉÖÂ†±„ÇíË°®Á§∫
    $(document).on('change', '#subcontractContractor', function() {
        const contractorId = $(this).val();
        if (contractorId && contractorsData[contractorId]) {
            const contractor = contractorsData[contractorId];
            const { closing_day, payment_offset_months, payment_day } = contractor;

            if (closing_day !== null && payment_offset_months !== null && payment_day !== null) {
                const cycleText = `${closing_day}Êó•Á∑†„ÇÅ ${payment_offset_months}„É∂ÊúàÂæå ${payment_day}Êó•Êâï„ÅÑ`;
                $('#paymentCycleText').text(cycleText);
                $('#contractorPaymentInfo').show();
                // Ë®àÁÆó„Éú„Çø„É≥„ÇíÊúâÂäπÂåñ
                $('#modalCalculatePaymentDueDate').prop('disabled', false);
            } else {
                $('#contractorPaymentInfo').hide();
                // Ë®àÁÆó„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñÔºàÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´ÊÉÖÂ†±„Å™„ÅóÔºâ
                $('#modalCalculatePaymentDueDate').prop('disabled', true);
            }
        } else {
            $('#contractorPaymentInfo').hide();
            // Ë®àÁÆó„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñÔºàÊ•≠ËÄÖÊú™ÈÅ∏ÊäûÔºâ
            $('#modalCalculatePaymentDueDate').prop('disabled', true);
        }
    });

    // Âá∫Èáë‰∫àÂÆöÊó•Ë®àÁÆó„Éú„Çø„É≥„ÅÆ„Ç§„Éô„É≥„Éà
    $('#modalCalculatePaymentDueDate').on('click', function() {
        const contractorId = $('#subcontractContractor').val();
        const referenceDate = $('#modalReferenceDate').val();

        // Âü∫Ê∫ñÊó•„ÅåÊú™ÂÖ•Âäõ„ÅÆÂ†¥Âêà„ÅÆ„Åø„ÉÅ„Çß„ÉÉ„ÇØ
        if (!referenceDate) {
            $('#modalCalculationResult').removeClass('alert-success').addClass('alert-warning');
            $('#modalCalculatedDate').text('Âü∫Ê∫ñÊó•„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            $('#modalCalculationResult').show();
            return;
        }

        const contractor = contractorsData[contractorId];
        const { closing_day, payment_offset_months, payment_day } = contractor;

        // Âá∫Èáë‰∫àÂÆöÊó•„ÇíË®àÁÆó
        const paymentDueDate = calculatePaymentDueDateForModal(referenceDate, closing_day, payment_offset_months, payment_day);

        if (paymentDueDate) {
            // YYYY-MM-DDÂΩ¢Âºè„Å´„Éï„Ç©„Éº„Éû„ÉÉ„ÉàÔºà„É≠„Éº„Ç´„É´„Çø„Ç§„É†„Çæ„Éº„É≥„ÅßÔºâ
            const year = paymentDueDate.getFullYear();
            const month = String(paymentDueDate.getMonth() + 1).padStart(2, '0');
            const day = String(paymentDueDate.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            // ÁµêÊûú„ÇíË°®Á§∫
            const displayDate = `${year}Âπ¥${paymentDueDate.getMonth() + 1}Êúà${paymentDueDate.getDate()}Êó•`;
            $('#modalCalculationResult').removeClass('alert-warning').addClass('alert-success');
            $('#modalCalculatedDate').text(displayDate);
            $('#modalCalculationResult').show();

            // Âá∫Èáë‰∫àÂÆöÊó•„Éï„Ç£„Éº„É´„Éâ„Å´Ëá™ÂãïÂÖ•Âäõ
            $('#subcontractPaymentDueDate').val(formattedDate);
        }
    });

    // „Éù„ÉÉ„Éó„Ç™„Éº„Éê„Éº„ÅÆÂàùÊúüÂåñÔºà„É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆË¶ÅÁ¥†Áî®Ôºâ
    $('#subcontractModal').on('shown.bs.modal', function() {
        $('[data-bs-toggle="popover"]').popover();
    });
});

// „É¢„Éº„ÉÄ„É´ÂÜÖ„Ç®„É©„ÉºË°®Á§∫Èñ¢Êï∞
function showModalError(message) {
    // Êó¢Â≠ò„ÅÆ„Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂâäÈô§
    $('#subcontractModalError').remove();

    // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Çí‰ΩúÊàê„Åó„Å¶„É¢„Éº„ÉÄ„É´„ÅÆ„Éú„Éá„Ç£„ÅÆÂÖàÈ†≠„Å´ÊåøÂÖ•
    const errorHtml = `
        <div id="subcontractModalError" class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    `;
    $('#subcontractModal .modal-body').prepend(errorHtml);

    // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„Åæ„Åß„Çπ„ÇØ„É≠„Éº„É´
    $('#subcontractModal .modal-body').scrollTop(0);
}

// ‰∏ãË´ã„Åë„Çí‰øùÂ≠ò
function saveSubcontract() {
    const form = $('#subcontractForm');
    const formData = new FormData(form[0]);

    // ÂãïÁöÑ„Éá„Éº„Çø„ÇíFormData„Å´ËøΩÂä†
    formData.set('dynamic_materials_data', $('#modalDynamicMaterialsData').val() || '[]');
    formData.set('additional_costs_data', $('#modalAdditionalCostsData').val() || '[]');

    // „É¢„Éº„ÉÄ„É´ÂÜÖ„ÅÆ„Ç®„É©„ÉºË°®Á§∫„Ç®„É™„Ç¢„Çí„ÇØ„É™„Ç¢
    $('#subcontractModalError').remove();

    // Ê•≠ËÄÖ„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    const contractorId = $('#subcontractContractor').val();
    if (!contractorId) {
        showModalError('‰∏ãË´ã„ÅëÁÆ°ÁêÜ„Éú„Çø„É≥„Åã„ÇâÊ•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
    }

    // Â∑•Á®ã„Åî„Å®„ÅÆÈáëÈ°çË®≠ÂÆö„ÅÆÂ†¥Âêà„ÄÅ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
    const costMethod = $('input[name="cost_allocation_method"]:checked').val();
    // ËøΩÂä†Â∑•Á®ã„Åå1„Å§‰ª•‰∏äÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Åø„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„ÇíÂÆüË°å
    const hasAdditionalSteps = $('.additional-step-checkbox:checked').length > 0;

    // costMethod„Åå'per_step'„Åß„ÄÅËøΩÂä†Â∑•Á®ã„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆ„Åø„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
    if (costMethod === 'per_step' && hasAdditionalSteps) {
        // ÁèæÂú®„ÅÆÂ∑•Á®ã„ÅÆÈáëÈ°ç„ÇíÂèñÂæóÔºà0ÂÜÜ„ÇÇË®±ÂèØ„Åô„Çã„Åü„ÇÅ„ÄÅÁ©∫„Åã„Å©„ÅÜ„Åã„ÅÆ„Åø„ÉÅ„Çß„ÉÉ„ÇØÔºâ
        const currentStepAmount = $('#currentStepAmount').val();
        if (currentStepAmount === '' || currentStepAmount === null || currentStepAmount === undefined) {
            showModalError('„É°„Ç§„É≥Â∑•Á®ã„ÅÆÂ•ëÁ¥ÑÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
            return;
        }

        // ÂêÑËøΩÂä†Â∑•Á®ã„ÅÆÈáëÈ°ç„ÇíÂèéÈõÜ„Åó„Å¶„Éê„É™„Éá„Éº„Ç∑„Éß„É≥Ôºà0ÂÜÜ„ÇÇË®±ÂèØÔºâ
        const stepAmounts = {};
        let hasError = false;
        let errorMessage = '';
        $('.step-amount-input').each(function() {
            const stepKey = $(this).data('step');
            const amount = $(this).val();
            if (amount === '' || amount === null || amount === undefined) {
                errorMessage = `${$(this).prev('label').text().replace(/Ôºà.*Ôºâ/, '')}„ÅÆÂ•ëÁ¥ÑÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ`;
                hasError = true;
                return false;
            }
            stepAmounts[stepKey] = amount;
        });

        if (hasError) {
            showModalError(errorMessage);
            return;
        }

        // „É°„Ç§„É≥Â∑•Á®ã„ÅÆÈáëÈ°ç„ÇÇ stepAmounts „Å´ËøΩÂä†
        stepAmounts[$('#subcontractStep').val()] = currentStepAmount;

        // JSONÂΩ¢Âºè„ÅßÈÄÅ‰ø°
        formData.set('step_amounts', JSON.stringify(stepAmounts));

        // ÂêàË®àÈáëÈ°ç„ÅØËá™ÂãïË®àÁÆó„Åï„Çå„Åü„ÇÇ„ÅÆ„Åå„Åô„Åß„Å´ contract_amount „Å´Ë®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Çã
        // ÔºàcalculateTotalStepAmount„ÅßË®≠ÂÆöÊ∏à„ÅøÔºâ
    }

    // ÈáëÈ°çË®≠ÂÆöÊñπÊ≥ï„ÇíËøΩÂä†
    if ($('#costAllocationSection').is(':visible')) {
        formData.set('cost_allocation_method', costMethod);
    }

    // ÈùûË°®Á§∫„Éï„Ç£„Éº„É´„Éâ„ÅÆrequiredÂ±ûÊÄß„Çí‰∏ÄÊôÇÁöÑ„Å´ÂâäÈô§ÔºàHTML5„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Ç®„É©„ÉºÂõûÈÅøÔºâ
    const hiddenRequiredFields = [];
    form.find('input[required], select[required], textarea[required]').each(function() {
        const $field = $(this);
        // ÈùûË°®Á§∫„ÄÅ„Åæ„Åü„ÅØË¶™Ë¶ÅÁ¥†„ÅåÈùûË°®Á§∫„ÅÆÂ†¥Âêà
        if (!$field.is(':visible') || $field.closest(':hidden').length > 0) {
            hiddenRequiredFields.push($field);
            $field.removeAttr('required');
        }
    });

    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
    if (!form[0].checkValidity()) {
        // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥Â§±ÊïóÊôÇ„ÄÅrequiredÂ±ûÊÄß„ÇíÂæ©ÂÖÉ
        hiddenRequiredFields.forEach(function($field) {
            $field.attr('required', 'required');
        });
        form[0].reportValidity();
        return;
    }

    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥ÊàêÂäüÂæå„ÄÅrequiredÂ±ûÊÄß„ÇíÂæ©ÂÖÉ
    hiddenRequiredFields.forEach(function($field) {
        $field.attr('required', 'required');
    });

    // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>‰øùÂ≠ò‰∏≠...';

    // AJAXÈÄÅ‰ø°
    $.ajax({
        url: '{% url "subcontract_management:subcontract_create" project.pk %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            bootstrap.Modal.getInstance(document.getElementById('subcontractModal')).hide();

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            if (typeof toastr !== 'undefined') {
                toastr.success('‰ΩúÊ•≠ËÄÖ„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
            }

            // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶Êõ¥Êñ∞„ÇíÂèçÊò†
            setTimeout(function() {
                location.reload();
            }, 500);
        },
        error: function(xhr, status, error) {
            // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            let errorMessage = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';

            if (xhr.responseJSON) {
                if (xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                }

                // „Éï„Ç£„Éº„É´„Éâ„Åî„Å®„ÅÆ„Ç®„É©„Éº„ÇíÂá¶ÁêÜ
                if (xhr.responseJSON.errors) {
                    const errors = xhr.responseJSON.errors;
                    const errorList = [];

                    for (const field in errors) {
                        const fieldErrors = errors[field];
                        if (Array.isArray(fieldErrors)) {
                            fieldErrors.forEach(err => errorList.push(err));
                        } else {
                            errorList.push(fieldErrors);
                        }
                    }

                    if (errorList.length > 0) {
                        errorMessage = errorList.join('<br>');
                    }
                }
            } else if (xhr.responseText) {
                errorMessage = xhr.responseText;
            }

            // „É¢„Éº„ÉÄ„É´ÂÜÖ„Å´„Ç®„É©„Éº„ÇíË°®Á§∫
            showModalError(errorMessage);

            // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    });
}

// ==================== Ë≥áÊùêÁô∫Ê≥®„É¢„Éº„ÉÄ„É´Èñ¢ÈÄ£Èñ¢Êï∞ ====================

// Ë≥áÊùêÁô∫Ê≥®„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
function openMaterialOrderModal() {
    // „Éï„Ç©„Éº„É†„Çí„É™„Çª„ÉÉ„Éà
    $('#materialOrderForm')[0].reset();

    // Áô∫Ê≥®Êó•„Çí‰ªäÊó•„Å´Ë®≠ÂÆö
    const today = new Date().toISOString().split('T')[0];
    $('#materialOrderDate').val(today);

    // Ë≥áÊùêÈ†ÖÁõÆ„ÇíÂàùÊúüÂåñÔºà1„Å§„Å†„ÅëÊÆã„ÅôÔºâ
    $('#materialItems').html(`
        <div class="material-item mb-3 p-3 bg-light rounded">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Ë≥áÊùêÂêç <span class="text-danger">*</span></label>
                    <input type="text" name="material_name[]" class="form-control" placeholder="‰æã: „Ç≥„É≥„ÇØ„É™„Éº„Éà" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Êï∞Èáè</label>
                    <input type="number" name="quantity[]" class="form-control material-quantity" step="0.01" placeholder="0.00">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Âçò‰Ωç</label>
                    <input type="text" name="unit[]" class="form-control" placeholder="‰æã: m¬≥">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Âçò‰æ°(ÂÜÜ)</label>
                    <input type="number" name="unit_price[]" class="form-control material-unit-price" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="form-label">‰ªïÊßò„ÉªË¶èÊ†º</label>
                    <input type="text" name="specification[]" class="form-control" placeholder="‰æã: 24-21-20">
                </div>
            </div>
        </div>
    `);

    // ÂêàË®àÈáëÈ°ç„Çí„É™„Çª„ÉÉ„Éà
    $('#materialTotalAmount').text('¬•0');

    // ÂêàË®àÈáëÈ°çË®àÁÆó„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÇíÂÜçË®≠ÂÆö
    attachMaterialCalculationEvents();

    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    const modal = new bootstrap.Modal(document.getElementById('materialOrderModal'));
    modal.show();
}

// Ë≥áÊùêÈ†ÖÁõÆ„ÇíËøΩÂä†
function addMaterialItem() {
    const newItem = `
        <div class="material-item mb-3 p-3 bg-light rounded position-relative">
            <button type="button" class="btn btn-sm btn-outline-danger position-absolute"
                    style="top: 10px; right: 10px;" onclick="removeMaterialItem(this)">
                <i class="fas fa-times"></i>
            </button>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">Ë≥áÊùêÂêç <span class="text-danger">*</span></label>
                    <input type="text" name="material_name[]" class="form-control" placeholder="‰æã: „Ç≥„É≥„ÇØ„É™„Éº„Éà" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Êï∞Èáè</label>
                    <input type="number" name="quantity[]" class="form-control material-quantity" step="0.01" placeholder="0.00">
                </div>
                <div class="col-md-2">
                    <label class="form-label">Âçò‰Ωç</label>
                    <input type="text" name="unit[]" class="form-control" placeholder="‰æã: m¬≥">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Âçò‰æ°(ÂÜÜ)</label>
                    <input type="number" name="unit_price[]" class="form-control material-unit-price" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="form-label">‰ªïÊßò„ÉªË¶èÊ†º</label>
                    <input type="text" name="specification[]" class="form-control" placeholder="‰æã: 24-21-20">
                </div>
            </div>
        </div>
    `;

    $('#materialItems').append(newItem);

    // Êñ∞„Åó„ÅèËøΩÂä†„Åï„Çå„ÅüÈ†ÖÁõÆ„Å´„ÇÇ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÇíË®≠ÂÆö
    attachMaterialCalculationEvents();
}

// Ë≥áÊùêÈ†ÖÁõÆ„ÇíÂâäÈô§
function removeMaterialItem(button) {
    $(button).closest('.material-item').remove();
    calculateMaterialTotal();
}

// ÂêàË®àÈáëÈ°ç„ÇíË®àÁÆó
function calculateMaterialTotal() {
    let total = 0;

    $('.material-item').each(function() {
        const quantity = parseFloat($(this).find('.material-quantity').val()) || 0;
        const unitPrice = parseFloat($(this).find('.material-unit-price').val()) || 0;
        total += quantity * unitPrice;
    });

    $('#materialTotalAmount').text('¬•' + total.toLocaleString());
    return total;
}

// ÂêàË®àÈáëÈ°çË®àÁÆó„ÅÆ„Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„ÇíË®≠ÂÆö
function attachMaterialCalculationEvents() {
    $('.material-quantity, .material-unit-price').off('input').on('input', function() {
        calculateMaterialTotal();
    });
}

// Ë≥áÊùêÁô∫Ê≥®„Çí‰øùÂ≠ò
function saveMaterialOrder() {
    const form = $('#materialOrderForm');

    // „Éê„É™„Éá„Éº„Ç∑„Éß„É≥
    if (!form[0].checkValidity()) {
        form[0].reportValidity();
        return;
    }

    // „Éï„Ç©„Éº„É†„Éá„Éº„Çø„ÇíÂèéÈõÜ
    const formData = new FormData(form[0]);

    // ÂêàË®àÈáëÈ°ç„ÇíËøΩÂä†
    const totalAmount = calculateMaterialTotal();
    formData.append('total_amount', totalAmount);

    // ‰øùÂ≠ò„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>‰øùÂ≠ò‰∏≠...';

    // AJAXÈÄÅ‰ø°
    $.ajax({
        url: '{% url "order_management:material_order_create" project.pk %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
            bootstrap.Modal.getInstance(document.getElementById('materialOrderModal')).hide();

            // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            if (typeof toastr !== 'undefined') {
                toastr.success('Ë≥áÊùêÁô∫Ê≥®„ÇíËøΩÂä†„Åó„Åæ„Åó„Åü');
            }

            // „Éö„Éº„Ç∏„Çí„É™„É≠„Éº„Éâ„Åó„Å¶Êõ¥Êñ∞„ÇíÂèçÊò†
            setTimeout(function() {
                location.reload();
            }, 500);
        },
        error: function(xhr, status, error) {
            // „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
            let errorMessage = '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            } else if (xhr.responseText) {
                errorMessage = xhr.responseText;
            }

            if (typeof toastr !== 'undefined') {
                toastr.error(errorMessage);
            } else {
                showErrorModal(errorMessage);
            }

            // „Éú„Çø„É≥„ÇíÂÖÉ„Å´Êàª„Åô
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    });
}

// ============================================
// ‰∏ãË´ã„ÅëÁÆ°ÁêÜ„Éë„Éç„É´
// ============================================

// ‰∏ãË´ã„ÅëÁÆ°ÁêÜ„Éë„Éç„É´„ÇíÈñã„Åè
window.openContractorManagementPanel = function() {
    console.log('‚úÖ openContractorManagementPanel called');

    // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    const modal = new bootstrap.Modal(document.getElementById('contractorManagementModal'));
    modal.show();

    // ‰∏ãË´ã„ÅëÊ•≠ËÄÖ‰∏ÄË¶ß„ÇíË™≠„ÅøËæº„ÇÄ
    refreshContractorList();

    // Ê§úÁ¥¢Ê©üËÉΩ„ÇíÂàùÊúüÂåñ
    setTimeout(function() {
        const searchInput = $('#contractorSearchInput');
        if (searchInput.length) {
            searchInput.off('input').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterContractorList(searchTerm);
            });
        }
    }, 100);
};

// ‰∏ãË´ã„ÅëÊ•≠ËÄÖ‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
window.refreshContractorList = function() {
    console.log('‚úÖ refreshContractorList called');

    const tbody = $('#contractorTableBody');
    tbody.html('<tr><td colspan="12" class="text-center text-muted">Ë™≠„ÅøËæº„Åø‰∏≠...</td></tr>');

    // „Åô„Åπ„Å¶„ÅÆ‰∏ãË´ã„ÅëÊ•≠ËÄÖ„ÇíÂèñÂæóÔºàDjango„ÉÜ„É≥„Éó„É¨„Éº„Éà„Åã„ÇâÔºâ
    const allContractors = contractorsData;

    console.log('üìã ‰∏ãË´ã„ÅëÊ•≠ËÄÖ„Éá„Éº„Çø:', allContractors);
    if (allContractors && allContractors.length > 0) {
        console.log('üìã ÊúÄÂàù„ÅÆ‰∏ãË´ã„ÅëÊ•≠ËÄÖ„ÅÆ„Éá„Éº„ÇøË©≥Á¥∞:', allContractors[0]);
    }

    if (!allContractors || allContractors.length === 0) {
        tbody.html('<tr><td colspan="12" class="text-center text-muted">‰∏ãË´ã„ÅëÊ•≠ËÄÖ„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</td></tr>');
        return;
    }

    let html = '';
    allContractors.forEach(function(contractor) {
        const statusBadge = contractor.is_active ?
            '<span class="badge bg-success">ÊúâÂäπ</span>' :
            '<span class="badge bg-secondary">ÁÑ°Âäπ</span>';

        const contractorTypeText = contractor.contractor_type_display || '-';
        const paymentCycleText = contractor.payment_cycle_display || '-';

        // Á∑†„ÇÅÊó•: null/undefined„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        const closingDayText = (contractor.closing_day !== null && contractor.closing_day !== undefined)
            ? `${contractor.closing_day}Êó•` : '-';

        // ÊîØÊâïÊúà: null/undefined„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        const paymentOffsetMonthsText = contractor.payment_offset_months_display || '-';

        // ÊîØÊâï„ÅÑÊó•: null/undefined„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        const paymentDayText = (contractor.payment_day !== null && contractor.payment_day !== undefined)
            ? `${contractor.payment_day}Êó•` : '-';

        // ÂêÑÊ•≠ËÄÖ„ÅÆ„Éá„Éº„Çø„ÇíÁ¢∫Ë™ç
        console.log(`  - ${contractor.name}: Á®ÆÂà•=${contractor.contractor_type_display}, Á∑†„ÇÅÊó•=${contractor.closing_day}, ÊîØÊâïÊúà=${contractor.payment_offset_months_display}, ÊîØÊâï„ÅÑÊó•=${contractor.payment_day}`);

        html += `
            <tr style="cursor: pointer;" onclick="selectContractor(${contractor.id})" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                <td><strong>${escapeHtml(contractor.name)}</strong></td>
                <td>${contractorTypeText}</td>
                <td>${escapeHtml(contractor.address || '-')}</td>
                <td>${escapeHtml(contractor.phone || '-')}</td>
                <td>${escapeHtml(contractor.contact_person || '-')}</td>
                <td>${escapeHtml(contractor.specialties || '-')}</td>
                <td class="text-center">${paymentCycleText}</td>
                <td class="text-center">${closingDayText}</td>
                <td class="text-center">${paymentOffsetMonthsText}</td>
                <td class="text-center">${paymentDayText}</td>
                <td class="text-center">${statusBadge}</td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-outline-primary" onclick="editContractor(${contractor.id})" title="Á∑®ÈõÜ">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.html(html);
};

// ‰∏ãË´ã„ÅëÊ•≠ËÄÖ„ÇíÈÅ∏Êäû„Åó„Å¶„É°„Ç§„É≥„Éï„Ç©„Éº„É†„Å´ÈÅ©Áî®
window.selectContractor = function(contractorId) {
    console.log('‚úÖ selectContractor called', contractorId);

    // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    const modal = bootstrap.Modal.getInstance(document.getElementById('contractorManagementModal'));
    if (modal) modal.hide();

    // Èö†„Åó„Éï„Ç£„Éº„É´„Éâ„Å´Ê•≠ËÄÖID„ÇíË®≠ÂÆö
    $('#subcontractContractor').val(contractorId);

    // ÈÅ∏Êäû„Åï„Çå„ÅüÊ•≠ËÄÖ„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
    const selectedContractor = contractorsData.find(c => c.id === contractorId);

    if (selectedContractor) {
        console.log('‚úÖ ÈÅ∏Êäû„Åï„Çå„Åü‰∏ãË´ã„ÅëÊ•≠ËÄÖ:', selectedContractor);

        // Ë°®Á§∫„Éï„Ç£„Éº„É´„Éâ„Å´Ê•≠ËÄÖÂêç„ÇíË®≠ÂÆö
        $('#selectedContractorDisplay').val(selectedContractor.name);

        // ÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´ÊÉÖÂ†±„ÇíËá™ÂãïÂÖ•ÂäõÔºàÊó¢Â≠ò„ÅÆÂá¶ÁêÜ„ÇíÂÜçÂà©Áî®Ôºâ
        $('#contractorPaymentCycleDisplay').text(selectedContractor.payment_cycle_display || '-');
        $('#contractorClosingDayDisplay').text(selectedContractor.closing_day ? selectedContractor.closing_day + 'Êó•' : '-');
        $('#contractorPaymentOffsetMonthsDisplay').text(selectedContractor.payment_offset_months_display || '-');
        $('#contractorPaymentDayDisplay').text(selectedContractor.payment_day ? selectedContractor.payment_day + 'Êó•' : '-');

        // ÊîØÊâï„ÅÑÊÉÖÂ†±„ÇíË°®Á§∫
        if (selectedContractor.payment_cycle || selectedContractor.closing_day || selectedContractor.payment_offset_months !== null || selectedContractor.payment_day) {
            $('#contractorPaymentInfo').show();
        } else {
            $('#contractorPaymentInfo').hide();
        }

        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏
        if (typeof toastr !== 'undefined') {
            toastr.success(`„Äå${selectedContractor.name}„Äç„ÇíÈÅ∏Êäû„Åó„Åæ„Åó„Åü`);
        }
    }
};

// ‰∏ãË´ã„ÅëÊ•≠ËÄÖÁ∑®ÈõÜÔºàÂà•„Éö„Éº„Ç∏„Å∏ÈÅ∑ÁßªÔºâ
window.editContractor = function(contractorId) {
    // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏URL„Çíback„Éë„É©„É°„Éº„Çø„Å®„Åó„Å¶Ê∏°„Åô
    const currentUrl = encodeURIComponent(window.location.pathname);
    window.location.href = `/orders/contractors/${contractorId}/edit/?back=${currentUrl}`;
};

// ‰∏ãË´ã„ÅëÊ•≠ËÄÖ‰∏ÄË¶ß„Çí„Éï„Ç£„É´„Çø„É™„É≥„Ç∞
window.filterContractorList = function(searchTerm) {
    console.log('üîç Filtering contractors:', searchTerm);

    const rows = $('#contractorTableBody tr');

    if (!searchTerm || searchTerm.trim() === '') {
        rows.show();
        return;
    }

    rows.each(function() {
        const row = $(this);
        const contractorName = row.find('td:first strong').text().toLowerCase();
        const contractorType = row.find('td:nth-child(2)').text().toLowerCase();
        const address = row.find('td:nth-child(3)').text().toLowerCase();
        const phone = row.find('td:nth-child(4)').text().toLowerCase();
        const specialties = row.find('td:nth-child(6)').text().toLowerCase();

        if (contractorName.includes(searchTerm) ||
            contractorType.includes(searchTerm) ||
            address.includes(searchTerm) ||
            phone.includes(searchTerm) ||
            specialties.includes(searchTerm)) {
            row.show();
        } else {
            row.hide();
        }
    });

    // Ê§úÁ¥¢ÁµêÊûú„Åå0‰ª∂„ÅÆÂ†¥Âêà„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
    const visibleRows = rows.filter(':visible').length;
    if (visibleRows === 0) {
        const tbody = $('#contractorTableBody');
        if (tbody.find('.no-results-row').length === 0) {
            tbody.append('<tr class="no-results-row"><td colspan="12" class="text-center text-muted py-4"><i class="fas fa-search me-2"></i>„Äå' + escapeHtml(searchTerm) + '„Äç„Å´‰∏ÄËá¥„Åô„Çã‰∏ãË´ã„ÅëÊ•≠ËÄÖ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü</td></tr>');
        }
    } else {
        $('#contractorTableBody .no-results-row').remove();
    }
};

// Êñ∞Ë¶è‰∏ãË´ã„ÅëÊ•≠ËÄÖËøΩÂä†ÔºàÂà•„Éö„Éº„Ç∏„Å∏ÈÅ∑ÁßªÔºâ
window.addNewContractor = function() {
    // ÁèæÂú®„ÅÆ„Éö„Éº„Ç∏URL„Çíback„Éë„É©„É°„Éº„Çø„Å®„Åó„Å¶Ê∏°„Åô
    const currentUrl = encodeURIComponent(window.location.pathname);
    window.location.href = `/orders/contractors/new/?back=${currentUrl}`;
};

// HTML„Ç®„Çπ„Ç±„Éº„ÉóÈñ¢Êï∞ÔºàÊó¢„Å´ÂÆöÁæ©„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„ÉóÔºâ
if (typeof escapeHtml === 'undefined') {
    window.escapeHtml = function(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
    };
}

// #comment-content „ÅØ Enter„Ç≠„Éº„ÅßÊîπË°å„Åï„Çå„ÄÅ„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØ„Åß„ÅÆ„ÅøÊäïÁ®ø„Åï„Çå„ÇãÔºàË®≠ÂÆö‰∏çË¶ÅÔºâ
</script>

<!-- Tribute.js - „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.css">
<script src="https://cdn.jsdelivr.net/npm/tributejs@5.1.3/dist/tribute.min.js"></script>

<style>
/* Tribute.js „É°„É≥„Ç∑„Éß„É≥„Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„ÅÆ„Ç´„Çπ„Çø„É†„Çπ„Çø„Ç§„É´ */
.tribute-container {
    position: absolute;
    top: 0;
    left: 0;
    height: auto;
    overflow: auto;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    max-height: 300px;
}

.tribute-container ul {
    margin: 0;
    padding: 0;
    list-style: none;
}

.tribute-container li {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 0.875rem;
    border-bottom: 1px solid #f0f0f0;
}

.tribute-container li:last-child {
    border-bottom: none;
}

.tribute-container li.highlight,
.tribute-container li:hover {
    background-color: #e7f3ff;
    color: #0d6efd;
}

.tribute-container li span {
    font-weight: normal;
}

.tribute-container .mention-name {
    font-weight: 600;
    color: #212529;
}

.tribute-container .mention-email {
    font-size: 0.75rem;
    color: #6c757d;
    margin-left: 8px;
}
</style>

<script>
// „É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÅÆÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    const commentTextarea = document.getElementById('comment-content');

    if (commentTextarea) {
        // Tribute.js„ÅÆË®≠ÂÆö
        const tribute = new Tribute({
            values: function (text, cb) {
                // „É¶„Éº„Ç∂„ÉºÊ§úÁ¥¢API„ÇíÂëº„Å≥Âá∫„Åó
                console.log('„É°„É≥„Ç∑„Éß„É≥Ê§úÁ¥¢:', text);
                fetch(`/orders/api/mention/users/?q=${encodeURIComponent(text)}`)
                    .then(response => {
                        console.log('API„É¨„Çπ„Éù„É≥„Çπ:', response.status);
                        return response.json();
                    })
                    .then(users => {
                        console.log('ÂèñÂæó„Åó„Åü„É¶„Éº„Ç∂„Éº:', users);
                        cb(users);
                    })
                    .catch(error => {
                        console.error('„É°„É≥„Ç∑„Éß„É≥ÂÄôË£ú„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
                        cb([]);
                    });
            },
            // „ÉÜ„É≥„Éó„É¨„Éº„Éà: „Éâ„É≠„ÉÉ„Éó„ÉÄ„Ç¶„É≥„Å´Ë°®Á§∫„Åô„ÇãÂÜÖÂÆπ
            menuItemTemplate: function (item) {
                return `<span class="mention-name">${item.original.value}</span><span class="mention-email">${item.original.email}</span>`;
            },
            // ÈÅ∏ÊäûÊôÇ„Å´ÊåøÂÖ•„Åô„Çã„ÉÜ„Ç≠„Çπ„Éà
            selectTemplate: function (item) {
                return '@' + item.original.key;
            },
            // Ê§úÁ¥¢„Ç≠„Éº
            lookup: 'value',
            // „É°„É≥„Ç∑„Éß„É≥ÈñãÂßãÊñáÂ≠ó
            trigger: '@',
            // Ê§úÁ¥¢ÊñáÂ≠óÊï∞„ÅÆÊúÄÂ∞èÂÄ§
            menuShowMinLength: 0,
            // Ê§úÁ¥¢ÁµêÊûú„Å™„Åó„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏
            noMatchTemplate: function () {
                return '<li style="padding: 8px 12px; color: #6c757d;">Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</li>';
            },
            // Â§ßÊñáÂ≠óÂ∞èÊñáÂ≠ó„ÇíÂå∫Âà•„Åó„Å™„ÅÑ
            requireLeadingSpace: false,
            // Ë®±ÂÆπ„Åô„ÇãÊñáÂ≠ó
            allowSpaces: false
        });

        // textarea„Å´Tribute„ÇíÈÅ©Áî®
        tribute.attach(commentTextarea);

        console.log('„É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü');
    }

    // Ëøî‰ø°„Éï„Ç©„Éº„É†„ÅÆtextarea„Å´„ÇÇ„É°„É≥„Ç∑„Éß„É≥Ê©üËÉΩ„ÇíÈÅ©Áî®
    // ÂãïÁöÑ„Å´ËøΩÂä†„Åï„Çå„ÇãËøî‰ø°„Éï„Ç©„Éº„É†„Å´„ÇÇÂØæÂøú
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            mutation.addedNodes.forEach(function(node) {
                if (node.nodeType === 1) { // Element node
                    const replyTextareas = node.querySelectorAll ? node.querySelectorAll('textarea[id^="reply-content-"]') : [];
                    replyTextareas.forEach(function(textarea) {
                        if (!textarea.tributeAttached) {
                            const replyTribute = new Tribute({
                                values: function (text, cb) {
                                    fetch(`/orders/api/mention/users/?q=${encodeURIComponent(text)}`)
                                        .then(response => response.json())
                                        .then(users => cb(users))
                                        .catch(error => {
                                            console.error('„É°„É≥„Ç∑„Éß„É≥ÂÄôË£ú„ÅÆÂèñÂæó„Å´Â§±Êïó:', error);
                                            cb([]);
                                        });
                                },
                                menuItemTemplate: function (item) {
                                    return `<span class="mention-name">${item.original.value}</span><span class="mention-email">${item.original.email}</span>`;
                                },
                                selectTemplate: function (item) {
                                    return '@' + item.original.key;
                                },
                                lookup: 'value',
                                trigger: '@',
                                menuShowMinLength: 0,
                                noMatchTemplate: function () {
                                    return '<li style="padding: 8px 12px; color: #6c757d;">Ë©≤ÂΩì„Åô„Çã„É¶„Éº„Ç∂„Éº„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì</li>';
                                },
                                requireLeadingSpace: false,
                                allowSpaces: false
                            });
                            replyTribute.attach(textarea);
                            textarea.tributeAttached = true;
                        }
                    });
                }
            });
        });
    });

    // Ëøî‰ø°„Éï„Ç©„Éº„É†„Ç≥„É≥„ÉÜ„Éä„ÇíÁõ£Ë¶ñ
    const replyContainers = document.querySelectorAll('[id^="reply-form-"]');
    replyContainers.forEach(function(container) {
        observer.observe(container, { childList: true, subtree: true });
    });
});
</script>

<!-- ‰∏ãË´ã„ÅëÁÆ°ÁêÜ„Éë„Éç„É´„É¢„Éº„ÉÄ„É´ -->
<div class="modal fade" id="contractorManagementModal" tabindex="-1" aria-labelledby="contractorManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorManagementModalLabel">
                    <i class="fas fa-handshake"></i> ‰∏ãË´ã„ÅëÁÆ°ÁêÜ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">ÁôªÈå≤‰∏ãË´ã„ÅëÊ•≠ËÄÖ‰∏ÄË¶ß</h6>
                    <div class="d-flex gap-2">
                        <input type="text" id="contractorSearchInput" class="form-control form-control-sm" placeholder="Ê•≠ËÄÖÂêç„ÅßÊ§úÁ¥¢..." style="width: 250px;">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewContractor()">
                            <i class="fas fa-plus"></i> Êñ∞Ë¶èËøΩÂä†
                        </button>
                    </div>
                </div>

                <!-- ‰∏ãË´ã„ÅëÊ•≠ËÄÖ„ÉÜ„Éº„Éñ„É´ -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>Ê•≠ËÄÖÂêç</th>
                                <th>Ê•≠ËÄÖÁ®ÆÂà•</th>
                                <th>‰ΩèÊâÄ</th>
                                <th>ÈõªË©±Áï™Âè∑</th>
                                <th>ÊãÖÂΩìËÄÖ</th>
                                <th>Â∞ÇÈñÄÂàÜÈáé</th>
                                <th class="text-center">ÊîØÊâï„ÅÑ„Çµ„Ç§„ÇØ„É´</th>
                                <th class="text-center">Á∑†„ÇÅÊó•</th>
                                <th class="text-center">ÊîØÊâïÊúà</th>
                                <th class="text-center">ÊîØÊâï„ÅÑÊó•</th>
                                <th class="text-center">Áä∂ÊÖã</th>
                                <th style="width: 140px;">„Ç¢„ÇØ„Ç∑„Éß„É≥</th>
                            </tr>
                        </thead>
                        <tbody id="contractorTableBody">
                            <tr>
                                <td colspan="12" class="text-center text-muted">Ë™≠„ÅøËæº„Åø‰∏≠...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Èñâ„Åò„Çã</button>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/locales/ja.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('projectCalendar');
    var calendar = null;
    var calendarInitialized = false;

    function initCalendar() {
        if (calendarInitialized || !calendarEl) return;

        // „Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆÈÄ≤Êçó„Çπ„ÉÜ„ÉÉ„Éó„Åã„Çâ„Ç§„Éô„É≥„Éà„Çí‰ΩúÊàê
        var events = [];

        {% for step in project.progress_steps.all %}
            {% if step.value and step.value.scheduled_date %}
            events.push({
                title: '{{ step.template.name }}',
                start: '{{ step.value.scheduled_date }}',
                backgroundColor: '{{ step.is_completed|yesno:"#28a745,#007bff" }}',
                borderColor: '{{ step.is_completed|yesno:"#28a745,#007bff" }}',
                extendedProps: {
                    completed: {{ step.is_completed|yesno:"true,false" }},
                    stepName: '{{ step.template.name }}'
                }
            });
            {% endif %}
        {% endfor %}

        // Â•ëÁ¥ÑÊó•
        {% if project.contract_date %}
        events.push({
            title: 'Â•ëÁ¥ÑÊó•',
            start: '{{ project.contract_date|date:"Y-m-d" }}',
            backgroundColor: '#6c757d',
            borderColor: '#6c757d'
        });
        {% endif %}

        // ÊîØÊâïÊúüÊó•
        {% if project.payment_due_date %}
        events.push({
            title: 'ÊîØÊâïÊúüÊó•',
            start: '{{ project.payment_due_date|date:"Y-m-d" }}',
            backgroundColor: '#ffc107',
            borderColor: '#ffc107'
        });
        {% endif %}

        console.log('Calendar events:', events);

        calendar = new FullCalendar.Calendar(calendarEl, {
            locale: 'ja',
            initialView: 'dayGridMonth',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek'
            },
            events: events,
            eventClick: function(info) {
                var eventDetails = info.event.title;
                if (info.event.extendedProps && info.event.extendedProps.completed) {
                    eventDetails += ' (ÂÆå‰∫Ü)';
                }
                alert(eventDetails);
            },
            height: 'auto',
            buttonText: {
                today: '‰ªäÊó•',
                month: 'Êúà',
                week: 'ÈÄ±'
            }
        });

        calendar.render();
        calendarInitialized = true;
    }

    // „Ç´„É¨„É≥„ÉÄ„Éº„Çø„Éñ„Åå„ÇØ„É™„ÉÉ„ÇØ„Åï„Çå„Åü„Å®„Åç„Å´ÂàùÊúüÂåñ
    var calendarTab = document.getElementById('calendar-tab');
    if (calendarTab) {
        calendarTab.addEventListener('shown.bs.tab', function (e) {
            initCalendar();
        });
    }

    // „Çø„Éñ„Åå„Åô„Åß„Å´„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Å™Â†¥Âêà„ÅØÂç≥Â∫ß„Å´ÂàùÊúüÂåñ
    var calendarTabPane = document.getElementById('calendar');
    if (calendarTabPane && calendarTabPane.classList.contains('active')) {
        initCalendar();
    }
});
</script>

{% endblock %}