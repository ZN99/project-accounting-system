{% extends "order_management/base.html" %}
{% load humanize %}
{% load role_tags %}
{% load custom_filters %}
{# âœ… COMMENT_SYSTEM_V2.0_20251129_020500 #}

{% block title %}{{ project.site_name }} - å»ºç¯‰æ´¾é£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<style>
/* å…¨ä½“çš„ã«æ–‡å­—ã‚’å¤§ãã */
.content {
    font-size: 1.1rem;
}

/* æ–™é‡‘ä½“ç³»é¸æŠã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.pricing-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.pricing-type-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
}

.pricing-type-card.border-primary {
    border-color: #0d6efd !important;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.25);
}

.pricing-type-card.bg-light {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.pricing-type-card .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}

/* ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.progress-enhanced {
    border-radius: 4px;
    background-color: #e9ecef;
}

.progress-enhanced .progress-bar {
    font-size: 0.85rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: width 0.6s ease;
    color: #fff;
}

/* é€²æ—ãƒãƒƒã‚¸ã®è‰² */
.bg-verified {
    background-color: #155724 !important; /* æ¿ƒã„ç·‘ï¼šå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ */
}

/* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã®çµ±ä¸€çš„ãªæ‹¡å¤§ - ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ä¸Šæ›¸ã */
.content [style*="font-size: 0.6rem"],
.content [style*="font-size: 0.65rem"] {
    font-size: 0.8rem !important;
}

.content [style*="font-size: 0.7rem"],
.content [style*="font-size: 0.75rem"] {
    font-size: 0.9rem !important;
}

.content [style*="font-size: 0.8rem"],
.content [style*="font-size: 0.85rem"] {
    font-size: 1rem !important;
}

/* ãƒœã‚¿ãƒ³ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
.content .btn {
    font-size: 0.9rem !important;
}

.content .btn-sm {
    font-size: 0.85rem !important;
}

/* ãƒãƒƒã‚¸ã®ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚º */
.content .badge {
    font-size: 0.8rem !important;
}

/* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
.content .form-control,
.content .form-select {
    font-size: 0.9rem !important;
}

/* ãƒ†ãƒ¼ãƒ–ãƒ« */
.content .table {
    font-size: 0.9rem !important;
}

/* å°ã•ã„ãƒ†ã‚­ã‚¹ãƒˆ */
.content small,
.content .small,
.content .text-muted {
    font-size: 0.85rem !important;
}
</style>
<!-- Sortable.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
    .progress-status-card {
        border: 2px solid;
        border-radius: 10px;
        transition: all 0.3s;
    }
    .progress-status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .action-button {
        min-width: 120px;
        margin: 0.25rem;
    }
    .status-selector {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1rem;
    }
    .progress-timeline {
        position: relative;
        padding-left: 2rem;
    }
    .progress-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -26px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d; /* ã‚°ãƒ¬ãƒ¼ï¼šä½•ã‚‚å…¥åŠ›ãªã— */
    }
    .timeline-item.scheduled::before {
        background: #ffc107; /* é»„è‰²ï¼šäºˆå®šæ—¥ã®ã¿å…¥åŠ› */
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }
    .timeline-item.completed::before {
        background: #28a745; /* ç·‘ï¼šå®Œäº†æ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ */
    }
    .timeline-item.verified::before {
        background: #155724; /* æ¿ƒã„ç·‘ï¼šå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ */
        box-shadow: 0 0 0 4px rgba(21, 87, 36, 0.3);
    }
    .timeline-item.current::before {
        background: #ffc107; /* é»„è‰²ï¼šç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆäºˆå®šæ—¥ã®ã¿ã¨åŒã˜ï¼‰ */
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }

    /* ç¸¦å‹ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .vertical-progress {
        position: relative;
        padding-left: 40px;
        min-height: 400px;
    }

    .vertical-progress::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }

    .progress-step {
        position: relative;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }

    .progress-step::before {
        content: '';
        position: absolute;
        left: -28px;
        top: 8px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #6c757d;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #6c757d;
        transition: all 0.3s ease;
    }

    .progress-step.completed::before {
        background: #28a745;
        box-shadow: 0 0 0 2px #28a745;
    }

    .progress-step.active::before {
        background: #007bff;
        box-shadow: 0 0 0 2px #007bff, 0 0 0 6px rgba(0, 123, 255, 0.2);
        transform: scale(1.2);
    }

    .progress-step.overdue::before {
        background: #dc3545;
        box-shadow: 0 0 0 2px #dc3545, 0 0 0 6px rgba(220, 53, 69, 0.2);
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 2px #dc3545, 0 0 0 6px rgba(220, 53, 69, 0.2);
        }
        50% {
            box-shadow: 0 0 0 2px #dc3545, 0 0 0 10px rgba(220, 53, 69, 0.4);
        }
    }

    .progress-step.overdue .progress-step-header {
        color: #dc3545;
    }

    .progress-step.overdue .progress-step-date {
        color: #dc3545;
        font-weight: 600;
    }

    .progress-step.overdue {
        background-color: rgba(220, 53, 69, 0.05);
        border-color: rgba(220, 53, 69, 0.3);
    }

    .progress-step:hover {
        transform: translateX(5px);
    }

    .progress-step-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        transition: color 0.3s ease;
    }

    .progress-step.completed .progress-step-header {
        color: #28a745;
    }

    .progress-step.active .progress-step-header {
        color: #007bff;
    }

    .progress-step-label {
        font-size: 1.05rem;
        font-weight: 500;
    }

    .progress-step-content {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 6px 8px;
        margin-top: 5px;
        display: none;
        box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        font-size: 0.9rem;
        line-height: 1.3;
    }

    .progress-step.expanded .progress-step-content {
        max-height: 5000px;
        opacity: 1;
        border-color: #dee2e6;
        background: #fff;
    }

    .progress-step-content {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-in-out, opacity 0.2s ease-in-out;
    }

    .progress-step {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 0.25rem 0.4rem;
        margin-bottom: 0.3rem;
        background-color: #fff;
        max-width: 800px;
    }

    .progress-step:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        border-color: #adb5bd;
    }

    .progress-step.expanded {
        background-color: #fff;
        border-color: #dee2e6;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .progress-step-date {
        font-size: 0.85rem;
        color: #6c757d;
        line-height: 1.2;
    }

    /* ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ãƒ‘ãƒãƒ«å†…ã®ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã‚’å°ã•ãã™ã‚‹ */
    #activeSteps .form-label {
        font-size: 0.85rem;
        margin-bottom: 0.2rem;
        line-height: 1.2;
    }

    #activeSteps .form-control,
    #activeSteps .form-select {
        font-size: 0.85rem;
        padding: 0.25rem 0.4rem;
        height: auto;
        min-height: 28px;
    }

    #activeSteps .form-check {
        font-size: 0.7rem;
        margin-bottom: 0.3rem;
        line-height: 1.2;
    }

    #activeSteps .form-check-input {
        width: 14px;
        height: 14px;
        margin-top: 0.1rem;
    }

    #activeSteps .btn {
        font-size: 0.65rem;
        padding: 0.2rem 0.4rem;
        line-height: 1.2;
    }

    #activeSteps .mb-3 {
        margin-bottom: 0.5rem !important;
    }

    #activeSteps .mb-2 {
        margin-bottom: 0.3rem !important;
    }

    #activeSteps .input-group {
        font-size: 0.7rem;
    }

    #activeSteps .input-group .btn {
        padding: 0.2rem 0.4rem;
    }

    /* ã‚¹ãƒ†ãƒƒãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼ã®ã‚µã‚¤ã‚ºèª¿æ•´ */
    #activeSteps .progress-step-header {
        font-size: 0.75rem;
        line-height: 1.2;
    }

    #activeSteps .progress-step-header i {
        font-size: 0.7rem;
    }

    /* ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚«ãƒ¼ãƒ‰ */
    .border-dashed {
        border: 2px dashed #dee2e6 !important;
        transition: all 0.3s ease;
    }
    .border-dashed:hover {
        border-color: #007bff !important;
        background-color: #f8f9fa;
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ— */
    .progress-step.sortable-ghost {
        opacity: 0.5;
        background: #e9ecef;
    }
    .progress-step.sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .progress-step.sortable-chosen {
        cursor: grab;
    }
    .progress-step {
        transition: all 0.3s ease;
    }
    .progress-step:hover {
        transform: translateX(5px);
    }
    .drag-handle {
        cursor: grab;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .progress-step:hover .drag-handle {
        opacity: 1;
    }
    .drag-handle:active {
        cursor: grabbing;
    }

    .progress-step.completed .progress-step-date {
        color: #28a745;
        font-weight: 500;
    }

    /* è©³ç´°é€²æ—ç®¡ç†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - Phase 11 */
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 28px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #e9ecef 0%, #dee2e6 100%);
    }

    .timeline-item {
        position: relative;
        padding-left: 70px;
        padding-bottom: 30px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-marker {
        position: absolute;
        left: 0;
        top: 0;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        z-index: 1;
    }

    .timeline-marker.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .timeline-marker.bg-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
    }

    .timeline-content {
        background: #ffffff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .timeline-content:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        transform: translateX(5px);
    }

    .timeline-content h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .badge.bg-light.text-dark {
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<!-- ä¿å­˜çŠ¶æ…‹ãƒãƒŠãƒ¼ -->
<div id="savingStatusBanner" class="alert alert-info alert-dismissible fade show d-none" role="alert" style="position: fixed; top: 60px; right: 20px; z-index: 10000; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    <div class="d-flex align-items-center">
        <div id="savingStatusIcon" class="me-2">
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <div id="savingStatusText">
            ä¿å­˜ä¸­...
        </div>
    </div>
</div>

<!-- æ–°ã—ã„1ãƒ–ãƒ­ãƒƒã‚¯ç›®: æ¡ˆä»¶ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ¨ªé•·ã€100pxé«˜ã•ï¼‰ -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card shadow-sm" style="min-height: 100px;">
            <div class="card-body p-2 d-flex align-items-center justify-content-between">
                <!-- å·¦å´: æ¡ˆä»¶åã¨ç®¡ç†ç•ªå· -->
                <div class="flex-grow-1 overflow-hidden" style="min-width: 0;">
                    <div class="d-flex align-items-center mb-1">
                        <h5 class="mb-0 me-2 text-truncate" style="font-size: 1rem; max-width: 60%;"><i class="fas fa-building me-1" style="font-size: 0.9rem;"></i>{{ project.site_name }}</h5>
                        <span class="badge project-status-badge {% if project.project_status == 'å—æ³¨ç¢ºå®š' %}bg-success{% elif project.project_status == 'A' %}bg-danger{% elif project.project_status == 'B' %}bg-warning text-dark{% elif project.project_status == 'NG' %}bg-secondary{% else %}text-dark{% endif %}"
                              style="{% if project.project_status == 'ãƒã‚¿' %}background-color: #e9d5ff;{% endif %} cursor: help; font-size: 0.7rem;"
                              title="{% if project.project_status == 'å—æ³¨ç¢ºå®š' %}æ­£å¼ã«å¥‘ç´„ãŒæ±ºå®šã—ãŸæ¡ˆä»¶ã€‚æ–½å·¥æº–å‚™ãƒ»å®Ÿæ–½æ®µéš{% elif project.project_status == 'A' %}å—æ³¨ç¢ºåº¦ã€é«˜ã€‘è¦‹ç©æå‡ºæ¸ˆã¿ã§ã€å¥‘ç´„ã®æ„å‘ãŒå¼·ãç¢ºèªã§ãã¦ã„ã‚‹æ¡ˆä»¶{% elif project.project_status == 'B' %}å—æ³¨ç¢ºåº¦ã€ä¸­ã€‘è¦‹ç©æå‡ºæ¸ˆã¿ã ãŒã€ä»–ç¤¾ã¨ã®ç«¶åˆã‚„ä¸ç¢ºå®šè¦ç´ ãŒã‚ã‚‹æ¡ˆä»¶{% elif project.project_status == 'NG' %}å¤±æ³¨ã¾ãŸã¯å–ã‚Šä¸‹ã’ãŸæ¡ˆä»¶ã€‚ä»–ç¤¾å—æ³¨ã‚„äºˆç®—ä¸æˆç«‹ãªã©{% else %}åˆæœŸæ®µéšã®è¦‹è¾¼ã¿æ¡ˆä»¶ã€‚å…ƒè«‹ã‹ã‚‰ã®å•ã„åˆã‚ã›ã‚„å¼•ãåˆã„ãŒã‚ã£ãŸæ®µéš{% endif %}">
                            {{ project.get_project_status_display }}
                        </span>
                    </div>
                    <div class="d-flex flex-wrap align-items-center gap-2" style="font-size: 0.7rem;">
                        <span class="text-muted"><strong>No:</strong> {{ project.management_no }}</span>
                        <span class="text-muted">|</span>
                        <span class="text-truncate" style="max-width: 150px;"><strong>å…ƒè«‹:</strong>
                            {% if project.client_company %}
                                {{ project.client_company.company_name }}
                            {% elif project.client_name %}
                                {{ project.client_name }}
                            {% else %}
                                -
                            {% endif %}
                        </span>
                        <span class="text-muted">|</span>
                        <span><strong>å·¥äº‹:</strong> <span class="badge bg-secondary" style="font-size: 0.65rem;">{{ project.work_type }}</span></span>
                        <span class="text-muted">|</span>
                        <span class="text-muted" style="opacity: 0.7;">å£²ä¸Š</span>
                        <span class="text-success fw-bold">Â¥{{ financial_info.revenue|floatformat:0|intcomma }}</span>
                        <span class="text-muted mx-1">|</span>
                        <span class="text-muted" style="opacity: 0.7;">åŸä¾¡</span>
                        <span class="text-warning">Â¥{{ financial_info.cost_of_sales|floatformat:0|intcomma }}</span>
                        <span class="text-muted mx-1">|</span>
                        <span class="text-muted" style="opacity: 0.7;">åˆ©ç›Š</span>
                        <span class="text-primary fw-bold">Â¥{{ financial_info.gross_profit|floatformat:0|intcomma }}</span>
                        <small class="text-info">({{ financial_info.gross_profit_rate|floatformat:1 }}%)</small>
                        <span class="text-muted mx-1">|</span>
                        {% with stage=project.get_current_project_stage %}
                        <span><strong>é€²æ—:</strong> <span class="badge bg-{{ stage.color }}" style="font-size: 0.65rem;">{{ stage.stage }}</span></span>
                        {% endwith %}
                        <span class="text-muted">|</span>
                        <span><strong>é–‹å§‹:</strong> {{ project.work_start_date|date:"Y/m/d"|default:"-" }}</span>
                        <span class="text-muted">|</span>
                        <span><strong>çµ‚äº†:</strong> {{ project.work_end_date|date:"Y/m/d"|default:"-" }}</span>
                    </div>
                </div>
                <!-- å³å´: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
                <div class="d-flex gap-1 ms-2 flex-shrink-0">
                    <a href="{% url 'order_management:project_update' project.pk %}" class="btn btn-warning btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{% url 'subcontract_management:project_subcontract_list' project.pk %}" class="btn btn-success btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="ç™ºæ³¨ç®¡ç†">
                        <i class="fas fa-file-contract"></i>
                    </a>
                    <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#deleteModal" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="å‰Šé™¤">
                        <i class="fas fa-trash"></i>
                    </button>
                    <a href="{% url 'order_management:project_list' %}" class="btn btn-secondary btn-sm" style="font-size: 0.7rem; padding: 0.25rem 0.4rem;" title="ä¸€è¦§">
                        <i class="fas fa-list"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- è©³ç´°æƒ…å ± (æ”¹å–„ç‰ˆ - ã‚¿ãƒ–UI) -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center py-1" style="cursor: pointer;" onclick="toggleDetailInfo()">
                <div class="d-flex align-items-center">
                    <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;">
                        <i class="fas fa-info-circle me-2"></i>æ¡ˆä»¶è©³ç´°æƒ…å ±
                    </h6>
                    <i class="fas fa-chevron-down ms-2" id="detailInfoToggleIcon" style="font-size: 0.75rem; transition: transform 0.3s ease;"></i>
                </div>
                <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                <div class="btn-group btn-group-sm" role="group" onclick="event.stopPropagation();">
                    <button type="button" class="btn btn-light active" id="tabViewBtn" onclick="switchViewMode('tab')" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-th-large me-1"></i>ã‚¿ãƒ–è¡¨ç¤º
                    </button>
                    <button type="button" class="btn btn-light" id="fullViewBtn" onclick="switchViewMode('full')" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-list me-1"></i>å…¨ä½“è¡¨ç¤º
                    </button>
                </div>
            </div>
            <div class="card-body p-0" id="detailInfoBody" style="display: none;">
                <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <ul class="nav nav-tabs" id="projectDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                            <i class="fas fa-home me-1"></i>æ¦‚è¦
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="business-tab" data-bs-toggle="tab" data-bs-target="#business" type="button" role="tab">
                            <i class="fas fa-briefcase me-1"></i>æ¥­è€…ãƒ»æ‹…å½“
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">
                            <i class="fas fa-calendar-alt me-1"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="finance-tab" data-bs-toggle="tab" data-bs-target="#finance" type="button" role="tab">
                            <i class="fas fa-yen-sign me-1"></i>è«‹æ±‚ãƒ»çµŒè²»
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                            <i class="fas fa-sticky-note me-1"></i>å‚™è€ƒãƒ»ãã®ä»–
                        </button>
                    </li>
                </ul>

                <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                <div class="tab-content p-3" id="projectDetailTabsContent">
                    <!-- æ¦‚è¦ã‚¿ãƒ– -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel" data-section-title="ğŸ“‹ æ¦‚è¦">
                        <div class="row g-3">
                            <!-- åŸºæœ¬æƒ…å ± -->
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-file-alt me-2"></i>åŸºæœ¬æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4 text-muted">ç®¡ç†No</dt>
                                        <dd class="col-sm-8 fw-bold">{{ project.management_no }}</dd>

                                        <dt class="col-sm-4 text-muted">ç¾å ´å</dt>
                                        <dd class="col-sm-8 editable-field" data-field="site_name" data-type="text">
                                            <span class="field-value">{{ project.site_name }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>

                                        <dt class="col-sm-4 text-muted">å·¥äº‹ç¨®åˆ¥</dt>
                                        <dd class="col-sm-8 editable-field" data-field="work_type" data-type="work_type">
                                            <span class="field-value"><span class="badge bg-secondary">{{ project.work_type }}</span></span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>

                                        <dt class="col-sm-4 text-muted">ç¾å ´ä½æ‰€</dt>
                                        <dd class="col-sm-8 editable-field" data-field="site_address" data-type="text">
                                            <span class="field-value">{{ project.site_address|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                    </dl>
                                </div>
                            </div>

                            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»é‡‘é¡ -->
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-success border-bottom pb-2 mb-3">
                                        <i class="fas fa-chart-line me-2"></i>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»é‡‘é¡
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">æ¡ˆä»¶é€²æ—</dt>
                                        <dd class="col-sm-7">
                                            {% with stage=project.get_current_project_stage %}
                                            <span class="badge bg-{{ stage.color }}" style="font-size: 0.65rem;">{{ stage.stage }}</span>
                                            {% endwith %}
                                        </dd>
                                        <dt class="col-sm-5 text-muted">å—æ³¨ãƒ¨ãƒŸ</dt>
                                        <dd class="col-sm-7">
                                            <select class="form-select form-select-sm order-forecast-select-detail"
                                                    data-project-id="{{ project.pk }}"
                                                    style="width: auto; display: inline-block; max-width: 150px; font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                                                {% for value, label in project.PROJECT_STATUS_CHOICES %}
                                                <option value="{{ value }}" {% if value == project.project_status %}selected{% endif %}>
                                                    {{ label }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </dd>
                                        <dt class="col-sm-5 text-muted">å—æ³¨é‡‘é¡</dt>
                                        <dd class="col-sm-7 text-primary fw-bold editable-field" data-field="order_amount" data-type="number">
                                            <span class="field-value">Â¥{{ project.order_amount|floatformat:0|intcomma }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>

                                        <dt class="col-sm-5 text-muted">å®Ÿè«‹æ±‚é¡</dt>
                                        <dd class="col-sm-7 text-success fw-bold editable-field" data-field="billing_amount" data-type="number">
                                            <span class="field-value">Â¥{{ project.billing_amount|floatformat:0|intcomma }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                    </dl>
                                </div>
                            </div>

                            <!-- ãã®ä»–æƒ…å ± -->
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-info border-bottom pb-2 mb-3">
                                        <i class="fas fa-clipboard-list me-2"></i>ãã®ä»–è©³ç´°
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-6 text-muted">è¦‹ç©æ›¸ç™ºè¡Œæ—¥</dt>
                                                <dd class="col-sm-6 editable-field" data-field="estimate_issued_date" data-type="date">
                                                    <span class="field-value">{{ project.estimate_issued_date|date:"Y/m/d"|default:"-" }}</span>
                                                    <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                                </dd>
                                            </dl>
                                        </div>
                                        <div class="col-md-4">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-6 text-muted">é§è»Šå ´ä»£</dt>
                                                <dd class="col-sm-6 editable-field" data-field="parking_fee" data-type="number">
                                                    <span class="field-value">Â¥{{ project.parking_fee|floatformat:0|intcomma }}</span>
                                                    <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                                </dd>
                                            </dl>
                                        </div>
                                        <div class="col-md-4">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-6 text-muted">å¢—æ¸›é¡</dt>
                                                <dd class="col-sm-6 {% if project.amount_difference > 0 %}text-success{% elif project.amount_difference < 0 %}text-danger{% endif %} fw-bold">
                                                    Â¥{{ project.amount_difference|floatformat:0|intcomma }}
                                                </dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="business" role="tabpanel" data-section-title="ğŸ¢ æ¥­è€…ãƒ»æ‹…å½“">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-building me-2"></i>å…ƒè«‹æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4 text-muted">å…ƒè«‹å</dt>
                                        <dd class="col-sm-8 fw-bold editable-field" data-field="client_company" data-type="select" data-client-company-id="{{ project.client_company_id|default:'' }}">
                                            <span class="field-value">{{ project.client_name|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                        <dt class="col-sm-4 text-muted">å…ƒè«‹ä½æ‰€</dt>
                                        <dd class="col-sm-8" id="client-address-display">
                                            <span class="field-value">{{ project.client_address|default:"-" }}</span>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-success border-bottom pb-2 mb-3">
                                        <i class="fas fa-user-tie me-2"></i>æ‹…å½“è€…æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4 text-muted">æ¡ˆä»¶æ‹…å½“</dt>
                                        <dd class="col-sm-8 fw-bold editable-field" data-field="project_manager" data-type="text">
                                            <span class="field-value">{{ project.project_manager|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="schedule" role="tabpanel" data-section-title="ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-calendar-check me-2"></i>å¥‘ç´„ãƒ»å·¥äº‹æ—¥ç¨‹
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">å¥‘ç´„æ—¥</dt>
                                        <dd class="col-sm-7 editable-field" data-field="contract_date" data-type="date">
                                            <span class="field-value">{{ project.contract_date|date:"Y/n/j"|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                        <dt class="col-sm-5 text-muted">å·¥äº‹é–‹å§‹æ—¥</dt>
                                        <dd class="col-sm-7 editable-field" data-field="work_start_date" data-type="date">
                                            <span class="field-value">{{ project.work_start_date|date:"Y/n/j"|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                        <dt class="col-sm-5 text-muted">å·¥äº‹çµ‚äº†æ—¥</dt>
                                        <dd class="col-sm-7 editable-field" data-field="work_end_date" data-type="date">
                                            <span class="field-value">{{ project.work_end_date|date:"Y/n/j"|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-success border-bottom pb-2 mb-3">
                                        <i class="fas fa-money-bill-wave me-2"></i>å…¥é‡‘äºˆå®š
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">å…¥é‡‘äºˆå®šæ—¥</dt>
                                        <dd class="col-sm-7 fw-bold editable-field" data-field="payment_due_date" data-type="date">
                                            <span class="field-value">{{ project.payment_due_date|date:"Y/n/j"|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>

                        <!-- å®Œäº†å ±å‘Šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="row g-3 mt-3">
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-info border-bottom pb-2 mb-3">
                                        <i class="fas fa-clipboard-check me-2"></i>å®Œäº†å ±å‘Š
                                    </h6>
                                    <div class="alert alert-info small mb-3">
                                        <i class="fas fa-info-circle me-1"></i>
                                        å…ƒè«‹ä¼šç¤¾ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¦ã„ã¾ã™ã€‚å†…å®¹ã‚’ç·¨é›†ã—ã¦å®Œäº†å ±å‘Šã‚’ä½œæˆã§ãã¾ã™ã€‚
                                    </div>

                                    <!-- è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ -->
                                    <dl class="row view-mode-only">
                                        <dt class="col-sm-3 text-muted">å®Œäº†å ±å‘Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</dt>
                                        <dd class="col-sm-9">
                                            {% if project.completion_report_completed %}
                                            <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>å®Œäº†</span>
                                            {% else %}
                                            <span class="badge bg-secondary">æœªå®Œäº†</span>
                                            {% endif %}
                                        </dd>
                                        <dt class="col-sm-3 text-muted">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</dt>
                                        <dd class="col-sm-9">
                                            {% if project.client_company and project.client_company.completion_report_template %}
                                            <a href="{{ project.client_company.completion_report_template.url }}" class="btn btn-sm btn-outline-primary" download>
                                                <i class="fas fa-download me-1"></i>å…ƒè«‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                            </a>
                                            {% else %}
                                            <span class="text-muted">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãªã—</span>
                                            {% endif %}
                                        </dd>
                                        <dt class="col-sm-3 text-muted">å®Œäº†å ±å‘Šãƒ•ã‚¡ã‚¤ãƒ«</dt>
                                        <dd class="col-sm-9">
                                            {% if project.completion_report_file %}
                                            <a href="{{ project.completion_report_file.url }}" class="btn btn-sm btn-success" download>
                                                <i class="fas fa-file-download me-1"></i>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                            </a>
                                            <small class="text-muted ms-2">{{ project.completion_report_file.name|slice:"19:" }}</small>
                                            {% else %}
                                            <span class="text-muted">æœªã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</span>
                                            {% endif %}
                                        </dd>
                                        <dt class="col-sm-3 text-muted">å®Œäº†å ±å‘Šæ—¥</dt>
                                        <dd class="col-sm-9">{{ project.completion_report_date|date:"Yå¹´mæœˆdæ—¥"|default:"-" }}</dd>
                                        <dt class="col-sm-3 text-muted">å®Œäº†å ±å‘Šå†…å®¹</dt>
                                        <dd class="col-sm-9">
                                            <div style="white-space: pre-wrap;">{{ project.completion_report_content|default:"æœªä½œæˆ" }}</div>
                                        </dd>
                                        {% if project.completion_report_notes %}
                                        <dt class="col-sm-3 text-muted">ãƒ¡ãƒ¢</dt>
                                        <dd class="col-sm-9">
                                            <div style="white-space: pre-wrap;">{{ project.completion_report_notes }}</div>
                                        </dd>
                                        {% endif %}
                                    </dl>

                                    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ -->
                                    <div class="edit-mode-only" style="display: none;">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">å®Œäº†ãƒã‚§ãƒƒã‚¯</label>
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" id="completion_report_completed" name="completion_report_completed" {% if project.completion_report_completed %}checked{% endif %}>
                                                <label class="form-check-label" for="completion_report_completed">
                                                    å®Œäº†å ±å‘Šã‚’å®Œäº†ã—ã¾ã—ãŸ
                                                </label>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">å…ƒè«‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ</label>
                                            <div>
                                                {% if project.client_company and project.client_company.completion_report_template %}
                                                <a href="{{ project.client_company.completion_report_template.url }}" class="btn btn-sm btn-outline-primary" download>
                                                    <i class="fas fa-download me-1"></i>ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                                </a>
                                                <div class="form-text">å…ƒè«‹ä¼šç¤¾ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ä½¿ç”¨ã§ãã¾ã™</div>
                                                {% else %}
                                                <span class="text-muted">ã“ã®å…ƒè«‹ä¼šç¤¾ã«ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
                                                {% endif %}
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">å®Œäº†å ±å‘Šãƒ•ã‚¡ã‚¤ãƒ«</label>
                                            <input type="file" name="completion_report_file" class="form-control" id="completionReportFileInput" accept=".pdf,.doc,.docx,.xls,.xlsx">
                                            <div class="form-text">PDFã€Wordã€Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™</div>
                                            {% if project.completion_report_file %}
                                            <div class="mt-2">
                                                <span class="badge bg-success">
                                                    <i class="fas fa-file me-1"></i>ç¾åœ¨ã®ãƒ•ã‚¡ã‚¤ãƒ«: {{ project.completion_report_file.name|slice:"19:" }}
                                                </span>
                                                <a href="{{ project.completion_report_file.url }}" class="btn btn-sm btn-link" download>
                                                    <i class="fas fa-download me-1"></i>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                                </a>
                                            </div>
                                            {% endif %}
                                        </div>

                                        <div class="mb-3">
                                            <label class="form-label">å®Œäº†å ±å‘Šæ—¥</label>
                                            <input type="date" name="completion_report_date" class="form-control dynamic-field" value="{{ project.completion_report_date|date:'Y-m-d'|default:'' }}">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">å®Œäº†å ±å‘Šå†…å®¹ï¼ˆãƒ†ã‚­ã‚¹ãƒˆï¼‰</label>
                                            <textarea name="completion_report_content" class="form-control dynamic-field" rows="6">{{ project.completion_report_content|default:'' }}</textarea>
                                            <div class="form-text">å…ƒè«‹ä¼šç¤¾ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå†…å®¹ã‹ã‚‰è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ï¼ˆãƒ†ã‚­ã‚¹ãƒˆå½¢å¼ï¼‰</div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">å®Œäº†å ±å‘Šãƒ¡ãƒ¢</label>
                                            <textarea name="completion_report_notes" class="form-control dynamic-field" rows="3">{{ project.completion_report_notes|default:'' }}</textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è«‹æ±‚ãƒ»çµŒè²»ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="finance" role="tabpanel" data-section-title="ğŸ’° è«‹æ±‚ãƒ»çµŒè²»">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-file-invoice me-2"></i>è«‹æ±‚æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-3 text-muted">è«‹æ±‚æ›¸ç™ºè¡Œ</dt>
                                        <dd class="col-sm-3">
                                            {% if project.invoice_issued %}
                                            <span class="badge bg-success">ç™ºè¡Œæ¸ˆã¿</span>
                                            {% else %}
                                            <span class="badge bg-secondary">æœªç™ºè¡Œ</span>
                                            {% endif %}
                                        </dd>
                                        <dt class="col-sm-3 text-muted">å®Ÿè«‹æ±‚é¡</dt>
                                        <dd class="col-sm-3 text-success fw-bold">Â¥{{ project.billing_amount|floatformat:0|intcomma }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-warning border-bottom pb-2 mb-3">
                                        <i class="fas fa-receipt me-2"></i>è«¸çµŒè²»â‘ 
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">é …ç›®å</dt>
                                        <dd class="col-sm-7 editable-field" data-field="expense_item_1" data-type="text">
                                            <span class="field-value">{{ project.expense_item_1|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                        <dt class="col-sm-5 text-muted">é‡‘é¡</dt>
                                        <dd class="col-sm-7 fw-bold editable-field" data-field="expense_amount_1" data-type="number">
                                            <span class="field-value">Â¥{{ project.expense_amount_1|floatformat:0|intcomma }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                    </dl>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-warning border-bottom pb-2 mb-3">
                                        <i class="fas fa-receipt me-2"></i>è«¸çµŒè²»â‘¡
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">é …ç›®å</dt>
                                        <dd class="col-sm-7 editable-field" data-field="expense_item_2" data-type="text">
                                            <span class="field-value">{{ project.expense_item_2|default:"-" }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                        <dt class="col-sm-5 text-muted">é‡‘é¡</dt>
                                        <dd class="col-sm-7 fw-bold editable-field" data-field="expense_amount_2" data-type="number">
                                            <span class="field-value">Â¥{{ project.expense_amount_2|floatformat:0|intcomma }}</span>
                                            <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer;" onclick="enableEdit(this)"></i>
                                        </dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å‚™è€ƒãƒ»ãã®ä»–ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="notes" role="tabpanel" data-section-title="ğŸ“ å‚™è€ƒãƒ»ãã®ä»–">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-comment-alt me-2"></i>å‚™è€ƒ
                                    </h6>
                                    <div class="editable-field" data-field="notes" data-type="textarea">
                                        <div class="field-value">
                                            {% if project.notes %}
                                                <div class="p-3 bg-light rounded">{{ project.notes|linebreaks }}</div>
                                            {% else %}
                                                <p class="text-muted fst-italic">å‚™è€ƒã¯ã‚ã‚Šã¾ã›ã‚“</p>
                                            {% endif %}
                                        </div>
                                        <i class="fas fa-pencil-alt ms-2 edit-icon" style="font-size: 0.65rem; color: #6c757d; cursor: pointer; position: absolute; right: 1rem; top: 0.5rem;" onclick="enableEdit(this)"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-secondary border-bottom pb-2 mb-3">
                                        <i class="fas fa-database me-2"></i>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-2 text-muted">ä½œæˆæ—¥æ™‚</dt>
                                        <dd class="col-sm-4">{{ project.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</dd>
                                        <dt class="col-sm-2 text-muted">æ›´æ–°æ—¥æ™‚</dt>
                                        <dd class="col-sm-4">{{ project.updated_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 1ã‚«ãƒ©ãƒ : ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç† & ã‚³ãƒ¡ãƒ³ãƒˆ -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card shadow-sm">
            <div class="card-header bg-gradient-primary text-white py-1">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;"><i class="fas fa-cog"></i> ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†</h6>
                    <button type="button" class="btn btn-sm btn-light" id="toggleAllSteps" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-compress-alt"></i> <span id="toggleButtonText">å…¨éƒ¨é–‰ã˜ã‚‹</span>
                    </button>
                </div>
            </div>
            <div class="card-body p-2" style="overflow-y: auto; overflow-x: visible;">
                <form method="post" action="{% url 'order_management:update_progress' project.pk %}">
                    {% csrf_token %}

                    <!-- å…¨ä½“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ -->
                    <div class="mb-3">
                        {% if project.project_status == 'ng' %}
                        <!-- NGæ¡ˆä»¶ã®å ´åˆã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã‚’è¡¨ç¤º -->
                        <div class="d-flex justify-content-center align-items-center" style="padding: 2rem 1rem;">
                            <div class="text-center">
                                <i class="fas fa-ban text-danger" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                                <h5 class="text-danger mb-0">ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆ</h5>
                                <small class="text-muted d-block mt-2" style="font-size: 0.75rem;">ã“ã®æ¡ˆä»¶ã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ</small>
                            </div>
                        </div>
                        {% else %}
                        <!-- é€šå¸¸ã®é€²æ—è¡¨ç¤º -->
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <small class="text-muted" style="font-size: 0.7rem;">
                                <i class="fas fa-chart-line me-1"></i>é€²æ—
                                <span id="overallPhase" class="badge bg-secondary" style="font-size: 0.6rem; margin-left: 0.3rem;">æœªé–‹å§‹</span>
                                <span id="overallStepCount" style="font-size: 0.65rem; margin-left: 0.3rem;">0/0</span>
                            </small>
                        </div>

                        <div class="progress progress-enhanced" style="height: 15px;">
                            <div class="progress-bar bg-warning" id="overallProgressBar" style="width: 0%">
                                <span id="overallProgressText">0/0</span>
                            </div>
                        </div>

                        <!-- Next Action -->
                        <div class="mt-1">
                            <small class="text-muted d-block" style="font-size: 0.65rem; line-height: 1.2;">
                                <i class="fas fa-arrow-right me-1" style="font-size: 0.6rem;"></i><strong>Next Action:</strong><br><span id="overallNextAction">-</span>
                            </small>
                        </div>
                        {% endif %}
                    </div>

                    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšï¼ˆå…¨ã¦å±•é–‹ï¼‰ -->
                    <div class="mb-1">
                        <label class="form-label fw-bold mb-1" style="font-size: 0.8rem; line-height: 1.2;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéš</label>
                        <div class="vertical-progress" id="activeSteps" style="font-size: 0.75rem;">
                            <!-- å‹•çš„ã«ã‚¹ãƒ†ãƒƒãƒ—ãŒæ§‹ç¯‰ã•ã‚Œã‚‹ -->
                        </div>

                        <!-- åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰ -->
                        <div id="stepInventory" class="mt-3">
                            <hr>
                            <h6 style="font-size: 0.8rem;"><i class="fas fa-box"></i> åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—</h6>
                            <div class="row" id="availableSteps">
                                <!-- åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ã“ã“ã«å‹•çš„ã«è¡¨ç¤º -->
                            </div>
                        </div>

                        <!-- ã‚¹ãƒ†ãƒƒãƒ—é †åºã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                        <input type="hidden" name="step_order" id="stepOrderInput" value="">
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm" style="font-size: 0.75rem; padding: 0.3rem 0.6rem;">
                        <i class="fas fa-save"></i> é€²æ—æ›´æ–°
                    </button>
                </form>
            </div>
        </div>
    </div>
    <!-- å³å´: æ¡ˆä»¶ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒ£ãƒƒãƒˆ -->
    <div class="col-md-4">
        <div class="card shadow-sm" style="height: 100%;">
            <div class="card-header bg-primary text-white py-1">
                <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;">
                    <i class="fas fa-comments me-2"></i>æ¡ˆä»¶ã‚³ãƒ¡ãƒ³ãƒˆ
                </h6>
            </div>
            <div class="card-body p-2">
                <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
                <div id="comments-container" class="mb-3">
                    <!-- ã‚³ãƒ¡ãƒ³ãƒˆã¯JavaScriptã§å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-spinner fa-spin fa-2x"></i>
                        <p class="mt-2" style="font-size: 0.75rem;">ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                    </div>
                </div>

                <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
                <div class="comment-form">
                    <form id="comment-form" onsubmit="return false;">
                        <div class="mb-2">
                            <textarea
                                id="comment-content"
                                class="form-control form-control-sm"
                                rows="3"
                                placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›..."
                                required
                                style="font-size: 0.75rem;"
                            ></textarea>
                        </div>

                        <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <div class="mb-2">
                            <label class="form-label" style="font-size: 0.75rem;">
                                <i class="fas fa-paperclip me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«æ·»ä»˜
                            </label>
                            <input
                                type="file"
                                class="form-control form-control-sm"
                                id="comment-files"
                                multiple
                                accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                                style="font-size: 0.7rem;"
                            >
                            <small class="form-text text-muted" style="font-size: 0.65rem;">
                                æœ€å¤§10MB/ãƒ•ã‚¡ã‚¤ãƒ«
                            </small>
                            <!-- é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                            <div id="file-preview" class="mt-1"></div>
                        </div>

                        <div class="form-check mb-2">
                            <input
                                type="checkbox"
                                class="form-check-input"
                                id="comment-important"
                            >
                            <label class="form-check-label" for="comment-important" style="font-size: 0.75rem;">
                                <i class="fas fa-exclamation-triangle text-warning"></i> é‡è¦
                            </label>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm w-100" onclick="postComment()" style="font-size: 0.75rem;">
                            <i class="fas fa-paper-plane me-1"></i>æŠ•ç¨¿
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 2ã‚«ãƒ©ãƒ : çµŒç†æƒ…å ± & ä¸‹è«‹ã‘æ‰‹é…çŠ¶æ³ -->
<div class="row mb-4">
    <!-- å·¦: çµŒç†æƒ…å ± -->
    <div class="col-md-6">
        <div class="card border-info shadow-sm" style="height: 100%;">
            <div class="card-header bg-info text-white py-1">
                <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;"><i class="fas fa-calculator"></i> çµŒç†æƒ…å ±</h6>
            </div>
            <div class="card-body p-2">
                <!-- è¦–è¦šçš„åˆ©ç›Šåˆ†æãƒãƒ£ãƒ¼ãƒˆï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰ -->
                <div class="text-center mb-2 p-2 bg-light rounded">
                    <div class="d-flex align-items-end justify-content-center" style="height: 120px;">
                        <!-- å£²ä¸Šãƒãƒ¼ -->
                        <div class="text-center">
                            <div style="width: 50px; height: 110px; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 8px; background: linear-gradient(135deg, #198754, #20c997); color: white; margin-right: 2px;">
                                <div style="font-size: 0.6rem; font-weight: bold;">å£²ä¸Š</div>
                                <div style="font-size: 0.55rem; line-height: 1.1; margin-top: 2px;">Â¥{{ financial_info.revenue|floatformat:0|intcomma }}</div>
                            </div>
                        </div>

                        <!-- å£²ä¸Šç·åˆ©ç›Šãƒãƒ¼ -->
                        {% widthratio financial_info.gross_profit financial_info.revenue 100 as profit_percentage %}
                        {% widthratio financial_info.cost_of_sales financial_info.revenue 100 as cost_percentage %}
                        <div class="text-center">
                            <div style="width: 50px; height: 110px; position: relative; margin-left: 2px; border-radius: 6px; overflow: hidden; display: flex; flex-direction: column;">
                                <!-- å£²ä¸ŠåŸä¾¡éƒ¨åˆ†ï¼ˆä¸Šéƒ¨ï¼‰ -->
                                <div style="width: 100%; height: {{ cost_percentage }}%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 4px; background: linear-gradient(135deg, #dc3545, #fd7e14); color: white; border-radius: 6px 6px 0 0;">
                                    <div style="font-size: 0.55rem; font-weight: bold;">åŸä¾¡</div>
                                    <div style="font-size: 0.5rem; line-height: 1.1;">Â¥{{ financial_info.cost_of_sales|floatformat:0|intcomma }}</div>
                                </div>
                                <!-- ç²—åˆ©éƒ¨åˆ†ï¼ˆä¸‹éƒ¨ï¼‰ -->
                                <div style="width: 100%; height: {{ profit_percentage }}%; background: linear-gradient(135deg, #0d6efd, #6f42c1); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 4px; color: white; border-radius: 0 0 6px 6px;">
                                    <div style="font-size: 0.55rem; font-weight: bold;">ç²—åˆ©</div>
                                    <div style="font-size: 0.5rem; line-height: 1.1;">Â¥{{ financial_info.gross_profit|floatformat:0|intcomma }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <small class="d-block text-primary fw-bold mt-1" style="font-size: 0.65rem;">ç²—åˆ©ç‡: {{ financial_info.gross_profit_rate|floatformat:1 }}%</small>
                </div>

                <!-- æš«å®šåˆ©ç›Šç‡åˆ†æãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-sm mb-0" style="font-size: 0.7rem;">
                        <tbody>
                            <tr style="background-color: rgba(25, 135, 84, 0.1);">
                                <td><strong>å£²ä¸Šï¼ˆå—æ³¨é¡ï¼‰</strong></td>
                                <td class="text-end"><strong>Â¥{{ financial_info.revenue|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            <tr class="table-secondary">
                                <td colspan="2"><strong>æ”¯å‡ºå†…è¨³</strong></td>
                            </tr>
                            <!-- æ—¢å­˜ä½œæ¥­è²»ç”¨ -->
                            {% if subcontracts %}
                                {% for subcontract in subcontracts %}
                                <tr class="small text-muted">
                                    <td style="padding-left: 15px;">
                                        â”” {% if subcontract.worker_type == 'external' %}
                                            {% if subcontract.contractor %}{{ subcontract.contractor.name }}{% else %}å¤–æ³¨å…ˆæœªè¨­å®š{% endif %}
                                        {% else %}
                                            {% if subcontract.internal_worker %}{{ subcontract.internal_worker.name }}ï¼ˆç¤¾å†…ï¼‰{% elif subcontract.internal_worker_name %}{{ subcontract.internal_worker_name }}ï¼ˆç¤¾å†…ï¼‰{% else %}ç¤¾å†…æ‹…å½“è€…æœªè¨­å®š{% endif %}
                                        {% endif %}
                                    </td>
                                    <td class="text-end">Â¥{{ subcontract.contract_amount|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            <tr class="table-light">
                                <td style="padding-left: 10px;">ææ–™è²»</td>
                                <td class="text-end">Â¥{% widthratio financial_info.material_cost|add:financial_info.material_order_cost 1 1 as total_material %}{{ total_material|floatformat:0|intcomma }}</td>
                            </tr>
                            <!-- è³‡æç™ºæ³¨è²»ç”¨ -->
                            {% if project.material_orders.exists %}
                                {% for material_order in project.material_orders.all %}
                                <tr class="small text-muted">
                                    <td style="padding-left: 15px;">
                                        â”” è³‡æç™ºæ³¨: {% if material_order.contractor %}{{ material_order.contractor.name }}{% else %}æ¥­è€…æœªè¨­å®š{% endif %}
                                    </td>
                                    <td class="text-end">Â¥{{ material_order.total_amount|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            {% endif %}
                            {% if financial_info.additional_cost > 0 %}
                            <tr class="table-light">
                                <td style="padding-left: 10px;">è¿½åŠ è²»ç”¨</td>
                                <td class="text-end">Â¥{{ financial_info.additional_cost|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}
                            <tr style="background-color: rgba(220, 53, 69, 0.1);">
                                <td><strong>ç·æ”¯å‡º</strong></td>
                                <td class="text-end"><strong>Â¥{{ financial_info.cost_of_sales|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            <tr style="background-color: rgba(13, 110, 253, 0.1);">
                                <td><strong>ç²—åˆ©ç›Š</strong></td>
                                <td class="text-end"><strong>Â¥{{ financial_info.gross_profit|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>åˆ©ç›Šç‡</strong></td>
                                <td class="text-end">
                                    <strong class="{% if financial_info.gross_profit_rate >= 30 %}text-success{% elif financial_info.gross_profit_rate >= 15 %}text-warning{% else %}text-danger{% endif %}">{{ financial_info.gross_profit_rate|floatformat:1 }}%</strong>
                                    <div class="progress mt-1" style="height: 6px;">
                                        <div class="progress-bar {% if financial_info.gross_profit_rate >= 30 %}bg-success{% elif financial_info.gross_profit_rate >= 15 %}bg-warning{% else %}bg-danger{% endif %}"
                                             role="progressbar" style="width: {{ financial_info.gross_profit_rate|floatformat:0 }}%;" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- å³: ä¸‹è«‹ã‘æ‰‹é…çŠ¶æ³ & è³‡æç™ºæ³¨çŠ¶æ³ -->
    <div class="col-md-6">
        <!-- ä¸‹è«‹ã‘æ‰‹é…çŠ¶æ³ -->
        <div class="card border-primary shadow-sm mb-2">
            <div class="card-header bg-primary text-white py-1">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;">
                        <i class="fas fa-file-contract"></i> ä¸‹è«‹ã‘æ‰‹é…çŠ¶æ³
                        <span class="badge bg-light text-dark ms-2">{{ subcontracts|length }}ä»¶</span>
                    </h6>
                    <a href="{% url 'subcontract_management:project_subcontract_list' project.pk %}" class="btn btn-sm btn-light" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-file-contract"></i> ç™ºæ³¨ç®¡ç†
                    </a>
                </div>
            </div>
            <div class="card-body p-2">
                {% if subcontracts %}
                    <!-- ç™»éŒ²æ¸ˆã¿ç™ºæ³¨å…ˆãƒªã‚¹ãƒˆï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰ -->
                    <div>
                        {% for subcontract in subcontracts %}
                        <div class="mb-2 p-2 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.75rem; font-weight: bold;">
                                        {{ subcontract.contractor.name }}
                                        <span class="badge bg-light text-dark border ms-1" style="font-size: 0.6rem;">{{ subcontract.get_step_display }}</span>
                                    </div>
                                </div>
                                <span class="badge bg-{{ subcontract.get_payment_status_color }}" style="font-size: 0.6rem;">
                                    {{ subcontract.get_payment_status_display }}
                                </span>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <div style="font-size: 0.65rem;">
                                    <span class="text-muted">å¥‘ç´„:</span> Â¥{{ subcontract.contract_amount|floatformat:0|intcomma }}<br>
                                    <span class="text-muted">è«‹æ±‚:</span> Â¥{{ subcontract.billed_amount|floatformat:0|intcomma }}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-2">
                        <i class="fas fa-file-contract fa-2x text-muted mb-2"></i>
                        <p style="font-size: 0.7rem; color: #6c757d;" class="mb-0">ç™ºæ³¨å…ˆæœªç™»éŒ²</p>
                    </div>
                {% endif %}
                <!-- ä½œæ¥­è€…è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-primary w-100" style="font-size: 0.65rem;" onclick="openSubcontractModal()">
                        <i class="fas fa-user-plus"></i> ä½œæ¥­è€…ã‚’è¿½åŠ 
                    </button>
                </div>
            </div>
        </div>

        <!-- è³‡æç™ºæ³¨çŠ¶æ³ -->
        <div class="card border-warning shadow-sm">
            <div class="card-header bg-warning text-white py-1">
                <div class="d-flex justify-content-between align-items-center">
                    <h6 class="mb-0" style="font-size: 1.1rem; line-height: 1.4;">
                        <i class="fas fa-box-open"></i> è³‡æç™ºæ³¨çŠ¶æ³
                        <span class="badge bg-light text-dark ms-2">{{ project.material_orders.count }}ä»¶</span>
                    </h6>
                    <a href="{% url 'order_management:material_order_list' project.id %}" class="btn btn-sm btn-light" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="fas fa-list"></i> è³‡æç®¡ç†
                    </a>
                </div>
            </div>
            <div class="card-body p-2">
                {% if project.material_orders.exists %}
                    <!-- ç™»éŒ²æ¸ˆã¿è³‡æç™ºæ³¨ãƒªã‚¹ãƒˆï¼ˆã‚³ãƒ³ãƒ‘ã‚¯ãƒˆç‰ˆï¼‰ -->
                    <div>
                        {% for material_order in project.material_orders.all %}
                        <div class="mb-2 p-2 border-bottom">
                            <div class="d-flex justify-content-between align-items-start">
                                <div style="flex: 1;">
                                    <div style="font-size: 0.75rem; font-weight: bold;">
                                        {% if material_order.contractor %}
                                            {{ material_order.contractor.name }}
                                        {% else %}
                                            ç™ºæ³¨å…ˆæœªè¨­å®š
                                        {% endif %}
                                    </div>
                                    {% if material_order.items.exists %}
                                    <div style="font-size: 0.65rem; color: #6c757d;">
                                        {{ material_order.items.first.material_name|truncatechars:25 }}
                                        {% if material_order.items.count > 1 %}
                                            ä»–{{ material_order.items.count|add:"-1" }}ä»¶
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-1">
                                <div style="font-size: 0.65rem;">
                                    <span class="text-muted">é‡‘é¡:</span> Â¥{{ material_order.total_amount|floatformat:0|intcomma }}<br>
                                    <span class="text-muted">ç™ºæ³¨æ—¥:</span> {{ material_order.order_date|date:"Y/m/d" }}
                                </div>
                                <span class="badge
                                    {% if material_order.status == 'completed' %}bg-success
                                    {% elif material_order.status == 'delivered' %}bg-info
                                    {% elif material_order.status == 'ordered' %}bg-warning
                                    {% else %}bg-secondary
                                    {% endif %}"
                                    style="font-size: 0.6rem;">
                                    {{ material_order.get_status_display }}
                                </span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-2">
                        <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                        <p style="font-size: 0.7rem; color: #6c757d;" class="mb-0">è³‡æç™ºæ³¨æœªç™»éŒ²</p>
                    </div>
                {% endif %}
                <!-- è³‡æç™ºæ³¨ã‚’è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-warning w-100" style="font-size: 0.65rem;" onclick="openMaterialOrderModal()">
                        <i class="fas fa-plus"></i> è³‡æç™ºæ³¨ã‚’è¿½åŠ 
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç¾åœ°èª¿æŸ» -->
<div class="row mb-4" id="surveyContentArea">
    <div class="col-lg-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>ç¾åœ°èª¿æŸ»
                        {% if surveys %}
                            <span class="badge bg-white text-primary ms-2">{{ surveys|length }}ä»¶</span>
                        {% endif %}
                    </h5>
                    <div class="btn-group">
                        {% comment %}
                        <a href="#" class="btn btn-sm btn-light">
                            <i class="fas fa-list"></i> èª¿æŸ»ä¸€è¦§
                        </a>
                        <a href="#" class="btn btn-sm btn-light">
                            <i class="fas fa-plus"></i> èª¿æŸ»è¿½åŠ 
                        </a>
                        {% endcomment %}
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if surveys %}
                    <!-- æœ€æ–°ã®èª¿æŸ»æƒ…å ± -->
                    {% with latest_survey=surveys.first %}
                    {% if latest_survey %}
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="alert {% if latest_survey.status == 'completed' %}alert-success{% elif latest_survey.status == 'in_progress' %}alert-warning{% else %}alert-info{% endif %} mb-0">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-1">
                                            {% if latest_survey.status == 'completed' %}
                                                <i class="fas fa-check-circle me-1"></i>æœ€æ–°èª¿æŸ»å®Œäº†
                                            {% elif latest_survey.status == 'in_progress' %}
                                                <i class="fas fa-spinner fa-spin me-1"></i>èª¿æŸ»å®Ÿæ–½ä¸­
                                            {% else %}
                                                <i class="fas fa-calendar-alt me-1"></i>æ¬¡å›èª¿æŸ»äºˆå®š
                                            {% endif %}
                                        </h6>
                                        <div class="small">
                                            <strong>æ—¥æ™‚:</strong> {{ latest_survey.scheduled_date|date:"Yå¹´mæœˆdæ—¥" }} {{ latest_survey.scheduled_start_time|time:"H:i" }}<br>
                                            <strong>æ‹…å½“:</strong> {{ latest_survey.surveyor.name }} ({{ latest_survey.surveyor.employee_id }})
                                            {% if latest_survey.status == 'completed' and latest_survey.rooms.count > 0 %}
                                            <br><strong>èª¿æŸ»çµæœ:</strong> {{ latest_survey.rooms.count }}éƒ¨å±‹ / {{ latest_survey.damages.count }}ä»¶ã®æå‚·è¨˜éŒ² / {{ latest_survey.photos.count }}æšã®å†™çœŸ
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% if latest_survey.status == 'completed' %}
{#                                             <a href="#" class="btn btn-sm btn-success">
                                                <i class="fas fa-file-pdf"></i> ãƒ¬ãƒãƒ¼ãƒˆ
                                            </a>
                                        {% elif latest_survey.status == 'in_progress' %}
{#                                             <a href="#" class="btn btn-sm btn-warning">
                                                <i class="fas fa-play"></i> ç¶šã‘ã‚‹
                                            </a>
                                        {% else %}
{#                                             <a href="#" class="btn btn-sm btn-primary">
                                                <i class="fas fa-play"></i> é–‹å§‹
                                            </a>
                                        {% endif %}
{#                                         <a href="#" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-eye"></i> è©³ç´°
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}

                    <!-- èª¿æŸ»å±¥æ­´ -->
                    {% if surveys|length > 1 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th width="20%">å®Ÿæ–½æ—¥</th>
                                    <th width="20%">æ‹…å½“è€…</th>
                                    <th width="15%">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th width="25%">èª¿æŸ»å†…å®¹</th>
                                    <th width="20%" class="text-end">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for survey in surveys %}
                                <tr>
                                    <td>{{ survey.scheduled_date|date:"m/d" }} {{ survey.scheduled_start_time|time:"H:i" }}</td>
                                    <td>{{ survey.surveyor.name }} ({{ survey.surveyor.employee_id }})</td>
                                    <td>
                                        <span class="badge {% if survey.status == 'completed' %}bg-success{% elif survey.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ survey.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if survey.status == 'completed' %}
                                            <small>{{ survey.rooms.count }}éƒ¨å±‹ / {{ survey.damages.count }}æå‚· / {{ survey.photos.count }}å†™çœŸ</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
{#                                         <a href="#" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if survey.status == 'completed' %}
{#                                             <a href="#" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-file-pdf"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                {% else %}
                    <!-- èª¿æŸ»æœªå®Ÿæ–½ã®å ´åˆ -->
                    <div class="alert alert-warning">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <div class="col-md-8">
                                <h6 class="mb-1">ç¾åœ°èª¿æŸ»ãŒæœªå®Ÿæ–½ã§ã™</h6>
                                <small>ã“ã®æ¡ˆä»¶ã®ç¾åœ°èª¿æŸ»ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚æ­£ç¢ºãªè¦‹ç©ã‚‚ã‚Šã¨æ–½å·¥è¨ˆç”»ã®ãŸã‚ã«å¿…è¦ã§ã™ã€‚</small>
                            </div>
                            <div class="col-md-3 text-end">
                                {% comment %}
                                <a href="#" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>èª¿æŸ»ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                                </a>
                                {% endcomment %}
                            </div>
                        </div>
                    </div>
                {% endif %}

                <!-- ç¾èª¿æ‹…å½“è€…ã®è¡¨ç¤º -->
                {% if project.survey_assignees %}
                <div class="mt-3 p-2 bg-light rounded">
                    <small class="text-muted d-block mb-1"><i class="fas fa-users me-1"></i>ç¾èª¿æ‹…å½“è€…:</small>
                    {% for assignee in project.survey_assignees %}
                    <span class="badge bg-primary me-1">{{ assignee }}</span>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- ä½œæ¥­è€…è¿½åŠ ãƒœã‚¿ãƒ³ -->
                <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-info w-100" onclick="openSubcontractModal('survey')">
                        <i class="fas fa-user-plus"></i> ä½œæ¥­è€…ã‚’è¿½åŠ ï¼ˆç¾èª¿ï¼‰
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>





<style>
/* è©³ç´°æƒ…å ±ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#projectDetailTabs .nav-link {
    color: #6c757d;
    font-weight: 500;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    transition: all 0.15s ease;
}

/* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®åˆ‡ã‚Šæ›¿ãˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é«˜é€ŸåŒ– */
.tab-content > .tab-pane {
    transition: opacity 0.1s ease-in-out;
}

.tab-content > .tab-pane:not(.active) {
    opacity: 0;
}

.tab-content > .tab-pane.active {
    opacity: 1;
}

#projectDetailTabs .nav-link:hover {
    color: #0d6efd;
    background: #f8f9fa;
    border-bottom-color: #dee2e6;
}

#projectDetailTabs .nav-link.active {
    color: #0d6efd;
    background: white;
    border-bottom-color: #0d6efd;
    font-weight: 600;
}

.info-group {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 0.5rem;
    height: 100%;
    position: relative;
}

.info-group h6 {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.75rem;
}

.info-group dl {
    margin-bottom: 0;
}

.info-group dt {
    font-size: 0.7rem;
    padding: 0.25rem 0 0.25rem 0.5rem;
}

.info-group dd {
    font-size: 0.7rem;
    padding: 0.25rem 0;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-group .btn-light.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.btn-group .btn-light {
    transition: all 0.3s ease;
}

.btn-group .btn-light:hover:not(.active) {
    background-color: #e9ecef;
}

/* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#projectDetailTabsContent .tab-pane {
    transition: all 0.3s ease;
}

/* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã‚¿ãƒ–ãƒ‘ãƒãƒ«é–“ã«ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ  */
#projectDetailTabsContent.full-view-mode .tab-pane {
    margin-bottom: 1rem;
    padding: 0.5rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

#projectDetailTabsContent.full-view-mode .tab-pane:last-child {
    margin-bottom: 0;
}

/* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
#projectDetailTabsContent.full-view-mode .tab-pane::before {
    content: attr(data-section-title);
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: #0d6efd;
    margin-bottom: 0.5rem;
    padding-bottom: 0.25rem;
    border-bottom: 2px solid #0d6efd;
}
</style>

<!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ¡ˆä»¶å‰Šé™¤ã®ç¢ºèª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ä»¥ä¸‹ã®æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <p class="text-danger">
                    <strong>{{ project.management_no }} - {{ project.site_name }}</strong>
                </p>
                <p class="text-muted">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
            </div>
            <div class="modal-footer">
                <form method="post" action="{% url 'order_management:project_delete' project.pk %}">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-danger">å‰Šé™¤ã™ã‚‹</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="genericErrorModal" tabindex="-1" aria-labelledby="genericErrorModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title" id="genericErrorModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i><span id="genericErrorModalTitle">ã‚¨ãƒ©ãƒ¼</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="genericErrorModalMessage">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="genericConfirmModal" tabindex="-1" aria-labelledby="genericConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header text-white" id="genericConfirmModalHeader">
                <h5 class="modal-title" id="genericConfirmModalLabel">
                    <i class="me-2" id="genericConfirmModalIcon"></i><span id="genericConfirmModalTitle">ç¢ºèª</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="genericConfirmModalMessage">ã“ã®æ“ä½œã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="genericConfirmModalOkBtn">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="stepDeleteModal" tabindex="-1" aria-labelledby="stepDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="stepDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤ã®ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong id="stepDeleteName"></strong> ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    å‰Šé™¤å¾Œã¯ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-danger" id="confirmStepDelete">
                    <i class="fas fa-trash-alt me-2"></i>å‰Šé™¤ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤å®Œäº†é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="stepDeleteSuccessModal" tabindex="-1" aria-labelledby="stepDeleteSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="stepDeleteSuccessModalLabel">
                    <i class="fas fa-check-circle me-2"></i>å‰Šé™¤å®Œäº†
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0"><strong id="stepDeleteSuccessName"></strong> ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚</p>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>OK
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®åˆæœŸåŒ–
var editMode = true; // å¸¸ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’ON
var sortable = null;
var projectStatus = '{{ project.project_status }}'; // æ¡ˆä»¶ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

// ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
function toggleEditMode() {
    editMode = !editMode;
    const btn = $('#editStepsBtn');

    if (editMode) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON
        btn.html('<i class="fas fa-check"></i> ç·¨é›†å®Œäº†');
        btn.removeClass('btn-outline-primary').addClass('btn-success');
        $('.remove-step-btn').show();
        $('.drag-handle').show();
        $('#stepInventory').show();
        if (typeof loadAvailableSteps === 'function') {
            loadAvailableSteps();
        }
    } else {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰OFF - å¤‰æ›´ã‚’ä¿å­˜

        // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ä¿å­˜
        if (typeof saveStepOrder === 'function') {
            saveStepOrder();
        }

        // ã™ã¹ã¦ã®å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åé›†
        const dynamicFields = {};
        $('.progress-step[data-step]').each(function() {
            const stepKey = $(this).data('step');
            const stepElement = $(this);

            // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
            stepElement.find('input, select, textarea').each(function() {
                const fieldElement = $(this);
                const fieldName = fieldElement.attr('name');

                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!fieldName) return;

                let fieldValue;

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å ´åˆ
                if (fieldElement.is(':checkbox')) {
                    fieldValue = fieldElement.is(':checked') ? 'on' : '';
                } else if (fieldElement.is(':radio')) {
                    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
                    if (!fieldElement.is(':checked')) return;
                    fieldValue = fieldElement.val();
                } else {
                    fieldValue = fieldElement.val();
                }

                // åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆestimate, contract, work_start, work_end, invoiceï¼‰
                const isBasicField = ['estimate_issued_date', 'estimate_not_required', 'estimate_notes',
                                     'contractor_estimate_amount', 'contract_date',
                                     'work_start_date', 'work_start_completed', 'work_end_date',
                                     'work_end_completed', 'invoice_issued'].includes(fieldName);

                // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç©ºã§ã‚‚POSTï¼ˆå‰Šé™¤ãƒ»ã‚¯ãƒªã‚¢æ“ä½œã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
                // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä»¥å¤–ã«è¿½åŠ 
                const finalFieldName = isBasicField ? fieldName :
                                      (fieldName.startsWith('dynamic_field_') ? fieldName : `dynamic_field_${fieldName}`);
                dynamicFields[finalFieldName] = fieldValue;

                // ãƒ‡ãƒãƒƒã‚°: estimateé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ­ã‚°å‡ºåŠ›
                if (fieldName.includes('estimate')) {
                    console.log(`DEBUG: ${fieldName} = "${fieldValue}" (type: ${typeof fieldValue}, is checkbox: ${fieldElement.is(':checkbox')}, checked: ${fieldElement.is(':checked')})`);
                }
            });
        });

        console.log('Saving dynamic fields:', dynamicFields);
        console.log('DEBUG: estimate_not_required in POST?', 'estimate_not_required' in dynamicFields);
        console.log('DEBUG: estimate_not_required value:', dynamicFields.estimate_not_required);

        // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆAJAX - çµ±ä¸€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
            data: $.extend({
                csrfmiddlewaretoken: '{{ csrf_token }}',
                step_order: $('#stepOrderInput').val(),
                ajax_save: 'true'  // AJAXä¿å­˜ãƒ•ãƒ©ã‚°
            }, dynamicFields),
            success: function(response) {
                console.log('ä¿å­˜æˆåŠŸ:', response);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                if (response && response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success(response.message || 'å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                    }
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
                    setTimeout(function() {
                        location.reload();
                    }, 500);  // 500mså¾…ã£ã¦ã‹ã‚‰ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆtoastrè¡¨ç¤ºã®ãŸã‚ï¼‰
                } else {
                    console.error('ä¿å­˜å¤±æ•—:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                let errorMessage = 'ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                } else if (xhr.status === 403) {
                    errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                } else if (xhr.status === 404) {
                    errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (xhr.status >= 500) {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                }
            }
        });

        // UIã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰OFFã«
        btn.html('<i class="fas fa-edit"></i> ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†');
        btn.removeClass('btn-success').addClass('btn-outline-primary');
        $('.remove-step-btn').hide();
        $('.drag-handle').hide();
        $('#stepInventory').hide();
    }

    // Sortableã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    if (sortable) {
        sortable.option("disabled", !editMode);
    }
}

// æ±ç”¨ã‚¨ãƒ©ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
function showErrorModal(message, title = 'ã‚¨ãƒ©ãƒ¼') {
    $('#genericErrorModalTitle').text(title);
    $('#genericErrorModalMessage').text(message);
    const modal = new bootstrap.Modal(document.getElementById('genericErrorModal'));
    modal.show();
}

// æ±ç”¨ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–¢æ•°ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
// ä½¿ç”¨ä¾‹: showConfirmModal('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() { /* OKã®å‡¦ç† */ });
function showConfirmModal(message, onConfirm, title = 'ç¢ºèª') {
    $('#genericConfirmModalTitle').text(title);
    $('#genericConfirmModalMessage').text(message);

    // ã‚¿ã‚¤ãƒˆãƒ«ã«ã€Œå‰Šé™¤ã€ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã¯èµ¤ï¼ˆdangerï¼‰ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
    const isDanger = title.includes('å‰Šé™¤');
    const header = $('#genericConfirmModalHeader');
    const icon = $('#genericConfirmModalIcon');
    const okBtn = $('#genericConfirmModalOkBtn');

    if (isDanger) {
        header.removeClass('bg-primary').addClass('bg-danger');
        icon.removeClass('fa-question-circle').addClass('fas fa-exclamation-triangle');
        okBtn.removeClass('btn-primary').addClass('btn btn-danger');
    } else {
        header.removeClass('bg-danger').addClass('bg-primary');
        icon.removeClass('fa-exclamation-triangle').addClass('fas fa-question-circle');
        okBtn.removeClass('btn-danger').addClass('btn btn-primary');
    }

    const modal = new bootstrap.Modal(document.getElementById('genericConfirmModal'));

    // æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤
    okBtn.off('click');

    // æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
    okBtn.on('click', function() {
        modal.hide();
        if (typeof onConfirm === 'function') {
            onConfirm();
        }
    });

    modal.show();
}

$(document).ready(function() {
    // æ¡ˆä»¶è©³ç´°æƒ…å ±ã®çŠ¶æ…‹ã‚’å¾©å…ƒ
    if (localStorage.getItem('detailInfoOpen') === 'true') {
        toggleDetailInfo();
        localStorage.removeItem('detailInfoOpen');
    }

    // ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆå¸¸ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãªã®ã§ä¸è¦ï¼‰
    // $('#editStepsBtn').on('click', function(e) {
    //     e.preventDefault();
    //     e.stopPropagation();
    //     toggleEditMode();
    // });

    // ä¾å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    $(document).on('change', 'input[type="radio"]', function() {
        const fieldName = $(this).attr('name');
        const selectedValue = $(this).val();

        // ã“ã®å¤‰æ›´ã«ã‚ˆã£ã¦å½±éŸ¿ã‚’å—ã‘ã‚‹ä¾å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
        $(`[data-dependency-field="${fieldName}"]`).each(function() {
            const requiredValue = $(this).data('dependency-value');
            if (selectedValue === requiredValue) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // åˆæœŸçŠ¶æ…‹ã§æ–™é‡‘ä½“ç³»ã‚’è¨­å®šï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œï¼‰
    setTimeout(function() {
        console.log('ğŸ”„ Initializing pricing type on page load');
        console.log('ğŸ” All pricing elements exist at start:', {
            hourly: $('#hourlyPricingFields').length,
            project: $('#projectPricingFields').length,
            hourlyCard: $('#hourlyCard').length,
            projectCard: $('#projectCard').length
        });

        // åˆæœŸé¸æŠã•ã‚Œã¦ã„ã‚‹ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
        var selectedWorkerType = $('input[name="worker_type"]:checked').val();
        console.log('ğŸ” Selected worker type:', selectedWorkerType);

        // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æ–™é‡‘ä½“ç³»ã‚’åˆæœŸåŒ–
        if (selectedWorkerType === 'internal') {
            $('#internalWorkerSection').show();
            console.log('ğŸ” Internal section shown');

            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ï¼ˆDOMæ›´æ–°å¾Œï¼‰
            setTimeout(function() {
                initializePricingType();

                var checkedRadio = $('input[name="internal_pricing_type"]:checked');
                console.log('ğŸ” Checked pricing radio found:', checkedRadio.length);
                if (checkedRadio.length > 0) {
                    checkedRadio.trigger('change');
                }
            }, 50);
        }
    }, 100);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ARIAå±æ€§ç®¡ç†
    $('#staffManagementModal, #staffModal').on('show.bs.modal', function() {
        console.log('ğŸ“‹ Modal showing - removing aria-hidden');
        $(this).removeAttr('aria-hidden');
    }).on('hide.bs.modal', function() {
        console.log('ğŸ“‹ Modal hiding - adding aria-hidden');
        $(this).attr('aria-hidden', 'true');
    }).on('shown.bs.modal', function() {
        console.log('ğŸ“‹ Modal shown - ensuring proper focus management');
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æœ€åˆã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½ãªè¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        var firstFocusableElement = $(this).find('input, select, textarea, button').filter(':visible').first();
        if (firstFocusableElement.length) {
            setTimeout(function() {
                firstFocusableElement.focus();
            }, 100);
        }
    });

    // ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—ã®åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="worker_type"]').on('change', function() {
        if ($(this).val() === 'external') {
            $('#externalWorkerSection').show();
            $('#internalWorkerSection').hide();
            $('#submitButtonText').text('ç™ºæ³¨å…ˆè¿½åŠ ');

            // å¤–æ³¨å…ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…é ˆã«
            $('#contractorSelect').attr('required', true);
            $('input[name="client_name"]').attr('required', false);

            // ç¤¾å†…ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éå¿…é ˆã«
            $('input[name="internal_worker_name"]').attr('required', false);
        } else {
            $('#externalWorkerSection').hide();
            $('#internalWorkerSection').show();
            $('#submitButtonText').text('ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹è¿½åŠ ');

            // ç¤¾å†…ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…é ˆã«
            $('input[name="internal_worker_name"]').attr('required', true);

            // æ–™é‡‘ä½“ç³»ã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
            setTimeout(function() {
                console.log('ğŸ”„ Initializing pricing type after internal switch');
                console.log('ğŸ” Internal section visible:', $('#internalWorkerSection').is(':visible'));
                console.log('ğŸ” Pricing elements exist:', $('#hourlyPricingFields').length, $('#projectPricingFields').length);

                initializePricingType();
                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹æ–™é‡‘ä½“ç³»ã‚’å¼·åˆ¶çš„ã«é©ç”¨
                var checkedRadio = $('input[name="internal_pricing_type"]:checked');
                console.log('ğŸ” Checked radio found:', checkedRadio.length);
                if (checkedRadio.length > 0) {
                    checkedRadio.trigger('change');
                }
            }, 200);

            // å¤–æ³¨å…ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éå¿…é ˆã«
            $('#contractorSelect').attr('required', false);
            $('input[name="client_name"]').attr('required', false);
        }
        updateCostBreakdown();
        updateProfitPreview();
    });

    // ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="internal_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existingInternalDiv').show();
            $('#newInternalDiv').hide();
            $('#internalSelect').attr('required', true);
            $('input[name="internal_worker_name"]').attr('required', false);
        } else {
            $('#existingInternalDiv').hide();
            $('#newInternalDiv').show();
            $('#internalSelect').attr('required', false);
            $('input[name="internal_worker_name"]').attr('required', true);
        }
    });

    // æ—¢å­˜ç¤¾å†…æ‹…å½“è€…é¸æŠæ™‚ã®æƒ…å ±è‡ªå‹•å…¥åŠ›
    $('#internalSelect').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var department = selectedOption.data('department') || '';
        var hourlyRate = selectedOption.data('hourly-rate') || '';

        $('#internalDepartment').val(department);
        $('#internalHourlyRate').val(hourlyRate);

        // å·¥æ•°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°è‡ªå‹•è¨ˆç®—
        calculateInternalCost();
    });

    // æ¥­è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="contractor_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existingContractorDiv').show();
            $('#newContractorDiv').hide();
            $('#contractorSelect').attr('required', true);
            $('input[name="client_name"]').attr('required', false);
        } else {
            $('#existingContractorDiv').hide();
            $('#newContractorDiv').show();
            $('#contractorSelect').attr('required', false);
            $('input[name="client_name"]').attr('required', true);
        }
    });

    // æ—¢å­˜æ¥­è€…é¸æŠæ™‚ã®ä½æ‰€è‡ªå‹•å…¥åŠ›
    $('#contractorSelect').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var address = selectedOption.data('address') || '';
        $('#contractorAddress').val(address);
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆä¿®æ­£ç‰ˆï¼‰
    $(document).on('change', 'input[name="modal_internal_pricing_type"]', function() {
        var pricingType = $(this).val();
        console.log('========================');
        console.log('ğŸ”¥ Modal Pricing type changed to:', pricingType);
        console.log('ğŸ” Event target element:', $(this)[0]);
        console.log('ğŸ” Parent modal visible:', $(this).closest('#addImplementationModal').is(':visible'));

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨è¦ç´ ã®å­˜åœ¨ç¢ºèª
        var hourlyFields = $('#modalHourlyPricingFields');
        var projectFields = $('#modalProjectPricingFields');

        console.log('ğŸ¯ Modal Elements found:');
        console.log('  - modalHourlyPricingFields:', hourlyFields.length, 'visible:', hourlyFields.is(':visible'));
        console.log('  - modalProjectPricingFields:', projectFields.length, 'visible:', projectFields.is(':visible'));

        console.log('ğŸ”§ Before changes:');
        console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
        console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));

        if (pricingType === 'hourly') {
            console.log('ğŸ”§ Setting modal to hourly mode');
            $('#modalHourlyPricingFields').show();
            $('#modalProjectPricingFields').hide();
            console.log('ğŸ”§ After hourly changes:');
            console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
            console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));
        } else {
            console.log('ğŸ”§ Setting modal to project mode');
            $('#modalHourlyPricingFields').hide();
            $('#modalProjectPricingFields').show();
            console.log('ğŸ”§ After project changes:');
            console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
            console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));
        }
        console.log('========================');
    });

    // ãƒšãƒ¼ã‚¸å†…ãƒ•ã‚©ãƒ¼ãƒ ã®æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆè©³ç´°ãƒ‡ãƒãƒƒã‚°ä»˜ãï¼‰
    $(document).on('change', 'input[name="internal_pricing_type"]', function() {
        var pricingType = $(this).val();
        console.log('========================');
        console.log('ğŸ”¥ Pricing type changed to:', pricingType);
        console.log('ğŸ” Event target element:', $(this)[0]);
        console.log('ğŸ” Parent container visible:', $(this).closest('#internalWorkerSection').is(':visible'));

        // è¦ç´ ã®å­˜åœ¨ç¢ºèª
        var hourlyFields = $('#hourlyPricingFields');
        var projectFields = $('#projectPricingFields');
        var hourlyCard = $('#hourlyCard');
        var projectCard = $('#projectCard');

        console.log('ğŸ¯ Elements found:');
        console.log('  - hourlyPricingFields:', hourlyFields.length, 'visible:', hourlyFields.is(':visible'));
        console.log('  - projectPricingFields:', projectFields.length, 'visible:', projectFields.is(':visible'));
        console.log('  - hourlyCard:', hourlyCard.length, 'visible:', hourlyCard.is(':visible'));
        console.log('  - projectCard:', projectCard.length, 'visible:', projectCard.is(':visible'));

        // ã‚«ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        $('.pricing-type-card').removeClass('border-primary bg-light');
        console.log('ğŸ”§ Before changes:');
        console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
        console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));

        if (pricingType === 'hourly') {
            console.log('ğŸ”§ Setting to hourly mode');
            $('#hourlyCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
            console.log('ğŸ”§ After hourly changes:');
            console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
            console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));
            $('#contractAmountHint').text('æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ã®å ´åˆã¯æ™‚çµ¦ Ã— å·¥æ•° + è¿½åŠ è²»ç”¨ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™');
            $('#internalContractAmount').prop('readonly', true);
            $('#costItemsLabel').text('è¿½åŠ è²»ç”¨é …ç›®');
            $('#addCostItemText').text('è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ');
            $('#costItemsLabel2').text('è¿½åŠ è²»ç”¨åˆè¨ˆ: Â¥');
            $('#contractAmountLabel').text('ä½œæ¥­è²»ç”¨ï¼ˆåŸºæœ¬æ–™é‡‘ + è¿½åŠ è²»ç”¨ï¼‰');
        } else {
            console.log('ğŸ”§ Setting to project mode');
            $('#projectCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
            console.log('ğŸ”§ After project changes:');
            console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
            console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));
            $('#contractAmountHint').text('æ¡ˆä»¶å˜ä½ã®å ´åˆã¯å¥‘ç´„é‡‘é¡ + è¿½åŠ è²»ç”¨ã§è¨ˆç®—ã•ã‚Œã¾ã™');
            $('#internalContractAmount').prop('readonly', true);
            $('#costItemsLabel').text('è¿½åŠ è²»ç”¨é …ç›®');
            $('#addCostItemText').text('è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ');
            $('#costItemsLabel2').text('è¿½åŠ è²»ç”¨åˆè¨ˆ: Â¥');
            $('#contractAmountLabel').text('ä½œæ¥­è²»ç”¨ï¼ˆå¥‘ç´„é‡‘é¡ + è¿½åŠ è²»ç”¨ï¼‰');
        }
        calculateInternalCost();
        updateProfitPreview();
        console.log('========================');
    });

    // æ‰‹å‹•ãƒ‡ãƒãƒƒã‚°ç”¨ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¿½åŠ 
    window.debugPricingSystem = function() {
        console.log('ğŸ› Manual Pricing System Debug:');
        console.log('  - Internal section visible:', $('#internalWorkerSection').is(':visible'));
        console.log('  - Pricing radio buttons found:', $('input[name="internal_pricing_type"]').length);
        console.log('  - Currently checked:', $('input[name="internal_pricing_type"]:checked').val());
        console.log('  - hourlyPricingFields exists:', $('#hourlyPricingFields').length, 'visible:', $('#hourlyPricingFields').is(':visible'));
        console.log('  - projectPricingFields exists:', $('#projectPricingFields').length, 'visible:', $('#projectPricingFields').is(':visible'));
        console.log('  - hourlyCard exists:', $('#hourlyCard').length);
        console.log('  - projectCard exists:', $('#projectCard').length);

        // å¼·åˆ¶çš„ã«åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
        console.log('ğŸ§ª Testing force toggle to project mode:');
        $('#projectPricing').prop('checked', true).trigger('change');
    };

    window.debugModalPricingSystem = function() {
        console.log('ğŸ› Modal Pricing System Debug:');
        console.log('  - Modal visible:', $('#addImplementationModal').is(':visible'));
        console.log('  - Modal pricing radio buttons found:', $('input[name="modal_internal_pricing_type"]').length);
        console.log('  - Currently checked:', $('input[name="modal_internal_pricing_type"]:checked').val());
        console.log('  - modalHourlyPricingFields exists:', $('#modalHourlyPricingFields').length, 'visible:', $('#modalHourlyPricingFields').is(':visible'));
        console.log('  - modalProjectPricingFields exists:', $('#modalProjectPricingFields').length, 'visible:', $('#modalProjectPricingFields').is(':visible'));

        // å¼·åˆ¶çš„ã«åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
        console.log('ğŸ§ª Testing force toggle to modal project mode:');
        $('#modalProjectPricing').prop('checked', true).trigger('change');
    };

    window.testToggleToProject = function() {
        console.log('ğŸ§ª Manually triggering project mode');
        $('#projectPricing').prop('checked', true).trigger('change');
    };

    window.testToggleToHourly = function() {
        console.log('ğŸ§ª Manually triggering hourly mode');
        $('#hourlyPricing').prop('checked', true).trigger('change');
    };

    window.testModalToggleToProject = function() {
        console.log('ğŸ§ª Manually triggering modal project mode');
        $('#modalProjectPricing').prop('checked', true).trigger('change');
    };

    window.testModalToggleToHourly = function() {
        console.log('ğŸ§ª Manually triggering modal hourly mode');
        $('#modalHourlyPricing').prop('checked', true).trigger('change');
    };

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæ¥­è²»ç”¨è‡ªå‹•è¨ˆç®—
    function calculateInternalCost() {
        var pricingType = $('input[name="internal_pricing_type"]:checked').val();

        if (pricingType === 'hourly') {
            // æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ï¼šåŸºæœ¬æ–™é‡‘ + è¿½åŠ è²»ç”¨
            var hourlyRate = parseFloat($('input[name="internal_hourly_rate"]').val()) || 0;
            var hours = parseFloat($('input[name="estimated_hours"]').val()) || 0;
            var baseAmount = hourlyRate * hours;

            var additionalCost = 0;
            $('.cost-item-input').each(function() {
                additionalCost += parseFloat($(this).val()) || 0;
            });

            var total = baseAmount + additionalCost;
            $('#internalContractAmount').val(total);

            // å†…è¨³è¡¨ç¤ºã‚’æ›´æ–°
            $('#baseAmount').text(baseAmount.toLocaleString());
            $('#additionalAmount').text(additionalCost.toLocaleString());
            $('#workSubtotal').text(total.toLocaleString());
            $('#hourlyBreakdown').show();
            $('#projectBreakdown').hide();
        } else if (pricingType === 'project') {
            // æ¡ˆä»¶å˜ä½ï¼šå¥‘ç´„é‡‘é¡ + è¿½åŠ è²»ç”¨
            var contractAmount = parseFloat($('#projectContractAmount').val()) || 0;

            var additionalCost = 0;
            $('.cost-item-input').each(function() {
                additionalCost += parseFloat($(this).val()) || 0;
            });

            var total = contractAmount + additionalCost;
            $('#internalContractAmount').val(total);

            // å†…è¨³è¡¨ç¤ºã‚’æ›´æ–°
            $('#projectBaseAmount').text(contractAmount.toLocaleString());
            $('#projectAdditionalAmount').text(additionalCost.toLocaleString());
            $('#projectSubtotal').text(total.toLocaleString());
            $('#hourlyBreakdown').hide();
            $('#projectBreakdown').show();
        }

        updateCostBreakdown();
        updateProfitPreview();
    }

    // è²»ç”¨å†…è¨³ã®æ›´æ–°
    function updateCostBreakdown() {
        var workerType = $('input[name="worker_type"]:checked').val();
        var materialCost = 0;
        var workCost = 0;

        if (workerType === 'external') {
            // å¤–æ³¨å…ˆã®å ´åˆ
            workCost = parseFloat($('input[name="contract_amount"]').val()) || 0;
            var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;
            $('.external-material-cost-input').each(function() {
                materialCost += parseFloat($(this).val()) || 0;
            });

            $('#externalContractAmount').text(workCost.toLocaleString());
            $('#externalBilledAmount').text(billedAmount.toLocaleString());
            $('#externalMaterialSubtotal').text(materialCost.toLocaleString());
            $('#externalGrandTotal').text((Math.max(workCost, billedAmount) + materialCost).toLocaleString());
        } else {
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®å ´åˆ
            workCost = parseFloat($('#internalContractAmount').val()) || 0;
            $('.internal-material-cost-input').each(function() {
                materialCost += parseFloat($(this).val()) || 0;
            });
        }

        // å…±é€šã®éƒ¨æè²»è¡¨ç¤ºæ›´æ–°
        $('#materialSubtotal').text(materialCost.toLocaleString());

        // ç·åˆè¨ˆã®æ›´æ–°
        var grandTotal = workCost + materialCost;
        $('#grandTotal').text(grandTotal.toLocaleString());
    }

    // æ™‚çµ¦ã¨å·¥æ•°ã®å¤‰æ›´ã‚’ç›£è¦–
    $('input[name="internal_hourly_rate"], input[name="estimated_hours"]').on('input', calculateInternalCost);

    // æ¡ˆä»¶å˜ä½ã®å¥‘ç´„é‡‘é¡å¤‰æ›´ã‚’ç›£è¦–
    $('#projectContractAmount').on('input', calculateInternalCost);

    // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
    function initializePricingType() {
        var pricingType = $('input[name="internal_pricing_type"]:checked').val();
        console.log('ğŸ”§ Initializing pricing type:', pricingType);
        console.log('ğŸ¯ Hourly fields element:', $('#hourlyPricingFields').length);
        console.log('ğŸ¯ Project fields element:', $('#projectPricingFields').length);
        console.log('ğŸ¯ Hourly card element:', $('#hourlyCard').length);
        console.log('ğŸ¯ Project card element:', $('#projectCard').length);

        $('.pricing-type-card').removeClass('border-primary bg-light');

        if (pricingType === 'hourly') {
            console.log('ğŸ”§ Initializing as hourly');
            $('#hourlyCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
        } else if (pricingType === 'project') {
            console.log('ğŸ”§ Initializing as project');
            $('#projectCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
        } else {
            console.log('âš ï¸ Unknown pricing type:', pricingType);
        }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–å®Ÿè¡Œ
    initializePricingType();

    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆ
    $(document).on('click', '.pricing-type-card', function() {
        console.log('ğŸ¯ Card clicked');
        var targetRadio = $(this).find('input[type="radio"]');
        console.log('ğŸ“» Radio found:', targetRadio.length);
        targetRadio.prop('checked', true).trigger('change');
    });

    // æš«å®šåˆ©ç›Šç‡ã®è¨ˆç®—ã¨è¡¨ç¤ºï¼ˆè©³ç´°ç‰ˆï¼‰
    function updateProfitPreview() {
        var revenue = parseFloat("{{ project.billing_amount|default:0 }}".replace(/,/g, '')) || 0;
        var newWorkCost = 0;
        var newMaterialCost = 0;

        // ç¾åœ¨å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ä½œæ¥­è²»ç”¨ã‚’å–å¾—
        if ($('input[name="worker_type"]:checked').val() === 'external') {
            newWorkCost = parseFloat($('input[name="contract_amount"]').val()) || 0;
            var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;
            newWorkCost = Math.max(newWorkCost, billedAmount); // ã‚ˆã‚Šé«˜ã„æ–¹ã‚’ä½¿ç”¨

            // å¤–æ³¨å…ˆã®éƒ¨æè²»åˆè¨ˆ
            $('.external-material-cost-input').each(function() {
                newMaterialCost += parseFloat($(this).val()) || 0;
            });
        } else {
            newWorkCost = parseFloat($('#internalContractAmount').val()) || 0;
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®éƒ¨æè²»åˆè¨ˆ
            $('.internal-material-cost-input').each(function() {
                newMaterialCost += parseFloat($(this).val()) || 0;
            });
        }

        var existingCost = parseFloat("{{ existing_total_cost|default:0 }}".replace(/,/g, '')) || 0;
        var totalCost = existingCost + newWorkCost + newMaterialCost;
        var grossProfit = revenue - totalCost;
        var profitRate = revenue > 0 ? (grossProfit / revenue * 100) : 0;

        // è©³ç´°è¡¨ç¤ºã‚’æ›´æ–°
        $('#previewRevenue').text(revenue.toLocaleString());
        $('#previewExistingCost').text(existingCost.toLocaleString());
        $('#previewNewWorkCost').text(newWorkCost.toLocaleString());
        $('#previewNewMaterialCost').text(newMaterialCost.toLocaleString());
        $('#previewTotalCost').text(totalCost.toLocaleString());
        $('#previewGrossProfit').text(grossProfit.toLocaleString());
        $('#previewProfitRate').text(profitRate.toFixed(1) + '%');

        // åˆ©ç›Šç‡ã«å¿œã˜ã¦è‰²ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
        var rateElement = $('#previewProfitRate');
        var progressBar = $('#profitRateBar');

        rateElement.removeClass('text-success text-warning text-danger');
        progressBar.removeClass('bg-success bg-warning bg-danger');

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®å¹…ã‚’è¨­å®šï¼ˆæœ€å¤§50%ã¾ã§è¡¨ç¤ºï¼‰
        var displayRate = Math.min(profitRate, 50);
        progressBar.css('width', displayRate + '%');

        // åˆ©ç›Šç‡ã«å¿œã˜ãŸè‰²åˆ†ã‘
        if (profitRate >= 30) {
            rateElement.addClass('text-success');
            progressBar.addClass('bg-success');
        } else if (profitRate >= 15) {
            rateElement.addClass('text-warning');
            progressBar.addClass('bg-warning');
        } else {
            rateElement.addClass('text-danger');
            progressBar.addClass('bg-danger');
        }

        // æ–°è¦è²»ç”¨ãŒã‚ã‚‹å ´åˆã®ã¿è¡Œã‚’è¡¨ç¤º
        if (newWorkCost > 0) {
            $('#newCostRow').show();
        } else {
            $('#newCostRow').hide();
        }

        if (newMaterialCost > 0) {
            $('#newMaterialRow').show();
        } else {
            $('#newMaterialRow').hide();
        }

        // åˆ©ç›Šç‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å¸¸ã«è¡¨ç¤ºï¼ˆå†…å®¹ã‚’å‹•çš„ã«æ›´æ–°ï¼‰
        // å…¥åŠ›ãŒãªã„å ´åˆã§ã‚‚ç¾åœ¨ã®çŠ¶æ³ã‚’è¡¨ç¤º
    }

    // é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆå¤–æ³¨å…ˆç”¨ï¼‰
    $('input[name="contract_amount"], input[name="billed_amount"]').on('input', function() {
        updateCostBreakdown();
        updateProfitPreview();
    });

    // éƒ¨æè²»åˆè¨ˆã®è‡ªå‹•è¨ˆç®—
    function calculateMaterialTotal() {
        var total = 0;
        $('.material-cost').each(function() {
            var value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#totalMaterialCost').val(total);
    }

    // éƒ¨æè²»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–
    $('.material-cost').on('input', calculateMaterialTotal);

    // åˆæœŸè¨ˆç®—
    calculateMaterialTotal();

    // å‹•çš„éƒ¨æè²»é …ç›®ç®¡ç†
    let materialItemCounter = 0;
    let externalMaterialItemCounter = 0;

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ç”¨éƒ¨æè²»é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addMaterialItem(item = '', cost = 0) {
        materialItemCounter++;
        const itemHtml = `
            <div class="material-item mb-2" data-item-id="${materialItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="internal_material_items[]" class="form-control"
                               placeholder="éƒ¨æè²»é …ç›®" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" name="internal_material_costs[]" class="form-control internal-material-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-material-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#materialCostSection').append(itemHtml);
        updateInternalMaterialTotal();
    }

    // å¤–æ³¨å…ˆç”¨éƒ¨æè²»é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addExternalMaterialItem(item = '', cost = 0) {
        externalMaterialItemCounter++;
        const itemHtml = `
            <div class="external-material-item mb-2" data-item-id="${externalMaterialItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="material_items[]" class="form-control"
                               placeholder="éƒ¨æè²»é …ç›®" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" name="material_costs[]" class="form-control external-material-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-external-material-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#externalMaterialCostSection').append(itemHtml);
        updateExternalMaterialTotal();
    }

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹éƒ¨æè²»åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateInternalMaterialTotal() {
        let total = 0;
        $('.internal-material-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#materialTotal').text(total.toLocaleString());
        updateCostBreakdown();
        updateProfitPreview();
    }

    // å¤–æ³¨å…ˆéƒ¨æè²»åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateExternalMaterialTotal() {
        let total = 0;
        $('.external-material-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#externalMaterialTotal').text(total.toLocaleString());
        $('#externalMaterialSubtotal').text(total.toLocaleString());
        updateExternalCostBreakdown();
        updateProfitPreview();
    }

    // å¤–æ³¨å…ˆç”¨è¿½åŠ è²»ç”¨é …ç›®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    let externalAdditionalCostItemCounter = 0;

    // å¤–æ³¨å…ˆç”¨è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addExternalAdditionalCostItem(item = '', cost = 0) {
        externalAdditionalCostItemCounter++;
        const itemHtml = `
            <div class="external-additional-cost-item mb-2" data-item-id="${externalAdditionalCostItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="additional_cost_items[]" class="form-control"
                               placeholder="è¿½åŠ è²»ç”¨é …ç›®" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" name="additional_cost_amounts[]" class="form-control external-additional-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-external-additional-cost-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#externalAdditionalCostSection').append(itemHtml);
        updateExternalAdditionalCostTotal();
    }

    // å¤–æ³¨å…ˆè¿½åŠ è²»ç”¨åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateExternalAdditionalCostTotal() {
        let total = 0;
        $('.external-additional-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#externalAdditionalCostTotal').text(total.toLocaleString());
        $('#externalAdditionalCostSubtotal').text(total.toLocaleString());
        updateExternalCostBreakdown();
        updateProfitPreview();
    }

    // å¤–æ³¨å…ˆè²»ç”¨å†…è¨³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateExternalCostBreakdown() {
        var contractAmount = parseFloat($('input[name="contract_amount"]').val()) || 0;
        var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;

        var materialCost = 0;
        $('.external-material-cost-input').each(function() {
            materialCost += parseFloat($(this).val()) || 0;
        });

        var additionalCost = 0;
        $('.external-additional-cost-input').each(function() {
            additionalCost += parseFloat($(this).val()) || 0;
        });

        $('#externalContractAmount').text(contractAmount.toLocaleString());
        $('#externalBilledAmount').text(billedAmount.toLocaleString());
        $('#externalMaterialSubtotal').text(materialCost.toLocaleString());
        $('#externalAdditionalCostSubtotal').text(additionalCost.toLocaleString());

        var grandTotal = Math.max(contractAmount, billedAmount) + materialCost + additionalCost;
        $('#externalGrandTotal').text(grandTotal.toLocaleString());
    }

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹éƒ¨æè²»é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#addMaterialBtn').on('click', function() {
        addMaterialItem();
    });

    // å¤–æ³¨å…ˆéƒ¨æè²»é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#addExternalMaterialBtn').on('click', function() {
        addExternalMaterialItem();
    });

    // å¤–æ³¨å…ˆè¿½åŠ è²»ç”¨é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#addExternalAdditionalCostBtn').on('click', function() {
        addExternalAdditionalCostItem();
    });

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹éƒ¨æè²»é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('click', '.remove-material-btn', function() {
        $(this).closest('.material-item').remove();
        updateInternalMaterialTotal();
    });

    // å¤–æ³¨å…ˆéƒ¨æè²»é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('click', '.remove-external-material-btn', function() {
        $(this).closest('.external-material-item').remove();
        updateExternalMaterialTotal();
    });

    // å¤–æ³¨å…ˆè¿½åŠ è²»ç”¨é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('click', '.remove-external-additional-cost-btn', function() {
        $(this).closest('.external-additional-cost-item').remove();
        updateExternalAdditionalCostTotal();
    });

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹éƒ¨æè²»é‡‘é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.internal-material-cost-input', function() {
        updateInternalMaterialTotal();
    });

    // å¤–æ³¨å…ˆéƒ¨æè²»é‡‘é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.external-material-cost-input', function() {
        updateExternalMaterialTotal();
    });

    // å¤–æ³¨å…ˆè¿½åŠ è²»ç”¨é‡‘é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.external-additional-cost-input', function() {
        updateExternalAdditionalCostTotal();
    });

    // å¤–æ³¨å…ˆå¥‘ç´„é‡‘é¡ãƒ»è¢«è«‹æ±‚é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', 'input[name="contract_amount"], input[name="billed_amount"]', function() {
        updateExternalCostBreakdown();
        updateProfitPreview();
    });

    // æ‹…å½“è€…é¸æŠè¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('click', '.add-staff-select-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const containerId = $(this).data('container-id');
        const fieldName = $(this).data('field-name');
        const container = $(`#${containerId}`);

        // ã‚¹ã‚¿ãƒƒãƒ•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
        const staffOptions = generateStaffOptions();
        let optionsHtml = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        if (staffOptions && Array.isArray(staffOptions)) {
            staffOptions.forEach(option => {
                optionsHtml += `<option value="${option.value}">${option.text}</option>`;
            });
        }

        // æ–°ã—ã„selectãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
        const newSelect = `
            <div class="staff-select-item mb-1">
                <select name="${fieldName}" class="form-select d-inline-block" style="width: calc(100% - 35px); font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                    ${optionsHtml}
                </select>
                <button type="button" class="btn btn-outline-danger remove-staff-select-btn" style="font-size: 0.65rem; padding: 0.2rem 0.35rem; line-height: 1;">
                    Ã—
                </button>
            </div>
        `;
        container.append(newSelect);

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆ2ã¤ä»¥ä¸Šã®å ´åˆï¼‰
        if (container.find('.staff-select-item').length > 1) {
            container.find('.remove-staff-select-btn').show();
        }
    });

    // æ‹…å½“è€…é¸æŠå‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('click', '.remove-staff-select-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const item = $(this).closest('.staff-select-item');
        const container = item.closest('.staff-select-container');

        item.remove();

        // 1ã¤ã—ã‹ãªã„å ´åˆã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        if (container.find('.staff-select-item').length <= 1) {
            container.find('.remove-staff-select-btn').hide();
        }
    });

    // ä¿å­˜çŠ¶æ…‹ç®¡ç†é–¢æ•°
    let saveTimeout = null;
    function showSavingStatus(status) {
        const banner = $('#savingStatusBanner');
        const icon = $('#savingStatusIcon');
        const text = $('#savingStatusText');

        banner.removeClass('d-none alert-info alert-success alert-warning');

        if (status === 'saving') {
            banner.addClass('alert-info');
            icon.html('<i class="fas fa-spinner fa-spin"></i>');
            text.text('ä¿å­˜ä¸­...');
        } else if (status === 'saved') {
            banner.addClass('alert-success');
            icon.html('<i class="fas fa-check-circle"></i>');
            text.text('ä¿å­˜ã—ã¾ã—ãŸ');
            // 2ç§’å¾Œã«éè¡¨ç¤º
            setTimeout(() => {
                banner.addClass('d-none');
            }, 2000);
        } else if (status === 'error') {
            banner.addClass('alert-warning');
            icon.html('<i class="fas fa-exclamation-triangle"></i>');
            text.text('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    }

    // å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä¿å­˜é–¢æ•°
    function saveStepField(stepKey, stepElement) {
        // æ—¢å­˜ã®ä¿å­˜ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
        if (saveTimeout) {
            clearTimeout(saveTimeout);
        }

        // 500msã®ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼ˆé€£ç¶šå…¥åŠ›ã‚’å¾…ã¤ï¼‰
        saveTimeout = setTimeout(() => {
            showSavingStatus('saving');

            if (stepElement.length === 0) {
                console.error('Step element not found:', stepKey);
                showSavingStatus('error');
                return;
            }

            // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åé›†
            const dynamicFields = {};
        stepElement.find('input, select, textarea').each(function() {
            const fieldElement = $(this);
            const fieldName = fieldElement.attr('name');

            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (!fieldName) return;

            let fieldValue;

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å ´åˆ
            if (fieldElement.is(':checkbox')) {
                fieldValue = fieldElement.is(':checked') ? 'true' : 'false';
            } else if (fieldElement.is(':radio')) {
                // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
                if (!fieldElement.is(':checked')) return;
                fieldValue = fieldElement.val();
            } else if (fieldElement.is('select[multiple]')) {
                // è¤‡æ•°é¸æŠã®å ´åˆ
                const selectedValues = fieldElement.val();
                if (selectedValues && selectedValues.length > 0) {
                    fieldValue = selectedValues.join(',');
                } else {
                    return; // ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                }
            } else {
                fieldValue = fieldElement.val();
            }

            // å€¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ 
            if (fieldValue !== undefined && fieldValue !== '') {
                // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ï¼ˆã¾ã ãªã„å ´åˆï¼‰
                const finalFieldName = fieldName.startsWith('dynamic_field_') ? fieldName : `dynamic_field_${fieldName}`;
                dynamicFields[finalFieldName] = fieldValue;
            }
        });

        console.log('Saving step:', stepKey, dynamicFields);

        // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆAJAXï¼‰
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
            data: $.extend({
                csrfmiddlewaretoken: '{{ csrf_token }}',
                ajax_save: 'true'  // AJAXä¿å­˜ãƒ•ãƒ©ã‚°
            }, dynamicFields),
            success: function(response) {
                console.log('ä¿å­˜æˆåŠŸ:', response);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                if (response && response.success) {
                    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¦æœ›ï¼‰
                    // if (typeof toastr !== 'undefined') {
                    //     toastr.success(response.message || `${stepKey}ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                    // } else {
                    //     showErrorModal(`${stepKey}ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                    // }
                    // é€²æ—çŠ¶æ³ã‚’æ›´æ–°
                    updateProgressTimeline();
                    updateProgressStatus();
                } else {
                    console.error('ä¿å­˜å¤±æ•—:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    } else {
                        showErrorModal('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                let errorMessage = 'ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                } else if (xhr.status === 403) {
                    errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                } else if (xhr.status === 404) {
                    errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (xhr.status >= 500) {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                } else {
                    showErrorModal(errorMessage);
                }
            }
        });
        }, 500);
    }

    // åˆæœŸéƒ¨æè²»é …ç›®ã‚’1ã¤è¿½åŠ 
    addMaterialItem();
    addExternalMaterialItem();
    addExternalAdditionalCostItem();

    // å‹•çš„è²»ç”¨é …ç›®ç®¡ç†
    let costItemCounter = 0;

    // è²»ç”¨é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addCostItem(item = '', cost = 0) {
        costItemCounter++;
        const itemHtml = `
            <div class="cost-item mb-2" data-item-id="${costItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="cost_items[]" class="form-control"
                               placeholder="è²»ç”¨é …ç›®å" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" name="cost_amounts[]" class="form-control cost-item-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-cost-item-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#costItemsSection').append(itemHtml);
        updateCostItemsTotal();
    }

    // è²»ç”¨é …ç›®åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateCostItemsTotal() {
        let total = 0;
        $('.cost-item-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#costItemsTotal').text(total.toLocaleString());
        calculateInternalCost(); // ã“ã‚ŒãŒ updateCostBreakdown ã¨ updateProfitPreview ã‚’å‘¼ã¶
    }

    // è²»ç”¨é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#addCostItemBtn').on('click', function() {
        addCostItem();
    });

    // è²»ç”¨é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('click', '.remove-cost-item-btn', function() {
        $(this).closest('.cost-item').remove();
        updateCostItemsTotal();
    });

    // è²»ç”¨é …ç›®é‡‘é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.cost-item-input', function() {
        updateCostItemsTotal();
    });

    // åˆæœŸè²»ç”¨é …ç›®ã‚’1ã¤è¿½åŠ 
    addCostItem();

    // åˆæœŸè¡¨ç¤ºæ™‚ã«åˆ©ç›Šç‡ã‚’è¨ˆç®—ãƒ»è¡¨ç¤º
    updateProfitPreview();

    // ç¸¦å‹ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆãƒˆã‚°ãƒ«å¼ - ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å±•é–‹çŠ¶æ…‹ï¼‰
    $(document).on('click', '.progress-step', function(e) {
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã€ç·¨é›†ãƒœã‚¿ãƒ³ã€ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã€ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
        if ($(e.target).hasClass('remove-step-btn') || $(e.target).closest('.remove-step-btn').length ||
            $(e.target).hasClass('btn') || $(e.target).closest('.btn').length ||
            $(e.target).hasClass('drag-handle') || $(e.target).closest('.drag-handle').length ||
            $(e.target).is('input, select, textarea') || $(e.target).closest('input, select, textarea').length) {
            return;
        }

        const $clickedStep = $(this);
        const isCurrentlyExpanded = $clickedStep.hasClass('expanded');

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒˆã‚°ãƒ«ï¼ˆCSS transitionã§æ»‘ã‚‰ã‹ã«å±•é–‹ï¼‰
        if (isCurrentlyExpanded) {
            $clickedStep.removeClass('expanded');
        } else {
            $clickedStep.addClass('expanded');
        }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚’æœ€åˆã¯éè¡¨ç¤º
    $('.drag-handle').hide();

    // Sortableæ©Ÿèƒ½ã‚’åˆæœŸåŒ–ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®šå¾Œï¼‰
    initializeSortable();

    // åˆæœŸè¡¨ç¤ºæ™‚ã«å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å±•é–‹ï¼ˆCSS transitionã§åˆ¶å¾¡ï¼‰
    $('.progress-step').addClass('expanded');
    // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚‚æ›´æ–°ï¼ˆãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã•ã‚ŒãŸã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    // $('#toggleAllSteps').find('i').removeClass('fa-expand-alt').addClass('fa-compress-alt');
    // $('#toggleButtonText').text('å…¨ã¦é–‰ã˜ã‚‹');

    // ä¸€æ‹¬é–‹é–‰ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆãƒœã‚¿ãƒ³ã¯å‰Šé™¤ã•ã‚ŒãŸã®ã§ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼‰
    // $('#toggleAllSteps').on('click', function() {
    //     // ç¾åœ¨ã®çŠ¶æ…‹ã‚’åˆ¤å®šï¼ˆã™ã¹ã¦å±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
    //     const allExpanded = $('.progress-step.expanded').length === $('.progress-step').length;

    //     if (allExpanded) {
    //         // å…¨ã¦é–‰ã˜ã‚‹
    //         $('.progress-step').removeClass('expanded');
    //         $('.progress-step-content').slideUp(200);
    //         // ãƒœã‚¿ãƒ³ã‚’ã€Œå…¨ã¦é–‹ãã€ã«å¤‰æ›´
    //         $(this).find('i').removeClass('fa-compress-alt').addClass('fa-expand-alt');
    //         $('#toggleButtonText').text('å…¨ã¦é–‹ã');
    //     } else {
    //         // å…¨ã¦é–‹ã
    //         $('.progress-step').addClass('expanded');
    //         $('.progress-step-content').slideDown(200);
    //         // ãƒœã‚¿ãƒ³ã‚’ã€Œå…¨ã¦é–‰ã˜ã‚‹ã€ã«å¤‰æ›´
    //         $(this).find('i').removeClass('fa-expand-alt').addClass('fa-compress-alt');
    //         $('#toggleButtonText').text('å…¨ã¦é–‰ã˜ã‚‹');
    //     }
    // });

    // å…¨éƒ¨é–‹ã/å…¨éƒ¨é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆãƒˆã‚°ãƒ«å¼ï¼‰
    $('#toggleAllSteps').on('click', function() {
        // ç¾åœ¨ã®çŠ¶æ…‹ã‚’åˆ¤å®šï¼ˆã™ã¹ã¦å±•é–‹ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼‰
        const allExpanded = $('.progress-step.expanded').length === $('.progress-step').length;

        if (allExpanded) {
            // å…¨ã¦é–‰ã˜ã‚‹
            console.log('å…¨ã¦é–‰ã˜ã‚‹');
            $('.progress-step').removeClass('expanded');
            $('.progress-step-content').slideUp(200);
            // ãƒœã‚¿ãƒ³ã‚’ã€Œå…¨éƒ¨é–‹ãã€ã«å¤‰æ›´
            $(this).find('i').removeClass('fa-compress-alt').addClass('fa-expand-alt');
            $('#toggleButtonText').text('å…¨éƒ¨é–‹ã');
        } else {
            // å…¨ã¦é–‹ã
            console.log('å…¨ã¦é–‹ã');
            $('.progress-step').addClass('expanded');
            $('.progress-step-content').slideDown(200);
            // ãƒœã‚¿ãƒ³ã‚’ã€Œå…¨éƒ¨é–‰ã˜ã‚‹ã€ã«å¤‰æ›´
            $(this).find('i').removeClass('fa-expand-alt').addClass('fa-compress-alt');
            $('#toggleButtonText').text('å…¨éƒ¨é–‰ã˜ã‚‹');
        }
    });

    // å®Ÿæ–½æ—¥è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    $(document).on('click', '.add-actual-date-btn', function(e) {
        e.stopPropagation();
        const $step = $(this).closest('.progress-step');
        const $actualDateField = $step.find('.actual-date-field');

        // å®Ÿæ–½æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º
        $actualDateField.slideDown();
        $(this).prop('disabled', true).addClass('disabled');
    });

    // å®Ÿæ–½æ—¥å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
    $(document).on('click', '.remove-actual-date-btn', function(e) {
        e.stopPropagation();
        const $step = $(this).closest('.progress-step');
        const $actualDateField = $step.find('.actual-date-field');
        const $actualDateInput = $step.find('.actual-date-input');
        const $addBtn = $step.find('.add-actual-date-btn');

        // å®Ÿæ–½æ—¥ã®å€¤ã‚’ã‚¯ãƒªã‚¢
        $actualDateInput.val('');

        // å®Ÿæ–½æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éè¡¨ç¤º
        $actualDateField.slideUp();
        $addBtn.prop('disabled', false).removeClass('disabled');
    });

    // äºˆå®šæ—¥ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    $(document).on('change', '.scheduled-date-input', function() {
        checkOverdueSteps();
    });

    // äºˆå®šæ—¥è¶…éãƒã‚§ãƒƒã‚¯é–¢æ•°ï¼ˆäºˆå®šæ—¥è¶…éæ™‚ã«è‡ªå‹•å®Œäº†ï¼‰
    function checkOverdueSteps() {
        const today = new Date();
        today.setHours(0, 0, 0, 0); // æ™‚åˆ»ã‚’ãƒªã‚»ãƒƒãƒˆ

        $('.progress-step').each(function() {
            const $step = $(this);
            const $scheduledInput = $step.find('.scheduled-date-input');
            const $actualInput = $step.find('.actual-date-input');
            const $completedCheckbox = $step.find('input[type="checkbox"][name$="_completed"], input[type="checkbox"][id$="Completed"]');

            const scheduledDate = $scheduledInput.val();
            const actualDate = $actualInput.val();
            const isManuallyCompleted = $completedCheckbox.length > 0 && $completedCheckbox.is(':checked');

            // å®Ÿæ–½æ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã‚Œã‚’å„ªå…ˆ
            if (actualDate) {
                $step.removeClass('overdue auto-completed');
                $step.addClass('completed');
                $step.find('.progress-step-date').html(
                    `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(actualDate)}`
                );
                return;
            }

            // æ‰‹å‹•ã§å®Œäº†ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (isManuallyCompleted) {
                $step.removeClass('overdue auto-completed');
                $step.addClass('completed');
                $step.find('.progress-step-date').html(
                    `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${scheduledDate ? formatDate(scheduledDate) : 'å®Œäº†æ¸ˆã¿'}`
                );
                return;
            }

            // äºˆå®šæ—¥ãŒã‚ã‚‹å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
            if (scheduledDate) {
                const scheduled = new Date(scheduledDate);
                scheduled.setHours(0, 0, 0, 0);

                // äºˆå®šæ—¥ãŒéãã¦ã„ã‚‹å ´åˆã¯è‡ªå‹•çš„ã«å®Œäº†æ‰±ã„
                if (scheduled < today) {
                    $step.removeClass('overdue');
                    $step.addClass('completed auto-completed');

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®Œäº†ï¼ˆäºˆå®šæ—¥ãƒ™ãƒ¼ã‚¹ï¼‰ã«æ›´æ–°
                    const daysAgo = Math.floor((today - scheduled) / (1000 * 60 * 60 * 24));
                    $step.find('.progress-step-date').html(
                        `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(scheduledDate)} <small class="text-muted">(${daysAgo}æ—¥å‰)</small>`
                    );
                } else {
                    // äºˆå®šæ—¥ãŒæœªæ¥ã®å ´åˆ
                    $step.removeClass('overdue completed auto-completed');
                    $step.find('.progress-step-date').html(
                        `<i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(scheduledDate)}`
                    );
                }
            } else {
                // äºˆå®šæ—¥ãŒãªã„å ´åˆ
                $step.removeClass('overdue completed auto-completed');
            }
        });
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€²æ—ãƒãƒ¼ã®è‰²ã‚’æ›´æ–°
    $('#workStartCompleted').on('change', function() {
        var step = $('.progress-step[data-step="work_start"]');
        if ($(this).is(':checked')) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate($('input[name="work_start_date"]').val()));

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå·¥äº‹çµ‚äº†ï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');

            // å·¥äº‹çµ‚äº†ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’å‰Šé™¤ï¼ˆå·¥äº‹çµ‚äº†ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆï¼‰
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.removeClass('active');
            }
        }
        // é€²æ—çŠ¶æ³ã‚‚æ›´æ–°
        updateProgressTimeline();
        updateProgressStatus();
    });

    $('#workEndCompleted').on('change', function() {
        var step = $('.progress-step[data-step="work_end"]');
        if ($(this).is(':checked')) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate($('input[name="work_end_date"]').val()));

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè«‹æ±‚æ›¸ç™ºè¡Œï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');

            // è«‹æ±‚æ›¸ç™ºè¡Œã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’å‰Šé™¤ï¼ˆè«‹æ±‚æ›¸ãŒæœªç™ºè¡Œã®å ´åˆï¼‰
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.removeClass('active');
            }
        }
        // é€²æ—çŠ¶æ³ã‚‚æ›´æ–°
        updateProgressTimeline();
        updateProgressStatus();
    });

    // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦é€²æ—çŠ¶æ³ã‚’è‡ªå‹•æ›´æ–°
    // æ±ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚‚å«ã‚€ï¼‰
    // _dateã§çµ‚ã‚ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆestimate_issued_date, contract_date, dynamic_field_*ã¯é™¤å¤–ï¼‰
    $(document).on('change', 'input[name$="_date"]:not([name="estimate_issued_date"]):not([name="contract_date"]):not([name^="dynamic_field_"]), input[name$="_completed"]:not([name^="dynamic_field_"]), select[name="invoice_issued"]', function() {
        // ä¿å­˜çŠ¶æ…‹ã‚’è¡¨ç¤º
        showSavingStatus('saving');

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆæ±ç”¨ï¼‰
        var fieldName = $(this).attr('name');
        var fieldValue;

        if ($(this).is(':checkbox')) {
            fieldValue = $(this).is(':checked');
        } else {
            fieldValue = $(this).val();
        }

        var data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ajax_save: 'true'
        };
        data[fieldName] = fieldValue;

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
            data: data,
            success: function(response) {
                console.log('ä¿å­˜æˆåŠŸ:', response);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                if (response && response.success) {
                    console.log(fieldName + 'ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', fieldValue);

                    // ä¿å­˜æˆåŠŸã‚’è¡¨ç¤º
                    showSavingStatus('saved');

                    // projectDataã‚’æ›´æ–°
                    projectData[fieldName] = fieldValue;

                    // UIå…¨ä½“ã‚’æ›´æ–°
                    updateProgressTimeline();
                    updateProgressStatus();
                } else {
                    console.error('ä¿å­˜å¤±æ•—:', response);
                    showSavingStatus('error');
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || fieldName + 'ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    field: fieldName,
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                // ä¿å­˜ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                showSavingStatus('error');

                let errorMessage = fieldName + 'ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                } else if (xhr.status === 403) {
                    errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                } else if (xhr.status === 404) {
                    errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (xhr.status >= 500) {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                }
            }
        });
    });

    // è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="estimate_issued_date"]', function() {
        console.log('=== è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ã¾ã—ãŸ ===');
        var step = $('.progress-step[data-step="estimate"]');
        var notRequiredChecked = $('#estimateNotRequired').is(':checked');
        var dateValue = $(this).val();

        console.log('ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', step.length > 0);
        console.log('è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯:', notRequiredChecked);
        console.log('å…¥åŠ›ã•ã‚ŒãŸæ—¥ä»˜:', dateValue);

        // ä¿å­˜çŠ¶æ…‹ã‚’è¡¨ç¤º
        showSavingStatus('saving');

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        console.log('AJAXä¿å­˜ã‚’é–‹å§‹ã—ã¾ã™ - URL:', '{% url "order_management:update_progress" project.pk %}');
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
            data: {
                estimate_issued_date: dateValue,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('ä¿å­˜æˆåŠŸ:', response);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                if (response && response.success) {
                    console.log('âœ“ è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸ');
                    console.log('ä¿å­˜ã•ã‚ŒãŸæ—¥ä»˜:', dateValue);

                    // ä¿å­˜æˆåŠŸã‚’è¡¨ç¤º
                    showSavingStatus('saved');

                    // projectDataã‚’æ›´æ–°
                    projectData.estimate_issued_date = dateValue;
                    console.log('projectDataã‚’æ›´æ–°ã—ã¾ã—ãŸ:', projectData.estimate_issued_date);

                    // UIã‚’æ›´æ–°
                    if (dateValue && !notRequiredChecked) {
                        console.log('ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†çŠ¶æ…‹ã«ã—ã¾ã™');
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
                    } else if (!notRequiredChecked) {
                        console.log('ã‚¹ãƒ†ãƒƒãƒ—ã‚’æœªå®Œäº†çŠ¶æ…‹ã«ã—ã¾ã™');
                        step.removeClass('completed');
                        step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
                    }

                    // é€²æ—çŠ¶æ³å…¨ä½“ã‚’æ›´æ–°
                    console.log('é€²æ—çŠ¶æ³ã‚’æ›´æ–°ã—ã¾ã™');
                    updateProgressTimeline();
                    updateProgressStatus();
                    updateActiveStep();
                    updateAllStepStatuses();
                } else {
                    console.error('ä¿å­˜å¤±æ•—:', response);
                    showSavingStatus('error');
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    } else {
                        showErrorModal('è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                // ä¿å­˜ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                showSavingStatus('error');

                let errorMessage = 'è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                } else if (xhr.status === 403) {
                    errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                } else if (xhr.status === 404) {
                    errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (xhr.status >= 500) {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                } else {
                    showErrorModal(errorMessage);
                }
            }
        });
    });

    // è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
    window.handleEstimateNotRequiredChange = function() {
        var isChecked = $('#estimateNotRequired').is(':checked');
        console.log('è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', isChecked);
        var step = $('.progress-step[data-step="estimate"]');
        var dateInput = $('input[name="estimate_issued_date"]');

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
            data: {
                estimate_not_required: isChecked ? 'on' : '',
                estimate_issued_date: isChecked ? '' : dateInput.val(),
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('ä¿å­˜æˆåŠŸ:', response);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                if (response && response.success) {
                    console.log('è¦‹ç©æ›¸ä¸è¦ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', isChecked);

                    // projectDataã‚’æ›´æ–°
                    projectData.estimate_not_required = isChecked;
                    if (isChecked) {
                        projectData.estimate_issued_date = null;
                    }

                    // UIã‚’æ›´æ–°
                    if (isChecked) {
                        // è¦‹ç©æ›¸ä¸è¦ã«ãƒã‚§ãƒƒã‚¯ã—ãŸå ´åˆ
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<i class="fas fa-times-circle me-1"></i>è¦‹ç©ä¸è¦');
                    dateInput.prop('disabled', true).val('');
                } else {
                    // è¦‹ç©æ›¸ä¸è¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸå ´åˆ
                    dateInput.prop('disabled', false);
                    if (!dateInput.val()) {
                        step.removeClass('completed');
                        step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
                    } else {
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>' + formatDate(dateInput.val()));
                    }
                }

                    // é€²æ—çŠ¶æ³å…¨ä½“ã‚’æ›´æ–°
                    updateActiveStep();
                    updateProgressTimeline();
                    updateProgressStatus();
                } else {
                    console.error('ä¿å­˜å¤±æ•—:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'è¦‹ç©æ›¸ä¸è¦ãƒ•ãƒ©ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    } else {
                        showErrorModal('è¦‹ç©æ›¸ä¸è¦ãƒ•ãƒ©ã‚°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                let errorMessage = 'è¦‹ç©æ›¸ä¸è¦ãƒ•ãƒ©ã‚°ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                } else if (xhr.status === 403) {
                    errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                } else if (xhr.status === 404) {
                    errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (xhr.status >= 500) {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                } else {
                    showErrorModal(errorMessage);
                }
            }
        });
    };

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰
    // â€»ç›´æ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¯å‰Šé™¤ï¼ˆDOMè¦ç´ ãŒã¾ã å­˜åœ¨ã—ãªã„ãŸã‚ï¼‰
    $(document).off('change', '#estimateNotRequired').on('change', '#estimateNotRequired', window.handleEstimateNotRequiredChange);

    // åˆæœŸçŠ¶æ…‹ã®è¨­å®šã¯ initializeSteps() ã®å¾Œã§è¡Œã‚ã‚Œã¾ã™ï¼ˆ3882-3887è¡Œç›®ï¼‰

    // ============================================
    // è¦‹ç©ã‚‚ã‚Šãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    // ============================================

    // è¦‹ç©ã‚‚ã‚Šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰å–å¾—ï¼‰
    let estimateFilesData = {{ estimate_files_json|safe }};

    // è¦‹ç©ã‚‚ã‚Šãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    function loadEstimateFiles() {
        renderEstimateFiles(estimateFilesData);
    }

    // è¦‹ç©ã‚‚ã‚Šãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderEstimateFiles(files) {
        const container = $('.estimate-files-list');
        if (!container.length) return;

        if (files.length === 0) {
            container.html('<small class="text-muted">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</small>');
            return;
        }

        let html = '<div class="list-group list-group-flush">';
        files.forEach(file => {
            const fileIcon = getFileIcon(file.file_type);
            html += `
                <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-0" data-file-id="${file.id}">
                    <div class="d-flex align-items-center flex-grow-1">
                        <i class="${fileIcon} me-2"></i>
                        <div class="flex-grow-1">
                            <div class="small fw-bold">${file.file_name}</div>
                            <div class="text-muted" style="font-size: 0.75rem;">
                                ${file.file_size} â€¢ ${file.uploaded_at}
                            </div>
                        </div>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <a href="{% url 'order_management:project_file_download' project.pk 0 %}".replace('/0/', '/${file.id}/')
                           class="btn btn-outline-primary btn-sm" title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                            <i class="fas fa-download"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger btn-sm delete-estimate-file-btn"
                                data-file-id="${file.id}" title="å‰Šé™¤">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        });
        html += '</div>';
        container.html(html);
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
    function getFileIcon(fileType) {
        if (!fileType) return 'fas fa-file';
        if (fileType.includes('pdf')) return 'fas fa-file-pdf text-danger';
        if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel text-success';
        if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word text-primary';
        if (fileType.includes('image')) return 'fas fa-file-image text-info';
        return 'fas fa-file';
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
    $(document).on('click', '.upload-estimate-file-btn', function() {
        $(this).closest('.estimate-files-section').find('.estimate-file-input').click();
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚ŒãŸã‚‰ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    $(document).on('change', '.estimate-file-input', function() {
        const fileInput = this;
        const file = fileInput.files[0];

        if (!file) return;

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ (10MB)
        if (file.size > 10 * 1024 * 1024) {
            if (typeof toastr !== 'undefined') {
                toastr.error('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
            } else {
                showErrorModal('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„');
            }
            fileInput.value = '';
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('related_step', 'estimate');
        formData.append('description', 'è¦‹ç©ã‚‚ã‚Šæ›¸é¡');

        const uploadBtn = $(fileInput).closest('.estimate-files-section').find('.upload-estimate-file-btn');
        uploadBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');

        $.ajax({
            url: '{% url "order_management:step_file_upload_ajax" project.pk %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success('ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                    }
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                    estimateFilesData.unshift(response.file);  // å…ˆé ­ã«è¿½åŠ 
                    renderEstimateFiles(estimateFilesData);
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (typeof toastr !== 'undefined') {
                    toastr.error(error);
                } else {
                    showErrorModal(error);
                }
            },
            complete: function() {
                uploadBtn.prop('disabled', false).html('<i class="fas fa-upload me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ');
                fileInput.value = '';
            }
        });
    });

    // ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤
    $(document).on('click', '.delete-estimate-file-btn', function() {
        const fileId = $(this).data('file-id');
        const fileItem = $(this).closest('.list-group-item');

        showConfirmModal('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', function() {

        $.ajax({
            url: '{% url "order_management:step_file_delete_ajax" project.pk 0 %}'.replace('/0/', `/${fileId}/`),
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            },
            success: function(response) {
                if (response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success(response.message);
                    }
                    // ãƒªã‚¹ãƒˆã‹ã‚‰å‰Šé™¤
                    fileItem.fadeOut(300, function() {
                        $(this).remove();
                        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒ0ä»¶ã«ãªã£ãŸã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                        if ($('.estimate-files-list .list-group-item').length === 0) {
                            $('.estimate-files-list').html('<small class="text-muted">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“</small>');
                        }
                    });

                    // ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                    estimateFilesData = estimateFilesData.filter(f => f.id !== fileId);
                }
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ';
                if (typeof toastr !== 'undefined') {
                    toastr.error(error);
                } else {
                    showErrorModal(error);
                }
            }
        });
        }); // showConfirmModal callbacké–‰ã˜æ‹¬å¼§
    });

    // å¥‘ç´„æ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="contract_date"]', function() {
        var step = $('.progress-step[data-step="contract"]');
        var dateValue = $(this).val();

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
            data: {
                contract_date: dateValue,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('ä¿å­˜æˆåŠŸ:', response);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                if (response && response.success) {
                    console.log('å¥‘ç´„æ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', dateValue);

                    // projectDataã‚’æ›´æ–°
                    projectData.contract_date = dateValue;

                    // UIã‚’æ›´æ–°
                    if (dateValue) {
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));

                        // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå·¥äº‹é–‹å§‹ï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                        var nextStep = $('.progress-step[data-step="work_start"]');
                        if (!nextStep.hasClass('completed')) {
                            nextStep.addClass('active');
                        }
                    } else {
                        step.removeClass('completed');
                        step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
                    }

                    // é€²æ—çŠ¶æ³å…¨ä½“ã‚’æ›´æ–°
                    updateProgressTimeline();
                    updateProgressStatus();
                    updateActiveStep();
                } else {
                    console.error('ä¿å­˜å¤±æ•—:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'å¥‘ç´„æ—¥ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    } else {
                        showErrorModal('å¥‘ç´„æ—¥ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                let errorMessage = 'å¥‘ç´„æ—¥ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                } else if (xhr.status === 403) {
                    errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                } else if (xhr.status === 404) {
                    errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (xhr.status >= 500) {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                } else {
                    showErrorModal(errorMessage);
                }
            }
        });
    });

    // è«‹æ±‚æ›¸ç™ºè¡Œã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="invoice_issued"], select[name="invoice_issued"]', function() {
        var step = $('.progress-step[data-step="invoice"]');
        if ($(this).val() === 'true') {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ç™ºè¡Œæ¸ˆã¿');
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('æœªç™ºè¡Œ');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å·¥äº‹é–‹å§‹æ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="work_start_date"]', function() {
        var step = $('.progress-step[data-step="work_start"]');
        var isCompleted = $('input[name="work_start_completed"]').is(':checked');
        var dateValue = $(this).val();

        if (isCompleted && dateValue) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ã§æ—¥ä»˜ã‚‚ã‚ã‚Œã°å®Œäº†
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
        } else if (dateValue) {
            // æ—¥ä»˜ã®ã¿ã®å ´åˆã¯äºˆå®šã¨ã—ã¦è¡¨ç¤º
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(dateValue));
        } else {
            // æ—¥ä»˜ãŒãªã„å ´åˆã¯æœªå®Œäº†
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å·¥äº‹é–‹å§‹å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="work_start_completed"]', function() {
        var step = $('.progress-step[data-step="work_start"]');
        var workStartDate = $('input[name="work_start_date"]').val();

        if ($(this).is(':checked')) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ã®å ´åˆ
            step.addClass('completed');
            if (workStartDate) {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(workStartDate));
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
            }

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå·¥äº‹çµ‚äº†ï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ•ã®å ´åˆ
            step.removeClass('completed');
            if (workStartDate) {
                // æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã¯äºˆå®šã¨ã—ã¦è¡¨ç¤º
                step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(workStartDate));
            } else {
                step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
            }
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å·¥äº‹çµ‚äº†æ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="work_end_date"]', function() {
        var step = $('.progress-step[data-step="work_end"]');
        var isCompleted = $('input[name="work_end_completed"]').is(':checked');
        var dateValue = $(this).val();

        if (isCompleted && dateValue) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ã§æ—¥ä»˜ã‚‚ã‚ã‚Œã°å®Œäº†
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
        } else if (dateValue) {
            // æ—¥ä»˜ã®ã¿ã®å ´åˆã¯äºˆå®šã¨ã—ã¦è¡¨ç¤º
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(dateValue));
        } else {
            // æ—¥ä»˜ãŒãªã„å ´åˆã¯æœªå®Œäº†
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å·¥äº‹çµ‚äº†å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="work_end_completed"]', function() {
        var step = $('.progress-step[data-step="work_end"]');
        var workEndDate = $('input[name="work_end_date"]').val();

        if ($(this).is(':checked')) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ã®å ´åˆ
            step.addClass('completed');
            if (workEndDate) {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(workEndDate));
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
            }

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè«‹æ±‚æ›¸ç™ºè¡Œï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ•ã®å ´åˆ
            step.removeClass('completed');
            if (workEndDate) {
                // æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã¯äºˆå®šã¨ã—ã¦è¡¨ç¤º
                step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(workEndDate));
            } else {
                step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
            }
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å®Œäº†å ±å‘Šãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‡¦ç†
    $(document).on('change', '#completionReportFileInput', function() {
        const fileInput = this;
        const file = fileInput.files[0];

        if (!file) {
            console.log('ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
            return;
        }

        console.log('å®Œäº†å ±å‘Šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­:', file.name);

        // FormDataã‚’ä½¿ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é€ä¿¡
        const formData = new FormData();
        formData.append('completion_report_file', file);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
        formData.append('ajax_save', 'true');

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: formData,
            processData: false,  // FormDataã‚’ä½¿ã†å ´åˆã¯å¿…é ˆ
            contentType: false,  // FormDataã‚’ä½¿ã†å ´åˆã¯å¿…é ˆ
            success: function(response) {
                console.log('ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸ:', response);
                if (response && response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success('å®Œäº†å ±å‘Šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                    } else {
                        showErrorModal('å®Œäº†å ±å‘Šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                    }
                    // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
                    setTimeout(function() {
                        location.reload();
                    }, 500);
                } else {
                    console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    } else {
                        showErrorModal('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                } else {
                    showErrorModal('ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
        });
    });

    // å®Œäº†å ±å‘Šå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†
    $(document).on('change', '#completion_report_completed', function() {
        const isChecked = $(this).is(':checked');
        console.log('å®Œäº†å ±å‘Šå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', isChecked);

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',
            data: {
                completion_report_completed: isChecked ? 'on' : '',
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('ä¿å­˜æˆåŠŸ:', response);
                if (response && response.success) {
                    if (typeof toastr !== 'undefined') {
                        toastr.success('å®Œäº†å ±å‘Šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                    }
                    // é€²æ—çŠ¶æ³ã‚’æ›´æ–°
                    updateProgressTimeline();
                    updateProgressStatus();
                } else {
                    console.error('ä¿å­˜å¤±æ•—:', response);
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error);
                }
            }
        });
    });

    // === å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†æ©Ÿèƒ½ ===

    // å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹å¤‰æ›´ã‚’ç›£è¦–ã—ã¦å³åº§ã«ä¿å­˜
    $(document).on('change', 'input[name$="_date"], input[name$="_completed"], input[name$="_value"]', function() {
        const inputName = $(this).attr('name');
        const stepName = inputName.replace(/_date$|_completed$|_value$/, '');
        const step = $('.progress-step[data-step="' + stepName + '"]');

        if (!step.length) return;

        // ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
        updateStepStatus(step, $(this));
    });

    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name^="dynamic_field_"], select[name^="dynamic_field_"], textarea[name^="dynamic_field_"]', function() {
        const fieldName = $(this).attr('name');
        // dynamic_field_attendance_scheduled_date -> attendance
        const stepKey = fieldName.replace(/^dynamic_field_/, '').split('_')[0];
        const $step = $(`.progress-step[data-step="${stepKey}"]`);

        // ä¿å­˜çŠ¶æ…‹ã‚’è¡¨ç¤º
        showSavingStatus('saving');

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆè¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
        const fieldValue = $(this).is(':checkbox') ? $(this).is(':checked') : $(this).val();
        const data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ajax_save: 'true'
        };
        data[fieldName] = fieldValue;

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
            data: data,
            success: function(response) {
                console.log('ä¿å­˜æˆåŠŸ:', response);

                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                if (response && response.success) {
                    console.log('è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', fieldName, fieldValue);

                    // ä¿å­˜æˆåŠŸã‚’è¡¨ç¤º
                    showSavingStatus('saved');

                    // ä¿å­˜æˆåŠŸå¾Œã«UIã‚’æ›´æ–°
                    if ($step.length > 0) {
                        // availableStepsã‹ã‚‰è©²å½“ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã‚’å–å¾—
                        const stepData = availableSteps.find(s => s.key === stepKey);

                        if (stepData && stepData.type === 'complex') {
                            // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å†è¨ˆç®—
                            const status = getComplexStepStatus(stepData, $step);

                            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ /å‰Šé™¤
                            if (status.completed) {
                                $step.addClass('completed');
                                $step.removeClass('active');
                            } else {
                                $step.removeClass('completed');
                            }

                            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                            $step.find('.progress-step-date').html(status.statusText);

                            // é€²æ—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¨çŠ¶æ³ãƒãƒ¼ã‚’æ›´æ–°
                            updateProgressTimeline();
                            updateProgressStatus();

                            console.log(`Updated complex step ${stepKey}:`, status);
                        }
                    }
                } else {
                    console.error('ä¿å­˜å¤±æ•—:', response);
                    showSavingStatus('error');
                    if (typeof toastr !== 'undefined') {
                        toastr.error(response.message || 'è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                    field: fieldName,
                    status: status,
                    error: error,
                    responseText: xhr.responseText,
                    statusCode: xhr.status
                });

                // ä¿å­˜ã‚¨ãƒ©ãƒ¼ã‚’è¡¨ç¤º
                showSavingStatus('error');

                let errorMessage = 'è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                if (xhr.responseJSON && xhr.responseJSON.message) {
                    errorMessage = xhr.responseJSON.message;
                } else if (xhr.status === 0) {
                    errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                } else if (xhr.status === 403) {
                    errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                } else if (xhr.status === 404) {
                    errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                } else if (xhr.status >= 500) {
                    errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                }

                if (typeof toastr !== 'undefined') {
                    toastr.error(errorMessage);
                }
            }
        });
    });

    // ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã®æ›´æ–°
    function updateStepStatus(step, input) {
        const inputName = input.attr('name');
        const value = input.val();
        const isChecked = input.is(':checked');
        const stepKey = step.data('step');

        // å³å´ã®è¡¨ç¤ºæ›´æ–°
        if (inputName.includes('actual_date') && value) {
            // å®Ÿæ–½æ—¥ã®å ´åˆã¯ã€Œå®Œäº†ã€
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(value));
        } else if (inputName.includes('issued_date') && value) {
            // ç™ºè¡Œæ—¥ã®å ´åˆã‚‚ã€Œå®Œäº†ã€
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(value));
        } else if (inputName.includes('scheduled_date') && value) {
            // äºˆå®šæ—¥ã®å ´åˆã¯ã€Œäºˆå®šã€
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(value));
        } else if (inputName.endsWith('_completed') && isChecked) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
        } else if (inputName.endsWith('_value') && value) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + value);
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
        }

        // é€²æ—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚‚æ›´æ–°
        updateProgressTimeline();
        // é€²æ—çŠ¶æ³ãƒãƒ¼ã‚‚æ›´æ–°
        updateProgressStatus();
    }


    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
    function formatDate(dateString) {
        if (!dateString || dateString === 'undefined' || dateString === undefined) return 'æ—¥ä»˜æœªè¨­å®š';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'æ—¥ä»˜æœªè¨­å®š';
            // æ—¥æœ¬èªå½¢å¼ã§æœˆ/æ—¥ã‚’è¡¨ç¤º
            return date.toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
        } catch (e) {
            return 'æ—¥ä»˜æœªè¨­å®š';
        }
    }

    // é€²æ—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateProgressTimeline() {
        const timeline = $('#progressTimeline');
        timeline.empty();

        // å³å´ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ç›´æ¥æƒ…å ±ã‚’å–å¾—
        const currentSteps = [];

        // activeStepså†…ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å·¦å´ã«è¡¨ç¤º
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');
            const isCompleted = $step.hasClass('completed');

            // ã‚¹ãƒ†ãƒƒãƒ—åã‚’å–å¾—ï¼ˆ.progress-step-labelã‚¯ãƒ©ã‚¹ã‹ã‚‰ç›´æ¥å–å¾—ï¼‰
            const stepNameElement = $step.find('.progress-step-label');
            let stepName = stepNameElement.text().trim();

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const statusElement = $step.find('.progress-step-date');
            let statusText = null;
            if (statusElement.length > 0) {
                const statusContent = statusElement.text().trim();
                if (statusContent && statusContent !== 'æœªå®Œäº†' && statusContent !== 'æœªè¨­å®š') {
                    // å®Œäº†ã€äºˆå®šã€é–‹å§‹ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä¿æŒã—ãŸã¾ã¾å–å¾—
                    statusText = statusContent;
                }
            }

            currentSteps.push({
                key: stepKey,
                name: stepName,
                completed: isCompleted,
                statusText: statusText
            });
        });

        // ä»¥ä¸‹ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ - å³å´ã‹ã‚‰ç›´æ¥èª­ã¿å–ã‚‹ãŸã‚ä¸è¦
        /*
        // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ï¼ˆç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä½¿ç”¨ï¼‰
        const basicSteps = [
        */

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰
        let previousCompleted = true;
        currentSteps.forEach(step => {
            // ã‚¹ãƒ†ãƒƒãƒ—åãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
            if (!step.name || step.name === 'undefined' || step.name === undefined) {
                console.warn('Skipping timeline item with invalid name:', step);
                return;
            }

            // ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹ã‚’åˆ¤å®š
            let statusClass = '';
            const stepElement = $(`.progress-step[data-step="${step.key}"]`);

            if (stepElement.length > 0) {
                // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã‚’ç¢ºèª
                const scheduledDate = stepElement.find(`input[name*="scheduled_date"]`).val();
                const actualDate = stepElement.find(`input[name*="actual_date"]`).val();
                const completedCheckbox = stepElement.find(`input[name*="completed"]`).is(':checked');
                const issuedDate = stepElement.find(`input[name*="issued_date"]`).val();
                const notRequired = stepElement.find(`input[name*="not_required"]`).is(':checked');

                // çŠ¶æ…‹ã®å„ªå…ˆé †ä½: verified > completed > scheduled > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                if (completedCheckbox) {
                    // å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š â†’ æ¿ƒã„ç·‘
                    statusClass = 'verified';
                } else if (actualDate || issuedDate || notRequired) {
                    // å®Œäº†æ—¥ã¾ãŸã¯ç™ºè¡Œæ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ â†’ ç·‘
                    statusClass = 'completed';
                } else if (scheduledDate) {
                    // äºˆå®šæ—¥ã®ã¿å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ â†’ é»„è‰²
                    statusClass = 'scheduled';
                } else if (step.completed) {
                    // å³å´ã§ completed ã‚¯ãƒ©ã‚¹ãŒã¤ã„ã¦ã„ã‚‹ â†’ ç·‘
                    statusClass = 'completed';
                }
                // ãã‚Œä»¥å¤–ï¼ˆä½•ã‚‚å…¥åŠ›ãªã—ï¼‰ â†’ ã‚°ãƒ¬ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¹ãªã—ï¼‰
            } else {
                // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å¾“æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯
                const isCompleted = step.completed;
                if (isCompleted) {
                    statusClass = 'completed';
                }
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã‚’æ±ºå®šï¼ˆäºˆå®šã¯é»„è‰²ã€å®Œäº†ã¯ç·‘ï¼‰
            let statusColor = 'text-success';
            if (step.statusText && step.statusText.includes('äºˆå®š:')) {
                statusColor = 'text-warning';
            }
            const statusHtml = step.statusText ?
                `<small class="${statusColor} d-block">${step.statusText}</small>` : '';

            timeline.append(`
                <div class="timeline-item ${statusClass}">
                    <strong>${step.name}</strong>
                    ${statusHtml}
                </div>
            `);

            if (statusClass === 'completed' || statusClass === 'verified') {
                previousCompleted = true;
            } else {
                previousCompleted = false;
            }
        });
    }

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆæœ€åˆã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ï¼‰
    function updateActiveStep() {
        // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        $('#activeSteps .progress-step').removeClass('active');

        // æœ€åˆã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¦‹ã¤ã‘ã¦activeã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
        let foundFirstIncomplete = false;
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            if (!foundFirstIncomplete && !$step.hasClass('completed')) {
                $step.addClass('active');
                foundFirstIncomplete = true;
            }
        });
    }

    // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    function updateAllStepStatuses() {
        $('.progress-step[data-step]').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');

            // availableStepsã‹ã‚‰è©²å½“ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã‚’å–å¾—
            const stepData = availableSteps.find(s => s.key === stepKey);

            if (stepData && stepData.type === 'complex') {
                // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—
                const status = getComplexStepStatus(stepData, $step);

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                if (status.completed) {
                    $step.addClass('completed');
                } else {
                    $step.removeClass('completed');
                }

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                $step.find('.progress-step-date').html(status.statusText);
            }
        });
    }

    // é€²æ—çŠ¶æ³ãƒãƒ¼ã¨ãƒ•ã‚§ãƒ¼ã‚ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆå‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†å¯¾å¿œï¼‰
    function updateNextActionAndStep(phase, allSteps) {
        let nextAction = 'å®Œäº†';

        // å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ ã‚’å–å¾—ï¼ˆè¡¨ç¤ºé †åºé †ï¼‰
        const stepElements = $('#activeSteps .progress-step');

        // æœªå®Œäº†ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¦‹ã¤ã‘ã‚‹
        let currentIncompleteStep = null;

        stepElements.each(function() {
            const $step = $(this);
            let isCompleted = $step.hasClass('completed');
            const stepName = $step.find('.progress-step-label').text().trim();
            const stepKey = $step.data('step');

            // Special handling for estimate step - check estimate_not_required checkbox
            if (stepKey === 'estimate' && !isCompleted) {
                const estimateNotRequired = $step.find('#estimateNotRequired').is(':checked');
                const estimateIssuedDate = $step.find('input[name="estimate_issued_date"]').val();
                if (estimateNotRequired || estimateIssuedDate) {
                    isCompleted = true;
                    // Make sure the step has the completed class
                    if (!$step.hasClass('completed')) {
                        $step.addClass('completed');
                        $step.removeClass('active');
                    }
                }
            }

            // æœ€åˆã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã‚’æ¢ã™
            if (!isCompleted && !currentIncompleteStep) {
                currentIncompleteStep = {
                    element: $step,
                    name: stepName,
                    key: stepKey
                };
            }
        });

        // ç¾åœ¨ã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®š
        if (currentIncompleteStep) {
            const $currentStep = currentIncompleteStep.element;
            const stepName = currentIncompleteStep.name;

            // äºˆå®šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
            const scheduledDateInput = $currentStep.find('input[name*="scheduled_date"]');
            const actualDateInput = $currentStep.find('input[name*="actual_date"]');
            const completedCheckbox = $currentStep.find('input[type="checkbox"][name*="completed"]');

            const hasScheduledDate = scheduledDateInput.length > 0 && scheduledDateInput.val();
            const hasActualDate = actualDateInput.length > 0 && actualDateInput.val();
            const isChecked = completedCheckbox.length > 0 && completedCheckbox.is(':checked');

            // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤å®š
            if (completedCheckbox.length > 0 && !isChecked) {
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆ
                if (hasActualDate) {
                    nextAction = `${stepName}ï¼šå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„`;
                } else if (hasScheduledDate) {
                    // äºˆå®šæ—¥ãŒéå»ã‹æœªæ¥ã‹ã‚’ãƒã‚§ãƒƒã‚¯
                    const scheduledDate = scheduledDateInput.val();
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const scheduledDateObj = new Date(scheduledDate);

                    if (scheduledDateObj < today) {
                        // äºˆå®šæ—¥ãŒéå»ã®å ´åˆã¯å®Œäº†ã¨è¦‹ãªã™
                        nextAction = `${stepName}ï¼šå®Œäº†`;
                    } else {
                        // äºˆå®šæ—¥ãŒæœªæ¥ã®å ´åˆã¯å¾…æ©Ÿä¸­
                        nextAction = `${stepName}ï¼šäºˆå®šæ—¥å¾…ã¡ï¼ˆ${scheduledDate}ï¼‰`;
                    }
                } else {
                    nextAction = `${stepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                }
            } else if (actualDateInput.length > 0 && !hasActualDate) {
                // å®Ÿæ–½æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆ
                if (hasScheduledDate) {
                    nextAction = `${stepName}ï¼šå®Ÿæ–½æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                } else {
                    nextAction = `${stepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                }
            } else if (scheduledDateInput.length > 0 && !hasScheduledDate) {
                // äºˆå®šæ—¥ã®ã¿ã®å ´åˆ
                nextAction = `${stepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
            } else {
                // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—
                nextAction = `${stepName}ï¼šå…¥åŠ›ã—ã¦ãã ã•ã„`;
            }

        }

        // UIã‚’æ›´æ–°ï¼ˆãƒãƒƒã‚¸å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
        $('#nextActionText').html(formatNextActionWithBadge(nextAction));

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ã‚«ãƒ¼ãƒ‰å†…ã®Next Actionã‚‚æ›´æ–°
        $('#overallNextAction').html(formatNextActionWithBadge(nextAction));

        console.log('ğŸ“Œ Next Action updated:', {
            action: nextAction,
            currentStep: currentIncompleteStep ? currentIncompleteStep.name : 'none'
        });
    }

    // Next Actionã‚’ãƒãƒƒã‚¸å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
    function formatNextActionWithBadge(value) {
        if (!value || value === 'å®Œäº†' || value === '-' || !value.includes('ï¼š')) {
            return value;
        }

        const parts = value.split('ï¼š');
        const stepName = parts[0];
        const action = parts.slice(1).join('ï¼š'); // è¤‡æ•°ã®ã€Œï¼šã€ãŒã‚ã‚‹å ´åˆã«å¯¾å¿œ

        return `<span class="badge bg-white border text-dark me-1" style="font-size: 0.65rem;">${stepName}</span>${action}`;
    }

    // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ã‚«ãƒ¼ãƒ‰å†…ã®å…¨ä½“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
    function updateOverallProgressBar(completedSteps, totalSteps, percentage, phase, color) {
        console.log(`ğŸ“Š Updating overall progress bar: ${completedSteps}/${totalSteps} = ${percentage}% | Phase: ${phase} (${color})`);

        // NGæ¡ˆä»¶ã®å ´åˆã¯ç‰¹åˆ¥è¡¨ç¤º
        if (phase === 'NG') {
            $('#overallProgressBar').css('width', '100%');
            $('#overallProgressText').text('NG');
            $('#overallProgressBar').removeClass('bg-danger bg-warning bg-info bg-success bg-verified').addClass('bg-secondary');
            $('#overallPhase').text('NG').removeClass().addClass('badge bg-secondary').css('font-size', '0.6rem');
            $('#overallStepCount').text(''); // ã‚«ã‚¦ãƒ³ãƒˆéè¡¨ç¤º
            return;
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®å¹…ã‚’æ›´æ–°
        $('#overallProgressBar').css('width', `${percentage}%`);

        // ãƒ†ã‚­ã‚¹ãƒˆè¡¨ç¤ºã‚’æ›´æ–°ï¼ˆã€Œå®Œäº†æ•°/ç·æ•°ã€å½¢å¼ï¼‰
        $('#overallProgressText').text(`${completedSteps}/${totalSteps}`);

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è‰²ã‚’å¤‰æ›´ï¼ˆé€²æ—ç‡ã«å¿œã˜ã¦ï¼‰
        $('#overallProgressBar').removeClass('bg-danger bg-warning bg-info bg-success bg-verified bg-secondary');
        if (percentage === 100) {
            $('#overallProgressBar').addClass('bg-success');
        } else if (percentage >= 70) {
            $('#overallProgressBar').addClass('bg-info');
        } else if (percentage >= 40) {
            $('#overallProgressBar').addClass('bg-warning');
        } else if (percentage > 0) {
            $('#overallProgressBar').addClass('bg-warning');
        } else {
            $('#overallProgressBar').addClass('bg-secondary');
        }

        // ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆé€²æ—çŠ¶æ³ï¼‰ã‚’æ›´æ–°
        $('#overallPhase').text(phase).removeClass().addClass(`badge bg-${color}`).css('font-size', '0.6rem');

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°
        $('#overallStepCount').text(`${completedSteps}/${totalSteps}`);
    }

    function updateProgressStatus() {
        // NGæ¡ˆä»¶ã®å ´åˆã¯ç‰¹åˆ¥è¡¨ç¤º
        if (projectStatus === 'NG') {
            console.log('NGæ¡ˆä»¶ã®ãŸã‚ã€NGè¡¨ç¤ºã‚’è¨­å®šã—ã¾ã™');
            updateOverallProgressBar(0, 5, 0, 'NG', 'secondary');
            return;
        }

        // å³å´ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ç›´æ¥å®Œäº†çŠ¶æ³ã‚’å–å¾—
        const allSteps = [];

        // activeStepså†…ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒ£ãƒ³
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');
            const isCompleted = $step.hasClass('completed');
            console.log(`ğŸ” Progress check - ${stepKey}: completed=${isCompleted}, has class=${$step.hasClass('completed')}`);
            allSteps.push({ key: stepKey, completed: isCompleted });
        });

        // å®Œäº†ç‡è¨ˆç®—
        const completedSteps = allSteps.filter(step => step.completed).length;
        const totalSteps = allSteps.length;
        const percentage = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

        console.log(`ğŸ“Š Progress calculation: ${completedSteps}/${totalSteps} = ${percentage}%`);
        console.log('All steps:', allSteps);

        // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¤å®šï¼ˆget_current_project_stage()ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        let phase = 'æœªé–‹å§‹';
        let color = 'secondary';

        // å®Œå·¥æ—¥ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæœ€å„ªå…ˆï¼‰
        const completionElement = $('.progress-step[data-step="completion"]');
        const completionCompleted = completionElement.find('input[name*="completed"]').is(':checked');
        const completionActualDate = completionElement.find('input[name*="actual_date"]').val();
        const workEndDate = $('input[name="work_end_date"]').val();

        // Priority 1: Check if completion step has 'completed' class or checkbox is checked
        if (completionElement.hasClass('completed') || completionCompleted || $('#workEndCompleted').is(':checked')) {
            phase = 'å®Œå·¥';
            color = 'verified';
        }
        // Priority 2: Check if completion actual date or work end date is filled
        else if (completionActualDate || workEndDate) {
            phase = 'å®Œå·¥';
            color = 'success';
        }
        // ç€å·¥æ—¥ã‚’ãƒã‚§ãƒƒã‚¯
        else {
            const constructionElement = $('.progress-step[data-step="construction_start"]');
            const constructionCompleted = $('#workStartCompleted').is(':checked');
            const constructionActualDate = constructionElement.find('input[name*="actual_date"]').val();
            const constructionScheduledDate = constructionElement.find('input[name*="scheduled_date"]').val() || $('input[name="work_start_date"]').val();

            if (constructionCompleted) {
                phase = 'å·¥äº‹ä¸­';
                color = 'verified';
            } else if (constructionActualDate) {
                phase = 'å·¥äº‹ä¸­';
                color = 'success';
            } else if (constructionScheduledDate) {
                // Check if scheduled date is in the past
                const today = new Date();
                today.setHours(0, 0, 0, 0); // Reset time to midnight for date-only comparison
                const scheduledDate = new Date(constructionScheduledDate);

                if (scheduledDate < today) {
                    // Past scheduled date - should be in progress
                    phase = 'å·¥äº‹ä¸­ã®äºˆå®š';
                    color = 'success';
                } else {
                    // Future scheduled date - waiting
                    phase = 'ç€å·¥æ—¥å¾…ã¡';
                    color = 'warning';
                }
            }
            // è¦‹ç©ã‚‚ã‚Šã‚’ãƒã‚§ãƒƒã‚¯
            else {
                const estimateIssuedDate = $('input[name="estimate_issued_date"]').val();
                const estimateNotRequired = $('#estimateNotRequired').is(':checked');

                if (estimateIssuedDate) {
                    phase = 'è¦‹ç©ã‚‚ã‚Šå¯©æŸ»ä¸­';
                    color = 'warning';
                } else {
                    // è¦‹ç©æ›¸ç™ºè¡Œæ—¥ãŒãªã„å ´åˆã®ã¿ã€å‰ã®å·¥ç¨‹ã‚’ãƒã‚§ãƒƒã‚¯
                    // ç¾èª¿ã‚’ãƒã‚§ãƒƒã‚¯
                    const surveyElement = $('.progress-step[data-step="survey"]');
                    const surveyActualDate = surveyElement.find('input[name*="actual_date"]').val();
                    const surveyScheduledDate = surveyElement.find('input[name*="scheduled_date"]').val();
                    const surveyCompleted = surveyElement.find('input[name*="completed"]').is(':checked');

                    // Check if scheduled date is in the past
                    let isSurveyScheduledPast = false;
                    if (surveyScheduledDate) {
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        const scheduledDate = new Date(surveyScheduledDate);
                        isSurveyScheduledPast = scheduledDate < today;
                    }

                    if (surveyActualDate || surveyCompleted || isSurveyScheduledPast) {
                        phase = 'ç¾èª¿æ¸ˆã¿';
                        color = 'success';
                    } else if (surveyScheduledDate) {
                        phase = 'ç¾èª¿å¾…ã¡';
                        color = 'warning';
                    } else {
                        // ç«‹ã¡ä¼šã„ã‚’ãƒã‚§ãƒƒã‚¯
                        const attendanceElement = $('.progress-step[data-step="attendance"]');
                        const attendanceActualDate = attendanceElement.find('input[name*="actual_date"]').val();
                        const attendanceScheduledDate = attendanceElement.find('input[name*="scheduled_date"]').val();
                        const attendanceCompleted = attendanceElement.find('input[name*="completed"]').is(':checked');

                        // Check if scheduled date is in the past
                        let isScheduledPast = false;
                        if (attendanceScheduledDate) {
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            const scheduledDate = new Date(attendanceScheduledDate);
                            isScheduledPast = scheduledDate < today;
                        }

                        if (attendanceActualDate || attendanceCompleted || isScheduledPast) {
                            phase = 'ç«‹ã¡ä¼šã„æ¸ˆã¿';
                            color = 'success';
                        } else if (attendanceScheduledDate) {
                            phase = 'ç«‹ã¡ä¼šã„å¾…ã¡';
                            color = 'warning';
                        } else {
                            phase = 'æœªé–‹å§‹';
                            color = 'secondary';
                        }
                    }
                }
            }
        }

        // UIæ›´æ–°
        $('#progressPhase').text(phase).removeClass().addClass(`text-${color}`);
        $('#progressBar').removeClass().addClass(`progress-bar bg-${color}`).css('width', `${percentage}%`).attr('aria-valuenow', percentage);
        $('#progressPercentage').text(`${completedSteps}/${totalSteps}`);
        $('#progressStatusCard').removeClass().addClass(`card progress-status-card border-${color}`);
        $('#progressStatusHeader').removeClass().addClass(`card-header bg-${color} text-white`);

        // ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç†ã‚«ãƒ¼ãƒ‰å†…ã®å…¨ä½“ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’æ›´æ–°
        updateOverallProgressBar(completedSteps, totalSteps, percentage, phase, color);

        // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨NEXTã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°
        updateNextActionAndStep(phase, allSteps);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é€²æ—çŠ¶æ³ã‚’ä¿å­˜
        saveProjectStage(phase, color);
    }

    // é€²æ—çŠ¶æ³ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
    var saveStageTimeout;
    function saveProjectStage(stage, color) {
        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼šé€£ç¶šã—ãŸå‘¼ã³å‡ºã—ã‚’500msé…å»¶
        clearTimeout(saveStageTimeout);
        saveStageTimeout = setTimeout(function() {
            $.ajax({
                url: '{% url "order_management:update_project_stage" project.pk %}',
                method: 'POST',
                dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
                data: {
                    stage: stage,
                    color: color,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('ä¿å­˜æˆåŠŸ:', response);

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                    if (response && response.success) {
                        console.log('é€²æ—çŠ¶æ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', stage);
                    } else {
                        console.error('ä¿å­˜å¤±æ•—:', response);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });

                    let errorMessage = 'é€²æ—çŠ¶æ³ã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                    } else if (xhr.status === 403) {
                        errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                    } else if (xhr.status === 404) {
                        errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    } else if (xhr.status >= 500) {
                        errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                    }

                    console.error(errorMessage);
                }
            });
        }, 500);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã‚’åŒæœŸ
    function syncFormFieldsToSteps() {
        console.log('Syncing form fields to steps');

        // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
        const fieldsToCheck = [
            { field: 'estimate_issued_date', step: 'estimate' },
            { field: 'contract_date', step: 'contract' },
            { field: 'work_start_date', step: 'work_start' },
            { field: 'work_end_date', step: 'work_end' }
        ];

        fieldsToCheck.forEach(({ field, step }) => {
            const input = $(`input[name="${field}"]`);
            const stepElement = $(`.progress-step[data-step="${step}"]`);

            if (input.length && stepElement.length) {
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’èª­ã¿å–ã£ã¦ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã‚’æ›´æ–°
                const inputValue = input.val();
                console.log(`Syncing ${field}: ${inputValue}`);

                if (inputValue) {
                    // å·¥äº‹é–‹å§‹ãƒ»å·¥äº‹å®Œäº†ã¯ç‰¹åˆ¥å‡¦ç†
                    if (step === 'work_start' || step === 'work_end') {
                        const completedCheckbox = $(`input[name="${step}_completed"]`);
                        const isCompleted = completedCheckbox.is(':checked');

                        if (isCompleted) {
                            stepElement.addClass('completed');
                            stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(inputValue));
                        } else {
                            stepElement.removeClass('completed');
                            stepElement.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(inputValue));
                        }
                    } else {
                        updateStepStatus(stepElement, input);
                    }
                } else if (step === 'work_start' || step === 'work_end') {
                    // æ—¥ä»˜ãŒãªã„ãŒã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆã®å‡¦ç†
                    const completedCheckbox = $(`input[name="${step}_completed"]`);
                    const isCompleted = completedCheckbox.is(':checked');

                    if (isCompleted) {
                        stepElement.addClass('completed');
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
                    } else {
                        stepElement.removeClass('completed');
                        stepElement.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
                    }
                }
            }
        });

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒã‚§ãƒƒã‚¯
        const checkboxFields = [
            { field: 'estimate_not_required', step: 'estimate' },
            { field: 'work_start_completed', step: 'work_start' },
            { field: 'work_end_completed', step: 'work_end' },
            { field: 'invoice_issued', step: 'invoice' }
        ];

        checkboxFields.forEach(({ field, step }) => {
            const input = $(`input[name="${field}"]`);
            const stepElement = $(`.progress-step[data-step="${step}"]`);

            if (input.length && stepElement.length && input.is(':checked')) {
                console.log(`Syncing checkbox ${field}: checked`);

                // è¦‹ç©æ›¸ä¸è¦ãƒ»å·¥äº‹é–‹å§‹ãƒ»å·¥äº‹å®Œäº†ã¯ç‰¹åˆ¥å‡¦ç†
                if (step === 'estimate' && field === 'estimate_not_required') {
                    stepElement.addClass('completed');
                    stepElement.find('.progress-step-date').html('<i class="fas fa-times-circle me-1"></i>è¦‹ç©ä¸è¦');
                } else if (step === 'work_start' || step === 'work_end') {
                    const dateInput = $(`input[name="${step}_date"]`);
                    const dateValue = dateInput.val();

                    stepElement.addClass('completed');
                    if (dateValue) {
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
                    } else {
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
                    }
                } else {
                    updateStepStatus(stepElement, input);
                }
            }
        });

        // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’è¨­å®š
        if (complexStepFields && typeof complexStepFields === 'object') {
            console.log('Setting complex step field values:', complexStepFields);
            Object.keys(complexStepFields).forEach(fieldName => {
                const fieldValue = complexStepFields[fieldName];
                // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œç´¢
                const fieldElement = $(`[name="dynamic_field_${fieldName}"]`);

                if (fieldElement.length > 0) {
                    if (fieldElement.is(':checkbox') || fieldElement.is(':radio')) {
                        if (fieldValue === 'true' || fieldValue === fieldElement.val()) {
                            fieldElement.prop('checked', true);
                        }
                    } else {
                        fieldElement.val(fieldValue);
                    }
                    console.log(`Set field dynamic_field_${fieldName} to ${fieldValue}`);
                }
            });

            // ä¾å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
            $('input[type="radio"]:checked').trigger('change');

            // å„è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            $('.progress-step[data-step]').each(function() {
                const $step = $(this);
                const stepKey = $step.data('step');

                // availableStepsã‹ã‚‰è©²å½“ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã‚’å–å¾—
                const stepData = availableSteps.find(s => s.key === stepKey);

                if (stepData && stepData.type === 'complex') {
                    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—
                    const status = getComplexStepStatus(stepData, $step);

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                    if (status.completed) {
                        $step.addClass('completed');
                    } else {
                        $step.removeClass('completed');
                    }

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                    $step.find('.progress-step-date').html(status.statusText);

                    console.log(`Updated status for ${stepKey}:`, status);
                }
            });
        }

        console.log('Form field sync complete');
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã«ã‚¹ãƒ†ãƒƒãƒ—é †åºã¨ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜
    $('form').on('submit', function(e) {
        console.log('=== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–‹å§‹ ===');
        saveStepOrder();
        collectDynamicFieldData();

        // ãƒ‡ãƒãƒƒã‚°: é€ä¿¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        const formData = $(this).serializeArray();
        const dynamicFields = formData.filter(item => item.name.startsWith('dynamic_field_'));
        console.log('é€ä¿¡ã•ã‚Œã‚‹ dynamic_field_ ã®æ•°:', dynamicFields.length);
        console.log('dynamic_field_ ãƒ‡ãƒ¼ã‚¿:', dynamicFields);

        // ç¢ºèªã®ãŸã‚ä¸€æ™‚åœæ­¢ï¼ˆæœ¬ç•ªã§ã¯å‰Šé™¤ã—ã¦ãã ã•ã„ï¼‰
        // e.preventDefault();
        // showErrorModal(`${dynamicFields.length} å€‹ã®dynamic_field_ã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
    });

    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«è¿½åŠ 
    function collectDynamicFieldData() {
        console.log('Collecting dynamic field data...');

        // ã¾ãšå€¤ã‚’åé›†ï¼ˆå‰Šé™¤ã™ã‚‹å‰ã«ï¼‰
        const collectedData = [];

        // å„è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã‚’åé›†
        $('.progress-step[data-step]').each(function() {
            const stepKey = $(this).data('step');
            const stepElement = $(this);

            // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
            stepElement.find('input, select, textarea').each(function() {
                const fieldElement = $(this);
                const fieldName = fieldElement.attr('name');

                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!fieldName) return;

                // dynamic_field_ã§å§‹ã¾ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å‡¦ç†
                if (!fieldName.startsWith('dynamic_field_')) return;

                let fieldValue;

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å ´åˆ
                if (fieldElement.is(':checkbox')) {
                    fieldValue = fieldElement.is(':checked') ? 'true' : 'false';
                } else if (fieldElement.is(':radio')) {
                    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
                    if (!fieldElement.is(':checked')) return;
                    fieldValue = fieldElement.val();
                } else if (fieldElement.is('select[multiple]')) {
                    // è¤‡æ•°é¸æŠã®å ´åˆ
                    const selectedValues = fieldElement.val();
                    if (selectedValues && selectedValues.length > 0) {
                        fieldValue = selectedValues.join(',');
                    } else {
                        fieldValue = '';
                    }
                } else {
                    fieldValue = fieldElement.val();
                }

                // å€¤ã‚’åé›†ï¼ˆç©ºã§ã‚‚åé›†ã—ã¦Noneã¨ã—ã¦é€ä¿¡ï¼‰
                collectedData.push({
                    name: fieldName,
                    value: fieldValue || ''
                });

                console.log(`Collected: ${fieldName} = ${fieldValue}`);
            });
        });

        // æ—¢å­˜ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ï¼ˆtype=hiddenã®ã¿ï¼‰
        $('input[type="hidden"][name^="dynamic_field_"]').remove();

        // åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆ
        collectedData.forEach(item => {
            const hiddenField = $('<input>', {
                type: 'hidden',
                name: item.name,
                value: item.value
            });
            $('form').append(hiddenField);
            console.log(`Added hidden field: ${item.name} = ${item.value}`);
        });

        console.log(`Dynamic field data collection complete. Collected ${collectedData.length} fields.`);
    }

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const orderedSteps = {{ ordered_steps_json|safe }};
    const dynamicSteps = {{ dynamic_steps_json|safe }};
    const complexStepFields = {{ complex_step_fields_json|safe }};

    console.log('=== Debug Info ===');
    console.log('orderedSteps:', orderedSteps);
    console.log('orderedSteps type:', typeof orderedSteps);
    console.log('orderedSteps length:', orderedSteps ? orderedSteps.length : 'null/undefined');
    if (orderedSteps && orderedSteps.length > 0) {
        orderedSteps.forEach((step, index) => {
            console.log(`orderedStep[${index}]:`, step);
            console.log(`  key: ${step.key} (type: ${typeof step.key})`);
            console.log(`  name: ${step.name} (type: ${typeof step.name})`);
        });
    }
    console.log('dynamicSteps:', dynamicSteps);
    const projectData = {
        estimate_issued_date: '{{ project.estimate_issued_date|date:"Y-m-d"|default:"" }}' || '',
        estimate_not_required: {% if project.estimate_not_required %}true{% else %}false{% endif %},
        estimate_notes: `{{ project.estimate_notes|escapejs }}`,
        contractor_estimate_amount: `{{ project.contractor_estimate_amount|escapejs }}`,
        contract_date: '{{ project.contract_date|date:"Y-m-d"|default:"" }}' || '',
        work_start_date: '{{ project.work_start_date|date:"Y-m-d"|default:"" }}' || '',
        work_start_completed: {% if project.work_start_completed %}true{% else %}false{% endif %},
        work_end_date: '{{ project.work_end_date|date:"Y-m-d"|default:"" }}' || '',
        work_end_completed: {% if project.work_end_completed %}true{% else %}false{% endif %},
        invoice_issued: {% if project.invoice_issued %}true{% else %}false{% endif %}
    };

    // ã‚¹ãƒ†ãƒƒãƒ—ã®åˆæœŸåŒ–
    function initializeSteps() {
        console.log('initializeSteps called');
        const container = $('#activeSteps');
        container.empty();

        try {
            // orderedStepsãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—
            if (orderedSteps && orderedSteps.length > 0) {
                console.log('Using ordered steps:', orderedSteps.length);
                orderedSteps.forEach((step, index) => {
                    const stepHtml = generateStepHtml(step);
                    if (stepHtml) {
                        container.append(stepHtml);
                    }
                });
            } else {
                console.log('Using default basic steps');
                // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç›´æ¥ç”Ÿæˆ
                container.append(generateEstimateStepHtml());

                // ç¾åœ°èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã¯ survey_required ãŒ true ã®å ´åˆã®ã¿è¿½åŠ 
                {% if project.survey_required %}
                    container.append(generateSurveyStepHtml());
                {% endif %}

                container.append(generateContractStepHtml());
                container.append(generateWorkStartStepHtml());
                container.append(generateWorkEndStepHtml());
                container.append(generateInvoiceStepHtml());
            }

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ­£ã—ãè¨­å®šï¼ˆæœ€åˆã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ï¼‰
            updateActiveStep();

            // é€²æ—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚‚æ›´æ–°ï¼ˆDOMè¦ç´ ãŒæº–å‚™ã•ã‚Œã¦ã‹ã‚‰ï¼‰
            setTimeout(() => {
                updateProgressTimeline();
                updateProgressStatus();

                // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡
                updateSurveyAreaVisibility();

                // å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å±•é–‹çŠ¶æ…‹ã§è¡¨ç¤º
                $('.progress-step').addClass('expanded');
                $('.progress-step-content').show();

                // äºˆå®šæ—¥è¶…éãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
                checkOverdueSteps();

                // è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–ï¼ˆDOMè¦ç´ ãŒç”Ÿæˆã•ã‚ŒãŸå¾Œï¼‰
                console.log('è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¦ç´ æ•°ï¼ˆåˆæœŸåŒ–å¾Œï¼‰:', $('#estimateNotRequired').length);
                console.log('è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸçŠ¶æ…‹ï¼ˆåˆæœŸåŒ–å¾Œï¼‰:', $('#estimateNotRequired').is(':checked'));
                if ($('#estimateNotRequired').length > 0) {
                    window.handleEstimateNotRequiredChange();
                }

                // ã‚·ãƒ³ãƒ—ãƒ«ãªæ—¥ä»˜ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆcontractç­‰ï¼‰ã®åˆæœŸå€¤ã‚’åæ˜ ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ï¼ˆattendance, survey, construction_start, completionï¼‰ã¯
                // getComplexStepStatusé–¢æ•°ã§æ—¢ã«å‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
                $('.progress-step').each(function() {
                    const $step = $(this);
                    const stepKey = $step.data('step');

                    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢ã«getComplexStepStatusã§å‡¦ç†æ¸ˆã¿ï¼‰
                    const complexSteps = ['attendance', 'survey', 'construction_start', 'completion'];
                    if (complexSteps.includes(stepKey)) {
                        return; // continue
                    }

                    // availableStepsã‹ã‚‰å®šç¾©ã‚’å–å¾—ã—ã¦typeã‚’ãƒã‚§ãƒƒã‚¯
                    const stepData = availableSteps.find(s => s.key === stepKey);
                    if (stepData && stepData.type === 'complex') {
                        return; // continue - è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—
                    }

                    // ã‚·ãƒ³ãƒ—ãƒ«ãªæ—¥ä»˜ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿å‡¦ç†
                    const $dateInput = $step.find('input[type="date"]');
                    if ($dateInput.length > 0 && $dateInput.val()) {
                        const dateValue = $dateInput.val();
                        $step.addClass('completed');
                        $step.removeClass('active');
                        $step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
                    }

                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚å‡¦ç†
                    const $checkbox = $step.find('input[type="checkbox"][name$="_completed"]');
                    if ($checkbox.length > 0 && $checkbox.is(':checked')) {
                        $step.addClass('completed');
                        $step.removeClass('active');
                        $step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†æ¸ˆã¿');
                    }
                });
            }, 50);

            console.log('Steps initialized:', container.children().length);
        } catch (error) {
            console.error('Error in initializeSteps:', error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¼·åˆ¶è¡¨ç¤º
            container.append(generateEstimateStepHtml());

            // ç¾åœ°èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã¯ survey_required ãŒ true ã®å ´åˆã®ã¿è¿½åŠ 
            {% if project.survey_required %}
                container.append(generateSurveyStepHtml());
            {% endif %}

            container.append(generateContractStepHtml());
            container.append(generateWorkStartStepHtml());
            container.append(generateWorkEndStepHtml());
            container.append(generateInvoiceStepHtml());
        }
    }

    // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡
    function updateSurveyAreaVisibility() {
        const surveyStep = $('.progress-step[data-step="survey"]');
        const surveyArea = $('#surveyContentArea');

        console.log('Survey step found:', surveyStep.length);
        console.log('Survey area element:', surveyArea.length);

        // survey_required ãƒ•ãƒ©ã‚°ã«åŸºã¥ã„ã¦è¡¨ç¤ºåˆ¶å¾¡
        {% if project.survey_required %}
            surveyArea.show();
            console.log('Survey area shown (survey_required=true)');
        {% else %}
            surveyArea.hide();
            console.log('Survey area hidden (survey_required=false)');
        {% endif %}
    }

    // ã‚¹ãƒ†ãƒƒãƒ—HTMLã‚’ç”Ÿæˆ
    function generateStepHtml(step) {
        // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const basicSteps = ['estimate', 'survey', 'contract', 'work_start', 'work_end', 'invoice'];
        const isBasicStep = basicSteps.includes(step.key);

        if (isBasicStep) {
            return generateStaticStepHtml(step);
        } else {
            // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰å®šç¾©ã‚’å–å¾—
            const stepDefinition = availableSteps.find(s => s.key === step.key);
            if (stepDefinition) {
                return generateAvailableStepHtml(stepDefinition);
            } else if (step.is_dynamic) {
                return generateDynamicStepHtml(step);
            } else {
                console.warn(`Unknown step: ${step.key}`);
                return '';
            }
        }
    }

    // å·¦å´è¡¨ç¤ºç”¨ã®ã‚¹ãƒ†ãƒƒãƒ—HTMLã‚’ç”Ÿæˆ
    function generateLeftDisplayStepHtml(step) {
        if (step.is_dynamic) {
            return generateLeftDisplayDynamicStepHtml(step);
        } else {
            return generateLeftDisplayStaticStepHtml(step);
        }
    }

    // å·¦å´è¡¨ç¤ºç”¨ - é™çš„ã‚¹ãƒ†ãƒƒãƒ—
    function generateLeftDisplayStaticStepHtml(step) {
        let stepName, stepIcon, isCompleted, statusHtml;

        switch (step.key) {
            case 'estimate':
                stepName = 'è¦‹ç©ä½œæˆ';
                stepIcon = 'fas fa-file-invoice';
                isCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;
                if (projectData.estimate_not_required) {
                    statusHtml = '<i class="fas fa-times-circle me-1"></i>è¦‹ç©ä¸è¦';
                } else if (projectData.estimate_issued_date) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.estimate_issued_date)}`;
                } else {
                    statusHtml = 'æœªå®Œäº†';
                }
                break;
            case 'contract':
                stepName = 'å¥‘ç´„';
                stepIcon = 'fas fa-handshake';
                isCompleted = projectData.contract_date;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.contract_date)}`;
                } else {
                    statusHtml = 'æœªå®Œäº†';
                }
                break;
            case 'work_start':
                stepName = 'å·¥äº‹é–‹å§‹';
                stepIcon = 'fas fa-play-circle';
                isCompleted = projectData.work_start_completed;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.work_start_date)}`;
                } else if (projectData.work_start_date) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(projectData.work_start_date)}`;
                } else {
                    statusHtml = 'æœªå®Œäº†';
                }
                break;
            case 'work_end':
                stepName = 'å·¥äº‹å®Œäº†';
                stepIcon = 'fas fa-check-circle';
                isCompleted = projectData.work_end_completed;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.work_end_date)}`;
                } else if (projectData.work_end_date) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(projectData.work_end_date)}`;
                } else {
                    statusHtml = 'æœªå®Œäº†';
                }
                break;
            case 'invoice':
                stepName = 'è«‹æ±‚æ›¸ç™ºè¡Œ';
                stepIcon = 'fas fa-file-invoice-dollar';
                isCompleted = projectData.invoice_issued;
                statusHtml = isCompleted ? '<i class="fas fa-check-circle me-1"></i>ç™ºè¡Œæ¸ˆã¿' : 'æœªç™ºè¡Œ';
                break;
            default:
                return '';
        }

        const completedClass = isCompleted ? 'completed' : '';

        return `
            <div class="progress-step ${completedClass}" data-step="${step.key}">
                <div class="progress-step-header">
                    <i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span>
                </div>
                <div class="progress-step-date">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // å·¦å´è¡¨ç¤ºç”¨ - å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—
    function generateLeftDisplayDynamicStepHtml(step) {
        const stepData = step.data || {};
        const stepKey = step.key;
        let stepName = stepKey;
        let stepIcon = 'fas fa-circle';

        // ã‚¹ãƒ†ãƒƒãƒ—åã¨ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®š
        switch (stepKey) {
            case 'survey':
                stepName = 'ç¾å ´èª¿æŸ»';
                stepIcon = 'fas fa-search-location';
                break;
            case 'material_order':
                stepName = 'éƒ¨æç™ºæ³¨';
                stepIcon = 'fas fa-shopping-cart';
                break;
            case 'delivery':
                stepName = 'ç´å“';
                stepIcon = 'fas fa-truck';
                break;
            case 'inspection':
                stepName = 'æ¤œæŸ»';
                stepIcon = 'fas fa-clipboard-check';
                break;
            case 'handover':
                stepName = 'å¼•ãæ¸¡ã—';
                stepIcon = 'fas fa-key';
                break;
            case 'maintenance':
                stepName = 'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹';
                stepIcon = 'fas fa-tools';
                break;
            case 'warranty':
                stepName = 'ä¿è¨¼å¯¾å¿œ';
                stepIcon = 'fas fa-shield-alt';
                break;
            case 'final_report':
                stepName = 'æœ€çµ‚å ±å‘Š';
                stepIcon = 'fas fa-file-alt';
                break;
            case 'customer_satisfaction':
                stepName = 'é¡§å®¢æº€è¶³åº¦èª¿æŸ»';
                stepIcon = 'fas fa-star';
                break;
            case 'payment_confirmation':
                stepName = 'å…¥é‡‘ç¢ºèª';
                stepIcon = 'fas fa-money-check-alt';
                break;
            case 'project_closure':
                stepName = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†';
                stepIcon = 'fas fa-certificate';
                break;
            default:
                stepName = stepData.name || stepKey;
                break;
        }

        const isCompleted = stepData.completed || stepData.date || stepData.value;
        let statusHtml = 'æœªå®Œäº†';

        if (stepData.type === 'date' && stepData.date) {
            statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(stepData.date)}`;
        } else if (stepData.type === 'checkbox' && stepData.completed) {
            statusHtml = '<i class="fas fa-check-circle me-1"></i>å®Œäº†æ¸ˆã¿';
        } else if (stepData.type === 'text' && stepData.value) {
            statusHtml = `<i class="fas fa-check-circle me-1"></i>${stepData.value}`;
        }

        const completedClass = isCompleted ? 'completed' : '';

        return `
            <div class="progress-step ${completedClass}" data-step="${stepKey}">
                <div class="progress-step-header">
                    <i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span>
                </div>
                <div class="progress-step-date">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // é™çš„ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
    function generateStaticStepHtml(step) {
        switch (step.key) {
            case 'estimate':
                return generateEstimateStepHtml();
            case 'survey':
                return generateSurveyStepHtml();
            case 'contract':
                return generateContractStepHtml();
            case 'work_start':
                return generateWorkStartStepHtml();
            case 'work_end':
                return generateWorkEndStepHtml();
            case 'invoice':
                return generateInvoiceStepHtml();
            default:
                return '';
        }
    }

    // å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateDynamicStepHtml(step) {
        const stepData = step.data || {};
        const stepKey = step.key;

        let stepName = stepKey;
        let stepIcon = 'fas fa-circle';

        // ã‚¹ãƒ†ãƒƒãƒ—åã¨ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®š
        switch (stepKey) {
            case 'contract':
                stepName = 'å¥‘ç´„';
                stepIcon = 'fas fa-handshake';
                break;
            case 'invoice':
                stepName = 'è«‹æ±‚æ›¸ç™ºè¡Œ';
                stepIcon = 'fas fa-file-invoice-dollar';
                break;
            case 'survey':
                stepName = 'ç¾å ´èª¿æŸ»';
                stepIcon = 'fas fa-search';
                break;
            case 'permit_application':
                stepName = 'è¨±å¯ç”³è«‹';
                stepIcon = 'fas fa-file-signature';
                break;
            case 'material_order':
                stepName = 'è³‡æç™ºæ³¨';
                stepIcon = 'fas fa-boxes';
                break;
            case 'safety_training':
                stepName = 'å®‰å…¨è¬›ç¿’';
                stepIcon = 'fas fa-hard-hat';
                break;
            case 'final_inspection':
                stepName = 'å®Œæˆæ¤œæŸ»';
                stepIcon = 'fas fa-clipboard-check';
                break;
            case 'handover':
                stepName = 'å¼•æ¸¡ã—';
                stepIcon = 'fas fa-key';
                break;
            case 'warranty_issue':
                stepName = 'ä¿è¨¼æ›¸ç™ºè¡Œ';
                stepIcon = 'fas fa-certificate';
                break;
        }

        // contractã¨invoiceã¯ç‰¹åˆ¥ãªå‡¦ç†ãŒå¿…è¦ï¼ˆprojectDataã‹ã‚‰å–å¾—ï¼‰
        let dateValue, completedValue;
        if (stepKey === 'contract') {
            dateValue = projectData.contract_date;
        } else if (stepKey === 'invoice') {
            completedValue = projectData.invoice_issued;
        } else {
            dateValue = stepData.date;
            completedValue = stepData.completed;
        }

        const isCompleted = completedValue || dateValue || stepData.value;
        let statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';

        if (stepData.type === 'date' && dateValue) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(dateValue)}</div>`;
        } else if (stepData.type === 'checkbox' && completedValue) {
            statusHtml = '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†æ¸ˆã¿</div>';
        } else if (stepData.type === 'text' && stepData.value) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>${stepData.value}</div>`;
        }

        let fieldHtml = '';
        if (stepData.type === 'date') {
            fieldHtml = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <label class="form-label mb-0">äºˆå®šæ—¥</label>
                    <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="${stepKey}" title="å®Ÿæ–½æ—¥ã‚’è¿½åŠ ">
                        <i class="fas fa-plus me-1"></i>å®Ÿæ–½æ—¥
                    </button>
                </div>
                <input type="date" name="${stepKey}_date" class="form-control scheduled-date-input" value="${dateValue || ''}">
                <div class="actual-date-field mt-2" style="display: none;">
                    <label class="form-label">å®Ÿæ–½æ—¥</label>
                    <div class="input-group">
                        <input type="date" name="${stepKey}_actual_date" class="form-control actual-date-input" value="">
                        <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="å®Ÿæ–½æ—¥ã‚’å‰Šé™¤">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            `;
        } else if (stepData.type === 'checkbox') {
            fieldHtml = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="${stepKey}_completed"
                           id="${stepKey}Completed" ${completedValue ? 'checked' : ''}>
                    <label class="form-check-label" for="${stepKey}Completed">
                        <i class="fas fa-check me-1"></i>${stepName}å®Œäº†
                    </label>
                </div>
            `;
        } else {
            fieldHtml = `
                <label class="form-label">${stepName}</label>
                <input type="text" name="${stepKey}_value" class="form-control" value="${stepData.value || ''}">
            `;
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="${stepKey}">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="${stepKey}" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    ${fieldHtml}
                </div>
            </div>
        `;
    }

    // è¦‹ç©æ›¸ç™ºè¡Œã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateEstimateStepHtml() {
        const isCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;
        let statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';

        if (projectData.estimate_not_required) {
            statusHtml = '<div class="progress-step-date"><i class="fas fa-times-circle me-1"></i>è¦‹ç©ä¸è¦</div>';
        } else if (projectData.estimate_issued_date) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.estimate_issued_date)}</div>`;
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="estimate">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-file-invoice me-2"></i><span class="progress-step-label">è¦‹ç©æ›¸ç™ºè¡Œ</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="estimate" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">äºˆå®šæ—¥</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="estimate" title="å®Ÿæ–½æ—¥ã‚’è¿½åŠ ">
                                <i class="fas fa-plus me-1"></i>å®Ÿæ–½æ—¥
                            </button>
                        </div>
                        <input type="date" name="estimate_issued_date" class="form-control scheduled-date-input"
                               value="${projectData.estimate_issued_date || ''}" ${projectData.estimate_not_required ? 'disabled' : ''}>
                        <div class="actual-date-field mt-2" style="display: none;">
                            <label class="form-label">å®Ÿæ–½æ—¥</label>
                            <div class="input-group">
                                <input type="date" name="dynamic_field_estimate_actual_date" class="form-control actual-date-input" value="">
                                <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="å®Ÿæ–½æ—¥ã‚’å‰Šé™¤">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" name="estimate_not_required"
                               id="estimateNotRequired" ${projectData.estimate_not_required ? 'checked' : ''}>
                        <label class="form-check-label" for="estimateNotRequired">
                            <i class="fas fa-times me-1"></i>è¦‹ç©æ›¸ä¸è¦
                        </label>
                    </div>

                    <!-- ä¸‹è«‹æ¥­è€…è¦‹ç©é‡‘é¡ -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-yen-sign me-1"></i>ä¸‹è«‹æ¥­è€…è¦‹ç©é‡‘é¡
                        </label>
                        <textarea name="contractor_estimate_amount" class="form-control contractor-estimate-amount-input"
                                  rows="3" placeholder="ä¸‹è«‹æ¥­è€…ã®è¦‹ç©é‡‘é¡ã‚’ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆã§å…¥åŠ›"
                                  ${projectData.estimate_not_required ? 'disabled' : ''}>${projectData.contractor_estimate_amount || ''}</textarea>
                        <small class="text-muted">ä¸‹è«‹æ¥­è€…ã®è¦‹ç©é‡‘é¡ã‚„å†…è¨³ã‚’è‡ªç”±ã«å…¥åŠ›ã§ãã¾ã™</small>
                    </div>

                    <!-- å‚™è€ƒ -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-comment me-1"></i>å‚™è€ƒ
                        </label>
                        <textarea name="estimate_notes" class="form-control estimate-notes-input"
                                  rows="3" placeholder="è¦‹ç©ã‚‚ã‚Šã«é–¢ã™ã‚‹å‚™è€ƒã‚„ãƒ¡ãƒ¢ã‚’å…¥åŠ›"
                                  ${projectData.estimate_not_required ? 'disabled' : ''}>${projectData.estimate_notes || ''}</textarea>
                        <small class="text-muted">è¦‹ç©ã‚‚ã‚Šã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ã‚„ç‰¹è¨˜äº‹é …ã‚’å…¥åŠ›ã§ãã¾ã™</small>
                    </div>

                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                    <div class="estimate-files-section">
                        <label class="form-label d-flex align-items-center">
                            <i class="fas fa-paperclip me-2"></i>è¦‹ç©ã‚‚ã‚Šæ›¸é¡
                        </label>
                        <div class="mb-2">
                            <input type="file" class="form-control form-control-sm estimate-file-input"
                                   accept=".pdf,.xlsx,.xls,.docx,.doc,.jpg,.jpeg,.png"
                                   style="position: absolute; left: -9999px;">
                            <button type="button" class="btn btn-sm btn-outline-primary upload-estimate-file-btn">
                                <i class="fas fa-upload me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                            </button>
                            <small class="text-muted d-block mt-1">
                                PDF, Excel, Word, ç”»åƒ (æœ€å¤§10MB)
                            </small>
                        </div>
                        <div class="estimate-files-list">
                            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // ç¾åœ°èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateSurveyStepHtml() {
        // å®Ÿéš›ã®èª¿æŸ»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆsurveyså¤‰æ•°ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰æ¸¡ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        let isCompleted = false;
        let statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';

        {% if surveys %}
        // å®Œäº†ã—ãŸèª¿æŸ»ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const completedSurveys = [{% for survey in surveys %}{% if survey.status == 'completed' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        const inProgressSurveys = [{% for survey in surveys %}{% if survey.status == 'in_progress' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        const scheduledSurveys = [{% for survey in surveys %}{% if survey.status == 'scheduled' %}{ id: '{{ survey.id }}', date: '{{ survey.scheduled_date|date:"m/d" }}', time: '{{ survey.scheduled_start_time|time:"H:i" }}' }{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];

        if (completedSurveys.length > 0) {
            isCompleted = true;
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${completedSurveys.length}ä»¶</div>`;
        } else if (inProgressSurveys.length > 0) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-play me-1"></i>å®Ÿæ–½ä¸­: ${inProgressSurveys.length}ä»¶</div>`;
        } else if (scheduledSurveys.length > 0) {
            // æ¬¡å›äºˆå®šã®èª¿æŸ»æ—¥æ™‚ã‚’è¡¨ç¤º
            const nextSurvey = scheduledSurveys[0];
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>äºˆå®š: ${scheduledSurveys.length}ä»¶ (æ¬¡å›: ${nextSurvey.date} ${nextSurvey.time})</div>`;
        }
        {% endif %}

        const hasEstimateCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;

        return `
            <div class="progress-step ${isCompleted ? 'completed' : hasEstimateCompleted ? 'active' : ''}" data-step="survey">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-clipboard-list me-2"></i><span class="progress-step-label">ç¾åœ°èª¿æŸ»</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="survey" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="d-flex gap-2 mb-3">
                        {% comment %}
                        <a href="#" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>èª¿æŸ»ä½œæˆ
                        </a>
                        <a href="#" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-list me-1"></i>èª¿æŸ»ä¸€è¦§
                        </a>
                        {% endcomment %}
                    </div>
                    {% if surveys %}
                    <div class="small">
                        <div class="mb-2"><strong>èª¿æŸ»çŠ¶æ³:</strong></div>
                        {% for survey in surveys|slice:":3" %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">{{ survey.scheduled_date|date:"m/d" }} {{ survey.scheduled_start_time|time:"H:i" }}</span>
                            <span class="badge {% if survey.status == 'completed' %}bg-success{% elif survey.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %} small">
                                {{ survey.get_status_display }}
                            </span>
                        </div>
                        {% endfor %}
                        {% if surveys|length > 3 %}
                        <div class="text-muted small">ä»– {{ surveys|length|add:"-3" }}ä»¶...</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>èª¿æŸ»ãŒæœªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™
                    </div>
                    {% endif %}

                    <!-- ç¾èª¿æ‹…å½“è€…ã®è¡¨ç¤º -->
                    ${generateStepSubcontractCardHtml('survey')}
                </div>
            </div>
        `;
    }

    // å¥‘ç´„ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateContractStepHtml() {
        const isCompleted = projectData.contract_date;
        const statusHtml = isCompleted
            ? `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.contract_date)}</div>`
            : '<div class="progress-step-date">æœªå®Œäº†</div>';

        // Check if survey is completed to determine if contract should be active
        let hasSurveyCompleted = false;
        {% if surveys %}
        const completedSurveys = [{% for survey in surveys %}{% if survey.status == 'completed' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        hasSurveyCompleted = completedSurveys.length > 0;
        {% endif %}

        return `
            <div class="progress-step ${isCompleted ? 'completed' : hasSurveyCompleted ? 'active' : ''}" data-step="contract">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-handshake me-2"></i><span class="progress-step-label">å¥‘ç´„</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="contract" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">äºˆå®šæ—¥</label>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="contract" title="å®Ÿæ–½æ—¥ã‚’è¿½åŠ ">
                            <i class="fas fa-plus me-1"></i>å®Ÿæ–½æ—¥
                        </button>
                    </div>
                    <input type="date" name="contract_date" class="form-control scheduled-date-input" value="${projectData.contract_date || ''}">
                    <div class="actual-date-field mt-2" style="display: none;">
                        <label class="form-label">å®Ÿæ–½æ—¥</label>
                        <div class="input-group">
                            <input type="date" name="contract_actual_date" class="form-control actual-date-input" value="">
                            <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="å®Ÿæ–½æ—¥ã‚’å‰Šé™¤">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    // å·¥äº‹é–‹å§‹ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateWorkStartStepHtml() {
        const isCompleted = projectData.work_start_completed;
        const hasDate = projectData.work_start_date;

        let statusHtml;
        if (isCompleted) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.work_start_date)}</div>`;
        } else if (hasDate) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(projectData.work_start_date)}</div>`;
        } else {
            statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.contract_date ? 'active' : ''}" data-step="work_start">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-play-circle me-2"></i><span class="progress-step-label">å·¥äº‹é–‹å§‹</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="work_start" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">äºˆå®šæ—¥</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="work_start" title="å®Ÿæ–½æ—¥ã‚’è¿½åŠ ">
                                <i class="fas fa-plus me-1"></i>å®Ÿæ–½æ—¥
                            </button>
                        </div>
                        <input type="date" name="work_start_date" class="form-control scheduled-date-input" value="${projectData.work_start_date || ''}">
                        <div class="actual-date-field mt-2" style="display: none;">
                            <label class="form-label">å®Ÿæ–½æ—¥</label>
                            <div class="input-group">
                                <input type="date" name="work_start_actual_date" class="form-control actual-date-input" value="">
                                <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="å®Ÿæ–½æ—¥ã‚’å‰Šé™¤">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="work_start_completed"
                               id="workStartCompleted" ${projectData.work_start_completed ? 'checked' : ''}>
                        <label class="form-check-label" for="workStartCompleted">
                            <i class="fas fa-check me-1"></i>å·¥äº‹é–‹å§‹å®Œäº†
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // å·¥äº‹çµ‚äº†ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateWorkEndStepHtml() {
        const isCompleted = projectData.work_end_completed;
        const hasDate = projectData.work_end_date;

        let statusHtml;
        if (isCompleted) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.work_end_date)}</div>`;
        } else if (hasDate) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(projectData.work_end_date)}</div>`;
        } else {
            statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.work_start_completed ? 'active' : ''}" data-step="work_end">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-stop-circle me-2"></i><span class="progress-step-label">å·¥äº‹çµ‚äº†</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="work_end" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0">äºˆå®šæ—¥</label>
                            <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="work_end" title="å®Ÿæ–½æ—¥ã‚’è¿½åŠ ">
                                <i class="fas fa-plus me-1"></i>å®Ÿæ–½æ—¥
                            </button>
                        </div>
                        <input type="date" name="work_end_date" class="form-control scheduled-date-input" value="${projectData.work_end_date || ''}">
                        <div class="actual-date-field mt-2" style="display: none;">
                            <label class="form-label">å®Ÿæ–½æ—¥</label>
                            <div class="input-group">
                                <input type="date" name="work_end_actual_date" class="form-control actual-date-input" value="">
                                <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="å®Ÿæ–½æ—¥ã‚’å‰Šé™¤">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="work_end_completed"
                               id="workEndCompleted" ${projectData.work_end_completed ? 'checked' : ''}>
                        <label class="form-check-label" for="workEndCompleted">
                            <i class="fas fa-check me-1"></i>å·¥äº‹çµ‚äº†å®Œäº†
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // è«‹æ±‚æ›¸ç™ºè¡Œã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateInvoiceStepHtml() {
        const isCompleted = projectData.invoice_issued;
        const statusHtml = isCompleted
            ? '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ç™ºè¡Œæ¸ˆã¿</div>'
            : '<div class="progress-step-date">æœªç™ºè¡Œ</div>';

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.work_end_completed ? 'active' : ''}" data-step="invoice">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-receipt me-2"></i><span class="progress-step-label">è«‹æ±‚æ›¸ç™ºè¡Œ</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="invoice" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <label class="form-label">è«‹æ±‚æ›¸ç™ºè¡Œ</label>
                    <select name="invoice_issued" class="form-select">
                        <option value="false" ${!projectData.invoice_issued ? 'selected' : ''}>æœªç™ºè¡Œ</option>
                        <option value="true" ${projectData.invoice_issued ? 'selected' : ''}>ç™ºè¡Œæ¸ˆã¿</option>
                    </select>
                </div>
            </div>
        `;
    }


    // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ5ã¤ + è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    const availableSteps = [
        // === ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆåŸºæœ¬5ã‚¹ãƒ†ãƒƒãƒ—ï¼‰ ===
        {
            name: 'ç«‹ã¡ä¼šã„æ—¥',
            icon: 'fas fa-user-check',
            key: 'attendance',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: 'äºˆå®šæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'ç«‹ã¡ä¼šã„å®Œäº†',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'waiting', label: 'ç«‹ã¡ä¼šã„å¾…ã¡', color: 'warning' },
                { key: 'in_progress', label: 'ç«‹ã¡ä¼šã„ä¸­', color: 'info' },
                { key: 'completed', label: 'ç«‹ã¡ä¼šã„æ¸ˆã¿', color: 'success' }
            ]
        },
        {
            name: 'ç¾èª¿æ—¥',
            icon: 'fas fa-clipboard-list',
            key: 'survey',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: 'äºˆå®šæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'assignees',
                    label: 'æ‹…å½“è€…',
                    type: 'staff_select_list',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'ç¾èª¿å®Œäº†',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'waiting', label: 'ç¾èª¿å¾…ã¡', color: 'warning' },
                { key: 'completed', label: 'ç¾èª¿æ¸ˆã¿', color: 'success' }
            ]
        },
        {
            name: 'è¦‹ç©ã‚‚ã‚Šç™ºè¡Œæ—¥',
            icon: 'fas fa-calculator',
            key: 'estimate',
            type: 'complex',
            fields: [
                {
                    name: 'issued_date',
                    label: 'ç™ºè¡Œæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'not_required',
                    label: 'è¦‹ç©ã‚‚ã‚Šä¸è¦',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'pending', label: 'è¦‹ç©ã‚‚ã‚Šæ›¸ç™ºè¡Œ', color: 'info' },
                { key: 'under_review', label: 'è¦‹ç©ã‚‚ã‚Šå¯©æŸ»ä¸­', color: 'warning' },
                { key: 'approved', label: 'è¦‹ç©ã‚‚ã‚Šæ‰¿èªæ¸ˆã¿', color: 'success' }
            ]
        },
        {
            name: 'ç€å·¥æ—¥',
            icon: 'fas fa-hard-hat',
            key: 'construction_start',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: 'äºˆå®šæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'ç€å·¥å®Œäº†',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'waiting', label: 'ç€å·¥æ—¥å¾…ã¡', color: 'warning' },
                { key: 'in_progress', label: 'å·¥äº‹ä¸­', color: 'primary' },
                { key: 'completed', label: 'å·¥äº‹å®Œäº†', color: 'success' }
            ]
        },
        {
            name: 'å®Œå·¥æ—¥',
            icon: 'fas fa-check-circle',
            key: 'completion',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: 'äºˆå®šæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'å®Œå·¥æ¸ˆã¿',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'in_progress', label: 'æ–½å·¥ä¸­', color: 'info' },
                { key: 'completed', label: 'å®Œå·¥', color: 'success' }
            ]
        },

        // === è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ— ===
        {
            name: 'å¥‘ç´„',
            icon: 'fas fa-handshake',
            key: 'contract',
            type: 'date'
        },
        {
            name: 'è«‹æ±‚æ›¸ç™ºè¡Œ',
            icon: 'fas fa-file-invoice-dollar',
            key: 'invoice',
            type: 'checkbox'
        },
        {
            name: 'è¨±å¯ç”³è«‹',
            icon: 'fas fa-file-signature',
            key: 'permit_application',
            type: 'date'
        },
        // å°†æ¥æ‹¡å¼µç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¾‹ï¼š
        /*
        {
            name: 'ææ–™æ¤œæŸ»',
            icon: 'fas fa-clipboard-check',
            key: 'material_inspection',
            type: 'complex',
            fields: [
                {
                    name: 'inspection_date',
                    label: 'æ¤œæŸ»æ—¥',
                    type: 'date',
                    required: true
                },
                {
                    name: 'inspector_id',
                    label: 'æ¤œæŸ»å“¡',
                    type: 'select',
                    required: true,
                    options: [
                        { value: '', text: 'é¸æŠã—ã¦ãã ã•ã„' },
                        { value: 'inspector_1', text: 'æ¤œæŸ»å“¡A' },
                        { value: 'inspector_2', text: 'æ¤œæŸ»å“¡B' }
                    ]
                },
                {
                    name: 'passed',
                    label: 'æ¤œæŸ»åˆæ ¼',
                    type: 'checkbox',
                    required: false
                },
                {
                    name: 'notes',
                    label: 'å‚™è€ƒ',
                    type: 'text',
                    required: false
                }
            ]
        },
        */
        {
            name: 'è³‡æç™ºæ³¨',
            icon: 'fas fa-boxes',
            key: 'material_order',
            type: 'date'
        },
        {
            name: 'å®‰å…¨è¬›ç¿’',
            icon: 'fas fa-hard-hat',
            key: 'safety_training',
            type: 'checkbox'
        },
        {
            name: 'å®Œæˆæ¤œæŸ»',
            icon: 'fas fa-clipboard-check',
            key: 'final_inspection',
            type: 'date'
        },
        {
            name: 'å¼•æ¸¡ã—',
            icon: 'fas fa-key',
            key: 'handover',
            type: 'date'
        },
        {
            name: 'ä¿è¨¼æ›¸ç™ºè¡Œ',
            icon: 'fas fa-certificate',
            key: 'warranty_issue',
            type: 'checkbox'
        }
    ];

    // Sortable.jsã®åˆæœŸåŒ–
    function initializeSortable() {
        const progressContainer = document.getElementById('activeSteps');

        // è¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—
        if (!progressContainer) {
            console.warn('activeSteps element not found, skipping Sortable initialization');
            return;
        }

        if (sortable) {
            sortable.destroy();
        }

        sortable = Sortable.create(progressContainer, {
            animation: 150,
            disabled: !editMode,
            filter: 'button, .btn, input, select, textarea, .progress-step-content',
            preventOnFilter: false,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: function (evt) {
                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã¯ç¾åœ¨ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ç¶­æŒï¼ˆä½•ã‚‚ã—ãªã„ï¼‰
            },
            onEnd: function (evt) {
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç†
                console.log('ã‚¹ãƒ†ãƒƒãƒ—é †åºå¤‰æ›´:', evt.oldIndex, '->', evt.newIndex);

                // ç¾åœ¨ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’ç¶­æŒã—ãŸã¾ã¾é †åºã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
                saveStepOrder();
                saveStepsToServer();
            }
        });
    }

    // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
    function saveStepOrder() {
        const steps = [];
        $('#activeSteps .progress-step').each(function(index) {
            steps.push({
                step: $(this).data('step'),
                order: index,
                completed: $(this).hasClass('completed')  // å®Œäº†ãƒ•ãƒ©ã‚°ã‚‚ä¿å­˜
            });
        });
        console.log('æ–°ã—ã„é †åº:', steps);

        // é †åºã‚’hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
        $('#stepOrderInput').val(JSON.stringify(steps));
    }

    // ã‚µãƒ¼ãƒãƒ¼ã«ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ä¿å­˜
    function saveStepsToServer() {
        const stepOrderJson = $('#stepOrderInput').val();

        if (!stepOrderJson) {
            console.warn('No step order to save');
            return;
        }

        console.log('Saving steps to server:', stepOrderJson);

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: {
                step_order: stepOrderJson,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Steps saved successfully:', response);
            },
            error: function(xhr, status, error) {
                console.error('Failed to save steps:', error);
                console.error('Response:', xhr.responseText);
            }
        });
    }

    // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¡¨ç¤º
    function loadAvailableSteps() {
        const container = $('#availableSteps');
        container.empty();

        availableSteps.forEach(step => {
            // æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ†ãƒƒãƒ—ã¯è¡¨ç¤ºã—ãªã„
            if ($('.progress-step[data-step="' + step.key + '"]').length > 0) {
                return;
            }

            // ç‰¹åˆ¥å‡¦ç†ã¯ä¸è¦ - ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ¼ã«è¡¨ç¤º

            const stepHtml = `
                <div class="col-auto mb-1">
                    <button type="button" class="btn btn-outline-success btn-sm add-step-btn"
                            data-step-key="${step.key}"
                            style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                        <i class="${step.icon}" style="font-size: 0.6rem;"></i> ${step.name}+
                    </button>
                </div>
            `;
            container.append(stepHtml);
        });
    }

    // ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ 
    $(document).on('click', '.add-step-btn', function() {
        const stepKey = $(this).data('step-key');
        const stepData = availableSteps.find(s => s.key === stepKey);
        const $btn = $(this);

        console.log('Add step button clicked:', stepKey);
        console.log('Edit mode:', editMode);
        console.log('Step data found:', stepData);

        // å¸¸ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ãªã®ã§ãƒã‚§ãƒƒã‚¯ä¸è¦
        // if (!editMode) {
        //     console.error('Not in edit mode! Cannot add step.');
        //     if (typeof toastr !== 'undefined') {
        //         toastr.warning('ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        //     } else {
        //         showErrorModal('ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
        //     }
        //     return;
        // }

        if (!stepData) {
            console.error('Step data not found for key:', stepKey);
            if (typeof toastr !== 'undefined') {
                toastr.error('ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            } else {
                showErrorModal('ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            }
            return;
        }

        if (stepData) {
            // ã‚¹ãƒ†ãƒƒãƒ—ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const existingStep = $(`.progress-step[data-step="${stepKey}"]`);
            if (existingStep.length > 0) {
                console.log('Step already exists:', stepKey);
                if (typeof toastr !== 'undefined') {
                    toastr.info(`${stepData.name}ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                } else {
                    showErrorModal(`${stepData.name}ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                }
                return;
            }

            // ç¾åœ°èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã§ survey_required=false ã®å ´åˆã¯APIã‚’å‘¼ã¶
            if (stepData.key === 'survey' && stepData.apiEndpoint && !{% if project.survey_required %}true{% else %}false{% endif %}) {
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> è¿½åŠ ä¸­...');

                fetch(stepData.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æˆåŠŸæ™‚ï¼šãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
                        location.reload();
                    } else {
                        showErrorModal('ã‚¹ãƒ†ãƒƒãƒ—ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                        $btn.prop('disabled', false).html('<i class="fas fa-plus"></i> è¿½åŠ ');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showErrorModal('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    $btn.prop('disabled', false).html('<i class="fas fa-plus"></i> è¿½åŠ ');
                });
            } else {
                // é€šå¸¸ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆï¼ˆåŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‚‚å«ã‚€ï¼‰
                if (stepData.type === 'basic') {
                    // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã¯å¯¾å¿œã™ã‚‹HTMLç”Ÿæˆé–¢æ•°ã‚’å‘¼ã¶
                    let stepHtml = '';
                    switch (stepData.key) {
                        case 'estimate':
                            stepHtml = generateEstimateStepHtml();
                            break;
                        case 'survey':
                            stepHtml = generateSurveyStepHtml();
                            break;
                        case 'contract':
                            stepHtml = generateContractStepHtml();
                            break;
                        case 'work_start':
                            stepHtml = generateWorkStartStepHtml();
                            break;
                        case 'work_end':
                            stepHtml = generateWorkEndStepHtml();
                            break;
                        case 'invoice':
                            stepHtml = generateInvoiceStepHtml();
                            break;
                        default:
                            stepHtml = generateAvailableStepHtml(stepData);
                    }

                    // è«‹æ±‚æ›¸ç™ºè¡Œã®å‰ã«æŒ¿å…¥
                    const invoiceStep = $('.progress-step[data-step="invoice"]');
                    if (invoiceStep.length > 0) {
                        invoiceStep.before(stepHtml);
                        console.log(`Added step ${stepData.key} before invoice step`);
                    } else {
                        $('#activeSteps').append(stepHtml);
                        console.log(`Added step ${stepData.key} to end of active steps`);
                    }

                    // é€šçŸ¥ã‚’è¡¨ç¤ºï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼‰
                    // if (typeof toastr !== 'undefined') {
                    //     toastr.success(`${stepData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
                    // } else {
                    //     showErrorModal(`${stepData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
                    // }
                } else {
                    addStepToProgress(stepData);
                }

                // ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ï¼ˆæ­£ã—ã„ã‚»ãƒ¬ã‚¯ã‚¿ã‚’ä½¿ç”¨ï¼‰
                $(this).closest('.col-auto').remove();

                // Sortableã‚’å†åˆæœŸåŒ–ï¼ˆDOMã®æ›´æ–°ã‚’å¾…ã¤ãŸã‚å°‘ã—é…å»¶ï¼‰
                setTimeout(() => {
                    initializeSortable();
                    // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ä¿å­˜
                    saveStepOrder();

                    // ã‚µãƒ¼ãƒãƒ¼ã«è‡ªå‹•ä¿å­˜
                    saveStepsToServer();
                }, 50);

                // è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°
                updateSurveyAreaVisibility();

                // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
                loadAvailableSteps();

                console.log(`Step ${stepData.key} (${stepData.name}) successfully added to progress timeline`);
            }
        }
    });

    // ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤ - ãƒ¢ãƒ¼ãƒ€ãƒ«ä½¿ç”¨
    let pendingDeleteBtn = null;

    $(document).on('click', '.remove-step-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã‚‚ç¢ºå®Ÿã«ãƒœã‚¿ãƒ³è¦ç´ ã‚’å–å¾—
        const $btn = $(e.target).closest('.remove-step-btn');
        const stepKey = $btn.data('step');
        console.log(`Remove button clicked for step: ${stepKey}`);

        if (!stepKey) {
            console.error('Step key not found');
            return;
        }

        // ã‚¹ãƒ†ãƒƒãƒ—åã‚’å–å¾—
        const stepName = $btn.closest('.progress-step').find('.progress-step-header span').text().trim();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚¹ãƒ†ãƒƒãƒ—åã‚’è¨­å®š
        $('#stepDeleteName').text(`ã€${stepName}ã€‘`);

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‚ç…§ã‚’ä¿å­˜
        pendingDeleteBtn = $btn;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        const deleteModal = new bootstrap.Modal(document.getElementById('stepDeleteModal'));
        deleteModal.show();
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å‰Šé™¤ç¢ºå®šãƒœã‚¿ãƒ³
    $('#confirmStepDelete').on('click', function() {
        if (!pendingDeleteBtn) {
            console.error('No pending delete button');
            return;
        }

        const stepKey = pendingDeleteBtn.data('step');
        const stepName = pendingDeleteBtn.closest('.progress-step').find('.progress-step-header span').text().trim();

        console.log(`Removing step: ${stepKey}`);

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤
        pendingDeleteBtn.closest('.progress-step').remove();

        // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’æ›´æ–°ï¼ˆé‡è¦ï¼ã“ã‚ŒãŒãªã„ã¨å‰Šé™¤ãŒä¿å­˜ã•ã‚Œãªã„ï¼‰
        saveStepOrder();

        // ã‚µãƒ¼ãƒãƒ¼ã«è‡ªå‹•ä¿å­˜
        saveStepsToServer();

        loadAvailableSteps(); // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’å†èª­ã¿è¾¼ã¿
        // Sortableã‚’å†åˆæœŸåŒ–ï¼ˆDOMã®æ›´æ–°ã‚’å¾…ã¤ãŸã‚å°‘ã—é…å»¶ï¼‰
        setTimeout(() => {
            initializeSortable();
        }, 50);
        updateSurveyAreaVisibility(); // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°

        console.log(`Step ${stepKey} removed and order updated`);

        // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('stepDeleteModal'));
        deleteModal.hide();

        // æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚¹ãƒ†ãƒƒãƒ—åã‚’è¨­å®š
        $('#stepDeleteSuccessName').text(`ã€${stepName}ã€‘`);

        // æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        const successModal = new bootstrap.Modal(document.getElementById('stepDeleteSuccessModal'));
        successModal.show();

        // å‚ç…§ã‚’ã‚¯ãƒªã‚¢
        pendingDeleteBtn = null;
    });

    // ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ã®ä¸‹è«‹ã‘æ‰‹é…ã‚«ãƒ¼ãƒ‰HTMLã‚’ç”Ÿæˆ
    function generateStepSubcontractCardHtml(stepKey) {
        // attendance, survey, construction_start ã®3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿å¯¾è±¡
        const stepSubcontracts = {
            'attendance': {{ attendance_subcontracts_json|safe }},
            'survey': {{ survey_subcontracts_json|safe }},
            'construction_start': {{ construction_start_subcontracts_json|safe }}
        };

        const subcontracts = stepSubcontracts[stepKey];
        if (!subcontracts) return '';  // å¯¾è±¡ã‚¹ãƒ†ãƒƒãƒ—ã§ãªã‘ã‚Œã°ç©ºæ–‡å­—ã‚’è¿”ã™

        const stepNames = {
            'attendance': 'ç«‹ã¡ä¼šã„',
            'survey': 'ç¾èª¿',
            'construction_start': 'ç€å·¥'
        };

        let subcontractListHtml = '';
        if (subcontracts.length > 0) {
            subcontracts.forEach(sub => {
                subcontractListHtml += `
                    <div class="mb-2 p-2 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; font-weight: bold;">
                                    ${sub.contractor_name}
                                    <span class="badge bg-light text-dark border ms-1" style="font-size: 0.6rem;">${stepNames[stepKey]}</span>
                                </div>
                            </div>
                            <span class="badge bg-${sub.payment_status_color}" style="font-size: 0.6rem;">
                                ${sub.payment_status_display}
                            </span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <div style="font-size: 0.65rem;">
                                <span class="text-muted">å¥‘ç´„:</span> Â¥${sub.contract_amount ? sub.contract_amount.toLocaleString() : 0}<br>
                                <span class="text-muted">è«‹æ±‚:</span> Â¥${sub.billed_amount ? sub.billed_amount.toLocaleString() : 0}
                            </div>
                        </div>
                    </div>
                `;
            });
        } else {
            subcontractListHtml = `
                <div class="text-center py-2">
                    <i class="fas fa-file-contract fa-2x text-muted mb-2"></i>
                    <p style="font-size: 0.7rem; color: #6c757d;" class="mb-0">ç™ºæ³¨å…ˆæœªç™»éŒ²</p>
                </div>
            `;
        }

        return `
            <div class="card border-primary shadow-sm mb-2 mt-3" style="max-width: 600px;">
                <div class="card-header bg-white text-primary py-1 border-bottom border-primary">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" style="font-size: 0.85rem; line-height: 1.4;">
                            <i class="fas fa-file-contract"></i> ${stepNames[stepKey]}ã®ä¸‹è«‹ã‘æ‰‹é…çŠ¶æ³
                            <span class="badge bg-primary text-white ms-2">${subcontracts.length}ä»¶</span>
                        </h6>
                    </div>
                </div>
                <div class="card-body p-2">
                    ${subcontractListHtml}
                    <!-- ä½œæ¥­è€…è¿½åŠ ãƒœã‚¿ãƒ³ -->
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-primary w-100" style="font-size: 0.65rem;" onclick="openSubcontractModal('${stepKey}')">
                            <i class="fas fa-user-plus"></i> ä½œæ¥­è€…ã‚’è¿½åŠ 
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // è³‡æç™ºæ³¨çŠ¶æ³ã‚«ãƒ¼ãƒ‰HTMLã‚’ç”Ÿæˆ
    function generateMaterialOrderCardHtml() {
        const materialOrders = {{ material_orders_json|safe }};

        let materialOrderListHtml = '';
        if (materialOrders && materialOrders.length > 0) {
            materialOrders.forEach(order => {
                const statusClass = order.status === 'completed' ? 'bg-success' :
                                  order.status === 'delivered' ? 'bg-info' :
                                  order.status === 'ordered' ? 'bg-warning' : 'bg-secondary';

                materialOrderListHtml += `
                    <div class="mb-2 p-2 border-bottom">
                        <div class="d-flex justify-content-between align-items-start">
                            <div style="flex: 1;">
                                <div style="font-size: 0.75rem; font-weight: bold;">
                                    ${order.contractor ? order.contractor.name : 'ç™ºæ³¨å…ˆæœªè¨­å®š'}
                                </div>
                                ${order.items && order.items.length > 0 ? `
                                    <div style="font-size: 0.65rem; color: #6c757d;">
                                        ${order.items[0].material_name}${order.items.length > 1 ? ' ä»–' + (order.items.length - 1) + 'ä»¶' : ''}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <div style="font-size: 0.65rem;">
                                <span class="text-muted">é‡‘é¡:</span> Â¥${order.total_amount ? order.total_amount.toLocaleString() : 0}<br>
                                <span class="text-muted">ç™ºæ³¨æ—¥:</span> ${order.order_date || '-'}
                            </div>
                            <span class="badge ${statusClass}" style="font-size: 0.6rem;">
                                ${order.status_display || '-'}
                            </span>
                        </div>
                    </div>
                `;
            });
        } else {
            materialOrderListHtml = `
                <div class="text-center py-2">
                    <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                    <p style="font-size: 0.7rem; color: #6c757d;" class="mb-0">è³‡æç™ºæ³¨æœªç™»éŒ²</p>
                </div>
            `;
        }

        return `
            <div class="card border-warning shadow-sm mb-2 mt-3" style="max-width: 600px;">
                <div class="card-header bg-white text-warning py-1 border-bottom border-warning">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0" style="font-size: 0.85rem; line-height: 1.4;">
                            <i class="fas fa-box-open"></i> è³‡æç™ºæ³¨çŠ¶æ³
                            <span class="badge bg-warning text-white ms-2">${materialOrders ? materialOrders.length : 0}ä»¶</span>
                        </h6>
                    </div>
                </div>
                <div class="card-body p-2">
                    ${materialOrderListHtml}
                    <!-- è³‡æç™ºæ³¨ã‚’è¿½åŠ ãƒœã‚¿ãƒ³ -->
                    <div class="mt-2">
                        <button type="button" class="btn btn-sm btn-outline-warning w-100" style="font-size: 0.65rem;" onclick="openMaterialOrderModal()">
                            <i class="fas fa-plus"></i> è³‡æç™ºæ³¨ã‚’è¿½åŠ 
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰å®Œå…¨ãªã‚¹ãƒ†ãƒƒãƒ—HTMLã‚’ç”Ÿæˆ
    function generateAvailableStepHtml(stepData) {
        const fieldHtml = generateFieldHtml(stepData);

        // attendance, survey, construction_start ã®å ´åˆã¯ä¸‹è«‹ã‘æ‰‹é…ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
        // material_order ã®å ´åˆã¯è³‡æç™ºæ³¨çŠ¶æ³ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ 
        let additionalCardHtml = '';
        if (['attendance', 'survey', 'construction_start'].includes(stepData.key)) {
            additionalCardHtml = generateStepSubcontractCardHtml(stepData.key);
        } else if (stepData.key === 'material_order') {
            additionalCardHtml = generateMaterialOrderCardHtml();
        }

        return `
            <div class="progress-step" data-step="${stepData.key}">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="${stepData.icon} me-2"></i><span class="progress-step-label">${stepData.name}</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="${stepData.key}" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div class="progress-step-date"><span class="badge bg-secondary">æœªå®Œäº†</span></div>
                <div class="progress-step-content">
                    ${fieldHtml}
                    ${additionalCardHtml}
                </div>
            </div>
        `;
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã«ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
    function addStepToProgress(stepData) {
        const stepHtml = generateAvailableStepHtml(stepData);

        // è«‹æ±‚æ›¸ç™ºè¡Œã®å‰ã«æŒ¿å…¥
        const invoiceStep = $('.progress-step[data-step="invoice"]');
        let $newStep;
        if (invoiceStep.length > 0) {
            invoiceStep.before(stepHtml);
            $newStep = invoiceStep.prev('.progress-step');
        } else {
            $('#activeSteps').append(stepHtml);
            $newStep = $('#activeSteps .progress-step').last();
        }

        // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—ã‚’å±•é–‹çŠ¶æ…‹ã«ã™ã‚‹
        $newStep.addClass('expanded');
        $newStep.find('.progress-step-content').show();

        // Sortableã‚’å†åˆæœŸåŒ–ï¼ˆDOMã®æ›´æ–°ã‚’å¾…ã¤ãŸã‚å°‘ã—é…å»¶ï¼‰
        setTimeout(() => {
            initializeSortable();
            // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ä¿å­˜
            saveStepOrder();
        }, 50);

        // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°
        updateSurveyAreaVisibility();

        console.log(`Added step: ${stepData.key} (${stepData.name})`);

        // é€šçŸ¥ã‚’è¡¨ç¤ºï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤ï¼‰
        // if (typeof toastr !== 'undefined') {
        //     toastr.success(`${stepData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
        // } else {
        //     showErrorModal(`${stepData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
        // }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸHTMLã‚’ç”Ÿæˆ
    function generateFieldHtml(stepData) {
        switch (stepData.type) {
            case 'complex':
                return generateComplexFieldHtml(stepData);
            case 'date':
                return `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <label class="form-label mb-0">äºˆå®šæ—¥</label>
                        <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="${stepData.key}" title="å®Ÿæ–½æ—¥ã‚’è¿½åŠ ">
                            <i class="fas fa-plus me-1"></i>å®Ÿæ–½æ—¥
                        </button>
                    </div>
                    <input type="date" name="${stepData.key}_date" class="form-control scheduled-date-input">
                    <div class="actual-date-field mt-2" style="display: none;">
                        <label class="form-label">å®Ÿæ–½æ—¥</label>
                        <div class="input-group">
                            <input type="date" name="${stepData.key}_actual_date" class="form-control actual-date-input" value="">
                            <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="å®Ÿæ–½æ—¥ã‚’å‰Šé™¤">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                `;
            case 'checkbox':
                return `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="${stepData.key}_completed"
                               id="${stepData.key}Completed">
                        <label class="form-check-label" for="${stepData.key}Completed">
                            <i class="fas fa-check me-1"></i>${stepData.name}å®Œäº†
                        </label>
                    </div>
                `;
            default:
                return `
                    <label class="form-label">${stepData.name}</label>
                    <input type="text" name="${stepData.key}_value" class="form-control">
                `;
        }
    }

    // è¤‡åˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®HTMLç”Ÿæˆ
    function generateComplexFieldHtml(stepData) {
        if (!stepData.fields || !Array.isArray(stepData.fields)) {
            return `<p class="text-muted">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>`;
        }

        let html = '';
        stepData.fields.forEach(field => {
            const fieldId = `${stepData.key}_${field.name}`;
            const fieldName = `dynamic_field_${stepData.key}_${field.name}`;  // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 

            html += `<div class="mb-1">`;

            // dependencyå±æ€§ã‚’å‡¦ç†ï¼ˆdependsOn ã¨ showWhen ã‚’ã‚µãƒãƒ¼ãƒˆï¼‰
            const dependsOnField = field.dependsOn ? `dynamic_field_${stepData.key}_${field.dependsOn}` : '';
            const showWhenValue = field.showWhen || '';
            const dependencyAttr = dependsOnField ?
                `data-dependency-field="${dependsOnField}" data-dependency-value="${showWhenValue}"` : '';
            const initialDisplay = dependsOnField ? 'style="display: none;"' : '';

            // ä¾å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆéè¡¨ç¤ºã®å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰ã¯requiredã«ã—ãªã„
            const isRequired = field.required && !dependsOnField;

            switch (field.type) {
                case 'radio':
                    html += `<label class="form-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>`;
                    html += `<div class="d-flex gap-2">`;
                    if (field.options && Array.isArray(field.options)) {
                        field.options.forEach((option, index) => {
                            const isDefault = field.default === option.value;
                            html += `
                                <div class="form-check form-check-inline" style="margin-bottom: 0;">
                                    <input class="form-check-input" type="radio" name="${fieldName}" id="${fieldId}_${index}"
                                           value="${option.value}" ${isDefault ? 'checked' : ''} ${isRequired ? 'required' : ''} style="width: 14px; height: 14px;">
                                    <label class="form-check-label" for="${fieldId}_${index}" style="font-size: 0.7rem;">
                                        ${option.text}
                                    </label>
                                </div>
                            `;
                        });
                    }
                    html += `</div>`;
                    break;
                case 'date':
                    // complex_step_fieldsã‹ã‚‰å€¤ã‚’å–å¾—
                    const dateFieldKey = `${stepData.key}_${field.name}`;
                    const dateValue = complexStepFields[dateFieldKey] || '';

                    // scheduled_dateã®å ´åˆã¯äºˆå®šæ—¥+å®Ÿæ–½æ—¥ã®æ§‹é€ 
                    if (field.name === 'scheduled_date') {
                        const actualDateKey = `${stepData.key}_actual_date`;
                        const actualDateValue = complexStepFields[actualDateKey] || '';
                        const actualDateFieldName = `dynamic_field_${stepData.key}_actual_date`;

                        html += `
                            <div ${dependencyAttr} ${initialDisplay}>
                                <div class="d-flex justify-content-between align-items-center" style="margin-bottom: 0.2rem;">
                                    <label class="form-label mb-0" style="font-size: 0.7rem;">${field.label}</label>
                                    <button type="button" class="btn btn-sm btn-outline-secondary add-actual-date-btn" data-step="${stepData.key}" title="å®Ÿæ–½æ—¥ã‚’è¿½åŠ " style="font-size: 0.65rem; padding: 0.15rem 0.3rem; line-height: 1;">
                                        <i class="fas fa-plus" style="font-size: 0.6rem;"></i> å®Ÿæ–½æ—¥
                                    </button>
                                </div>
                                <input type="date" name="${fieldName}" id="${fieldId}" class="form-control scheduled-date-input" value="${dateValue}" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                                <div class="actual-date-field mt-1" style="display: ${actualDateValue ? 'block' : 'none'};">
                                    <label class="form-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">å®Ÿæ–½æ—¥</label>
                                    <div class="input-group">
                                        <input type="date" name="${actualDateFieldName}" class="form-control actual-date-input" value="${actualDateValue}" style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                                        <button type="button" class="btn btn-outline-danger remove-actual-date-btn" title="å®Ÿæ–½æ—¥ã‚’å‰Šé™¤" style="font-size: 0.65rem; padding: 0.2rem 0.35rem; line-height: 1;">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        // é€šå¸¸ã®æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
                        html += `
                            <div ${dependencyAttr} ${initialDisplay}>
                                <label class="form-label" for="${fieldId}" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                                <input type="date" name="${fieldName}" id="${fieldId}" class="form-control" value="${dateValue}" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                            </div>
                        `;
                    }
                    break;
                case 'select':
                    // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠã®å ´åˆã¯å‹•çš„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
                    let options = field.options;
                    if (field.name === 'staff_id') {
                        options = generateStaffOptions();
                    }

                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                            <select name="${fieldName}" id="${fieldId}" class="form-select" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                    `;
                    if (options && Array.isArray(options)) {
                        options.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `</select>`;

                    // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ï¼‰
                    if (field.name === 'staff_id') {
                        html += `
                            <button type="button" class="btn btn-outline-secondary mt-1" onclick="openStaffManagementPanel()" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; line-height: 1.2;">
                                <i class="fas fa-users-cog" style="font-size: 0.6rem;"></i> æ‹…å½“è€…ç®¡ç†
                            </button>
                        `;
                    }
                    html += `</div>`;
                    break;
                case 'multiselect':
                    // è¤‡æ•°é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆè·äººé¸æŠãªã©ï¼‰
                    let multioptions = field.options;
                    if (field.name === 'staff_ids') {
                        multioptions = generateStaffOptions();
                    }

                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                            <select name="${fieldName}" id="${fieldId}" class="form-select" multiple size="5" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem;">
                    `;
                    if (multioptions && Array.isArray(multioptions)) {
                        multioptions.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `</select>`;
                    html += `<small class="form-text text-muted" style="font-size: 0.65rem;">Ctrl/Cmdã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</small>`;

                    // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                    if (field.name === 'staff_ids') {
                        html += `
                            <button type="button" class="btn btn-outline-secondary mt-1" onclick="openStaffManagementPanel()" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; line-height: 1.2;">
                                <i class="fas fa-users-cog" style="font-size: 0.6rem;"></i> æ‹…å½“è€…ç®¡ç†
                            </button>
                        `;
                    }
                    html += `</div>`;
                    break;
                case 'text':
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                            <input type="text" name="${fieldName}" id="${fieldId}" class="form-control" ${isRequired ? 'required' : ''} style="font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                        </div>
                    `;
                    break;
                case 'checkbox':
                    html += `
                        <div class="form-check" ${dependencyAttr} ${initialDisplay}>
                            <input class="form-check-input" type="checkbox" name="${fieldName}" id="${fieldId}" ${isRequired ? 'required' : ''} style="width: 14px; height: 14px;">
                            <label class="form-check-label" for="${fieldId}" style="font-size: 0.7rem;">
                                <i class="fas fa-check me-1" style="font-size: 0.65rem;"></i>${field.label}
                            </label>
                        </div>
                    `;
                    break;
                case 'staff_select_list':
                    // å‹•çš„ã«è¿½åŠ å¯èƒ½ãªæ‹…å½“è€…é¸æŠãƒªã‚¹ãƒˆ
                    const staffOptions = generateStaffOptions();
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" style="font-size: 0.7rem; margin-bottom: 0.2rem;">${field.label}</label>
                            <div class="staff-select-container" id="${fieldId}_container">
                                <div class="staff-select-item mb-1">
                                    <select name="${fieldName}" class="form-select d-inline-block" style="width: calc(100% - 35px); font-size: 0.7rem; padding: 0.25rem 0.4rem; min-height: 28px;">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    `;
                    if (staffOptions && Array.isArray(staffOptions)) {
                        staffOptions.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `
                                    </select>
                                    <button type="button" class="btn btn-outline-danger remove-staff-select-btn" style="display:none; font-size: 0.65rem; padding: 0.2rem 0.35rem; line-height: 1;">
                                        Ã—
                                    </button>
                                </div>
                            </div>
                            <div class="d-flex gap-1 mt-1">
                                <button type="button" class="btn btn-outline-primary add-staff-select-btn" data-container-id="${fieldId}_container" data-field-name="${fieldName}" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; line-height: 1.2;">
                                    <i class="fas fa-plus" style="font-size: 0.6rem;"></i> æ‹…å½“è€…ã‚’è¿½åŠ 
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="openStaffManagementPanel()" style="font-size: 0.65rem; padding: 0.2rem 0.4rem; line-height: 1.2;">
                                    <i class="fas fa-users-cog" style="font-size: 0.6rem;"></i> æ‹…å½“è€…ç®¡ç†
                                </button>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    html += `<p class="text-warning">æœªå¯¾å¿œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—: ${field.type}</p>`;
            }

            html += `</div>`;
        });

        return html;
    }

    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
    function getComplexStepStatus(stepData, stepElement) {
        if (!stepData.fields || !Array.isArray(stepData.fields)) {
            return { completed: false, statusText: 'æœªå®Œäº†', status: 'pending' };
        }

        const values = {};
        stepData.fields.forEach(field => {
            const fieldName = `dynamic_field_${stepData.key}_${field.name}`;  // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
            const input = stepElement.find(`[name="${fieldName}"]`);

            if (input.length > 0) {
                if (field.type === 'checkbox') {
                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯booleanå€¤ã‚’è¿”ã™
                    values[field.name] = input.is(':checked');
                } else if (field.type === 'radio') {
                    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ã®ã¿
                    if (input.is(':checked')) {
                        values[field.name] = input.val();
                    }
                } else if (field.type === 'multiselect') {
                    // è¤‡æ•°é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ - é…åˆ—ã‚’å‡¦ç†
                    const val = input.val();
                    if (val && Array.isArray(val) && val.length > 0) {
                        values[field.name] = val.join(',');
                    }
                } else {
                    // ãƒ†ã‚­ã‚¹ãƒˆã‚„æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ - ç©ºæ–‡å­—åˆ—ã¯å«ã‚ãªã„
                    const val = input.val();
                    if (val && typeof val === 'string' && val.trim() !== '') {
                        values[field.name] = val.trim();
                    }
                }
            }
        });

        // æ‹…å½“è€…åã‚’å–å¾—
        function getStaffInfo() {
            if (values.staff_id) {
                return getStaffName(values.staff_id);
            }
            return '';
        }

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆæ™‚åˆ»ãªã—ï¼‰
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®šï¼ˆäºˆå®šæ—¥ãƒ™ãƒ¼ã‚¹ï¼šäºˆå®šæ—¥ãŒéå»ãªã‚‰è‡ªå‹•å®Œäº†ï¼‰
        switch (stepData.key) {
            case 'attendance':  // ç«‹ã¡ä¼šã„æ—¥
                const attCompleted = values.completed;
                const attScheduled = values.scheduled_date;
                const attStaff = getStaffInfo();

                // äºˆå®šæ—¥ãŒéå»ã‹ãƒã‚§ãƒƒã‚¯
                let attScheduledPast = false;
                if (attScheduled) {
                    const scheduled = new Date(attScheduled);
                    scheduled.setHours(0, 0, 0, 0);
                    attScheduledPast = scheduled < today;
                }

                if (attCompleted || attScheduledPast) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">ç«‹ã¡ä¼šã„æ¸ˆã¿</span> ${attScheduled ? formatDate(attScheduled) : ''}${attStaff ? ' (' + attStaff + ')' : ''}`
                    };
                } else if (attScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">ç«‹ã¡ä¼šã„å¾…ã¡</span> ${formatDate(attScheduled)}${attStaff ? ' (' + attStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            case 'survey':  // ç¾èª¿æ—¥
                const surCompleted = values.completed;
                const surScheduled = values.scheduled_date;
                const surStaff = getStaffInfo();

                // äºˆå®šæ—¥ãŒéå»ã‹ãƒã‚§ãƒƒã‚¯
                let surScheduledPast = false;
                if (surScheduled) {
                    const scheduled = new Date(surScheduled);
                    scheduled.setHours(0, 0, 0, 0);
                    surScheduledPast = scheduled < today;
                }

                if (surCompleted || surScheduledPast) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">ç¾èª¿æ¸ˆã¿</span> ${surScheduled ? formatDate(surScheduled) : ''}${surStaff ? ' (' + surStaff + ')' : ''}`
                    };
                } else if (surScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">ç¾èª¿å¾…ã¡</span> ${formatDate(surScheduled)}${surStaff ? ' (' + surStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            case 'estimate':  // è¦‹ç©ã‚‚ã‚Šç™ºè¡Œæ—¥
                const estIssued = values.issued_date;
                const estNotRequired = values.not_required;

                if (estNotRequired) {
                    return {
                        completed: true,
                        status: 'approved',
                        statusText: '<span class="badge bg-success">è¦‹ç©ã‚‚ã‚Šä¸è¦</span>'
                    };
                } else if (estIssued) {
                    return {
                        completed: false,
                        status: 'under_review',
                        statusText: `<span class="badge bg-warning">è¦‹ç©ã‚‚ã‚Šå¯©æŸ»ä¸­</span> ${formatDate(estIssued)}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            case 'construction_start':  // ç€å·¥æ—¥ï¼ˆå®Ÿæ–½æ—¥å„ªå…ˆã€äºˆå®šæ—¥ãƒ™ãƒ¼ã‚¹ï¼šäºˆå®šæ—¥ãŒéå»ãªã‚‰è‡ªå‹•å®Œäº†ï¼‰
                const csCompleted = values.completed;
                const csScheduled = values.scheduled_date;
                const csActual = values.actual_date;
                const csStaff = getStaffInfo();

                // å®Ÿæ–½æ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã‚Œã‚’å„ªå…ˆ
                if (csActual) {
                    return {
                        completed: true,
                        status: 'in_progress',
                        statusText: `<span class="badge bg-primary">å·¥äº‹ä¸­</span> ${formatDate(csActual)}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                }

                // äºˆå®šæ—¥ãŒéå»ã‹ãƒã‚§ãƒƒã‚¯
                let csScheduledPast = false;
                if (csScheduled) {
                    const scheduled = new Date(csScheduled);
                    scheduled.setHours(0, 0, 0, 0);
                    csScheduledPast = scheduled < today;
                }

                if (csCompleted || csScheduledPast) {
                    return {
                        completed: true,
                        status: 'in_progress',
                        statusText: `<span class="badge bg-primary">å·¥äº‹ä¸­</span> ${csScheduled ? formatDate(csScheduled) : ''}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                } else if (csScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">ç€å·¥æ—¥å¾…ã¡</span> ${formatDate(csScheduled)}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            case 'completion':  // å®Œå·¥æ—¥ï¼ˆå®Ÿæ–½æ—¥å„ªå…ˆã€äºˆå®šæ—¥ãƒ™ãƒ¼ã‚¹ï¼šäºˆå®šæ—¥ãŒéå»ãªã‚‰è‡ªå‹•å®Œäº†ï¼‰
                const compCompleted = values.completed;
                const compScheduled = values.scheduled_date;
                const compActual = values.actual_date;

                // å®Ÿæ–½æ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€ãã‚Œã‚’å„ªå…ˆ
                if (compActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">å®Œå·¥</span> ${formatDate(compActual)}`
                    };
                }

                // äºˆå®šæ—¥ãŒéå»ã‹ãƒã‚§ãƒƒã‚¯
                let compScheduledPast = false;
                if (compScheduled) {
                    const scheduled = new Date(compScheduled);
                    scheduled.setHours(0, 0, 0, 0);
                    compScheduledPast = scheduled < today;
                }

                if (compCompleted || compScheduledPast) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">å®Œå·¥</span> ${compScheduled ? formatDate(compScheduled) : ''}`
                    };
                } else if (compScheduled) {
                    // ç€å·¥æ—¥ã®çŠ¶æ…‹ã‚’ç¢ºèªï¼ˆå®Ÿæ–½æ—¥ã€completedãƒ™ãƒ¼ã‚¹ã€ã¾ãŸã¯äºˆå®šæ—¥éå»ï¼‰
                    const constructionStartStep = $('#activeSteps .progress-step[data-step="construction_start"]');
                    let isConstructionStarted = false;

                    if (constructionStartStep.length > 0) {
                        const csActualInput = constructionStartStep.find('input[name*="actual_date"]');
                        const csCompletedInput = constructionStartStep.find('input[name*="completed"]');
                        const csScheduledInput = constructionStartStep.find('.scheduled-date-input');

                        // ç€å·¥æ—¥ã®å®Ÿæ–½æ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                        const hasActualDate = csActualInput.length > 0 && csActualInput.val();

                        const csIsCompleted = csCompletedInput.length > 0 && csCompletedInput.is(':checked');

                        // ç€å·¥æ—¥ã®äºˆå®šæ—¥ãŒéå»ã‹ãƒã‚§ãƒƒã‚¯
                        let csScheduledPast = false;
                        if (csScheduledInput.length > 0 && csScheduledInput.val()) {
                            const csScheduled = new Date(csScheduledInput.val());
                            csScheduled.setHours(0, 0, 0, 0);
                            csScheduledPast = csScheduled < today;
                        }

                        isConstructionStarted = hasActualDate || csIsCompleted || csScheduledPast;
                    }

                    if (isConstructionStarted) {
                        return {
                            completed: false,
                            status: 'in_progress',
                            statusText: `<span class="badge bg-info">æ–½å·¥ä¸­</span> äºˆå®š: ${formatDate(compScheduled)}`
                        };
                    } else {
                        return {
                            completed: false,
                            status: 'waiting',
                            statusText: `<span class="badge bg-warning">ç€å·¥å¾…ã¡</span> äºˆå®š: ${formatDate(compScheduled)}`
                        };
                    }
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            default:
                // ãã®ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼šä½•ã‹å€¤ãŒã‚ã‚Œã°å®Œäº†
                const hasAnyValue = Object.values(values).some(value =>
                    typeof value === 'boolean' ? value : (value && value.trim && value.trim())
                );

                if (hasAnyValue) {
                    return { completed: true, status: 'completed', statusText: '<span class="badge bg-success">å®Œäº†</span>' };
                } else {
                    return { completed: false, status: 'pending', statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>' };
                }
        }
    }

    // æ‹…å½“è€…ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ï¼‰
    let staffMaster = [
        {% for worker in internal_workers %}
        {
            id: '{{ worker.id }}',
            name: '{{ worker.name }}',
            department: '{{ worker.get_department_display|default:"" }}',
            phone: '{{ worker.phone|default:"" }}',
            hourly_rate: parseFloat("{{ worker.hourly_rate|default:0 }}".replace(/,/g, '')) || 0,
            specialties: '{{ worker.specialties|default:"" }}',
            active: {% if worker.is_active %}true{% else %}false{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // ã‚¹ã‚¿ãƒƒãƒ•åã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getStaffName(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        return staff ? staff.name : 'ä¸æ˜';
    }

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ã‚¿ãƒƒãƒ•ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
    function generateStaffOptions() {
        const activeStaff = staffMaster.filter(s => s.active);
        return [
            { value: '', text: 'é¸æŠã—ã¦ãã ã•ã„' },
            ...activeStaff.map(staff => ({
                value: staff.id,
                text: `${staff.name} (${staff.department})`
            }))
        ];
    }

    // dependencyæ©Ÿèƒ½ - ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    $(document).on('change', 'input[type="radio"]', function() {
        const changedFieldName = $(this).attr('name');
        const selectedValue = $(this).val();

        // ã“ã®å¤‰æ›´ã«ä¾å­˜ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤º
        $(`[data-dependency-field="${changedFieldName}"]`).each(function() {
            const dependencyValue = $(this).data('dependency-value');
            if (selectedValue === dependencyValue) {
                $(this).show();
            } else {
                $(this).hide();
                // éè¡¨ç¤ºã«ãªã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’ã‚¯ãƒªã‚¢
                $(this).find('input, select').val('');
            }
        });
    });

    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name^="survey_"], select[name^="survey_"]', function() {
        const stepElement = $('.progress-step[data-step="survey"]');
        if (stepElement.length === 0) return;

        // ç¾å ´èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const sitesurvey = availableSteps.find(step => step.key === 'survey');
        if (!sitesurvey) return;

        const status = getComplexStepStatus(sitesurvey, stepElement);

        if (status.completed) {
            stepElement.addClass('completed');
        } else {
            stepElement.removeClass('completed');
        }

        stepElement.find('.progress-step-date').html(status.statusText);

        // é€²æ—æ›´æ–°
        updateProgressTimeline();
        updateProgressStatus();
    });

    // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã
    window.openStaffManagementPanel = function() {
        $('#staffManagementModal').modal('show');
        refreshStaffList();
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’æ›´æ–°
    function refreshStaffList() {
        const tbody = $('#staffTableBody');
        tbody.empty();

        staffMaster.forEach((staff, index) => {
            const statusBadge = staff.active ?
                '<span class="badge bg-success">æœ‰åŠ¹</span>' :
                '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

            const hourlyRateDisplay = staff.hourly_rate ? `Â¥${staff.hourly_rate}/æ™‚é–“` : '-';
            tbody.append(`
                <tr data-staff-id="${staff.id}" style="cursor: pointer;" onclick="selectStaff('${staff.id}')" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                    <td><strong>${staff.name}</strong></td>
                    <td>${staff.department}</td>
                    <td>${hourlyRateDisplay}</td>
                    <td>${staff.specialties || '-'}</td>
                    <td>${statusBadge}</td>
                    <td onclick="event.stopPropagation()">
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="editStaff('${staff.id}')">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    // æ‹…å½“è€…ã‚’é¸æŠã—ã¦ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«åæ˜ 
    window.selectStaff = function(staffId) {
        console.log('âœ… selectStaff called', staffId);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const modalElement = document.getElementById('staffManagementModal');
        if (modalElement) {
            $(modalElement).removeClass('show').css('display', 'none');
            $('.modal-backdrop').remove();
            $('body').removeClass('modal-open').css('overflow', '');
        }

        // æœ€å¾Œã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚Œã¦ã„ãŸæ‹…å½“è€…é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
        const lastFocusedSelect = $('.staff-select-container select').last();
        if (lastFocusedSelect.length > 0) {
            lastFocusedSelect.val(staffId);
            console.log('âœ… æ‹…å½“è€…ã‚’é¸æŠã—ã¾ã—ãŸ:', staffId);
        } else {
            // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã•ã‚ŒãŸãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã¯ã€ã™ã¹ã¦ã®staff_select_listãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ€åˆã®ç©ºæ¬„ã‚’åŸ‹ã‚ã‚‹
            $('.staff-select-container select').each(function() {
                if (!$(this).val()) {
                    $(this).val(staffId);
                    console.log('âœ… æ‹…å½“è€…ã‚’é¸æŠã—ã¾ã—ãŸï¼ˆç©ºæ¬„ã«ï¼‰:', staffId);
                    return false; // break
                }
            });
        }
    };

    // ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
    window.addNewStaff = function() {
        $('#staffModalTitle').text('æ–°ã—ã„æ‹…å½“è€…ã‚’è¿½åŠ ');
        $('#staffForm')[0].reset();
        $('#staffId').val('');
        $('#staffModal').modal('show');
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†
    window.editStaff = function(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        if (!staff) return;

        $('#staffModalTitle').text('æ‹…å½“è€…ã‚’ç·¨é›†');
        $('#staffId').val(staff.id);
        $('#staffName').val(staff.name);
        $('#staffDepartment').val(staff.department);
        $('#staffPhone').val(staff.phone || '');
        $('#staffHourlyRate').val(staff.hourly_rate || '');
        $('#staffSpecialties').val(staff.specialties || '');
        $('#staffActive').prop('checked', staff.active);
        $('#staffModal').modal('show');
    };

    // ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤
    window.deleteStaff = function(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        if (!staff) return;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«æ‹…å½“è€…åã‚’è¨­å®š
        $('#deleteStaffName').text(staff.name);

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        const modal = new bootstrap.Modal(document.getElementById('staffDeleteConfirmModal'));
        modal.show();

        // backdrop z-indexã‚’èª¿æ•´
        setTimeout(function() {
            $('.modal-backdrop').last().css('z-index', 10049);
        }, 10);

        // ç¢ºèªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
        $('#confirmDeleteStaffBtn').off('click').on('click', function() {
            $(this).prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>å‰Šé™¤ä¸­...');

            $.ajax({
                url: `/orders/api/staff/${staffId}/`,
                method: 'DELETE',
                dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
                success: function(response) {
                    console.log('å‰Šé™¤æˆåŠŸ:', response);

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                    if (response && response.success) {
                        staffMaster = staffMaster.filter(s => s.id !== staffId);
                        refreshStaffList();
                        updateStaffSelects();
                        modal.hide();
                        if (typeof toastr !== 'undefined') {
                            toastr.success('æ‹…å½“è€…ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                        }
                    } else {
                        console.error('å‰Šé™¤å¤±æ•—:', response);
                        if (typeof toastr !== 'undefined') {
                            toastr.error(response.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        } else {
                            showErrorModal('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.error || ''));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });

                    let errorMessage = 'å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                    } else if (xhr.status === 403) {
                        errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                    } else if (xhr.status === 404) {
                        errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ‹…å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    } else if (xhr.status >= 500) {
                        errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                    }

                    if (typeof toastr !== 'undefined') {
                        toastr.error(errorMessage);
                    }
                },
                complete: function() {
                    $('#confirmDeleteStaffBtn').prop('disabled', false).html('<i class="fas fa-trash me-2"></i>å‰Šé™¤ã™ã‚‹');
                }
            });
        });
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ä¿å­˜
    window.saveStaff = function() {
        const staffId = $('#staffId').val();
        const name = $('#staffName').val().trim();
        const department = $('#staffDepartment').val().trim();
        const phone = $('#staffPhone').val().trim();
        const hourly_rate = parseFloat($('#staffHourlyRate').val()) || 0;
        const specialties = $('#staffSpecialties').val().trim();
        const active = $('#staffActive').is(':checked');

        if (!name) {
            showErrorModal('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const staffData = {
            name: name,
            department: department,
            phone: phone,
            hourly_rate: hourly_rate,
            specialties: specialties,
            active: active
        };

        if (staffId) {
            // æ—¢å­˜ã‚¹ã‚¿ãƒƒãƒ•ã‚’æ›´æ–°
            $.ajax({
                url: `/orders/api/staff/${staffId}/`,
                method: 'PUT',
                dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
                data: JSON.stringify(staffData),
                contentType: 'application/json',
                success: function(response) {
                    console.log('æ›´æ–°æˆåŠŸ:', response);

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                    if (response && response.success) {
                        const staff = staffMaster.find(s => s.id === staffId);
                        if (staff) {
                            Object.assign(staff, response.staff);
                        }
                        $('#staffModal').modal('hide');
                        refreshStaffList();
                        updateStaffSelects();
                        if (typeof toastr !== 'undefined') {
                            toastr.success('æ‹…å½“è€…ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                        }
                    } else {
                        console.error('æ›´æ–°å¤±æ•—:', response);
                        if (typeof toastr !== 'undefined') {
                            toastr.error(response.error || 'æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        } else {
                            showErrorModal('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.error || ''));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('æ›´æ–°ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });

                    let errorMessage = 'æ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                    } else if (xhr.status === 403) {
                        errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                    } else if (xhr.status === 404) {
                        errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ‹…å½“è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    } else if (xhr.status >= 500) {
                        errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                    }

                    if (typeof toastr !== 'undefined') {
                        toastr.error(errorMessage);
                    } else {
                        showErrorModal(errorMessage);
                    }
                }
            });
        } else {
            // æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ 
            $.ajax({
                url: '/orders/api/staff/',
                method: 'POST',
                dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
                data: JSON.stringify(staffData),
                contentType: 'application/json',
                success: function(response) {
                    console.log('è¿½åŠ æˆåŠŸ:', response);

                    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
                    if (response && response.success) {
                        staffMaster.push(response.staff);
                        $('#staffModal').modal('hide');
                        refreshStaffList();
                        updateStaffSelects();
                        if (typeof toastr !== 'undefined') {
                            toastr.success('æ‹…å½“è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
                        }
                    } else {
                        console.error('è¿½åŠ å¤±æ•—:', response);
                        if (typeof toastr !== 'undefined') {
                            toastr.error(response.error || 'è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ');
                        } else {
                            showErrorModal('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.error || ''));
                        }
                    }
                },
                error: function(xhr, status, error) {
                    console.error('è¿½åŠ ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                        status: status,
                        error: error,
                        responseText: xhr.responseText,
                        statusCode: xhr.status
                    });

                    let errorMessage = 'è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    } else if (xhr.status === 0) {
                        errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
                    } else if (xhr.status === 403) {
                        errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
                    } else if (xhr.status === 404) {
                        errorMessage = 'ã‚¨ãƒ©ãƒ¼: ãƒªã‚½ãƒ¼ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
                    } else if (xhr.status >= 500) {
                        errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
                    }

                    if (typeof toastr !== 'undefined') {
                        toastr.error(errorMessage);
                    } else {
                        showErrorModal(errorMessage);
                    }
                }
            });
        }
    };

    // å…¨ã¦ã®ã‚¹ã‚¿ãƒƒãƒ•é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    function updateStaffSelects() {
        const newOptions = generateStaffOptions();
        $('select[name="survey_staff_id"]').each(function() {
            const currentValue = $(this).val();
            $(this).empty();
            newOptions.forEach(option => {
                const selected = option.value === currentValue ? 'selected' : '';
                $(this).append(`<option value="${option.value}" ${selected}>${option.text}</option>`);
            });
        });
    }

    // åˆæœŸåŒ–å‡¦ç†
    $(document).ready(function() {
        console.log('Document ready - starting step initialization');

        // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®å­˜åœ¨ç¢ºèª
        console.log('Survey content area exists:', $('#surveyContentArea').length);
        console.log('Survey content area visible:', $('#surveyContentArea').is(':visible'));

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰åˆæœŸåŒ–
        setTimeout(function() {
            console.log('Clearing fallback display and initializing steps');
            $('#activeSteps').empty();

            // ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸåŒ–
            initializeSteps();
            // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ­ãƒ¼ãƒ‰
            loadAvailableSteps();
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸå€¤ã«åŸºã¥ã„ã¦ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã‚’åŒæœŸ
            syncFormFieldsToSteps();

            // è¦‹ç©ã‚‚ã‚Šãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
            setTimeout(loadEstimateFiles, 500);  // ã‚¹ãƒ†ãƒƒãƒ—ç”Ÿæˆå®Œäº†ã‚’å¾…ã¤

            // åˆæœŸçŠ¶æ…‹ã§ç·¨é›†è¦ç´ ã‚’è¡¨ç¤ºï¼ˆeditMode = true - å¸¸ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ï¼‰
            console.log('Setting initial edit mode state (ON - always enabled)');
            $('.remove-step-btn').show();
            $('.drag-handle').show();
            $('#stepInventory').show();

            // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ­ãƒ¼ãƒ‰
            if (typeof loadAvailableSteps === 'function') {
                loadAvailableSteps();
            }

            // åˆæœŸåŒ–å®Œäº†å¾Œã«é€²æ—çŠ¶æ³ã‚’æ›´æ–°
            if (typeof updateProgressStatus === 'function') {
                updateProgressStatus();
            }

            console.log('Step initialization complete');
        }, 100);
    });
});

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ç¢ºèª - Phase 5
function confirmFileDelete(fileId, fileName) {
    showConfirmModal(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`, function() {
        const form = document.getElementById('fileDeleteForm');
        form.action = `/orders/projects/${projectId}/files/${fileId}/delete/`;
        form.submit();
    });
}
</script>

<!-- æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffManagementModal" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffManagementModalLabel">
                    <i class="fas fa-users"></i> æ‹…å½“è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">æ‹…å½“è€…ä¸€è¦§</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewStaff()">
                        <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>éƒ¨ç½²</th>
                                <th>æ™‚çµ¦</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç·¨é›†/è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalTitle">æ‹…å½“è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    <div class="mb-3">
                        <label for="staffName" class="form-label">æ‹…å½“è€…å <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="staffName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staffDepartment" class="form-label">éƒ¨ç½²</label>
                        <input type="text" class="form-control" id="staffDepartment" name="department">
                    </div>
                    <div class="mb-3">
                        <label for="staffHourlyRate" class="form-label">æ™‚çµ¦</label>
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control" id="staffHourlyRate" name="hourly_rate" placeholder="ä¾‹: 3000">
                            <span class="input-group-text">/æ™‚é–“</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="staffSpecialties" name="specialties" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="staffActive" name="active" checked>
                        <label class="form-check-label" for="staffActive">
                            æœ‰åŠ¹
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffDeleteConfirmModal" tabindex="-1" style="z-index: 10050 !important;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>å‰Šé™¤ã®ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>æ‹…å½“è€…ã€Œ<strong id="deleteStaffName"></strong>ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteStaffBtn">
                    <i class="fas fa-trash me-2"></i>å‰Šé™¤ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ä¸‹è«‹ã‘ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="subcontractModal" tabindex="-1" aria-labelledby="subcontractModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="subcontractModalLabel">
                    <i class="fas fa-user-plus me-2"></i>ä½œæ¥­è€…ã‚’è¿½åŠ 
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="subcontractForm">
                    {% csrf_token %}
                    <input type="hidden" id="subcontractStep" name="step">

                    <div class="mb-3">
                        <label class="form-label">
                            ç™ºæ³¨å…ˆ <span class="text-danger">*</span>
                        </label>
                        <div class="d-flex gap-2 align-items-center">
                            <input type="hidden" id="subcontractContractor" name="contractor" required>
                            <input type="text" id="selectedContractorDisplay" class="form-control" readonly placeholder="ä¸‹è«‹ã‘ç®¡ç†ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„" style="flex: 1; background-color: #f8f9fa; cursor: pointer;" onclick="openContractorManagementPanel()">
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="openContractorManagementPanel()" title="ä¸‹è«‹ã‘æ¥­è€…ã‚’é¸æŠãƒ»ç®¡ç†">
                                <i class="fas fa-handshake"></i> ä¸‹è«‹ã‘ç®¡ç†
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            ä¸‹è«‹ã‘ç®¡ç†ãƒœã‚¿ãƒ³ã‹ã‚‰æ¥­è€…ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®æ¥­è€…ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«ãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™
                        </small>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subcontractContractAmount" class="form-label">
                                    ç™ºæ³¨é‡‘é¡
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="number" class="form-control" id="subcontractContractAmount" name="contract_amount">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subcontractBilledAmount" class="form-label">
                                    è«‹æ±‚é‡‘é¡
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">Â¥</span>
                                    <input type="number" class="form-control" id="subcontractBilledAmount" name="billed_amount">
                                </div>
                                <small class="form-text text-muted">å®Ÿéš›ã«è«‹æ±‚ã•ã‚ŒãŸé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰</small>
                            </div>
                        </div>
                    </div>

                    <!-- ç™ºæ³¨å…ˆã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ”¯æ‰•ã„æƒ…å ±ï¼ˆè¡¨ç¤ºã®ã¿ï¼‰ -->
                    <div class="alert alert-info" style="display: none;" id="contractorPaymentInfo">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="alert-heading mb-0">
                                <i class="fas fa-info-circle me-1"></i>ç™ºæ³¨å…ˆã®æ”¯æ‰•ã„æ¡ä»¶
                            </h6>
                            <button type="button" class="btn btn-sm btn-outline-warning" onclick="enableCustomPaymentDate()">
                                <i class="fas fa-exclamation-triangle me-1"></i>ä¾‹å¤–å‡¦ç†
                            </button>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-4">
                                <small class="text-muted">æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«:</small>
                                <div><span id="contractorPaymentCycleDisplay">-</span></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">ç· æ—¥:</small>
                                <div><span id="contractorClosingDayDisplay">-</span></div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">æ”¯æ‰•æ—¥:</small>
                                <div><span id="contractorPaymentDayDisplay">-</span></div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                ç™ºæ³¨å…ˆã¨ã®å¥‘ç´„ä¸Šã®æ”¯æ‰•ã„æ¡ä»¶ï¼ˆå‚è€ƒæƒ…å ±ï¼‰
                            </small>
                        </div>
                    </div>

                    <!-- å€‹åˆ¥æ”¯æ‰•æœŸé™è¨­å®šï¼ˆä¾‹å¤–å‡¦ç†ï¼‰ -->
                    <div id="customPaymentDateSection" style="display: none;">
                        <div class="alert alert-warning">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="alert-heading mb-0">
                                    <i class="fas fa-exclamation-triangle me-1"></i>ä¾‹å¤–å‡¦ç†ï¼šå€‹åˆ¥æ”¯æ‰•æœŸé™
                                </h6>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="disableCustomPaymentDate()">
                                    <i class="fas fa-undo me-1"></i>é€šå¸¸ã«æˆ»ã™
                                </button>
                            </div>
                            <small class="text-muted d-block mb-3">
                                ã“ã®æ¡ˆä»¶ã®ã¿ã€ç™ºæ³¨å…ˆã®é€šå¸¸ã®æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«ã¨ã¯ç•°ãªã‚‹æ”¯æ‰•æœŸé™ã‚’è¨­å®šã—ã¾ã™
                            </small>

                            <div class="mb-0">
                                <label for="subcontractPaymentDueDate" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>æ”¯æ‰•æœŸé™ <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="subcontractPaymentDueDate" name="payment_due_date">
                                <small class="form-text text-muted">ã“ã®æ¡ˆä»¶å°‚ç”¨ã®å‡ºé‡‘äºˆå®šæ—¥ã‚’è¨­å®šã—ã¦ãã ã•ã„</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subcontractPaymentDate" class="form-label">
                                    å®Ÿéš›ã®æ”¯æ‰•æ—¥
                                </label>
                                <input type="date" class="form-control" id="subcontractPaymentDate" name="payment_date">
                                <small class="form-text text-muted">å®Ÿéš›ã«æ”¯æ‰•ã£ãŸæ—¥ä»˜ï¼ˆä»»æ„ï¼‰</small>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subcontractPaymentStatus" class="form-label">
                                    æ”¯æ‰•çŠ¶æ³
                                </label>
                                <select class="form-select" id="subcontractPaymentStatus" name="payment_status">
                                    <option value="pending">æœªæ‰•ã„</option>
                                    <option value="processing">å‡¦ç†ä¸­</option>
                                    <option value="paid">æ”¯æ‰•æ¸ˆ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="subcontractWorkDescription" class="form-label">
                            ä½œæ¥­å†…å®¹
                        </label>
                        <textarea class="form-control" id="subcontractWorkDescription" name="work_description" rows="3"></textarea>
                    </div>

                    <!-- ç™ºæ³¨æ›¸ç™ºè¡Œæ¸ˆã¿ -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="subcontractPurchaseOrderIssued" name="purchase_order_issued">
                            <label class="form-check-label" for="subcontractPurchaseOrderIssued">
                                <i class="fas fa-file-invoice me-1"></i>ç™ºæ³¨æ›¸ç™ºè¡Œæ¸ˆã¿
                            </label>
                        </div>
                    </div>

                    <!-- éƒ¨æè²»ç®¡ç†ï¼ˆæŠ˜ã‚ŠãŸãŸã¿å¯èƒ½ï¼‰ -->
                    <div class="card mb-3 border-secondary">
                        <div class="card-header bg-light" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#materialCostSection">
                            <h6 class="mb-0">
                                <i class="fas fa-boxes me-2"></i>éƒ¨æè²»ï¼ˆä»»æ„ï¼‰
                                <i class="fas fa-chevron-down float-end"></i>
                            </h6>
                        </div>
                        <div id="materialCostSection" class="collapse">
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem1" class="form-label">éƒ¨æè²»é …ç›®â‘ </label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem1" name="material_item_1" placeholder="ä¾‹ï¼šæœ¨æ">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost1" class="form-label">éƒ¨æè²»ä»£â‘ </label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost1" name="material_cost_1">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem2" class="form-label">éƒ¨æè²»é …ç›®â‘¡</label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem2" name="material_item_2" placeholder="ä¾‹ï¼šé‡‘å…·">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost2" class="form-label">éƒ¨æè²»ä»£â‘¡</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost2" name="material_cost_2">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialItem3" class="form-label">éƒ¨æè²»é …ç›®â‘¢</label>
                                        <input type="text" class="form-control" id="subcontractMaterialItem3" name="material_item_3" placeholder="ä¾‹ï¼šå¡—æ–™">
                                    </div>
                                    <div class="col-md-6">
                                        <label for="subcontractMaterialCost3" class="form-label">éƒ¨æè²»ä»£â‘¢</label>
                                        <div class="input-group">
                                            <span class="input-group-text">Â¥</span>
                                            <input type="number" class="form-control material-cost-input" id="subcontractMaterialCost3" name="material_cost_3">
                                        </div>
                                    </div>
                                </div>
                                <!-- éƒ¨æè²»åˆè¨ˆè¡¨ç¤º -->
                                <div class="alert alert-info mb-0">
                                    <strong>éƒ¨æè²»åˆè¨ˆ: Â¥<span id="modalMaterialTotalAmount">0</span></strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ç·ã‚³ã‚¹ãƒˆè¡¨ç¤º -->
                    <div class="alert alert-warning mb-3">
                        <h6 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>
                            <strong>ç·ã‚³ã‚¹ãƒˆ: Â¥<span id="modalTotalCostAmount">0</span></strong>
                        </h6>
                        <small class="text-muted">ï¼ˆ<span id="modalCostBaseLabel">å¥‘ç´„é‡‘é¡</span> + éƒ¨æè²»åˆè¨ˆï¼‰</small>
                    </div>

                    <!-- ä»–ã®å·¥ç¨‹ã«ã‚‚è¿½åŠ  -->
                    <div class="mb-3" id="additionalStepsSection" style="display: none;">
                        <div class="card border-info">
                            <div class="card-header bg-light">
                                <h6 class="mb-0">
                                    <i class="fas fa-clone me-2"></i>ä»–ã®å·¥ç¨‹ã«ã‚‚è¿½åŠ 
                                </h6>
                                <small class="text-muted">åŒã˜æ¥­è€…ãƒ»åŒã˜æ¡ä»¶ã§è¤‡æ•°ã®å·¥ç¨‹ã«ä¸€æ‹¬ç™»éŒ²ã§ãã¾ã™</small>
                            </div>
                            <div class="card-body">
                                <!-- å·¥ç¨‹é¸æŠãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ -->
                                <div id="additionalStepsCheckboxes" class="mb-3">
                                    <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                                </div>

                                <!-- é‡‘é¡ã®è¨­å®šæ–¹æ³•ã‚’é¸æŠ -->
                                <div id="costAllocationSection" style="display: none;">
                                    <hr class="my-3">
                                    <h6 class="mb-3">
                                        <i class="fas fa-yen-sign me-2"></i>é‡‘é¡ã®è¨­å®šæ–¹æ³•
                                    </h6>
                                    <div class="mb-3">
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="cost_allocation_method" id="costMethodLumpSum" value="lump_sum" checked>
                                            <label class="form-check-label" for="costMethodLumpSum">
                                                <strong>å…¨å·¥ç¨‹ä¸€å¼ã§ç™»éŒ²</strong>
                                                <div class="text-muted small">ä¸Šè¨˜ã®å¥‘ç´„é‡‘é¡ã§å…¨å·¥ç¨‹ã‚’ã‚«ãƒãƒ¼ã—ã¾ã™ï¼ˆè¿½åŠ å·¥ç¨‹ã¯Â¥0ã§é–¢é€£ä»˜ã‘ï¼‰</div>
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="cost_allocation_method" id="costMethodPerStep" value="per_step">
                                            <label class="form-check-label" for="costMethodPerStep">
                                                <strong>å·¥ç¨‹ã”ã¨ã«é‡‘é¡ã‚’è¨­å®š</strong>
                                                <div class="text-muted small">å„å·¥ç¨‹ã®é‡‘é¡ã‚’å€‹åˆ¥ã«å…¥åŠ›ã—ã¾ã™</div>
                                            </label>
                                        </div>
                                    </div>

                                    <!-- å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›æ¬„ -->
                                    <div id="perStepAmountsSection" style="display: none;">
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-1"></i>å„å·¥ç¨‹ã®å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
                                        </div>
                                        <div id="perStepAmountsInputs">
                                            <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="subcontractNotes" class="form-label">
                            å‚™è€ƒ
                        </label>
                        <textarea class="form-control" id="subcontractNotes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-primary" onclick="saveSubcontract()">
                    <i class="fas fa-save me-1"></i>ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- è³‡æç™ºæ³¨ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="materialOrderModal" tabindex="-1" aria-labelledby="materialOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="materialOrderModalLabel">
                    <i class="fas fa-box-open me-2"></i>è³‡æç™ºæ³¨ã‚’è¿½åŠ 
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="materialOrderForm">
                    {% csrf_token %}

                    <!-- è³‡ææ¥­è€…é¸æŠ -->
                    <div class="mb-3">
                        <label for="materialContractor" class="form-label">
                            è³‡ææ¥­è€… <span class="text-danger">*</span>
                        </label>
                        <div class="d-flex gap-2">
                            <select class="form-select" id="materialContractor" name="contractor" required style="flex: 1;">
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                {% for contractor in contractors %}
                                <option value="{{ contractor.id }}">{{ contractor.name }}</option>
                                {% endfor %}
                            </select>
                            <a href="{% url 'order_management:contractor_create' %}?back={{ request.path }}" target="_blank" class="btn btn-outline-warning" title="æ–°è¦æ¥­è€…ã‚’è¿½åŠ ">
                                <i class="fas fa-plus"></i>
                            </a>
                        </div>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle me-1"></i>æ–°ã—ã„æ¥­è€…ã‚’è¿½åŠ ã™ã‚‹å ´åˆã¯<i class="fas fa-plus"></i>ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„
                        </small>
                    </div>

                    <!-- ç™ºæ³¨æƒ…å ± -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="materialOrderDate" class="form-label">
                                    ç™ºæ³¨æ—¥ <span class="text-danger">*</span>
                                </label>
                                <input type="date" class="form-control" id="materialOrderDate" name="order_date" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="materialDeliveryDate" class="form-label">
                                    å¸Œæœ›ç´æœŸ
                                </label>
                                <input type="date" class="form-control" id="materialDeliveryDate" name="delivery_date">
                            </div>
                        </div>
                    </div>

                    <!-- è³‡æé …ç›® -->
                    <div class="mb-3">
                        <h6 class="text-warning border-bottom border-warning pb-2 mb-3">
                            <i class="fas fa-boxes me-1"></i>è³‡æé …ç›®
                        </h6>
                        <div id="materialItems">
                            <!-- æœ€åˆã®è³‡æé …ç›® -->
                            <div class="material-item mb-3 p-3 bg-light rounded">
                                <div class="row">
                                    <div class="col-md-4">
                                        <label class="form-label">è³‡æå <span class="text-danger">*</span></label>
                                        <input type="text" name="material_name[]" class="form-control" placeholder="ä¾‹: ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ" required>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">æ•°é‡</label>
                                        <input type="number" name="quantity[]" class="form-control material-quantity" step="0.01" placeholder="0.00">
                                    </div>
                                    <div class="col-md-2">
                                        <label class="form-label">å˜ä½</label>
                                        <input type="text" name="unit[]" class="form-control" placeholder="ä¾‹: mÂ³">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">å˜ä¾¡(å††)</label>
                                        <input type="number" name="unit_price[]" class="form-control material-unit-price" step="0.01" placeholder="0.00">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-12">
                                        <label class="form-label">ä»•æ§˜ãƒ»è¦æ ¼</label>
                                        <input type="text" name="specification[]" class="form-control" placeholder="ä¾‹: 24-21-20">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- è³‡æé …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ -->
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="addMaterialItem()">
                            <i class="fas fa-plus me-1"></i>è³‡æé …ç›®ã‚’è¿½åŠ 
                        </button>
                    </div>

                    <!-- åˆè¨ˆé‡‘é¡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ -->
                    <div class="mb-3">
                        <div class="alert alert-warning">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <strong><i class="fas fa-calculator me-1"></i>åˆè¨ˆé‡‘é¡:</strong>
                                </div>
                                <div class="col-md-6 text-end">
                                    <h4 class="mb-0" id="materialTotalAmount">Â¥0</h4>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å‚™è€ƒ -->
                    <div class="mb-3">
                        <label for="materialNotes" class="form-label">
                            å‚™è€ƒ
                        </label>
                        <textarea class="form-control" id="materialNotes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-warning" onclick="saveMaterialOrder()">
                    <i class="fas fa-save me-1"></i>ä¿å­˜
                </button>
            </div>
        </div>
    </div>
</div>

<!-- æ¡ˆä»¶ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - Phase 5 -->
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-folder-open me-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
                </h5>
                <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-light btn-sm">
                    <i class="fas fa-cloud-upload-alt me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if project.files.all %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="40%">ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                <th width="15%">ã‚µã‚¤ã‚º</th>
                                <th width="20%">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è€…</th>
                                <th width="15%">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th>
                                <th width="10%" class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in project.files.all %}
                            <tr>
                                <td>
                                    {% if 'pdf' in file.file_type %}
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {% elif 'word' in file.file_type or 'document' in file.file_type %}
                                        <i class="fas fa-file-word text-primary me-2"></i>
                                    {% elif 'excel' in file.file_type or 'spreadsheet' in file.file_type %}
                                        <i class="fas fa-file-excel text-success me-2"></i>
                                    {% elif 'image' in file.file_type or 'jpg' in file.file_type or 'png' in file.file_type %}
                                        <i class="fas fa-file-image text-info me-2"></i>
                                    {% else %}
                                        <i class="fas fa-file text-secondary me-2"></i>
                                    {% endif %}
                                    <strong>{{ file.file_name }}</strong>
                                    {% if file.description %}
                                        <br><small class="text-muted ms-4">{{ file.description }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ file.get_file_size_display }}</span>
                                </td>
                                <td>
                                    {% if file.uploaded_by %}
                                        <i class="fas fa-user-circle me-1"></i>{{ file.uploaded_by.get_full_name|default:file.uploaded_by.username }}
                                    {% else %}
                                        <span class="text-muted">ä¸æ˜</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ file.uploaded_at|date:"Y/m/d H:i" }}</small>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'order_management:project_file_download' project.pk file.pk %}"
                                           class="btn btn-outline-primary"
                                           title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-outline-danger"
                                                onclick="confirmFileDelete({{ file.pk }}, '{{ file.file_name }}')"
                                                title="å‰Šé™¤">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p class="mb-2">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-info">
                        <i class="fas fa-cloud-upload-alt me-1"></i>æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ç¢ºèªç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ  (éè¡¨ç¤º) - Phase 5 -->
<form id="fileDeleteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

<style>
/* ãƒãƒ£ãƒƒãƒˆUIã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-item {
    position: relative;
    border-left: 3px solid #dee2e6;
    padding: 15px;
    padding-right: 50px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s;
}

.comment-item:hover {
    border-left-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.comment-item.important {
    border-left-color: #ffc107;
    background: #fff3cd;
}

/* ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ãƒã‚¿ãƒ¼ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.user-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
    font-weight: 600;
    font-size: 0.85rem;
    color: white;
    flex-shrink: 0;
}

.user-avatar img {
    width: 100%;
    height: 100%;
    border-radius: 50%;
    object-fit: cover;
}

.user-avatar.initials {
    background: #007bff;
}

.comment-header {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.comment-author {
    font-weight: 600;
    color: #0d6efd;
    margin-right: 10px;
}

.comment-date {
    color: #6c757d;
    font-size: 0.9em;
}

.comment-content {
    margin-top: 10px;
    line-height: 1.6;
}

.comment-important-badge {
    background: #ffc107;
    color: #000;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    margin-left: 10px;
}

/* æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-attachments {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-top: 10px;
}

.attachment-item {
    margin-bottom: 10px;
}

.attachment-link {
    display: inline-block;
    padding: 5px 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    text-decoration: none;
    color: #333;
    transition: all 0.2s;
}

.attachment-link:hover {
    background: #e9ecef;
    border-color: #0d6efd;
    color: #0d6efd;
    text-decoration: none;
}

.attachment-name {
    margin: 0 5px;
}

.attachment-size {
    color: #6c757d;
    font-size: 0.85em;
}

.attachment-preview {
    max-width: 300px;
    max-height: 200px;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s;
}

.attachment-preview:hover {
    transform: scale(1.05);
}

/* ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« */
.image-modal {
    display: block;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
}

.image-modal-content {
    position: relative;
    margin: auto;
    padding: 20px;
    max-width: 90%;
    max-height: 90%;
    top: 50%;
    transform: translateY(-50%);
}

.image-modal-content img {
    max-width: 100%;
    max-height: 80vh;
    display: block;
    margin: auto;
}

.image-modal-close {
    position: absolute;
    top: 10px;
    right: 25px;
    color: #f1f1f1;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
}

.image-modal-close:hover,
.image-modal-close:focus {
    color: #bbb;
}

/* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
.file-item {
    padding: 5px;
    margin: 2px 0;
    background: #f8f9fa;
    border-radius: 3px;
}

.selected-files {
    margin-bottom: 5px;
    color: #0d6efd;
}

/* ã‚¹ãƒ¬ãƒƒãƒ‰è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-reply {
    margin-left: 40px;
    margin-top: 10px;
    border-left-width: 2px;
}

.comment-replies {
    transition: all 0.3s ease;
}

.comment-actions {
    position: absolute;
    top: 10px;
    right: 10px;
    display: flex;
    gap: 6px;
    align-items: center;
}

.reply-button,
.toggle-replies {
    font-size: 0.7rem;
    padding: 2px 4px;
    transition: color 0.2s;
}

.reply-button:hover,
.toggle-replies:hover {
    color: #0d6efd !important;
    text-decoration: none;
}

.reply-form {
    animation: slideDown 0.3s ease;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.toggle-replies i {
    transition: transform 0.3s ease;
}
</style>

<script>
// ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®JavaScript - Production Version
const projectId = {{ project.id }};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
document.addEventListener('DOMContentLoaded', function() {
    loadComments();
});

// ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
function loadComments() {
    fetch(`/orders/api/projects/${projectId}/comments/`)
        .then(response => {
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœŸå¾…ã•ã‚Œã¾ã—ãŸãŒã€åˆ¥ã®å½¢å¼ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
            }
            return response.json();
        })
        .then(data => {
            displayComments(data.comments);
        })
        .catch(error => {
            console.error('[loadComments] Error:', error);
            document.getElementById('comments-container').innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p class="small">ã‚³ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>
                </div>
            `;
        });
}

// ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤ºï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œï¼‰
function displayComments(comments) {
    const container = document.getElementById('comments-container');

    if (!container) {
        console.error('[displayComments] Container not found!');
        return;
    }

    if (!comments || comments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-comment-slash fa-3x mb-3"></i>
                <p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                <p class="small">æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
            </div>
        `;
        return;
    }

    let html = '';
    comments.forEach((comment) => {
        html += renderComment(comment, false);
    });

    container.innerHTML = html;
}

// 1ã¤ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’HTMLã«å¤‰æ›ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰å¯¾å¿œï¼‰
function renderComment(comment, isReply) {
    const importantClass = comment.is_important ? 'important' : '';
    const importantBadge = comment.is_important ?
        '<span class="comment-important-badge"><i class="fas fa-exclamation-triangle"></i> é‡è¦</span>' : '';

    // ã‚¢ãƒã‚¿ãƒ¼ã®HTMLç”Ÿæˆ
    let avatarHtml = '';
    if (comment.avatar) {
        if (comment.avatar.type === 'image') {
            avatarHtml = `<div class="user-avatar"><img src="${comment.avatar.url}" alt="${escapeHtml(comment.author)}"></div>`;
        } else {
            avatarHtml = `<div class="user-avatar initials" style="background-color: ${comment.avatar.background_color}">${comment.avatar.initials}</div>`;
        }
    } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ã‚¢ãƒã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
        const initials = comment.author.substring(0, 2).toUpperCase();
        avatarHtml = `<div class="user-avatar initials" style="background-color: #007bff">${initials}</div>`;
    }

    // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®HTMLç”Ÿæˆ
    let attachmentsHtml = '';
    if (comment.attachments && comment.attachments.length > 0) {
        attachmentsHtml = '<div class="comment-attachments mt-2">';
        comment.attachments.forEach(attachment => {
            const icon = getFileIcon(attachment);
            attachmentsHtml += `
                <div class="attachment-item">
                    <a href="${attachment.file_url}" target="_blank" class="attachment-link">
                        <i class="${icon}"></i>
                        <span class="attachment-name">${escapeHtml(attachment.file_name)}</span>
                        <span class="attachment-size">(${attachment.file_size})</span>
                    </a>
                    ${attachment.is_image ? `<div class="mt-2"><img src="${attachment.file_url}" class="attachment-preview" onclick="openImageModal('${attachment.file_url}', '${escapeHtml(attachment.file_name)}')"></div>` : ''}
                </div>
            `;
        });
        attachmentsHtml += '</div>';
    }

    // è¿”ä¿¡ã®æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã¨ã‚«ã‚¦ãƒ³ãƒˆ
    let replyToggleHtml = '';
    let repliesHtml = '';
    if (comment.replies && comment.replies.length > 0) {
        replyToggleHtml = `
            <button class="btn btn-link text-muted p-0 toggle-replies" data-comment-id="${comment.id}" title="${comment.reply_count}ä»¶ã®è¿”ä¿¡">
                <i class="fas fa-chevron-down" style="font-size: 0.8rem;"></i>
                <span style="font-size: 0.65rem;">${comment.reply_count}</span>
            </button>
        `;

        // è¿”ä¿¡ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤ºï¼‰
        repliesHtml = `<div class="comment-replies" data-parent-id="${comment.id}">`;
        comment.replies.forEach(reply => {
            repliesHtml += renderComment(reply, true);
        });
        repliesHtml += '</div>';
    }

    const replyClass = isReply ? 'comment-reply' : '';

    // ç·¨é›†æ¸ˆã¿è¡¨ç¤º
    const editedBadge = comment.is_edited ?
        `<div class="text-muted" style="font-size: 0.75rem; margin-top: 4px;">
            <i class="fas fa-edit"></i> ç·¨é›†æ¸ˆã¿ (${comment.updated_at})
        </div>` : '';

    return `
        <div class="comment-item ${importantClass} ${replyClass}" data-comment-id="${comment.id}">
            <div class="comment-header">
                ${avatarHtml}
                <div style="flex: 1;">
                    <div>
                        <span class="comment-author">
                            ${escapeHtml(comment.author)}
                        </span>
                        <span class="comment-date">
                            <i class="far fa-clock"></i> ${comment.created_at}
                        </span>
                        ${importantBadge}
                    </div>
                    ${editedBadge}
                </div>
            </div>
            <div class="comment-content">
                ${formatCommentContent(comment.content)}
            </div>
            ${attachmentsHtml}
            <div class="comment-actions">
                ${replyToggleHtml}
                <button class="btn btn-link text-muted p-0 reply-button" data-comment-id="${comment.id}" data-author="${escapeHtml(comment.author)}" title="è¿”ä¿¡">
                    <i class="fas fa-reply" style="font-size: 0.9rem;"></i>
                </button>
                ${comment.can_edit ? `
                    <button class="btn btn-link text-muted p-0 edit-comment-button" data-comment-id="${comment.id}" title="ç·¨é›†">
                        <i class="fas fa-edit" style="font-size: 0.9rem;"></i>
                    </button>
                ` : ''}
                ${comment.can_delete ? `
                    <button class="btn btn-link text-muted p-0 delete-comment-button" data-comment-id="${comment.id}" title="å‰Šé™¤">
                        <i class="fas fa-trash" style="font-size: 0.9rem;"></i>
                    </button>
                ` : ''}
            </div>
            <div class="edit-form-container" id="edit-form-${comment.id}" style="display: none;"></div>
            ${repliesHtml}
            <div class="reply-form-container" id="reply-form-${comment.id}" style="display: none;"></div>
        </div>
    `;
}

// ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ”¹è¡Œã¨ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’å‡¦ç†ï¼‰
function formatCommentContent(content) {
    const escaped = escapeHtml(content);
    // æ”¹è¡Œã‚’<br>ã«å¤‰æ›
    const withBreaks = escaped.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
    // @ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    return withBreaks.replace(/@(\w+)/g, '<strong class="text-primary">@$1</strong>');
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
function postComment() {
    const content = document.getElementById('comment-content').value.trim();
    const isImportant = document.getElementById('comment-important').checked;
    const filesInput = document.getElementById('comment-files');
    const files = filesInput ? filesInput.files : [];

    if (!content) {
        return;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) {
            return;
        }
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // FormDataã‚’ä½¿ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’é€ä¿¡
    const formData = new FormData();
    formData.append('content', content);
    formData.append('is_important', isImportant);

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
    for (let file of files) {
        formData.append('files', file);
    }

    fetch(`/orders/api/projects/${projectId}/comments/post/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('[postComment] Error response:', text);
                throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('comment-content').value = '';
            document.getElementById('comment-important').checked = false;
            if (filesInput) {
                filesInput.value = '';
            }
            const filePreview = document.getElementById('file-preview');
            if (filePreview) {
                filePreview.innerHTML = '';
            }

            // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadComments();
        } else {
            console.error('[postComment] Server returned failure:', data.error);
        }
    })
    .catch(error => {
        console.error('[postComment] Catch error:', error);
    });
}

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
function showToast(message, type = 'info') {
    // ç°¡æ˜“çš„ãªãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
function getFileIcon(attachment) {
    if (attachment.is_image) {
        return 'fas fa-file-image text-info';
    } else if (attachment.is_pdf) {
        return 'fas fa-file-pdf text-danger';
    } else if (attachment.file_type.includes('word') || attachment.file_type.includes('document')) {
        return 'fas fa-file-word text-primary';
    } else if (attachment.file_type.includes('excel') || attachment.file_type.includes('spreadsheet')) {
        return 'fas fa-file-excel text-success';
    } else {
        return 'fas fa-file text-secondary';
    }
}

// ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openImageModal(imageUrl, imageName) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `
        <div class="image-modal-content">
            <span class="image-modal-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <img src="${imageUrl}" alt="${imageName}">
            <p class="text-center mt-2">${imageName}</p>
        </div>
    `;
    document.body.appendChild(modal);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
document.getElementById('comment-files').addEventListener('change', function(e) {
    const files = e.target.files;
    const preview = document.getElementById('file-preview');
    preview.innerHTML = '';

    if (files.length === 0) return;

    preview.innerHTML = '<div class="selected-files"><strong>é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«:</strong></div>';
    for (let file of files) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        const sizeKB = (file.size / 1024).toFixed(1);
        fileItem.innerHTML = `
            <i class="fas fa-file me-2"></i>
            <span>${file.name}</span>
            <span class="text-muted ms-2">(${sizeKB} KB)</span>
        `;
        preview.appendChild(fileItem);
    }
});

// è¿”ä¿¡ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
$(document).on('click', '.reply-button', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    const authorName = $(this).data('author');
    showReplyForm(commentId, authorName);
});

// æŠ˜ã‚ŠãŸãŸã¿ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
$(document).on('click', '.toggle-replies', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    toggleReplies(commentId, this);
});

// è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¡¨ç¤º
function showReplyForm(commentId, authorName) {
    // ä»–ã®è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
    document.querySelectorAll('.reply-form-container').forEach(container => {
        container.style.display = 'none';
        container.innerHTML = '';
    });

    // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã®HTML
    const replyFormHtml = `
        <div class="reply-form p-3 bg-light rounded">
            <div class="mb-2 text-muted small">
                <i class="fas fa-reply"></i> @${authorName} ã¸ã®è¿”ä¿¡
            </div>
            <textarea
                class="form-control mb-2"
                id="reply-content-${commentId}"
                rows="2"
                placeholder="è¿”ä¿¡ã‚’å…¥åŠ›..."></textarea>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-secondary cancel-reply" data-comment-id="${commentId}">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button class="btn btn-sm btn-primary post-reply" data-comment-id="${commentId}">
                    è¿”ä¿¡ã‚’æŠ•ç¨¿
                </button>
            </div>
        </div>
    `;

    const container = document.getElementById(`reply-form-${commentId}`);
    container.innerHTML = replyFormHtml;
    container.style.display = 'block';

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    document.getElementById(`reply-content-${commentId}`).focus();
}

// è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
$(document).on('click', '.cancel-reply', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    const container = $(`#reply-form-${commentId}`);
    container.hide().html('');
});

// è¿”ä¿¡ã‚’æŠ•ç¨¿ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
$(document).on('click', '.post-reply', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    const content = $(`#reply-content-${commentId}`).val().trim();

    if (!content) return;

    postCommentReply(commentId, content);
});

// è¿”ä¿¡ã‚’æŠ•ç¨¿ã™ã‚‹é–¢æ•°
function postCommentReply(parentCommentId, content) {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    const formData = new FormData();
    formData.append('content', content);
    formData.append('is_important', false);
    formData.append('parent_comment_id', parentCommentId);

    fetch(`/orders/api/projects/${projectId}/comments/post/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                console.error('[postCommentReply] Error response:', text);
                throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            // è¿”ä¿¡ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
            const container = document.getElementById(`reply-form-${parentCommentId}`);
            container.style.display = 'none';
            container.innerHTML = '';

            // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadComments();
        } else {
            console.error('[postCommentReply] Server returned failure:', data.error);
        }
    })
    .catch(error => {
        console.error('[postCommentReply] Catch error:', error);
    });
}

// è¿”ä¿¡ã®æŠ˜ã‚ŠãŸãŸã¿ãƒˆã‚°ãƒ«
function toggleReplies(commentId, button) {
    const repliesContainer = document.querySelector(`.comment-replies[data-parent-id="${commentId}"]`);

    if (repliesContainer.style.display === 'none') {
        repliesContainer.style.display = 'block';
        button.querySelector('i').className = 'fas fa-chevron-down';
    } else {
        repliesContainer.style.display = 'none';
        button.querySelector('i').className = 'fas fa-chevron-right';
    }
}

// ã‚³ãƒ¡ãƒ³ãƒˆã‚’ç·¨é›†
$(document).on('click', '.edit-comment-button', function(e) {
    e.preventDefault();
    const commentId = $(this).data('comment-id');
    showEditForm(commentId);
});

function showEditForm(commentId) {
    const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
    const contentElement = commentItem.querySelector('.comment-content');
    const currentContent = contentElement.textContent.trim();

    // ä»–ã®ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã‚’é–‰ã˜ã‚‹
    document.querySelectorAll('.edit-form-container').forEach(container => {
        container.style.display = 'none';
        container.innerHTML = '';
    });

    // ç·¨é›†ãƒ•ã‚©ãƒ¼ãƒ ã®HTML
    const editFormHtml = `
        <div class="edit-form mt-2 p-3 bg-light rounded">
            <textarea
                class="form-control mb-2"
                id="edit-content-${commentId}"
                rows="3">${currentContent}</textarea>
            <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-sm btn-secondary cancel-edit" data-comment-id="${commentId}">
                    ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button class="btn btn-sm btn-primary save-edit" data-comment-id="${commentId}">
                    ä¿å­˜
                </button>
            </div>
        </div>
    `;

    const container = document.getElementById(`edit-form-${commentId}`);
    container.innerHTML = editFormHtml;
    container.style.display = 'block';

    // å…ƒã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
    contentElement.style.display = 'none';

    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    document.getElementById(`edit-content-${commentId}`).focus();
}

// ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
document.addEventListener('click', function(e) {
    if (e.target.closest('.cancel-edit')) {
        const button = e.target.closest('.cancel-edit');
        const commentId = button.dataset.commentId;
        const commentItem = document.querySelector(`.comment-item[data-comment-id="${commentId}"]`);
        const contentElement = commentItem.querySelector('.comment-content');
        const container = document.getElementById(`edit-form-${commentId}`);

        container.style.display = 'none';
        container.innerHTML = '';
        contentElement.style.display = 'block';
    }
});

// ç·¨é›†ã‚’ä¿å­˜
document.addEventListener('click', function(e) {
    if (e.target.closest('.save-edit')) {
        const button = e.target.closest('.save-edit');
        const commentId = button.dataset.commentId;
        const content = document.getElementById(`edit-content-${commentId}`).value.trim();

        if (!content) return;

        saveEditComment(commentId, content);
    }
});

function saveEditComment(commentId, content) {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    fetch(`/orders/api/comments/${commentId}/edit/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrftoken
        },
        body: JSON.stringify({
            content: content
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadComments();
        } else {
            console.error('[saveEditComment] Error:', data.error);
            alert('ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('[saveEditComment] Catch error:', error);
        alert('ç·¨é›†ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

// ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤
$(document).on('click', '.delete-comment-button', function(e) {
    e.preventDefault();
    e.stopPropagation();
    const commentId = $(this).data('comment-id');

    showConfirmModal(
        'ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
        function() {
            deleteComment(commentId);
        },
        'ã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤'
    );
});

function deleteComment(commentId) {
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    fetch(`/orders/api/comments/${commentId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadComments();
        } else {
            console.error('[deleteComment] Error:', data.error);
            alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (data.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
        }
    })
    .catch(error => {
        console.error('[deleteComment] Catch error:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

// Enterã‚­ãƒ¼ã§ã®è‡ªå‹•æŠ•ç¨¿ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ”¹è¡Œã‚’è¨±å¯ï¼‰
// ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã®ã¿æŠ•ç¨¿ã™ã‚‹

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ç¢ºèª - Phase 5
function confirmFileDelete(fileId, fileName) {
    showConfirmModal(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`, function() {
        const form = document.getElementById('fileDeleteForm');
        form.action = `/orders/projects/${projectId}/files/${fileId}/delete/`;
        form.submit();
    });
}

// å—æ³¨ãƒ¨ãƒŸã®å¤‰æ›´ã‚’è‡ªå‹•ä¿å­˜ï¼ˆæ¡ˆä»¶è©³ç´°ç”»é¢ï¼‰
$(document).on('change', '.order-forecast-select-detail', function(e) {
    var select = $(this);
    var projectId = select.data('project-id');
    var newValue = select.val();
    var csrfToken = $('[name=csrfmiddlewaretoken]').val() || '{{ csrf_token }}';

    // ä¿å­˜ä¸­ã®è¡¨ç¤º
    select.prop('disabled', true).css('opacity', '0.5');

    $.ajax({
        url: '/orders/' + projectId + '/update-forecast/',
        method: 'POST',
        dataType: 'json',  // JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’æœŸå¾…
        data: {
            project_status: newValue,
            csrfmiddlewaretoken: csrfToken
        },
        success: function(response) {
            console.log('ä¿å­˜æˆåŠŸ:', response);

            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®æ¤œè¨¼
            if (response && response.success) {
                // ä¿å­˜æˆåŠŸæ™‚ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                select.css('border-color', '#28a745');

                // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒã‚¸ã‚‚æ›´æ–°
                var badge = $('.project-status-badge');
                if (badge.length) {
                    // ãƒãƒƒã‚¸ã®è‰²ã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´
                    badge.removeClass('bg-primary bg-success bg-danger bg-info bg-warning bg-secondary text-dark');
                    badge.css('background-color', ''); // ã‚«ã‚¹ã‚¿ãƒ èƒŒæ™¯è‰²ã‚’ã‚¯ãƒªã‚¢

                    if (newValue === 'å—æ³¨ç¢ºå®š') {
                        badge.addClass('bg-success');
                    } else if (newValue === 'A') {
                        badge.addClass('bg-danger');
                    } else if (newValue === 'B') {
                        badge.addClass('bg-warning text-dark');
                    } else if (newValue === 'NG') {
                        badge.addClass('bg-secondary');
                    } else if (newValue === 'ãƒã‚¿') {
                        badge.addClass('text-dark');
                        badge.css('background-color', '#e9d5ff');
                    } else {
                        badge.addClass('bg-info');
                    }

                    // ãƒãƒƒã‚¸ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆget_project_status_displayç›¸å½“ï¼‰
                    var displayText = newValue;
                    if (newValue === 'å—æ³¨ç¢ºå®š') {
                        displayText = 'å—æ³¨ç¢ºå®š';
                    } else if (newValue === 'A') {
                        displayText = 'A';
                    } else if (newValue === 'B') {
                        displayText = 'B';
                    } else if (newValue === 'NG') {
                        displayText = 'NG';
                    } else if (newValue === 'ãƒã‚¿') {
                        displayText = 'ãƒã‚¿';
                    }
                    badge.text(displayText);
                }

                // 1ç§’å¾Œã«ç·‘ã®æ ç·šã‚’æ¶ˆã™
                setTimeout(function() {
                    select.css('border-color', '');
                }, 1000);
            } else {
                console.error('ä¿å­˜å¤±æ•—:', response);
                if (typeof toastr !== 'undefined') {
                    toastr.error(response.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                } else {
                    showErrorModal('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                }
                location.reload();
            }
        },
        error: function(xhr, status, error) {
            console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
                status: status,
                error: error,
                responseText: xhr.responseText,
                statusCode: xhr.status
            });

            let errorMessage = 'å—æ³¨ãƒ¨ãƒŸã®ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            if (xhr.responseJSON && xhr.responseJSON.message) {
                errorMessage = xhr.responseJSON.message;
            } else if (xhr.status === 0) {
                errorMessage = 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“';
            } else if (xhr.status === 403) {
                errorMessage = 'æ¨©é™ã‚¨ãƒ©ãƒ¼: ã“ã®æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“';
            } else if (xhr.status === 404) {
                errorMessage = 'ã‚¨ãƒ©ãƒ¼: æ¡ˆä»¶ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
            } else if (xhr.status >= 500) {
                errorMessage = 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼: ã—ã°ã‚‰ãã—ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„';
            }

            if (typeof toastr !== 'undefined') {
                toastr.error(errorMessage);
            } else {
                showErrorModal(errorMessage);
            }
            location.reload();
        },
        complete: function() {
            select.prop('disabled', false).css('opacity', '1');
        }
    });
});

// æ¡ˆä»¶è©³ç´°æƒ…å ±ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
function toggleDetailInfo() {
    const body = $('#detailInfoBody');
    const icon = $('#detailInfoToggleIcon');

    body.slideToggle(300, function() {
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã«ã‚¢ã‚¤ã‚³ãƒ³ã‚’å›è»¢
        if (body.is(':visible')) {
            icon.removeClass('fa-chevron-down').addClass('fa-chevron-up');
        } else {
            icon.removeClass('fa-chevron-up').addClass('fa-chevron-down');
        }
    });
}

// ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ç·¨é›†æ©Ÿèƒ½
function enableEdit(icon) {
    const dd = $(icon).closest('.editable-field');
    const fieldValue = dd.find('.field-value');
    const field = dd.data('field');
    const type = dd.data('type');

    // ã™ã§ã«ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
    if (dd.find('.edit-controls').length > 0) {
        return;
    }

    // ç·¨é›†ã‚¢ã‚¤ã‚³ãƒ³ã‚’éè¡¨ç¤º
    dd.find('.edit-icon').hide();

    let currentValue;
    let inputHtml = '';

    if (type === 'textarea') {
        // textareaã®å ´åˆã¯ã€HTMLã‚¿ã‚°ã‚’é™¤å»ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã ã‘ã‚’å–å¾—
        currentValue = fieldValue.text().trim();
        if (currentValue === 'å‚™è€ƒã¯ã‚ã‚Šã¾ã›ã‚“') {
            currentValue = '';
        }
        inputHtml = `<textarea class="form-control form-control-sm edit-input" rows="5" style="font-size: 0.7rem; padding: 0.4rem; width: 100%;">${currentValue}</textarea>`;
    } else if (type === 'select') {
        // selectã®å ´åˆã¯ã€ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ä½œæˆ
        const currentCompanyId = dd.data('client-company-id') || '';

        // å…ƒè«‹ä¼šç¤¾ãƒªã‚¹ãƒˆã‹ã‚‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
        let options = '<option value="">-- å…ƒè«‹ä¼šç¤¾ã‚’é¸æŠ --</option>';
        clientCompaniesData.forEach(function(company) {
            const selected = company.id == currentCompanyId ? 'selected' : '';
            options += `<option value="${company.id}" ${selected} data-address="${company.address || ''}">${company.company_name}</option>`;
        });

        inputHtml = `<select class="form-select form-select-sm edit-input" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">${options}</select>`;
    } else if (type === 'work_type') {
        // å·¥äº‹ç¨®åˆ¥ã®å ´åˆã¯ã€WorkTypeãƒã‚¹ã‚¿ãƒ¼ã‹ã‚‰ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’ä½œæˆ
        currentValue = fieldValue.text().trim();

        // å·¥äº‹ç¨®åˆ¥ãƒªã‚¹ãƒˆã‹ã‚‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
        let options = '<option value="">-- å·¥äº‹ç¨®åˆ¥ã‚’é¸æŠ --</option>';
        workTypesData.forEach(function(workType) {
            const selected = workType.name === currentValue ? 'selected' : '';
            options += `<option value="${workType.name}" ${selected}>${workType.name}</option>`;
        });

        inputHtml = `<select class="form-select form-select-sm edit-input" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">${options}</select>`;
    } else {
        currentValue = fieldValue.text().replace('Â¥', '').replace(/,/g, '').trim();

        // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆ
        if (type === 'date') {
            // æ—¥ä»˜å½¢å¼ã‚’YYYY-MM-DDã«å¤‰æ›ï¼ˆY/m/då½¢å¼ã‹ã‚‰ï¼‰
            const dateParts = currentValue.split('/');
            const dateValue = dateParts.length === 3 && currentValue !== '-' ?
                `${dateParts[0]}-${dateParts[1].padStart(2, '0')}-${dateParts[2].padStart(2, '0')}` : '';
            inputHtml = `<input type="date" class="form-control form-control-sm edit-input" value="${dateValue}" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">`;
        } else if (type === 'number') {
            // æ•°å€¤ã‹ã‚‰è¨˜å·ã‚’é™¤å»
            const numValue = currentValue === '-' ? '0' : currentValue;
            inputHtml = `<input type="number" class="form-control form-control-sm edit-input" value="${numValue}" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">`;
        } else {
            inputHtml = `<input type="text" class="form-control form-control-sm edit-input" value="${currentValue}" style="font-size: 0.7rem; padding: 0.2rem 0.4rem; width: auto; display: inline-block;">`;
        }
    }

    // å€¤ã‚’éè¡¨ç¤ºã«ã—ã¦å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ä¿å­˜/ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
    fieldValue.hide();
    const buttonDisplay = type === 'textarea' ? 'd-block mt-2' : 'd-inline-block';
    fieldValue.after(`
        <div class="edit-controls ${type === 'textarea' ? 'd-block' : 'd-inline-block'}">
            ${inputHtml}
            <div class="${buttonDisplay}">
                <button class="btn btn-sm btn-success ms-1" onclick="saveField(this)" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                    <i class="fas fa-check"></i> ä¿å­˜
                </button>
                <button class="btn btn-sm btn-secondary ms-1" onclick="cancelEdit(this)" style="font-size: 0.65rem; padding: 0.2rem 0.4rem;">
                    <i class="fas fa-times"></i> ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
            </div>
        </div>
    `);

    // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
    dd.find('.edit-input').focus();
}

function saveField(button) {
    const dd = $(button).closest('.editable-field');
    const fieldValue = dd.find('.field-value');
    const field = dd.data('field');
    const type = dd.data('type');
    const input = dd.find('.edit-input');
    const newValue = input.val();

    // ä¿å­˜å‡¦ç†
    $.ajax({
        url: '{% url "order_management:update_project_field" project.pk %}',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            field: field,
            value: newValue
        }),
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        success: function(response) {
            if (response.success) {
                // è¡¨ç¤ºã‚’æ›´æ–°
                let displayValue = newValue;
                if (type === 'select') {
                    // selectã®å ´åˆã¯ã€é¸æŠã•ã‚ŒãŸä¼šç¤¾åã¨ä½æ‰€ã‚’å–å¾—
                    const selectedOption = input.find('option:selected');
                    const companyName = selectedOption.text();
                    const companyAddress = selectedOption.data('address') || '-';

                    // å…ƒè«‹åã‚’æ›´æ–°
                    fieldValue.text(companyName);
                    dd.data('client-company-id', newValue);

                    // å…ƒè«‹ä½æ‰€ã‚‚æ›´æ–°
                    $('#client-address-display .field-value').text(companyAddress);
                } else if (type === 'work_type') {
                    // å·¥äº‹ç¨®åˆ¥ã®å ´åˆã¯ã€ãƒãƒƒã‚¸ã‚’æ›´æ–°
                    fieldValue.find('.badge').text(newValue);
                } else if (type === 'number') {
                    // æ•°å€¤ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    const num = parseFloat(newValue);
                    displayValue = 'Â¥' + num.toLocaleString('ja-JP', {maximumFractionDigits: 0});
                } else if (type === 'date') {
                    // æ—¥ä»˜ã‚’Y/m/då½¢å¼ã«å¤‰æ›
                    if (newValue) {
                        const dateParts = newValue.split('-');
                        displayValue = `${dateParts[0]}/${parseInt(dateParts[1])}/${parseInt(dateParts[2])}`;
                    } else {
                        displayValue = '-';
                    }
                }

                // ãƒãƒƒã‚¸ãŒã‚ã‚‹å ´åˆã®å‡¦ç†ï¼ˆselectã€work_typeä»¥å¤–ï¼‰
                if (type !== 'select' && type !== 'work_type') {
                    if (fieldValue.find('.badge').length > 0) {
                        fieldValue.find('.badge').text(displayValue.replace('Â¥', '').replace(/,/g, ''));
                    } else {
                        fieldValue.text(displayValue);
                    }
                }

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
                dd.find('.edit-controls').remove();
                fieldValue.show();
                dd.find('.edit-icon').show();

                // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                if (typeof toastr !== 'undefined') {
                    toastr.success('ä¿å­˜ã—ã¾ã—ãŸ');
                }
            } else {
                if (typeof toastr !== 'undefined') {
                    toastr.error(response.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                } else {
                    showErrorModal(response.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }
        },
        error: function(xhr) {
            const errorMsg = xhr.responseJSON?.error || 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ';
            if (typeof toastr !== 'undefined') {
                toastr.error(errorMsg);
            } else {
                showErrorModal(errorMsg);
            }
            console.error('Save error:', xhr);
        }
    });
}

function cancelEdit(button) {
    const dd = $(button).closest('.editable-field');
    const fieldValue = dd.find('.field-value');

    // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‚’çµ‚äº†
    dd.find('.edit-controls').remove();
    fieldValue.show();
    dd.find('.edit-icon').show();
}

// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
function switchViewMode(mode) {
    const tabViewBtn = document.getElementById('tabViewBtn');
    const fullViewBtn = document.getElementById('fullViewBtn');
    const tabNav = document.getElementById('projectDetailTabs');
    const tabContent = document.getElementById('projectDetailTabsContent');
    const tabPanes = document.querySelectorAll('#projectDetailTabsContent .tab-pane');

    if (mode === 'tab') {
        // ã‚¿ãƒ–è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        tabViewBtn.classList.add('active');
        fullViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        tabNav.style.display = 'flex';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        tabContent.classList.remove('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // æœ€åˆã®ã‚¿ãƒ–ã‚’è¡¨ç¤º
        const firstPane = document.getElementById('overview');
        if (firstPane) {
            firstPane.classList.add('show', 'active');
        }

        // æœ€åˆã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        const tabButtons = document.querySelectorAll('#projectDetailTabs .nav-link');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        const firstButton = document.getElementById('overview-tab');
        if (firstButton) {
            firstButton.classList.add('active');
        }

    } else if (mode === 'full') {
        // å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        fullViewBtn.classList.add('active');
        tabViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        tabNav.style.display = 'none';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        tabContent.classList.add('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        tabPanes.forEach(pane => {
            pane.classList.add('show', 'active');
        });
    }

    // é¸æŠçŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('projectDetailViewMode', mode);
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
document.addEventListener('DOMContentLoaded', function() {
    const savedMode = localStorage.getItem('projectDetailViewMode');
    if (savedMode === 'full') {
        switchViewMode('full');
    }
});

// è¿½åŠ å·¥ç¨‹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
function handleAdditionalStepsChange() {
    const checkedBoxes = $('.additional-step-checkbox:checked');

    if (checkedBoxes.length > 0) {
        // ç¾èª¿ï¼ˆsurveyï¼‰ãŒãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸå ´åˆã€å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ã«è¿½åŠ 
        const surveyCheckbox = $('#addStep_survey');
        if (surveyCheckbox.is(':checked')) {
            // ç¾èª¿ã‚¹ãƒ†ãƒƒãƒ—ãŒæ—¢ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            // ãƒšãƒ¼ã‚¸å†…ã«ç¾èª¿ã‚«ãƒ¼ãƒ‰ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ ãŒå¿…è¦
            const surveyStepExists = $('[data-step-key="survey"]').length > 0 ||
                                     $('.step-card:contains("ç¾èª¿")').length > 0;

            if (!surveyStepExists) {
                // ç¾èª¿ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‹•çš„ã«è¿½åŠ 
                toastr.info('ç¾èª¿ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«è¿½åŠ ã—ã¦ã„ã¾ã™...', '', {timeOut: 2000});

                // ã“ã“ã§å®Ÿéš›ã«ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã™ã‚‹å‡¦ç†
                // ç°¡æ˜“çš„ãªå®Ÿè£…ï¼šãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°ã‚’åæ˜ 
                // ã‚ˆã‚Šæ´—ç·´ã•ã‚ŒãŸå®Ÿè£…ã§ã¯ã€AJAXçµŒç”±ã§ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦DOMã‚’æ›´æ–°
                console.log('Survey step will be added when saving the subcontract');
            }
        }

        // 1ã¤ä»¥ä¸Šã®å·¥ç¨‹ãŒãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã€é‡‘é¡è¨­å®šæ–¹æ³•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        $('#costAllocationSection').show();

        // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹æ–¹æ³•ã«å¿œã˜ã¦å…¥åŠ›æ¬„ã‚’æ›´æ–°
        updatePerStepAmountsInputs();
    } else {
        // ãƒã‚§ãƒƒã‚¯ã•ã‚Œã¦ã„ãªã„å ´åˆã¯éè¡¨ç¤º
        $('#costAllocationSection').hide();
        $('#perStepAmountsSection').hide();
    }
}

// å·¥ç¨‹ã”ã¨ã®é‡‘é¡å…¥åŠ›æ¬„ã‚’ç”Ÿæˆ
function updatePerStepAmountsInputs() {
    const checkedBoxes = $('.additional-step-checkbox:checked');
    const currentStepKey = $('#subcontractStep').val();

    // ç¾åœ¨ã®å·¥ç¨‹åã‚’å–å¾—
    const stepNames = {
        'attendance': 'ç«‹ã¡ä¼šã„',
        'survey': 'ç¾èª¿',
        'construction_start': 'ç€å·¥'
    };
    const currentStepName = stepNames[currentStepKey] || '';

    let inputsHtml = '';

    // ç¾åœ¨ã®å·¥ç¨‹ã®å…¥åŠ›æ¬„
    if (currentStepName) {
        inputsHtml += `
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-calendar-check me-1"></i>${currentStepName}ï¼ˆãƒ¡ã‚¤ãƒ³å·¥ç¨‹ï¼‰
                </label>
                <input type="number" class="form-control step-amount-input-all" id="currentStepAmount"
                       placeholder="å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›" min="0" step="1000" required>
            </div>
        `;
    }

    // è¿½åŠ å·¥ç¨‹ã®å…¥åŠ›æ¬„
    checkedBoxes.each(function() {
        const stepKey = $(this).val();
        const stepLabel = $(this).data('label');

        inputsHtml += `
            <div class="mb-3">
                <label class="form-label">
                    <i class="fas fa-calendar-check me-1"></i>${stepLabel}
                </label>
                <input type="number" class="form-control step-amount-input step-amount-input-all"
                       name="step_amounts[${stepKey}]"
                       data-step="${stepKey}"
                       placeholder="å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›" min="0" step="1000" required>
            </div>
        `;
    });

    $('#perStepAmountsInputs').html(inputsHtml);

    // é‡‘é¡å…¥åŠ›æ¬„ã«å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ ï¼ˆåˆè¨ˆã‚’è‡ªå‹•è¨ˆç®—ï¼‰
    $('.step-amount-input-all').on('input', calculateTotalStepAmount);
}

// å„å·¥ç¨‹ã®é‡‘é¡åˆè¨ˆã‚’è¨ˆç®—ã—ã¦ãƒ¡ã‚¤ãƒ³å¥‘ç´„é‡‘é¡ã«åæ˜ 
function calculateTotalStepAmount() {
    let total = 0;

    // ã™ã¹ã¦ã®å·¥ç¨‹ã®é‡‘é¡ã‚’åˆè¨ˆ
    $('.step-amount-input-all').each(function() {
        const value = parseInt($(this).val()) || 0;
        total += value;
    });

    // ãƒ¡ã‚¤ãƒ³ã®å¥‘ç´„é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
    $('#subcontractContractAmount').val(total);
}

// é‡‘é¡è¨­å®šæ–¹æ³•ã®å¤‰æ›´ãƒãƒ³ãƒ‰ãƒ©
$(document).on('change', 'input[name="cost_allocation_method"]', function() {
    const method = $(this).val();

    if (method === 'per_step') {
        // å·¥ç¨‹ã”ã¨ã«é‡‘é¡ã‚’è¨­å®šã™ã‚‹å ´åˆ
        updatePerStepAmountsInputs();
        $('#perStepAmountsSection').show();

        // ãƒ¡ã‚¤ãƒ³ã®å¥‘ç´„é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’èª­ã¿å–ã‚Šå°‚ç”¨ã«ã™ã‚‹
        $('#subcontractContractAmount').prop('readonly', true);
        $('#subcontractContractAmount').addClass('bg-light');
        $('#subcontractContractAmount').attr('placeholder', 'å„å·¥ç¨‹ã®åˆè¨ˆãŒè‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™');

        // åˆè¨ˆã‚’è¨ˆç®—
        calculateTotalStepAmount();
    } else {
        // ä¸€å¼ã®å ´åˆã¯éè¡¨ç¤º
        $('#perStepAmountsSection').hide();

        // ãƒ¡ã‚¤ãƒ³ã®å¥‘ç´„é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç·¨é›†å¯èƒ½ã«æˆ»ã™
        $('#subcontractContractAmount').prop('readonly', false);
        $('#subcontractContractAmount').removeClass('bg-light');
        $('#subcontractContractAmount').attr('placeholder', '');
    }
});

// ä¸‹è«‹ã‘ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openSubcontractModal(stepKey) {
    // stepãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨­å®š
    if (stepKey) {
        $('#subcontractStep').val(stepKey);

        // ã‚¹ãƒ†ãƒƒãƒ—åã‚’ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã«è¿½åŠ 
        const stepNames = {
            'attendance': 'ç«‹ã¡ä¼šã„',
            'survey': 'ç¾èª¿',
            'construction_start': 'ç€å·¥',
            'material_order': 'è³‡æç™ºæ³¨'
        };
        const stepName = stepNames[stepKey] || '';
        $('#subcontractModalLabel').html(`<i class="fas fa-user-plus me-2"></i>ä½œæ¥­è€…ã‚’è¿½åŠ ${stepName ? ' (' + stepName + ')' : ''}`);

        // ä»–ã®å·¥ç¨‹ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ç”Ÿæˆ
        const allSteps = [
            { key: 'attendance', label: 'ç«‹ã¡ä¼šã„' },
            { key: 'survey', label: 'ç¾èª¿' },
            { key: 'construction_start', label: 'ç€å·¥' }
        ];

        const otherSteps = allSteps.filter(step => step.key !== stepKey);

        if (otherSteps.length > 0) {
            let checkboxesHtml = '<div class="row">';
            otherSteps.forEach(step => {
                checkboxesHtml += `
                    <div class="col-md-6 mb-2">
                        <div class="form-check">
                            <input class="form-check-input additional-step-checkbox" type="checkbox" name="additional_steps[]" value="${step.key}" id="addStep_${step.key}" data-label="${step.label}">
                            <label class="form-check-label" for="addStep_${step.key}">
                                <i class="fas fa-calendar-check me-1"></i>${step.label}
                            </label>
                        </div>
                    </div>
                `;
            });
            checkboxesHtml += '</div>';

            $('#additionalStepsCheckboxes').html(checkboxesHtml);
            $('#additionalStepsSection').show();

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
            $('.additional-step-checkbox').on('change', handleAdditionalStepsChange);
        } else {
            $('#additionalStepsSection').hide();
        }
    } else {
        $('#subcontractStep').val('');
        $('#subcontractModalLabel').html('<i class="fas fa-user-plus me-2"></i>ä½œæ¥­è€…ã‚’è¿½åŠ ');
        $('#additionalStepsSection').hide();
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#subcontractForm')[0].reset();
    $('#subcontractStep').val(stepKey || '');  // hidden fieldã¯ç¶­æŒ

    // ç™ºæ³¨å…ˆè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#selectedContractorDisplay').val('');

    // ç™ºæ³¨å…ˆæƒ…å ±ã¨ä¾‹å¤–å‡¦ç†ã‚’ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('contractorPaymentInfo').style.display = 'none';
    document.getElementById('customPaymentDateSection').style.display = 'none';

    // é‡‘é¡è¨­å®šæ–¹æ³•ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#costAllocationSection').hide();
    $('#perStepAmountsSection').hide();
    $('#costMethodLumpSum').prop('checked', true);

    // å¥‘ç´„é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆç·¨é›†å¯èƒ½ã«æˆ»ã™ï¼‰
    $('#subcontractContractAmount').prop('readonly', false);
    $('#subcontractContractAmount').removeClass('bg-light');
    $('#subcontractContractAmount').attr('placeholder', '');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('subcontractModal'));
    modal.show();
}

// ç™ºæ³¨å…ˆãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
const contractorsData = {{ contractors_json|safe }};

// å…ƒè«‹ä¼šç¤¾ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
const clientCompaniesData = {{ client_companies_json|safe }};

// å·¥äº‹ç¨®åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’JavaScriptã§åˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
const workTypesData = {{ work_types_json|safe }};

// ãƒ¢ãƒ¼ãƒ€ãƒ«ç·ã‚³ã‚¹ãƒˆè‡ªå‹•è¨ˆç®—
$(document).ready(function() {
    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç·ã‚³ã‚¹ãƒˆè‡ªå‹•è¨ˆç®—
    function calculateModalTotalCost() {
        var material1 = parseFloat($('#subcontractMaterialCost1').val()) || 0;
        var material2 = parseFloat($('#subcontractMaterialCost2').val()) || 0;
        var material3 = parseFloat($('#subcontractMaterialCost3').val()) || 0;
        var billed = parseFloat($('#subcontractBilledAmount').val()) || 0;
        var contract = parseFloat($('#subcontractContractAmount').val()) || 0;

        // è¢«è«‹æ±‚é¡ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°å¥‘ç´„é‡‘é¡ã‚’ä½¿ç”¨
        var baseAmount = billed > 0 ? billed : contract;

        var totalMaterial = material1 + material2 + material3;
        var totalCost = baseAmount + totalMaterial;

        // ãƒ©ãƒ™ãƒ«æ›´æ–°
        if (billed > 0) {
            $('#modalCostBaseLabel').text('è«‹æ±‚é‡‘é¡');
        } else {
            $('#modalCostBaseLabel').text('å¥‘ç´„é‡‘é¡');
        }

        // é‡‘é¡ã‚’æ›´æ–°
        $('#modalMaterialTotalAmount').text(totalMaterial.toLocaleString());
        $('#modalTotalCostAmount').text(totalCost.toLocaleString());
    }

    // é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–
    $('#subcontractMaterialCost1, #subcontractMaterialCost2, #subcontractMaterialCost3, #subcontractBilledAmount, #subcontractContractAmount').on('input', calculateModalTotalCost);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ã„ãŸã¨ãã«åˆæœŸè¨ˆç®—
    $('#subcontractModal').on('shown.bs.modal', function() {
        calculateModalTotalCost();
    });
});

// ä¾‹å¤–å‡¦ç†ï¼šå€‹åˆ¥æ”¯æ‰•æœŸé™ã‚’æœ‰åŠ¹åŒ–
function enableCustomPaymentDate() {
    document.getElementById('contractorPaymentInfo').style.display = 'none';
    document.getElementById('customPaymentDateSection').style.display = 'block';
}

// ä¾‹å¤–å‡¦ç†ï¼šé€šå¸¸ã®æ”¯æ‰•ã‚µã‚¤ã‚¯ãƒ«ã«æˆ»ã™
function disableCustomPaymentDate() {
    document.getElementById('customPaymentDateSection').style.display = 'none';
    document.getElementById('contractorPaymentInfo').style.display = 'block';

    // æ”¯æ‰•æœŸé™ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
    document.getElementById('subcontractPaymentDueDate').value = '';
}

// ä¸‹è«‹ã‘ã‚’ä¿å­˜
function saveSubcontract() {
    const form = $('#subcontractForm');
    const formData = new FormData(form[0]);

    // å·¥ç¨‹ã”ã¨ã®é‡‘é¡è¨­å®šã®å ´åˆã€ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    const costMethod = $('input[name="cost_allocation_method"]:checked').val();
    if (costMethod === 'per_step' && $('#perStepAmountsSection').is(':visible')) {
        // ç¾åœ¨ã®å·¥ç¨‹ã®é‡‘é¡ã‚’å–å¾—
        const currentStepAmount = $('#currentStepAmount').val();
        if (!currentStepAmount || currentStepAmount <= 0) {
            showErrorModal('ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }

        // å„è¿½åŠ å·¥ç¨‹ã®é‡‘é¡ã‚’åé›†ã—ã¦ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const stepAmounts = {};
        let hasError = false;
        $('.step-amount-input').each(function() {
            const stepKey = $(this).data('step');
            const amount = $(this).val();
            if (!amount || amount <= 0) {
                showErrorModal(`${$(this).prev('label').text().replace(/ï¼ˆ.*ï¼‰/, '')}ã®å¥‘ç´„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
                hasError = true;
                return false;
            }
            stepAmounts[stepKey] = amount;
        });

        if (hasError) {
            return;
        }

        // ãƒ¡ã‚¤ãƒ³å·¥ç¨‹ã®é‡‘é¡ã‚‚ stepAmounts ã«è¿½åŠ 
        stepAmounts[$('#subcontractStep').val()] = currentStepAmount;

        // JSONå½¢å¼ã§é€ä¿¡
        formData.set('step_amounts', JSON.stringify(stepAmounts));

        // åˆè¨ˆé‡‘é¡ã¯è‡ªå‹•è¨ˆç®—ã•ã‚ŒãŸã‚‚ã®ãŒã™ã§ã« contract_amount ã«è¨­å®šã•ã‚Œã¦ã„ã‚‹
        // ï¼ˆcalculateTotalStepAmountã§è¨­å®šæ¸ˆã¿ï¼‰
    }

    // é‡‘é¡è¨­å®šæ–¹æ³•ã‚’è¿½åŠ 
    if ($('#costAllocationSection').is(':visible')) {
        formData.set('cost_allocation_method', costMethod);
    }

    // éè¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®requiredå±æ€§ã‚’ä¸€æ™‚çš„ã«å‰Šé™¤ï¼ˆHTML5ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
    const hiddenRequiredFields = [];
    form.find('input[required], select[required], textarea[required]').each(function() {
        const $field = $(this);
        // éè¡¨ç¤ºã€ã¾ãŸã¯è¦ªè¦ç´ ãŒéè¡¨ç¤ºã®å ´åˆ
        if (!$field.is(':visible') || $field.closest(':hidden').length > 0) {
            hiddenRequiredFields.push($field);
            $field.removeAttr('required');
        }
    });

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!form[0].checkValidity()) {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã€requiredå±æ€§ã‚’å¾©å…ƒ
        hiddenRequiredFields.forEach(function($field) {
            $field.attr('required', 'required');
        });
        form[0].reportValidity();
        return;
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³æˆåŠŸå¾Œã€requiredå±æ€§ã‚’å¾©å…ƒ
    hiddenRequiredFields.forEach(function($field) {
        $field.attr('required', 'required');
    });

    // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';

    // AJAXé€ä¿¡
    $.ajax({
        url: '{% url "subcontract_management:subcontract_create" project.pk %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            bootstrap.Modal.getInstance(document.getElementById('subcontractModal')).hide();

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (typeof toastr !== 'undefined') {
                toastr.success('ä½œæ¥­è€…ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }

            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°ã‚’åæ˜ 
            setTimeout(function() {
                location.reload();
            }, 500);
        },
        error: function(xhr, status, error) {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            } else if (xhr.responseText) {
                errorMessage = xhr.responseText;
            }

            if (typeof toastr !== 'undefined') {
                toastr.error(errorMessage);
            } else {
                showErrorModal(errorMessage);
            }

            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    });
}

// ==================== è³‡æç™ºæ³¨ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£é–¢æ•° ====================

// è³‡æç™ºæ³¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openMaterialOrderModal() {
    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#materialOrderForm')[0].reset();

    // ç™ºæ³¨æ—¥ã‚’ä»Šæ—¥ã«è¨­å®š
    const today = new Date().toISOString().split('T')[0];
    $('#materialOrderDate').val(today);

    // è³‡æé …ç›®ã‚’åˆæœŸåŒ–ï¼ˆ1ã¤ã ã‘æ®‹ã™ï¼‰
    $('#materialItems').html(`
        <div class="material-item mb-3 p-3 bg-light rounded">
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">è³‡æå <span class="text-danger">*</span></label>
                    <input type="text" name="material_name[]" class="form-control" placeholder="ä¾‹: ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">æ•°é‡</label>
                    <input type="number" name="quantity[]" class="form-control material-quantity" step="0.01" placeholder="0.00">
                </div>
                <div class="col-md-2">
                    <label class="form-label">å˜ä½</label>
                    <input type="text" name="unit[]" class="form-control" placeholder="ä¾‹: mÂ³">
                </div>
                <div class="col-md-3">
                    <label class="form-label">å˜ä¾¡(å††)</label>
                    <input type="number" name="unit_price[]" class="form-control material-unit-price" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="form-label">ä»•æ§˜ãƒ»è¦æ ¼</label>
                    <input type="text" name="specification[]" class="form-control" placeholder="ä¾‹: 24-21-20">
                </div>
            </div>
        </div>
    `);

    // åˆè¨ˆé‡‘é¡ã‚’ãƒªã‚»ãƒƒãƒˆ
    $('#materialTotalAmount').text('Â¥0');

    // åˆè¨ˆé‡‘é¡è¨ˆç®—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’å†è¨­å®š
    attachMaterialCalculationEvents();

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('materialOrderModal'));
    modal.show();
}

// è³‡æé …ç›®ã‚’è¿½åŠ 
function addMaterialItem() {
    const newItem = `
        <div class="material-item mb-3 p-3 bg-light rounded position-relative">
            <button type="button" class="btn btn-sm btn-outline-danger position-absolute"
                    style="top: 10px; right: 10px;" onclick="removeMaterialItem(this)">
                <i class="fas fa-times"></i>
            </button>
            <div class="row">
                <div class="col-md-4">
                    <label class="form-label">è³‡æå <span class="text-danger">*</span></label>
                    <input type="text" name="material_name[]" class="form-control" placeholder="ä¾‹: ã‚³ãƒ³ã‚¯ãƒªãƒ¼ãƒˆ" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label">æ•°é‡</label>
                    <input type="number" name="quantity[]" class="form-control material-quantity" step="0.01" placeholder="0.00">
                </div>
                <div class="col-md-2">
                    <label class="form-label">å˜ä½</label>
                    <input type="text" name="unit[]" class="form-control" placeholder="ä¾‹: mÂ³">
                </div>
                <div class="col-md-3">
                    <label class="form-label">å˜ä¾¡(å††)</label>
                    <input type="number" name="unit_price[]" class="form-control material-unit-price" step="0.01" placeholder="0.00">
                </div>
            </div>
            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="form-label">ä»•æ§˜ãƒ»è¦æ ¼</label>
                    <input type="text" name="specification[]" class="form-control" placeholder="ä¾‹: 24-21-20">
                </div>
            </div>
        </div>
    `;

    $('#materialItems').append(newItem);

    // æ–°ã—ãè¿½åŠ ã•ã‚ŒãŸé …ç›®ã«ã‚‚ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
    attachMaterialCalculationEvents();
}

// è³‡æé …ç›®ã‚’å‰Šé™¤
function removeMaterialItem(button) {
    $(button).closest('.material-item').remove();
    calculateMaterialTotal();
}

// åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
function calculateMaterialTotal() {
    let total = 0;

    $('.material-item').each(function() {
        const quantity = parseFloat($(this).find('.material-quantity').val()) || 0;
        const unitPrice = parseFloat($(this).find('.material-unit-price').val()) || 0;
        total += quantity * unitPrice;
    });

    $('#materialTotalAmount').text('Â¥' + total.toLocaleString());
    return total;
}

// åˆè¨ˆé‡‘é¡è¨ˆç®—ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
function attachMaterialCalculationEvents() {
    $('.material-quantity, .material-unit-price').off('input').on('input', function() {
        calculateMaterialTotal();
    });
}

// è³‡æç™ºæ³¨ã‚’ä¿å­˜
function saveMaterialOrder() {
    const form = $('#materialOrderForm');

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!form[0].checkValidity()) {
        form[0].reportValidity();
        return;
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
    const formData = new FormData(form[0]);

    // åˆè¨ˆé‡‘é¡ã‚’è¿½åŠ 
    const totalAmount = calculateMaterialTotal();
    formData.append('total_amount', totalAmount);

    // ä¿å­˜ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
    const saveBtn = event.target;
    const originalText = saveBtn.innerHTML;
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>ä¿å­˜ä¸­...';

    // AJAXé€ä¿¡
    $.ajax({
        url: '{% url "order_management:material_order_create" project.pk %}',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'X-Requested-With': 'XMLHttpRequest'
        },
        success: function(response) {
            // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            bootstrap.Modal.getInstance(document.getElementById('materialOrderModal')).hide();

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            if (typeof toastr !== 'undefined') {
                toastr.success('è³‡æç™ºæ³¨ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            }

            // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ›´æ–°ã‚’åæ˜ 
            setTimeout(function() {
                location.reload();
            }, 500);
        },
        error: function(xhr, status, error) {
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            let errorMessage = 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            } else if (xhr.responseText) {
                errorMessage = xhr.responseText;
            }

            if (typeof toastr !== 'undefined') {
                toastr.error(errorMessage);
            } else {
                showErrorModal(errorMessage);
            }

            // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
            saveBtn.disabled = false;
            saveBtn.innerHTML = originalText;
        }
    });
}

// ============================================
// ä¸‹è«‹ã‘ç®¡ç†ãƒ‘ãƒãƒ«
// ============================================

// ä¸‹è«‹ã‘ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã
window.openContractorManagementPanel = function() {
    console.log('âœ… openContractorManagementPanel called');

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    const modal = new bootstrap.Modal(document.getElementById('contractorManagementModal'));
    modal.show();

    // ä¸‹è«‹ã‘æ¥­è€…ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    refreshContractorList();

    // æ¤œç´¢æ©Ÿèƒ½ã‚’åˆæœŸåŒ–
    setTimeout(function() {
        const searchInput = $('#contractorSearchInput');
        if (searchInput.length) {
            searchInput.off('input').on('input', function() {
                const searchTerm = $(this).val().toLowerCase();
                filterContractorList(searchTerm);
            });
        }
    }, 100);
};

// ä¸‹è«‹ã‘æ¥­è€…ä¸€è¦§ã‚’æ›´æ–°
window.refreshContractorList = function() {
    console.log('âœ… refreshContractorList called');

    const tbody = $('#contractorTableBody');
    tbody.html('<tr><td colspan="12" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td></tr>');

    // ã™ã¹ã¦ã®ä¸‹è«‹ã‘æ¥­è€…ã‚’å–å¾—ï¼ˆDjangoãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ï¼‰
    const allContractors = contractorsData;

    console.log('ğŸ“‹ ä¸‹è«‹ã‘æ¥­è€…ãƒ‡ãƒ¼ã‚¿:', allContractors);
    if (allContractors && allContractors.length > 0) {
        console.log('ğŸ“‹ æœ€åˆã®ä¸‹è«‹ã‘æ¥­è€…ã®ãƒ‡ãƒ¼ã‚¿è©³ç´°:', allContractors[0]);
    }

    if (!allContractors || allContractors.length === 0) {
        tbody.html('<tr><td colspan="12" class="text-center text-muted">ä¸‹è«‹ã‘æ¥­è€…ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</td></tr>');
        return;
    }

    let html = '';
    allContractors.forEach(function(contractor) {
        const statusBadge = contractor.is_active ?
            '<span class="badge bg-success">æœ‰åŠ¹</span>' :
            '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

        const contractorTypeText = contractor.contractor_type_display || '-';
        const paymentCycleText = contractor.payment_cycle_display || '-';

        // ç· ã‚æ—¥: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯
        const closingDayText = (contractor.closing_day !== null && contractor.closing_day !== undefined)
            ? `${contractor.closing_day}æ—¥` : '-';

        // æ”¯æ‰•æœˆ: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯
        const paymentOffsetMonthsText = contractor.payment_offset_months_display || '-';

        // æ”¯æ‰•ã„æ—¥: null/undefinedã‚’ãƒã‚§ãƒƒã‚¯
        const paymentDayText = (contractor.payment_day !== null && contractor.payment_day !== undefined)
            ? `${contractor.payment_day}æ—¥` : '-';

        // å„æ¥­è€…ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        console.log(`  - ${contractor.name}: ç¨®åˆ¥=${contractor.contractor_type_display}, ç· ã‚æ—¥=${contractor.closing_day}, æ”¯æ‰•æœˆ=${contractor.payment_offset_months_display}, æ”¯æ‰•ã„æ—¥=${contractor.payment_day}`);

        html += `
            <tr style="cursor: pointer;" onclick="selectContractor(${contractor.id})" onmouseover="this.style.backgroundColor='#f8f9fa'" onmouseout="this.style.backgroundColor=''">
                <td><strong>${escapeHtml(contractor.name)}</strong></td>
                <td>${contractorTypeText}</td>
                <td>${escapeHtml(contractor.address || '-')}</td>
                <td>${escapeHtml(contractor.phone || '-')}</td>
                <td>${escapeHtml(contractor.contact_person || '-')}</td>
                <td>${escapeHtml(contractor.specialties || '-')}</td>
                <td class="text-center">${paymentCycleText}</td>
                <td class="text-center">${closingDayText}</td>
                <td class="text-center">${paymentOffsetMonthsText}</td>
                <td class="text-center">${paymentDayText}</td>
                <td class="text-center">${statusBadge}</td>
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-sm btn-outline-primary" onclick="editContractor(${contractor.id})" title="ç·¨é›†">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    tbody.html(html);
};

// ä¸‹è«‹ã‘æ¥­è€…ã‚’é¸æŠã—ã¦ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã«é©ç”¨
window.selectContractor = function(contractorId) {
    console.log('âœ… selectContractor called', contractorId);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    const modal = bootstrap.Modal.getInstance(document.getElementById('contractorManagementModal'));
    if (modal) modal.hide();

    // éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ¥­è€…IDã‚’è¨­å®š
    $('#subcontractContractor').val(contractorId);

    // é¸æŠã•ã‚ŒãŸæ¥­è€…ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const selectedContractor = contractorsData.find(c => c.id === contractorId);

    if (selectedContractor) {
        console.log('âœ… é¸æŠã•ã‚ŒãŸä¸‹è«‹ã‘æ¥­è€…:', selectedContractor);

        // è¡¨ç¤ºãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æ¥­è€…åã‚’è¨­å®š
        $('#selectedContractorDisplay').val(selectedContractor.name);

        // æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«æƒ…å ±ã‚’è‡ªå‹•å…¥åŠ›ï¼ˆæ—¢å­˜ã®å‡¦ç†ã‚’å†åˆ©ç”¨ï¼‰
        $('#contractorPaymentCycleDisplay').text(selectedContractor.payment_cycle_display || '-');
        $('#contractorClosingDayDisplay').text(selectedContractor.closing_day ? selectedContractor.closing_day + 'æ—¥' : '-');
        $('#contractorPaymentDayDisplay').text(selectedContractor.payment_day ? selectedContractor.payment_day + 'æ—¥' : '-');

        // æ”¯æ‰•ã„æƒ…å ±ã‚’è¡¨ç¤º
        if (selectedContractor.payment_cycle || selectedContractor.closing_day || selectedContractor.payment_day) {
            $('#contractorPaymentInfo').show();
        } else {
            $('#contractorPaymentInfo').hide();
        }

        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (typeof toastr !== 'undefined') {
            toastr.success(`ã€Œ${selectedContractor.name}ã€ã‚’é¸æŠã—ã¾ã—ãŸ`);
        }
    }
};

// ä¸‹è«‹ã‘æ¥­è€…ç·¨é›†ï¼ˆåˆ¥ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼‰
window.editContractor = function(contractorId) {
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸URLã‚’backãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
    const currentUrl = encodeURIComponent(window.location.pathname);
    window.location.href = `/orders/contractors/${contractorId}/edit/?back=${currentUrl}`;
};

// ä¸‹è«‹ã‘æ¥­è€…ä¸€è¦§ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
window.filterContractorList = function(searchTerm) {
    console.log('ğŸ” Filtering contractors:', searchTerm);

    const rows = $('#contractorTableBody tr');

    if (!searchTerm || searchTerm.trim() === '') {
        rows.show();
        return;
    }

    rows.each(function() {
        const row = $(this);
        const contractorName = row.find('td:first strong').text().toLowerCase();
        const contractorType = row.find('td:nth-child(2)').text().toLowerCase();
        const address = row.find('td:nth-child(3)').text().toLowerCase();
        const phone = row.find('td:nth-child(4)').text().toLowerCase();
        const specialties = row.find('td:nth-child(6)').text().toLowerCase();

        if (contractorName.includes(searchTerm) ||
            contractorType.includes(searchTerm) ||
            address.includes(searchTerm) ||
            phone.includes(searchTerm) ||
            specialties.includes(searchTerm)) {
            row.show();
        } else {
            row.hide();
        }
    });

    // æ¤œç´¢çµæœãŒ0ä»¶ã®å ´åˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    const visibleRows = rows.filter(':visible').length;
    if (visibleRows === 0) {
        const tbody = $('#contractorTableBody');
        if (tbody.find('.no-results-row').length === 0) {
            tbody.append('<tr class="no-results-row"><td colspan="12" class="text-center text-muted py-4"><i class="fas fa-search me-2"></i>ã€Œ' + escapeHtml(searchTerm) + 'ã€ã«ä¸€è‡´ã™ã‚‹ä¸‹è«‹ã‘æ¥­è€…ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</td></tr>');
        }
    } else {
        $('#contractorTableBody .no-results-row').remove();
    }
};

// æ–°è¦ä¸‹è«‹ã‘æ¥­è€…è¿½åŠ ï¼ˆåˆ¥ãƒšãƒ¼ã‚¸ã¸é·ç§»ï¼‰
window.addNewContractor = function() {
    // ç¾åœ¨ã®ãƒšãƒ¼ã‚¸URLã‚’backãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¨ã—ã¦æ¸¡ã™
    const currentUrl = encodeURIComponent(window.location.pathname);
    window.location.href = `/orders/contractors/new/?back=${currentUrl}`;
};

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°ï¼ˆæ—¢ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼‰
if (typeof escapeHtml === 'undefined') {
    window.escapeHtml = function(text) {
        if (!text) return '';
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
    };
}

// #comment-content ã¯ Enterã‚­ãƒ¼ã§æ”¹è¡Œã•ã‚Œã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã®ã¿æŠ•ç¨¿ã•ã‚Œã‚‹ï¼ˆè¨­å®šä¸è¦ï¼‰
</script>

<!-- ä¸‹è«‹ã‘ç®¡ç†ãƒ‘ãƒãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="contractorManagementModal" tabindex="-1" aria-labelledby="contractorManagementModalLabel" aria-hidden="true" style="z-index: 9999 !important;">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="contractorManagementModalLabel">
                    <i class="fas fa-handshake"></i> ä¸‹è«‹ã‘ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">ç™»éŒ²ä¸‹è«‹ã‘æ¥­è€…ä¸€è¦§</h6>
                    <div class="d-flex gap-2">
                        <input type="text" id="contractorSearchInput" class="form-control form-control-sm" placeholder="æ¥­è€…åã§æ¤œç´¢..." style="width: 250px;">
                        <button type="button" class="btn btn-primary btn-sm" onclick="addNewContractor()">
                            <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                        </button>
                    </div>
                </div>

                <!-- ä¸‹è«‹ã‘æ¥­è€…ãƒ†ãƒ¼ãƒ–ãƒ« -->
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-light">
                            <tr>
                                <th>æ¥­è€…å</th>
                                <th>æ¥­è€…ç¨®åˆ¥</th>
                                <th>ä½æ‰€</th>
                                <th>é›»è©±ç•ªå·</th>
                                <th>æ‹…å½“è€…</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th class="text-center">æ”¯æ‰•ã„ã‚µã‚¤ã‚¯ãƒ«</th>
                                <th class="text-center">ç· ã‚æ—¥</th>
                                <th class="text-center">æ”¯æ‰•æœˆ</th>
                                <th class="text-center">æ”¯æ‰•ã„æ—¥</th>
                                <th class="text-center">çŠ¶æ…‹</th>
                                <th style="width: 140px;">ã‚¢ã‚¯ã‚·ãƒ§ãƒ³</th>
                            </tr>
                        </thead>
                        <tbody id="contractorTableBody">
                            <tr>
                                <td colspan="12" class="text-center text-muted">èª­ã¿è¾¼ã¿ä¸­...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}