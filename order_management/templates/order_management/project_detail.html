{% extends "order_management/base.html" %}
{% load humanize %}
{% load role_tags %}

{% block title %}{{ project.site_name }} - 建築派遣管理システム{% endblock %}

{% block extra_css %}
<style>
/* 料金体系選択カードのスタイル */
.pricing-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.pricing-type-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
}

.pricing-type-card.border-primary {
    border-color: #0d6efd !important;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.25);
}

.pricing-type-card.bg-light {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.pricing-type-card .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>
<!-- Sortable.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
    .progress-status-card {
        border: 2px solid;
        border-radius: 10px;
        transition: all 0.3s;
    }
    .progress-status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .action-button {
        min-width: 120px;
        margin: 0.25rem;
    }
    .status-selector {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1rem;
    }
    .progress-timeline {
        position: relative;
        padding-left: 2rem;
    }
    .progress-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 1rem;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -26px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d; /* グレー：何も入力なし */
    }
    .timeline-item.scheduled::before {
        background: #ffc107; /* 黄色：予定日のみ入力 */
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }
    .timeline-item.completed::before {
        background: #28a745; /* 緑：完了日が入力されている */
    }
    .timeline-item.verified::before {
        background: #155724; /* 濃い緑：完了チェックボックスにチェック */
        box-shadow: 0 0 0 4px rgba(21, 87, 36, 0.3);
    }
    .timeline-item.current::before {
        background: #ffc107; /* 黄色：現在のステップ（予定日のみと同じ） */
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }

    /* 縦型プログレスバー */
    .vertical-progress {
        position: relative;
        padding-left: 40px;
        min-height: 400px;
    }

    .vertical-progress::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }

    .progress-step {
        position: relative;
        margin-bottom: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .progress-step::before {
        content: '';
        position: absolute;
        left: -28px;
        top: 8px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #6c757d;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #6c757d;
        transition: all 0.3s ease;
    }

    .progress-step.completed::before {
        background: #28a745;
        box-shadow: 0 0 0 2px #28a745;
    }

    .progress-step.active::before {
        background: #007bff;
        box-shadow: 0 0 0 2px #007bff, 0 0 0 6px rgba(0, 123, 255, 0.2);
        transform: scale(1.2);
    }

    .progress-step:hover {
        transform: translateX(5px);
    }

    .progress-step-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        transition: color 0.3s ease;
    }

    .progress-step.completed .progress-step-header {
        color: #28a745;
    }

    .progress-step.active .progress-step-header {
        color: #007bff;
    }

    .progress-step-content {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
        display: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .progress-step.expanded .progress-step-content {
        display: block;
        border-color: #007bff;
        background: #fff;
    }

    .progress-step {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        border-radius: 8px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .progress-step:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        border-color: #dee2e6;
    }

    .progress-step.expanded {
        background-color: #fff;
        border-color: #007bff;
        box-shadow: 0 4px 8px rgba(0,123,255,0.1);
    }

    .progress-step-date {
        font-size: 0.875rem;
        color: #6c757d;
    }

    /* インベントリカード */
    .border-dashed {
        border: 2px dashed #dee2e6 !important;
        transition: all 0.3s ease;
    }
    .border-dashed:hover {
        border-color: #007bff !important;
        background-color: #f8f9fa;
    }

    /* ドラッグアンドドロップ */
    .progress-step.sortable-ghost {
        opacity: 0.5;
        background: #e9ecef;
    }
    .progress-step.sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .progress-step.sortable-chosen {
        cursor: grab;
    }
    .progress-step {
        transition: all 0.3s ease;
    }
    .progress-step:hover {
        transform: translateX(5px);
    }
    .drag-handle {
        cursor: grab;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .progress-step:hover .drag-handle {
        opacity: 1;
    }
    .drag-handle:active {
        cursor: grabbing;
    }

    .progress-step.completed .progress-step-date {
        color: #28a745;
        font-weight: 500;
    }

    /* 詳細進捗管理タイムライン - Phase 11 */
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 28px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #e9ecef 0%, #dee2e6 100%);
    }

    .timeline-item {
        position: relative;
        padding-left: 70px;
        padding-bottom: 30px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-marker {
        position: absolute;
        left: 0;
        top: 0;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        z-index: 1;
    }

    .timeline-marker.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .timeline-marker.bg-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
    }

    .timeline-content {
        background: #ffffff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .timeline-content:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        transform: translateX(5px);
    }

    .timeline-content h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .badge.bg-light.text-dark {
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<!-- ヘッダー & アクションボタン -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex align-items-center">
            <h2><i class="fas fa-building"></i> {{ project.site_name }}</h2>
            <span class="badge {% if project.project_status == '受注確定' %}bg-primary{% elif project.project_status == 'A' %}bg-success{% elif project.project_status == 'B' %}bg-info{% elif project.project_status == 'NG' %}bg-secondary{% else %}bg-warning text-dark{% endif %} fs-6 ms-3"
                  title="受注ヨミ（営業見込み度）">
                受注ヨミ: {{ project.get_project_status_display }}
            </span>
        </div>
        <p class="text-muted mb-0">{{ project.management_no }} | {{ project.work_type }}</p>
    </div>
    <div class="col-md-4">
        <div class="text-end">
            <a href="{% url 'subcontract_management:project_subcontract_list' project.pk %}" class="btn btn-success action-button">
                <i class="fas fa-file-contract"></i> 発注管理
            </a>
            <button type="button" class="btn btn-danger action-button" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="fas fa-trash"></i> 削除
            </button>
            <a href="{% url 'order_management:project_list' %}" class="btn btn-secondary action-button">
                <i class="fas fa-list"></i> 一覧へ
            </a>
        </div>
    </div>
</div>

<!-- 進捗状況カード -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card progress-status-card border-primary" id="progressStatusCard">
            <div class="card-header bg-primary text-white" id="progressStatusHeader">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> 進捗状況</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        {% with stage=project.get_current_project_stage %}
                        <h3 class="text-{{ stage.color }}" id="progressPhase">{{ stage.stage }}</h3>
                        {% endwith %}
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-primary" id="progressBar"
                                 role="progressbar"
                                 style="width: {{ project.get_progress_status.percentage }}%"
                                 aria-valuenow="{{ project.get_progress_status.percentage }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <span id="progressPercentage">{{ project.get_progress_status.percentage }}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="progress-timeline" id="progressTimeline">
                            <!-- 動的に構築されるタイムライン -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card status-selector">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-cog"></i> 進捗状況を更新</h6>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'order_management:update_progress' project.pk %}">
                    {% csrf_token %}

                    <!-- プロジェクト段階管理 -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label">プロジェクト段階</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="editStepsBtn"
                                    style="position: relative; z-index: 1000; pointer-events: auto;">
                                <i class="fas fa-edit"></i> ステップ編集
                            </button>
                        </div>
                        <div class="vertical-progress" id="activeSteps">
                            <!-- 動的にステップが構築される -->
                        </div>
                    </div>

                    <!-- インベントリセクション（進捗更新ボタンの下） -->
                    <div id="stepInventory" class="mt-4">
                        <hr>
                        <h6><i class="fas fa-box"></i> 利用可能なステップ</h6>
                        <div class="row" id="availableSteps">
                            <!-- 利用可能なステップをここに動的に表示 -->
                        </div>
                    </div>

                    <!-- ステップ順序の隠しフィールド -->
                    <input type="hidden" name="step_order" id="stepOrderInput" value="">

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save"></i> 進捗更新
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 現地調査 -->
<div class="row mb-4" id="surveyContentArea">
    <div class="col-lg-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>現地調査
                        {% if surveys %}
                            <span class="badge bg-white text-primary ms-2">{{ surveys|length }}件</span>
                        {% endif %}
                    </h5>
                    <div class="btn-group">
{#                         <a href="#" class="btn btn-sm btn-light">
                            <i class="fas fa-list"></i> 調査一覧
                        </a>
{#                         <a href="#" class="btn btn-sm btn-light">
                            <i class="fas fa-plus"></i> 調査追加
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if surveys %}
                    <!-- 最新の調査情報 -->
                    {% with latest_survey=surveys.first %}
                    {% if latest_survey %}
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="alert {% if latest_survey.status == 'completed' %}alert-success{% elif latest_survey.status == 'in_progress' %}alert-warning{% else %}alert-info{% endif %} mb-0">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-1">
                                            {% if latest_survey.status == 'completed' %}
                                                <i class="fas fa-check-circle me-1"></i>最新調査完了
                                            {% elif latest_survey.status == 'in_progress' %}
                                                <i class="fas fa-spinner fa-spin me-1"></i>調査実施中
                                            {% else %}
                                                <i class="fas fa-calendar-alt me-1"></i>次回調査予定
                                            {% endif %}
                                        </h6>
                                        <div class="small">
                                            <strong>日時:</strong> {{ latest_survey.scheduled_date|date:"Y年m月d日" }} {{ latest_survey.scheduled_start_time|time:"H:i" }}<br>
                                            <strong>担当:</strong> {{ latest_survey.surveyor.name }} ({{ latest_survey.surveyor.employee_id }})
                                            {% if latest_survey.status == 'completed' and latest_survey.rooms.count > 0 %}
                                            <br><strong>調査結果:</strong> {{ latest_survey.rooms.count }}部屋 / {{ latest_survey.damages.count }}件の損傷記録 / {{ latest_survey.photos.count }}枚の写真
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% if latest_survey.status == 'completed' %}
{#                                             <a href="#" class="btn btn-sm btn-success">
                                                <i class="fas fa-file-pdf"></i> レポート
                                            </a>
                                        {% elif latest_survey.status == 'in_progress' %}
{#                                             <a href="#" class="btn btn-sm btn-warning">
                                                <i class="fas fa-play"></i> 続ける
                                            </a>
                                        {% else %}
{#                                             <a href="#" class="btn btn-sm btn-primary">
                                                <i class="fas fa-play"></i> 開始
                                            </a>
                                        {% endif %}
{#                                         <a href="#" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-eye"></i> 詳細
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}

                    <!-- 調査履歴 -->
                    {% if surveys|length > 1 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th width="20%">実施日</th>
                                    <th width="20%">担当者</th>
                                    <th width="15%">ステータス</th>
                                    <th width="25%">調査内容</th>
                                    <th width="20%" class="text-end">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for survey in surveys %}
                                <tr>
                                    <td>{{ survey.scheduled_date|date:"m/d" }} {{ survey.scheduled_start_time|time:"H:i" }}</td>
                                    <td>{{ survey.surveyor.name }} ({{ survey.surveyor.employee_id }})</td>
                                    <td>
                                        <span class="badge {% if survey.status == 'completed' %}bg-success{% elif survey.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ survey.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if survey.status == 'completed' %}
                                            <small>{{ survey.rooms.count }}部屋 / {{ survey.damages.count }}損傷 / {{ survey.photos.count }}写真</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
{#                                         <a href="#" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if survey.status == 'completed' %}
{#                                             <a href="#" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-file-pdf"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                {% else %}
                    <!-- 調査未実施の場合 -->
                    <div class="alert alert-warning">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <div class="col-md-8">
                                <h6 class="mb-1">現地調査が未実施です</h6>
                                <small>この案件の現地調査をスケジュールしてください。正確な見積もりと施工計画のために必要です。</small>
                            </div>
                            <div class="col-md-3 text-end">
{#                                 <a href="#" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>調査をスケジュール
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- 手配状況 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-{% if subcontracts %}success{% else %}warning{% endif %}">
            <div class="card-header bg-{% if subcontracts %}success{% else %}warning{% endif %} text-white">
                <h5 class="mb-0"><i class="fas fa-file-contract"></i> 手配状況
                    <span class="badge bg-light text-dark ms-2">{{ subcontracts|length }}件登録</span>
                </h5>
            </div>
            <div class="card-body">
                {% if subcontracts %}
                <!-- 登録済み発注先リスト -->
                <h6><i class="fas fa-file-contract"></i> 登録済み発注先</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>発注先</th>
                                <th>作業内容</th>
                                <th class="text-end">契約額</th>
                                <th class="text-end">被請求額</th>
                                <th class="text-center">支払状況</th>
                                <th class="text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subcontract in subcontracts %}
                            <tr>
                                <td><strong>{{ subcontract.contractor.name }}</strong></td>
                                <td>{{ subcontract.work_description|default:"-"|truncatechars:20 }}</td>
                                <td class="text-end">¥{{ subcontract.contract_amount|floatformat:0|intcomma }}</td>
                                <td class="text-end">¥{{ subcontract.billed_amount|floatformat:0|intcomma }}</td>
                                <td class="text-center">
                                    <span class="badge bg-{{ subcontract.get_payment_status_color }}">
                                        {{ subcontract.get_payment_status_display }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'subcontract_management:subcontract_update' subcontract.pk %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">発注先未登録</h5>
                    <p class="text-muted">この案件にはまだ発注先が登録されていません。<br>右側のフォームから発注先を追加してください。</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-plus-circle"></i> 作業者追加</h6>
            </div>
            <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                <form method="post" action="{% url 'order_management:add_subcontract' project.pk %}">
                    {% csrf_token %}

                    <!-- 作業者タイプ選択 -->
                    <div class="mb-3">
                        <label class="form-label">作業者タイプ <span class="text-danger">*</span></label>
                        <div class="mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="worker_type" id="externalWorker" value="external" checked>
                                <label class="form-check-label" for="externalWorker">
                                    <i class="fas fa-file-contract me-1"></i>発注
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="worker_type" id="internalWorker" value="internal">
                                <label class="form-check-label" for="internalWorker">
                                    <i class="fas fa-users me-1"></i>社内リソース
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- 外注先情報（外注の場合のみ表示） -->
                    <div id="externalWorkerSection">
                        <!-- 工事業者情報 -->
                    <div class="mb-3">
                        <label class="form-label">工事元請名 <span class="text-danger">*</span></label>
                        <div class="mb-2">
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="contractor_input_type" id="existingContractor" value="existing" checked>
                                <label class="form-check-label" for="existingContractor">
                                    既存から選択
                                </label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="radio" name="contractor_input_type" id="newContractor" value="new">
                                <label class="form-check-label" for="newContractor">
                                    新規入力
                                </label>
                            </div>
                        </div>

                        <!-- 既存業者選択 -->
                        <div id="existingContractorDiv">
                            <select name="existing_contractor_id" class="form-select" id="contractorSelect">
                                <option value="">-- 業者を選択してください --</option>
                                {% for contractor in contractors %}
                                <option value="{{ contractor.id }}" data-name="{{ contractor.name }}" data-address="{{ contractor.address }}">
                                    {{ contractor.name }} {% if contractor.address %}({{ contractor.address }}){% endif %}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- 新規業者入力 -->
                        <div id="newContractorDiv" style="display: none;">
                            <input type="text" name="client_name" class="form-control" placeholder="例: 田中工務店">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">工事元請住所</label>
                        <input type="text" name="client_address" class="form-control" id="contractorAddress" placeholder="例: 東京都渋谷区1-2-3">
                    </div>

                    <!-- 金額情報 -->
                    <div class="mb-3">
                        <label class="form-label">依頼金額 <span class="text-danger">*</span></label>
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" name="contract_amount" class="form-control" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">被請求額</label>
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" name="billed_amount" class="form-control">
                        </div>
                    </div>

                    <!-- 出金情報 -->
                    <div class="mb-3">
                        <label class="form-label">出金予定日</label>
                        <input type="date" name="payment_due_date" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">出金日</label>
                        <input type="date" name="payment_date" class="form-control">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">出金状況</label>
                        <select name="payment_status" class="form-select">
                            <option value="pending">未払い</option>
                            <option value="paid">支払済み</option>
                            <option value="partial">一部払い</option>
                        </select>
                    </div>

                    <!-- 部材費情報 -->
                    <hr>
                    <h6><i class="fas fa-box"></i> 部材費情報</h6>
                    <div id="externalMaterialCostSection">
                        <!-- 動的に部材費項目が追加される -->
                    </div>
                    <button type="button" class="btn btn-outline-success btn-sm" id="addExternalMaterialBtn">
                        <i class="fas fa-plus"></i> 部材費項目を追加
                    </button>
                    <div class="mt-2">
                        <strong>部材費合計: ¥<span id="externalMaterialTotal">0</span></strong>
                    </div>

                    <!-- 追加費用情報 -->
                    <hr>
                    <h6><i class="fas fa-plus-circle"></i> 追加費用情報</h6>
                    <div id="externalAdditionalCostSection">
                        <!-- 動的に追加費用項目が追加される -->
                    </div>
                    <button type="button" class="btn btn-outline-warning btn-sm" id="addExternalAdditionalCostBtn">
                        <i class="fas fa-plus"></i> 追加費用項目を追加
                    </button>
                    <div class="mt-2">
                        <strong>追加費用合計: ¥<span id="externalAdditionalCostTotal">0</span></strong>
                    </div>

                    <!-- 外注先費用内訳 -->
                    <div class="mt-3 p-3 bg-light rounded" id="externalCostBreakdown">
                        <h6 class="mb-2"><i class="fas fa-calculator"></i> 費用内訳（外注）</h6>
                        <div class="row mb-1">
                            <div class="col-8">依頼金額:</div>
                            <div class="col-4 text-end">¥<span id="externalContractAmount">0</span></div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-8">被請求額:</div>
                            <div class="col-4 text-end">¥<span id="externalBilledAmount">0</span></div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-8">部材費:</div>
                            <div class="col-4 text-end">¥<span id="externalMaterialSubtotal">0</span></div>
                        </div>
                        <div class="row mb-1">
                            <div class="col-8">追加費用:</div>
                            <div class="col-4 text-end">¥<span id="externalAdditionalCostSubtotal">0</span></div>
                        </div>
                        <hr class="my-2">
                        <div class="row fw-bold text-primary">
                            <div class="col-8 fs-5">総合計:</div>
                            <div class="col-4 text-end fs-5">¥<span id="externalGrandTotal">0</span></div>
                        </div>
                    </div>

                    <!-- 発注書 -->
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="purchase_order_issued" id="purchaseOrder">
                            <label class="form-check-label" for="purchaseOrder">
                                発注書発行済み
                            </label>
                        </div>
                    </div>

                    </div>

                    <!-- 社内リソース情報（社内の場合のみ表示） -->
                    <div id="internalWorkerSection" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">担当者選択方法 <span class="text-danger">*</span></label>
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="internal_input_type" id="existingInternal" value="existing" checked>
                                    <label class="form-check-label" for="existingInternal">
                                        既存から選択
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="internal_input_type" id="newInternal" value="new">
                                    <label class="form-check-label" for="newInternal">
                                        新規入力
                                    </label>
                                </div>
                            </div>

                            <!-- 既存担当者選択 -->
                            <div id="existingInternalDiv">
                                <select name="existing_internal_id" class="form-select" id="internalSelect">
                                    <option value="">-- 担当者を選択してください --</option>
                                    {% for worker in internal_workers %}
                                    <option value="{{ worker.id }}"
                                            data-name="{{ worker.name }}"
                                            data-department="{{ worker.get_department_display }}"
                                            data-hourly-rate="{{ worker.hourly_rate }}"
                                            data-specialties="{{ worker.specialties }}">
                                        {{ worker.name }} ({{ worker.get_department_display }}) - ¥{{ worker.hourly_rate }}/時間
                                    </option>
                                    {% endfor %}
                                </select>
                                <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openStaffManagementPanel()">
                                    <i class="fas fa-users-cog"></i> 担当者管理
                                </button>
                            </div>

                            <!-- 新規担当者入力 -->
                            <div id="newInternalDiv" style="display: none;">
                                <input type="text" name="internal_worker_name" class="form-control" placeholder="例: 田中太郎">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">所属部署</label>
                            <input type="text" name="internal_department" class="form-control" id="internalDepartment" placeholder="例: 施工部">
                        </div>

                        <!-- 料金体系選択 -->
                        <div class="mb-3">
                            <label class="form-label">料金体系 <span class="text-danger">*</span></label>
                            <div class="mb-3">
                                <div class="row g-2">
                                    <div class="col-md-6">
                                        <div class="card pricing-type-card" id="hourlyCard">
                                            <div class="card-body text-center">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="internal_pricing_type" id="hourlyPricing" value="hourly" checked>
                                                    <label class="form-check-label fw-bold" for="hourlyPricing">
                                                        <i class="fas fa-clock me-1"></i>時給ベース
                                                    </label>
                                                </div>
                                                <small class="text-muted">時給 × 工数で計算</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card pricing-type-card" id="projectCard">
                                            <div class="card-body text-center">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="radio" name="internal_pricing_type" id="projectPricing" value="project">
                                                    <label class="form-check-label fw-bold" for="projectPricing">
                                                        <i class="fas fa-file-invoice me-1"></i>案件単位
                                                    </label>
                                                </div>
                                                <small class="text-muted">固定金額で計算</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 時給ベースの場合のフィールド -->
                        <div id="hourlyPricingFields">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">時給単価 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <span class="input-group-text">¥</span>
                                            <input type="number" name="internal_hourly_rate" class="form-control" id="internalHourlyRate" placeholder="3000">
                                            <span class="input-group-text">/時間</span>
                                        </div>
                                        <small class="text-muted">データベースから自動入力可能</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">見積工数 <span class="text-danger">*</span></label>
                                        <div class="input-group">
                                            <input type="number" name="estimated_hours" class="form-control" id="estimatedHours" step="0.5" placeholder="8.0">
                                            <span class="input-group-text">時間</span>
                                        </div>
                                        <small class="text-muted">予想される作業時間</small>
                                    </div>
                                </div>
                            </div>
                            <div class="alert alert-info">
                                <small><i class="fas fa-calculator me-1"></i>基本料金: <strong>時給 × 工数</strong> で自動計算されます</small>
                            </div>
                        </div>

                        <!-- 案件単位の場合のフィールド -->
                        <div id="projectPricingFields" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">契約金額 <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <span class="input-group-text">¥</span>
                                    <input type="number" name="project_contract_amount" class="form-control" id="projectContractAmount" placeholder="100000">
                                </div>
                                <small class="text-muted">案件全体の固定金額を入力</small>
                            </div>
                            <div class="alert alert-success">
                                <small><i class="fas fa-handshake me-1"></i>案件単位では<strong>固定金額</strong>で契約します</small>
                            </div>
                        </div>

                        <!-- 税込/税抜選択 -->
                        <div class="mb-3">
                            <label class="form-label">税込/税抜 <span class="text-danger">*</span></label>
                            <div class="mb-2">
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="tax_type" id="taxInclude" value="include" checked>
                                    <label class="form-check-label" for="taxInclude">
                                        税込
                                    </label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="tax_type" id="taxExclude" value="exclude">
                                    <label class="form-check-label" for="taxExclude">
                                        税抜
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 動的費用項目（時給ベースの追加費用 / 案件単位の費用項目） -->
                        <div class="mb-3">
                            <label class="form-label" id="costItemsLabel">追加費用項目</label>
                            <div id="costItemsSection">
                                <!-- 動的に費用項目が追加される -->
                            </div>
                            <button type="button" class="btn btn-outline-info btn-sm" id="addCostItemBtn">
                                <i class="fas fa-plus"></i> <span id="addCostItemText">追加費用項目を追加</span>
                            </button>
                            <div class="mt-2">
                                <strong id="costItemsLabel2">追加費用合計: ¥<span id="costItemsTotal">0</span></strong>
                            </div>

                            <!-- 詳細費用内訳 -->
                            <div class="mt-3 p-3 bg-light rounded" id="costBreakdown">
                                <h6 class="mb-2"><i class="fas fa-calculator"></i> 費用内訳</h6>

                                <!-- 時給ベースの場合 -->
                                <div id="hourlyBreakdown" style="display: none;">
                                    <div class="row mb-1">
                                        <div class="col-8">基本料金（時給 × 工数）:</div>
                                        <div class="col-4 text-end">¥<span id="baseAmount">0</span></div>
                                    </div>
                                    <div class="row mb-1">
                                        <div class="col-8">追加費用:</div>
                                        <div class="col-4 text-end">¥<span id="additionalAmount">0</span></div>
                                    </div>
                                    <hr class="my-2">
                                    <div class="row mb-2 fw-bold">
                                        <div class="col-8">作業費用小計:</div>
                                        <div class="col-4 text-end">¥<span id="workSubtotal">0</span></div>
                                    </div>
                                </div>

                                <!-- 案件単位の場合 -->
                                <div id="projectBreakdown" style="display: none;">
                                    <div class="row mb-2 fw-bold">
                                        <div class="col-8">作業費用小計:</div>
                                        <div class="col-4 text-end">¥<span id="projectSubtotal">0</span></div>
                                    </div>
                                </div>

                                <!-- 部材費 -->
                                <div class="row mb-1">
                                    <div class="col-8">部材費:</div>
                                    <div class="col-4 text-end">¥<span id="materialSubtotal">0</span></div>
                                </div>

                                <hr class="my-2">
                                <div class="row fw-bold text-primary">
                                    <div class="col-8 fs-5">総合計:</div>
                                    <div class="col-4 text-end fs-5">¥<span id="grandTotal">0</span></div>
                                </div>
                            </div>
                        </div>

                        <!-- 金額情報（社内） -->
                        <div class="mb-3">
                            <label class="form-label" id="contractAmountLabel">作業費用 <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" name="contract_amount" class="form-control" required id="internalContractAmount">
                            </div>
                            <small class="text-muted" id="contractAmountHint">時給ベースの場合は時給 × 工数 + 追加費用で自動計算されます</small>
                        </div>

                        <!-- 出金情報（社内リソース） -->
                        <hr>
                        <h6><i class="fas fa-credit-card"></i> 出金情報</h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">出金予定日</label>
                                    <input type="date" name="payment_due_date" class="form-control">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">出金日</label>
                                    <input type="date" name="payment_date" class="form-control">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">出金状況</label>
                            <select name="payment_status" class="form-select">
                                <option value="pending">未払い</option>
                                <option value="processing">処理中</option>
                                <option value="paid">支払済み</option>
                            </select>
                        </div>

                        <!-- 部材費情報（社内リソースでも利用可能） -->
                        <hr>
                        <h6><i class="fas fa-box"></i> 部材費情報</h6>
                        <div id="materialCostSection">
                            <!-- 動的に部材費項目が追加される -->
                        </div>
                        <button type="button" class="btn btn-outline-success btn-sm" id="addMaterialBtn">
                            <i class="fas fa-plus"></i> 部材費項目を追加
                        </button>
                        <div class="mt-2">
                            <strong>部材費合計: ¥<span id="materialTotal">0</span></strong>
                        </div>
                    </div>

                    <!-- 暫定利益率表示（詳細版） -->
                    <div class="card mt-3 border-primary shadow-sm" id="profitPreview">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-chart-line"></i> 暫定利益率分析（リアルタイム）</h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <tbody>
                                        <tr class="table-success">
                                            <td><strong>売上（受注額）</strong></td>
                                            <td class="text-end"><strong>¥<span id="previewRevenue">{{ project.billing_amount|floatformat:0|intcomma }}</span></strong></td>
                                        </tr>
                                        <tr>
                                            <td colspan="2"><strong>支出内訳</strong></td>
                                        </tr>
                                        <tr>
                                            <td class="ps-3">既存作業費用</td>
                                            <td class="text-end">¥<span id="previewExistingCost">{{ existing_total_cost|default:0 }}</span></td>
                                        </tr>
                                        <tr id="newCostRow">
                                            <td class="ps-3">追加作業費用</td>
                                            <td class="text-end">¥<span id="previewNewWorkCost">0</span></td>
                                        </tr>
                                        <tr id="newMaterialRow">
                                            <td class="ps-3">追加部材費</td>
                                            <td class="text-end">¥<span id="previewNewMaterialCost">0</span></td>
                                        </tr>
                                        <tr class="table-warning">
                                            <td><strong>総支出</strong></td>
                                            <td class="text-end"><strong>¥<span id="previewTotalCost">{{ existing_total_cost|default:0 }}</span></strong></td>
                                        </tr>
                                        <tr class="table-primary">
                                            <td><strong>粗利益</strong></td>
                                            <td class="text-end"><strong>¥<span id="previewGrossProfit">0</span></strong></td>
                                        </tr>
                                        <tr class="table-info">
                                            <td><strong>利益率</strong></td>
                                            <td class="text-end">
                                                <strong class="fs-4" id="previewProfitRate">0%</strong>
                                                <div class="progress mt-1" style="height: 8px;">
                                                    <div class="progress-bar" id="profitRateBar" role="progressbar" style="width: 0%" aria-valuemin="0" aria-valuemax="100"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-plus"></i> <span id="submitButtonText">作業者追加</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 資材管理状況 -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0"><i class="fas fa-boxes"></i> 資材管理状況
                    {% with material_status=project.get_material_status %}
                    <span class="badge bg-light text-dark ms-2">{{ material_status.total_orders }}件発注</span>
                    {% endwith %}
                </h5>
            </div>
            <div class="card-body">
                {% with material_status=project.get_material_status %}
                {% if material_status.total_orders > 0 %}
                <!-- 資材発注サマリー -->
                <div class="row mb-3">
                    <div class="col-md-3 text-center">
                        <div class="h4 text-warning">{{ material_status.total_orders }}</div>
                        <small class="text-muted">総発注数</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-success">¥{{ material_status.total_amount|floatformat:0|intcomma }}</div>
                        <small class="text-muted">総金額</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-info">{{ material_status.delivered_count }}</div>
                        <small class="text-muted">納品済み</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-primary">{{ material_status.completed_count }}</div>
                        <small class="text-muted">完了</small>
                    </div>
                </div>

                <!-- ステータス別進捗 -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>下書き</span>
                        <span class="badge bg-secondary">{{ material_status.draft_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>発注済み</span>
                        <span class="badge bg-warning">{{ material_status.ordered_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>納品済み</span>
                        <span class="badge bg-success">{{ material_status.delivered_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>完了</span>
                        <span class="badge bg-info">{{ material_status.completed_count }}</span>
                    </div>
                </div>

                <!-- 最近の発注 -->
                {% if project.material_orders.exists %}
                <h6><i class="fas fa-clock"></i> 最近の発注</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>発注番号</th>
                                <th>業者</th>
                                <th>金額</th>
                                <th>ステータス</th>
                                <th>発注日</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in project.material_orders.all|slice:":5" %}
                            <tr>
                                <td>
                                    <a href="{% url 'order_management:material_order_detail' project.id order.id %}" class="text-decoration-none">
                                        {{ order.order_number }}
                                    </a>
                                </td>
                                <td>{{ order.contractor.name }}</td>
                                <td class="text-end">¥{{ order.total_amount|floatformat:0|intcomma }}</td>
                                <td>
                                    <span class="badge bg-{{ order.get_status_color }}">
                                        {{ order.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ order.order_date }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">資材発注未登録</h5>
                    <p class="text-muted">この案件にはまだ資材発注が登録されていません。<br>右側のボタンから資材発注を開始してください。</p>
                </div>
                {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h6 class="mb-0"><i class="fas fa-plus-circle"></i> 資材管理</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'order_management:material_order_list' project.id %}" class="btn btn-warning">
                        <i class="fas fa-list"></i> 資材発注一覧
                    </a>
                    <a href="{% url 'order_management:material_order_create' project.id %}" class="btn btn-outline-warning">
                        <i class="fas fa-plus"></i> 新規資材発注
                    </a>
                </div>

                <!-- 資材管理のヒント -->
                <div class="mt-3">
                    <h6 class="text-warning"><i class="fas fa-lightbulb"></i> 使い方</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-1"><i class="fas fa-check text-warning"></i> 複数業者への発注管理</li>
                        <li class="mb-1"><i class="fas fa-check text-warning"></i> 業者ごとの複数注文対応</li>
                        <li class="mb-1"><i class="fas fa-check text-warning"></i> 納期・ステータス管理</li>
                        <li class="mb-1"><i class="fas fa-check text-warning"></i> 金額・小計自動計算</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 経理情報 -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> 経理情報</h5>
            </div>
            <div class="card-body">
                <div class="row g-0">
                    <!-- 視覚的利益分析チャート -->
                    <div class="col-md-3 d-flex align-items-center justify-content-center bg-light border-end">
                        <div class="profit-chart-container p-3">
                            <div class="chart-bars d-flex align-items-end justify-content-center" style="height: 300px;">
                                <!-- 売上バー -->
                                <div class="chart-bar-wrapper text-center">
                                    <div class="chart-bar"
                                         style="width: 80px; height: 280px; border-radius: 8px; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 15px; background: linear-gradient(135deg, #198754, #20c997); color: white; margin-right: 2px;">
                                        <div class="chart-label fw-bold mb-2" style="font-size: 0.9rem;">売上</div>
                                        <div class="chart-amount text-center fw-bold" style="font-size: 0.8rem; line-height: 1.2;">
                                            ¥{{ financial_info.revenue|floatformat:0|intcomma }}
                                        </div>
                                    </div>
                                </div>

                                <!-- 売上総利益バー -->
                                <div class="chart-bar-wrapper text-center">
                                    {% widthratio financial_info.gross_profit financial_info.revenue 100 as profit_percentage %}
                                    {% widthratio financial_info.cost_of_sales financial_info.revenue 100 as cost_percentage %}
                                    <div style="width: 80px; height: 280px; position: relative; margin-left: 2px; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;">
                                        <!-- 売上原価部分（上部） -->
                                        <div class="chart-section"
                                             style="width: 100%; height: {{ cost_percentage }}%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 8px; background: linear-gradient(135deg, #dc3545, #fd7e14); color: white; border-radius: 8px 8px 0 0;">
                                            <div class="chart-label fw-bold mb-1" style="font-size: 0.8rem;">売上原価</div>
                                            <div class="chart-amount text-center fw-bold" style="font-size: 0.7rem; line-height: 1.2;">
                                                ¥{{ financial_info.cost_of_sales|floatformat:0|intcomma }}
                                            </div>
                                        </div>
                                        <!-- 粗利部分（下部） -->
                                        <div class="chart-section"
                                             style="width: 100%; height: {{ profit_percentage }}%; background: linear-gradient(135deg, #0d6efd, #6f42c1); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 8px; color: white; border-radius: 0 0 8px 8px;">
                                            <div class="chart-label fw-bold mb-1" style="font-size: 0.8rem;">売上総利益</div>
                                            <div class="chart-amount text-center fw-bold" style="font-size: 0.7rem; line-height: 1.2;">
                                                ¥{{ financial_info.gross_profit|floatformat:0|intcomma }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="d-block text-primary fw-bold">粗利率: {{ financial_info.gross_profit_rate|floatformat:1 }}%</small>
                            </div>
                        </div>
                    </div>

                    <!-- 経理情報テーブル -->
                    <div class="col-md-9">
                        <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody>
                            <!-- 収入 -->
                            <tr style="background-color: rgba(25, 135, 84, 0.1);">
                                <td><strong>売上（受注額）</strong></td>
                                <td class="text-end"><strong>¥{{ financial_info.revenue|floatformat:0|intcomma }}</strong></td>
                            </tr>

                            <!-- 売上原価 -->
                            <tr class="table-secondary">
                                <td><strong>売上原価</strong></td>
                                <td></td>
                            </tr>
                            <!-- 発注費用詳細 -->
                            {% if subcontracts %}
                                {% for subcontract in subcontracts %}
                                <tr class="table-light">
                                    <td style="padding-left: 20px;">
                                        <em>
                                            {% if subcontract.worker_type == 'external' %}
                                                {% if subcontract.contractor %}
                                                    {{ subcontract.contractor.name }}（外注）
                                                {% else %}
                                                    外注先未設定
                                                {% endif %}
                                            {% else %}
                                                {% if subcontract.internal_worker %}
                                                    {{ subcontract.internal_worker.name }}（社内）
                                                {% elif subcontract.internal_worker_name %}
                                                    {{ subcontract.internal_worker_name }}（社内）
                                                {% else %}
                                                    社内担当者未設定
                                                {% endif %}
                                            {% endif %}
                                        </em>
                                    </td>
                                    <td class="text-end">¥{{ subcontract.billed_amount|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr class="table-light">
                                    <td style="padding-left: 20px;"><em>発注費用</em></td>
                                    <td class="text-end">¥0</td>
                                </tr>
                            {% endif %}
                            <tr class="table-light">
                                <td style="padding-left: 20px;"><em>材料費</em></td>
                                <td class="text-end">¥{{ financial_info.material_cost|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr style="background-color: rgba(220, 53, 69, 0.1);">
                                <td><strong>売上原価 小計</strong></td>
                                <td class="text-end"><strong>¥{{ financial_info.cost_of_sales|floatformat:0|intcomma }}</strong></td>
                            </tr>

                            <!-- 支出 - 販売費 -->
                            {% if financial_info.expense_1 > 0 %}
                            <tr class="table-light">
                                <td style="padding-left: 20px;"><em>{{ project.expense_item_1|default:"諸経費①" }}</em></td>
                                <td class="text-end">¥{{ financial_info.expense_1|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}
                            {% if financial_info.expense_2 > 0 %}
                            <tr class="table-light">
                                <td style="padding-left: 20px;"><em>{{ project.expense_item_2|default:"諸経費②" }}</em></td>
                                <td class="text-end">¥{{ financial_info.expense_2|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}
                            {% if financial_info.parking_fee > 0 %}
                            <tr class="table-light">
                                <td style="padding-left: 20px;"><em>駐車場代</em></td>
                                <td class="text-end">¥{{ financial_info.parking_fee|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}

                            <!-- 粗利益・利益率 -->
                            <tr style="background-color: rgba(13, 110, 253, 0.1);">
                                <td><strong>粗利益</strong></td>
                                <td class="text-end"><strong>¥{{ financial_info.gross_profit|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>粗利率</strong></td>
                                <td class="text-end">
                                    <strong class="fs-4">{{ financial_info.gross_profit_rate|floatformat:1 }}%</strong>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar {% if financial_info.gross_profit_rate >= 30 %}bg-success{% elif financial_info.gross_profit_rate >= 15 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar"
                                             style="width: {{ financial_info.gross_profit_rate|floatformat:0|intcomma }}%" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 詳細情報 -->
<div class="row mb-4">
<div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle"></i> 詳細情報</h5>
            </div>
            <div class="card-body">
                <!-- 基本情報 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">基本情報</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">管理No:</dt>
                                    <dd class="col-sm-8">{{ project.management_no }}</dd>
                                    <dt class="col-sm-4">現場名:</dt>
                                    <dd class="col-sm-8">{{ project.site_name }}</dd>
                                    <dt class="col-sm-4">種別:</dt>
                                    <dd class="col-sm-8">{{ project.work_type }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">現場住所:</dt>
                                    <dd class="col-sm-8">{{ project.site_address }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 受注・見積情報 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">受注・見積情報</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">案件進捗:</dt>
                                    <dd class="col-sm-7">
                                        {% with stage=project.get_current_project_stage %}
                                        <span class="badge bg-{{ stage.color }}">
                                            {{ stage.stage }}
                                        </span>
                                        {% endwith %}
                                    </dd>
                                    <dt class="col-sm-5">受注ヨミ:</dt>
                                    <dd class="col-sm-7">
                                        <select class="form-select form-select-sm order-forecast-select-detail"
                                                data-project-id="{{ project.pk }}"
                                                style="width: auto; display: inline-block; max-width: 150px;">
                                            {% for value, label in project.PROJECT_STATUS_CHOICES %}
                                            <option value="{{ value }}" {% if value == project.project_status %}selected{% endif %}>
                                                {{ label }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </dd>
                                    <dt class="col-sm-5">見積書発行日:</dt>
                                    <dd class="col-sm-7">{{ project.estimate_issued_date|date:"Y年m月d日"|default:"-" }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">受注金額(税込):</dt>
                                    <dd class="col-sm-7 text-primary fw-bold">¥{{ project.order_amount|floatformat:0|intcomma }}</dd>
                                    <dt class="col-sm-5">駐車場代(税込):</dt>
                                    <dd class="col-sm-7">¥{{ project.parking_fee|floatformat:0|intcomma }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 業者・担当情報 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">業者・担当情報</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">元請名:</dt>
                                    <dd class="col-sm-8">{{ project.client_name }}</dd>
                                    <dt class="col-sm-4">案件担当:</dt>
                                    <dd class="col-sm-8">{{ project.project_manager }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-4">元請住所:</dt>
                                    <dd class="col-sm-8">{{ project.client_address }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- スケジュール -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">スケジュール</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">契約日:</dt>
                                    <dd class="col-sm-7">{{ project.contract_date|date:"Y年m月d日"|default:"-" }}</dd>
                                    <dt class="col-sm-5">工事開始日:</dt>
                                    <dd class="col-sm-7">{{ project.work_start_date|date:"Y年m月d日"|default:"-" }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">工事終了日:</dt>
                                    <dd class="col-sm-7">{{ project.work_end_date|date:"Y年m月d日"|default:"-" }}</dd>
                                    <dt class="col-sm-5">入金予定日:</dt>
                                    <dd class="col-sm-7">{{ project.payment_due_date|date:"Y年m月d日"|default:"-" }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 請求・経費管理 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">請求・経費管理</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">請求書発行:</dt>
                                    <dd class="col-sm-7">
                                        {% if project.invoice_issued %}
                                        <span class="badge bg-success">発行済み</span>
                                        {% else %}
                                        <span class="badge bg-secondary">未発行</span>
                                        {% endif %}
                                    </dd>
                                    <dt class="col-sm-5">諸経費項目①:</dt>
                                    <dd class="col-sm-7">{{ project.expense_item_1|default:"-" }}</dd>
                                    <dt class="col-sm-5">諸経費代①:</dt>
                                    <dd class="col-sm-7">¥{{ project.expense_amount_1|floatformat:0|intcomma }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">諸経費項目②:</dt>
                                    <dd class="col-sm-7">{{ project.expense_item_2|default:"-" }}</dd>
                                    <dt class="col-sm-5">諸経費代②:</dt>
                                    <dd class="col-sm-7">¥{{ project.expense_amount_2|floatformat:0|intcomma }}</dd>
                                </dl>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">請求額実請求:</dt>
                                    <dd class="col-sm-7 text-success fw-bold fs-5">¥{{ project.billing_amount|floatformat:0|intcomma }}</dd>
                                </dl>
                            </div>
                            <div class="col-md-6">
                                <dl class="row">
                                    <dt class="col-sm-5">増減:</dt>
                                    <dd class="col-sm-7 {% if project.amount_difference > 0 %}text-success{% elif project.amount_difference < 0 %}text-danger{% endif %} fw-bold">
                                        ¥{{ project.amount_difference|floatformat:0|intcomma }}
                                    </dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 備考 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">備考</h5>
                    </div>
                    <div class="card-body">
                        {% if project.notes %}
                            <p>{{ project.notes|linebreaks }}</p>
                        {% else %}
                            <p class="text-muted">備考はありません</p>
                        {% endif %}
                    </div>
                </div>

                <!-- システム情報 -->
                <div class="card mb-3">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">システム情報</h5>
                    </div>
                    <div class="card-body">
                        <dl class="row">
                            <dt class="col-sm-2">作成日時:</dt>
                            <dd class="col-sm-4">{{ project.created_at|date:"Y年m月d日 H:i" }}</dd>
                            <dt class="col-sm-2">更新日時:</dt>
                            <dd class="col-sm-4">{{ project.updated_at|date:"Y年m月d日 H:i" }}</dd>
                        </dl>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- ページ最下部のアクションボタン -->
<div class="row mt-5 mb-4">
    <div class="col-12 text-center">
        <a href="{% url 'order_management:project_update' project.pk %}" class="btn btn-warning btn-lg">
            <i class="fas fa-edit"></i> この案件を編集
        </a>
    </div>
</div>

<!-- 削除確認モーダル -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">案件削除の確認</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>以下の案件を削除してもよろしいですか？</p>
                <p class="text-danger">
                    <strong>{{ project.management_no }} - {{ project.site_name }}</strong>
                </p>
                <p class="text-muted">この操作は取り消せません。</p>
            </div>
            <div class="modal-footer">
                <form method="post" action="{% url 'order_management:project_delete' project.pk %}">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <button type="submit" class="btn btn-danger">削除する</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// グローバル変数の初期化
var editMode = false;
var sortable = null;

// ステップ編集モードの切り替え（グローバル関数）
function toggleEditMode() {
    editMode = !editMode;
    const btn = $('#editStepsBtn');

    if (editMode) {
        // 編集モードON
        btn.html('<i class="fas fa-check"></i> 編集完了');
        btn.removeClass('btn-outline-primary').addClass('btn-success');
        $('.remove-step-btn').show();
        $('.drag-handle').show();
        $('#stepInventory').show();
        if (typeof loadAvailableSteps === 'function') {
            loadAvailableSteps();
        }
    } else {
        // 編集モードOFF - 変更を保存

        // ステップ順序を保存
        if (typeof saveStepOrder === 'function') {
            saveStepOrder();
        }

        // すべての動的フィールドを収集
        const dynamicFields = {};
        $('.progress-step[data-step]').each(function() {
            const stepKey = $(this).data('step');
            const stepElement = $(this);

            // 複合ステップのフィールドを探す
            stepElement.find('input, select, textarea').each(function() {
                const fieldElement = $(this);
                const fieldName = fieldElement.attr('name');

                // フィールド名がない場合はスキップ
                if (!fieldName) return;

                let fieldValue;

                // チェックボックスとラジオボタンの場合
                if (fieldElement.is(':checkbox')) {
                    fieldValue = fieldElement.is(':checked') ? 'on' : '';
                } else if (fieldElement.is(':radio')) {
                    // ラジオボタンは選択されている場合のみ処理
                    if (!fieldElement.is(':checked')) return;
                    fieldValue = fieldElement.val();
                } else {
                    fieldValue = fieldElement.val();
                }

                // 基本フィールド（estimate, contract, work_start, work_end, invoice）
                const isBasicField = ['estimate_issued_date', 'estimate_not_required', 'contract_date',
                                     'work_start_date', 'work_start_completed', 'work_end_date',
                                     'work_end_completed', 'invoice_issued'].includes(fieldName);

                // すべてのフィールドを空でもPOST（削除・クリア操作を可能にするため）
                // dynamic_field_ プレフィックスは基本フィールド以外に追加
                const finalFieldName = isBasicField ? fieldName :
                                      (fieldName.startsWith('dynamic_field_') ? fieldName : `dynamic_field_${fieldName}`);
                dynamicFields[finalFieldName] = fieldValue;
            });
        });

        console.log('Saving dynamic fields:', dynamicFields);

        // サーバーに保存（AJAX - 統一エンドポイント）
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: $.extend({
                csrfmiddlewaretoken: '{{ csrf_token }}',
                step_order: $('#stepOrderInput').val(),
                ajax_save: 'true'  // AJAX保存フラグ
            }, dynamicFields),
            success: function(response) {
                if (typeof toastr !== 'undefined') {
                    toastr.success('変更を保存しました');
                }
                // ページをリロードして最新の状態を表示
                location.reload();
            },
            error: function(xhr, status, error) {
                console.error('保存エラー:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('保存中にエラーが発生しました');
                }
            }
        });

        // UIを編集モードOFFに
        btn.html('<i class="fas fa-edit"></i> ステップ編集');
        btn.removeClass('btn-success').addClass('btn-outline-primary');
        $('.remove-step-btn').hide();
        $('.drag-handle').hide();
        $('#stepInventory').hide();
    }

    // Sortableの有効/無効を切り替え
    if (sortable) {
        sortable.option("disabled", !editMode);
    }
}

$(document).ready(function() {
    // ステップ編集ボタンのイベントリスナーを設定
    $('#editStepsBtn').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleEditMode();
    });

    // 依存フィールドの表示/非表示切り替え
    $(document).on('change', 'input[type="radio"]', function() {
        const fieldName = $(this).attr('name');
        const selectedValue = $(this).val();

        // この変更によって影響を受ける依存フィールドを探す
        $(`[data-dependency-field="${fieldName}"]`).each(function() {
            const requiredValue = $(this).data('dependency-value');
            if (selectedValue === requiredValue) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // 初期状態で料金体系を設定（ページロード時に実行）
    setTimeout(function() {
        console.log('🔄 Initializing pricing type on page load');
        console.log('🔍 All pricing elements exist at start:', {
            hourly: $('#hourlyPricingFields').length,
            project: $('#projectPricingFields').length,
            hourlyCard: $('#hourlyCard').length,
            projectCard: $('#projectCard').length
        });

        // 初期選択されている作業者タイプをチェック
        var selectedWorkerType = $('input[name="worker_type"]:checked').val();
        console.log('🔍 Selected worker type:', selectedWorkerType);

        // 社内リソースが選択されている場合は、料金体系を初期化
        if (selectedWorkerType === 'internal') {
            $('#internalWorkerSection').show();
            console.log('🔍 Internal section shown');

            // 少し待ってから初期化（DOM更新後）
            setTimeout(function() {
                initializePricingType();

                var checkedRadio = $('input[name="internal_pricing_type"]:checked');
                console.log('🔍 Checked pricing radio found:', checkedRadio.length);
                if (checkedRadio.length > 0) {
                    checkedRadio.trigger('change');
                }
            }, 50);
        }
    }, 100);

    // モーダルのARIA属性管理
    $('#staffManagementModal, #staffModal').on('show.bs.modal', function() {
        console.log('📋 Modal showing - removing aria-hidden');
        $(this).removeAttr('aria-hidden');
    }).on('hide.bs.modal', function() {
        console.log('📋 Modal hiding - adding aria-hidden');
        $(this).attr('aria-hidden', 'true');
    }).on('shown.bs.modal', function() {
        console.log('📋 Modal shown - ensuring proper focus management');
        // モーダル内の最初のフォーカス可能な要素にフォーカス
        var firstFocusableElement = $(this).find('input, select, textarea, button').filter(':visible').first();
        if (firstFocusableElement.length) {
            setTimeout(function() {
                firstFocusableElement.focus();
            }, 100);
        }
    });

    // 作業者タイプの切り替え
    $('input[name="worker_type"]').on('change', function() {
        if ($(this).val() === 'external') {
            $('#externalWorkerSection').show();
            $('#internalWorkerSection').hide();
            $('#submitButtonText').text('発注先追加');

            // 外注先フィールドを必須に
            $('#contractorSelect').attr('required', true);
            $('input[name="client_name"]').attr('required', false);

            // 社内フィールドを非必須に
            $('input[name="internal_worker_name"]').attr('required', false);
        } else {
            $('#externalWorkerSection').hide();
            $('#internalWorkerSection').show();
            $('#submitButtonText').text('社内リソース追加');

            // 社内フィールドを必須に
            $('input[name="internal_worker_name"]').attr('required', true);

            // 料金体系の初期化を実行
            setTimeout(function() {
                console.log('🔄 Initializing pricing type after internal switch');
                console.log('🔍 Internal section visible:', $('#internalWorkerSection').is(':visible'));
                console.log('🔍 Pricing elements exist:', $('#hourlyPricingFields').length, $('#projectPricingFields').length);

                initializePricingType();
                // 現在選択されている料金体系を強制的に適用
                var checkedRadio = $('input[name="internal_pricing_type"]:checked');
                console.log('🔍 Checked radio found:', checkedRadio.length);
                if (checkedRadio.length > 0) {
                    checkedRadio.trigger('change');
                }
            }, 200);

            // 外注先フィールドを非必須に
            $('#contractorSelect').attr('required', false);
            $('input[name="client_name"]').attr('required', false);
        }
        updateCostBreakdown();
        updateProfitPreview();
    });

    // 社内担当者選択方法の切り替え
    $('input[name="internal_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existingInternalDiv').show();
            $('#newInternalDiv').hide();
            $('#internalSelect').attr('required', true);
            $('input[name="internal_worker_name"]').attr('required', false);
        } else {
            $('#existingInternalDiv').hide();
            $('#newInternalDiv').show();
            $('#internalSelect').attr('required', false);
            $('input[name="internal_worker_name"]').attr('required', true);
        }
    });

    // 既存社内担当者選択時の情報自動入力
    $('#internalSelect').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var department = selectedOption.data('department') || '';
        var hourlyRate = selectedOption.data('hourly-rate') || '';

        $('#internalDepartment').val(department);
        $('#internalHourlyRate').val(hourlyRate);

        // 工数が入力されていれば自動計算
        calculateInternalCost();
    });

    // 業者選択方法の切り替え
    $('input[name="contractor_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existingContractorDiv').show();
            $('#newContractorDiv').hide();
            $('#contractorSelect').attr('required', true);
            $('input[name="client_name"]').attr('required', false);
        } else {
            $('#existingContractorDiv').hide();
            $('#newContractorDiv').show();
            $('#contractorSelect').attr('required', false);
            $('input[name="client_name"]').attr('required', true);
        }
    });

    // 既存業者選択時の住所自動入力
    $('#contractorSelect').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var address = selectedOption.data('address') || '';
        $('#contractorAddress').val(address);
    });

    // モーダル内の料金体系の切り替え（修正版）
    $(document).on('change', 'input[name="modal_internal_pricing_type"]', function() {
        var pricingType = $(this).val();
        console.log('========================');
        console.log('🔥 Modal Pricing type changed to:', pricingType);
        console.log('🔍 Event target element:', $(this)[0]);
        console.log('🔍 Parent modal visible:', $(this).closest('#addImplementationModal').is(':visible'));

        // モーダル用要素の存在確認
        var hourlyFields = $('#modalHourlyPricingFields');
        var projectFields = $('#modalProjectPricingFields');

        console.log('🎯 Modal Elements found:');
        console.log('  - modalHourlyPricingFields:', hourlyFields.length, 'visible:', hourlyFields.is(':visible'));
        console.log('  - modalProjectPricingFields:', projectFields.length, 'visible:', projectFields.is(':visible'));

        console.log('🔧 Before changes:');
        console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
        console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));

        if (pricingType === 'hourly') {
            console.log('🔧 Setting modal to hourly mode');
            $('#modalHourlyPricingFields').show();
            $('#modalProjectPricingFields').hide();
            console.log('🔧 After hourly changes:');
            console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
            console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));
        } else {
            console.log('🔧 Setting modal to project mode');
            $('#modalHourlyPricingFields').hide();
            $('#modalProjectPricingFields').show();
            console.log('🔧 After project changes:');
            console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
            console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));
        }
        console.log('========================');
    });

    // ページ内フォームの料金体系の切り替え（詳細デバッグ付き）
    $(document).on('change', 'input[name="internal_pricing_type"]', function() {
        var pricingType = $(this).val();
        console.log('========================');
        console.log('🔥 Pricing type changed to:', pricingType);
        console.log('🔍 Event target element:', $(this)[0]);
        console.log('🔍 Parent container visible:', $(this).closest('#internalWorkerSection').is(':visible'));

        // 要素の存在確認
        var hourlyFields = $('#hourlyPricingFields');
        var projectFields = $('#projectPricingFields');
        var hourlyCard = $('#hourlyCard');
        var projectCard = $('#projectCard');

        console.log('🎯 Elements found:');
        console.log('  - hourlyPricingFields:', hourlyFields.length, 'visible:', hourlyFields.is(':visible'));
        console.log('  - projectPricingFields:', projectFields.length, 'visible:', projectFields.is(':visible'));
        console.log('  - hourlyCard:', hourlyCard.length, 'visible:', hourlyCard.is(':visible'));
        console.log('  - projectCard:', projectCard.length, 'visible:', projectCard.is(':visible'));

        // カードのハイライト
        $('.pricing-type-card').removeClass('border-primary bg-light');
        console.log('🔧 Before changes:');
        console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
        console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));

        if (pricingType === 'hourly') {
            console.log('🔧 Setting to hourly mode');
            $('#hourlyCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
            console.log('🔧 After hourly changes:');
            console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
            console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));
            $('#contractAmountHint').text('時給ベースの場合は時給 × 工数 + 追加費用で自動計算されます');
            $('#internalContractAmount').prop('readonly', true);
            $('#costItemsLabel').text('追加費用項目');
            $('#addCostItemText').text('追加費用項目を追加');
            $('#costItemsLabel2').text('追加費用合計: ¥');
            $('#contractAmountLabel').text('作業費用（基本料金 + 追加費用）');
        } else {
            console.log('🔧 Setting to project mode');
            $('#projectCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
            console.log('🔧 After project changes:');
            console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
            console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));
            $('#contractAmountHint').text('案件単位の場合は契約金額 + 追加費用で計算されます');
            $('#internalContractAmount').prop('readonly', true);
            $('#costItemsLabel').text('追加費用項目');
            $('#addCostItemText').text('追加費用項目を追加');
            $('#costItemsLabel2').text('追加費用合計: ¥');
            $('#contractAmountLabel').text('作業費用（契約金額 + 追加費用）');
        }
        calculateInternalCost();
        updateProfitPreview();
        console.log('========================');
    });

    // 手動デバッグ用の関数をグローバルに追加
    window.debugPricingSystem = function() {
        console.log('🐛 Manual Pricing System Debug:');
        console.log('  - Internal section visible:', $('#internalWorkerSection').is(':visible'));
        console.log('  - Pricing radio buttons found:', $('input[name="internal_pricing_type"]').length);
        console.log('  - Currently checked:', $('input[name="internal_pricing_type"]:checked').val());
        console.log('  - hourlyPricingFields exists:', $('#hourlyPricingFields').length, 'visible:', $('#hourlyPricingFields').is(':visible'));
        console.log('  - projectPricingFields exists:', $('#projectPricingFields').length, 'visible:', $('#projectPricingFields').is(':visible'));
        console.log('  - hourlyCard exists:', $('#hourlyCard').length);
        console.log('  - projectCard exists:', $('#projectCard').length);

        // 強制的に切り替えテスト
        console.log('🧪 Testing force toggle to project mode:');
        $('#projectPricing').prop('checked', true).trigger('change');
    };

    window.debugModalPricingSystem = function() {
        console.log('🐛 Modal Pricing System Debug:');
        console.log('  - Modal visible:', $('#addImplementationModal').is(':visible'));
        console.log('  - Modal pricing radio buttons found:', $('input[name="modal_internal_pricing_type"]').length);
        console.log('  - Currently checked:', $('input[name="modal_internal_pricing_type"]:checked').val());
        console.log('  - modalHourlyPricingFields exists:', $('#modalHourlyPricingFields').length, 'visible:', $('#modalHourlyPricingFields').is(':visible'));
        console.log('  - modalProjectPricingFields exists:', $('#modalProjectPricingFields').length, 'visible:', $('#modalProjectPricingFields').is(':visible'));

        // 強制的に切り替えテスト
        console.log('🧪 Testing force toggle to modal project mode:');
        $('#modalProjectPricing').prop('checked', true).trigger('change');
    };

    window.testToggleToProject = function() {
        console.log('🧪 Manually triggering project mode');
        $('#projectPricing').prop('checked', true).trigger('change');
    };

    window.testToggleToHourly = function() {
        console.log('🧪 Manually triggering hourly mode');
        $('#hourlyPricing').prop('checked', true).trigger('change');
    };

    window.testModalToggleToProject = function() {
        console.log('🧪 Manually triggering modal project mode');
        $('#modalProjectPricing').prop('checked', true).trigger('change');
    };

    window.testModalToggleToHourly = function() {
        console.log('🧪 Manually triggering modal hourly mode');
        $('#modalHourlyPricing').prop('checked', true).trigger('change');
    };

    // 社内リソースの作業費用自動計算
    function calculateInternalCost() {
        var pricingType = $('input[name="internal_pricing_type"]:checked').val();

        if (pricingType === 'hourly') {
            // 時給ベース：基本料金 + 追加費用
            var hourlyRate = parseFloat($('input[name="internal_hourly_rate"]').val()) || 0;
            var hours = parseFloat($('input[name="estimated_hours"]').val()) || 0;
            var baseAmount = hourlyRate * hours;

            var additionalCost = 0;
            $('.cost-item-input').each(function() {
                additionalCost += parseFloat($(this).val()) || 0;
            });

            var total = baseAmount + additionalCost;
            $('#internalContractAmount').val(total);

            // 内訳表示を更新
            $('#baseAmount').text(baseAmount.toLocaleString());
            $('#additionalAmount').text(additionalCost.toLocaleString());
            $('#workSubtotal').text(total.toLocaleString());
            $('#hourlyBreakdown').show();
            $('#projectBreakdown').hide();
        } else if (pricingType === 'project') {
            // 案件単位：契約金額 + 追加費用
            var contractAmount = parseFloat($('#projectContractAmount').val()) || 0;

            var additionalCost = 0;
            $('.cost-item-input').each(function() {
                additionalCost += parseFloat($(this).val()) || 0;
            });

            var total = contractAmount + additionalCost;
            $('#internalContractAmount').val(total);

            // 内訳表示を更新
            $('#projectBaseAmount').text(contractAmount.toLocaleString());
            $('#projectAdditionalAmount').text(additionalCost.toLocaleString());
            $('#projectSubtotal').text(total.toLocaleString());
            $('#hourlyBreakdown').hide();
            $('#projectBreakdown').show();
        }

        updateCostBreakdown();
        updateProfitPreview();
    }

    // 費用内訳の更新
    function updateCostBreakdown() {
        var workerType = $('input[name="worker_type"]:checked').val();
        var materialCost = 0;
        var workCost = 0;

        if (workerType === 'external') {
            // 外注先の場合
            workCost = parseFloat($('input[name="contract_amount"]').val()) || 0;
            var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;
            $('.external-material-cost-input').each(function() {
                materialCost += parseFloat($(this).val()) || 0;
            });

            $('#externalContractAmount').text(workCost.toLocaleString());
            $('#externalBilledAmount').text(billedAmount.toLocaleString());
            $('#externalMaterialSubtotal').text(materialCost.toLocaleString());
            $('#externalGrandTotal').text((Math.max(workCost, billedAmount) + materialCost).toLocaleString());
        } else {
            // 社内リソースの場合
            workCost = parseFloat($('#internalContractAmount').val()) || 0;
            $('.internal-material-cost-input').each(function() {
                materialCost += parseFloat($(this).val()) || 0;
            });
        }

        // 共通の部材費表示更新
        $('#materialSubtotal').text(materialCost.toLocaleString());

        // 総合計の更新
        var grandTotal = workCost + materialCost;
        $('#grandTotal').text(grandTotal.toLocaleString());
    }

    // 時給と工数の変更を監視
    $('input[name="internal_hourly_rate"], input[name="estimated_hours"]').on('input', calculateInternalCost);

    // 案件単位の契約金額変更を監視
    $('#projectContractAmount').on('input', calculateInternalCost);

    // 初期状態の設定
    function initializePricingType() {
        var pricingType = $('input[name="internal_pricing_type"]:checked').val();
        console.log('🔧 Initializing pricing type:', pricingType);
        console.log('🎯 Hourly fields element:', $('#hourlyPricingFields').length);
        console.log('🎯 Project fields element:', $('#projectPricingFields').length);
        console.log('🎯 Hourly card element:', $('#hourlyCard').length);
        console.log('🎯 Project card element:', $('#projectCard').length);

        $('.pricing-type-card').removeClass('border-primary bg-light');

        if (pricingType === 'hourly') {
            console.log('🔧 Initializing as hourly');
            $('#hourlyCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
        } else if (pricingType === 'project') {
            console.log('🔧 Initializing as project');
            $('#projectCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
        } else {
            console.log('⚠️ Unknown pricing type:', pricingType);
        }
    }

    // ページ読み込み時に初期化実行
    initializePricingType();

    // カードクリックで料金体系切り替え
    $(document).on('click', '.pricing-type-card', function() {
        console.log('🎯 Card clicked');
        var targetRadio = $(this).find('input[type="radio"]');
        console.log('📻 Radio found:', targetRadio.length);
        targetRadio.prop('checked', true).trigger('change');
    });

    // 暫定利益率の計算と表示（詳細版）
    function updateProfitPreview() {
        var revenue = parseFloat("{{ project.billing_amount|default:0 }}".replace(/,/g, '')) || 0;
        var newWorkCost = 0;
        var newMaterialCost = 0;

        // 現在入力されている作業費用を取得
        if ($('input[name="worker_type"]:checked').val() === 'external') {
            newWorkCost = parseFloat($('input[name="contract_amount"]').val()) || 0;
            var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;
            newWorkCost = Math.max(newWorkCost, billedAmount); // より高い方を使用

            // 外注先の部材費合計
            $('.external-material-cost-input').each(function() {
                newMaterialCost += parseFloat($(this).val()) || 0;
            });
        } else {
            newWorkCost = parseFloat($('#internalContractAmount').val()) || 0;
            // 社内リソースの部材費合計
            $('.internal-material-cost-input').each(function() {
                newMaterialCost += parseFloat($(this).val()) || 0;
            });
        }

        var existingCost = parseFloat("{{ existing_total_cost|default:0 }}".replace(/,/g, '')) || 0;
        var totalCost = existingCost + newWorkCost + newMaterialCost;
        var grossProfit = revenue - totalCost;
        var profitRate = revenue > 0 ? (grossProfit / revenue * 100) : 0;

        // 詳細表示を更新
        $('#previewRevenue').text(revenue.toLocaleString());
        $('#previewExistingCost').text(existingCost.toLocaleString());
        $('#previewNewWorkCost').text(newWorkCost.toLocaleString());
        $('#previewNewMaterialCost').text(newMaterialCost.toLocaleString());
        $('#previewTotalCost').text(totalCost.toLocaleString());
        $('#previewGrossProfit').text(grossProfit.toLocaleString());
        $('#previewProfitRate').text(profitRate.toFixed(1) + '%');

        // 利益率に応じて色とメッセージを変更
        var rateElement = $('#previewProfitRate');
        var progressBar = $('#profitRateBar');

        rateElement.removeClass('text-success text-warning text-danger');
        progressBar.removeClass('bg-success bg-warning bg-danger');

        // プログレスバーの幅を設定（最大50%まで表示）
        var displayRate = Math.min(profitRate, 50);
        progressBar.css('width', displayRate + '%');

        // 利益率に応じた色分け
        if (profitRate >= 30) {
            rateElement.addClass('text-success');
            progressBar.addClass('bg-success');
        } else if (profitRate >= 15) {
            rateElement.addClass('text-warning');
            progressBar.addClass('bg-warning');
        } else {
            rateElement.addClass('text-danger');
            progressBar.addClass('bg-danger');
        }

        // 新規費用がある場合のみ行を表示
        if (newWorkCost > 0) {
            $('#newCostRow').show();
        } else {
            $('#newCostRow').hide();
        }

        if (newMaterialCost > 0) {
            $('#newMaterialRow').show();
        } else {
            $('#newMaterialRow').hide();
        }

        // 利益率プレビューは常に表示（内容を動的に更新）
        // 入力がない場合でも現在の状況を表示
    }

    // 金額フィールドの変更を監視（外注先用）
    $('input[name="contract_amount"], input[name="billed_amount"]').on('input', function() {
        updateCostBreakdown();
        updateProfitPreview();
    });

    // 部材費合計の自動計算
    function calculateMaterialTotal() {
        var total = 0;
        $('.material-cost').each(function() {
            var value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#totalMaterialCost').val(total);
    }

    // 部材費フィールドの変更を監視
    $('.material-cost').on('input', calculateMaterialTotal);

    // 初期計算
    calculateMaterialTotal();

    // 動的部材費項目管理
    let materialItemCounter = 0;
    let externalMaterialItemCounter = 0;

    // 社内リソース用部材費項目を追加する関数
    function addMaterialItem(item = '', cost = 0) {
        materialItemCounter++;
        const itemHtml = `
            <div class="material-item mb-2" data-item-id="${materialItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="internal_material_items[]" class="form-control"
                               placeholder="部材費項目" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" name="internal_material_costs[]" class="form-control internal-material-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-material-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#materialCostSection').append(itemHtml);
        updateInternalMaterialTotal();
    }

    // 外注先用部材費項目を追加する関数
    function addExternalMaterialItem(item = '', cost = 0) {
        externalMaterialItemCounter++;
        const itemHtml = `
            <div class="external-material-item mb-2" data-item-id="${externalMaterialItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="material_items[]" class="form-control"
                               placeholder="部材費項目" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" name="material_costs[]" class="form-control external-material-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-external-material-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#externalMaterialCostSection').append(itemHtml);
        updateExternalMaterialTotal();
    }

    // 社内リソース部材費合計を更新する関数
    function updateInternalMaterialTotal() {
        let total = 0;
        $('.internal-material-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#materialTotal').text(total.toLocaleString());
        updateCostBreakdown();
        updateProfitPreview();
    }

    // 外注先部材費合計を更新する関数
    function updateExternalMaterialTotal() {
        let total = 0;
        $('.external-material-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#externalMaterialTotal').text(total.toLocaleString());
        $('#externalMaterialSubtotal').text(total.toLocaleString());
        updateExternalCostBreakdown();
        updateProfitPreview();
    }

    // 外注先用追加費用項目カウンター
    let externalAdditionalCostItemCounter = 0;

    // 外注先用追加費用項目を追加する関数
    function addExternalAdditionalCostItem(item = '', cost = 0) {
        externalAdditionalCostItemCounter++;
        const itemHtml = `
            <div class="external-additional-cost-item mb-2" data-item-id="${externalAdditionalCostItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="additional_cost_items[]" class="form-control"
                               placeholder="追加費用項目" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" name="additional_cost_amounts[]" class="form-control external-additional-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-external-additional-cost-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#externalAdditionalCostSection').append(itemHtml);
        updateExternalAdditionalCostTotal();
    }

    // 外注先追加費用合計を更新する関数
    function updateExternalAdditionalCostTotal() {
        let total = 0;
        $('.external-additional-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#externalAdditionalCostTotal').text(total.toLocaleString());
        $('#externalAdditionalCostSubtotal').text(total.toLocaleString());
        updateExternalCostBreakdown();
        updateProfitPreview();
    }

    // 外注先費用内訳を更新する関数
    function updateExternalCostBreakdown() {
        var contractAmount = parseFloat($('input[name="contract_amount"]').val()) || 0;
        var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;

        var materialCost = 0;
        $('.external-material-cost-input').each(function() {
            materialCost += parseFloat($(this).val()) || 0;
        });

        var additionalCost = 0;
        $('.external-additional-cost-input').each(function() {
            additionalCost += parseFloat($(this).val()) || 0;
        });

        $('#externalContractAmount').text(contractAmount.toLocaleString());
        $('#externalBilledAmount').text(billedAmount.toLocaleString());
        $('#externalMaterialSubtotal').text(materialCost.toLocaleString());
        $('#externalAdditionalCostSubtotal').text(additionalCost.toLocaleString());

        var grandTotal = Math.max(contractAmount, billedAmount) + materialCost + additionalCost;
        $('#externalGrandTotal').text(grandTotal.toLocaleString());
    }

    // 社内リソース部材費項目追加ボタンのクリックイベント
    $('#addMaterialBtn').on('click', function() {
        addMaterialItem();
    });

    // 外注先部材費項目追加ボタンのクリックイベント
    $('#addExternalMaterialBtn').on('click', function() {
        addExternalMaterialItem();
    });

    // 外注先追加費用項目追加ボタンのクリックイベント
    $('#addExternalAdditionalCostBtn').on('click', function() {
        addExternalAdditionalCostItem();
    });

    // 社内リソース部材費項目削除ボタンのクリックイベント（イベント委譲）
    $(document).on('click', '.remove-material-btn', function() {
        $(this).closest('.material-item').remove();
        updateInternalMaterialTotal();
    });

    // 外注先部材費項目削除ボタンのクリックイベント（イベント委譲）
    $(document).on('click', '.remove-external-material-btn', function() {
        $(this).closest('.external-material-item').remove();
        updateExternalMaterialTotal();
    });

    // 外注先追加費用項目削除ボタンのクリックイベント（イベント委譲）
    $(document).on('click', '.remove-external-additional-cost-btn', function() {
        $(this).closest('.external-additional-cost-item').remove();
        updateExternalAdditionalCostTotal();
    });

    // 社内リソース部材費金額の変更を監視
    $(document).on('input', '.internal-material-cost-input', function() {
        updateInternalMaterialTotal();
    });

    // 外注先部材費金額の変更を監視
    $(document).on('input', '.external-material-cost-input', function() {
        updateExternalMaterialTotal();
    });

    // 外注先追加費用金額の変更を監視
    $(document).on('input', '.external-additional-cost-input', function() {
        updateExternalAdditionalCostTotal();
    });

    // 外注先契約金額・被請求額の変更を監視
    $(document).on('input', 'input[name="contract_amount"], input[name="billed_amount"]', function() {
        updateExternalCostBreakdown();
        updateProfitPreview();
    });

    // 担当者選択追加ボタンのクリックイベント
    $(document).on('click', '.add-staff-select-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const containerId = $(this).data('container-id');
        const fieldName = $(this).data('field-name');
        const container = $(`#${containerId}`);

        // スタッフオプションを生成
        const staffOptions = generateStaffOptions();
        let optionsHtml = '<option value="">選択してください</option>';
        if (staffOptions && Array.isArray(staffOptions)) {
            staffOptions.forEach(option => {
                optionsHtml += `<option value="${option.value}">${option.text}</option>`;
            });
        }

        // 新しいselectボックスを追加
        const newSelect = `
            <div class="staff-select-item mb-2">
                <select name="${fieldName}" class="form-select form-select-sm d-inline-block" style="width: calc(100% - 50px);">
                    ${optionsHtml}
                </select>
                <button type="button" class="btn btn-outline-danger btn-sm remove-staff-select-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.append(newSelect);

        // 削除ボタンを表示（2つ以上の場合）
        if (container.find('.staff-select-item').length > 1) {
            container.find('.remove-staff-select-btn').show();
        }
    });

    // 担当者選択削除ボタンのクリックイベント
    $(document).on('click', '.remove-staff-select-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const item = $(this).closest('.staff-select-item');
        const container = item.closest('.staff-select-container');

        item.remove();

        // 1つしかない場合は削除ボタンを非表示
        if (container.find('.staff-select-item').length <= 1) {
            container.find('.remove-staff-select-btn').hide();
        }
    });

    // 個別ステップ保存ボタンのクリックイベント
    $(document).on('click', '.save-step-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const stepKey = $(this).data('step');
        const stepElement = $(`.progress-step[data-step="${stepKey}"]`);

        if (stepElement.length === 0) {
            console.error('Step element not found:', stepKey);
            return;
        }

        // このステップのフィールドを収集
        const dynamicFields = {};
        stepElement.find('input, select, textarea').each(function() {
            const fieldElement = $(this);
            const fieldName = fieldElement.attr('name');

            // フィールド名がない場合はスキップ
            if (!fieldName) return;

            let fieldValue;

            // チェックボックスとラジオボタンの場合
            if (fieldElement.is(':checkbox')) {
                fieldValue = fieldElement.is(':checked') ? 'true' : 'false';
            } else if (fieldElement.is(':radio')) {
                // ラジオボタンは選択されている場合のみ処理
                if (!fieldElement.is(':checked')) return;
                fieldValue = fieldElement.val();
            } else if (fieldElement.is('select[multiple]')) {
                // 複数選択の場合
                const selectedValues = fieldElement.val();
                if (selectedValues && selectedValues.length > 0) {
                    fieldValue = selectedValues.join(',');
                } else {
                    return; // 何も選択されていない場合はスキップ
                }
            } else {
                fieldValue = fieldElement.val();
            }

            // 値が存在する場合のみ追加
            if (fieldValue !== undefined && fieldValue !== '') {
                // dynamic_field_ プレフィックスを追加（まだない場合）
                const finalFieldName = fieldName.startsWith('dynamic_field_') ? fieldName : `dynamic_field_${fieldName}`;
                dynamicFields[finalFieldName] = fieldValue;
            }
        });

        console.log('Saving step:', stepKey, dynamicFields);

        // サーバーに保存（AJAX）
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: $.extend({
                csrfmiddlewaretoken: '{{ csrf_token }}',
                ajax_save: 'true'  // AJAX保存フラグ
            }, dynamicFields),
            success: function(response) {
                if (typeof toastr !== 'undefined') {
                    toastr.success(`${stepKey}ステップを保存しました`);
                } else {
                    alert(`${stepKey}ステップを保存しました`);
                }
                // 進捗状況を更新
                updateProgressTimeline();
                updateProgressStatus();
            },
            error: function(xhr, status, error) {
                console.error('保存エラー:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('保存中にエラーが発生しました');
                } else {
                    alert('保存中にエラーが発生しました');
                }
            }
        });
    });

    // 初期部材費項目を1つ追加
    addMaterialItem();
    addExternalMaterialItem();
    addExternalAdditionalCostItem();

    // 動的費用項目管理
    let costItemCounter = 0;

    // 費用項目を追加する関数
    function addCostItem(item = '', cost = 0) {
        costItemCounter++;
        const itemHtml = `
            <div class="cost-item mb-2" data-item-id="${costItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="cost_items[]" class="form-control"
                               placeholder="費用項目名" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" name="cost_amounts[]" class="form-control cost-item-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-cost-item-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#costItemsSection').append(itemHtml);
        updateCostItemsTotal();
    }

    // 費用項目合計を更新する関数
    function updateCostItemsTotal() {
        let total = 0;
        $('.cost-item-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#costItemsTotal').text(total.toLocaleString());
        calculateInternalCost(); // これが updateCostBreakdown と updateProfitPreview を呼ぶ
    }

    // 費用項目追加ボタンのクリックイベント
    $('#addCostItemBtn').on('click', function() {
        addCostItem();
    });

    // 費用項目削除ボタンのクリックイベント（イベント委譲）
    $(document).on('click', '.remove-cost-item-btn', function() {
        $(this).closest('.cost-item').remove();
        updateCostItemsTotal();
    });

    // 費用項目金額の変更を監視
    $(document).on('input', '.cost-item-input', function() {
        updateCostItemsTotal();
    });

    // 初期費用項目を1つ追加
    addCostItem();

    // 初期表示時に利益率を計算・表示
    updateProfitPreview();

    // 縦型プログレスステップのクリック処理（展開/折りたたみ）
    $(document).on('click', '.progress-step', function(e) {
        // 削除ボタン、編集ボタン、ドラッグハンドル、フォーム要素のクリックは除外
        if ($(e.target).hasClass('remove-step-btn') || $(e.target).closest('.remove-step-btn').length ||
            $(e.target).hasClass('btn') || $(e.target).closest('.btn').length ||
            $(e.target).hasClass('drag-handle') || $(e.target).closest('.drag-handle').length ||
            $(e.target).is('input, select, textarea') || $(e.target).closest('input, select, textarea').length) {
            return;
        }

        const $clickedStep = $(this);
        const isCurrentlyExpanded = $clickedStep.hasClass('expanded');

        // 全てのステップを折りたたみ
        $('.progress-step').removeClass('expanded');
        $('.progress-step-content').hide();

        // クリックされたステップが折りたたまれていた場合、展開
        if (!isCurrentlyExpanded) {
            $clickedStep.addClass('expanded');
            $clickedStep.find('.progress-step-content').show();
        }
    });

    // ドラッグハンドルを最初は非表示
    $('.drag-handle').hide();

    // Sortable機能を初期化（イベントハンドラー設定後）
    initializeSortable();

    // チェックボックスの変更を監視してリアルタイムで進捗バーの色を更新
    $('#workStartCompleted').on('change', function() {
        var step = $('.progress-step[data-step="work_start"]');
        if ($(this).is(':checked')) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate($('input[name="work_start_date"]').val()));

            // 次のステップ（工事終了）をアクティブにする
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('未完了');

            // 工事終了ステップからアクティブを削除（工事終了が完了していない場合）
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.removeClass('active');
            }
        }
        // 進捗状況も更新
        updateProgressTimeline();
        updateProgressStatus();
    });

    $('#workEndCompleted').on('change', function() {
        var step = $('.progress-step[data-step="work_end"]');
        if ($(this).is(':checked')) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate($('input[name="work_end_date"]').val()));

            // 次のステップ（請求書発行）をアクティブにする
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('未完了');

            // 請求書発行ステップからアクティブを削除（請求書が未発行の場合）
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.removeClass('active');
            }
        }
        // 進捗状況も更新
        updateProgressTimeline();
        updateProgressStatus();
    });

    // フォーム値の変更を監視して進捗状況を自動更新
    // 汎用フィールドの変更を監視（動的に追加されるステップも含む）
    // _dateで終わるフィールド（estimate_issued_date, contract_date, dynamic_field_*は除外）
    $(document).on('change', 'input[name$="_date"]:not([name="estimate_issued_date"]):not([name="contract_date"]):not([name^="dynamic_field_"]), input[name$="_completed"]:not([name^="dynamic_field_"]), select[name="invoice_issued"]', function() {
        // データベースに保存（汎用）
        var fieldName = $(this).attr('name');
        var fieldValue;

        if ($(this).is(':checkbox')) {
            fieldValue = $(this).is(':checked');
        } else {
            fieldValue = $(this).val();
        }

        var data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ajax_save: 'true'
        };
        data[fieldName] = fieldValue;

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: data,
            success: function(response) {
                console.log(fieldName + 'を保存しました:', fieldValue);

                // projectDataを更新
                projectData[fieldName] = fieldValue;

                // UI全体を更新
                updateProgressTimeline();
                updateProgressStatus();
            },
            error: function(xhr, status, error) {
                console.error(fieldName + 'の保存に失敗:', error);
            }
        });
    });

    // 見積書発行日の変更を監視
    $(document).on('change', 'input[name="estimate_issued_date"]', function() {
        console.log('=== 見積書発行日の変更イベントが発火しました ===');
        var step = $('.progress-step[data-step="estimate"]');
        var notRequiredChecked = $('#estimateNotRequired').is(':checked');
        var dateValue = $(this).val();

        console.log('ステップ要素が見つかりました:', step.length > 0);
        console.log('見積書不要チェック:', notRequiredChecked);
        console.log('入力された日付:', dateValue);

        // データベースに保存
        console.log('AJAX保存を開始します - URL:', '{% url "order_management:update_progress" project.pk %}');
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: {
                estimate_issued_date: dateValue,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('✓ 見積書発行日の保存に成功しました');
                console.log('レスポンス:', response);
                console.log('保存された日付:', dateValue);

                // projectDataを更新
                projectData.estimate_issued_date = dateValue;
                console.log('projectDataを更新しました:', projectData.estimate_issued_date);

                // UIを更新
                if (dateValue && !notRequiredChecked) {
                    console.log('ステップを完了状態にします');
                    step.addClass('completed');
                    step.removeClass('active');
                    step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(dateValue));
                } else if (!notRequiredChecked) {
                    console.log('ステップを未完了状態にします');
                    step.removeClass('completed');
                    step.find('.progress-step-date').html('<span class="badge bg-secondary">未完了</span>');
                }

                // 進捗状況全体を更新
                console.log('進捗状況を更新します');
                updateProgressTimeline();
                updateProgressStatus();
                updateActiveStep();
            },
            error: function(xhr, status, error) {
                console.error('✗ 見積書発行日の保存に失敗しました');
                console.error('ステータス:', status);
                console.error('エラー:', error);
                console.error('レスポンス:', xhr.responseText);
                console.error('HTTPステータス:', xhr.status);
                alert('保存に失敗しました。もう一度お試しください。\nエラー: ' + error);
            }
        });
    });

    // 見積書不要チェックボックスの処理をグローバル関数として定義
    window.handleEstimateNotRequiredChange = function() {
        var isChecked = $('#estimateNotRequired').is(':checked');
        console.log('見積書不要チェックボックスが変更されました:', isChecked);
        var step = $('.progress-step[data-step="estimate"]');
        var dateInput = $('input[name="estimate_issued_date"]');

        // データベースに保存
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: {
                estimate_not_required: isChecked ? 'on' : '',
                estimate_issued_date: isChecked ? '' : dateInput.val(),
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('見積書不要フラグを保存しました:', isChecked);

                // projectDataを更新
                projectData.estimate_not_required = isChecked;
                if (isChecked) {
                    projectData.estimate_issued_date = null;
                }

                // UIを更新
                if (isChecked) {
                    // 見積書不要にチェックした場合
                    step.addClass('completed');
                    step.removeClass('active');
                    step.find('.progress-step-date').html('<i class="fas fa-times-circle me-1"></i>見積不要');
                    dateInput.prop('disabled', true).val('');
                } else {
                    // 見積書不要のチェックを外した場合
                    dateInput.prop('disabled', false);
                    if (!dateInput.val()) {
                        step.removeClass('completed');
                        step.find('.progress-step-date').html('<span class="badge bg-secondary">未完了</span>');
                    } else {
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>' + formatDate(dateInput.val()));
                    }
                }

                // 進捗状況全体を更新
                updateActiveStep();
                updateProgressTimeline();
                updateProgressStatus();
            },
            error: function(xhr, status, error) {
                console.error('見積書不要フラグの保存に失敗:', error);
                alert('保存に失敗しました。もう一度お試しください。');
            }
        });
    };

    // チェックボックスにイベントリスナーを設定
    $('#estimateNotRequired').off().on('change', window.handleEstimateNotRequiredChange);
    $(document).off('change', '#estimateNotRequired').on('change', '#estimateNotRequired', window.handleEstimateNotRequiredChange);

    // 見積書不要チェックボックスの初期状態確認
    console.log('見積書不要チェックボックスの要素数:', $('#estimateNotRequired').length);
    console.log('見積書不要チェックボックスの初期状態:', $('#estimateNotRequired').is(':checked'));

    // 初期状態で表示を正しく設定
    window.handleEstimateNotRequiredChange();

    // 契約日の変更を監視
    $(document).on('change', 'input[name="contract_date"]', function() {
        var step = $('.progress-step[data-step="contract"]');
        var dateValue = $(this).val();

        // データベースに保存
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: {
                contract_date: dateValue,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('契約日を保存しました:', dateValue);

                // projectDataを更新
                projectData.contract_date = dateValue;

                // UIを更新
                if (dateValue) {
                    step.addClass('completed');
                    step.removeClass('active');
                    step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(dateValue));

                    // 次のステップ（工事開始）をアクティブにする
                    var nextStep = $('.progress-step[data-step="work_start"]');
                    if (!nextStep.hasClass('completed')) {
                        nextStep.addClass('active');
                    }
                } else {
                    step.removeClass('completed');
                    step.find('.progress-step-date').html('<span class="badge bg-secondary">未完了</span>');
                }

                // 進捗状況全体を更新
                updateProgressTimeline();
                updateProgressStatus();
                updateActiveStep();
            },
            error: function(xhr, status, error) {
                console.error('契約日の保存に失敗:', error);
                alert('保存に失敗しました。もう一度お試しください。');
            }
        });
    });

    // 請求書発行の変更を監視
    $(document).on('change', 'input[name="invoice_issued"], select[name="invoice_issued"]', function() {
        var step = $('.progress-step[data-step="invoice"]');
        if ($(this).val() === 'true') {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>発行済み');
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('未発行');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // 工事開始日の変更を監視
    $(document).on('change', 'input[name="work_start_date"]', function() {
        var step = $('.progress-step[data-step="work_start"]');
        var isCompleted = $('input[name="work_start_completed"]').is(':checked');
        var dateValue = $(this).val();

        if (isCompleted && dateValue) {
            // チェックボックスがオンで日付もあれば完了
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(dateValue));
        } else if (dateValue) {
            // 日付のみの場合は予定として表示
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>予定: ' + formatDate(dateValue));
        } else {
            // 日付がない場合は未完了
            step.removeClass('completed');
            step.find('.progress-step-date').html('未完了');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // 工事開始完了チェックボックスの変更を監視
    $(document).on('change', 'input[name="work_start_completed"]', function() {
        var step = $('.progress-step[data-step="work_start"]');
        var workStartDate = $('input[name="work_start_date"]').val();

        if ($(this).is(':checked')) {
            // チェックボックスがオンの場合
            step.addClass('completed');
            if (workStartDate) {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(workStartDate));
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了');
            }

            // 次のステップ（工事終了）をアクティブにする
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            // チェックボックスがオフの場合
            step.removeClass('completed');
            if (workStartDate) {
                // 日付がある場合は予定として表示
                step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>予定: ' + formatDate(workStartDate));
            } else {
                step.find('.progress-step-date').html('未完了');
            }
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // 工事終了日の変更を監視
    $(document).on('change', 'input[name="work_end_date"]', function() {
        var step = $('.progress-step[data-step="work_end"]');
        var isCompleted = $('input[name="work_end_completed"]').is(':checked');
        var dateValue = $(this).val();

        if (isCompleted && dateValue) {
            // チェックボックスがオンで日付もあれば完了
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(dateValue));
        } else if (dateValue) {
            // 日付のみの場合は予定として表示
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>予定: ' + formatDate(dateValue));
        } else {
            // 日付がない場合は未完了
            step.removeClass('completed');
            step.find('.progress-step-date').html('未完了');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // 工事終了完了チェックボックスの変更を監視
    $(document).on('change', 'input[name="work_end_completed"]', function() {
        var step = $('.progress-step[data-step="work_end"]');
        var workEndDate = $('input[name="work_end_date"]').val();

        if ($(this).is(':checked')) {
            // チェックボックスがオンの場合
            step.addClass('completed');
            if (workEndDate) {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(workEndDate));
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了');
            }

            // 次のステップ（請求書発行）をアクティブにする
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            // チェックボックスがオフの場合
            step.removeClass('completed');
            if (workEndDate) {
                // 日付がある場合は予定として表示
                step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>予定: ' + formatDate(workEndDate));
            } else {
                step.find('.progress-step-date').html('未完了');
            }
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // === 動的ステップ管理機能 ===

    // 動的ステップの状態変更を監視して即座に保存
    $(document).on('change', 'input[name$="_date"], input[name$="_completed"], input[name$="_value"]', function() {
        const inputName = $(this).attr('name');
        const stepName = inputName.replace(/_date$|_completed$|_value$/, '');
        const step = $('.progress-step[data-step="' + stepName + '"]');

        if (!step.length) return;

        // ステップの表示状態を更新
        updateStepStatus(step, $(this));
    });

    // 複合ステップのフィールド変更を監視
    $(document).on('change', 'input[name^="dynamic_field_"], select[name^="dynamic_field_"], textarea[name^="dynamic_field_"]', function() {
        const fieldName = $(this).attr('name');
        // dynamic_field_attendance_scheduled_date -> attendance
        const stepKey = fieldName.replace(/^dynamic_field_/, '').split('_')[0];
        const $step = $(`.progress-step[data-step="${stepKey}"]`);

        // データベースに保存（複合ステップフィールド）
        const fieldValue = $(this).is(':checkbox') ? $(this).is(':checked') : $(this).val();
        const data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ajax_save: 'true'
        };
        data[fieldName] = fieldValue;

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: data,
            success: function(response) {
                console.log('複合ステップフィールドを保存しました:', fieldName, fieldValue);

                // 保存成功後にUIを更新
                if ($step.length > 0) {
                    // availableStepsから該当するステップ定義を取得
                    const stepData = availableSteps.find(s => s.key === stepKey);

                    if (stepData && stepData.type === 'complex') {
                        // 複合ステップのステータスを再計算
                        const status = getComplexStepStatus(stepData, $step);

                        // ステータスに応じてクラスを追加/削除
                        if (status.completed) {
                            $step.addClass('completed');
                            $step.removeClass('active');
                        } else {
                            $step.removeClass('completed');
                        }

                        // ステータステキストを更新
                        $step.find('.progress-step-date').html(status.statusText);

                        // 進捗タイムラインと状況バーを更新
                        updateProgressTimeline();
                        updateProgressStatus();

                        console.log(`Updated complex step ${stepKey}:`, status);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('複合ステップフィールドの保存に失敗:', fieldName, error);
            }
        });
    });

    // ステップ状態の更新
    function updateStepStatus(step, input) {
        const inputName = input.attr('name');
        const value = input.val();
        const isChecked = input.is(':checked');
        const stepKey = step.data('step');

        // 右側の表示更新
        if (inputName.includes('actual_date') && value) {
            // 実施日の場合は「完了」
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(value));
        } else if (inputName.includes('issued_date') && value) {
            // 発行日の場合も「完了」
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(value));
        } else if (inputName.includes('scheduled_date') && value) {
            // 予定日の場合は「予定」
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>予定: ' + formatDate(value));
        } else if (inputName.endsWith('_completed') && isChecked) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了');
        } else if (inputName.endsWith('_value') && value) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + value);
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('未完了');
        }

        // 進捗タイムラインも更新
        updateProgressTimeline();
        // 進捗状況バーも更新
        updateProgressStatus();
    }


    // 日付フォーマット関数
    function formatDate(dateString) {
        if (!dateString || dateString === 'undefined' || dateString === undefined) return '日付未設定';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '日付未設定';
            // 日本語形式で月/日を表示
            return date.toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
        } catch (e) {
            return '日付未設定';
        }
    }

    // 進捗タイムラインを更新する関数
    function updateProgressTimeline() {
        const timeline = $('#progressTimeline');
        timeline.empty();

        // 右側のステップから直接情報を取得
        const currentSteps = [];

        // activeSteps内の全ステップをスキャンして左側に表示
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');
            const isCompleted = $step.hasClass('completed');

            // ステップ名を取得（アイコンを除去）
            const stepNameElement = $step.find('.progress-step-header span');
            let stepName = stepNameElement.text().trim();
            // アイコン部分を除去してステップ名のみ取得
            stepName = stepName.replace(/^\s*.*?\s+/, '').trim();

            // ステータステキストを取得
            const statusElement = $step.find('.progress-step-date');
            let statusText = null;
            if (statusElement.length > 0) {
                const statusContent = statusElement.text().trim();
                if (statusContent && statusContent !== '未完了' && statusContent !== '未設定') {
                    // 完了、予定、開始のプレフィックスを保持したまま取得
                    statusText = statusContent;
                }
            }

            currentSteps.push({
                key: stepKey,
                name: stepName,
                completed: isCompleted,
                statusText: statusText
            });
        });

        // 以下コメントアウト - 右側から直接読み取るため不要
        /*
        // 基本ステップを追加（現在のフォーム値を使用）
        const basicSteps = [
        */

        // タイムラインを構築
        let previousCompleted = true;
        currentSteps.forEach(step => {
            // ステップ名が有効かチェック
            if (!step.name || step.name === 'undefined' || step.name === undefined) {
                console.warn('Skipping timeline item with invalid name:', step);
                return;
            }

            // ステップの状態を判定
            let statusClass = '';
            const stepElement = $(`.progress-step[data-step="${step.key}"]`);

            if (stepElement.length > 0) {
                // 複合ステップの場合、フィールド値を確認
                const scheduledDate = stepElement.find(`input[name*="scheduled_date"]`).val();
                const actualDate = stepElement.find(`input[name*="actual_date"]`).val();
                const completedCheckbox = stepElement.find(`input[name*="completed"]`).is(':checked');
                const issuedDate = stepElement.find(`input[name*="issued_date"]`).val();
                const notRequired = stepElement.find(`input[name*="not_required"]`).is(':checked');

                // 状態の優先順位: verified > completed > scheduled > デフォルト
                if (completedCheckbox) {
                    // 完了チェックボックスにチェックあり → 濃い緑
                    statusClass = 'verified';
                } else if (actualDate || issuedDate || notRequired) {
                    // 完了日または発行日が入力されている → 緑
                    statusClass = 'completed';
                } else if (scheduledDate) {
                    // 予定日のみ入力されている → 黄色
                    statusClass = 'scheduled';
                } else if (step.completed) {
                    // 右側で completed クラスがついている → 緑
                    statusClass = 'completed';
                }
                // それ以外（何も入力なし） → グレー（クラスなし）
            } else {
                // 要素が見つからない場合は従来のロジック
                const isCompleted = step.completed;
                if (isCompleted) {
                    statusClass = 'completed';
                }
            }

            // ステータステキストの色を決定（予定は黄色、完了は緑）
            let statusColor = 'text-success';
            if (step.statusText && step.statusText.includes('予定:')) {
                statusColor = 'text-warning';
            }
            const statusHtml = step.statusText ?
                `<small class="${statusColor} d-block">${step.statusText}</small>` : '';

            timeline.append(`
                <div class="timeline-item ${statusClass}">
                    <strong>${step.name}</strong>
                    ${statusHtml}
                </div>
            `);

            if (statusClass === 'completed' || statusClass === 'verified') {
                previousCompleted = true;
            } else {
                previousCompleted = false;
            }
        });
    }

    // アクティブステップを更新する関数（最初の未完了ステップのみをアクティブにする）
    function updateActiveStep() {
        // すべてのステップからactiveクラスを削除
        $('#activeSteps .progress-step').removeClass('active');

        // 最初の未完了ステップを見つけてactiveクラスを付与
        let foundFirstIncomplete = false;
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            if (!foundFirstIncomplete && !$step.hasClass('completed')) {
                $step.addClass('active');
                foundFirstIncomplete = true;
            }
        });
    }

    // 進捗状況バーとフェーズを更新する関数
    function updateProgressStatus() {
        // 右側のステップから直接完了状況を取得
        const allSteps = [];

        // activeSteps内の全ステップをスキャン
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            const isCompleted = $step.hasClass('completed');
            allSteps.push({ completed: isCompleted });
        });

        // 完了率計算
        const completedSteps = allSteps.filter(step => step.completed).length;
        const totalSteps = allSteps.length;
        const percentage = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

        // フェーズ判定（get_current_project_stage()と同じロジック）
        let phase = '未開始';
        let color = 'secondary';

        // 完工日をチェック
        const completionElement = $('.progress-step[data-step="completion"]');
        const completionCompleted = completionElement.find('input[name*="completed"]').is(':checked');
        const completionActualDate = completionElement.find('input[name*="actual_date"]').val();
        const workEndDate = $('input[name="work_end_date"]').val();

        if (completionCompleted || $('#workEndCompleted').is(':checked')) {
            phase = '完工';
            color = 'verified';
        } else if (completionActualDate || workEndDate) {
            phase = '完工';
            color = 'success';
        }
        // 着工日をチェック
        else {
            const constructionElement = $('.progress-step[data-step="construction_start"]');
            const constructionCompleted = $('#workStartCompleted').is(':checked');
            const constructionActualDate = constructionElement.find('input[name*="actual_date"]').val();
            const constructionScheduledDate = constructionElement.find('input[name*="scheduled_date"]').val() || $('input[name="work_start_date"]').val();

            if (constructionCompleted) {
                phase = '工事中';
                color = 'verified';
            } else if (constructionActualDate) {
                phase = '工事中';
                color = 'success';
            } else if (constructionScheduledDate) {
                phase = '着工日待ち';
                color = 'warning';
            }
            // 見積もりをチェック
            else {
                const estimateIssuedDate = $('input[name="estimate_issued_date"]').val();
                const estimateNotRequired = $('#estimateNotRequired').is(':checked');

                if (estimateIssuedDate) {
                    phase = '見積もり審査中';
                    color = 'warning';
                } else {
                    // 見積書発行日がない場合のみ、前の工程をチェック
                    // 現調をチェック
                    const surveyElement = $('.progress-step[data-step="survey"]');
                    const surveyActualDate = surveyElement.find('input[name*="actual_date"]').val();
                    const surveyScheduledDate = surveyElement.find('input[name*="scheduled_date"]').val();
                    if (surveyActualDate) {
                        phase = '現調済み';
                        color = 'success';
                    } else if (surveyScheduledDate) {
                        phase = '現調待ち';
                        color = 'warning';
                    } else {
                        // 立ち会いをチェック
                        const attendanceElement = $('.progress-step[data-step="attendance"]');
                        const attendanceActualDate = attendanceElement.find('input[name*="actual_date"]').val();
                        const attendanceScheduledDate = attendanceElement.find('input[name*="scheduled_date"]').val();

                        if (attendanceActualDate) {
                            phase = '立ち会い済み';
                            color = 'success';
                        } else if (attendanceScheduledDate) {
                            phase = '立ち会い待ち';
                            color = 'warning';
                        } else {
                            phase = '未開始';
                            color = 'secondary';
                        }
                    }
                }
            }
        }

        // UI更新
        $('#progressPhase').text(phase).removeClass().addClass(`text-${color}`);
        $('#progressBar').removeClass().addClass(`progress-bar bg-${color}`).css('width', `${percentage}%`).attr('aria-valuenow', percentage);
        $('#progressPercentage').text(`${completedSteps}/${totalSteps}`);
        $('#progressStatusCard').removeClass().addClass(`card progress-status-card border-${color}`);
        $('#progressStatusHeader').removeClass().addClass(`card-header bg-${color} text-white`);

        // データベースに進捗状況を保存
        saveProjectStage(phase, color);
    }

    // 進捗状況をサーバーに保存（デバウンス付き）
    var saveStageTimeout;
    function saveProjectStage(stage, color) {
        // デバウンス：連続した呼び出しを500ms遅延
        clearTimeout(saveStageTimeout);
        saveStageTimeout = setTimeout(function() {
            $.ajax({
                url: '{% url "order_management:update_project_stage" project.pk %}',
                method: 'POST',
                data: {
                    stage: stage,
                    color: color,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('進捗状況を保存しました:', stage);
                },
                error: function(xhr, status, error) {
                    console.error('進捗状況の保存に失敗:', error);
                }
            });
        }, 500);
    }

    // フォームフィールドと ステップ状態を同期
    function syncFormFieldsToSteps() {
        console.log('Syncing form fields to steps');

        // 基本ステップのフォームフィールドをチェック
        const fieldsToCheck = [
            { field: 'estimate_issued_date', step: 'estimate' },
            { field: 'contract_date', step: 'contract' },
            { field: 'work_start_date', step: 'work_start' },
            { field: 'work_end_date', step: 'work_end' }
        ];

        fieldsToCheck.forEach(({ field, step }) => {
            const input = $(`input[name="${field}"]`);
            const stepElement = $(`.progress-step[data-step="${step}"]`);

            if (input.length && stepElement.length) {
                // フォームフィールドの値を読み取ってステップ状態を更新
                const inputValue = input.val();
                console.log(`Syncing ${field}: ${inputValue}`);

                if (inputValue) {
                    // 工事開始・工事完了は特別処理
                    if (step === 'work_start' || step === 'work_end') {
                        const completedCheckbox = $(`input[name="${step}_completed"]`);
                        const isCompleted = completedCheckbox.is(':checked');

                        if (isCompleted) {
                            stepElement.addClass('completed');
                            stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(inputValue));
                        } else {
                            stepElement.removeClass('completed');
                            stepElement.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>予定: ' + formatDate(inputValue));
                        }
                    } else {
                        updateStepStatus(stepElement, input);
                    }
                } else if (step === 'work_start' || step === 'work_end') {
                    // 日付がないが、チェックボックスがある場合の処理
                    const completedCheckbox = $(`input[name="${step}_completed"]`);
                    const isCompleted = completedCheckbox.is(':checked');

                    if (isCompleted) {
                        stepElement.addClass('completed');
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了');
                    } else {
                        stepElement.removeClass('completed');
                        stepElement.find('.progress-step-date').html('未完了');
                    }
                }
            }
        });

        // チェックボックスフィールドもチェック
        const checkboxFields = [
            { field: 'estimate_not_required', step: 'estimate' },
            { field: 'work_start_completed', step: 'work_start' },
            { field: 'work_end_completed', step: 'work_end' },
            { field: 'invoice_issued', step: 'invoice' }
        ];

        checkboxFields.forEach(({ field, step }) => {
            const input = $(`input[name="${field}"]`);
            const stepElement = $(`.progress-step[data-step="${step}"]`);

            if (input.length && stepElement.length && input.is(':checked')) {
                console.log(`Syncing checkbox ${field}: checked`);

                // 見積書不要・工事開始・工事完了は特別処理
                if (step === 'estimate' && field === 'estimate_not_required') {
                    stepElement.addClass('completed');
                    stepElement.find('.progress-step-date').html('<i class="fas fa-times-circle me-1"></i>見積不要');
                } else if (step === 'work_start' || step === 'work_end') {
                    const dateInput = $(`input[name="${step}_date"]`);
                    const dateValue = dateInput.val();

                    stepElement.addClass('completed');
                    if (dateValue) {
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了: ' + formatDate(dateValue));
                    } else {
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>完了');
                    }
                } else {
                    updateStepStatus(stepElement, input);
                }
            }
        });

        // 複合ステップフィールドの値を設定
        if (complexStepFields && typeof complexStepFields === 'object') {
            console.log('Setting complex step field values:', complexStepFields);
            Object.keys(complexStepFields).forEach(fieldName => {
                const fieldValue = complexStepFields[fieldName];
                // dynamic_field_ プレフィックスを追加してフィールドを検索
                const fieldElement = $(`[name="dynamic_field_${fieldName}"]`);

                if (fieldElement.length > 0) {
                    if (fieldElement.is(':checkbox') || fieldElement.is(':radio')) {
                        if (fieldValue === 'true' || fieldValue === fieldElement.val()) {
                            fieldElement.prop('checked', true);
                        }
                    } else {
                        fieldElement.val(fieldValue);
                    }
                    console.log(`Set field dynamic_field_${fieldName} to ${fieldValue}`);
                }
            });

            // 依存フィールドの表示状態を更新
            $('input[type="radio"]:checked').trigger('change');

            // 各複合ステップのステータスを更新
            $('.progress-step[data-step]').each(function() {
                const $step = $(this);
                const stepKey = $step.data('step');

                // availableStepsから該当するステップ定義を取得
                const stepData = availableSteps.find(s => s.key === stepKey);

                if (stepData && stepData.type === 'complex') {
                    // 複合ステップのステータスを計算
                    const status = getComplexStepStatus(stepData, $step);

                    // ステータスに応じてクラスを追加
                    if (status.completed) {
                        $step.addClass('completed');
                    } else {
                        $step.removeClass('completed');
                    }

                    // ステータステキストを更新
                    $step.find('.progress-step-date').html(status.statusText);

                    console.log(`Updated status for ${stepKey}:`, status);
                }
            });
        }

        console.log('Form field sync complete');
    }

    // フォーム送信前にステップ順序とダイナミックフィールドを保存
    $('form').on('submit', function(e) {
        console.log('=== フォーム送信開始 ===');
        saveStepOrder();
        collectDynamicFieldData();

        // デバッグ: 送信されるデータを確認
        const formData = $(this).serializeArray();
        const dynamicFields = formData.filter(item => item.name.startsWith('dynamic_field_'));
        console.log('送信される dynamic_field_ の数:', dynamicFields.length);
        console.log('dynamic_field_ データ:', dynamicFields);

        // 確認のため一時停止（本番では削除してください）
        // e.preventDefault();
        // alert(`${dynamicFields.length} 個のdynamic_field_を送信します。コンソールを確認してください。`);
    });

    // 複合ステップのフィールドデータを収集してフォームに追加
    function collectDynamicFieldData() {
        console.log('Collecting dynamic field data...');

        // まず値を収集（削除する前に）
        const collectedData = [];

        // 各複合ステップのフィールド値を収集
        $('.progress-step[data-step]').each(function() {
            const stepKey = $(this).data('step');
            const stepElement = $(this);

            // 複合ステップのフィールドを探す
            stepElement.find('input, select, textarea').each(function() {
                const fieldElement = $(this);
                const fieldName = fieldElement.attr('name');

                // フィールド名がない場合はスキップ
                if (!fieldName) return;

                // dynamic_field_で始まるフィールドのみ処理
                if (!fieldName.startsWith('dynamic_field_')) return;

                let fieldValue;

                // チェックボックスとラジオボタンの場合
                if (fieldElement.is(':checkbox')) {
                    fieldValue = fieldElement.is(':checked') ? 'true' : 'false';
                } else if (fieldElement.is(':radio')) {
                    // ラジオボタンは選択されている場合のみ処理
                    if (!fieldElement.is(':checked')) return;
                    fieldValue = fieldElement.val();
                } else if (fieldElement.is('select[multiple]')) {
                    // 複数選択の場合
                    const selectedValues = fieldElement.val();
                    if (selectedValues && selectedValues.length > 0) {
                        fieldValue = selectedValues.join(',');
                    } else {
                        fieldValue = '';
                    }
                } else {
                    fieldValue = fieldElement.val();
                }

                // 値を収集（空でも収集してNoneとして送信）
                collectedData.push({
                    name: fieldName,
                    value: fieldValue || ''
                });

                console.log(`Collected: ${fieldName} = ${fieldValue}`);
            });
        });

        // 既存の隠しフィールドを削除（type=hiddenのみ）
        $('input[type="hidden"][name^="dynamic_field_"]').remove();

        // 収集したデータから隠しフィールドを作成
        collectedData.forEach(item => {
            const hiddenField = $('<input>', {
                type: 'hidden',
                name: item.name,
                value: item.value
            });
            $('form').append(hiddenField);
            console.log(`Added hidden field: ${item.name} = ${item.value}`);
        });

        console.log(`Dynamic field data collection complete. Collected ${collectedData.length} fields.`);
    }

    // サーバーからのデータを取得
    const orderedSteps = {{ ordered_steps_json|safe }};
    const dynamicSteps = {{ dynamic_steps_json|safe }};
    const complexStepFields = {{ complex_step_fields_json|safe }};

    console.log('=== Debug Info ===');
    console.log('orderedSteps:', orderedSteps);
    console.log('orderedSteps type:', typeof orderedSteps);
    console.log('orderedSteps length:', orderedSteps ? orderedSteps.length : 'null/undefined');
    if (orderedSteps && orderedSteps.length > 0) {
        orderedSteps.forEach((step, index) => {
            console.log(`orderedStep[${index}]:`, step);
            console.log(`  key: ${step.key} (type: ${typeof step.key})`);
            console.log(`  name: ${step.name} (type: ${typeof step.name})`);
        });
    }
    console.log('dynamicSteps:', dynamicSteps);
    const projectData = {
        estimate_issued_date: '{{ project.estimate_issued_date|date:"Y-m-d"|default:"" }}' || '',
        estimate_not_required: {% if project.estimate_not_required %}true{% else %}false{% endif %},
        contract_date: '{{ project.contract_date|date:"Y-m-d"|default:"" }}' || '',
        work_start_date: '{{ project.work_start_date|date:"Y-m-d"|default:"" }}' || '',
        work_start_completed: {% if project.work_start_completed %}true{% else %}false{% endif %},
        work_end_date: '{{ project.work_end_date|date:"Y-m-d"|default:"" }}' || '',
        work_end_completed: {% if project.work_end_completed %}true{% else %}false{% endif %},
        invoice_issued: {% if project.invoice_issued %}true{% else %}false{% endif %}
    };

    // ステップの初期化
    function initializeSteps() {
        console.log('initializeSteps called');
        const container = $('#activeSteps');
        container.empty();

        try {
            // orderedStepsがある場合はそれを使用、なければ基本ステップ
            if (orderedSteps && orderedSteps.length > 0) {
                console.log('Using ordered steps:', orderedSteps.length);
                orderedSteps.forEach((step, index) => {
                    const stepHtml = generateStepHtml(step);
                    if (stepHtml) {
                        container.append(stepHtml);
                    }
                });
            } else {
                console.log('Using default basic steps');
                // 基本ステップを直接生成
                container.append(generateEstimateStepHtml());

                // 現地調査ステップは survey_required が true の場合のみ追加
                {% if project.survey_required %}
                    container.append(generateSurveyStepHtml());
                {% endif %}

                container.append(generateContractStepHtml());
                container.append(generateWorkStartStepHtml());
                container.append(generateWorkEndStepHtml());
                container.append(generateInvoiceStepHtml());
            }

            // アクティブステップを正しく設定（最初の未完了ステップのみ）
            updateActiveStep();

            // 進捗タイムラインも更新（DOM要素が準備されてから）
            setTimeout(() => {
                updateProgressTimeline();
                updateProgressStatus();

                // 現地調査エリアの表示制御
                updateSurveyAreaVisibility();

                // 初期状態では何も展開しない（クリック時のみ展開）
            }, 50);

            console.log('Steps initialized:', container.children().length);
        } catch (error) {
            console.error('Error in initializeSteps:', error);
            // エラー時は基本ステップを強制表示
            container.append(generateEstimateStepHtml());

            // 現地調査ステップは survey_required が true の場合のみ追加
            {% if project.survey_required %}
                container.append(generateSurveyStepHtml());
            {% endif %}

            container.append(generateContractStepHtml());
            container.append(generateWorkStartStepHtml());
            container.append(generateWorkEndStepHtml());
            container.append(generateInvoiceStepHtml());
        }
    }

    // 現地調査エリアの表示制御
    function updateSurveyAreaVisibility() {
        const surveyStep = $('.progress-step[data-step="survey"]');
        const surveyArea = $('#surveyContentArea');

        console.log('Survey step found:', surveyStep.length);
        console.log('Survey area element:', surveyArea.length);

        // survey_required フラグに基づいて表示制御
        {% if project.survey_required %}
            surveyArea.show();
            console.log('Survey area shown (survey_required=true)');
        {% else %}
            surveyArea.hide();
            console.log('Survey area hidden (survey_required=false)');
        {% endif %}
    }

    // ステップHTMLを生成
    function generateStepHtml(step) {
        // 基本ステップかどうかをチェック
        const basicSteps = ['estimate', 'survey', 'contract', 'work_start', 'work_end', 'invoice'];
        const isBasicStep = basicSteps.includes(step.key);

        if (isBasicStep) {
            return generateStaticStepHtml(step);
        } else {
            // 利用可能なステップから定義を取得
            const stepDefinition = availableSteps.find(s => s.key === step.key);
            if (stepDefinition) {
                return generateAvailableStepHtml(stepDefinition);
            } else if (step.is_dynamic) {
                return generateDynamicStepHtml(step);
            } else {
                console.warn(`Unknown step: ${step.key}`);
                return '';
            }
        }
    }

    // 左側表示用のステップHTMLを生成
    function generateLeftDisplayStepHtml(step) {
        if (step.is_dynamic) {
            return generateLeftDisplayDynamicStepHtml(step);
        } else {
            return generateLeftDisplayStaticStepHtml(step);
        }
    }

    // 左側表示用 - 静的ステップ
    function generateLeftDisplayStaticStepHtml(step) {
        let stepName, stepIcon, isCompleted, statusHtml;

        switch (step.key) {
            case 'estimate':
                stepName = '見積作成';
                stepIcon = 'fas fa-file-invoice';
                isCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;
                if (projectData.estimate_not_required) {
                    statusHtml = '<i class="fas fa-times-circle me-1"></i>見積不要';
                } else if (projectData.estimate_issued_date) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>完了: ${formatDate(projectData.estimate_issued_date)}`;
                } else {
                    statusHtml = '未完了';
                }
                break;
            case 'contract':
                stepName = '契約';
                stepIcon = 'fas fa-handshake';
                isCompleted = projectData.contract_date;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>完了: ${formatDate(projectData.contract_date)}`;
                } else {
                    statusHtml = '未完了';
                }
                break;
            case 'work_start':
                stepName = '工事開始';
                stepIcon = 'fas fa-play-circle';
                isCompleted = projectData.work_start_completed;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>完了: ${formatDate(projectData.work_start_date)}`;
                } else if (projectData.work_start_date) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>予定: ${formatDate(projectData.work_start_date)}`;
                } else {
                    statusHtml = '未完了';
                }
                break;
            case 'work_end':
                stepName = '工事完了';
                stepIcon = 'fas fa-check-circle';
                isCompleted = projectData.work_end_completed;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>完了: ${formatDate(projectData.work_end_date)}`;
                } else if (projectData.work_end_date) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>予定: ${formatDate(projectData.work_end_date)}`;
                } else {
                    statusHtml = '未完了';
                }
                break;
            case 'invoice':
                stepName = '請求書発行';
                stepIcon = 'fas fa-file-invoice-dollar';
                isCompleted = projectData.invoice_issued;
                statusHtml = isCompleted ? '<i class="fas fa-check-circle me-1"></i>発行済み' : '未発行';
                break;
            default:
                return '';
        }

        const completedClass = isCompleted ? 'completed' : '';

        return `
            <div class="progress-step ${completedClass}" data-step="${step.key}">
                <div class="progress-step-header">
                    <i class="${stepIcon} me-2"></i>${stepName}
                </div>
                <div class="progress-step-date">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // 左側表示用 - 動的ステップ
    function generateLeftDisplayDynamicStepHtml(step) {
        const stepData = step.data || {};
        const stepKey = step.key;
        let stepName = stepKey;
        let stepIcon = 'fas fa-circle';

        // ステップ名とアイコンの設定
        switch (stepKey) {
            case 'survey':
                stepName = '現場調査';
                stepIcon = 'fas fa-search-location';
                break;
            case 'material_order':
                stepName = '部材発注';
                stepIcon = 'fas fa-shopping-cart';
                break;
            case 'delivery':
                stepName = '納品';
                stepIcon = 'fas fa-truck';
                break;
            case 'inspection':
                stepName = '検査';
                stepIcon = 'fas fa-clipboard-check';
                break;
            case 'handover':
                stepName = '引き渡し';
                stepIcon = 'fas fa-key';
                break;
            case 'maintenance':
                stepName = 'メンテナンス';
                stepIcon = 'fas fa-tools';
                break;
            case 'warranty':
                stepName = '保証対応';
                stepIcon = 'fas fa-shield-alt';
                break;
            case 'final_report':
                stepName = '最終報告';
                stepIcon = 'fas fa-file-alt';
                break;
            case 'customer_satisfaction':
                stepName = '顧客満足度調査';
                stepIcon = 'fas fa-star';
                break;
            case 'payment_confirmation':
                stepName = '入金確認';
                stepIcon = 'fas fa-money-check-alt';
                break;
            case 'project_closure':
                stepName = 'プロジェクト完了';
                stepIcon = 'fas fa-certificate';
                break;
            default:
                stepName = stepData.name || stepKey;
                break;
        }

        const isCompleted = stepData.completed || stepData.date || stepData.value;
        let statusHtml = '未完了';

        if (stepData.type === 'date' && stepData.date) {
            statusHtml = `<i class="fas fa-check-circle me-1"></i>完了: ${formatDate(stepData.date)}`;
        } else if (stepData.type === 'checkbox' && stepData.completed) {
            statusHtml = '<i class="fas fa-check-circle me-1"></i>完了済み';
        } else if (stepData.type === 'text' && stepData.value) {
            statusHtml = `<i class="fas fa-check-circle me-1"></i>${stepData.value}`;
        }

        const completedClass = isCompleted ? 'completed' : '';

        return `
            <div class="progress-step ${completedClass}" data-step="${stepKey}">
                <div class="progress-step-header">
                    <i class="${stepIcon} me-2"></i>${stepName}
                </div>
                <div class="progress-step-date">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // 静的ステップのHTML生成（プロジェクトデータを使用）
    function generateStaticStepHtml(step) {
        switch (step.key) {
            case 'estimate':
                return generateEstimateStepHtml();
            case 'survey':
                return generateSurveyStepHtml();
            case 'contract':
                return generateContractStepHtml();
            case 'work_start':
                return generateWorkStartStepHtml();
            case 'work_end':
                return generateWorkEndStepHtml();
            case 'invoice':
                return generateInvoiceStepHtml();
            default:
                return '';
        }
    }

    // 動的ステップのHTML生成
    function generateDynamicStepHtml(step) {
        const stepData = step.data || {};
        const stepKey = step.key;

        let stepName = stepKey;
        let stepIcon = 'fas fa-circle';

        // ステップ名とアイコンの設定
        switch (stepKey) {
            case 'survey':
                stepName = '現場調査';
                stepIcon = 'fas fa-search';
                break;
            case 'permit_application':
                stepName = '許可申請';
                stepIcon = 'fas fa-file-signature';
                break;
            case 'material_order':
                stepName = '材料発注';
                stepIcon = 'fas fa-boxes';
                break;
            case 'safety_training':
                stepName = '安全講習';
                stepIcon = 'fas fa-hard-hat';
                break;
            case 'final_inspection':
                stepName = '完成検査';
                stepIcon = 'fas fa-clipboard-check';
                break;
            case 'handover':
                stepName = '引渡し';
                stepIcon = 'fas fa-key';
                break;
            case 'warranty_issue':
                stepName = '保証書発行';
                stepIcon = 'fas fa-certificate';
                break;
        }

        const isCompleted = stepData.completed || stepData.date || stepData.value;
        let statusHtml = '<div class="progress-step-date">未完了</div>';

        if (stepData.type === 'date' && stepData.date) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>完了: ${formatDate(stepData.date)}</div>`;
        } else if (stepData.type === 'checkbox' && stepData.completed) {
            statusHtml = '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>完了済み</div>';
        } else if (stepData.type === 'text' && stepData.value) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>${stepData.value}</div>`;
        }

        let fieldHtml = '';
        if (stepData.type === 'date') {
            fieldHtml = `
                <label class="form-label">${stepName}日</label>
                <input type="date" name="${stepKey}_date" class="form-control" value="${stepData.date || ''}">
            `;
        } else if (stepData.type === 'checkbox') {
            fieldHtml = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="${stepKey}_completed"
                           id="${stepKey}Completed" ${stepData.completed ? 'checked' : ''}>
                    <label class="form-check-label" for="${stepKey}Completed">
                        <i class="fas fa-check me-1"></i>${stepName}完了
                    </label>
                </div>
            `;
        } else {
            fieldHtml = `
                <label class="form-label">${stepName}</label>
                <input type="text" name="${stepKey}_value" class="form-control" value="${stepData.value || ''}">
            `;
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="${stepKey}">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ドラッグして並び替え"></i>
                        <span><i class="${stepIcon} me-2"></i>${stepName}</span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="${stepKey}" title="ステップを削除">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    ${fieldHtml}
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-sm save-step-btn" data-step="${stepKey}">
                            <i class="fas fa-save me-1"></i>保存
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // 見積書発行ステップのHTML生成
    function generateEstimateStepHtml() {
        const isCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;
        let statusHtml = '<div class="progress-step-date">未完了</div>';

        if (projectData.estimate_not_required) {
            statusHtml = '<div class="progress-step-date"><i class="fas fa-times-circle me-1"></i>見積不要</div>';
        } else if (projectData.estimate_issued_date) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>完了: ${formatDate(projectData.estimate_issued_date)}</div>`;
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="estimate">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ドラッグして並び替え"></i>
                        <span><i class="fas fa-file-invoice me-2"></i>見積書発行</span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="estimate" title="ステップを削除">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <label class="form-label">見積書発行日</label>
                        <input type="date" name="estimate_issued_date" class="form-control"
                               value="${projectData.estimate_issued_date || ''}" ${projectData.estimate_not_required ? 'disabled' : ''}>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="estimate_not_required"
                               id="estimateNotRequired" ${projectData.estimate_not_required ? 'checked' : ''}>
                        <label class="form-check-label" for="estimateNotRequired">
                            <i class="fas fa-times me-1"></i>見積書不要
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // 現地調査ステップのHTML生成
    function generateSurveyStepHtml() {
        // 実際の調査データがあるかチェック（surveys変数がテンプレートから渡されている場合）
        let isCompleted = false;
        let statusHtml = '<div class="progress-step-date">未完了</div>';

        {% if surveys %}
        // 完了した調査があるかチェック
        const completedSurveys = [{% for survey in surveys %}{% if survey.status == 'completed' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        const inProgressSurveys = [{% for survey in surveys %}{% if survey.status == 'in_progress' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        const scheduledSurveys = [{% for survey in surveys %}{% if survey.status == 'scheduled' %}{ id: '{{ survey.id }}', date: '{{ survey.scheduled_date|date:"m/d" }}', time: '{{ survey.scheduled_start_time|time:"H:i" }}' }{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];

        if (completedSurveys.length > 0) {
            isCompleted = true;
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>完了: ${completedSurveys.length}件</div>`;
        } else if (inProgressSurveys.length > 0) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-play me-1"></i>実施中: ${inProgressSurveys.length}件</div>`;
        } else if (scheduledSurveys.length > 0) {
            // 次回予定の調査日時を表示
            const nextSurvey = scheduledSurveys[0];
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>予定: ${scheduledSurveys.length}件 (次回: ${nextSurvey.date} ${nextSurvey.time})</div>`;
        }
        {% endif %}

        const hasEstimateCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;

        return `
            <div class="progress-step ${isCompleted ? 'completed' : hasEstimateCompleted ? 'active' : ''}" data-step="survey">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ドラッグして並び替え"></i>
                        <span><i class="fas fa-clipboard-list me-2"></i>現地調査</span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="survey" title="ステップを削除">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="d-flex gap-2 mb-3">
{#                         <a href="#" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>調査作成
                        </a>
{#                         <a href="#" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-list me-1"></i>調査一覧
                        </a>
                    </div>
                    {% if surveys %}
                    <div class="small">
                        <div class="mb-2"><strong>調査状況:</strong></div>
                        {% for survey in surveys|slice:":3" %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">{{ survey.scheduled_date|date:"m/d" }} {{ survey.scheduled_start_time|time:"H:i" }}</span>
                            <span class="badge {% if survey.status == 'completed' %}bg-success{% elif survey.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %} small">
                                {{ survey.get_status_display }}
                            </span>
                        </div>
                        {% endfor %}
                        {% if surveys|length > 3 %}
                        <div class="text-muted small">他 {{ surveys|length|add:"-3" }}件...</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>調査が未スケジュールです
                    </div>
                    {% endif %}
                </div>
            </div>
        `;
    }

    // 契約ステップのHTML生成
    function generateContractStepHtml() {
        const isCompleted = projectData.contract_date;
        const statusHtml = isCompleted
            ? `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>完了: ${formatDate(projectData.contract_date)}</div>`
            : '<div class="progress-step-date">未完了</div>';

        // Check if survey is completed to determine if contract should be active
        let hasSurveyCompleted = false;
        {% if surveys %}
        const completedSurveys = [{% for survey in surveys %}{% if survey.status == 'completed' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        hasSurveyCompleted = completedSurveys.length > 0;
        {% endif %}

        return `
            <div class="progress-step ${isCompleted ? 'completed' : hasSurveyCompleted ? 'active' : ''}" data-step="contract">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ドラッグして並び替え"></i>
                        <span><i class="fas fa-handshake me-2"></i>契約</span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="contract" title="ステップを削除">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <label class="form-label">契約日</label>
                    <input type="date" name="contract_date" class="form-control" value="${projectData.contract_date || ''}">
                </div>
            </div>
        `;
    }

    // 工事開始ステップのHTML生成
    function generateWorkStartStepHtml() {
        const isCompleted = projectData.work_start_completed;
        const hasDate = projectData.work_start_date;

        let statusHtml;
        if (isCompleted) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>完了: ${formatDate(projectData.work_start_date)}</div>`;
        } else if (hasDate) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>予定: ${formatDate(projectData.work_start_date)}</div>`;
        } else {
            statusHtml = '<div class="progress-step-date">未完了</div>';
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.contract_date ? 'active' : ''}" data-step="work_start">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ドラッグして並び替え"></i>
                        <span><i class="fas fa-play-circle me-2"></i>工事開始</span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="work_start" title="ステップを削除">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <label class="form-label">工事開始日</label>
                        <input type="date" name="work_start_date" class="form-control" value="${projectData.work_start_date || ''}">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="work_start_completed"
                               id="workStartCompleted" ${projectData.work_start_completed ? 'checked' : ''}>
                        <label class="form-check-label" for="workStartCompleted">
                            <i class="fas fa-check me-1"></i>工事開始完了
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // 工事終了ステップのHTML生成
    function generateWorkEndStepHtml() {
        const isCompleted = projectData.work_end_completed;
        const hasDate = projectData.work_end_date;

        let statusHtml;
        if (isCompleted) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>完了: ${formatDate(projectData.work_end_date)}</div>`;
        } else if (hasDate) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>予定: ${formatDate(projectData.work_end_date)}</div>`;
        } else {
            statusHtml = '<div class="progress-step-date">未完了</div>';
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.work_start_completed ? 'active' : ''}" data-step="work_end">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ドラッグして並び替え"></i>
                        <span><i class="fas fa-stop-circle me-2"></i>工事終了</span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="work_end" title="ステップを削除">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <label class="form-label">工事終了日</label>
                        <input type="date" name="work_end_date" class="form-control" value="${projectData.work_end_date || ''}">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="work_end_completed"
                               id="workEndCompleted" ${projectData.work_end_completed ? 'checked' : ''}>
                        <label class="form-check-label" for="workEndCompleted">
                            <i class="fas fa-check me-1"></i>工事終了完了
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // 請求書発行ステップのHTML生成
    function generateInvoiceStepHtml() {
        const isCompleted = projectData.invoice_issued;
        const statusHtml = isCompleted
            ? '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>発行済み</div>'
            : '<div class="progress-step-date">未発行</div>';

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.work_end_completed ? 'active' : ''}" data-step="invoice">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ドラッグして並び替え"></i>
                        <span><i class="fas fa-receipt me-2"></i>請求書発行</span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="invoice" title="ステップを削除">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <label class="form-label">請求書発行</label>
                    <select name="invoice_issued" class="form-select">
                        <option value="false" ${!projectData.invoice_issued ? 'selected' : ''}>未発行</option>
                        <option value="true" ${projectData.invoice_issued ? 'selected' : ''}>発行済み</option>
                    </select>
                </div>
            </div>
        `;
    }


    // 利用可能なステップデータ（デフォルトプリセット5つ + 追加オプション）
    const availableSteps = [
        // === デフォルトプリセット（基本5ステップ） ===
        {
            name: '立ち会い日',
            icon: 'fas fa-user-check',
            key: 'attendance',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: '予定日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'actual_date',
                    label: '実施日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'staff_input_type',
                    label: '担当者入力方法',
                    type: 'radio',
                    options: [
                        { value: 'existing', text: '既存担当者から選択' },
                        { value: 'new', text: '新規担当者を入力' }
                    ],
                    default: 'existing'
                },
                {
                    name: 'staff_id',
                    label: '担当者（複数選択可）',
                    type: 'staff_select_list',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'existing'
                },
                {
                    name: 'staff_name',
                    label: '担当者名',
                    type: 'text',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'new'
                }
            ],
            statuses: [
                { key: 'waiting', label: '立ち会い待ち', color: 'warning' },
                { key: 'in_progress', label: '立ち会い中', color: 'info' },
                { key: 'completed', label: '立ち会い済み', color: 'success' }
            ]
        },
        {
            name: '現調日',
            icon: 'fas fa-clipboard-list',
            key: 'survey',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: '予定日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'actual_date',
                    label: '実施日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'staff_input_type',
                    label: '担当者入力方法',
                    type: 'radio',
                    options: [
                        { value: 'existing', text: '既存担当者から選択' },
                        { value: 'new', text: '新規担当者を入力' }
                    ],
                    default: 'existing'
                },
                {
                    name: 'staff_id',
                    label: '担当者（複数選択可）',
                    type: 'staff_select_list',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'existing'
                },
                {
                    name: 'staff_name',
                    label: '職人名',
                    type: 'text',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'new'
                }
            ],
            statuses: [
                { key: 'waiting', label: '現調待ち', color: 'warning' },
                { key: 'completed', label: '現調済み', color: 'success' }
            ]
        },
        {
            name: '見積もり発行日',
            icon: 'fas fa-calculator',
            key: 'estimate',
            type: 'complex',
            fields: [
                {
                    name: 'issued_date',
                    label: '発行日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'not_required',
                    label: '見積もり不要',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'pending', label: '見積もり書発行', color: 'info' },
                { key: 'under_review', label: '見積もり審査中', color: 'warning' },
                { key: 'approved', label: '見積もり承認済み', color: 'success' }
            ]
        },
        {
            name: '着工日',
            icon: 'fas fa-hard-hat',
            key: 'construction_start',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: '予定日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'actual_date',
                    label: '実施日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'staff_input_type',
                    label: '職人入力方法',
                    type: 'radio',
                    options: [
                        { value: 'existing', text: '既存職人から選択' },
                        { value: 'new', text: '新規職人を入力' }
                    ],
                    default: 'existing'
                },
                {
                    name: 'staff_id',
                    label: '担当者（複数選択可）',
                    type: 'staff_select_list',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'existing'
                },
                {
                    name: 'staff_name',
                    label: '職人名',
                    type: 'text',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'new'
                }
            ],
            statuses: [
                { key: 'waiting', label: '着工日待ち', color: 'warning' },
                { key: 'in_progress', label: '工事中', color: 'primary' },
                { key: 'completed', label: '工事完了', color: 'success' }
            ]
        },
        {
            name: '完工日',
            icon: 'fas fa-check-circle',
            key: 'completion',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: '予定日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'actual_date',
                    label: '実施日',
                    type: 'date',
                    required: false
                },
                {
                    name: 'completed',
                    label: '完工済み',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'in_progress', label: '施工中', color: 'info' },
                { key: 'completed', label: '完工', color: 'success' }
            ]
        },

        // === 追加オプションステップ ===
        {
            name: '契約',
            icon: 'fas fa-handshake',
            key: 'contract',
            type: 'date'
        },
        {
            name: '請求書発行',
            icon: 'fas fa-file-invoice-dollar',
            key: 'invoice',
            type: 'checkbox'
        },
        {
            name: '許可申請',
            icon: 'fas fa-file-signature',
            key: 'permit_application',
            type: 'date'
        },
        // 将来拡張用テンプレート例：
        /*
        {
            name: '材料検査',
            icon: 'fas fa-clipboard-check',
            key: 'material_inspection',
            type: 'complex',
            fields: [
                {
                    name: 'inspection_date',
                    label: '検査日',
                    type: 'date',
                    required: true
                },
                {
                    name: 'inspector_id',
                    label: '検査員',
                    type: 'select',
                    required: true,
                    options: [
                        { value: '', text: '選択してください' },
                        { value: 'inspector_1', text: '検査員A' },
                        { value: 'inspector_2', text: '検査員B' }
                    ]
                },
                {
                    name: 'passed',
                    label: '検査合格',
                    type: 'checkbox',
                    required: false
                },
                {
                    name: 'notes',
                    label: '備考',
                    type: 'text',
                    required: false
                }
            ]
        },
        */
        {
            name: '材料発注',
            icon: 'fas fa-boxes',
            key: 'material_order',
            type: 'date'
        },
        {
            name: '安全講習',
            icon: 'fas fa-hard-hat',
            key: 'safety_training',
            type: 'checkbox'
        },
        {
            name: '完成検査',
            icon: 'fas fa-clipboard-check',
            key: 'final_inspection',
            type: 'date'
        },
        {
            name: '引渡し',
            icon: 'fas fa-key',
            key: 'handover',
            type: 'date'
        },
        {
            name: '保証書発行',
            icon: 'fas fa-certificate',
            key: 'warranty_issue',
            type: 'checkbox'
        }
    ];

    // Sortable.jsの初期化
    function initializeSortable() {
        const progressContainer = document.getElementById('activeSteps');

        if (sortable) {
            sortable.destroy();
        }

        sortable = Sortable.create(progressContainer, {
            animation: 150,
            disabled: !editMode,
            filter: 'button, .btn, input, select, textarea, .progress-step-content',
            preventOnFilter: false,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: function (evt) {
                // ドラッグ開始時にコンテンツを非表示
                $('.progress-step-content').hide();
            },
            onEnd: function (evt) {
                // ドラッグ終了時の処理
                console.log('ステップ順序変更:', evt.oldIndex, '->', evt.newIndex);

                // ドラッグ後は全ての展開状態をリセット（自動展開なし）
                setTimeout(() => {
                    $('.progress-step').removeClass('expanded');
                    $('.progress-step-content').hide();
                }, 100);

                // ここで順序をサーバーに保存する処理を追加可能
                saveStepOrder();
            }
        });
    }

    // ステップ順序をサーバーに保存
    function saveStepOrder() {
        const steps = [];
        $('#activeSteps .progress-step').each(function(index) {
            steps.push({
                step: $(this).data('step'),
                order: index,
                completed: $(this).hasClass('completed')  // 完了フラグも保存
            });
        });
        console.log('新しい順序:', steps);

        // 順序をhiddenフィールドに設定
        $('#stepOrderInput').val(JSON.stringify(steps));
    }

    // 利用可能なステップをインベントリに表示
    function loadAvailableSteps() {
        const container = $('#availableSteps');
        container.empty();

        availableSteps.forEach(step => {
            // 既にアクティブなステップは表示しない
            if ($('.progress-step[data-step="' + step.key + '"]').length > 0) {
                return;
            }

            // 特別処理は不要 - すべてのステップをインベントリーに表示

            const stepHtml = `
                <div class="col-md-4 mb-2">
                    <div class="card border-dashed">
                        <div class="card-body p-2 text-center">
                            <i class="${step.icon} mb-1"></i><br>
                            <small>${step.name}</small><br>
                            <button type="button" class="btn btn-success btn-sm add-step-btn mt-1"
                                    data-step-key="${step.key}">
                                <i class="fas fa-plus"></i> 追加
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.append(stepHtml);
        });
    }

    // ステップ追加
    $(document).on('click', '.add-step-btn', function() {
        const stepKey = $(this).data('step-key');
        const stepData = availableSteps.find(s => s.key === stepKey);
        const $btn = $(this);

        console.log('Add step button clicked:', stepKey);
        console.log('Edit mode:', editMode);
        console.log('Step data found:', stepData);

        if (!editMode) {
            console.error('Not in edit mode! Cannot add step.');
            if (typeof toastr !== 'undefined') {
                toastr.warning('ステップ編集モードに入ってからステップを追加してください。');
            } else {
                alert('ステップ編集モードに入ってからステップを追加してください。');
            }
            return;
        }

        if (!stepData) {
            console.error('Step data not found for key:', stepKey);
            if (typeof toastr !== 'undefined') {
                toastr.error('ステップデータが見つかりません。');
            } else {
                alert('ステップデータが見つかりません。');
            }
            return;
        }

        if (stepData) {
            // ステップが既に存在するかチェック
            const existingStep = $(`.progress-step[data-step="${stepKey}"]`);
            if (existingStep.length > 0) {
                console.log('Step already exists:', stepKey);
                if (typeof toastr !== 'undefined') {
                    toastr.info(`${stepData.name}は既に追加されています。`);
                } else {
                    alert(`${stepData.name}は既に追加されています。`);
                }
                return;
            }

            // 現地調査ステップで survey_required=false の場合はAPIを呼ぶ
            if (stepData.key === 'survey' && stepData.apiEndpoint && !{% if project.survey_required %}true{% else %}false{% endif %}) {
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> 追加中...');

                fetch(stepData.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 成功時：ページをリロードして新しいステップを表示
                        location.reload();
                    } else {
                        alert('ステップの追加に失敗しました: ' + data.error);
                        $btn.prop('disabled', false).html('<i class="fas fa-plus"></i> 追加');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('エラーが発生しました');
                    $btn.prop('disabled', false).html('<i class="fas fa-plus"></i> 追加');
                });
            } else {
                // 通常のステップの場合（基本ステップも含む）
                if (stepData.type === 'basic') {
                    // 基本ステップの場合は対応するHTML生成関数を呼ぶ
                    let stepHtml = '';
                    switch (stepData.key) {
                        case 'estimate':
                            stepHtml = generateEstimateStepHtml();
                            break;
                        case 'survey':
                            stepHtml = generateSurveyStepHtml();
                            break;
                        case 'contract':
                            stepHtml = generateContractStepHtml();
                            break;
                        case 'work_start':
                            stepHtml = generateWorkStartStepHtml();
                            break;
                        case 'work_end':
                            stepHtml = generateWorkEndStepHtml();
                            break;
                        case 'invoice':
                            stepHtml = generateInvoiceStepHtml();
                            break;
                        default:
                            stepHtml = generateAvailableStepHtml(stepData);
                    }

                    // 請求書発行の前に挿入
                    const invoiceStep = $('.progress-step[data-step="invoice"]');
                    if (invoiceStep.length > 0) {
                        invoiceStep.before(stepHtml);
                        console.log(`Added step ${stepData.key} before invoice step`);
                    } else {
                        $('#activeSteps').append(stepHtml);
                        console.log(`Added step ${stepData.key} to end of active steps`);
                    }

                    // 通知を表示
                    if (typeof toastr !== 'undefined') {
                        toastr.success(`${stepData.name}を追加しました。「編集完了」ボタンをクリックして保存してください。`);
                    } else {
                        alert(`${stepData.name}を追加しました。「編集完了」ボタンをクリックして保存してください。`);
                    }
                } else {
                    addStepToProgress(stepData);
                }
                $(this).closest('.col-md-4').remove();

                // Sortableを再初期化
                initializeSortable();
                // ステップ順序を保存
                saveStepOrder();
                // 表示制御を更新
                updateSurveyAreaVisibility();

                console.log(`Step ${stepData.key} (${stepData.name}) successfully added to progress timeline`);
            }
        }
    });

    // ステップ削除
    $(document).on('click', '.remove-step-btn', function() {
        const stepKey = $(this).data('step');

        if (confirm('このステップを削除しますか？')) {
            console.log(`Removing step: ${stepKey}`);
            $(this).closest('.progress-step').remove();

            // ステップ順序を更新（重要！これがないと削除が保存されない）
            saveStepOrder();

            loadAvailableSteps(); // インベントリを再読み込み
            initializeSortable(); // Sortableを再初期化
            updateSurveyAreaVisibility(); // 現地調査エリアの表示制御を更新

            console.log(`Step ${stepKey} removed and order updated`);
        }
    });

    // 利用可能なステップから完全なステップHTMLを生成
    function generateAvailableStepHtml(stepData) {
        const fieldHtml = generateFieldHtml(stepData);

        return `
            <div class="progress-step" data-step="${stepData.key}">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ドラッグして並び替え"></i>
                        <span><i class="${stepData.icon} me-2"></i>${stepData.name}</span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="${stepData.key}" title="ステップを削除">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div class="progress-step-date">未完了</div>
                <div class="progress-step-content">
                    ${fieldHtml}
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-sm save-step-btn" data-step="${stepData.key}">
                            <i class="fas fa-save me-1"></i>保存
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // プログレスにステップを追加
    function addStepToProgress(stepData) {
        const stepHtml = generateAvailableStepHtml(stepData);

        // 請求書発行の前に挿入
        const invoiceStep = $('.progress-step[data-step="invoice"]');
        if (invoiceStep.length > 0) {
            invoiceStep.before(stepHtml);
        } else {
            $('#activeSteps').append(stepHtml);
        }

        // Sortableを再初期化
        initializeSortable();

        // ステップ順序を保存
        saveStepOrder();

        // 現地調査エリアの表示制御を更新
        updateSurveyAreaVisibility();

        console.log(`Added step: ${stepData.key} (${stepData.name})`);

        // 通知を表示
        if (typeof toastr !== 'undefined') {
            toastr.success(`${stepData.name}を追加しました。「編集完了」ボタンをクリックして保存してください。`);
        } else {
            alert(`${stepData.name}を追加しました。「編集完了」ボタンをクリックして保存してください。`);
        }
    }

    // フィールドタイプに応じたHTMLを生成
    function generateFieldHtml(stepData) {
        switch (stepData.type) {
            case 'complex':
                return generateComplexFieldHtml(stepData);
            case 'date':
                return `
                    <label class="form-label">${stepData.name}日</label>
                    <input type="date" name="${stepData.key}_date" class="form-control">
                `;
            case 'checkbox':
                return `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="${stepData.key}_completed"
                               id="${stepData.key}Completed">
                        <label class="form-check-label" for="${stepData.key}Completed">
                            <i class="fas fa-check me-1"></i>${stepData.name}完了
                        </label>
                    </div>
                `;
            default:
                return `
                    <label class="form-label">${stepData.name}</label>
                    <input type="text" name="${stepData.key}_value" class="form-control">
                `;
        }
    }

    // 複合フィールドのHTML生成
    function generateComplexFieldHtml(stepData) {
        if (!stepData.fields || !Array.isArray(stepData.fields)) {
            return `<p class="text-muted">フィールド定義が見つかりません</p>`;
        }

        let html = '';
        stepData.fields.forEach(field => {
            const fieldId = `${stepData.key}_${field.name}`;
            const fieldName = `dynamic_field_${stepData.key}_${field.name}`;  // dynamic_field_ プレフィックスを追加

            html += `<div class="mb-3">`;

            // dependency属性を処理（dependsOn と showWhen をサポート）
            const dependsOnField = field.dependsOn ? `dynamic_field_${stepData.key}_${field.dependsOn}` : '';
            const showWhenValue = field.showWhen || '';
            const dependencyAttr = dependsOnField ?
                `data-dependency-field="${dependsOnField}" data-dependency-value="${showWhenValue}"` : '';
            const initialDisplay = dependsOnField ? 'style="display: none;"' : '';

            // 依存フィールド（非表示の可能性がある）はrequiredにしない
            const isRequired = field.required && !dependsOnField;

            switch (field.type) {
                case 'radio':
                    html += `<label class="form-label">${field.label}</label>`;
                    if (field.options && Array.isArray(field.options)) {
                        field.options.forEach((option, index) => {
                            const isDefault = field.default === option.value;
                            html += `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${fieldName}" id="${fieldId}_${index}"
                                           value="${option.value}" ${isDefault ? 'checked' : ''} ${isRequired ? 'required' : ''}>
                                    <label class="form-check-label" for="${fieldId}_${index}">
                                        ${option.text}
                                    </label>
                                </div>
                            `;
                        });
                    }
                    break;
                case 'date':
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}">${field.label}</label>
                            <input type="date" name="${fieldName}" id="${fieldId}" class="form-control" ${isRequired ? 'required' : ''}>
                        </div>
                    `;
                    break;
                case 'select':
                    // スタッフ選択の場合は動的オプション生成
                    let options = field.options;
                    if (field.name === 'staff_id') {
                        options = generateStaffOptions();
                    }

                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}">${field.label}</label>
                            <select name="${fieldName}" id="${fieldId}" class="form-select" ${isRequired ? 'required' : ''}>
                    `;
                    if (options && Array.isArray(options)) {
                        options.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `</select>`;

                    // スタッフ管理ボタンを追加（すべてのステップで）
                    if (field.name === 'staff_id') {
                        html += `
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openStaffManagementPanel()">
                                <i class="fas fa-users-cog"></i> 担当者管理
                            </button>
                        `;
                    }
                    html += `</div>`;
                    break;
                case 'multiselect':
                    // 複数選択フィールド（職人選択など）
                    let multioptions = field.options;
                    if (field.name === 'staff_ids') {
                        multioptions = generateStaffOptions();
                    }

                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}">${field.label}</label>
                            <select name="${fieldName}" id="${fieldId}" class="form-select" multiple size="5" ${isRequired ? 'required' : ''}>
                    `;
                    if (multioptions && Array.isArray(multioptions)) {
                        multioptions.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `</select>`;
                    html += `<small class="form-text text-muted">Ctrl/Cmdキーを押しながらクリックで複数選択</small>`;

                    // スタッフ管理ボタンを追加
                    if (field.name === 'staff_ids') {
                        html += `
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openStaffManagementPanel()">
                                <i class="fas fa-users-cog"></i> 担当者管理
                            </button>
                        `;
                    }
                    html += `</div>`;
                    break;
                case 'text':
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}">${field.label}</label>
                            <input type="text" name="${fieldName}" id="${fieldId}" class="form-control" ${isRequired ? 'required' : ''}>
                        </div>
                    `;
                    break;
                case 'checkbox':
                    html += `
                        <div class="form-check" ${dependencyAttr} ${initialDisplay}>
                            <input class="form-check-input" type="checkbox" name="${fieldName}" id="${fieldId}" ${isRequired ? 'required' : ''}>
                            <label class="form-check-label" for="${fieldId}">
                                <i class="fas fa-check me-1"></i>${field.label}
                            </label>
                        </div>
                    `;
                    break;
                case 'staff_select_list':
                    // 動的に追加可能な担当者選択リスト
                    const staffOptions = generateStaffOptions();
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label">${field.label}</label>
                            <div class="staff-select-container" id="${fieldId}_container">
                                <div class="staff-select-item mb-2">
                                    <select name="${fieldName}" class="form-select form-select-sm d-inline-block" style="width: calc(100% - 50px);">
                                        <option value="">選択してください</option>
                    `;
                    if (staffOptions && Array.isArray(staffOptions)) {
                        staffOptions.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `
                                    </select>
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-staff-select-btn" style="display:none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2 add-staff-select-btn" data-container-id="${fieldId}_container" data-field-name="${fieldName}">
                                <i class="fas fa-plus me-1"></i>担当者を追加
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openStaffManagementPanel()">
                                <i class="fas fa-users-cog me-1"></i>担当者管理
                            </button>
                        </div>
                    `;
                    break;
                default:
                    html += `<p class="text-warning">未対応のフィールドタイプ: ${field.type}</p>`;
            }

            html += `</div>`;
        });

        return html;
    }

    // 複合ステップのステータス判定
    function getComplexStepStatus(stepData, stepElement) {
        if (!stepData.fields || !Array.isArray(stepData.fields)) {
            return { completed: false, statusText: '未完了', status: 'pending' };
        }

        const values = {};
        stepData.fields.forEach(field => {
            const fieldName = `dynamic_field_${stepData.key}_${field.name}`;  // dynamic_field_ プレフィックスを追加
            const input = stepElement.find(`[name="${fieldName}"]`);

            if (input.length > 0) {
                if (field.type === 'checkbox') {
                    // チェックボックスはboolean値を返す
                    values[field.name] = input.is(':checked');
                } else if (field.type === 'radio') {
                    // ラジオボタンは選択されている値のみ
                    if (input.is(':checked')) {
                        values[field.name] = input.val();
                    }
                } else if (field.type === 'multiselect') {
                    // 複数選択フィールド - 配列を処理
                    const val = input.val();
                    if (val && Array.isArray(val) && val.length > 0) {
                        values[field.name] = val.join(',');
                    }
                } else {
                    // テキストや日付フィールド - 空文字列は含めない
                    const val = input.val();
                    if (val && typeof val === 'string' && val.trim() !== '') {
                        values[field.name] = val.trim();
                    }
                }
            }
        });

        // 担当者名を取得
        function getStaffInfo() {
            const inputType = values.staff_input_type || 'existing';
            if (inputType === 'existing' && values.staff_id) {
                return getStaffName(values.staff_id);
            } else if (inputType === 'new' && values.staff_name) {
                return values.staff_name;
            }
            return '';
        }

        // ステップ別のステータス判定
        switch (stepData.key) {
            case 'attendance':  // 立ち会い日
                const attActual = values.actual_date;
                const attScheduled = values.scheduled_date;
                const attStaff = getStaffInfo();

                if (attActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">立ち会い済み</span> ${formatDate(attActual)}${attStaff ? ' (' + attStaff + ')' : ''}`
                    };
                } else if (attScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">立ち会い待ち</span> ${formatDate(attScheduled)}${attStaff ? ' (' + attStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">未完了</span>'
                    };
                }

            case 'survey':  // 現調日
                const surActual = values.actual_date;
                const surScheduled = values.scheduled_date;
                const surStaff = getStaffInfo();

                if (surActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">現調済み</span> ${formatDate(surActual)}${surStaff ? ' (' + surStaff + ')' : ''}`
                    };
                } else if (surScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">現調待ち</span> ${formatDate(surScheduled)}${surStaff ? ' (' + surStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">未完了</span>'
                    };
                }

            case 'estimate':  // 見積もり発行日
                const estIssued = values.issued_date;
                const estNotRequired = values.not_required;

                if (estNotRequired) {
                    return {
                        completed: true,
                        status: 'approved',
                        statusText: '<span class="badge bg-success">見積もり不要</span>'
                    };
                } else if (estIssued) {
                    return {
                        completed: false,
                        status: 'under_review',
                        statusText: `<span class="badge bg-warning">見積もり審査中</span> ${formatDate(estIssued)}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">未完了</span>'
                    };
                }

            case 'construction_start':  // 着工日
                const csActual = values.actual_date;
                const csScheduled = values.scheduled_date;
                const csStaff = getStaffInfo();

                if (csActual) {
                    return {
                        completed: true,
                        status: 'in_progress',
                        statusText: `<span class="badge bg-primary">工事中</span> ${formatDate(csActual)}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                } else if (csScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">着工日待ち</span> ${formatDate(csScheduled)}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">未完了</span>'
                    };
                }

            case 'completion':  // 完工日
                const compActual = values.actual_date;
                const compScheduled = values.scheduled_date;
                const compCompleted = values.completed;

                if (compCompleted || compActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">完工</span> ${compActual ? formatDate(compActual) : ''}`
                    };
                } else if (compScheduled) {
                    return {
                        completed: false,
                        status: 'in_progress',
                        statusText: `<span class="badge bg-info">施工中</span> 予定: ${formatDate(compScheduled)}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">未完了</span>'
                    };
                }

            default:
                // その他のステップ：何か値があれば完了
                const hasAnyValue = Object.values(values).some(value =>
                    typeof value === 'boolean' ? value : (value && value.trim && value.trim())
                );

                if (hasAnyValue) {
                    return { completed: true, status: 'completed', statusText: '<span class="badge bg-success">完了</span>' };
                } else {
                    return { completed: false, status: 'pending', statusText: '<span class="badge bg-secondary">未完了</span>' };
                }
        }
    }

    // 担当者マスタデータ（データベースから取得）
    let staffMaster = [
        {% for worker in internal_workers %}
        {
            id: '{{ worker.id }}',
            name: '{{ worker.name }}',
            department: '{{ worker.get_department_display|default:"" }}',
            phone: '{{ worker.phone|default:"" }}',
            hourly_rate: parseFloat("{{ worker.hourly_rate|default:0 }}".replace(/,/g, '')) || 0,
            specialties: '{{ worker.specialties|default:"" }}',
            active: {% if worker.is_active %}true{% else %}false{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // スタッフ名を取得するヘルパー関数
    function getStaffName(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        return staff ? staff.name : '不明';
    }

    // アクティブなスタッフのオプションリストを生成
    function generateStaffOptions() {
        const activeStaff = staffMaster.filter(s => s.active);
        return [
            { value: '', text: '選択してください' },
            ...activeStaff.map(staff => ({
                value: staff.id,
                text: `${staff.name} (${staff.department})`
            }))
        ];
    }

    // dependency機能 - ラジオボタンの変更でフィールドの表示/非表示を切り替え
    $(document).on('change', 'input[type="radio"]', function() {
        const changedFieldName = $(this).attr('name');
        const selectedValue = $(this).val();

        // この変更に依存するフィールドを表示/非表示
        $(`[data-dependency-field="${changedFieldName}"]`).each(function() {
            const dependencyValue = $(this).data('dependency-value');
            if (selectedValue === dependencyValue) {
                $(this).show();
            } else {
                $(this).hide();
                // 非表示になるフィールドの値をクリア
                $(this).find('input, select').val('');
            }
        });
    });

    // 複合ステップの変更を監視
    $(document).on('change', 'input[name^="survey_"], select[name^="survey_"]', function() {
        const stepElement = $('.progress-step[data-step="survey"]');
        if (stepElement.length === 0) return;

        // 現場調査ステップのデータを取得
        const sitesurvey = availableSteps.find(step => step.key === 'survey');
        if (!sitesurvey) return;

        const status = getComplexStepStatus(sitesurvey, stepElement);

        if (status.completed) {
            stepElement.addClass('completed');
        } else {
            stepElement.removeClass('completed');
        }

        stepElement.find('.progress-step-date').html(status.statusText);

        // 進捗更新
        updateProgressTimeline();
        updateProgressStatus();
    });

    // スタッフ管理パネルを開く
    window.openStaffManagementPanel = function() {
        $('#staffManagementModal').modal('show');
        refreshStaffList();
    };

    // スタッフリストを更新
    function refreshStaffList() {
        const tbody = $('#staffTableBody');
        tbody.empty();

        staffMaster.forEach((staff, index) => {
            const statusBadge = staff.active ?
                '<span class="badge bg-success">有効</span>' :
                '<span class="badge bg-secondary">無効</span>';

            const hourlyRateDisplay = staff.hourly_rate ? `¥${staff.hourly_rate}/時間` : '-';
            tbody.append(`
                <tr data-staff-id="${staff.id}">
                    <td>${staff.name}</td>
                    <td>${staff.department}</td>
                    <td>${hourlyRateDisplay}</td>
                    <td>${staff.specialties || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="editStaff('${staff.id}')">
                            <i class="fas fa-edit"></i> 編集
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteStaff('${staff.id}')">
                            <i class="fas fa-trash"></i> 削除
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    // スタッフ追加
    window.addNewStaff = function() {
        $('#staffModalTitle').text('新しい担当者を追加');
        $('#staffForm')[0].reset();
        $('#staffId').val('');
        $('#staffModal').modal('show');
    };

    // スタッフ編集
    window.editStaff = function(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        if (!staff) return;

        $('#staffModalTitle').text('担当者を編集');
        $('#staffId').val(staff.id);
        $('#staffName').val(staff.name);
        $('#staffDepartment').val(staff.department);
        $('#staffPhone').val(staff.phone || '');
        $('#staffHourlyRate').val(staff.hourly_rate || '');
        $('#staffSpecialties').val(staff.specialties || '');
        $('#staffActive').prop('checked', staff.active);
        $('#staffModal').modal('show');
    };

    // スタッフ削除
    window.deleteStaff = function(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        if (!staff) return;

        if (confirm(`「${staff.name}」を削除しますか？`)) {
            $.ajax({
                url: `/orders/api/staff/${staffId}/`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        staffMaster = staffMaster.filter(s => s.id !== staffId);
                        refreshStaffList();
                        updateStaffSelects();
                    } else {
                        alert('削除に失敗しました: ' + response.error);
                    }
                },
                error: function() {
                    alert('削除に失敗しました。');
                }
            });
        }
    };

    // スタッフ保存
    window.saveStaff = function() {
        const staffId = $('#staffId').val();
        const name = $('#staffName').val().trim();
        const department = $('#staffDepartment').val().trim();
        const phone = $('#staffPhone').val().trim();
        const hourly_rate = parseFloat($('#staffHourlyRate').val()) || 0;
        const specialties = $('#staffSpecialties').val().trim();
        const active = $('#staffActive').is(':checked');

        if (!name) {
            alert('担当者名を入力してください。');
            return;
        }

        const staffData = {
            name: name,
            department: department,
            phone: phone,
            hourly_rate: hourly_rate,
            specialties: specialties,
            active: active
        };

        if (staffId) {
            // 既存スタッフを更新
            $.ajax({
                url: `/orders/api/staff/${staffId}/`,
                method: 'PUT',
                data: JSON.stringify(staffData),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        const staff = staffMaster.find(s => s.id === staffId);
                        if (staff) {
                            Object.assign(staff, response.staff);
                        }
                        $('#staffModal').modal('hide');
                        refreshStaffList();
                        updateStaffSelects();
                    } else {
                        alert('更新に失敗しました: ' + response.error);
                    }
                },
                error: function() {
                    alert('更新に失敗しました。');
                }
            });
        } else {
            // 新しいスタッフを追加
            $.ajax({
                url: '/orders/api/staff/',
                method: 'POST',
                data: JSON.stringify(staffData),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        staffMaster.push(response.staff);
                        $('#staffModal').modal('hide');
                        refreshStaffList();
                        updateStaffSelects();
                    } else {
                        alert('追加に失敗しました: ' + response.error);
                    }
                },
                error: function() {
                    alert('追加に失敗しました。');
                }
            });
        }
    };

    // 全てのスタッフ選択フィールドを更新
    function updateStaffSelects() {
        const newOptions = generateStaffOptions();
        $('select[name="survey_staff_id"]').each(function() {
            const currentValue = $(this).val();
            $(this).empty();
            newOptions.forEach(option => {
                const selected = option.value === currentValue ? 'selected' : '';
                $(this).append(`<option value="${option.value}" ${selected}>${option.text}</option>`);
            });
        });
    }

    // 初期化処理
    $(document).ready(function() {
        console.log('Document ready - starting step initialization');

        // 現地調査エリアの存在確認
        console.log('Survey content area exists:', $('#surveyContentArea').length);
        console.log('Survey content area visible:', $('#surveyContentArea').is(':visible'));

        // フォールバック表示をクリアしてから初期化
        setTimeout(function() {
            console.log('Clearing fallback display and initializing steps');
            $('#activeSteps').empty();

            // ステップを初期化
            initializeSteps();
            // 利用可能なステップをロード
            loadAvailableSteps();
            // フォームフィールドの初期値に基づいてステップ状態を同期
            syncFormFieldsToSteps();

            // 初期状態で編集要素を隠す（editMode = false）
            console.log('Setting initial edit mode state (OFF)');
            $('.remove-step-btn').hide();
            $('.drag-handle').hide();
            $('#stepInventory').hide();

            console.log('Step initialization complete');
        }, 100);
    });
});

// ファイル削除確認 - Phase 5
function confirmFileDelete(fileId, fileName) {
    if (confirm(`ファイル「${fileName}」を削除してもよろしいですか？\n\nこの操作は取り消せません。`)) {
        const form = document.getElementById('fileDeleteForm');
        form.action = `/orders/projects/${projectId}/files/${fileId}/delete/`;
        form.submit();
    }
}
</script>

<!-- 担当者管理モーダル -->
<div class="modal fade" id="staffManagementModal" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffManagementModalLabel">
                    <i class="fas fa-users"></i> 担当者管理
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">担当者一覧</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewStaff()">
                        <i class="fas fa-plus"></i> 新規追加
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>名前</th>
                                <th>部署</th>
                                <th>時給</th>
                                <th>専門分野</th>
                                <th>状態</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- スタッフリストが動的に追加される -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
            </div>
        </div>
    </div>
</div>

<!-- 担当者編集/追加モーダル -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalTitle">担当者を追加</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    <div class="mb-3">
                        <label for="staffName" class="form-label">担当者名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="staffName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staffDepartment" class="form-label">部署</label>
                        <input type="text" class="form-control" id="staffDepartment" name="department">
                    </div>
                    <div class="mb-3">
                        <label for="staffHourlyRate" class="form-label">時給</label>
                        <div class="input-group">
                            <span class="input-group-text">¥</span>
                            <input type="number" class="form-control" id="staffHourlyRate" name="hourly_rate" placeholder="例: 3000">
                            <span class="input-group-text">/時間</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staffSpecialties" class="form-label">専門分野</label>
                        <input type="text" class="form-control" id="staffSpecialties" name="specialties" placeholder="例: 電気工事、配管">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="staffActive" name="active" checked>
                        <label class="form-check-label" for="staffActive">
                            有効
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 案件ファイル管理セクション - Phase 5 -->
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-folder-open me-2"></i>ファイル管理
                </h5>
                <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-light btn-sm">
                    <i class="fas fa-cloud-upload-alt me-1"></i>ファイルアップロード
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if project.files.all %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="40%">ファイル名</th>
                                <th width="15%">サイズ</th>
                                <th width="20%">アップロード者</th>
                                <th width="15%">アップロード日時</th>
                                <th width="10%" class="text-center">操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in project.files.all %}
                            <tr>
                                <td>
                                    {% if 'pdf' in file.file_type %}
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {% elif 'word' in file.file_type or 'document' in file.file_type %}
                                        <i class="fas fa-file-word text-primary me-2"></i>
                                    {% elif 'excel' in file.file_type or 'spreadsheet' in file.file_type %}
                                        <i class="fas fa-file-excel text-success me-2"></i>
                                    {% elif 'image' in file.file_type or 'jpg' in file.file_type or 'png' in file.file_type %}
                                        <i class="fas fa-file-image text-info me-2"></i>
                                    {% else %}
                                        <i class="fas fa-file text-secondary me-2"></i>
                                    {% endif %}
                                    <strong>{{ file.file_name }}</strong>
                                    {% if file.description %}
                                        <br><small class="text-muted ms-4">{{ file.description }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ file.get_file_size_display }}</span>
                                </td>
                                <td>
                                    {% if file.uploaded_by %}
                                        <i class="fas fa-user-circle me-1"></i>{{ file.uploaded_by.get_full_name|default:file.uploaded_by.username }}
                                    {% else %}
                                        <span class="text-muted">不明</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ file.uploaded_at|date:"Y/m/d H:i" }}</small>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'order_management:project_file_download' project.pk file.pk %}"
                                           class="btn btn-outline-primary"
                                           title="ダウンロード">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-outline-danger"
                                                onclick="confirmFileDelete({{ file.pk }}, '{{ file.file_name }}')"
                                                title="削除">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p class="mb-2">まだファイルがアップロードされていません</p>
                    <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-info">
                        <i class="fas fa-cloud-upload-alt me-1"></i>最初のファイルをアップロード
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ファイル削除確認用のフォーム (非表示) - Phase 5 -->
<form id="fileDeleteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

<!-- 案件チャット・コメントセクション -->
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-comments me-2"></i>案件コメント・チャット
            </h5>
        </div>
        <div class="card-body">
            <!-- コメント一覧 -->
            <div id="comments-container" class="mb-4" style="max-height: 500px; overflow-y: auto;">
                <!-- コメントはJavaScriptで動的に読み込み -->
                <div class="text-center text-muted py-5">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">コメントを読み込み中...</p>
                </div>
            </div>

            <!-- コメント投稿フォーム -->
            <div class="comment-form">
                <form id="comment-form" onsubmit="return false;">
                    <div class="mb-3">
                        <textarea
                            id="comment-content"
                            class="form-control"
                            rows="3"
                            placeholder="コメントを入力してください... (@ユーザー名 でメンションできます)"
                            required
                        ></textarea>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> @ユーザー名 でメンションすると、そのユーザーに通知が送られます
                        </small>
                    </div>

                    <!-- ファイルアップロードセクション -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-paperclip me-1"></i>ファイルを添付 (複数選択可)
                        </label>
                        <input
                            type="file"
                            class="form-control"
                            id="comment-files"
                            multiple
                            accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                        >
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> 画像、PDF、Office文書に対応（最大10MB/ファイル）
                        </small>
                        <!-- 選択したファイルのプレビュー -->
                        <div id="file-preview" class="mt-2"></div>
                    </div>

                    <div class="form-check mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="comment-important"
                        >
                        <label class="form-check-label" for="comment-important">
                            <i class="fas fa-exclamation-triangle text-warning"></i> 重要なコメントとしてマークする
                        </label>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="postComment()">
                        <i class="fas fa-paper-plane me-2"></i>コメントを投稿
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* チャットUIのスタイル */
.comment-item {
    border-left: 3px solid #dee2e6;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s;
}

.comment-item:hover {
    border-left-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.comment-item.important {
    border-left-color: #ffc107;
    background: #fff3cd;
}

.comment-author {
    font-weight: 600;
    color: #0d6efd;
    margin-right: 10px;
}

.comment-date {
    color: #6c757d;
    font-size: 0.9em;
}

.comment-content {
    margin-top: 10px;
    line-height: 1.6;
}

.comment-important-badge {
    background: #ffc107;
    color: #000;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    margin-left: 10px;
}

/* 添付ファイル関連のスタイル */
.comment-attachments {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-top: 10px;
}

.attachment-item {
    margin-bottom: 10px;
}

.attachment-link {
    display: inline-block;
    padding: 5px 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    text-decoration: none;
    color: #333;
    transition: all 0.2s;
}

.attachment-link:hover {
    background: #e9ecef;
    border-color: #0d6efd;
    color: #0d6efd;
    text-decoration: none;
}

.attachment-name {
    margin: 0 5px;
}

.attachment-size {
    color: #6c757d;
    font-size: 0.85em;
}

.attachment-preview {
    max-width: 300px;
    max-height: 200px;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s;
}

.attachment-preview:hover {
    transform: scale(1.05);
}

/* 画像モーダル */
.image-modal {
    display: block;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
}

.image-modal-content {
    position: relative;
    margin: auto;
    padding: 20px;
    max-width: 90%;
    max-height: 90%;
    top: 50%;
    transform: translateY(-50%);
}

.image-modal-content img {
    max-width: 100%;
    max-height: 80vh;
    display: block;
    margin: auto;
}

.image-modal-close {
    position: absolute;
    top: 10px;
    right: 25px;
    color: #f1f1f1;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
}

.image-modal-close:hover,
.image-modal-close:focus {
    color: #bbb;
}

/* ファイルプレビュー */
.file-item {
    padding: 5px;
    margin: 2px 0;
    background: #f8f9fa;
    border-radius: 3px;
}

.selected-files {
    margin-bottom: 5px;
    color: #0d6efd;
}
</style>

<script>
// コメント機能のJavaScript
const projectId = {{ project.id }};

// ページ読み込み時にコメントを取得
document.addEventListener('DOMContentLoaded', function() {
    loadComments();
});

// コメント一覧を読み込み
function loadComments() {
    fetch(`/orders/api/projects/${projectId}/comments/`)
        .then(response => {
            // レスポンスのContent-Typeをチェック
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('JSONレスポンスが期待されましたが、別の形式が返されました');
            }
            return response.json();
        })
        .then(data => {
            displayComments(data.comments);
        })
        .catch(error => {
            console.error('コメント取得エラー:', error);
            // コメント機能が未実装の可能性があるため、エラーを非表示にする
            document.getElementById('comments-container').innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p class="small">コメント機能は現在準備中です</p>
                </div>
            `;
        });
}

// コメントを表示
function displayComments(comments) {
    const container = document.getElementById('comments-container');

    if (comments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-comment-slash fa-3x mb-3"></i>
                <p>まだコメントがありません</p>
                <p class="small">最初のコメントを投稿してみましょう！</p>
            </div>
        `;
        return;
    }

    let html = '';
    comments.forEach(comment => {
        const importantClass = comment.is_important ? 'important' : '';
        const importantBadge = comment.is_important ?
            '<span class="comment-important-badge"><i class="fas fa-exclamation-triangle"></i> 重要</span>' : '';

        // 添付ファイルのHTML生成
        let attachmentsHtml = '';
        if (comment.attachments && comment.attachments.length > 0) {
            attachmentsHtml = '<div class="comment-attachments mt-2">';
            comment.attachments.forEach(attachment => {
                const icon = getFileIcon(attachment);
                attachmentsHtml += `
                    <div class="attachment-item">
                        <a href="${attachment.file_url}" target="_blank" class="attachment-link">
                            <i class="${icon}"></i>
                            <span class="attachment-name">${escapeHtml(attachment.file_name)}</span>
                            <span class="attachment-size">(${attachment.file_size})</span>
                        </a>
                        ${attachment.is_image ? `<div class="mt-2"><img src="${attachment.file_url}" class="attachment-preview" onclick="openImageModal('${attachment.file_url}', '${escapeHtml(attachment.file_name)}')"></div>` : ''}
                    </div>
                `;
            });
            attachmentsHtml += '</div>';
        }

        html += `
            <div class="comment-item ${importantClass}">
                <div class="comment-header">
                    <span class="comment-author">
                        <i class="fas fa-user-circle"></i> ${escapeHtml(comment.author)}
                    </span>
                    <span class="comment-date">
                        <i class="far fa-clock"></i> ${comment.created_at}
                    </span>
                    ${importantBadge}
                </div>
                <div class="comment-content">
                    ${formatCommentContent(comment.content)}
                </div>
                ${attachmentsHtml}
            </div>
        `;
    });

    container.innerHTML = html;

    // 最新のコメントにスクロール
    container.scrollTop = container.scrollHeight;
}

// コメント内容をフォーマット（@メンションをハイライト）
function formatCommentContent(content) {
    const escaped = escapeHtml(content);
    return escaped.replace(/@(\w+)/g, '<strong class="text-primary">@$1</strong>');
}

// HTMLエスケープ
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// コメントを投稿
function postComment() {
    const content = document.getElementById('comment-content').value.trim();
    const isImportant = document.getElementById('comment-important').checked;
    const filesInput = document.getElementById('comment-files');
    const files = filesInput.files;

    if (!content) {
        alert('コメント内容を入力してください');
        return;
    }

    // ファイルサイズチェック（10MB制限）
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) {
            alert(`ファイル "${file.name}" が10MBを超えています`);
            return;
        }
    }

    // CSRFトークンを取得
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // FormDataを使ってファイルとテキストを送信
    const formData = new FormData();
    formData.append('content', content);
    formData.append('is_important', isImportant);

    // ファイルを追加
    for (let file of files) {
        formData.append('files', file);
    }

    fetch(`/orders/api/projects/${projectId}/comments/post/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // フォームをリセット
            document.getElementById('comment-content').value = '';
            document.getElementById('comment-important').checked = false;
            filesInput.value = '';
            document.getElementById('file-preview').innerHTML = '';

            // コメント一覧を再読み込み
            loadComments();

            // 成功メッセージ
            showToast('コメントを投稿しました', 'success');
        } else {
            alert('エラー: ' + (data.error || 'コメントの投稿に失敗しました'));
        }
    })
    .catch(error => {
        console.error('コメント投稿エラー:', error);
        alert('コメントの投稿に失敗しました');
    });
}

// トースト通知を表示
function showToast(message, type = 'info') {
    // 簡易的なトースト表示
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ファイルアイコンを取得
function getFileIcon(attachment) {
    if (attachment.is_image) {
        return 'fas fa-file-image text-info';
    } else if (attachment.is_pdf) {
        return 'fas fa-file-pdf text-danger';
    } else if (attachment.file_type.includes('word') || attachment.file_type.includes('document')) {
        return 'fas fa-file-word text-primary';
    } else if (attachment.file_type.includes('excel') || attachment.file_type.includes('spreadsheet')) {
        return 'fas fa-file-excel text-success';
    } else {
        return 'fas fa-file text-secondary';
    }
}

// 画像モーダルを開く
function openImageModal(imageUrl, imageName) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `
        <div class="image-modal-content">
            <span class="image-modal-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <img src="${imageUrl}" alt="${imageName}">
            <p class="text-center mt-2">${imageName}</p>
        </div>
    `;
    document.body.appendChild(modal);

    // モーダル外クリックで閉じる
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// ファイル選択時のプレビュー表示
document.getElementById('comment-files').addEventListener('change', function(e) {
    const files = e.target.files;
    const preview = document.getElementById('file-preview');
    preview.innerHTML = '';

    if (files.length === 0) return;

    preview.innerHTML = '<div class="selected-files"><strong>選択したファイル:</strong></div>';
    for (let file of files) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        const sizeKB = (file.size / 1024).toFixed(1);
        fileItem.innerHTML = `
            <i class="fas fa-file me-2"></i>
            <span>${file.name}</span>
            <span class="text-muted ms-2">(${sizeKB} KB)</span>
        `;
        preview.appendChild(fileItem);
    }
});

// エンターキーでの送信（Shift+Enterで改行）
document.getElementById('comment-content').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        postComment();
    }
});

// ファイル削除確認 - Phase 5
function confirmFileDelete(fileId, fileName) {
    if (confirm(`ファイル「${fileName}」を削除してもよろしいですか？\n\nこの操作は取り消せません。`)) {
        const form = document.getElementById('fileDeleteForm');
        form.action = `/orders/projects/${projectId}/files/${fileId}/delete/`;
        form.submit();
    }
}

// 受注ヨミの変更を自動保存（案件詳細画面）
$(document).on('change', '.order-forecast-select-detail', function(e) {
    var select = $(this);
    var projectId = select.data('project-id');
    var newValue = select.val();
    var csrfToken = $('[name=csrfmiddlewaretoken]').val() || '{{ csrf_token }}';

    // 保存中の表示
    select.prop('disabled', true).css('opacity', '0.5');

    $.ajax({
        url: '/orders/' + projectId + '/update-forecast/',
        method: 'POST',
        data: {
            project_status: newValue,
            csrfmiddlewaretoken: csrfToken
        },
        success: function(response) {
            if (response.success) {
                // 保存成功時の視覚フィードバック
                select.css('border-color', '#28a745');

                // ヘッダーバッジも更新
                var badge = $('.badge[title="受注ヨミ（営業見込み度）"]');
                if (badge.length) {
                    // バッジの色を変更
                    badge.removeClass('bg-primary bg-success bg-info bg-warning bg-secondary text-dark');
                    if (newValue === '受注確定') {
                        badge.addClass('bg-primary');
                    } else if (newValue === 'A') {
                        badge.addClass('bg-success');
                    } else if (newValue === 'B') {
                        badge.addClass('bg-info');
                    } else if (newValue === 'NG') {
                        badge.addClass('bg-secondary');
                    } else {
                        badge.addClass('bg-warning text-dark');
                    }
                    badge.text('受注ヨミ: ' + newValue);
                }

                // 1秒後に緑の枠線を消す
                setTimeout(function() {
                    select.css('border-color', '');
                }, 1000);
            } else {
                alert('保存に失敗しました: ' + (response.error || '不明なエラー'));
                location.reload();
            }
        },
        error: function(xhr, status, error) {
            console.error('保存エラー:', error);
            alert('保存に失敗しました');
            location.reload();
        },
        complete: function() {
            select.prop('disabled', false).css('opacity', '1');
        }
    });
});
</script>

{% endblock %}