{% extends "order_management/base.html" %}
{% load humanize %}
{% load role_tags %}
{% load custom_filters %}

{% block title %}{{ project.site_name }} - å»ºç¯‰æ´¾é£ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ {% endblock %}

{% block extra_css %}
<style>
/* æ–™é‡‘ä½“ç³»é¸æŠã‚«ãƒ¼ãƒ‰ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.pricing-type-card {
    cursor: pointer;
    transition: all 0.3s ease;
    border: 1px solid #dee2e6;
}

.pricing-type-card:hover {
    border-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.15);
}

.pricing-type-card.border-primary {
    border-color: #0d6efd !important;
    box-shadow: 0 2px 8px rgba(13, 110, 253, 0.25);
}

.pricing-type-card.bg-light {
    background-color: rgba(13, 110, 253, 0.1) !important;
}

.pricing-type-card .form-check-input:checked {
    background-color: #0d6efd;
    border-color: #0d6efd;
}
</style>
<!-- Sortable.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<style>
    .progress-status-card {
        border: 2px solid;
        border-radius: 10px;
        transition: all 0.3s;
    }
    .progress-status-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .action-button {
        min-width: 120px;
        margin: 0.25rem;
    }
    .status-selector {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 10px;
        padding: 1rem;
    }
    .progress-timeline {
        position: relative;
        padding-left: 2rem;
    }
    .progress-timeline::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
    }
    .timeline-item {
        position: relative;
        margin-bottom: 1rem;
    }
    .timeline-item::before {
        content: '';
        position: absolute;
        left: -26px;
        top: 8px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #6c757d; /* ã‚°ãƒ¬ãƒ¼ï¼šä½•ã‚‚å…¥åŠ›ãªã— */
    }
    .timeline-item.scheduled::before {
        background: #ffc107; /* é»„è‰²ï¼šäºˆå®šæ—¥ã®ã¿å…¥åŠ› */
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }
    .timeline-item.completed::before {
        background: #28a745; /* ç·‘ï¼šå®Œäº†æ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ */
    }
    .timeline-item.verified::before {
        background: #155724; /* æ¿ƒã„ç·‘ï¼šå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ */
        box-shadow: 0 0 0 4px rgba(21, 87, 36, 0.3);
    }
    .timeline-item.current::before {
        background: #ffc107; /* é»„è‰²ï¼šç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆäºˆå®šæ—¥ã®ã¿ã¨åŒã˜ï¼‰ */
        box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
    }

    /* ç¸¦å‹ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ */
    .vertical-progress {
        position: relative;
        padding-left: 40px;
        min-height: 400px;
    }

    .vertical-progress::before {
        content: '';
        position: absolute;
        left: 20px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #e9ecef;
    }

    .progress-step {
        position: relative;
        margin-bottom: 30px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .progress-step::before {
        content: '';
        position: absolute;
        left: -28px;
        top: 8px;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #6c757d;
        border: 3px solid #fff;
        box-shadow: 0 0 0 2px #6c757d;
        transition: all 0.3s ease;
    }

    .progress-step.completed::before {
        background: #28a745;
        box-shadow: 0 0 0 2px #28a745;
    }

    .progress-step.active::before {
        background: #007bff;
        box-shadow: 0 0 0 2px #007bff, 0 0 0 6px rgba(0, 123, 255, 0.2);
        transform: scale(1.2);
    }

    .progress-step:hover {
        transform: translateX(5px);
    }

    .progress-step-header {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        transition: color 0.3s ease;
    }

    .progress-step.completed .progress-step-header {
        color: #28a745;
    }

    .progress-step.active .progress-step-header {
        color: #007bff;
    }

    .progress-step-content {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 10px;
        display: none;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }

    .progress-step.expanded .progress-step-content {
        display: block;
        border-color: #007bff;
        background: #fff;
    }

    .progress-step {
        cursor: pointer;
        transition: all 0.2s ease;
        border: 1px solid transparent;
        border-radius: 8px;
        padding: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .progress-step:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        border-color: #dee2e6;
    }

    .progress-step.expanded {
        background-color: #fff;
        border-color: #007bff;
        box-shadow: 0 4px 8px rgba(0,123,255,0.1);
    }

    .progress-step-date {
        font-size: 0.875rem;
        color: #6c757d;
    }

    /* ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚«ãƒ¼ãƒ‰ */
    .border-dashed {
        border: 2px dashed #dee2e6 !important;
        transition: all 0.3s ease;
    }
    .border-dashed:hover {
        border-color: #007bff !important;
        background-color: #f8f9fa;
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°ã‚¢ãƒ³ãƒ‰ãƒ‰ãƒ­ãƒƒãƒ— */
    .progress-step.sortable-ghost {
        opacity: 0.5;
        background: #e9ecef;
    }
    .progress-step.sortable-drag {
        opacity: 0.8;
        transform: rotate(5deg);
        box-shadow: 0 10px 20px rgba(0,0,0,0.2);
    }
    .progress-step.sortable-chosen {
        cursor: grab;
    }
    .progress-step {
        transition: all 0.3s ease;
    }
    .progress-step:hover {
        transform: translateX(5px);
    }
    .drag-handle {
        cursor: grab;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    .progress-step:hover .drag-handle {
        opacity: 1;
    }
    .drag-handle:active {
        cursor: grabbing;
    }

    .progress-step.completed .progress-step-date {
        color: #28a745;
        font-weight: 500;
    }

    /* è©³ç´°é€²æ—ç®¡ç†ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ - Phase 11 */
    .timeline {
        position: relative;
        padding: 20px 0;
    }

    .timeline::before {
        content: '';
        position: absolute;
        left: 28px;
        top: 0;
        bottom: 0;
        width: 3px;
        background: linear-gradient(180deg, #e9ecef 0%, #dee2e6 100%);
    }

    .timeline-item {
        position: relative;
        padding-left: 70px;
        padding-bottom: 30px;
    }

    .timeline-item:last-child {
        padding-bottom: 0;
    }

    .timeline-marker {
        position: absolute;
        left: 0;
        top: 0;
        width: 56px;
        height: 56px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
        color: white;
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        z-index: 1;
    }

    .timeline-marker.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    .timeline-marker.bg-secondary {
        background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
    }

    .timeline-content {
        background: #ffffff;
        border: 2px solid #e9ecef;
        border-radius: 12px;
        padding: 15px 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        transition: all 0.3s ease;
    }

    .timeline-content:hover {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0,123,255,0.15);
        transform: translateX(5px);
    }

    .timeline-content h6 {
        color: #495057;
        font-weight: 600;
        margin-bottom: 10px;
    }

    .badge.bg-light.text-dark {
        background-color: #f8f9fa !important;
        border: 1px solid #dee2e6;
    }
</style>
{% endblock %}

{% block content %}
<!-- ãƒ˜ãƒƒãƒ€ãƒ¼ & ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="d-flex align-items-center">
            <h2><i class="fas fa-building"></i> {{ project.site_name }}</h2>
            <span class="badge {% if project.project_status == 'å—æ³¨ç¢ºå®š' %}bg-primary{% elif project.project_status == 'A' %}bg-success{% elif project.project_status == 'B' %}bg-info{% elif project.project_status == 'NG' %}bg-secondary{% else %}bg-warning text-dark{% endif %} fs-6 ms-3"
                  title="å—æ³¨ãƒ¨ãƒŸï¼ˆå–¶æ¥­è¦‹è¾¼ã¿åº¦ï¼‰">
                å—æ³¨ãƒ¨ãƒŸ: {{ project.get_project_status_display }}
            </span>
        </div>
        <p class="text-muted mb-0">{{ project.management_no }} | {{ project.work_type }}</p>
    </div>
    <div class="col-md-4">
        <div class="text-end">
            <a href="{% url 'subcontract_management:project_subcontract_list' project.pk %}" class="btn btn-success action-button">
                <i class="fas fa-file-contract"></i> ç™ºæ³¨ç®¡ç†
            </a>
            <button type="button" class="btn btn-danger action-button" data-bs-toggle="modal" data-bs-target="#deleteModal">
                <i class="fas fa-trash"></i> å‰Šé™¤
            </button>
            <a href="{% url 'order_management:project_list' %}" class="btn btn-secondary action-button">
                <i class="fas fa-list"></i> ä¸€è¦§ã¸
            </a>
        </div>
    </div>
</div>

<!-- é€²æ—çŠ¶æ³ã‚«ãƒ¼ãƒ‰ -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card progress-status-card border-primary" id="progressStatusCard">
            <div class="card-header bg-primary text-white" id="progressStatusHeader">
                <h5 class="mb-0"><i class="fas fa-tasks"></i> é€²æ—çŠ¶æ³</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        {% with stage=project.get_current_project_stage %}
                        <h3 class="text-{{ stage.color }}" id="progressPhase">{{ stage.stage }}</h3>
                        {% endwith %}
                        <!-- æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ -->
                        <p class="text-muted mb-1" style="font-size: 0.9rem;" id="nextAction">
                            <i class="fas fa-arrow-right me-1"></i><strong>Next Action:</strong><br><span id="nextActionText">èª­ã¿è¾¼ã¿ä¸­...</span>
                        </p>
                        <!-- NEXTã‚¹ãƒ†ãƒƒãƒ— -->
                        <p class="text-secondary mb-2" style="font-size: 0.8rem; margin-top: 0.5rem;" id="nextStep">
                            <i class="fas fa-forward me-1"></i><strong>Next Step:</strong><br><span id="nextStepText">-</span>
                        </p>
                        <div class="progress" style="height: 25px;">
                            <div class="progress-bar bg-primary" id="progressBar"
                                 role="progressbar"
                                 style="width: {{ project.get_progress_status.percentage }}%"
                                 aria-valuenow="{{ project.get_progress_status.percentage }}"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <span id="progressPercentage">{{ project.get_progress_status.percentage }}%</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="progress-timeline" id="progressTimeline">
                            <!-- å‹•çš„ã«æ§‹ç¯‰ã•ã‚Œã‚‹ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card status-selector">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-cog"></i> é€²æ—çŠ¶æ³ã‚’æ›´æ–°</h6>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'order_management:update_progress' project.pk %}">
                    {% csrf_token %}

                    <!-- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéšç®¡ç† -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <label class="form-label">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ®µéš</label>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="editStepsBtn"
                                    style="position: relative; z-index: 1000; pointer-events: auto;">
                                <i class="fas fa-edit"></i> ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†
                            </button>
                        </div>
                        <div class="vertical-progress" id="activeSteps">
                            <!-- å‹•çš„ã«ã‚¹ãƒ†ãƒƒãƒ—ãŒæ§‹ç¯‰ã•ã‚Œã‚‹ -->
                        </div>
                    </div>

                    <!-- ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆé€²æ—æ›´æ–°ãƒœã‚¿ãƒ³ã®ä¸‹ï¼‰ -->
                    <div id="stepInventory" class="mt-4">
                        <hr>
                        <h6><i class="fas fa-box"></i> åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—</h6>
                        <div class="row" id="availableSteps">
                            <!-- åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ã“ã“ã«å‹•çš„ã«è¡¨ç¤º -->
                        </div>
                    </div>

                    <!-- ã‚¹ãƒ†ãƒƒãƒ—é †åºã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ -->
                    <input type="hidden" name="step_order" id="stepOrderInput" value="">

                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save"></i> é€²æ—æ›´æ–°
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ç¾åœ°èª¿æŸ» -->
<div class="row mb-4" id="surveyContentArea">
    <div class="col-lg-12">
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-clipboard-list me-2"></i>ç¾åœ°èª¿æŸ»
                        {% if surveys %}
                            <span class="badge bg-white text-primary ms-2">{{ surveys|length }}ä»¶</span>
                        {% endif %}
                    </h5>
                    <div class="btn-group">
{#                         <a href="#" class="btn btn-sm btn-light">
                            <i class="fas fa-list"></i> èª¿æŸ»ä¸€è¦§
                        </a>
{#                         <a href="#" class="btn btn-sm btn-light">
                            <i class="fas fa-plus"></i> èª¿æŸ»è¿½åŠ 
                        </a>
                    </div>
                </div>
            </div>
            <div class="card-body">
                {% if surveys %}
                    <!-- æœ€æ–°ã®èª¿æŸ»æƒ…å ± -->
                    {% with latest_survey=surveys.first %}
                    {% if latest_survey %}
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <div class="alert {% if latest_survey.status == 'completed' %}alert-success{% elif latest_survey.status == 'in_progress' %}alert-warning{% else %}alert-info{% endif %} mb-0">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-1">
                                            {% if latest_survey.status == 'completed' %}
                                                <i class="fas fa-check-circle me-1"></i>æœ€æ–°èª¿æŸ»å®Œäº†
                                            {% elif latest_survey.status == 'in_progress' %}
                                                <i class="fas fa-spinner fa-spin me-1"></i>èª¿æŸ»å®Ÿæ–½ä¸­
                                            {% else %}
                                                <i class="fas fa-calendar-alt me-1"></i>æ¬¡å›èª¿æŸ»äºˆå®š
                                            {% endif %}
                                        </h6>
                                        <div class="small">
                                            <strong>æ—¥æ™‚:</strong> {{ latest_survey.scheduled_date|date:"Yå¹´mæœˆdæ—¥" }} {{ latest_survey.scheduled_start_time|time:"H:i" }}<br>
                                            <strong>æ‹…å½“:</strong> {{ latest_survey.surveyor.name }} ({{ latest_survey.surveyor.employee_id }})
                                            {% if latest_survey.status == 'completed' and latest_survey.rooms.count > 0 %}
                                            <br><strong>èª¿æŸ»çµæœ:</strong> {{ latest_survey.rooms.count }}éƒ¨å±‹ / {{ latest_survey.damages.count }}ä»¶ã®æå‚·è¨˜éŒ² / {{ latest_survey.photos.count }}æšã®å†™çœŸ
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-4 text-end">
                                        {% if latest_survey.status == 'completed' %}
{#                                             <a href="#" class="btn btn-sm btn-success">
                                                <i class="fas fa-file-pdf"></i> ãƒ¬ãƒãƒ¼ãƒˆ
                                            </a>
                                        {% elif latest_survey.status == 'in_progress' %}
{#                                             <a href="#" class="btn btn-sm btn-warning">
                                                <i class="fas fa-play"></i> ç¶šã‘ã‚‹
                                            </a>
                                        {% else %}
{#                                             <a href="#" class="btn btn-sm btn-primary">
                                                <i class="fas fa-play"></i> é–‹å§‹
                                            </a>
                                        {% endif %}
{#                                         <a href="#" class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-eye"></i> è©³ç´°
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endwith %}

                    <!-- èª¿æŸ»å±¥æ­´ -->
                    {% if surveys|length > 1 %}
                    <div class="table-responsive">
                        <table class="table table-sm table-hover">
                            <thead>
                                <tr>
                                    <th width="20%">å®Ÿæ–½æ—¥</th>
                                    <th width="20%">æ‹…å½“è€…</th>
                                    <th width="15%">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                    <th width="25%">èª¿æŸ»å†…å®¹</th>
                                    <th width="20%" class="text-end">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for survey in surveys %}
                                <tr>
                                    <td>{{ survey.scheduled_date|date:"m/d" }} {{ survey.scheduled_start_time|time:"H:i" }}</td>
                                    <td>{{ survey.surveyor.name }} ({{ survey.surveyor.employee_id }})</td>
                                    <td>
                                        <span class="badge {% if survey.status == 'completed' %}bg-success{% elif survey.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %}">
                                            {{ survey.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if survey.status == 'completed' %}
                                            <small>{{ survey.rooms.count }}éƒ¨å±‹ / {{ survey.damages.count }}æå‚· / {{ survey.photos.count }}å†™çœŸ</small>
                                        {% else %}
                                            <small class="text-muted">-</small>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
{#                                         <a href="#" class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        {% if survey.status == 'completed' %}
{#                                             <a href="#" class="btn btn-sm btn-outline-success">
                                                <i class="fas fa-file-pdf"></i>
                                            </a>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% endif %}

                {% else %}
                    <!-- èª¿æŸ»æœªå®Ÿæ–½ã®å ´åˆ -->
                    <div class="alert alert-warning">
                        <div class="row align-items-center">
                            <div class="col-md-1 text-center">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                            <div class="col-md-8">
                                <h6 class="mb-1">ç¾åœ°èª¿æŸ»ãŒæœªå®Ÿæ–½ã§ã™</h6>
                                <small>ã“ã®æ¡ˆä»¶ã®ç¾åœ°èª¿æŸ»ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚æ­£ç¢ºãªè¦‹ç©ã‚‚ã‚Šã¨æ–½å·¥è¨ˆç”»ã®ãŸã‚ã«å¿…è¦ã§ã™ã€‚</small>
                            </div>
                            <div class="col-md-3 text-end">
{#                                 <a href="#" class="btn btn-primary">
                                    <i class="fas fa-plus me-1"></i>èª¿æŸ»ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                                </a>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- æ‰‹é…çŠ¶æ³ -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card border-{% if subcontracts %}success{% else %}warning{% endif %}">
            <div class="card-header bg-{% if subcontracts %}success{% else %}warning{% endif %} text-white">
                <h5 class="mb-0"><i class="fas fa-file-contract"></i> æ‰‹é…çŠ¶æ³
                    <span class="badge bg-light text-dark ms-2">{{ subcontracts|length }}ä»¶ç™»éŒ²</span>
                </h5>
            </div>
            <div class="card-body">
                {% if subcontracts %}
                <!-- ç™»éŒ²æ¸ˆã¿ç™ºæ³¨å…ˆãƒªã‚¹ãƒˆ -->
                <h6><i class="fas fa-file-contract"></i> ç™»éŒ²æ¸ˆã¿ç™ºæ³¨å…ˆ</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ç™ºæ³¨å…ˆ</th>
                                <th>ä½œæ¥­å†…å®¹</th>
                                <th class="text-end">å¥‘ç´„é¡</th>
                                <th class="text-end">è¢«è«‹æ±‚é¡</th>
                                <th class="text-center">æ”¯æ‰•çŠ¶æ³</th>
                                <th class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subcontract in subcontracts %}
                            <tr>
                                <td><strong>{{ subcontract.contractor.name }}</strong></td>
                                <td>{{ subcontract.work_description|default:"-"|truncatechars:20 }}</td>
                                <td class="text-end">Â¥{{ subcontract.contract_amount|floatformat:0|intcomma }}</td>
                                <td class="text-end">Â¥{{ subcontract.billed_amount|floatformat:0|intcomma }}</td>
                                <td class="text-center">
                                    <span class="badge bg-{{ subcontract.get_payment_status_color }}">
                                        {{ subcontract.get_payment_status_display }}
                                    </span>
                                </td>
                                <td class="text-center">
                                    <a href="{% url 'subcontract_management:subcontract_update' subcontract.pk %}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">ç™ºæ³¨å…ˆæœªç™»éŒ²</h5>
                    <p class="text-muted">ã“ã®æ¡ˆä»¶ã«ã¯ã¾ã ç™ºæ³¨å…ˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>å³å´ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ç™ºæ³¨å…ˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- ä½œæ¥­è€…ç®¡ç†ã‚«ãƒ¼ãƒ‰ï¼ˆè³‡æç®¡ç†ã¨åŒã˜ã‚¹ã‚¿ã‚¤ãƒ«ï¼‰ -->
        <div class="card border-primary">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fas fa-users"></i> ä½œæ¥­è€…ç®¡ç†</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'order_management:add_subcontract' project.pk %}" class="btn btn-primary">
                        <i class="fas fa-user-plus"></i> ä½œæ¥­è€…ã‚’è¿½åŠ 
                    </a>
                </div>

                <!-- ä½œæ¥­è€…ç®¡ç†ã®ãƒ’ãƒ³ãƒˆ -->
                <div class="mt-3">
                    <h6 class="text-primary"><i class="fas fa-lightbulb"></i> ä½¿ã„æ–¹</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-1"><i class="fas fa-check text-primary"></i> å¤–æ³¨ãƒ»ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ç®¡ç†</li>
                        <li class="mb-1"><i class="fas fa-check text-primary"></i> è²»ç”¨ãƒ»å·¥æ•°ã®è‡ªå‹•è¨ˆç®—</li>
                        <li class="mb-1"><i class="fas fa-check text-primary"></i> å‡ºé‡‘çŠ¶æ³ã®ç®¡ç†</li>
                        <li class="mb-1"><i class="fas fa-check text-primary"></i> åˆ©ç›Šç‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ è¡¨ç¤º</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è³‡æç™ºæ³¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-box-open"></i> è³‡æç™ºæ³¨çŠ¶æ³
                    {% with material_status=project.get_material_status %}
                    <span class="badge bg-light text-dark ms-2">{{ material_status.total_orders }}ä»¶ç™ºæ³¨</span>
                    {% endwith %}
                </h5>
            </div>
            <div class="card-body">
                {% with material_status=project.get_material_status %}
                {% if material_status.total_orders > 0 %}
                <!-- è³‡æç™ºæ³¨ã‚µãƒãƒªãƒ¼ -->
                <div class="row mb-3">
                    <div class="col-md-3 text-center">
                        <div class="h4 text-warning">{{ material_status.total_orders }}</div>
                        <small class="text-muted">ç·ç™ºæ³¨æ•°</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-success">Â¥{{ material_status.total_amount|floatformat:0|intcomma }}</div>
                        <small class="text-muted">ç·é‡‘é¡</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-info">{{ material_status.delivered_count }}</div>
                        <small class="text-muted">ç´å“æ¸ˆã¿</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-primary">{{ material_status.completed_count }}</div>
                        <small class="text-muted">å®Œäº†</small>
                    </div>
                </div>

                <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¥é€²æ— -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <span>ä¸‹æ›¸ã</span>
                        <span class="badge bg-secondary">{{ material_status.draft_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>ç™ºæ³¨æ¸ˆã¿</span>
                        <span class="badge bg-warning">{{ material_status.ordered_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span>ç´å“æ¸ˆã¿</span>
                        <span class="badge bg-success">{{ material_status.delivered_count }}</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>å®Œäº†</span>
                        <span class="badge bg-info">{{ material_status.completed_count }}</span>
                    </div>
                </div>

                <!-- æœ€è¿‘ã®ç™ºæ³¨ -->
                {% if project.material_orders.exists %}
                <h6><i class="fas fa-clock"></i> æœ€è¿‘ã®ç™ºæ³¨</h6>
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>ç™ºæ³¨ç•ªå·</th>
                                <th>æ¥­è€…</th>
                                <th>é‡‘é¡</th>
                                <th>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</th>
                                <th>ç™ºæ³¨æ—¥</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in project.material_orders.all|slice:":5" %}
                            <tr>
                                <td>
                                    <a href="{% url 'order_management:material_order_detail' project.id order.id %}" class="text-decoration-none">
                                        {{ order.order_number }}
                                    </a>
                                </td>
                                <td>{{ order.contractor.name }}</td>
                                <td class="text-end">Â¥{{ order.total_amount|floatformat:0|intcomma }}</td>
                                <td>
                                    <span class="badge bg-{{ order.get_status_color }}">
                                        {{ order.get_status_display }}
                                    </span>
                                </td>
                                <td>{{ order.order_date }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">è³‡æç™ºæ³¨æœªç™»éŒ²</h5>
                    <p class="text-muted">ã“ã®æ¡ˆä»¶ã«ã¯ã¾ã è³‡æç™ºæ³¨ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚<br>å³å´ã®ãƒœã‚¿ãƒ³ã‹ã‚‰è³‡æç™ºæ³¨ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚</p>
                </div>
                {% endif %}
                {% endwith %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-warning">
            <div class="card-header bg-warning text-white">
                <h6 class="mb-0"><i class="fas fa-plus-circle"></i> è³‡æç®¡ç†</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'order_management:material_order_list' project.id %}" class="btn btn-warning">
                        <i class="fas fa-list"></i> è³‡æç™ºæ³¨ä¸€è¦§
                    </a>
                    <a href="{% url 'order_management:material_order_create' project.id %}" class="btn btn-outline-warning">
                        <i class="fas fa-plus"></i> æ–°è¦è³‡æç™ºæ³¨
                    </a>
                </div>

                <!-- è³‡æç®¡ç†ã®ãƒ’ãƒ³ãƒˆ -->
                <div class="mt-3">
                    <h6 class="text-warning"><i class="fas fa-lightbulb"></i> ä½¿ã„æ–¹</h6>
                    <ul class="list-unstyled small">
                        <li class="mb-1"><i class="fas fa-check text-warning"></i> è¤‡æ•°æ¥­è€…ã¸ã®ç™ºæ³¨ç®¡ç†</li>
                        <li class="mb-1"><i class="fas fa-check text-warning"></i> æ¥­è€…ã”ã¨ã®è¤‡æ•°æ³¨æ–‡å¯¾å¿œ</li>
                        <li class="mb-1"><i class="fas fa-check text-warning"></i> ç´æœŸãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†</li>
                        <li class="mb-1"><i class="fas fa-check text-warning"></i> é‡‘é¡ãƒ»å°è¨ˆè‡ªå‹•è¨ˆç®—</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- çµŒç†æƒ…å ± -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card border-info">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-calculator"></i> çµŒç†æƒ…å ±</h5>
            </div>
            <div class="card-body">
                <div class="row g-0">
                    <!-- è¦–è¦šçš„åˆ©ç›Šåˆ†æãƒãƒ£ãƒ¼ãƒˆ -->
                    <div class="col-md-3 d-flex align-items-center justify-content-center bg-light border-end">
                        <div class="profit-chart-container p-3">
                            <div class="chart-bars d-flex align-items-end justify-content-center" style="height: 300px;">
                                <!-- å£²ä¸Šãƒãƒ¼ -->
                                <div class="chart-bar-wrapper text-center">
                                    <div class="chart-bar"
                                         style="width: 80px; height: 280px; border-radius: 8px; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 15px; background: linear-gradient(135deg, #198754, #20c997); color: white; margin-right: 2px;">
                                        <div class="chart-label fw-bold mb-2" style="font-size: 0.9rem;">å£²ä¸Š</div>
                                        <div class="chart-amount text-center fw-bold" style="font-size: 0.8rem; line-height: 1.2;">
                                            Â¥{{ financial_info.revenue|floatformat:0|intcomma }}
                                        </div>
                                    </div>
                                </div>

                                <!-- å£²ä¸Šç·åˆ©ç›Šãƒãƒ¼ -->
                                <div class="chart-bar-wrapper text-center">
                                    {% widthratio financial_info.gross_profit financial_info.revenue 100 as profit_percentage %}
                                    {% widthratio financial_info.cost_of_sales financial_info.revenue 100 as cost_percentage %}
                                    <div style="width: 80px; height: 280px; position: relative; margin-left: 2px; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column;">
                                        <!-- å£²ä¸ŠåŸä¾¡éƒ¨åˆ†ï¼ˆä¸Šéƒ¨ï¼‰ -->
                                        <div class="chart-section"
                                             style="width: 100%; height: {{ cost_percentage }}%; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 8px; background: linear-gradient(135deg, #dc3545, #fd7e14); color: white; border-radius: 8px 8px 0 0;">
                                            <div class="chart-label fw-bold mb-1" style="font-size: 0.8rem;">å£²ä¸ŠåŸä¾¡</div>
                                            <div class="chart-amount text-center fw-bold" style="font-size: 0.7rem; line-height: 1.2;">
                                                Â¥{{ financial_info.cost_of_sales|floatformat:0|intcomma }}
                                            </div>
                                        </div>
                                        <!-- ç²—åˆ©éƒ¨åˆ†ï¼ˆä¸‹éƒ¨ï¼‰ -->
                                        <div class="chart-section"
                                             style="width: 100%; height: {{ profit_percentage }}%; background: linear-gradient(135deg, #0d6efd, #6f42c1); display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 8px; color: white; border-radius: 0 0 8px 8px;">
                                            <div class="chart-label fw-bold mb-1" style="font-size: 0.8rem;">å£²ä¸Šç·åˆ©ç›Š</div>
                                            <div class="chart-amount text-center fw-bold" style="font-size: 0.7rem; line-height: 1.2;">
                                                Â¥{{ financial_info.gross_profit|floatformat:0|intcomma }}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="d-block text-primary fw-bold">ç²—åˆ©ç‡: {{ financial_info.gross_profit_rate|floatformat:1 }}%</small>
                            </div>
                        </div>
                    </div>

                    <!-- çµŒç†æƒ…å ±ãƒ†ãƒ¼ãƒ–ãƒ« -->
                    <div class="col-md-9">
                        <div class="table-responsive">
                    <table class="table table-sm">
                        <tbody>
                            <!-- åå…¥ -->
                            <tr style="background-color: rgba(25, 135, 84, 0.1);">
                                <td><strong>å£²ä¸Šï¼ˆå—æ³¨é¡ï¼‰</strong></td>
                                <td class="text-end"><strong>Â¥{{ financial_info.revenue|floatformat:0|intcomma }}</strong></td>
                            </tr>

                            <!-- å£²ä¸ŠåŸä¾¡ -->
                            <tr class="table-secondary">
                                <td><strong>å£²ä¸ŠåŸä¾¡</strong></td>
                                <td></td>
                            </tr>
                            <!-- ç™ºæ³¨è²»ç”¨è©³ç´° -->
                            {% if subcontracts %}
                                {% for subcontract in subcontracts %}
                                <tr class="table-light">
                                    <td style="padding-left: 20px;">
                                        <em>
                                            {% if subcontract.worker_type == 'external' %}
                                                {% if subcontract.contractor %}
                                                    {{ subcontract.contractor.name }}ï¼ˆå¤–æ³¨ï¼‰
                                                {% else %}
                                                    å¤–æ³¨å…ˆæœªè¨­å®š
                                                {% endif %}
                                            {% else %}
                                                {% if subcontract.internal_worker %}
                                                    {{ subcontract.internal_worker.name }}ï¼ˆç¤¾å†…ï¼‰
                                                {% elif subcontract.internal_worker_name %}
                                                    {{ subcontract.internal_worker_name }}ï¼ˆç¤¾å†…ï¼‰
                                                {% else %}
                                                    ç¤¾å†…æ‹…å½“è€…æœªè¨­å®š
                                                {% endif %}
                                            {% endif %}
                                        </em>
                                    </td>
                                    <td class="text-end">Â¥{{ subcontract.billed_amount|floatformat:0|intcomma }}</td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr class="table-light">
                                    <td style="padding-left: 20px;"><em>ç™ºæ³¨è²»ç”¨</em></td>
                                    <td class="text-end">Â¥0</td>
                                </tr>
                            {% endif %}
                            <tr class="table-light">
                                <td style="padding-left: 20px;"><em>ææ–™è²»</em></td>
                                <td class="text-end">Â¥{{ financial_info.material_cost|floatformat:0|intcomma }}</td>
                            </tr>
                            <tr style="background-color: rgba(220, 53, 69, 0.1);">
                                <td><strong>å£²ä¸ŠåŸä¾¡ å°è¨ˆ</strong></td>
                                <td class="text-end"><strong>Â¥{{ financial_info.cost_of_sales|floatformat:0|intcomma }}</strong></td>
                            </tr>

                            <!-- æ”¯å‡º - è²©å£²è²» -->
                            {% if financial_info.expense_1 > 0 %}
                            <tr class="table-light">
                                <td style="padding-left: 20px;"><em>{{ project.expense_item_1|default:"è«¸çµŒè²»â‘ " }}</em></td>
                                <td class="text-end">Â¥{{ financial_info.expense_1|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}
                            {% if financial_info.expense_2 > 0 %}
                            <tr class="table-light">
                                <td style="padding-left: 20px;"><em>{{ project.expense_item_2|default:"è«¸çµŒè²»â‘¡" }}</em></td>
                                <td class="text-end">Â¥{{ financial_info.expense_2|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}
                            {% if financial_info.parking_fee > 0 %}
                            <tr class="table-light">
                                <td style="padding-left: 20px;"><em>é§è»Šå ´ä»£</em></td>
                                <td class="text-end">Â¥{{ financial_info.parking_fee|floatformat:0|intcomma }}</td>
                            </tr>
                            {% endif %}

                            <!-- ç²—åˆ©ç›Šãƒ»åˆ©ç›Šç‡ -->
                            <tr style="background-color: rgba(13, 110, 253, 0.1);">
                                <td><strong>ç²—åˆ©ç›Š</strong></td>
                                <td class="text-end"><strong>Â¥{{ financial_info.gross_profit|floatformat:0|intcomma }}</strong></td>
                            </tr>
                            <tr class="table-info">
                                <td><strong>ç²—åˆ©ç‡</strong></td>
                                <td class="text-end">
                                    <strong class="fs-4">{{ financial_info.gross_profit_rate|floatformat:1 }}%</strong>
                                    <div class="progress mt-1" style="height: 8px;">
                                        <div class="progress-bar {% if financial_info.gross_profit_rate >= 30 %}bg-success{% elif financial_info.gross_profit_rate >= 15 %}bg-warning{% else %}bg-danger{% endif %}" role="progressbar"
                                             style="width: {{ financial_info.gross_profit_rate|floatformat:0|intcomma }}%" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è©³ç´°æƒ…å ± (æ”¹å–„ç‰ˆ - ã‚¿ãƒ–UI) -->
<div class="row mb-4">
    <div class="col-lg-12">
        <div class="card shadow-sm">
            <div class="card-header bg-gradient-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>æ¡ˆä»¶è©³ç´°æƒ…å ±</h5>
                <!-- è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ -->
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-light active" id="tabViewBtn" onclick="switchViewMode('tab')">
                        <i class="fas fa-th-large me-1"></i>ã‚¿ãƒ–è¡¨ç¤º
                    </button>
                    <button type="button" class="btn btn-light" id="fullViewBtn" onclick="switchViewMode('full')">
                        <i class="fas fa-list me-1"></i>å…¨ä½“è¡¨ç¤º
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
                <ul class="nav nav-tabs" id="projectDetailTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
                            <i class="fas fa-home me-1"></i>æ¦‚è¦
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="business-tab" data-bs-toggle="tab" data-bs-target="#business" type="button" role="tab">
                            <i class="fas fa-briefcase me-1"></i>æ¥­è€…ãƒ»æ‹…å½“
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="schedule-tab" data-bs-toggle="tab" data-bs-target="#schedule" type="button" role="tab">
                            <i class="fas fa-calendar-alt me-1"></i>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="finance-tab" data-bs-toggle="tab" data-bs-target="#finance" type="button" role="tab">
                            <i class="fas fa-yen-sign me-1"></i>è«‹æ±‚ãƒ»çµŒè²»
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab">
                            <i class="fas fa-sticky-note me-1"></i>å‚™è€ƒãƒ»ãã®ä»–
                        </button>
                    </li>
                </ul>

                <!-- ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
                <div class="tab-content p-4" id="projectDetailTabsContent">
                    <!-- æ¦‚è¦ã‚¿ãƒ– -->
                    <div class="tab-pane fade show active" id="overview" role="tabpanel" data-section-title="ğŸ“‹ æ¦‚è¦">
                        <div class="row g-3">
                            <!-- åŸºæœ¬æƒ…å ± -->
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-file-alt me-2"></i>åŸºæœ¬æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4 text-muted">ç®¡ç†No</dt>
                                        <dd class="col-sm-8 fw-bold">{{ project.management_no }}</dd>
                                        <dt class="col-sm-4 text-muted">ç¾å ´å</dt>
                                        <dd class="col-sm-8">{{ project.site_name }}</dd>
                                        <dt class="col-sm-4 text-muted">å·¥äº‹ç¨®åˆ¥</dt>
                                        <dd class="col-sm-8"><span class="badge bg-secondary">{{ project.work_type }}</span></dd>
                                        <dt class="col-sm-4 text-muted">ç¾å ´ä½æ‰€</dt>
                                        <dd class="col-sm-8">{{ project.site_address|default:"-" }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»é‡‘é¡ -->
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-success border-bottom pb-2 mb-3">
                                        <i class="fas fa-chart-line me-2"></i>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»é‡‘é¡
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">æ¡ˆä»¶é€²æ—</dt>
                                        <dd class="col-sm-7">
                                            {% with stage=project.get_current_project_stage %}
                                            <span class="badge bg-{{ stage.color }} fs-6">{{ stage.stage }}</span>
                                            {% endwith %}
                                        </dd>
                                        <dt class="col-sm-5 text-muted">å—æ³¨ãƒ¨ãƒŸ</dt>
                                        <dd class="col-sm-7">
                                            <select class="form-select form-select-sm order-forecast-select-detail"
                                                    data-project-id="{{ project.pk }}"
                                                    style="width: auto; display: inline-block; max-width: 150px;">
                                                {% for value, label in project.PROJECT_STATUS_CHOICES %}
                                                <option value="{{ value }}" {% if value == project.project_status %}selected{% endif %}>
                                                    {{ label }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </dd>
                                        <dt class="col-sm-5 text-muted">å—æ³¨é‡‘é¡</dt>
                                        <dd class="col-sm-7 text-primary fw-bold fs-5">Â¥{{ project.order_amount|floatformat:0|intcomma }}</dd>
                                        <dt class="col-sm-5 text-muted">å®Ÿè«‹æ±‚é¡</dt>
                                        <dd class="col-sm-7 text-success fw-bold fs-5">Â¥{{ project.billing_amount|floatformat:0|intcomma }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <!-- ãã®ä»–æƒ…å ± -->
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-info border-bottom pb-2 mb-3">
                                        <i class="fas fa-clipboard-list me-2"></i>ãã®ä»–è©³ç´°
                                    </h6>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-6 text-muted">è¦‹ç©æ›¸ç™ºè¡Œæ—¥</dt>
                                                <dd class="col-sm-6">{{ project.estimate_issued_date|date:"Y/m/d"|default:"-" }}</dd>
                                            </dl>
                                        </div>
                                        <div class="col-md-4">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-6 text-muted">é§è»Šå ´ä»£</dt>
                                                <dd class="col-sm-6">Â¥{{ project.parking_fee|floatformat:0|intcomma }}</dd>
                                            </dl>
                                        </div>
                                        <div class="col-md-4">
                                            <dl class="row mb-0">
                                                <dt class="col-sm-6 text-muted">å¢—æ¸›é¡</dt>
                                                <dd class="col-sm-6 {% if project.amount_difference > 0 %}text-success{% elif project.amount_difference < 0 %}text-danger{% endif %} fw-bold">
                                                    Â¥{{ project.amount_difference|floatformat:0|intcomma }}
                                                </dd>
                                            </dl>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ¥­è€…ãƒ»æ‹…å½“ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="business" role="tabpanel" data-section-title="ğŸ¢ æ¥­è€…ãƒ»æ‹…å½“">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-building me-2"></i>å…ƒè«‹æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4 text-muted">å…ƒè«‹å</dt>
                                        <dd class="col-sm-8 fw-bold">{{ project.client_name|default:"-" }}</dd>
                                        <dt class="col-sm-4 text-muted">å…ƒè«‹ä½æ‰€</dt>
                                        <dd class="col-sm-8">{{ project.client_address|default:"-" }}</dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-success border-bottom pb-2 mb-3">
                                        <i class="fas fa-user-tie me-2"></i>æ‹…å½“è€…æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4 text-muted">æ¡ˆä»¶æ‹…å½“</dt>
                                        <dd class="col-sm-8 fw-bold">{{ project.project_manager|default:"-" }}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="schedule" role="tabpanel" data-section-title="ğŸ“… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-calendar-check me-2"></i>å¥‘ç´„ãƒ»å·¥äº‹æ—¥ç¨‹
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">å¥‘ç´„æ—¥</dt>
                                        <dd class="col-sm-7">{{ project.contract_date|date:"Yå¹´mæœˆdæ—¥"|default:"-" }}</dd>
                                        <dt class="col-sm-5 text-muted">å·¥äº‹é–‹å§‹æ—¥</dt>
                                        <dd class="col-sm-7">{{ project.work_start_date|date:"Yå¹´mæœˆdæ—¥"|default:"-" }}</dd>
                                        <dt class="col-sm-5 text-muted">å·¥äº‹çµ‚äº†æ—¥</dt>
                                        <dd class="col-sm-7">{{ project.work_end_date|date:"Yå¹´mæœˆdæ—¥"|default:"-" }}</dd>
                                    </dl>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-success border-bottom pb-2 mb-3">
                                        <i class="fas fa-money-bill-wave me-2"></i>å…¥é‡‘äºˆå®š
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">å…¥é‡‘äºˆå®šæ—¥</dt>
                                        <dd class="col-sm-7 fw-bold">{{ project.payment_due_date|date:"Yå¹´mæœˆdæ—¥"|default:"-" }}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- è«‹æ±‚ãƒ»çµŒè²»ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="finance" role="tabpanel" data-section-title="ğŸ’° è«‹æ±‚ãƒ»çµŒè²»">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-file-invoice me-2"></i>è«‹æ±‚æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-3 text-muted">è«‹æ±‚æ›¸ç™ºè¡Œ</dt>
                                        <dd class="col-sm-3">
                                            {% if project.invoice_issued %}
                                            <span class="badge bg-success">ç™ºè¡Œæ¸ˆã¿</span>
                                            {% else %}
                                            <span class="badge bg-secondary">æœªç™ºè¡Œ</span>
                                            {% endif %}
                                        </dd>
                                        <dt class="col-sm-3 text-muted">å®Ÿè«‹æ±‚é¡</dt>
                                        <dd class="col-sm-3 text-success fw-bold fs-5">Â¥{{ project.billing_amount|floatformat:0|intcomma }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-warning border-bottom pb-2 mb-3">
                                        <i class="fas fa-receipt me-2"></i>è«¸çµŒè²»â‘ 
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">é …ç›®å</dt>
                                        <dd class="col-sm-7">{{ project.expense_item_1|default:"-" }}</dd>
                                        <dt class="col-sm-5 text-muted">é‡‘é¡</dt>
                                        <dd class="col-sm-7 fw-bold">Â¥{{ project.expense_amount_1|floatformat:0|intcomma }}</dd>
                                    </dl>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="info-group">
                                    <h6 class="text-warning border-bottom pb-2 mb-3">
                                        <i class="fas fa-receipt me-2"></i>è«¸çµŒè²»â‘¡
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-5 text-muted">é …ç›®å</dt>
                                        <dd class="col-sm-7">{{ project.expense_item_2|default:"-" }}</dd>
                                        <dt class="col-sm-5 text-muted">é‡‘é¡</dt>
                                        <dd class="col-sm-7 fw-bold">Â¥{{ project.expense_amount_2|floatformat:0|intcomma }}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å‚™è€ƒãƒ»ãã®ä»–ã‚¿ãƒ– -->
                    <div class="tab-pane fade" id="notes" role="tabpanel" data-section-title="ğŸ“ å‚™è€ƒãƒ»ãã®ä»–">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-primary border-bottom pb-2 mb-3">
                                        <i class="fas fa-comment-alt me-2"></i>å‚™è€ƒ
                                    </h6>
                                    {% if project.notes %}
                                        <div class="p-3 bg-light rounded">{{ project.notes|linebreaks }}</div>
                                    {% else %}
                                        <p class="text-muted fst-italic">å‚™è€ƒã¯ã‚ã‚Šã¾ã›ã‚“</p>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="info-group">
                                    <h6 class="text-secondary border-bottom pb-2 mb-3">
                                        <i class="fas fa-database me-2"></i>ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±
                                    </h6>
                                    <dl class="row mb-0">
                                        <dt class="col-sm-2 text-muted">ä½œæˆæ—¥æ™‚</dt>
                                        <dd class="col-sm-4">{{ project.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</dd>
                                        <dt class="col-sm-2 text-muted">æ›´æ–°æ—¥æ™‚</dt>
                                        <dd class="col-sm-4">{{ project.updated_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* è©³ç´°æƒ…å ±ã‚¿ãƒ–ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#projectDetailTabs .nav-link {
    color: #6c757d;
    font-weight: 500;
    border: none;
    border-bottom: 3px solid transparent;
    padding: 1rem 1.5rem;
    transition: all 0.3s ease;
}

#projectDetailTabs .nav-link:hover {
    color: #0d6efd;
    background: #f8f9fa;
    border-bottom-color: #dee2e6;
}

#projectDetailTabs .nav-link.active {
    color: #0d6efd;
    background: white;
    border-bottom-color: #0d6efd;
    font-weight: 600;
}

.info-group {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1.5rem;
    height: 100%;
}

.info-group h6 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.info-group dl {
    margin-bottom: 0;
}

.info-group dt {
    font-size: 0.875rem;
    padding: 0.5rem 0;
}

.info-group dd {
    font-size: 0.9375rem;
    padding: 0.5rem 0;
}

.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

/* è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.btn-group .btn-light.active {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
}

.btn-group .btn-light {
    transition: all 0.3s ease;
}

.btn-group .btn-light:hover:not(.active) {
    background-color: #e9ecef;
}

/* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
#projectDetailTabsContent .tab-pane {
    transition: all 0.3s ease;
}

/* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã‚¿ãƒ–ãƒ‘ãƒãƒ«é–“ã«ãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ  */
#projectDetailTabsContent.full-view-mode .tab-pane {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: white;
    border-radius: 8px;
    border: 1px solid #e2e8f0;
}

#projectDetailTabsContent.full-view-mode .tab-pane:last-child {
    margin-bottom: 0;
}

/* å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã§ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãƒ˜ãƒƒãƒ€ãƒ¼ */
#projectDetailTabsContent.full-view-mode .tab-pane::before {
    content: attr(data-section-title);
    display: block;
    font-size: 1.25rem;
    font-weight: 600;
    color: #0d6efd;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #0d6efd;
}
</style>

<!-- ãƒšãƒ¼ã‚¸æœ€ä¸‹éƒ¨ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
<div class="row mt-5 mb-4">
    <div class="col-12 text-center">
        <a href="{% url 'order_management:project_update' project.pk %}" class="btn btn-warning btn-lg">
            <i class="fas fa-edit"></i> ã“ã®æ¡ˆä»¶ã‚’ç·¨é›†
        </a>
    </div>
</div>

<!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">æ¡ˆä»¶å‰Šé™¤ã®ç¢ºèª</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ä»¥ä¸‹ã®æ¡ˆä»¶ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
                <p class="text-danger">
                    <strong>{{ project.management_no }} - {{ project.site_name }}</strong>
                </p>
                <p class="text-muted">ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
            </div>
            <div class="modal-footer">
                <form method="post" action="{% url 'order_management:project_delete' project.pk %}">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-danger">å‰Šé™¤ã™ã‚‹</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="stepDeleteModal" tabindex="-1" aria-labelledby="stepDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="stepDeleteModalLabel">
                    <i class="fas fa-exclamation-triangle me-2"></i>ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤ã®ç¢ºèª
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3"><strong id="stepDeleteName"></strong> ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</p>
                <div class="alert alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    å‰Šé™¤å¾Œã¯ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button type="button" class="btn btn-danger" id="confirmStepDelete">
                    <i class="fas fa-trash-alt me-2"></i>å‰Šé™¤ã™ã‚‹
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤å®Œäº†é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="stepDeleteSuccessModal" tabindex="-1" aria-labelledby="stepDeleteSuccessModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="stepDeleteSuccessModalLabel">
                    <i class="fas fa-check-circle me-2"></i>å‰Šé™¤å®Œäº†
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0"><strong id="stepDeleteSuccessName"></strong> ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚</p>
                <div class="alert alert-info mt-3 mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">
                    <i class="fas fa-check me-2"></i>OK
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®åˆæœŸåŒ–
var editMode = false;
var sortable = null;

// ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ï¼‰
function toggleEditMode() {
    editMode = !editMode;
    const btn = $('#editStepsBtn');

    if (editMode) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ON
        btn.html('<i class="fas fa-check"></i> ç·¨é›†å®Œäº†');
        btn.removeClass('btn-outline-primary').addClass('btn-success');
        $('.remove-step-btn').show();
        $('.drag-handle').show();
        $('#stepInventory').show();
        if (typeof loadAvailableSteps === 'function') {
            loadAvailableSteps();
        }
    } else {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰OFF - å¤‰æ›´ã‚’ä¿å­˜

        // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ä¿å­˜
        if (typeof saveStepOrder === 'function') {
            saveStepOrder();
        }

        // ã™ã¹ã¦ã®å‹•çš„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åé›†
        const dynamicFields = {};
        $('.progress-step[data-step]').each(function() {
            const stepKey = $(this).data('step');
            const stepElement = $(this);

            // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
            stepElement.find('input, select, textarea').each(function() {
                const fieldElement = $(this);
                const fieldName = fieldElement.attr('name');

                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!fieldName) return;

                let fieldValue;

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å ´åˆ
                if (fieldElement.is(':checkbox')) {
                    fieldValue = fieldElement.is(':checked') ? 'on' : '';
                } else if (fieldElement.is(':radio')) {
                    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
                    if (!fieldElement.is(':checked')) return;
                    fieldValue = fieldElement.val();
                } else {
                    fieldValue = fieldElement.val();
                }

                // åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆestimate, contract, work_start, work_end, invoiceï¼‰
                const isBasicField = ['estimate_issued_date', 'estimate_not_required', 'contract_date',
                                     'work_start_date', 'work_start_completed', 'work_end_date',
                                     'work_end_completed', 'invoice_issued'].includes(fieldName);

                // ã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç©ºã§ã‚‚POSTï¼ˆå‰Šé™¤ãƒ»ã‚¯ãƒªã‚¢æ“ä½œã‚’å¯èƒ½ã«ã™ã‚‹ãŸã‚ï¼‰
                // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã¯åŸºæœ¬ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ä»¥å¤–ã«è¿½åŠ 
                const finalFieldName = isBasicField ? fieldName :
                                      (fieldName.startsWith('dynamic_field_') ? fieldName : `dynamic_field_${fieldName}`);
                dynamicFields[finalFieldName] = fieldValue;

                // ãƒ‡ãƒãƒƒã‚°: estimateé–¢é€£ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ­ã‚°å‡ºåŠ›
                if (fieldName.includes('estimate')) {
                    console.log(`DEBUG: ${fieldName} = "${fieldValue}" (type: ${typeof fieldValue}, is checkbox: ${fieldElement.is(':checkbox')}, checked: ${fieldElement.is(':checked')})`);
                }
            });
        });

        console.log('Saving dynamic fields:', dynamicFields);
        console.log('DEBUG: estimate_not_required in POST?', 'estimate_not_required' in dynamicFields);
        console.log('DEBUG: estimate_not_required value:', dynamicFields.estimate_not_required);

        // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆAJAX - çµ±ä¸€ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: $.extend({
                csrfmiddlewaretoken: '{{ csrf_token }}',
                step_order: $('#stepOrderInput').val(),
                ajax_save: 'true'  // AJAXä¿å­˜ãƒ•ãƒ©ã‚°
            }, dynamicFields),
            success: function(response) {
                if (typeof toastr !== 'undefined') {
                    toastr.success('å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                }
                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æœ€æ–°ã®çŠ¶æ…‹ã‚’è¡¨ç¤º
                location.reload();
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }
        });

        // UIã‚’ç·¨é›†ãƒ¢ãƒ¼ãƒ‰OFFã«
        btn.html('<i class="fas fa-edit"></i> ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†');
        btn.removeClass('btn-success').addClass('btn-outline-primary');
        $('.remove-step-btn').hide();
        $('.drag-handle').hide();
        $('#stepInventory').hide();
    }

    // Sortableã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆ
    if (sortable) {
        sortable.option("disabled", !editMode);
    }
}

$(document).ready(function() {
    // ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
    $('#editStepsBtn').on('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        toggleEditMode();
    });

    // ä¾å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    $(document).on('change', 'input[type="radio"]', function() {
        const fieldName = $(this).attr('name');
        const selectedValue = $(this).val();

        // ã“ã®å¤‰æ›´ã«ã‚ˆã£ã¦å½±éŸ¿ã‚’å—ã‘ã‚‹ä¾å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
        $(`[data-dependency-field="${fieldName}"]`).each(function() {
            const requiredValue = $(this).data('dependency-value');
            if (selectedValue === requiredValue) {
                $(this).show();
            } else {
                $(this).hide();
            }
        });
    });

    // åˆæœŸçŠ¶æ…‹ã§æ–™é‡‘ä½“ç³»ã‚’è¨­å®šï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å®Ÿè¡Œï¼‰
    setTimeout(function() {
        console.log('ğŸ”„ Initializing pricing type on page load');
        console.log('ğŸ” All pricing elements exist at start:', {
            hourly: $('#hourlyPricingFields').length,
            project: $('#projectPricingFields').length,
            hourlyCard: $('#hourlyCard').length,
            projectCard: $('#projectCard').length
        });

        // åˆæœŸé¸æŠã•ã‚Œã¦ã„ã‚‹ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
        var selectedWorkerType = $('input[name="worker_type"]:checked').val();
        console.log('ğŸ” Selected worker type:', selectedWorkerType);

        // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ã€æ–™é‡‘ä½“ç³»ã‚’åˆæœŸåŒ–
        if (selectedWorkerType === 'internal') {
            $('#internalWorkerSection').show();
            console.log('ğŸ” Internal section shown');

            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ï¼ˆDOMæ›´æ–°å¾Œï¼‰
            setTimeout(function() {
                initializePricingType();

                var checkedRadio = $('input[name="internal_pricing_type"]:checked');
                console.log('ğŸ” Checked pricing radio found:', checkedRadio.length);
                if (checkedRadio.length > 0) {
                    checkedRadio.trigger('change');
                }
            }, 50);
        }
    }, 100);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ARIAå±æ€§ç®¡ç†
    $('#staffManagementModal, #staffModal').on('show.bs.modal', function() {
        console.log('ğŸ“‹ Modal showing - removing aria-hidden');
        $(this).removeAttr('aria-hidden');
    }).on('hide.bs.modal', function() {
        console.log('ğŸ“‹ Modal hiding - adding aria-hidden');
        $(this).attr('aria-hidden', 'true');
    }).on('shown.bs.modal', function() {
        console.log('ğŸ“‹ Modal shown - ensuring proper focus management');
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æœ€åˆã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯èƒ½ãªè¦ç´ ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        var firstFocusableElement = $(this).find('input, select, textarea, button').filter(':visible').first();
        if (firstFocusableElement.length) {
            setTimeout(function() {
                firstFocusableElement.focus();
            }, 100);
        }
    });

    // ä½œæ¥­è€…ã‚¿ã‚¤ãƒ—ã®åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="worker_type"]').on('change', function() {
        if ($(this).val() === 'external') {
            $('#externalWorkerSection').show();
            $('#internalWorkerSection').hide();
            $('#submitButtonText').text('ç™ºæ³¨å…ˆè¿½åŠ ');

            // å¤–æ³¨å…ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…é ˆã«
            $('#contractorSelect').attr('required', true);
            $('input[name="client_name"]').attr('required', false);

            // ç¤¾å†…ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éå¿…é ˆã«
            $('input[name="internal_worker_name"]').attr('required', false);
        } else {
            $('#externalWorkerSection').hide();
            $('#internalWorkerSection').show();
            $('#submitButtonText').text('ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹è¿½åŠ ');

            // ç¤¾å†…ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å¿…é ˆã«
            $('input[name="internal_worker_name"]').attr('required', true);

            // æ–™é‡‘ä½“ç³»ã®åˆæœŸåŒ–ã‚’å®Ÿè¡Œ
            setTimeout(function() {
                console.log('ğŸ”„ Initializing pricing type after internal switch');
                console.log('ğŸ” Internal section visible:', $('#internalWorkerSection').is(':visible'));
                console.log('ğŸ” Pricing elements exist:', $('#hourlyPricingFields').length, $('#projectPricingFields').length);

                initializePricingType();
                // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹æ–™é‡‘ä½“ç³»ã‚’å¼·åˆ¶çš„ã«é©ç”¨
                var checkedRadio = $('input[name="internal_pricing_type"]:checked');
                console.log('ğŸ” Checked radio found:', checkedRadio.length);
                if (checkedRadio.length > 0) {
                    checkedRadio.trigger('change');
                }
            }, 200);

            // å¤–æ³¨å…ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’éå¿…é ˆã«
            $('#contractorSelect').attr('required', false);
            $('input[name="client_name"]').attr('required', false);
        }
        updateCostBreakdown();
        updateProfitPreview();
    });

    // ç¤¾å†…æ‹…å½“è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="internal_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existingInternalDiv').show();
            $('#newInternalDiv').hide();
            $('#internalSelect').attr('required', true);
            $('input[name="internal_worker_name"]').attr('required', false);
        } else {
            $('#existingInternalDiv').hide();
            $('#newInternalDiv').show();
            $('#internalSelect').attr('required', false);
            $('input[name="internal_worker_name"]').attr('required', true);
        }
    });

    // æ—¢å­˜ç¤¾å†…æ‹…å½“è€…é¸æŠæ™‚ã®æƒ…å ±è‡ªå‹•å…¥åŠ›
    $('#internalSelect').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var department = selectedOption.data('department') || '';
        var hourlyRate = selectedOption.data('hourly-rate') || '';

        $('#internalDepartment').val(department);
        $('#internalHourlyRate').val(hourlyRate);

        // å·¥æ•°ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°è‡ªå‹•è¨ˆç®—
        calculateInternalCost();
    });

    // æ¥­è€…é¸æŠæ–¹æ³•ã®åˆ‡ã‚Šæ›¿ãˆ
    $('input[name="contractor_input_type"]').on('change', function() {
        if ($(this).val() === 'existing') {
            $('#existingContractorDiv').show();
            $('#newContractorDiv').hide();
            $('#contractorSelect').attr('required', true);
            $('input[name="client_name"]').attr('required', false);
        } else {
            $('#existingContractorDiv').hide();
            $('#newContractorDiv').show();
            $('#contractorSelect').attr('required', false);
            $('input[name="client_name"]').attr('required', true);
        }
    });

    // æ—¢å­˜æ¥­è€…é¸æŠæ™‚ã®ä½æ‰€è‡ªå‹•å…¥åŠ›
    $('#contractorSelect').on('change', function() {
        var selectedOption = $(this).find('option:selected');
        var address = selectedOption.data('address') || '';
        $('#contractorAddress').val(address);
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆä¿®æ­£ç‰ˆï¼‰
    $(document).on('change', 'input[name="modal_internal_pricing_type"]', function() {
        var pricingType = $(this).val();
        console.log('========================');
        console.log('ğŸ”¥ Modal Pricing type changed to:', pricingType);
        console.log('ğŸ” Event target element:', $(this)[0]);
        console.log('ğŸ” Parent modal visible:', $(this).closest('#addImplementationModal').is(':visible'));

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨è¦ç´ ã®å­˜åœ¨ç¢ºèª
        var hourlyFields = $('#modalHourlyPricingFields');
        var projectFields = $('#modalProjectPricingFields');

        console.log('ğŸ¯ Modal Elements found:');
        console.log('  - modalHourlyPricingFields:', hourlyFields.length, 'visible:', hourlyFields.is(':visible'));
        console.log('  - modalProjectPricingFields:', projectFields.length, 'visible:', projectFields.is(':visible'));

        console.log('ğŸ”§ Before changes:');
        console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
        console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));

        if (pricingType === 'hourly') {
            console.log('ğŸ”§ Setting modal to hourly mode');
            $('#modalHourlyPricingFields').show();
            $('#modalProjectPricingFields').hide();
            console.log('ğŸ”§ After hourly changes:');
            console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
            console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));
        } else {
            console.log('ğŸ”§ Setting modal to project mode');
            $('#modalHourlyPricingFields').hide();
            $('#modalProjectPricingFields').show();
            console.log('ğŸ”§ After project changes:');
            console.log('  - modalHourlyPricingFields visible:', $('#modalHourlyPricingFields').is(':visible'));
            console.log('  - modalProjectPricingFields visible:', $('#modalProjectPricingFields').is(':visible'));
        }
        console.log('========================');
    });

    // ãƒšãƒ¼ã‚¸å†…ãƒ•ã‚©ãƒ¼ãƒ ã®æ–™é‡‘ä½“ç³»ã®åˆ‡ã‚Šæ›¿ãˆï¼ˆè©³ç´°ãƒ‡ãƒãƒƒã‚°ä»˜ãï¼‰
    $(document).on('change', 'input[name="internal_pricing_type"]', function() {
        var pricingType = $(this).val();
        console.log('========================');
        console.log('ğŸ”¥ Pricing type changed to:', pricingType);
        console.log('ğŸ” Event target element:', $(this)[0]);
        console.log('ğŸ” Parent container visible:', $(this).closest('#internalWorkerSection').is(':visible'));

        // è¦ç´ ã®å­˜åœ¨ç¢ºèª
        var hourlyFields = $('#hourlyPricingFields');
        var projectFields = $('#projectPricingFields');
        var hourlyCard = $('#hourlyCard');
        var projectCard = $('#projectCard');

        console.log('ğŸ¯ Elements found:');
        console.log('  - hourlyPricingFields:', hourlyFields.length, 'visible:', hourlyFields.is(':visible'));
        console.log('  - projectPricingFields:', projectFields.length, 'visible:', projectFields.is(':visible'));
        console.log('  - hourlyCard:', hourlyCard.length, 'visible:', hourlyCard.is(':visible'));
        console.log('  - projectCard:', projectCard.length, 'visible:', projectCard.is(':visible'));

        // ã‚«ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        $('.pricing-type-card').removeClass('border-primary bg-light');
        console.log('ğŸ”§ Before changes:');
        console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
        console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));

        if (pricingType === 'hourly') {
            console.log('ğŸ”§ Setting to hourly mode');
            $('#hourlyCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
            console.log('ğŸ”§ After hourly changes:');
            console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
            console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));
            $('#contractAmountHint').text('æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ã®å ´åˆã¯æ™‚çµ¦ Ã— å·¥æ•° + è¿½åŠ è²»ç”¨ã§è‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™');
            $('#internalContractAmount').prop('readonly', true);
            $('#costItemsLabel').text('è¿½åŠ è²»ç”¨é …ç›®');
            $('#addCostItemText').text('è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ');
            $('#costItemsLabel2').text('è¿½åŠ è²»ç”¨åˆè¨ˆ: Â¥');
            $('#contractAmountLabel').text('ä½œæ¥­è²»ç”¨ï¼ˆåŸºæœ¬æ–™é‡‘ + è¿½åŠ è²»ç”¨ï¼‰');
        } else {
            console.log('ğŸ”§ Setting to project mode');
            $('#projectCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
            console.log('ğŸ”§ After project changes:');
            console.log('  - hourlyPricingFields visible:', $('#hourlyPricingFields').is(':visible'));
            console.log('  - projectPricingFields visible:', $('#projectPricingFields').is(':visible'));
            $('#contractAmountHint').text('æ¡ˆä»¶å˜ä½ã®å ´åˆã¯å¥‘ç´„é‡‘é¡ + è¿½åŠ è²»ç”¨ã§è¨ˆç®—ã•ã‚Œã¾ã™');
            $('#internalContractAmount').prop('readonly', true);
            $('#costItemsLabel').text('è¿½åŠ è²»ç”¨é …ç›®');
            $('#addCostItemText').text('è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ');
            $('#costItemsLabel2').text('è¿½åŠ è²»ç”¨åˆè¨ˆ: Â¥');
            $('#contractAmountLabel').text('ä½œæ¥­è²»ç”¨ï¼ˆå¥‘ç´„é‡‘é¡ + è¿½åŠ è²»ç”¨ï¼‰');
        }
        calculateInternalCost();
        updateProfitPreview();
        console.log('========================');
    });

    // æ‰‹å‹•ãƒ‡ãƒãƒƒã‚°ç”¨ã®é–¢æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¿½åŠ 
    window.debugPricingSystem = function() {
        console.log('ğŸ› Manual Pricing System Debug:');
        console.log('  - Internal section visible:', $('#internalWorkerSection').is(':visible'));
        console.log('  - Pricing radio buttons found:', $('input[name="internal_pricing_type"]').length);
        console.log('  - Currently checked:', $('input[name="internal_pricing_type"]:checked').val());
        console.log('  - hourlyPricingFields exists:', $('#hourlyPricingFields').length, 'visible:', $('#hourlyPricingFields').is(':visible'));
        console.log('  - projectPricingFields exists:', $('#projectPricingFields').length, 'visible:', $('#projectPricingFields').is(':visible'));
        console.log('  - hourlyCard exists:', $('#hourlyCard').length);
        console.log('  - projectCard exists:', $('#projectCard').length);

        // å¼·åˆ¶çš„ã«åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
        console.log('ğŸ§ª Testing force toggle to project mode:');
        $('#projectPricing').prop('checked', true).trigger('change');
    };

    window.debugModalPricingSystem = function() {
        console.log('ğŸ› Modal Pricing System Debug:');
        console.log('  - Modal visible:', $('#addImplementationModal').is(':visible'));
        console.log('  - Modal pricing radio buttons found:', $('input[name="modal_internal_pricing_type"]').length);
        console.log('  - Currently checked:', $('input[name="modal_internal_pricing_type"]:checked').val());
        console.log('  - modalHourlyPricingFields exists:', $('#modalHourlyPricingFields').length, 'visible:', $('#modalHourlyPricingFields').is(':visible'));
        console.log('  - modalProjectPricingFields exists:', $('#modalProjectPricingFields').length, 'visible:', $('#modalProjectPricingFields').is(':visible'));

        // å¼·åˆ¶çš„ã«åˆ‡ã‚Šæ›¿ãˆãƒ†ã‚¹ãƒˆ
        console.log('ğŸ§ª Testing force toggle to modal project mode:');
        $('#modalProjectPricing').prop('checked', true).trigger('change');
    };

    window.testToggleToProject = function() {
        console.log('ğŸ§ª Manually triggering project mode');
        $('#projectPricing').prop('checked', true).trigger('change');
    };

    window.testToggleToHourly = function() {
        console.log('ğŸ§ª Manually triggering hourly mode');
        $('#hourlyPricing').prop('checked', true).trigger('change');
    };

    window.testModalToggleToProject = function() {
        console.log('ğŸ§ª Manually triggering modal project mode');
        $('#modalProjectPricing').prop('checked', true).trigger('change');
    };

    window.testModalToggleToHourly = function() {
        console.log('ğŸ§ª Manually triggering modal hourly mode');
        $('#modalHourlyPricing').prop('checked', true).trigger('change');
    };

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®ä½œæ¥­è²»ç”¨è‡ªå‹•è¨ˆç®—
    function calculateInternalCost() {
        var pricingType = $('input[name="internal_pricing_type"]:checked').val();

        if (pricingType === 'hourly') {
            // æ™‚çµ¦ãƒ™ãƒ¼ã‚¹ï¼šåŸºæœ¬æ–™é‡‘ + è¿½åŠ è²»ç”¨
            var hourlyRate = parseFloat($('input[name="internal_hourly_rate"]').val()) || 0;
            var hours = parseFloat($('input[name="estimated_hours"]').val()) || 0;
            var baseAmount = hourlyRate * hours;

            var additionalCost = 0;
            $('.cost-item-input').each(function() {
                additionalCost += parseFloat($(this).val()) || 0;
            });

            var total = baseAmount + additionalCost;
            $('#internalContractAmount').val(total);

            // å†…è¨³è¡¨ç¤ºã‚’æ›´æ–°
            $('#baseAmount').text(baseAmount.toLocaleString());
            $('#additionalAmount').text(additionalCost.toLocaleString());
            $('#workSubtotal').text(total.toLocaleString());
            $('#hourlyBreakdown').show();
            $('#projectBreakdown').hide();
        } else if (pricingType === 'project') {
            // æ¡ˆä»¶å˜ä½ï¼šå¥‘ç´„é‡‘é¡ + è¿½åŠ è²»ç”¨
            var contractAmount = parseFloat($('#projectContractAmount').val()) || 0;

            var additionalCost = 0;
            $('.cost-item-input').each(function() {
                additionalCost += parseFloat($(this).val()) || 0;
            });

            var total = contractAmount + additionalCost;
            $('#internalContractAmount').val(total);

            // å†…è¨³è¡¨ç¤ºã‚’æ›´æ–°
            $('#projectBaseAmount').text(contractAmount.toLocaleString());
            $('#projectAdditionalAmount').text(additionalCost.toLocaleString());
            $('#projectSubtotal').text(total.toLocaleString());
            $('#hourlyBreakdown').hide();
            $('#projectBreakdown').show();
        }

        updateCostBreakdown();
        updateProfitPreview();
    }

    // è²»ç”¨å†…è¨³ã®æ›´æ–°
    function updateCostBreakdown() {
        var workerType = $('input[name="worker_type"]:checked').val();
        var materialCost = 0;
        var workCost = 0;

        if (workerType === 'external') {
            // å¤–æ³¨å…ˆã®å ´åˆ
            workCost = parseFloat($('input[name="contract_amount"]').val()) || 0;
            var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;
            $('.external-material-cost-input').each(function() {
                materialCost += parseFloat($(this).val()) || 0;
            });

            $('#externalContractAmount').text(workCost.toLocaleString());
            $('#externalBilledAmount').text(billedAmount.toLocaleString());
            $('#externalMaterialSubtotal').text(materialCost.toLocaleString());
            $('#externalGrandTotal').text((Math.max(workCost, billedAmount) + materialCost).toLocaleString());
        } else {
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®å ´åˆ
            workCost = parseFloat($('#internalContractAmount').val()) || 0;
            $('.internal-material-cost-input').each(function() {
                materialCost += parseFloat($(this).val()) || 0;
            });
        }

        // å…±é€šã®éƒ¨æè²»è¡¨ç¤ºæ›´æ–°
        $('#materialSubtotal').text(materialCost.toLocaleString());

        // ç·åˆè¨ˆã®æ›´æ–°
        var grandTotal = workCost + materialCost;
        $('#grandTotal').text(grandTotal.toLocaleString());
    }

    // æ™‚çµ¦ã¨å·¥æ•°ã®å¤‰æ›´ã‚’ç›£è¦–
    $('input[name="internal_hourly_rate"], input[name="estimated_hours"]').on('input', calculateInternalCost);

    // æ¡ˆä»¶å˜ä½ã®å¥‘ç´„é‡‘é¡å¤‰æ›´ã‚’ç›£è¦–
    $('#projectContractAmount').on('input', calculateInternalCost);

    // åˆæœŸçŠ¶æ…‹ã®è¨­å®š
    function initializePricingType() {
        var pricingType = $('input[name="internal_pricing_type"]:checked').val();
        console.log('ğŸ”§ Initializing pricing type:', pricingType);
        console.log('ğŸ¯ Hourly fields element:', $('#hourlyPricingFields').length);
        console.log('ğŸ¯ Project fields element:', $('#projectPricingFields').length);
        console.log('ğŸ¯ Hourly card element:', $('#hourlyCard').length);
        console.log('ğŸ¯ Project card element:', $('#projectCard').length);

        $('.pricing-type-card').removeClass('border-primary bg-light');

        if (pricingType === 'hourly') {
            console.log('ğŸ”§ Initializing as hourly');
            $('#hourlyCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').show();
            $('#projectPricingFields').hide();
        } else if (pricingType === 'project') {
            console.log('ğŸ”§ Initializing as project');
            $('#projectCard').addClass('border-primary bg-light');
            $('#hourlyPricingFields').hide();
            $('#projectPricingFields').show();
        } else {
            console.log('âš ï¸ Unknown pricing type:', pricingType);
        }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–å®Ÿè¡Œ
    initializePricingType();

    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§æ–™é‡‘ä½“ç³»åˆ‡ã‚Šæ›¿ãˆ
    $(document).on('click', '.pricing-type-card', function() {
        console.log('ğŸ¯ Card clicked');
        var targetRadio = $(this).find('input[type="radio"]');
        console.log('ğŸ“» Radio found:', targetRadio.length);
        targetRadio.prop('checked', true).trigger('change');
    });

    // æš«å®šåˆ©ç›Šç‡ã®è¨ˆç®—ã¨è¡¨ç¤ºï¼ˆè©³ç´°ç‰ˆï¼‰
    function updateProfitPreview() {
        var revenue = parseFloat("{{ project.billing_amount|default:0 }}".replace(/,/g, '')) || 0;
        var newWorkCost = 0;
        var newMaterialCost = 0;

        // ç¾åœ¨å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ä½œæ¥­è²»ç”¨ã‚’å–å¾—
        if ($('input[name="worker_type"]:checked').val() === 'external') {
            newWorkCost = parseFloat($('input[name="contract_amount"]').val()) || 0;
            var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;
            newWorkCost = Math.max(newWorkCost, billedAmount); // ã‚ˆã‚Šé«˜ã„æ–¹ã‚’ä½¿ç”¨

            // å¤–æ³¨å…ˆã®éƒ¨æè²»åˆè¨ˆ
            $('.external-material-cost-input').each(function() {
                newMaterialCost += parseFloat($(this).val()) || 0;
            });
        } else {
            newWorkCost = parseFloat($('#internalContractAmount').val()) || 0;
            // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ã®éƒ¨æè²»åˆè¨ˆ
            $('.internal-material-cost-input').each(function() {
                newMaterialCost += parseFloat($(this).val()) || 0;
            });
        }

        var existingCost = parseFloat("{{ existing_total_cost|default:0 }}".replace(/,/g, '')) || 0;
        var totalCost = existingCost + newWorkCost + newMaterialCost;
        var grossProfit = revenue - totalCost;
        var profitRate = revenue > 0 ? (grossProfit / revenue * 100) : 0;

        // è©³ç´°è¡¨ç¤ºã‚’æ›´æ–°
        $('#previewRevenue').text(revenue.toLocaleString());
        $('#previewExistingCost').text(existingCost.toLocaleString());
        $('#previewNewWorkCost').text(newWorkCost.toLocaleString());
        $('#previewNewMaterialCost').text(newMaterialCost.toLocaleString());
        $('#previewTotalCost').text(totalCost.toLocaleString());
        $('#previewGrossProfit').text(grossProfit.toLocaleString());
        $('#previewProfitRate').text(profitRate.toFixed(1) + '%');

        // åˆ©ç›Šç‡ã«å¿œã˜ã¦è‰²ã¨ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
        var rateElement = $('#previewProfitRate');
        var progressBar = $('#profitRateBar');

        rateElement.removeClass('text-success text-warning text-danger');
        progressBar.removeClass('bg-success bg-warning bg-danger');

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®å¹…ã‚’è¨­å®šï¼ˆæœ€å¤§50%ã¾ã§è¡¨ç¤ºï¼‰
        var displayRate = Math.min(profitRate, 50);
        progressBar.css('width', displayRate + '%');

        // åˆ©ç›Šç‡ã«å¿œã˜ãŸè‰²åˆ†ã‘
        if (profitRate >= 30) {
            rateElement.addClass('text-success');
            progressBar.addClass('bg-success');
        } else if (profitRate >= 15) {
            rateElement.addClass('text-warning');
            progressBar.addClass('bg-warning');
        } else {
            rateElement.addClass('text-danger');
            progressBar.addClass('bg-danger');
        }

        // æ–°è¦è²»ç”¨ãŒã‚ã‚‹å ´åˆã®ã¿è¡Œã‚’è¡¨ç¤º
        if (newWorkCost > 0) {
            $('#newCostRow').show();
        } else {
            $('#newCostRow').hide();
        }

        if (newMaterialCost > 0) {
            $('#newMaterialRow').show();
        } else {
            $('#newMaterialRow').hide();
        }

        // åˆ©ç›Šç‡ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å¸¸ã«è¡¨ç¤ºï¼ˆå†…å®¹ã‚’å‹•çš„ã«æ›´æ–°ï¼‰
        // å…¥åŠ›ãŒãªã„å ´åˆã§ã‚‚ç¾åœ¨ã®çŠ¶æ³ã‚’è¡¨ç¤º
    }

    // é‡‘é¡ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆå¤–æ³¨å…ˆç”¨ï¼‰
    $('input[name="contract_amount"], input[name="billed_amount"]').on('input', function() {
        updateCostBreakdown();
        updateProfitPreview();
    });

    // éƒ¨æè²»åˆè¨ˆã®è‡ªå‹•è¨ˆç®—
    function calculateMaterialTotal() {
        var total = 0;
        $('.material-cost').each(function() {
            var value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#totalMaterialCost').val(total);
    }

    // éƒ¨æè²»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–
    $('.material-cost').on('input', calculateMaterialTotal);

    // åˆæœŸè¨ˆç®—
    calculateMaterialTotal();

    // å‹•çš„éƒ¨æè²»é …ç›®ç®¡ç†
    let materialItemCounter = 0;
    let externalMaterialItemCounter = 0;

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹ç”¨éƒ¨æè²»é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addMaterialItem(item = '', cost = 0) {
        materialItemCounter++;
        const itemHtml = `
            <div class="material-item mb-2" data-item-id="${materialItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="internal_material_items[]" class="form-control"
                               placeholder="éƒ¨æè²»é …ç›®" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" name="internal_material_costs[]" class="form-control internal-material-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-material-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#materialCostSection').append(itemHtml);
        updateInternalMaterialTotal();
    }

    // å¤–æ³¨å…ˆç”¨éƒ¨æè²»é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addExternalMaterialItem(item = '', cost = 0) {
        externalMaterialItemCounter++;
        const itemHtml = `
            <div class="external-material-item mb-2" data-item-id="${externalMaterialItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="material_items[]" class="form-control"
                               placeholder="éƒ¨æè²»é …ç›®" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" name="material_costs[]" class="form-control external-material-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-external-material-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#externalMaterialCostSection').append(itemHtml);
        updateExternalMaterialTotal();
    }

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹éƒ¨æè²»åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateInternalMaterialTotal() {
        let total = 0;
        $('.internal-material-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#materialTotal').text(total.toLocaleString());
        updateCostBreakdown();
        updateProfitPreview();
    }

    // å¤–æ³¨å…ˆéƒ¨æè²»åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateExternalMaterialTotal() {
        let total = 0;
        $('.external-material-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#externalMaterialTotal').text(total.toLocaleString());
        $('#externalMaterialSubtotal').text(total.toLocaleString());
        updateExternalCostBreakdown();
        updateProfitPreview();
    }

    // å¤–æ³¨å…ˆç”¨è¿½åŠ è²»ç”¨é …ç›®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    let externalAdditionalCostItemCounter = 0;

    // å¤–æ³¨å…ˆç”¨è¿½åŠ è²»ç”¨é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addExternalAdditionalCostItem(item = '', cost = 0) {
        externalAdditionalCostItemCounter++;
        const itemHtml = `
            <div class="external-additional-cost-item mb-2" data-item-id="${externalAdditionalCostItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="additional_cost_items[]" class="form-control"
                               placeholder="è¿½åŠ è²»ç”¨é …ç›®" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" name="additional_cost_amounts[]" class="form-control external-additional-cost-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-external-additional-cost-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#externalAdditionalCostSection').append(itemHtml);
        updateExternalAdditionalCostTotal();
    }

    // å¤–æ³¨å…ˆè¿½åŠ è²»ç”¨åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateExternalAdditionalCostTotal() {
        let total = 0;
        $('.external-additional-cost-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#externalAdditionalCostTotal').text(total.toLocaleString());
        $('#externalAdditionalCostSubtotal').text(total.toLocaleString());
        updateExternalCostBreakdown();
        updateProfitPreview();
    }

    // å¤–æ³¨å…ˆè²»ç”¨å†…è¨³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateExternalCostBreakdown() {
        var contractAmount = parseFloat($('input[name="contract_amount"]').val()) || 0;
        var billedAmount = parseFloat($('input[name="billed_amount"]').val()) || 0;

        var materialCost = 0;
        $('.external-material-cost-input').each(function() {
            materialCost += parseFloat($(this).val()) || 0;
        });

        var additionalCost = 0;
        $('.external-additional-cost-input').each(function() {
            additionalCost += parseFloat($(this).val()) || 0;
        });

        $('#externalContractAmount').text(contractAmount.toLocaleString());
        $('#externalBilledAmount').text(billedAmount.toLocaleString());
        $('#externalMaterialSubtotal').text(materialCost.toLocaleString());
        $('#externalAdditionalCostSubtotal').text(additionalCost.toLocaleString());

        var grandTotal = Math.max(contractAmount, billedAmount) + materialCost + additionalCost;
        $('#externalGrandTotal').text(grandTotal.toLocaleString());
    }

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹éƒ¨æè²»é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#addMaterialBtn').on('click', function() {
        addMaterialItem();
    });

    // å¤–æ³¨å…ˆéƒ¨æè²»é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#addExternalMaterialBtn').on('click', function() {
        addExternalMaterialItem();
    });

    // å¤–æ³¨å…ˆè¿½åŠ è²»ç”¨é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#addExternalAdditionalCostBtn').on('click', function() {
        addExternalAdditionalCostItem();
    });

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹éƒ¨æè²»é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('click', '.remove-material-btn', function() {
        $(this).closest('.material-item').remove();
        updateInternalMaterialTotal();
    });

    // å¤–æ³¨å…ˆéƒ¨æè²»é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('click', '.remove-external-material-btn', function() {
        $(this).closest('.external-material-item').remove();
        updateExternalMaterialTotal();
    });

    // å¤–æ³¨å…ˆè¿½åŠ è²»ç”¨é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('click', '.remove-external-additional-cost-btn', function() {
        $(this).closest('.external-additional-cost-item').remove();
        updateExternalAdditionalCostTotal();
    });

    // ç¤¾å†…ãƒªã‚½ãƒ¼ã‚¹éƒ¨æè²»é‡‘é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.internal-material-cost-input', function() {
        updateInternalMaterialTotal();
    });

    // å¤–æ³¨å…ˆéƒ¨æè²»é‡‘é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.external-material-cost-input', function() {
        updateExternalMaterialTotal();
    });

    // å¤–æ³¨å…ˆè¿½åŠ è²»ç”¨é‡‘é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.external-additional-cost-input', function() {
        updateExternalAdditionalCostTotal();
    });

    // å¤–æ³¨å…ˆå¥‘ç´„é‡‘é¡ãƒ»è¢«è«‹æ±‚é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', 'input[name="contract_amount"], input[name="billed_amount"]', function() {
        updateExternalCostBreakdown();
        updateProfitPreview();
    });

    // æ‹…å½“è€…é¸æŠè¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('click', '.add-staff-select-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const containerId = $(this).data('container-id');
        const fieldName = $(this).data('field-name');
        const container = $(`#${containerId}`);

        // ã‚¹ã‚¿ãƒƒãƒ•ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ç”Ÿæˆ
        const staffOptions = generateStaffOptions();
        let optionsHtml = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        if (staffOptions && Array.isArray(staffOptions)) {
            staffOptions.forEach(option => {
                optionsHtml += `<option value="${option.value}">${option.text}</option>`;
            });
        }

        // æ–°ã—ã„selectãƒœãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
        const newSelect = `
            <div class="staff-select-item mb-2">
                <select name="${fieldName}" class="form-select form-select-sm d-inline-block" style="width: calc(100% - 50px);">
                    ${optionsHtml}
                </select>
                <button type="button" class="btn btn-outline-danger btn-sm remove-staff-select-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        container.append(newSelect);

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤ºï¼ˆ2ã¤ä»¥ä¸Šã®å ´åˆï¼‰
        if (container.find('.staff-select-item').length > 1) {
            container.find('.remove-staff-select-btn').show();
        }
    });

    // æ‹…å½“è€…é¸æŠå‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('click', '.remove-staff-select-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const item = $(this).closest('.staff-select-item');
        const container = item.closest('.staff-select-container');

        item.remove();

        // 1ã¤ã—ã‹ãªã„å ´åˆã¯å‰Šé™¤ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        if (container.find('.staff-select-item').length <= 1) {
            container.find('.remove-staff-select-btn').hide();
        }
    });

    // å€‹åˆ¥ã‚¹ãƒ†ãƒƒãƒ—ä¿å­˜ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $(document).on('click', '.save-step-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        const stepKey = $(this).data('step');
        const stepElement = $(`.progress-step[data-step="${stepKey}"]`);

        if (stepElement.length === 0) {
            console.error('Step element not found:', stepKey);
            return;
        }

        // ã“ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’åé›†
        const dynamicFields = {};
        stepElement.find('input, select, textarea').each(function() {
            const fieldElement = $(this);
            const fieldName = fieldElement.attr('name');

            // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
            if (!fieldName) return;

            let fieldValue;

            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å ´åˆ
            if (fieldElement.is(':checkbox')) {
                fieldValue = fieldElement.is(':checked') ? 'true' : 'false';
            } else if (fieldElement.is(':radio')) {
                // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
                if (!fieldElement.is(':checked')) return;
                fieldValue = fieldElement.val();
            } else if (fieldElement.is('select[multiple]')) {
                // è¤‡æ•°é¸æŠã®å ´åˆ
                const selectedValues = fieldElement.val();
                if (selectedValues && selectedValues.length > 0) {
                    fieldValue = selectedValues.join(',');
                } else {
                    return; // ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                }
            } else {
                fieldValue = fieldElement.val();
            }

            // å€¤ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ 
            if (fieldValue !== undefined && fieldValue !== '') {
                // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ï¼ˆã¾ã ãªã„å ´åˆï¼‰
                const finalFieldName = fieldName.startsWith('dynamic_field_') ? fieldName : `dynamic_field_${fieldName}`;
                dynamicFields[finalFieldName] = fieldValue;
            }
        });

        console.log('Saving step:', stepKey, dynamicFields);

        // ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆAJAXï¼‰
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: $.extend({
                csrfmiddlewaretoken: '{{ csrf_token }}',
                ajax_save: 'true'  // AJAXä¿å­˜ãƒ•ãƒ©ã‚°
            }, dynamicFields),
            success: function(response) {
                if (typeof toastr !== 'undefined') {
                    toastr.success(`${stepKey}ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                } else {
                    alert(`${stepKey}ã‚¹ãƒ†ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
                }
                // é€²æ—çŠ¶æ³ã‚’æ›´æ–°
                updateProgressTimeline();
                updateProgressStatus();
            },
            error: function(xhr, status, error) {
                console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
                if (typeof toastr !== 'undefined') {
                    toastr.error('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                } else {
                    alert('ä¿å­˜ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
            }
        });
    });

    // åˆæœŸéƒ¨æè²»é …ç›®ã‚’1ã¤è¿½åŠ 
    addMaterialItem();
    addExternalMaterialItem();
    addExternalAdditionalCostItem();

    // å‹•çš„è²»ç”¨é …ç›®ç®¡ç†
    let costItemCounter = 0;

    // è²»ç”¨é …ç›®ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    function addCostItem(item = '', cost = 0) {
        costItemCounter++;
        const itemHtml = `
            <div class="cost-item mb-2" data-item-id="${costItemCounter}">
                <div class="row">
                    <div class="col-6">
                        <input type="text" name="cost_items[]" class="form-control"
                               placeholder="è²»ç”¨é …ç›®å" value="${item}">
                    </div>
                    <div class="col-4">
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" name="cost_amounts[]" class="form-control cost-item-input"
                                   value="${cost}" placeholder="0">
                        </div>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-outline-danger btn-sm remove-cost-item-btn">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
        $('#costItemsSection').append(itemHtml);
        updateCostItemsTotal();
    }

    // è²»ç”¨é …ç›®åˆè¨ˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateCostItemsTotal() {
        let total = 0;
        $('.cost-item-input').each(function() {
            const value = parseFloat($(this).val()) || 0;
            total += value;
        });
        $('#costItemsTotal').text(total.toLocaleString());
        calculateInternalCost(); // ã“ã‚ŒãŒ updateCostBreakdown ã¨ updateProfitPreview ã‚’å‘¼ã¶
    }

    // è²»ç”¨é …ç›®è¿½åŠ ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
    $('#addCostItemBtn').on('click', function() {
        addCostItem();
    });

    // è²»ç”¨é …ç›®å‰Šé™¤ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆã‚¤ãƒ™ãƒ³ãƒˆå§”è­²ï¼‰
    $(document).on('click', '.remove-cost-item-btn', function() {
        $(this).closest('.cost-item').remove();
        updateCostItemsTotal();
    });

    // è²»ç”¨é …ç›®é‡‘é¡ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('input', '.cost-item-input', function() {
        updateCostItemsTotal();
    });

    // åˆæœŸè²»ç”¨é …ç›®ã‚’1ã¤è¿½åŠ 
    addCostItem();

    // åˆæœŸè¡¨ç¤ºæ™‚ã«åˆ©ç›Šç‡ã‚’è¨ˆç®—ãƒ»è¡¨ç¤º
    updateProfitPreview();

    // ç¸¦å‹ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†ï¼ˆå±•é–‹/æŠ˜ã‚ŠãŸãŸã¿ï¼‰
    $(document).on('click', '.progress-step', function(e) {
        // å‰Šé™¤ãƒœã‚¿ãƒ³ã€ç·¨é›†ãƒœã‚¿ãƒ³ã€ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã€ãƒ•ã‚©ãƒ¼ãƒ è¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
        if ($(e.target).hasClass('remove-step-btn') || $(e.target).closest('.remove-step-btn').length ||
            $(e.target).hasClass('btn') || $(e.target).closest('.btn').length ||
            $(e.target).hasClass('drag-handle') || $(e.target).closest('.drag-handle').length ||
            $(e.target).is('input, select, textarea') || $(e.target).closest('input, select, textarea').length) {
            return;
        }

        const $clickedStep = $(this);
        const isCurrentlyExpanded = $clickedStep.hasClass('expanded');

        // å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’æŠ˜ã‚ŠãŸãŸã¿
        $('.progress-step').removeClass('expanded');
        $('.progress-step-content').hide();

        // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸã‚¹ãƒ†ãƒƒãƒ—ãŒæŠ˜ã‚ŠãŸãŸã¾ã‚Œã¦ã„ãŸå ´åˆã€å±•é–‹
        if (!isCurrentlyExpanded) {
            $clickedStep.addClass('expanded');
            $clickedStep.find('.progress-step-content').show();
        }
    });

    // ãƒ‰ãƒ©ãƒƒã‚°ãƒãƒ³ãƒ‰ãƒ«ã‚’æœ€åˆã¯éè¡¨ç¤º
    $('.drag-handle').hide();

    // Sortableæ©Ÿèƒ½ã‚’åˆæœŸåŒ–ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼è¨­å®šå¾Œï¼‰
    initializeSortable();

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§é€²æ—ãƒãƒ¼ã®è‰²ã‚’æ›´æ–°
    $('#workStartCompleted').on('change', function() {
        var step = $('.progress-step[data-step="work_start"]');
        if ($(this).is(':checked')) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate($('input[name="work_start_date"]').val()));

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå·¥äº‹çµ‚äº†ï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('æœªå®Œäº†');

            // å·¥äº‹çµ‚äº†ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’å‰Šé™¤ï¼ˆå·¥äº‹çµ‚äº†ãŒå®Œäº†ã—ã¦ã„ãªã„å ´åˆï¼‰
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.removeClass('active');
            }
        }
        // é€²æ—çŠ¶æ³ã‚‚æ›´æ–°
        updateProgressTimeline();
        updateProgressStatus();
    });

    $('#workEndCompleted').on('change', function() {
        var step = $('.progress-step[data-step="work_end"]');
        if ($(this).is(':checked')) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate($('input[name="work_end_date"]').val()));

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè«‹æ±‚æ›¸ç™ºè¡Œï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('æœªå®Œäº†');

            // è«‹æ±‚æ›¸ç™ºè¡Œã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚’å‰Šé™¤ï¼ˆè«‹æ±‚æ›¸ãŒæœªç™ºè¡Œã®å ´åˆï¼‰
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.removeClass('active');
            }
        }
        // é€²æ—çŠ¶æ³ã‚‚æ›´æ–°
        updateProgressTimeline();
        updateProgressStatus();
    });

    // ãƒ•ã‚©ãƒ¼ãƒ å€¤ã®å¤‰æ›´ã‚’ç›£è¦–ã—ã¦é€²æ—çŠ¶æ³ã‚’è‡ªå‹•æ›´æ–°
    // æ±ç”¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ã‚¹ãƒ†ãƒƒãƒ—ã‚‚å«ã‚€ï¼‰
    // _dateã§çµ‚ã‚ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆestimate_issued_date, contract_date, dynamic_field_*ã¯é™¤å¤–ï¼‰
    $(document).on('change', 'input[name$="_date"]:not([name="estimate_issued_date"]):not([name="contract_date"]):not([name^="dynamic_field_"]), input[name$="_completed"]:not([name^="dynamic_field_"]), select[name="invoice_issued"]', function() {
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆæ±ç”¨ï¼‰
        var fieldName = $(this).attr('name');
        var fieldValue;

        if ($(this).is(':checkbox')) {
            fieldValue = $(this).is(':checked');
        } else {
            fieldValue = $(this).val();
        }

        var data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ajax_save: 'true'
        };
        data[fieldName] = fieldValue;

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: data,
            success: function(response) {
                console.log(fieldName + 'ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', fieldValue);

                // projectDataã‚’æ›´æ–°
                projectData[fieldName] = fieldValue;

                // UIå…¨ä½“ã‚’æ›´æ–°
                updateProgressTimeline();
                updateProgressStatus();
            },
            error: function(xhr, status, error) {
                console.error(fieldName + 'ã®ä¿å­˜ã«å¤±æ•—:', error);
            }
        });
    });

    // è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="estimate_issued_date"]', function() {
        console.log('=== è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ã¾ã—ãŸ ===');
        var step = $('.progress-step[data-step="estimate"]');
        var notRequiredChecked = $('#estimateNotRequired').is(':checked');
        var dateValue = $(this).val();

        console.log('ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', step.length > 0);
        console.log('è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯:', notRequiredChecked);
        console.log('å…¥åŠ›ã•ã‚ŒãŸæ—¥ä»˜:', dateValue);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        console.log('AJAXä¿å­˜ã‚’é–‹å§‹ã—ã¾ã™ - URL:', '{% url "order_management:update_progress" project.pk %}');
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: {
                estimate_issued_date: dateValue,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('âœ“ è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®ä¿å­˜ã«æˆåŠŸã—ã¾ã—ãŸ');
                console.log('ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', response);
                console.log('ä¿å­˜ã•ã‚ŒãŸæ—¥ä»˜:', dateValue);

                // projectDataã‚’æ›´æ–°
                projectData.estimate_issued_date = dateValue;
                console.log('projectDataã‚’æ›´æ–°ã—ã¾ã—ãŸ:', projectData.estimate_issued_date);

                // UIã‚’æ›´æ–°
                if (dateValue && !notRequiredChecked) {
                    console.log('ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®Œäº†çŠ¶æ…‹ã«ã—ã¾ã™');
                    step.addClass('completed');
                    step.removeClass('active');
                    step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
                } else if (!notRequiredChecked) {
                    console.log('ã‚¹ãƒ†ãƒƒãƒ—ã‚’æœªå®Œäº†çŠ¶æ…‹ã«ã—ã¾ã™');
                    step.removeClass('completed');
                    step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
                }

                // é€²æ—çŠ¶æ³å…¨ä½“ã‚’æ›´æ–°
                console.log('é€²æ—çŠ¶æ³ã‚’æ›´æ–°ã—ã¾ã™');
                updateProgressTimeline();
                updateProgressStatus();
                updateActiveStep();
                updateAllStepStatuses();
            },
            error: function(xhr, status, error) {
                console.error('âœ— è¦‹ç©æ›¸ç™ºè¡Œæ—¥ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', status);
                console.error('ã‚¨ãƒ©ãƒ¼:', error);
                console.error('ãƒ¬ã‚¹ãƒãƒ³ã‚¹:', xhr.responseText);
                console.error('HTTPã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:', xhr.status);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\nã‚¨ãƒ©ãƒ¼: ' + error);
            }
        });
    });

    // è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å‡¦ç†ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å®šç¾©
    window.handleEstimateNotRequiredChange = function() {
        var isChecked = $('#estimateNotRequired').is(':checked');
        console.log('è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ:', isChecked);
        var step = $('.progress-step[data-step="estimate"]');
        var dateInput = $('input[name="estimate_issued_date"]');

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: {
                estimate_not_required: isChecked ? 'on' : '',
                estimate_issued_date: isChecked ? '' : dateInput.val(),
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('è¦‹ç©æ›¸ä¸è¦ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', isChecked);

                // projectDataã‚’æ›´æ–°
                projectData.estimate_not_required = isChecked;
                if (isChecked) {
                    projectData.estimate_issued_date = null;
                }

                // UIã‚’æ›´æ–°
                if (isChecked) {
                    // è¦‹ç©æ›¸ä¸è¦ã«ãƒã‚§ãƒƒã‚¯ã—ãŸå ´åˆ
                    step.addClass('completed');
                    step.removeClass('active');
                    step.find('.progress-step-date').html('<i class="fas fa-times-circle me-1"></i>è¦‹ç©ä¸è¦');
                    dateInput.prop('disabled', true).val('');
                } else {
                    // è¦‹ç©æ›¸ä¸è¦ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã—ãŸå ´åˆ
                    dateInput.prop('disabled', false);
                    if (!dateInput.val()) {
                        step.removeClass('completed');
                        step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
                    } else {
                        step.addClass('completed');
                        step.removeClass('active');
                        step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>' + formatDate(dateInput.val()));
                    }
                }

                // é€²æ—çŠ¶æ³å…¨ä½“ã‚’æ›´æ–°
                updateActiveStep();
                updateProgressTimeline();
                updateProgressStatus();
            },
            error: function(xhr, status, error) {
                console.error('è¦‹ç©æ›¸ä¸è¦ãƒ•ãƒ©ã‚°ã®ä¿å­˜ã«å¤±æ•—:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        });
    };

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®šï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒ‡ãƒªã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰
    // â€»ç›´æ¥ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã¯å‰Šé™¤ï¼ˆDOMè¦ç´ ãŒã¾ã å­˜åœ¨ã—ãªã„ãŸã‚ï¼‰
    $(document).off('change', '#estimateNotRequired').on('change', '#estimateNotRequired', window.handleEstimateNotRequiredChange);

    // åˆæœŸçŠ¶æ…‹ã®è¨­å®šã¯ initializeSteps() ã®å¾Œã§è¡Œã‚ã‚Œã¾ã™ï¼ˆ3882-3887è¡Œç›®ï¼‰

    // å¥‘ç´„æ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="contract_date"]', function() {
        var step = $('.progress-step[data-step="contract"]');
        var dateValue = $(this).val();

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: {
                contract_date: dateValue,
                ajax_save: 'true',
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('å¥‘ç´„æ—¥ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', dateValue);

                // projectDataã‚’æ›´æ–°
                projectData.contract_date = dateValue;

                // UIã‚’æ›´æ–°
                if (dateValue) {
                    step.addClass('completed');
                    step.removeClass('active');
                    step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));

                    // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå·¥äº‹é–‹å§‹ï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
                    var nextStep = $('.progress-step[data-step="work_start"]');
                    if (!nextStep.hasClass('completed')) {
                        nextStep.addClass('active');
                    }
                } else {
                    step.removeClass('completed');
                    step.find('.progress-step-date').html('<span class="badge bg-secondary">æœªå®Œäº†</span>');
                }

                // é€²æ—çŠ¶æ³å…¨ä½“ã‚’æ›´æ–°
                updateProgressTimeline();
                updateProgressStatus();
                updateActiveStep();
            },
            error: function(xhr, status, error) {
                console.error('å¥‘ç´„æ—¥ã®ä¿å­˜ã«å¤±æ•—:', error);
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
            }
        });
    });

    // è«‹æ±‚æ›¸ç™ºè¡Œã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="invoice_issued"], select[name="invoice_issued"]', function() {
        var step = $('.progress-step[data-step="invoice"]');
        if ($(this).val() === 'true') {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>ç™ºè¡Œæ¸ˆã¿');
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('æœªç™ºè¡Œ');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å·¥äº‹é–‹å§‹æ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="work_start_date"]', function() {
        var step = $('.progress-step[data-step="work_start"]');
        var isCompleted = $('input[name="work_start_completed"]').is(':checked');
        var dateValue = $(this).val();

        if (isCompleted && dateValue) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ã§æ—¥ä»˜ã‚‚ã‚ã‚Œã°å®Œäº†
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
        } else if (dateValue) {
            // æ—¥ä»˜ã®ã¿ã®å ´åˆã¯äºˆå®šã¨ã—ã¦è¡¨ç¤º
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(dateValue));
        } else {
            // æ—¥ä»˜ãŒãªã„å ´åˆã¯æœªå®Œäº†
            step.removeClass('completed');
            step.find('.progress-step-date').html('æœªå®Œäº†');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å·¥äº‹é–‹å§‹å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="work_start_completed"]', function() {
        var step = $('.progress-step[data-step="work_start"]');
        var workStartDate = $('input[name="work_start_date"]').val();

        if ($(this).is(':checked')) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ã®å ´åˆ
            step.addClass('completed');
            if (workStartDate) {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(workStartDate));
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
            }

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå·¥äº‹çµ‚äº†ï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            var nextStep = $('.progress-step[data-step="work_end"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ•ã®å ´åˆ
            step.removeClass('completed');
            if (workStartDate) {
                // æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã¯äºˆå®šã¨ã—ã¦è¡¨ç¤º
                step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(workStartDate));
            } else {
                step.find('.progress-step-date').html('æœªå®Œäº†');
            }
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å·¥äº‹çµ‚äº†æ—¥ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="work_end_date"]', function() {
        var step = $('.progress-step[data-step="work_end"]');
        var isCompleted = $('input[name="work_end_completed"]').is(':checked');
        var dateValue = $(this).val();

        if (isCompleted && dateValue) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ã§æ—¥ä»˜ã‚‚ã‚ã‚Œã°å®Œäº†
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
        } else if (dateValue) {
            // æ—¥ä»˜ã®ã¿ã®å ´åˆã¯äºˆå®šã¨ã—ã¦è¡¨ç¤º
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(dateValue));
        } else {
            // æ—¥ä»˜ãŒãªã„å ´åˆã¯æœªå®Œäº†
            step.removeClass('completed');
            step.find('.progress-step-date').html('æœªå®Œäº†');
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // å·¥äº‹çµ‚äº†å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name="work_end_completed"]', function() {
        var step = $('.progress-step[data-step="work_end"]');
        var workEndDate = $('input[name="work_end_date"]').val();

        if ($(this).is(':checked')) {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ³ã®å ´åˆ
            step.addClass('completed');
            if (workEndDate) {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(workEndDate));
            } else {
                step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
            }

            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè«‹æ±‚æ›¸ç™ºè¡Œï¼‰ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
            var nextStep = $('.progress-step[data-step="invoice"]');
            if (!nextStep.hasClass('completed')) {
                nextStep.addClass('active');
            }
        } else {
            // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ªãƒ•ã®å ´åˆ
            step.removeClass('completed');
            if (workEndDate) {
                // æ—¥ä»˜ãŒã‚ã‚‹å ´åˆã¯äºˆå®šã¨ã—ã¦è¡¨ç¤º
                step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(workEndDate));
            } else {
                step.find('.progress-step-date').html('æœªå®Œäº†');
            }
        }

        updateProgressTimeline();
        updateProgressStatus();
    });

    // === å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†æ©Ÿèƒ½ ===

    // å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹å¤‰æ›´ã‚’ç›£è¦–ã—ã¦å³åº§ã«ä¿å­˜
    $(document).on('change', 'input[name$="_date"], input[name$="_completed"], input[name$="_value"]', function() {
        const inputName = $(this).attr('name');
        const stepName = inputName.replace(/_date$|_completed$|_value$/, '');
        const step = $('.progress-step[data-step="' + stepName + '"]');

        if (!step.length) return;

        // ã‚¹ãƒ†ãƒƒãƒ—ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
        updateStepStatus(step, $(this));
    });

    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name^="dynamic_field_"], select[name^="dynamic_field_"], textarea[name^="dynamic_field_"]', function() {
        const fieldName = $(this).attr('name');
        // dynamic_field_attendance_scheduled_date -> attendance
        const stepKey = fieldName.replace(/^dynamic_field_/, '').split('_')[0];
        const $step = $(`.progress-step[data-step="${stepKey}"]`);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜ï¼ˆè¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
        const fieldValue = $(this).is(':checkbox') ? $(this).is(':checked') : $(this).val();
        const data = {
            csrfmiddlewaretoken: '{{ csrf_token }}',
            ajax_save: 'true'
        };
        data[fieldName] = fieldValue;

        $.ajax({
            url: '{% url "order_management:update_progress" project.pk %}',
            method: 'POST',
            data: data,
            success: function(response) {
                console.log('è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', fieldName, fieldValue);

                // ä¿å­˜æˆåŠŸå¾Œã«UIã‚’æ›´æ–°
                if ($step.length > 0) {
                    // availableStepsã‹ã‚‰è©²å½“ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã‚’å–å¾—
                    const stepData = availableSteps.find(s => s.key === stepKey);

                    if (stepData && stepData.type === 'complex') {
                        // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å†è¨ˆç®—
                        const status = getComplexStepStatus(stepData, $step);

                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ /å‰Šé™¤
                        if (status.completed) {
                            $step.addClass('completed');
                            $step.removeClass('active');
                        } else {
                            $step.removeClass('completed');
                        }

                        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                        $step.find('.progress-step-date').html(status.statusText);

                        // é€²æ—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã¨çŠ¶æ³ãƒãƒ¼ã‚’æ›´æ–°
                        updateProgressTimeline();
                        updateProgressStatus();

                        console.log(`Updated complex step ${stepKey}:`, status);
                    }
                }
            },
            error: function(xhr, status, error) {
                console.error('è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ä¿å­˜ã«å¤±æ•—:', fieldName, error);
            }
        });
    });

    // ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã®æ›´æ–°
    function updateStepStatus(step, input) {
        const inputName = input.attr('name');
        const value = input.val();
        const isChecked = input.is(':checked');
        const stepKey = step.data('step');

        // å³å´ã®è¡¨ç¤ºæ›´æ–°
        if (inputName.includes('actual_date') && value) {
            // å®Ÿæ–½æ—¥ã®å ´åˆã¯ã€Œå®Œäº†ã€
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(value));
        } else if (inputName.includes('issued_date') && value) {
            // ç™ºè¡Œæ—¥ã®å ´åˆã‚‚ã€Œå®Œäº†ã€
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(value));
        } else if (inputName.includes('scheduled_date') && value) {
            // äºˆå®šæ—¥ã®å ´åˆã¯ã€Œäºˆå®šã€
            step.removeClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(value));
        } else if (inputName.endsWith('_completed') && isChecked) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
        } else if (inputName.endsWith('_value') && value) {
            step.addClass('completed');
            step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + value);
        } else {
            step.removeClass('completed');
            step.find('.progress-step-date').html('æœªå®Œäº†');
        }

        // é€²æ—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚‚æ›´æ–°
        updateProgressTimeline();
        // é€²æ—çŠ¶æ³ãƒãƒ¼ã‚‚æ›´æ–°
        updateProgressStatus();
    }


    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°
    function formatDate(dateString) {
        if (!dateString || dateString === 'undefined' || dateString === undefined) return 'æ—¥ä»˜æœªè¨­å®š';
        try {
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return 'æ—¥ä»˜æœªè¨­å®š';
            // æ—¥æœ¬èªå½¢å¼ã§æœˆ/æ—¥ã‚’è¡¨ç¤º
            return date.toLocaleDateString('ja-JP', {month: 'numeric', day: 'numeric'});
        } catch (e) {
            return 'æ—¥ä»˜æœªè¨­å®š';
        }
    }

    // é€²æ—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateProgressTimeline() {
        const timeline = $('#progressTimeline');
        timeline.empty();

        // å³å´ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ç›´æ¥æƒ…å ±ã‚’å–å¾—
        const currentSteps = [];

        // activeStepså†…ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å·¦å´ã«è¡¨ç¤º
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');
            const isCompleted = $step.hasClass('completed');

            // ã‚¹ãƒ†ãƒƒãƒ—åã‚’å–å¾—ï¼ˆ.progress-step-labelã‚¯ãƒ©ã‚¹ã‹ã‚‰ç›´æ¥å–å¾—ï¼‰
            const stepNameElement = $step.find('.progress-step-label');
            let stepName = stepNameElement.text().trim();

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
            const statusElement = $step.find('.progress-step-date');
            let statusText = null;
            if (statusElement.length > 0) {
                const statusContent = statusElement.text().trim();
                if (statusContent && statusContent !== 'æœªå®Œäº†' && statusContent !== 'æœªè¨­å®š') {
                    // å®Œäº†ã€äºˆå®šã€é–‹å§‹ã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’ä¿æŒã—ãŸã¾ã¾å–å¾—
                    statusText = statusContent;
                }
            }

            currentSteps.push({
                key: stepKey,
                name: stepName,
                completed: isCompleted,
                statusText: statusText
            });
        });

        // ä»¥ä¸‹ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ - å³å´ã‹ã‚‰ç›´æ¥èª­ã¿å–ã‚‹ãŸã‚ä¸è¦
        /*
        // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ï¼ˆç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ å€¤ã‚’ä½¿ç”¨ï¼‰
        const basicSteps = [
        */

        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚’æ§‹ç¯‰
        let previousCompleted = true;
        currentSteps.forEach(step => {
            // ã‚¹ãƒ†ãƒƒãƒ—åãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
            if (!step.name || step.name === 'undefined' || step.name === undefined) {
                console.warn('Skipping timeline item with invalid name:', step);
                return;
            }

            // ã‚¹ãƒ†ãƒƒãƒ—ã®çŠ¶æ…‹ã‚’åˆ¤å®š
            let statusClass = '';
            const stepElement = $(`.progress-step[data-step="${step.key}"]`);

            if (stepElement.length > 0) {
                // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã€ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã‚’ç¢ºèª
                const scheduledDate = stepElement.find(`input[name*="scheduled_date"]`).val();
                const actualDate = stepElement.find(`input[name*="actual_date"]`).val();
                const completedCheckbox = stepElement.find(`input[name*="completed"]`).is(':checked');
                const issuedDate = stepElement.find(`input[name*="issued_date"]`).val();
                const notRequired = stepElement.find(`input[name*="not_required"]`).is(':checked');

                // çŠ¶æ…‹ã®å„ªå…ˆé †ä½: verified > completed > scheduled > ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
                if (completedCheckbox) {
                    // å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã«ãƒã‚§ãƒƒã‚¯ã‚ã‚Š â†’ æ¿ƒã„ç·‘
                    statusClass = 'verified';
                } else if (actualDate || issuedDate || notRequired) {
                    // å®Œäº†æ—¥ã¾ãŸã¯ç™ºè¡Œæ—¥ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ â†’ ç·‘
                    statusClass = 'completed';
                } else if (scheduledDate) {
                    // äºˆå®šæ—¥ã®ã¿å…¥åŠ›ã•ã‚Œã¦ã„ã‚‹ â†’ é»„è‰²
                    statusClass = 'scheduled';
                } else if (step.completed) {
                    // å³å´ã§ completed ã‚¯ãƒ©ã‚¹ãŒã¤ã„ã¦ã„ã‚‹ â†’ ç·‘
                    statusClass = 'completed';
                }
                // ãã‚Œä»¥å¤–ï¼ˆä½•ã‚‚å…¥åŠ›ãªã—ï¼‰ â†’ ã‚°ãƒ¬ãƒ¼ï¼ˆã‚¯ãƒ©ã‚¹ãªã—ï¼‰
            } else {
                // è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯å¾“æ¥ã®ãƒ­ã‚¸ãƒƒã‚¯
                const isCompleted = step.completed;
                if (isCompleted) {
                    statusClass = 'completed';
                }
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã®è‰²ã‚’æ±ºå®šï¼ˆäºˆå®šã¯é»„è‰²ã€å®Œäº†ã¯ç·‘ï¼‰
            let statusColor = 'text-success';
            if (step.statusText && step.statusText.includes('äºˆå®š:')) {
                statusColor = 'text-warning';
            }
            const statusHtml = step.statusText ?
                `<small class="${statusColor} d-block">${step.statusText}</small>` : '';

            timeline.append(`
                <div class="timeline-item ${statusClass}">
                    <strong>${step.name}</strong>
                    ${statusHtml}
                </div>
            `);

            if (statusClass === 'completed' || statusClass === 'verified') {
                previousCompleted = true;
            } else {
                previousCompleted = false;
            }
        });
    }

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆæœ€åˆã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹ï¼‰
    function updateActiveStep() {
        // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰activeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        $('#activeSteps .progress-step').removeClass('active');

        // æœ€åˆã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¦‹ã¤ã‘ã¦activeã‚¯ãƒ©ã‚¹ã‚’ä»˜ä¸
        let foundFirstIncomplete = false;
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            if (!foundFirstIncomplete && !$step.hasClass('completed')) {
                $step.addClass('active');
                foundFirstIncomplete = true;
            }
        });
    }

    // ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    function updateAllStepStatuses() {
        $('.progress-step[data-step]').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');

            // availableStepsã‹ã‚‰è©²å½“ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã‚’å–å¾—
            const stepData = availableSteps.find(s => s.key === stepKey);

            if (stepData && stepData.type === 'complex') {
                // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—
                const status = getComplexStepStatus(stepData, $step);

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                if (status.completed) {
                    $step.addClass('completed');
                } else {
                    $step.removeClass('completed');
                }

                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                $step.find('.progress-step-date').html(status.statusText);
            }
        });
    }

    // é€²æ—çŠ¶æ³ãƒãƒ¼ã¨ãƒ•ã‚§ãƒ¼ã‚ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨NEXTã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°ï¼ˆå‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†å¯¾å¿œï¼‰
    function updateNextActionAndStep(phase, allSteps) {
        let nextAction = 'å®Œäº†';
        let nextStep = '-';

        // å…¨ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—è¦ç´ ã‚’å–å¾—ï¼ˆè¡¨ç¤ºé †åºé †ï¼‰
        const stepElements = $('#activeSteps .progress-step');

        // æœªå®Œäº†ã®æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¦‹ã¤ã‘ã‚‹
        let currentIncompleteStep = null;
        let nextIncompleteStep = null;
        let foundCurrent = false;

        stepElements.each(function() {
            const $step = $(this);
            const isCompleted = $step.hasClass('completed');
            const stepName = $step.find('.progress-step-label').text().trim();

            if (!isCompleted) {
                if (!foundCurrent) {
                    currentIncompleteStep = {
                        element: $step,
                        name: stepName,
                        key: $step.data('step')
                    };
                    foundCurrent = true;
                } else if (!nextIncompleteStep) {
                    nextIncompleteStep = {
                        element: $step,
                        name: stepName,
                        key: $step.data('step')
                    };
                }
            }
        });

        // ç¾åœ¨ã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ãŒã‚ã‚‹å ´åˆã€æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ±ºå®š
        if (currentIncompleteStep) {
            const $currentStep = currentIncompleteStep.element;
            const stepName = currentIncompleteStep.name;

            // äºˆå®šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
            const scheduledDateInput = $currentStep.find('input[name*="scheduled_date"]');
            const actualDateInput = $currentStep.find('input[name*="actual_date"]');
            const completedCheckbox = $currentStep.find('input[type="checkbox"][name*="completed"]');

            const hasScheduledDate = scheduledDateInput.length > 0 && scheduledDateInput.val();
            const hasActualDate = actualDateInput.length > 0 && actualDateInput.val();
            const isChecked = completedCheckbox.length > 0 && completedCheckbox.is(':checked');

            // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤å®š
            if (completedCheckbox.length > 0 && !isChecked) {
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆ
                if (hasActualDate) {
                    nextAction = `${stepName}ï¼šå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„`;
                } else if (hasScheduledDate) {
                    nextAction = `${stepName}ï¼šå®Ÿæ–½æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                } else {
                    nextAction = `${stepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                }
            } else if (actualDateInput.length > 0 && !hasActualDate) {
                // å®Ÿæ–½æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆ
                if (hasScheduledDate) {
                    nextAction = `${stepName}ï¼šå®Ÿæ–½æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                } else {
                    nextAction = `${stepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                }
            } else if (scheduledDateInput.length > 0 && !hasScheduledDate) {
                // äºˆå®šæ—¥ã®ã¿ã®å ´åˆ
                nextAction = `${stepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
            } else {
                // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—
                nextAction = `${stepName}ï¼šå…¥åŠ›ã—ã¦ãã ã•ã„`;
            }

            // NEXTã‚¹ãƒ†ãƒƒãƒ—ã‚’è¨­å®šï¼ˆnextIncompleteStepã«ã¤ã„ã¦ã‚‚åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã§ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤å®šï¼‰
            if (nextIncompleteStep) {
                const $nextStep = nextIncompleteStep.element;
                const nextStepName = nextIncompleteStep.name;

                // Next Stepã®äºˆå®šæ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºèª
                const nextScheduledDateInput = $nextStep.find('input[name*="scheduled_date"]');
                const nextActualDateInput = $nextStep.find('input[name*="actual_date"]');
                const nextCompletedCheckbox = $nextStep.find('input[type="checkbox"][name*="completed"]');

                const nextHasScheduledDate = nextScheduledDateInput.length > 0 && nextScheduledDateInput.val();
                const nextHasActualDate = nextActualDateInput.length > 0 && nextActualDateInput.val();
                const nextIsChecked = nextCompletedCheckbox.length > 0 && nextCompletedCheckbox.is(':checked');

                // Next Stepã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’åˆ¤å®š
                if (nextCompletedCheckbox.length > 0 && !nextIsChecked) {
                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆ
                    if (nextHasActualDate) {
                        nextStep = `${nextStepName}ï¼šå®Œäº†ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„`;
                    } else if (nextHasScheduledDate) {
                        nextStep = `${nextStepName}ï¼šå®Ÿæ–½æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                    } else {
                        nextStep = `${nextStepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                    }
                } else if (nextActualDateInput.length > 0 && !nextHasActualDate) {
                    // å®Ÿæ–½æ—¥ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆ
                    if (nextHasScheduledDate) {
                        nextStep = `${nextStepName}ï¼šå®Ÿæ–½æ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                    } else {
                        nextStep = `${nextStepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                    }
                } else if (nextScheduledDateInput.length > 0 && !nextHasScheduledDate) {
                    // äºˆå®šæ—¥ã®ã¿ã®å ´åˆ
                    nextStep = `${nextStepName}ï¼šäºˆå®šæ—¥ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
                } else {
                    // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—
                    nextStep = `${nextStepName}ï¼šå…¥åŠ›ã—ã¦ãã ã•ã„`;
                }
            } else {
                nextStep = 'å®Œäº†';
            }
        }

        // UIã‚’æ›´æ–°ï¼ˆãƒãƒƒã‚¸å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼‰
        $('#nextActionText').html(formatNextActionWithBadge(nextAction));
        $('#nextStepText').html(formatNextActionWithBadge(nextStep));

        console.log('ğŸ“Œ Next Action updated:', {
            action: nextAction,
            step: nextStep,
            currentStep: currentIncompleteStep ? currentIncompleteStep.name : 'none'
        });
    }

    // Next Actionã‚’ãƒãƒƒã‚¸å½¢å¼ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã™ã‚‹é–¢æ•°
    function formatNextActionWithBadge(value) {
        if (!value || value === 'å®Œäº†' || value === '-' || !value.includes('ï¼š')) {
            return value;
        }

        const parts = value.split('ï¼š');
        const stepName = parts[0];
        const action = parts.slice(1).join('ï¼š'); // è¤‡æ•°ã®ã€Œï¼šã€ãŒã‚ã‚‹å ´åˆã«å¯¾å¿œ

        return `<span class="badge bg-white border text-dark me-1" style="font-size: 0.75rem;">${stepName}</span>${action}`;
    }

    function updateProgressStatus() {
        // å³å´ã®ã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰ç›´æ¥å®Œäº†çŠ¶æ³ã‚’å–å¾—
        const allSteps = [];

        // activeStepså†…ã®å…¨ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒ£ãƒ³
        $('#activeSteps .progress-step').each(function() {
            const $step = $(this);
            const stepKey = $step.data('step');
            const isCompleted = $step.hasClass('completed');
            console.log(`ğŸ” Progress check - ${stepKey}: completed=${isCompleted}, has class=${$step.hasClass('completed')}`);
            allSteps.push({ key: stepKey, completed: isCompleted });
        });

        // å®Œäº†ç‡è¨ˆç®—
        const completedSteps = allSteps.filter(step => step.completed).length;
        const totalSteps = allSteps.length;
        const percentage = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;

        console.log(`ğŸ“Š Progress calculation: ${completedSteps}/${totalSteps} = ${percentage}%`);
        console.log('All steps:', allSteps);

        // ãƒ•ã‚§ãƒ¼ã‚ºåˆ¤å®šï¼ˆget_current_project_stage()ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        let phase = 'æœªé–‹å§‹';
        let color = 'secondary';

        // å®Œå·¥æ—¥ã‚’ãƒã‚§ãƒƒã‚¯
        const completionElement = $('.progress-step[data-step="completion"]');
        const completionCompleted = completionElement.find('input[name*="completed"]').is(':checked');
        const completionActualDate = completionElement.find('input[name*="actual_date"]').val();
        const workEndDate = $('input[name="work_end_date"]').val();

        if (completionCompleted || $('#workEndCompleted').is(':checked')) {
            phase = 'å®Œå·¥';
            color = 'verified';
        } else if (completionActualDate || workEndDate) {
            phase = 'å®Œå·¥';
            color = 'success';
        }
        // ç€å·¥æ—¥ã‚’ãƒã‚§ãƒƒã‚¯
        else {
            const constructionElement = $('.progress-step[data-step="construction_start"]');
            const constructionCompleted = $('#workStartCompleted').is(':checked');
            const constructionActualDate = constructionElement.find('input[name*="actual_date"]').val();
            const constructionScheduledDate = constructionElement.find('input[name*="scheduled_date"]').val() || $('input[name="work_start_date"]').val();

            if (constructionCompleted) {
                phase = 'å·¥äº‹ä¸­';
                color = 'verified';
            } else if (constructionActualDate) {
                phase = 'å·¥äº‹ä¸­';
                color = 'success';
            } else if (constructionScheduledDate) {
                phase = 'ç€å·¥æ—¥å¾…ã¡';
                color = 'warning';
            }
            // è¦‹ç©ã‚‚ã‚Šã‚’ãƒã‚§ãƒƒã‚¯
            else {
                const estimateIssuedDate = $('input[name="estimate_issued_date"]').val();
                const estimateNotRequired = $('#estimateNotRequired').is(':checked');

                if (estimateIssuedDate) {
                    phase = 'è¦‹ç©ã‚‚ã‚Šå¯©æŸ»ä¸­';
                    color = 'warning';
                } else {
                    // è¦‹ç©æ›¸ç™ºè¡Œæ—¥ãŒãªã„å ´åˆã®ã¿ã€å‰ã®å·¥ç¨‹ã‚’ãƒã‚§ãƒƒã‚¯
                    // ç¾èª¿ã‚’ãƒã‚§ãƒƒã‚¯
                    const surveyElement = $('.progress-step[data-step="survey"]');
                    const surveyActualDate = surveyElement.find('input[name*="actual_date"]').val();
                    const surveyScheduledDate = surveyElement.find('input[name*="scheduled_date"]').val();
                    if (surveyActualDate) {
                        phase = 'ç¾èª¿æ¸ˆã¿';
                        color = 'success';
                    } else if (surveyScheduledDate) {
                        phase = 'ç¾èª¿å¾…ã¡';
                        color = 'warning';
                    } else {
                        // ç«‹ã¡ä¼šã„ã‚’ãƒã‚§ãƒƒã‚¯
                        const attendanceElement = $('.progress-step[data-step="attendance"]');
                        const attendanceActualDate = attendanceElement.find('input[name*="actual_date"]').val();
                        const attendanceScheduledDate = attendanceElement.find('input[name*="scheduled_date"]').val();

                        if (attendanceActualDate) {
                            phase = 'ç«‹ã¡ä¼šã„æ¸ˆã¿';
                            color = 'success';
                        } else if (attendanceScheduledDate) {
                            phase = 'ç«‹ã¡ä¼šã„å¾…ã¡';
                            color = 'warning';
                        } else {
                            phase = 'æœªé–‹å§‹';
                            color = 'secondary';
                        }
                    }
                }
            }
        }

        // UIæ›´æ–°
        $('#progressPhase').text(phase).removeClass().addClass(`text-${color}`);
        $('#progressBar').removeClass().addClass(`progress-bar bg-${color}`).css('width', `${percentage}%`).attr('aria-valuenow', percentage);
        $('#progressPercentage').text(`${completedSteps}/${totalSteps}`);
        $('#progressStatusCard').removeClass().addClass(`card progress-status-card border-${color}`);
        $('#progressStatusHeader').removeClass().addClass(`card-header bg-${color} text-white`);

        // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã¨NEXTã‚¹ãƒ†ãƒƒãƒ—ã‚’æ›´æ–°
        updateNextActionAndStep(phase, allSteps);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é€²æ—çŠ¶æ³ã‚’ä¿å­˜
        saveProjectStage(phase, color);
    }

    // é€²æ—çŠ¶æ³ã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ï¼ˆãƒ‡ãƒã‚¦ãƒ³ã‚¹ä»˜ãï¼‰
    var saveStageTimeout;
    function saveProjectStage(stage, color) {
        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ï¼šé€£ç¶šã—ãŸå‘¼ã³å‡ºã—ã‚’500msé…å»¶
        clearTimeout(saveStageTimeout);
        saveStageTimeout = setTimeout(function() {
            $.ajax({
                url: '{% url "order_management:update_project_stage" project.pk %}',
                method: 'POST',
                data: {
                    stage: stage,
                    color: color,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('é€²æ—çŠ¶æ³ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', stage);
                },
                error: function(xhr, status, error) {
                    console.error('é€²æ—çŠ¶æ³ã®ä¿å­˜ã«å¤±æ•—:', error);
                }
            });
        }, 500);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã‚’åŒæœŸ
    function syncFormFieldsToSteps() {
        console.log('Syncing form fields to steps');

        // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯
        const fieldsToCheck = [
            { field: 'estimate_issued_date', step: 'estimate' },
            { field: 'contract_date', step: 'contract' },
            { field: 'work_start_date', step: 'work_start' },
            { field: 'work_end_date', step: 'work_end' }
        ];

        fieldsToCheck.forEach(({ field, step }) => {
            const input = $(`input[name="${field}"]`);
            const stepElement = $(`.progress-step[data-step="${step}"]`);

            if (input.length && stepElement.length) {
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’èª­ã¿å–ã£ã¦ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã‚’æ›´æ–°
                const inputValue = input.val();
                console.log(`Syncing ${field}: ${inputValue}`);

                if (inputValue) {
                    // å·¥äº‹é–‹å§‹ãƒ»å·¥äº‹å®Œäº†ã¯ç‰¹åˆ¥å‡¦ç†
                    if (step === 'work_start' || step === 'work_end') {
                        const completedCheckbox = $(`input[name="${step}_completed"]`);
                        const isCompleted = completedCheckbox.is(':checked');

                        if (isCompleted) {
                            stepElement.addClass('completed');
                            stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(inputValue));
                        } else {
                            stepElement.removeClass('completed');
                            stepElement.find('.progress-step-date').html('<i class="fas fa-calendar me-1"></i>äºˆå®š: ' + formatDate(inputValue));
                        }
                    } else {
                        updateStepStatus(stepElement, input);
                    }
                } else if (step === 'work_start' || step === 'work_end') {
                    // æ—¥ä»˜ãŒãªã„ãŒã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒã‚ã‚‹å ´åˆã®å‡¦ç†
                    const completedCheckbox = $(`input[name="${step}_completed"]`);
                    const isCompleted = completedCheckbox.is(':checked');

                    if (isCompleted) {
                        stepElement.addClass('completed');
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
                    } else {
                        stepElement.removeClass('completed');
                        stepElement.find('.progress-step-date').html('æœªå®Œäº†');
                    }
                }
            }
        });

        // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚ãƒã‚§ãƒƒã‚¯
        const checkboxFields = [
            { field: 'estimate_not_required', step: 'estimate' },
            { field: 'work_start_completed', step: 'work_start' },
            { field: 'work_end_completed', step: 'work_end' },
            { field: 'invoice_issued', step: 'invoice' }
        ];

        checkboxFields.forEach(({ field, step }) => {
            const input = $(`input[name="${field}"]`);
            const stepElement = $(`.progress-step[data-step="${step}"]`);

            if (input.length && stepElement.length && input.is(':checked')) {
                console.log(`Syncing checkbox ${field}: checked`);

                // è¦‹ç©æ›¸ä¸è¦ãƒ»å·¥äº‹é–‹å§‹ãƒ»å·¥äº‹å®Œäº†ã¯ç‰¹åˆ¥å‡¦ç†
                if (step === 'estimate' && field === 'estimate_not_required') {
                    stepElement.addClass('completed');
                    stepElement.find('.progress-step-date').html('<i class="fas fa-times-circle me-1"></i>è¦‹ç©ä¸è¦');
                } else if (step === 'work_start' || step === 'work_end') {
                    const dateInput = $(`input[name="${step}_date"]`);
                    const dateValue = dateInput.val();

                    stepElement.addClass('completed');
                    if (dateValue) {
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
                    } else {
                        stepElement.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†');
                    }
                } else {
                    updateStepStatus(stepElement, input);
                }
            }
        });

        // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’è¨­å®š
        if (complexStepFields && typeof complexStepFields === 'object') {
            console.log('Setting complex step field values:', complexStepFields);
            Object.keys(complexStepFields).forEach(fieldName => {
                const fieldValue = complexStepFields[fieldName];
                // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ã—ã¦ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¤œç´¢
                const fieldElement = $(`[name="dynamic_field_${fieldName}"]`);

                if (fieldElement.length > 0) {
                    if (fieldElement.is(':checkbox') || fieldElement.is(':radio')) {
                        if (fieldValue === 'true' || fieldValue === fieldElement.val()) {
                            fieldElement.prop('checked', true);
                        }
                    } else {
                        fieldElement.val(fieldValue);
                    }
                    console.log(`Set field dynamic_field_${fieldName} to ${fieldValue}`);
                }
            });

            // ä¾å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤ºçŠ¶æ…‹ã‚’æ›´æ–°
            $('input[type="radio"]:checked').trigger('change');

            // å„è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
            $('.progress-step[data-step]').each(function() {
                const $step = $(this);
                const stepKey = $step.data('step');

                // availableStepsã‹ã‚‰è©²å½“ã™ã‚‹ã‚¹ãƒ†ãƒƒãƒ—å®šç¾©ã‚’å–å¾—
                const stepData = availableSteps.find(s => s.key === stepKey);

                if (stepData && stepData.type === 'complex') {
                    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨ˆç®—
                    const status = getComplexStepStatus(stepData, $step);

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
                    if (status.completed) {
                        $step.addClass('completed');
                    } else {
                        $step.removeClass('completed');
                    }

                    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
                    $step.find('.progress-step-date').html(status.statusText);

                    console.log(`Updated status for ${stepKey}:`, status);
                }
            });
        }

        console.log('Form field sync complete');
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã«ã‚¹ãƒ†ãƒƒãƒ—é †åºã¨ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿å­˜
    $('form').on('submit', function(e) {
        console.log('=== ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡é–‹å§‹ ===');
        saveStepOrder();
        collectDynamicFieldData();

        // ãƒ‡ãƒãƒƒã‚°: é€ä¿¡ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        const formData = $(this).serializeArray();
        const dynamicFields = formData.filter(item => item.name.startsWith('dynamic_field_'));
        console.log('é€ä¿¡ã•ã‚Œã‚‹ dynamic_field_ ã®æ•°:', dynamicFields.length);
        console.log('dynamic_field_ ãƒ‡ãƒ¼ã‚¿:', dynamicFields);

        // ç¢ºèªã®ãŸã‚ä¸€æ™‚åœæ­¢ï¼ˆæœ¬ç•ªã§ã¯å‰Šé™¤ã—ã¦ãã ã•ã„ï¼‰
        // e.preventDefault();
        // alert(`${dynamicFields.length} å€‹ã®dynamic_field_ã‚’é€ä¿¡ã—ã¾ã™ã€‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
    });

    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’åé›†ã—ã¦ãƒ•ã‚©ãƒ¼ãƒ ã«è¿½åŠ 
    function collectDynamicFieldData() {
        console.log('Collecting dynamic field data...');

        // ã¾ãšå€¤ã‚’åé›†ï¼ˆå‰Šé™¤ã™ã‚‹å‰ã«ï¼‰
        const collectedData = [];

        // å„è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å€¤ã‚’åé›†
        $('.progress-step[data-step]').each(function() {
            const stepKey = $(this).data('step');
            const stepElement = $(this);

            // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ¢ã™
            stepElement.find('input, select, textarea').each(function() {
                const fieldElement = $(this);
                const fieldName = fieldElement.attr('name');

                // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
                if (!fieldName) return;

                // dynamic_field_ã§å§‹ã¾ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿å‡¦ç†
                if (!fieldName.startsWith('dynamic_field_')) return;

                let fieldValue;

                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å ´åˆ
                if (fieldElement.is(':checkbox')) {
                    fieldValue = fieldElement.is(':checked') ? 'true' : 'false';
                } else if (fieldElement.is(':radio')) {
                    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿å‡¦ç†
                    if (!fieldElement.is(':checked')) return;
                    fieldValue = fieldElement.val();
                } else if (fieldElement.is('select[multiple]')) {
                    // è¤‡æ•°é¸æŠã®å ´åˆ
                    const selectedValues = fieldElement.val();
                    if (selectedValues && selectedValues.length > 0) {
                        fieldValue = selectedValues.join(',');
                    } else {
                        fieldValue = '';
                    }
                } else {
                    fieldValue = fieldElement.val();
                }

                // å€¤ã‚’åé›†ï¼ˆç©ºã§ã‚‚åé›†ã—ã¦Noneã¨ã—ã¦é€ä¿¡ï¼‰
                collectedData.push({
                    name: fieldName,
                    value: fieldValue || ''
                });

                console.log(`Collected: ${fieldName} = ${fieldValue}`);
            });
        });

        // æ—¢å­˜ã®éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤ï¼ˆtype=hiddenã®ã¿ï¼‰
        $('input[type="hidden"][name^="dynamic_field_"]').remove();

        // åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½œæˆ
        collectedData.forEach(item => {
            const hiddenField = $('<input>', {
                type: 'hidden',
                name: item.name,
                value: item.value
            });
            $('form').append(hiddenField);
            console.log(`Added hidden field: ${item.name} = ${item.value}`);
        });

        console.log(`Dynamic field data collection complete. Collected ${collectedData.length} fields.`);
    }

    // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    const orderedSteps = {{ ordered_steps_json|safe }};
    const dynamicSteps = {{ dynamic_steps_json|safe }};
    const complexStepFields = {{ complex_step_fields_json|safe }};

    console.log('=== Debug Info ===');
    console.log('orderedSteps:', orderedSteps);
    console.log('orderedSteps type:', typeof orderedSteps);
    console.log('orderedSteps length:', orderedSteps ? orderedSteps.length : 'null/undefined');
    if (orderedSteps && orderedSteps.length > 0) {
        orderedSteps.forEach((step, index) => {
            console.log(`orderedStep[${index}]:`, step);
            console.log(`  key: ${step.key} (type: ${typeof step.key})`);
            console.log(`  name: ${step.name} (type: ${typeof step.name})`);
        });
    }
    console.log('dynamicSteps:', dynamicSteps);
    const projectData = {
        estimate_issued_date: '{{ project.estimate_issued_date|date:"Y-m-d"|default:"" }}' || '',
        estimate_not_required: {% if project.estimate_not_required %}true{% else %}false{% endif %},
        contract_date: '{{ project.contract_date|date:"Y-m-d"|default:"" }}' || '',
        work_start_date: '{{ project.work_start_date|date:"Y-m-d"|default:"" }}' || '',
        work_start_completed: {% if project.work_start_completed %}true{% else %}false{% endif %},
        work_end_date: '{{ project.work_end_date|date:"Y-m-d"|default:"" }}' || '',
        work_end_completed: {% if project.work_end_completed %}true{% else %}false{% endif %},
        invoice_issued: {% if project.invoice_issued %}true{% else %}false{% endif %}
    };

    // ã‚¹ãƒ†ãƒƒãƒ—ã®åˆæœŸåŒ–
    function initializeSteps() {
        console.log('initializeSteps called');
        const container = $('#activeSteps');
        container.empty();

        try {
            // orderedStepsãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—
            if (orderedSteps && orderedSteps.length > 0) {
                console.log('Using ordered steps:', orderedSteps.length);
                orderedSteps.forEach((step, index) => {
                    const stepHtml = generateStepHtml(step);
                    if (stepHtml) {
                        container.append(stepHtml);
                    }
                });
            } else {
                console.log('Using default basic steps');
                // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‚’ç›´æ¥ç”Ÿæˆ
                container.append(generateEstimateStepHtml());

                // ç¾åœ°èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã¯ survey_required ãŒ true ã®å ´åˆã®ã¿è¿½åŠ 
                {% if project.survey_required %}
                    container.append(generateSurveyStepHtml());
                {% endif %}

                container.append(generateContractStepHtml());
                container.append(generateWorkStartStepHtml());
                container.append(generateWorkEndStepHtml());
                container.append(generateInvoiceStepHtml());
            }

            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚¹ãƒ†ãƒƒãƒ—ã‚’æ­£ã—ãè¨­å®šï¼ˆæœ€åˆã®æœªå®Œäº†ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ï¼‰
            updateActiveStep();

            // é€²æ—ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã‚‚æ›´æ–°ï¼ˆDOMè¦ç´ ãŒæº–å‚™ã•ã‚Œã¦ã‹ã‚‰ï¼‰
            setTimeout(() => {
                updateProgressTimeline();
                updateProgressStatus();

                // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡
                updateSurveyAreaVisibility();

                // åˆæœŸçŠ¶æ…‹ã§ã¯ä½•ã‚‚å±•é–‹ã—ãªã„ï¼ˆã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã¿å±•é–‹ï¼‰

                // è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–ï¼ˆDOMè¦ç´ ãŒç”Ÿæˆã•ã‚ŒãŸå¾Œï¼‰
                console.log('è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¦ç´ æ•°ï¼ˆåˆæœŸåŒ–å¾Œï¼‰:', $('#estimateNotRequired').length);
                console.log('è¦‹ç©æ›¸ä¸è¦ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®åˆæœŸçŠ¶æ…‹ï¼ˆåˆæœŸåŒ–å¾Œï¼‰:', $('#estimateNotRequired').is(':checked'));
                if ($('#estimateNotRequired').length > 0) {
                    window.handleEstimateNotRequiredChange();
                }

                // ã‚·ãƒ³ãƒ—ãƒ«ãªæ—¥ä»˜ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆcontractç­‰ï¼‰ã®åˆæœŸå€¤ã‚’åæ˜ ã—ã¦ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
                // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ï¼ˆattendance, survey, construction_start, completionï¼‰ã¯
                // getComplexStepStatusé–¢æ•°ã§æ—¢ã«å‡¦ç†ã•ã‚Œã¦ã„ã‚‹ã®ã§ã‚¹ã‚­ãƒƒãƒ—
                $('.progress-step').each(function() {
                    const $step = $(this);
                    const stepKey = $step.data('step');

                    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆæ—¢ã«getComplexStepStatusã§å‡¦ç†æ¸ˆã¿ï¼‰
                    const complexSteps = ['attendance', 'survey', 'construction_start', 'completion'];
                    if (complexSteps.includes(stepKey)) {
                        return; // continue
                    }

                    // availableStepsã‹ã‚‰å®šç¾©ã‚’å–å¾—ã—ã¦typeã‚’ãƒã‚§ãƒƒã‚¯
                    const stepData = availableSteps.find(s => s.key === stepKey);
                    if (stepData && stepData.type === 'complex') {
                        return; // continue - è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—
                    }

                    // ã‚·ãƒ³ãƒ—ãƒ«ãªæ—¥ä»˜ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿å‡¦ç†
                    const $dateInput = $step.find('input[type="date"]');
                    if ($dateInput.length > 0 && $dateInput.val()) {
                        const dateValue = $dateInput.val();
                        $step.addClass('completed');
                        $step.removeClass('active');
                        $step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†: ' + formatDate(dateValue));
                    }

                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚å‡¦ç†
                    const $checkbox = $step.find('input[type="checkbox"][name$="_completed"]');
                    if ($checkbox.length > 0 && $checkbox.is(':checked')) {
                        $step.addClass('completed');
                        $step.removeClass('active');
                        $step.find('.progress-step-date').html('<i class="fas fa-check-circle me-1"></i>å®Œäº†æ¸ˆã¿');
                    }
                });
            }, 50);

            console.log('Steps initialized:', container.children().length);
        } catch (error) {
            console.error('Error in initializeSteps:', error);
            // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‚’å¼·åˆ¶è¡¨ç¤º
            container.append(generateEstimateStepHtml());

            // ç¾åœ°èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã¯ survey_required ãŒ true ã®å ´åˆã®ã¿è¿½åŠ 
            {% if project.survey_required %}
                container.append(generateSurveyStepHtml());
            {% endif %}

            container.append(generateContractStepHtml());
            container.append(generateWorkStartStepHtml());
            container.append(generateWorkEndStepHtml());
            container.append(generateInvoiceStepHtml());
        }
    }

    // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡
    function updateSurveyAreaVisibility() {
        const surveyStep = $('.progress-step[data-step="survey"]');
        const surveyArea = $('#surveyContentArea');

        console.log('Survey step found:', surveyStep.length);
        console.log('Survey area element:', surveyArea.length);

        // survey_required ãƒ•ãƒ©ã‚°ã«åŸºã¥ã„ã¦è¡¨ç¤ºåˆ¶å¾¡
        {% if project.survey_required %}
            surveyArea.show();
            console.log('Survey area shown (survey_required=true)');
        {% else %}
            surveyArea.hide();
            console.log('Survey area hidden (survey_required=false)');
        {% endif %}
    }

    // ã‚¹ãƒ†ãƒƒãƒ—HTMLã‚’ç”Ÿæˆ
    function generateStepHtml(step) {
        // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const basicSteps = ['estimate', 'survey', 'contract', 'work_start', 'work_end', 'invoice'];
        const isBasicStep = basicSteps.includes(step.key);

        if (isBasicStep) {
            return generateStaticStepHtml(step);
        } else {
            // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰å®šç¾©ã‚’å–å¾—
            const stepDefinition = availableSteps.find(s => s.key === step.key);
            if (stepDefinition) {
                return generateAvailableStepHtml(stepDefinition);
            } else if (step.is_dynamic) {
                return generateDynamicStepHtml(step);
            } else {
                console.warn(`Unknown step: ${step.key}`);
                return '';
            }
        }
    }

    // å·¦å´è¡¨ç¤ºç”¨ã®ã‚¹ãƒ†ãƒƒãƒ—HTMLã‚’ç”Ÿæˆ
    function generateLeftDisplayStepHtml(step) {
        if (step.is_dynamic) {
            return generateLeftDisplayDynamicStepHtml(step);
        } else {
            return generateLeftDisplayStaticStepHtml(step);
        }
    }

    // å·¦å´è¡¨ç¤ºç”¨ - é™çš„ã‚¹ãƒ†ãƒƒãƒ—
    function generateLeftDisplayStaticStepHtml(step) {
        let stepName, stepIcon, isCompleted, statusHtml;

        switch (step.key) {
            case 'estimate':
                stepName = 'è¦‹ç©ä½œæˆ';
                stepIcon = 'fas fa-file-invoice';
                isCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;
                if (projectData.estimate_not_required) {
                    statusHtml = '<i class="fas fa-times-circle me-1"></i>è¦‹ç©ä¸è¦';
                } else if (projectData.estimate_issued_date) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.estimate_issued_date)}`;
                } else {
                    statusHtml = 'æœªå®Œäº†';
                }
                break;
            case 'contract':
                stepName = 'å¥‘ç´„';
                stepIcon = 'fas fa-handshake';
                isCompleted = projectData.contract_date;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.contract_date)}`;
                } else {
                    statusHtml = 'æœªå®Œäº†';
                }
                break;
            case 'work_start':
                stepName = 'å·¥äº‹é–‹å§‹';
                stepIcon = 'fas fa-play-circle';
                isCompleted = projectData.work_start_completed;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.work_start_date)}`;
                } else if (projectData.work_start_date) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(projectData.work_start_date)}`;
                } else {
                    statusHtml = 'æœªå®Œäº†';
                }
                break;
            case 'work_end':
                stepName = 'å·¥äº‹å®Œäº†';
                stepIcon = 'fas fa-check-circle';
                isCompleted = projectData.work_end_completed;
                if (isCompleted) {
                    statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.work_end_date)}`;
                } else if (projectData.work_end_date) {
                    statusHtml = `<i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(projectData.work_end_date)}`;
                } else {
                    statusHtml = 'æœªå®Œäº†';
                }
                break;
            case 'invoice':
                stepName = 'è«‹æ±‚æ›¸ç™ºè¡Œ';
                stepIcon = 'fas fa-file-invoice-dollar';
                isCompleted = projectData.invoice_issued;
                statusHtml = isCompleted ? '<i class="fas fa-check-circle me-1"></i>ç™ºè¡Œæ¸ˆã¿' : 'æœªç™ºè¡Œ';
                break;
            default:
                return '';
        }

        const completedClass = isCompleted ? 'completed' : '';

        return `
            <div class="progress-step ${completedClass}" data-step="${step.key}">
                <div class="progress-step-header">
                    <i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span>
                </div>
                <div class="progress-step-date">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // å·¦å´è¡¨ç¤ºç”¨ - å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—
    function generateLeftDisplayDynamicStepHtml(step) {
        const stepData = step.data || {};
        const stepKey = step.key;
        let stepName = stepKey;
        let stepIcon = 'fas fa-circle';

        // ã‚¹ãƒ†ãƒƒãƒ—åã¨ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®š
        switch (stepKey) {
            case 'survey':
                stepName = 'ç¾å ´èª¿æŸ»';
                stepIcon = 'fas fa-search-location';
                break;
            case 'material_order':
                stepName = 'éƒ¨æç™ºæ³¨';
                stepIcon = 'fas fa-shopping-cart';
                break;
            case 'delivery':
                stepName = 'ç´å“';
                stepIcon = 'fas fa-truck';
                break;
            case 'inspection':
                stepName = 'æ¤œæŸ»';
                stepIcon = 'fas fa-clipboard-check';
                break;
            case 'handover':
                stepName = 'å¼•ãæ¸¡ã—';
                stepIcon = 'fas fa-key';
                break;
            case 'maintenance':
                stepName = 'ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹';
                stepIcon = 'fas fa-tools';
                break;
            case 'warranty':
                stepName = 'ä¿è¨¼å¯¾å¿œ';
                stepIcon = 'fas fa-shield-alt';
                break;
            case 'final_report':
                stepName = 'æœ€çµ‚å ±å‘Š';
                stepIcon = 'fas fa-file-alt';
                break;
            case 'customer_satisfaction':
                stepName = 'é¡§å®¢æº€è¶³åº¦èª¿æŸ»';
                stepIcon = 'fas fa-star';
                break;
            case 'payment_confirmation':
                stepName = 'å…¥é‡‘ç¢ºèª';
                stepIcon = 'fas fa-money-check-alt';
                break;
            case 'project_closure':
                stepName = 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå®Œäº†';
                stepIcon = 'fas fa-certificate';
                break;
            default:
                stepName = stepData.name || stepKey;
                break;
        }

        const isCompleted = stepData.completed || stepData.date || stepData.value;
        let statusHtml = 'æœªå®Œäº†';

        if (stepData.type === 'date' && stepData.date) {
            statusHtml = `<i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(stepData.date)}`;
        } else if (stepData.type === 'checkbox' && stepData.completed) {
            statusHtml = '<i class="fas fa-check-circle me-1"></i>å®Œäº†æ¸ˆã¿';
        } else if (stepData.type === 'text' && stepData.value) {
            statusHtml = `<i class="fas fa-check-circle me-1"></i>${stepData.value}`;
        }

        const completedClass = isCompleted ? 'completed' : '';

        return `
            <div class="progress-step ${completedClass}" data-step="${stepKey}">
                <div class="progress-step-header">
                    <i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span>
                </div>
                <div class="progress-step-date">
                    ${statusHtml}
                </div>
            </div>
        `;
    }

    // é™çš„ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
    function generateStaticStepHtml(step) {
        switch (step.key) {
            case 'estimate':
                return generateEstimateStepHtml();
            case 'survey':
                return generateSurveyStepHtml();
            case 'contract':
                return generateContractStepHtml();
            case 'work_start':
                return generateWorkStartStepHtml();
            case 'work_end':
                return generateWorkEndStepHtml();
            case 'invoice':
                return generateInvoiceStepHtml();
            default:
                return '';
        }
    }

    // å‹•çš„ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateDynamicStepHtml(step) {
        const stepData = step.data || {};
        const stepKey = step.key;

        let stepName = stepKey;
        let stepIcon = 'fas fa-circle';

        // ã‚¹ãƒ†ãƒƒãƒ—åã¨ã‚¢ã‚¤ã‚³ãƒ³ã®è¨­å®š
        switch (stepKey) {
            case 'contract':
                stepName = 'å¥‘ç´„';
                stepIcon = 'fas fa-handshake';
                break;
            case 'invoice':
                stepName = 'è«‹æ±‚æ›¸ç™ºè¡Œ';
                stepIcon = 'fas fa-file-invoice-dollar';
                break;
            case 'survey':
                stepName = 'ç¾å ´èª¿æŸ»';
                stepIcon = 'fas fa-search';
                break;
            case 'permit_application':
                stepName = 'è¨±å¯ç”³è«‹';
                stepIcon = 'fas fa-file-signature';
                break;
            case 'material_order':
                stepName = 'ææ–™ç™ºæ³¨';
                stepIcon = 'fas fa-boxes';
                break;
            case 'safety_training':
                stepName = 'å®‰å…¨è¬›ç¿’';
                stepIcon = 'fas fa-hard-hat';
                break;
            case 'final_inspection':
                stepName = 'å®Œæˆæ¤œæŸ»';
                stepIcon = 'fas fa-clipboard-check';
                break;
            case 'handover':
                stepName = 'å¼•æ¸¡ã—';
                stepIcon = 'fas fa-key';
                break;
            case 'warranty_issue':
                stepName = 'ä¿è¨¼æ›¸ç™ºè¡Œ';
                stepIcon = 'fas fa-certificate';
                break;
        }

        // contractã¨invoiceã¯ç‰¹åˆ¥ãªå‡¦ç†ãŒå¿…è¦ï¼ˆprojectDataã‹ã‚‰å–å¾—ï¼‰
        let dateValue, completedValue;
        if (stepKey === 'contract') {
            dateValue = projectData.contract_date;
        } else if (stepKey === 'invoice') {
            completedValue = projectData.invoice_issued;
        } else {
            dateValue = stepData.date;
            completedValue = stepData.completed;
        }

        const isCompleted = completedValue || dateValue || stepData.value;
        let statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';

        if (stepData.type === 'date' && dateValue) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(dateValue)}</div>`;
        } else if (stepData.type === 'checkbox' && completedValue) {
            statusHtml = '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†æ¸ˆã¿</div>';
        } else if (stepData.type === 'text' && stepData.value) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>${stepData.value}</div>`;
        }

        let fieldHtml = '';
        if (stepData.type === 'date') {
            fieldHtml = `
                <label class="form-label">${stepName}æ—¥</label>
                <input type="date" name="${stepKey}_date" class="form-control" value="${dateValue || ''}">
            `;
        } else if (stepData.type === 'checkbox') {
            fieldHtml = `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="${stepKey}_completed"
                           id="${stepKey}Completed" ${completedValue ? 'checked' : ''}>
                    <label class="form-check-label" for="${stepKey}Completed">
                        <i class="fas fa-check me-1"></i>${stepName}å®Œäº†
                    </label>
                </div>
            `;
        } else {
            fieldHtml = `
                <label class="form-label">${stepName}</label>
                <input type="text" name="${stepKey}_value" class="form-control" value="${stepData.value || ''}">
            `;
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="${stepKey}">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="${stepIcon} me-2"></i><span class="progress-step-label">${stepName}</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="${stepKey}" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    ${fieldHtml}
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-sm save-step-btn" data-step="${stepKey}">
                            <i class="fas fa-save me-1"></i>ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // è¦‹ç©æ›¸ç™ºè¡Œã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateEstimateStepHtml() {
        const isCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;
        let statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';

        if (projectData.estimate_not_required) {
            statusHtml = '<div class="progress-step-date"><i class="fas fa-times-circle me-1"></i>è¦‹ç©ä¸è¦</div>';
        } else if (projectData.estimate_issued_date) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.estimate_issued_date)}</div>`;
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : 'active'}" data-step="estimate">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-file-invoice me-2"></i><span class="progress-step-label">è¦‹ç©æ›¸ç™ºè¡Œ</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="estimate" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <label class="form-label">è¦‹ç©æ›¸ç™ºè¡Œæ—¥</label>
                        <input type="date" name="estimate_issued_date" class="form-control"
                               value="${projectData.estimate_issued_date || ''}" ${projectData.estimate_not_required ? 'disabled' : ''}>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="estimate_not_required"
                               id="estimateNotRequired" ${projectData.estimate_not_required ? 'checked' : ''}>
                        <label class="form-check-label" for="estimateNotRequired">
                            <i class="fas fa-times me-1"></i>è¦‹ç©æ›¸ä¸è¦
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // ç¾åœ°èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateSurveyStepHtml() {
        // å®Ÿéš›ã®èª¿æŸ»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆsurveyså¤‰æ•°ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰æ¸¡ã•ã‚Œã¦ã„ã‚‹å ´åˆï¼‰
        let isCompleted = false;
        let statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';

        {% if surveys %}
        // å®Œäº†ã—ãŸèª¿æŸ»ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const completedSurveys = [{% for survey in surveys %}{% if survey.status == 'completed' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        const inProgressSurveys = [{% for survey in surveys %}{% if survey.status == 'in_progress' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        const scheduledSurveys = [{% for survey in surveys %}{% if survey.status == 'scheduled' %}{ id: '{{ survey.id }}', date: '{{ survey.scheduled_date|date:"m/d" }}', time: '{{ survey.scheduled_start_time|time:"H:i" }}' }{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];

        if (completedSurveys.length > 0) {
            isCompleted = true;
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${completedSurveys.length}ä»¶</div>`;
        } else if (inProgressSurveys.length > 0) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-play me-1"></i>å®Ÿæ–½ä¸­: ${inProgressSurveys.length}ä»¶</div>`;
        } else if (scheduledSurveys.length > 0) {
            // æ¬¡å›äºˆå®šã®èª¿æŸ»æ—¥æ™‚ã‚’è¡¨ç¤º
            const nextSurvey = scheduledSurveys[0];
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>äºˆå®š: ${scheduledSurveys.length}ä»¶ (æ¬¡å›: ${nextSurvey.date} ${nextSurvey.time})</div>`;
        }
        {% endif %}

        const hasEstimateCompleted = projectData.estimate_issued_date || projectData.estimate_not_required;

        return `
            <div class="progress-step ${isCompleted ? 'completed' : hasEstimateCompleted ? 'active' : ''}" data-step="survey">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-clipboard-list me-2"></i><span class="progress-step-label">ç¾åœ°èª¿æŸ»</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="survey" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="d-flex gap-2 mb-3">
{#                         <a href="#" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>èª¿æŸ»ä½œæˆ
                        </a>
{#                         <a href="#" class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-list me-1"></i>èª¿æŸ»ä¸€è¦§
                        </a>
                    </div>
                    {% if surveys %}
                    <div class="small">
                        <div class="mb-2"><strong>èª¿æŸ»çŠ¶æ³:</strong></div>
                        {% for survey in surveys|slice:":3" %}
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted">{{ survey.scheduled_date|date:"m/d" }} {{ survey.scheduled_start_time|time:"H:i" }}</span>
                            <span class="badge {% if survey.status == 'completed' %}bg-success{% elif survey.status == 'in_progress' %}bg-warning{% else %}bg-secondary{% endif %} small">
                                {{ survey.get_status_display }}
                            </span>
                        </div>
                        {% endfor %}
                        {% if surveys|length > 3 %}
                        <div class="text-muted small">ä»– {{ surveys|length|add:"-3" }}ä»¶...</div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="text-muted small">
                        <i class="fas fa-info-circle me-1"></i>èª¿æŸ»ãŒæœªã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™
                    </div>
                    {% endif %}
                </div>
            </div>
        `;
    }

    // å¥‘ç´„ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateContractStepHtml() {
        const isCompleted = projectData.contract_date;
        const statusHtml = isCompleted
            ? `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.contract_date)}</div>`
            : '<div class="progress-step-date">æœªå®Œäº†</div>';

        // Check if survey is completed to determine if contract should be active
        let hasSurveyCompleted = false;
        {% if surveys %}
        const completedSurveys = [{% for survey in surveys %}{% if survey.status == 'completed' %}'{{ survey.id }}'{% if not forloop.last %},{% endif %}{% endif %}{% endfor %}];
        hasSurveyCompleted = completedSurveys.length > 0;
        {% endif %}

        return `
            <div class="progress-step ${isCompleted ? 'completed' : hasSurveyCompleted ? 'active' : ''}" data-step="contract">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-handshake me-2"></i><span class="progress-step-label">å¥‘ç´„</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="contract" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <label class="form-label">å¥‘ç´„æ—¥</label>
                    <input type="date" name="contract_date" class="form-control" value="${projectData.contract_date || ''}">
                </div>
            </div>
        `;
    }

    // å·¥äº‹é–‹å§‹ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateWorkStartStepHtml() {
        const isCompleted = projectData.work_start_completed;
        const hasDate = projectData.work_start_date;

        let statusHtml;
        if (isCompleted) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.work_start_date)}</div>`;
        } else if (hasDate) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(projectData.work_start_date)}</div>`;
        } else {
            statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.contract_date ? 'active' : ''}" data-step="work_start">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-play-circle me-2"></i><span class="progress-step-label">å·¥äº‹é–‹å§‹</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="work_start" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <label class="form-label">å·¥äº‹é–‹å§‹æ—¥</label>
                        <input type="date" name="work_start_date" class="form-control" value="${projectData.work_start_date || ''}">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="work_start_completed"
                               id="workStartCompleted" ${projectData.work_start_completed ? 'checked' : ''}>
                        <label class="form-check-label" for="workStartCompleted">
                            <i class="fas fa-check me-1"></i>å·¥äº‹é–‹å§‹å®Œäº†
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // å·¥äº‹çµ‚äº†ã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateWorkEndStepHtml() {
        const isCompleted = projectData.work_end_completed;
        const hasDate = projectData.work_end_date;

        let statusHtml;
        if (isCompleted) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>å®Œäº†: ${formatDate(projectData.work_end_date)}</div>`;
        } else if (hasDate) {
            statusHtml = `<div class="progress-step-date"><i class="fas fa-calendar me-1"></i>äºˆå®š: ${formatDate(projectData.work_end_date)}</div>`;
        } else {
            statusHtml = '<div class="progress-step-date">æœªå®Œäº†</div>';
        }

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.work_start_completed ? 'active' : ''}" data-step="work_end">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-stop-circle me-2"></i><span class="progress-step-label">å·¥äº‹çµ‚äº†</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="work_end" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <div class="mb-3">
                        <label class="form-label">å·¥äº‹çµ‚äº†æ—¥</label>
                        <input type="date" name="work_end_date" class="form-control" value="${projectData.work_end_date || ''}">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="work_end_completed"
                               id="workEndCompleted" ${projectData.work_end_completed ? 'checked' : ''}>
                        <label class="form-check-label" for="workEndCompleted">
                            <i class="fas fa-check me-1"></i>å·¥äº‹çµ‚äº†å®Œäº†
                        </label>
                    </div>
                </div>
            </div>
        `;
    }

    // è«‹æ±‚æ›¸ç™ºè¡Œã‚¹ãƒ†ãƒƒãƒ—ã®HTMLç”Ÿæˆ
    function generateInvoiceStepHtml() {
        const isCompleted = projectData.invoice_issued;
        const statusHtml = isCompleted
            ? '<div class="progress-step-date"><i class="fas fa-check-circle me-1"></i>ç™ºè¡Œæ¸ˆã¿</div>'
            : '<div class="progress-step-date">æœªç™ºè¡Œ</div>';

        return `
            <div class="progress-step ${isCompleted ? 'completed' : projectData.work_end_completed ? 'active' : ''}" data-step="invoice">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="fas fa-receipt me-2"></i><span class="progress-step-label">è«‹æ±‚æ›¸ç™ºè¡Œ</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="invoice" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                ${statusHtml}
                <div class="progress-step-content">
                    <label class="form-label">è«‹æ±‚æ›¸ç™ºè¡Œ</label>
                    <select name="invoice_issued" class="form-select">
                        <option value="false" ${!projectData.invoice_issued ? 'selected' : ''}>æœªç™ºè¡Œ</option>
                        <option value="true" ${projectData.invoice_issued ? 'selected' : ''}>ç™ºè¡Œæ¸ˆã¿</option>
                    </select>
                </div>
            </div>
        `;
    }


    // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ5ã¤ + è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    const availableSteps = [
        // === ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆåŸºæœ¬5ã‚¹ãƒ†ãƒƒãƒ—ï¼‰ ===
        {
            name: 'ç«‹ã¡ä¼šã„æ—¥',
            icon: 'fas fa-user-check',
            key: 'attendance',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: 'äºˆå®šæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'actual_date',
                    label: 'å®Ÿæ–½æ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'staff_input_type',
                    label: 'æ‹…å½“è€…å…¥åŠ›æ–¹æ³•',
                    type: 'radio',
                    options: [
                        { value: 'existing', text: 'æ—¢å­˜æ‹…å½“è€…ã‹ã‚‰é¸æŠ' },
                        { value: 'new', text: 'æ–°è¦æ‹…å½“è€…ã‚’å…¥åŠ›' }
                    ],
                    default: 'existing'
                },
                {
                    name: 'staff_id',
                    label: 'æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰',
                    type: 'staff_select_list',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'existing'
                },
                {
                    name: 'staff_name',
                    label: 'æ‹…å½“è€…å',
                    type: 'text',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'new'
                }
            ],
            statuses: [
                { key: 'waiting', label: 'ç«‹ã¡ä¼šã„å¾…ã¡', color: 'warning' },
                { key: 'in_progress', label: 'ç«‹ã¡ä¼šã„ä¸­', color: 'info' },
                { key: 'completed', label: 'ç«‹ã¡ä¼šã„æ¸ˆã¿', color: 'success' }
            ]
        },
        {
            name: 'ç¾èª¿æ—¥',
            icon: 'fas fa-clipboard-list',
            key: 'survey',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: 'äºˆå®šæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'actual_date',
                    label: 'å®Ÿæ–½æ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'staff_input_type',
                    label: 'æ‹…å½“è€…å…¥åŠ›æ–¹æ³•',
                    type: 'radio',
                    options: [
                        { value: 'existing', text: 'æ—¢å­˜æ‹…å½“è€…ã‹ã‚‰é¸æŠ' },
                        { value: 'new', text: 'æ–°è¦æ‹…å½“è€…ã‚’å…¥åŠ›' }
                    ],
                    default: 'existing'
                },
                {
                    name: 'staff_id',
                    label: 'æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰',
                    type: 'staff_select_list',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'existing'
                },
                {
                    name: 'staff_name',
                    label: 'è·äººå',
                    type: 'text',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'new'
                }
            ],
            statuses: [
                { key: 'waiting', label: 'ç¾èª¿å¾…ã¡', color: 'warning' },
                { key: 'completed', label: 'ç¾èª¿æ¸ˆã¿', color: 'success' }
            ]
        },
        {
            name: 'è¦‹ç©ã‚‚ã‚Šç™ºè¡Œæ—¥',
            icon: 'fas fa-calculator',
            key: 'estimate',
            type: 'complex',
            fields: [
                {
                    name: 'issued_date',
                    label: 'ç™ºè¡Œæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'not_required',
                    label: 'è¦‹ç©ã‚‚ã‚Šä¸è¦',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'pending', label: 'è¦‹ç©ã‚‚ã‚Šæ›¸ç™ºè¡Œ', color: 'info' },
                { key: 'under_review', label: 'è¦‹ç©ã‚‚ã‚Šå¯©æŸ»ä¸­', color: 'warning' },
                { key: 'approved', label: 'è¦‹ç©ã‚‚ã‚Šæ‰¿èªæ¸ˆã¿', color: 'success' }
            ]
        },
        {
            name: 'ç€å·¥æ—¥',
            icon: 'fas fa-hard-hat',
            key: 'construction_start',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: 'äºˆå®šæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'actual_date',
                    label: 'å®Ÿæ–½æ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'staff_input_type',
                    label: 'è·äººå…¥åŠ›æ–¹æ³•',
                    type: 'radio',
                    options: [
                        { value: 'existing', text: 'æ—¢å­˜è·äººã‹ã‚‰é¸æŠ' },
                        { value: 'new', text: 'æ–°è¦è·äººã‚’å…¥åŠ›' }
                    ],
                    default: 'existing'
                },
                {
                    name: 'staff_id',
                    label: 'æ‹…å½“è€…ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰',
                    type: 'staff_select_list',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'existing'
                },
                {
                    name: 'staff_name',
                    label: 'è·äººå',
                    type: 'text',
                    required: false,
                    dependsOn: 'staff_input_type',
                    showWhen: 'new'
                }
            ],
            statuses: [
                { key: 'waiting', label: 'ç€å·¥æ—¥å¾…ã¡', color: 'warning' },
                { key: 'in_progress', label: 'å·¥äº‹ä¸­', color: 'primary' },
                { key: 'completed', label: 'å·¥äº‹å®Œäº†', color: 'success' }
            ]
        },
        {
            name: 'å®Œå·¥æ—¥',
            icon: 'fas fa-check-circle',
            key: 'completion',
            type: 'complex',
            fields: [
                {
                    name: 'scheduled_date',
                    label: 'äºˆå®šæ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'actual_date',
                    label: 'å®Ÿæ–½æ—¥',
                    type: 'date',
                    required: false
                },
                {
                    name: 'completed',
                    label: 'å®Œå·¥æ¸ˆã¿',
                    type: 'checkbox',
                    required: false
                }
            ],
            statuses: [
                { key: 'in_progress', label: 'æ–½å·¥ä¸­', color: 'info' },
                { key: 'completed', label: 'å®Œå·¥', color: 'success' }
            ]
        },

        // === è¿½åŠ ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚¹ãƒ†ãƒƒãƒ— ===
        {
            name: 'å¥‘ç´„',
            icon: 'fas fa-handshake',
            key: 'contract',
            type: 'date'
        },
        {
            name: 'è«‹æ±‚æ›¸ç™ºè¡Œ',
            icon: 'fas fa-file-invoice-dollar',
            key: 'invoice',
            type: 'checkbox'
        },
        {
            name: 'è¨±å¯ç”³è«‹',
            icon: 'fas fa-file-signature',
            key: 'permit_application',
            type: 'date'
        },
        // å°†æ¥æ‹¡å¼µç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¾‹ï¼š
        /*
        {
            name: 'ææ–™æ¤œæŸ»',
            icon: 'fas fa-clipboard-check',
            key: 'material_inspection',
            type: 'complex',
            fields: [
                {
                    name: 'inspection_date',
                    label: 'æ¤œæŸ»æ—¥',
                    type: 'date',
                    required: true
                },
                {
                    name: 'inspector_id',
                    label: 'æ¤œæŸ»å“¡',
                    type: 'select',
                    required: true,
                    options: [
                        { value: '', text: 'é¸æŠã—ã¦ãã ã•ã„' },
                        { value: 'inspector_1', text: 'æ¤œæŸ»å“¡A' },
                        { value: 'inspector_2', text: 'æ¤œæŸ»å“¡B' }
                    ]
                },
                {
                    name: 'passed',
                    label: 'æ¤œæŸ»åˆæ ¼',
                    type: 'checkbox',
                    required: false
                },
                {
                    name: 'notes',
                    label: 'å‚™è€ƒ',
                    type: 'text',
                    required: false
                }
            ]
        },
        */
        {
            name: 'ææ–™ç™ºæ³¨',
            icon: 'fas fa-boxes',
            key: 'material_order',
            type: 'date'
        },
        {
            name: 'å®‰å…¨è¬›ç¿’',
            icon: 'fas fa-hard-hat',
            key: 'safety_training',
            type: 'checkbox'
        },
        {
            name: 'å®Œæˆæ¤œæŸ»',
            icon: 'fas fa-clipboard-check',
            key: 'final_inspection',
            type: 'date'
        },
        {
            name: 'å¼•æ¸¡ã—',
            icon: 'fas fa-key',
            key: 'handover',
            type: 'date'
        },
        {
            name: 'ä¿è¨¼æ›¸ç™ºè¡Œ',
            icon: 'fas fa-certificate',
            key: 'warranty_issue',
            type: 'checkbox'
        }
    ];

    // Sortable.jsã®åˆæœŸåŒ–
    function initializeSortable() {
        const progressContainer = document.getElementById('activeSteps');

        if (sortable) {
            sortable.destroy();
        }

        sortable = Sortable.create(progressContainer, {
            animation: 150,
            disabled: !editMode,
            filter: 'button, .btn, input, select, textarea, .progress-step-content',
            preventOnFilter: false,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onStart: function (evt) {
                // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹æ™‚ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
                $('.progress-step-content').hide();
            },
            onEnd: function (evt) {
                // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†æ™‚ã®å‡¦ç†
                console.log('ã‚¹ãƒ†ãƒƒãƒ—é †åºå¤‰æ›´:', evt.oldIndex, '->', evt.newIndex);

                // ãƒ‰ãƒ©ãƒƒã‚°å¾Œã¯å…¨ã¦ã®å±•é–‹çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆè‡ªå‹•å±•é–‹ãªã—ï¼‰
                setTimeout(() => {
                    $('.progress-step').removeClass('expanded');
                    $('.progress-step-content').hide();
                }, 100);

                // ã“ã“ã§é †åºã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã™ã‚‹å‡¦ç†ã‚’è¿½åŠ å¯èƒ½
                saveStepOrder();
            }
        });
    }

    // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜
    function saveStepOrder() {
        const steps = [];
        $('#activeSteps .progress-step').each(function(index) {
            steps.push({
                step: $(this).data('step'),
                order: index,
                completed: $(this).hasClass('completed')  // å®Œäº†ãƒ•ãƒ©ã‚°ã‚‚ä¿å­˜
            });
        });
        console.log('æ–°ã—ã„é †åº:', steps);

        // é †åºã‚’hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è¨­å®š
        $('#stepOrderInput').val(JSON.stringify(steps));
    }

    // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã«è¡¨ç¤º
    function loadAvailableSteps() {
        const container = $('#availableSteps');
        container.empty();

        availableSteps.forEach(step => {
            // æ—¢ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ãƒ†ãƒƒãƒ—ã¯è¡¨ç¤ºã—ãªã„
            if ($('.progress-step[data-step="' + step.key + '"]').length > 0) {
                return;
            }

            // ç‰¹åˆ¥å‡¦ç†ã¯ä¸è¦ - ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªãƒ¼ã«è¡¨ç¤º

            const stepHtml = `
                <div class="col-md-4 mb-2">
                    <div class="card border-dashed">
                        <div class="card-body p-2 text-center">
                            <i class="${step.icon} mb-1"></i><br>
                            <small>${step.name}</small><br>
                            <button type="button" class="btn btn-success btn-sm add-step-btn mt-1"
                                    data-step-key="${step.key}">
                                <i class="fas fa-plus"></i> è¿½åŠ 
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.append(stepHtml);
        });
    }

    // ã‚¹ãƒ†ãƒƒãƒ—è¿½åŠ 
    $(document).on('click', '.add-step-btn', function() {
        const stepKey = $(this).data('step-key');
        const stepData = availableSteps.find(s => s.key === stepKey);
        const $btn = $(this);

        console.log('Add step button clicked:', stepKey);
        console.log('Edit mode:', editMode);
        console.log('Step data found:', stepData);

        if (!editMode) {
            console.error('Not in edit mode! Cannot add step.');
            if (typeof toastr !== 'undefined') {
                toastr.warning('ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
            } else {
                alert('ã‚¹ãƒ†ãƒƒãƒ—ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«å…¥ã£ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚');
            }
            return;
        }

        if (!stepData) {
            console.error('Step data not found for key:', stepKey);
            if (typeof toastr !== 'undefined') {
                toastr.error('ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            } else {
                alert('ã‚¹ãƒ†ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
            }
            return;
        }

        if (stepData) {
            // ã‚¹ãƒ†ãƒƒãƒ—ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const existingStep = $(`.progress-step[data-step="${stepKey}"]`);
            if (existingStep.length > 0) {
                console.log('Step already exists:', stepKey);
                if (typeof toastr !== 'undefined') {
                    toastr.info(`${stepData.name}ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                } else {
                    alert(`${stepData.name}ã¯æ—¢ã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚`);
                }
                return;
            }

            // ç¾åœ°èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã§ survey_required=false ã®å ´åˆã¯APIã‚’å‘¼ã¶
            if (stepData.key === 'survey' && stepData.apiEndpoint && !{% if project.survey_required %}true{% else %}false{% endif %}) {
                $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> è¿½åŠ ä¸­...');

                fetch(stepData.apiEndpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // æˆåŠŸæ™‚ï¼šãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦æ–°ã—ã„ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¡¨ç¤º
                        location.reload();
                    } else {
                        alert('ã‚¹ãƒ†ãƒƒãƒ—ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + data.error);
                        $btn.prop('disabled', false).html('<i class="fas fa-plus"></i> è¿½åŠ ');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                    $btn.prop('disabled', false).html('<i class="fas fa-plus"></i> è¿½åŠ ');
                });
            } else {
                // é€šå¸¸ã®ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆï¼ˆåŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã‚‚å«ã‚€ï¼‰
                if (stepData.type === 'basic') {
                    // åŸºæœ¬ã‚¹ãƒ†ãƒƒãƒ—ã®å ´åˆã¯å¯¾å¿œã™ã‚‹HTMLç”Ÿæˆé–¢æ•°ã‚’å‘¼ã¶
                    let stepHtml = '';
                    switch (stepData.key) {
                        case 'estimate':
                            stepHtml = generateEstimateStepHtml();
                            break;
                        case 'survey':
                            stepHtml = generateSurveyStepHtml();
                            break;
                        case 'contract':
                            stepHtml = generateContractStepHtml();
                            break;
                        case 'work_start':
                            stepHtml = generateWorkStartStepHtml();
                            break;
                        case 'work_end':
                            stepHtml = generateWorkEndStepHtml();
                            break;
                        case 'invoice':
                            stepHtml = generateInvoiceStepHtml();
                            break;
                        default:
                            stepHtml = generateAvailableStepHtml(stepData);
                    }

                    // è«‹æ±‚æ›¸ç™ºè¡Œã®å‰ã«æŒ¿å…¥
                    const invoiceStep = $('.progress-step[data-step="invoice"]');
                    if (invoiceStep.length > 0) {
                        invoiceStep.before(stepHtml);
                        console.log(`Added step ${stepData.key} before invoice step`);
                    } else {
                        $('#activeSteps').append(stepHtml);
                        console.log(`Added step ${stepData.key} to end of active steps`);
                    }

                    // é€šçŸ¥ã‚’è¡¨ç¤º
                    if (typeof toastr !== 'undefined') {
                        toastr.success(`${stepData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
                    } else {
                        alert(`${stepData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
                    }
                } else {
                    addStepToProgress(stepData);
                }
                $(this).closest('.col-md-4').remove();

                // Sortableã‚’å†åˆæœŸåŒ–
                initializeSortable();
                // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ä¿å­˜
                saveStepOrder();
                // è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°
                updateSurveyAreaVisibility();

                console.log(`Step ${stepData.key} (${stepData.name}) successfully added to progress timeline`);
            }
        }
    });

    // ã‚¹ãƒ†ãƒƒãƒ—å‰Šé™¤ - ãƒ¢ãƒ¼ãƒ€ãƒ«ä½¿ç”¨
    let pendingDeleteBtn = null;

    $(document).on('click', '.remove-step-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();

        // ã‚¢ã‚¤ã‚³ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã‚‚ç¢ºå®Ÿã«ãƒœã‚¿ãƒ³è¦ç´ ã‚’å–å¾—
        const $btn = $(e.target).closest('.remove-step-btn');
        const stepKey = $btn.data('step');
        console.log(`Remove button clicked for step: ${stepKey}`);

        if (!stepKey) {
            console.error('Step key not found');
            return;
        }

        // ã‚¹ãƒ†ãƒƒãƒ—åã‚’å–å¾—
        const stepName = $btn.closest('.progress-step').find('.progress-step-header span').text().trim();

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚¹ãƒ†ãƒƒãƒ—åã‚’è¨­å®š
        $('#stepDeleteName').text(`ã€${stepName}ã€‘`);

        // å‰Šé™¤ãƒœã‚¿ãƒ³ã®å‚ç…§ã‚’ä¿å­˜
        pendingDeleteBtn = $btn;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        const deleteModal = new bootstrap.Modal(document.getElementById('stepDeleteModal'));
        deleteModal.show();
    });

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å‰Šé™¤ç¢ºå®šãƒœã‚¿ãƒ³
    $('#confirmStepDelete').on('click', function() {
        if (!pendingDeleteBtn) {
            console.error('No pending delete button');
            return;
        }

        const stepKey = pendingDeleteBtn.data('step');
        const stepName = pendingDeleteBtn.closest('.progress-step').find('.progress-step-header span').text().trim();

        console.log(`Removing step: ${stepKey}`);

        // ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤
        pendingDeleteBtn.closest('.progress-step').remove();

        // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’æ›´æ–°ï¼ˆé‡è¦ï¼ã“ã‚ŒãŒãªã„ã¨å‰Šé™¤ãŒä¿å­˜ã•ã‚Œãªã„ï¼‰
        saveStepOrder();

        loadAvailableSteps(); // ã‚¤ãƒ³ãƒ™ãƒ³ãƒˆãƒªã‚’å†èª­ã¿è¾¼ã¿
        initializeSortable(); // Sortableã‚’å†åˆæœŸåŒ–
        updateSurveyAreaVisibility(); // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°

        console.log(`Step ${stepKey} removed and order updated`);

        // ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const deleteModal = bootstrap.Modal.getInstance(document.getElementById('stepDeleteModal'));
        deleteModal.hide();

        // æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚¹ãƒ†ãƒƒãƒ—åã‚’è¨­å®š
        $('#stepDeleteSuccessName').text(`ã€${stepName}ã€‘`);

        // æˆåŠŸãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        const successModal = new bootstrap.Modal(document.getElementById('stepDeleteSuccessModal'));
        successModal.show();

        // å‚ç…§ã‚’ã‚¯ãƒªã‚¢
        pendingDeleteBtn = null;
    });

    // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‹ã‚‰å®Œå…¨ãªã‚¹ãƒ†ãƒƒãƒ—HTMLã‚’ç”Ÿæˆ
    function generateAvailableStepHtml(stepData) {
        const fieldHtml = generateFieldHtml(stepData);

        return `
            <div class="progress-step" data-step="${stepData.key}">
                <div class="progress-step-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-grip-vertical drag-handle me-2" title="ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ä¸¦ã³æ›¿ãˆ"></i>
                        <span><i class="${stepData.icon} me-2"></i><span class="progress-step-label">${stepData.name}</span></span>
                    </div>
                    <button type="button" class="btn btn-outline-danger btn-sm remove-step-btn"
                            data-step="${stepData.key}" title="ã‚¹ãƒ†ãƒƒãƒ—ã‚’å‰Šé™¤">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>
                <div class="progress-step-date">æœªå®Œäº†</div>
                <div class="progress-step-content">
                    ${fieldHtml}
                    <div class="mt-3">
                        <button type="button" class="btn btn-primary btn-sm save-step-btn" data-step="${stepData.key}">
                            <i class="fas fa-save me-1"></i>ä¿å­˜
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ã«ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ 
    function addStepToProgress(stepData) {
        const stepHtml = generateAvailableStepHtml(stepData);

        // è«‹æ±‚æ›¸ç™ºè¡Œã®å‰ã«æŒ¿å…¥
        const invoiceStep = $('.progress-step[data-step="invoice"]');
        if (invoiceStep.length > 0) {
            invoiceStep.before(stepHtml);
        } else {
            $('#activeSteps').append(stepHtml);
        }

        // Sortableã‚’å†åˆæœŸåŒ–
        initializeSortable();

        // ã‚¹ãƒ†ãƒƒãƒ—é †åºã‚’ä¿å­˜
        saveStepOrder();

        // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®è¡¨ç¤ºåˆ¶å¾¡ã‚’æ›´æ–°
        updateSurveyAreaVisibility();

        console.log(`Added step: ${stepData.key} (${stepData.name})`);

        // é€šçŸ¥ã‚’è¡¨ç¤º
        if (typeof toastr !== 'undefined') {
            toastr.success(`${stepData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
        } else {
            alert(`${stepData.name}ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚ã€Œç·¨é›†å®Œäº†ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿å­˜ã—ã¦ãã ã•ã„ã€‚`);
        }
    }

    // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸHTMLã‚’ç”Ÿæˆ
    function generateFieldHtml(stepData) {
        switch (stepData.type) {
            case 'complex':
                return generateComplexFieldHtml(stepData);
            case 'date':
                return `
                    <label class="form-label">${stepData.name}æ—¥</label>
                    <input type="date" name="${stepData.key}_date" class="form-control">
                `;
            case 'checkbox':
                return `
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="${stepData.key}_completed"
                               id="${stepData.key}Completed">
                        <label class="form-check-label" for="${stepData.key}Completed">
                            <i class="fas fa-check me-1"></i>${stepData.name}å®Œäº†
                        </label>
                    </div>
                `;
            default:
                return `
                    <label class="form-label">${stepData.name}</label>
                    <input type="text" name="${stepData.key}_value" class="form-control">
                `;
        }
    }

    // è¤‡åˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®HTMLç”Ÿæˆ
    function generateComplexFieldHtml(stepData) {
        if (!stepData.fields || !Array.isArray(stepData.fields)) {
            return `<p class="text-muted">ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å®šç¾©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</p>`;
        }

        let html = '';
        stepData.fields.forEach(field => {
            const fieldId = `${stepData.key}_${field.name}`;
            const fieldName = `dynamic_field_${stepData.key}_${field.name}`;  // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 

            html += `<div class="mb-3">`;

            // dependencyå±æ€§ã‚’å‡¦ç†ï¼ˆdependsOn ã¨ showWhen ã‚’ã‚µãƒãƒ¼ãƒˆï¼‰
            const dependsOnField = field.dependsOn ? `dynamic_field_${stepData.key}_${field.dependsOn}` : '';
            const showWhenValue = field.showWhen || '';
            const dependencyAttr = dependsOnField ?
                `data-dependency-field="${dependsOnField}" data-dependency-value="${showWhenValue}"` : '';
            const initialDisplay = dependsOnField ? 'style="display: none;"' : '';

            // ä¾å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆéè¡¨ç¤ºã®å¯èƒ½æ€§ãŒã‚ã‚‹ï¼‰ã¯requiredã«ã—ãªã„
            const isRequired = field.required && !dependsOnField;

            switch (field.type) {
                case 'radio':
                    html += `<label class="form-label">${field.label}</label>`;
                    if (field.options && Array.isArray(field.options)) {
                        field.options.forEach((option, index) => {
                            const isDefault = field.default === option.value;
                            html += `
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="${fieldName}" id="${fieldId}_${index}"
                                           value="${option.value}" ${isDefault ? 'checked' : ''} ${isRequired ? 'required' : ''}>
                                    <label class="form-check-label" for="${fieldId}_${index}">
                                        ${option.text}
                                    </label>
                                </div>
                            `;
                        });
                    }
                    break;
                case 'date':
                    // complex_step_fieldsã‹ã‚‰å€¤ã‚’å–å¾—
                    const dateFieldKey = `${stepData.key}_${field.name}`;
                    const dateValue = complexStepFields[dateFieldKey] || '';
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}">${field.label}</label>
                            <input type="date" name="${fieldName}" id="${fieldId}" class="form-control" value="${dateValue}" ${isRequired ? 'required' : ''}>
                        </div>
                    `;
                    break;
                case 'select':
                    // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠã®å ´åˆã¯å‹•çš„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”Ÿæˆ
                    let options = field.options;
                    if (field.name === 'staff_id') {
                        options = generateStaffOptions();
                    }

                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}">${field.label}</label>
                            <select name="${fieldName}" id="${fieldId}" class="form-select" ${isRequired ? 'required' : ''}>
                    `;
                    if (options && Array.isArray(options)) {
                        options.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `</select>`;

                    // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ ï¼ˆã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ï¼‰
                    if (field.name === 'staff_id') {
                        html += `
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openStaffManagementPanel()">
                                <i class="fas fa-users-cog"></i> æ‹…å½“è€…ç®¡ç†
                            </button>
                        `;
                    }
                    html += `</div>`;
                    break;
                case 'multiselect':
                    // è¤‡æ•°é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆè·äººé¸æŠãªã©ï¼‰
                    let multioptions = field.options;
                    if (field.name === 'staff_ids') {
                        multioptions = generateStaffOptions();
                    }

                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}">${field.label}</label>
                            <select name="${fieldName}" id="${fieldId}" class="form-select" multiple size="5" ${isRequired ? 'required' : ''}>
                    `;
                    if (multioptions && Array.isArray(multioptions)) {
                        multioptions.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `</select>`;
                    html += `<small class="form-text text-muted">Ctrl/Cmdã‚­ãƒ¼ã‚’æŠ¼ã—ãªãŒã‚‰ã‚¯ãƒªãƒƒã‚¯ã§è¤‡æ•°é¸æŠ</small>`;

                    // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
                    if (field.name === 'staff_ids') {
                        html += `
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openStaffManagementPanel()">
                                <i class="fas fa-users-cog"></i> æ‹…å½“è€…ç®¡ç†
                            </button>
                        `;
                    }
                    html += `</div>`;
                    break;
                case 'text':
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label" for="${fieldId}">${field.label}</label>
                            <input type="text" name="${fieldName}" id="${fieldId}" class="form-control" ${isRequired ? 'required' : ''}>
                        </div>
                    `;
                    break;
                case 'checkbox':
                    html += `
                        <div class="form-check" ${dependencyAttr} ${initialDisplay}>
                            <input class="form-check-input" type="checkbox" name="${fieldName}" id="${fieldId}" ${isRequired ? 'required' : ''}>
                            <label class="form-check-label" for="${fieldId}">
                                <i class="fas fa-check me-1"></i>${field.label}
                            </label>
                        </div>
                    `;
                    break;
                case 'staff_select_list':
                    // å‹•çš„ã«è¿½åŠ å¯èƒ½ãªæ‹…å½“è€…é¸æŠãƒªã‚¹ãƒˆ
                    const staffOptions = generateStaffOptions();
                    html += `
                        <div ${dependencyAttr} ${initialDisplay}>
                            <label class="form-label">${field.label}</label>
                            <div class="staff-select-container" id="${fieldId}_container">
                                <div class="staff-select-item mb-2">
                                    <select name="${fieldName}" class="form-select form-select-sm d-inline-block" style="width: calc(100% - 50px);">
                                        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                    `;
                    if (staffOptions && Array.isArray(staffOptions)) {
                        staffOptions.forEach(option => {
                            html += `<option value="${option.value}">${option.text}</option>`;
                        });
                    }
                    html += `
                                    </select>
                                    <button type="button" class="btn btn-outline-danger btn-sm remove-staff-select-btn" style="display:none;">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm mt-2 add-staff-select-btn" data-container-id="${fieldId}_container" data-field-name="${fieldName}">
                                <i class="fas fa-plus me-1"></i>æ‹…å½“è€…ã‚’è¿½åŠ 
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm mt-2" onclick="openStaffManagementPanel()">
                                <i class="fas fa-users-cog me-1"></i>æ‹…å½“è€…ç®¡ç†
                            </button>
                        </div>
                    `;
                    break;
                default:
                    html += `<p class="text-warning">æœªå¯¾å¿œã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¿ã‚¤ãƒ—: ${field.type}</p>`;
            }

            html += `</div>`;
        });

        return html;
    }

    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
    function getComplexStepStatus(stepData, stepElement) {
        if (!stepData.fields || !Array.isArray(stepData.fields)) {
            return { completed: false, statusText: 'æœªå®Œäº†', status: 'pending' };
        }

        const values = {};
        stepData.fields.forEach(field => {
            const fieldName = `dynamic_field_${stepData.key}_${field.name}`;  // dynamic_field_ ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ 
            const input = stepElement.find(`[name="${fieldName}"]`);

            if (input.length > 0) {
                if (field.type === 'checkbox') {
                    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯booleanå€¤ã‚’è¿”ã™
                    values[field.name] = input.is(':checked');
                } else if (field.type === 'radio') {
                    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã¯é¸æŠã•ã‚Œã¦ã„ã‚‹å€¤ã®ã¿
                    if (input.is(':checked')) {
                        values[field.name] = input.val();
                    }
                } else if (field.type === 'multiselect') {
                    // è¤‡æ•°é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ - é…åˆ—ã‚’å‡¦ç†
                    const val = input.val();
                    if (val && Array.isArray(val) && val.length > 0) {
                        values[field.name] = val.join(',');
                    }
                } else {
                    // ãƒ†ã‚­ã‚¹ãƒˆã‚„æ—¥ä»˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ - ç©ºæ–‡å­—åˆ—ã¯å«ã‚ãªã„
                    const val = input.val();
                    if (val && typeof val === 'string' && val.trim() !== '') {
                        values[field.name] = val.trim();
                    }
                }
            }
        });

        // æ‹…å½“è€…åã‚’å–å¾—
        function getStaffInfo() {
            const inputType = values.staff_input_type || 'existing';
            if (inputType === 'existing' && values.staff_id) {
                return getStaffName(values.staff_id);
            } else if (inputType === 'new' && values.staff_name) {
                return values.staff_name;
            }
            return '';
        }

        // ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹åˆ¤å®š
        switch (stepData.key) {
            case 'attendance':  // ç«‹ã¡ä¼šã„æ—¥
                const attActual = values.actual_date;
                const attScheduled = values.scheduled_date;
                const attStaff = getStaffInfo();

                if (attActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">ç«‹ã¡ä¼šã„æ¸ˆã¿</span> ${formatDate(attActual)}${attStaff ? ' (' + attStaff + ')' : ''}`
                    };
                } else if (attScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">ç«‹ã¡ä¼šã„å¾…ã¡</span> ${formatDate(attScheduled)}${attStaff ? ' (' + attStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            case 'survey':  // ç¾èª¿æ—¥
                const surActual = values.actual_date;
                const surScheduled = values.scheduled_date;
                const surStaff = getStaffInfo();

                if (surActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">ç¾èª¿æ¸ˆã¿</span> ${formatDate(surActual)}${surStaff ? ' (' + surStaff + ')' : ''}`
                    };
                } else if (surScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">ç¾èª¿å¾…ã¡</span> ${formatDate(surScheduled)}${surStaff ? ' (' + surStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            case 'estimate':  // è¦‹ç©ã‚‚ã‚Šç™ºè¡Œæ—¥
                const estIssued = values.issued_date;
                const estNotRequired = values.not_required;

                if (estNotRequired) {
                    return {
                        completed: true,
                        status: 'approved',
                        statusText: '<span class="badge bg-success">è¦‹ç©ã‚‚ã‚Šä¸è¦</span>'
                    };
                } else if (estIssued) {
                    return {
                        completed: false,
                        status: 'under_review',
                        statusText: `<span class="badge bg-warning">è¦‹ç©ã‚‚ã‚Šå¯©æŸ»ä¸­</span> ${formatDate(estIssued)}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            case 'construction_start':  // ç€å·¥æ—¥
                const csActual = values.actual_date;
                const csScheduled = values.scheduled_date;
                const csStaff = getStaffInfo();

                if (csActual) {
                    return {
                        completed: true,
                        status: 'in_progress',
                        statusText: `<span class="badge bg-primary">å·¥äº‹ä¸­</span> ${formatDate(csActual)}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                } else if (csScheduled) {
                    return {
                        completed: false,
                        status: 'waiting',
                        statusText: `<span class="badge bg-warning">ç€å·¥æ—¥å¾…ã¡</span> ${formatDate(csScheduled)}${csStaff ? ' (' + csStaff + ')' : ''}`
                    };
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            case 'completion':  // å®Œå·¥æ—¥
                const compActual = values.actual_date;
                const compScheduled = values.scheduled_date;
                const compCompleted = values.completed;

                if (compCompleted || compActual) {
                    return {
                        completed: true,
                        status: 'completed',
                        statusText: `<span class="badge bg-success">å®Œå·¥</span> ${compActual ? formatDate(compActual) : ''}`
                    };
                } else if (compScheduled) {
                    // ç€å·¥æ—¥ã®çŠ¶æ…‹ã‚’ç¢ºèª
                    const constructionStartStep = $('#activeSteps .progress-step[data-step-key="construction_start"]');
                    let isConstructionStarted = false;

                    if (constructionStartStep.length > 0) {
                        const csActualInput = constructionStartStep.find('input[name*="actual_date"]');
                        isConstructionStarted = csActualInput.length > 0 && csActualInput.val() && csActualInput.val().trim() !== '';
                    }

                    if (isConstructionStarted) {
                        return {
                            completed: false,
                            status: 'in_progress',
                            statusText: `<span class="badge bg-info">æ–½å·¥ä¸­</span> äºˆå®š: ${formatDate(compScheduled)}`
                        };
                    } else {
                        return {
                            completed: false,
                            status: 'waiting',
                            statusText: `<span class="badge bg-warning">ç€å·¥å¾…ã¡</span> äºˆå®š: ${formatDate(compScheduled)}`
                        };
                    }
                } else {
                    return {
                        completed: false,
                        status: 'pending',
                        statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>'
                    };
                }

            default:
                // ãã®ä»–ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼šä½•ã‹å€¤ãŒã‚ã‚Œã°å®Œäº†
                const hasAnyValue = Object.values(values).some(value =>
                    typeof value === 'boolean' ? value : (value && value.trim && value.trim())
                );

                if (hasAnyValue) {
                    return { completed: true, status: 'completed', statusText: '<span class="badge bg-success">å®Œäº†</span>' };
                } else {
                    return { completed: false, status: 'pending', statusText: '<span class="badge bg-secondary">æœªå®Œäº†</span>' };
                }
        }
    }

    // æ‹…å½“è€…ãƒã‚¹ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰å–å¾—ï¼‰
    let staffMaster = [
        {% for worker in internal_workers %}
        {
            id: '{{ worker.id }}',
            name: '{{ worker.name }}',
            department: '{{ worker.get_department_display|default:"" }}',
            phone: '{{ worker.phone|default:"" }}',
            hourly_rate: parseFloat("{{ worker.hourly_rate|default:0 }}".replace(/,/g, '')) || 0,
            specialties: '{{ worker.specialties|default:"" }}',
            active: {% if worker.is_active %}true{% else %}false{% endif %}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // ã‚¹ã‚¿ãƒƒãƒ•åã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function getStaffName(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        return staff ? staff.name : 'ä¸æ˜';
    }

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªã‚¹ã‚¿ãƒƒãƒ•ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
    function generateStaffOptions() {
        const activeStaff = staffMaster.filter(s => s.active);
        return [
            { value: '', text: 'é¸æŠã—ã¦ãã ã•ã„' },
            ...activeStaff.map(staff => ({
                value: staff.id,
                text: `${staff.name} (${staff.department})`
            }))
        ];
    }

    // dependencyæ©Ÿèƒ½ - ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã§ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    $(document).on('change', 'input[type="radio"]', function() {
        const changedFieldName = $(this).attr('name');
        const selectedValue = $(this).val();

        // ã“ã®å¤‰æ›´ã«ä¾å­˜ã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ç¤º/éè¡¨ç¤º
        $(`[data-dependency-field="${changedFieldName}"]`).each(function() {
            const dependencyValue = $(this).data('dependency-value');
            if (selectedValue === dependencyValue) {
                $(this).show();
            } else {
                $(this).hide();
                // éè¡¨ç¤ºã«ãªã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å€¤ã‚’ã‚¯ãƒªã‚¢
                $(this).find('input, select').val('');
            }
        });
    });

    // è¤‡åˆã‚¹ãƒ†ãƒƒãƒ—ã®å¤‰æ›´ã‚’ç›£è¦–
    $(document).on('change', 'input[name^="survey_"], select[name^="survey_"]', function() {
        const stepElement = $('.progress-step[data-step="survey"]');
        if (stepElement.length === 0) return;

        // ç¾å ´èª¿æŸ»ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const sitesurvey = availableSteps.find(step => step.key === 'survey');
        if (!sitesurvey) return;

        const status = getComplexStepStatus(sitesurvey, stepElement);

        if (status.completed) {
            stepElement.addClass('completed');
        } else {
            stepElement.removeClass('completed');
        }

        stepElement.find('.progress-step-date').html(status.statusText);

        // é€²æ—æ›´æ–°
        updateProgressTimeline();
        updateProgressStatus();
    });

    // ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ãƒ‘ãƒãƒ«ã‚’é–‹ã
    window.openStaffManagementPanel = function() {
        $('#staffManagementModal').modal('show');
        refreshStaffList();
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆã‚’æ›´æ–°
    function refreshStaffList() {
        const tbody = $('#staffTableBody');
        tbody.empty();

        staffMaster.forEach((staff, index) => {
            const statusBadge = staff.active ?
                '<span class="badge bg-success">æœ‰åŠ¹</span>' :
                '<span class="badge bg-secondary">ç„¡åŠ¹</span>';

            const hourlyRateDisplay = staff.hourly_rate ? `Â¥${staff.hourly_rate}/æ™‚é–“` : '-';
            tbody.append(`
                <tr data-staff-id="${staff.id}">
                    <td>${staff.name}</td>
                    <td>${staff.department}</td>
                    <td>${hourlyRateDisplay}</td>
                    <td>${staff.specialties || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="editStaff('${staff.id}')">
                            <i class="fas fa-edit"></i> ç·¨é›†
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteStaff('${staff.id}')">
                            <i class="fas fa-trash"></i> å‰Šé™¤
                        </button>
                    </td>
                </tr>
            `);
        });
    }

    // ã‚¹ã‚¿ãƒƒãƒ•è¿½åŠ 
    window.addNewStaff = function() {
        $('#staffModalTitle').text('æ–°ã—ã„æ‹…å½“è€…ã‚’è¿½åŠ ');
        $('#staffForm')[0].reset();
        $('#staffId').val('');
        $('#staffModal').modal('show');
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†
    window.editStaff = function(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        if (!staff) return;

        $('#staffModalTitle').text('æ‹…å½“è€…ã‚’ç·¨é›†');
        $('#staffId').val(staff.id);
        $('#staffName').val(staff.name);
        $('#staffDepartment').val(staff.department);
        $('#staffPhone').val(staff.phone || '');
        $('#staffHourlyRate').val(staff.hourly_rate || '');
        $('#staffSpecialties').val(staff.specialties || '');
        $('#staffActive').prop('checked', staff.active);
        $('#staffModal').modal('show');
    };

    // ã‚¹ã‚¿ãƒƒãƒ•å‰Šé™¤
    window.deleteStaff = function(staffId) {
        const staff = staffMaster.find(s => s.id === staffId);
        if (!staff) return;

        if (confirm(`ã€Œ${staff.name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            $.ajax({
                url: `/orders/api/staff/${staffId}/`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        staffMaster = staffMaster.filter(s => s.id !== staffId);
                        refreshStaffList();
                        updateStaffSelects();
                    } else {
                        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.error);
                    }
                },
                error: function() {
                    alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            });
        }
    };

    // ã‚¹ã‚¿ãƒƒãƒ•ä¿å­˜
    window.saveStaff = function() {
        const staffId = $('#staffId').val();
        const name = $('#staffName').val().trim();
        const department = $('#staffDepartment').val().trim();
        const phone = $('#staffPhone').val().trim();
        const hourly_rate = parseFloat($('#staffHourlyRate').val()) || 0;
        const specialties = $('#staffSpecialties').val().trim();
        const active = $('#staffActive').is(':checked');

        if (!name) {
            alert('æ‹…å½“è€…åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        const staffData = {
            name: name,
            department: department,
            phone: phone,
            hourly_rate: hourly_rate,
            specialties: specialties,
            active: active
        };

        if (staffId) {
            // æ—¢å­˜ã‚¹ã‚¿ãƒƒãƒ•ã‚’æ›´æ–°
            $.ajax({
                url: `/orders/api/staff/${staffId}/`,
                method: 'PUT',
                data: JSON.stringify(staffData),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        const staff = staffMaster.find(s => s.id === staffId);
                        if (staff) {
                            Object.assign(staff, response.staff);
                        }
                        $('#staffModal').modal('hide');
                        refreshStaffList();
                        updateStaffSelects();
                    } else {
                        alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.error);
                    }
                },
                error: function() {
                    alert('æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            });
        } else {
            // æ–°ã—ã„ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ 
            $.ajax({
                url: '/orders/api/staff/',
                method: 'POST',
                data: JSON.stringify(staffData),
                contentType: 'application/json',
                success: function(response) {
                    if (response.success) {
                        staffMaster.push(response.staff);
                        $('#staffModal').modal('hide');
                        refreshStaffList();
                        updateStaffSelects();
                    } else {
                        alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.error);
                    }
                },
                error: function() {
                    alert('è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                }
            });
        }
    };

    // å…¨ã¦ã®ã‚¹ã‚¿ãƒƒãƒ•é¸æŠãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    function updateStaffSelects() {
        const newOptions = generateStaffOptions();
        $('select[name="survey_staff_id"]').each(function() {
            const currentValue = $(this).val();
            $(this).empty();
            newOptions.forEach(option => {
                const selected = option.value === currentValue ? 'selected' : '';
                $(this).append(`<option value="${option.value}" ${selected}>${option.text}</option>`);
            });
        });
    }

    // åˆæœŸåŒ–å‡¦ç†
    $(document).ready(function() {
        console.log('Document ready - starting step initialization');

        // ç¾åœ°èª¿æŸ»ã‚¨ãƒªã‚¢ã®å­˜åœ¨ç¢ºèª
        console.log('Survey content area exists:', $('#surveyContentArea').length);
        console.log('Survey content area visible:', $('#surveyContentArea').is(':visible'));

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ã—ã¦ã‹ã‚‰åˆæœŸåŒ–
        setTimeout(function() {
            console.log('Clearing fallback display and initializing steps');
            $('#activeSteps').empty();

            // ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆæœŸåŒ–
            initializeSteps();
            // åˆ©ç”¨å¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒ­ãƒ¼ãƒ‰
            loadAvailableSteps();
            // ãƒ•ã‚©ãƒ¼ãƒ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®åˆæœŸå€¤ã«åŸºã¥ã„ã¦ã‚¹ãƒ†ãƒƒãƒ—çŠ¶æ…‹ã‚’åŒæœŸ
            syncFormFieldsToSteps();

            // åˆæœŸçŠ¶æ…‹ã§ç·¨é›†è¦ç´ ã‚’éš ã™ï¼ˆeditMode = falseï¼‰
            console.log('Setting initial edit mode state (OFF)');
            $('.remove-step-btn').hide();
            $('.drag-handle').hide();
            $('#stepInventory').hide();

            console.log('Step initialization complete');
        }, 100);
    });
});

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ç¢ºèª - Phase 5
function confirmFileDelete(fileId, fileName) {
    if (confirm(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        const form = document.getElementById('fileDeleteForm');
        form.action = `/orders/projects/${projectId}/files/${fileId}/delete/`;
        form.submit();
    }
}
</script>

<!-- æ‹…å½“è€…ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffManagementModal" tabindex="-1" aria-labelledby="staffManagementModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffManagementModalLabel">
                    <i class="fas fa-users"></i> æ‹…å½“è€…ç®¡ç†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h6 class="mb-0">æ‹…å½“è€…ä¸€è¦§</h6>
                    <button type="button" class="btn btn-primary btn-sm" onclick="addNewStaff()">
                        <i class="fas fa-plus"></i> æ–°è¦è¿½åŠ 
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>åå‰</th>
                                <th>éƒ¨ç½²</th>
                                <th>æ™‚çµ¦</th>
                                <th>å°‚é–€åˆ†é‡</th>
                                <th>çŠ¶æ…‹</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="staffTableBody">
                            <!-- ã‚¹ã‚¿ãƒƒãƒ•ãƒªã‚¹ãƒˆãŒå‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">é–‰ã˜ã‚‹</button>
            </div>
        </div>
    </div>
</div>

<!-- æ‹…å½“è€…ç·¨é›†/è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div class="modal fade" id="staffModal" tabindex="-1" aria-labelledby="staffModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staffModalTitle">æ‹…å½“è€…ã‚’è¿½åŠ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="staffForm">
                    <input type="hidden" id="staffId" name="id">
                    <div class="mb-3">
                        <label for="staffName" class="form-label">æ‹…å½“è€…å <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="staffName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="staffDepartment" class="form-label">éƒ¨ç½²</label>
                        <input type="text" class="form-control" id="staffDepartment" name="department">
                    </div>
                    <div class="mb-3">
                        <label for="staffHourlyRate" class="form-label">æ™‚çµ¦</label>
                        <div class="input-group">
                            <span class="input-group-text">Â¥</span>
                            <input type="number" class="form-control" id="staffHourlyRate" name="hourly_rate" placeholder="ä¾‹: 3000">
                            <span class="input-group-text">/æ™‚é–“</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="staffSpecialties" class="form-label">å°‚é–€åˆ†é‡</label>
                        <input type="text" class="form-control" id="staffSpecialties" name="specialties" placeholder="ä¾‹: é›»æ°—å·¥äº‹ã€é…ç®¡">
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="staffActive" name="active" checked>
                        <label class="form-check-label" for="staffActive">
                            æœ‰åŠ¹
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" class="btn btn-primary" onclick="saveStaff()">ä¿å­˜</button>
            </div>
        </div>
    </div>
</div>

<!-- æ¡ˆä»¶ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ - Phase 5 -->
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-info text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-folder-open me-2"></i>ãƒ•ã‚¡ã‚¤ãƒ«ç®¡ç†
                </h5>
                <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-light btn-sm">
                    <i class="fas fa-cloud-upload-alt me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
        </div>
        <div class="card-body">
            {% if project.files.all %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th width="40%">ãƒ•ã‚¡ã‚¤ãƒ«å</th>
                                <th width="15%">ã‚µã‚¤ã‚º</th>
                                <th width="20%">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰è€…</th>
                                <th width="15%">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ—¥æ™‚</th>
                                <th width="10%" class="text-center">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for file in project.files.all %}
                            <tr>
                                <td>
                                    {% if 'pdf' in file.file_type %}
                                        <i class="fas fa-file-pdf text-danger me-2"></i>
                                    {% elif 'word' in file.file_type or 'document' in file.file_type %}
                                        <i class="fas fa-file-word text-primary me-2"></i>
                                    {% elif 'excel' in file.file_type or 'spreadsheet' in file.file_type %}
                                        <i class="fas fa-file-excel text-success me-2"></i>
                                    {% elif 'image' in file.file_type or 'jpg' in file.file_type or 'png' in file.file_type %}
                                        <i class="fas fa-file-image text-info me-2"></i>
                                    {% else %}
                                        <i class="fas fa-file text-secondary me-2"></i>
                                    {% endif %}
                                    <strong>{{ file.file_name }}</strong>
                                    {% if file.description %}
                                        <br><small class="text-muted ms-4">{{ file.description }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="badge bg-light text-dark">{{ file.get_file_size_display }}</span>
                                </td>
                                <td>
                                    {% if file.uploaded_by %}
                                        <i class="fas fa-user-circle me-1"></i>{{ file.uploaded_by.get_full_name|default:file.uploaded_by.username }}
                                    {% else %}
                                        <span class="text-muted">ä¸æ˜</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ file.uploaded_at|date:"Y/m/d H:i" }}</small>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'order_management:project_file_download' project.pk file.pk %}"
                                           class="btn btn-outline-primary"
                                           title="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button type="button"
                                                class="btn btn-outline-danger"
                                                onclick="confirmFileDelete({{ file.pk }}, '{{ file.file_name }}')"
                                                title="å‰Šé™¤">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-folder-open fa-3x mb-3"></i>
                    <p class="mb-2">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                    <a href="{% url 'order_management:project_file_upload' project.pk %}" class="btn btn-info">
                        <i class="fas fa-cloud-upload-alt me-1"></i>æœ€åˆã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                    </a>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ç¢ºèªç”¨ã®ãƒ•ã‚©ãƒ¼ãƒ  (éè¡¨ç¤º) - Phase 5 -->
<form id="fileDeleteForm" method="post" style="display: none;">
    {% csrf_token %}
</form>

<!-- æ¡ˆä»¶ãƒãƒ£ãƒƒãƒˆãƒ»ã‚³ãƒ¡ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div class="container mt-5 mb-5">
    <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-comments me-2"></i>æ¡ˆä»¶ã‚³ãƒ¡ãƒ³ãƒˆãƒ»ãƒãƒ£ãƒƒãƒˆ
            </h5>
        </div>
        <div class="card-body">
            <!-- ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ -->
            <div id="comments-container" class="mb-4" style="max-height: 500px; overflow-y: auto;">
                <!-- ã‚³ãƒ¡ãƒ³ãƒˆã¯JavaScriptã§å‹•çš„ã«èª­ã¿è¾¼ã¿ -->
                <div class="text-center text-muted py-5">
                    <i class="fas fa-spinner fa-spin fa-2x"></i>
                    <p class="mt-2">ã‚³ãƒ¡ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
                </div>
            </div>

            <!-- ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ãƒ•ã‚©ãƒ¼ãƒ  -->
            <div class="comment-form">
                <form id="comment-form" onsubmit="return false;">
                    <div class="mb-3">
                        <textarea
                            id="comment-content"
                            class="form-control"
                            rows="3"
                            placeholder="ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„... (@ãƒ¦ãƒ¼ã‚¶ãƒ¼å ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§ãã¾ã™)"
                            required
                        ></textarea>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> @ãƒ¦ãƒ¼ã‚¶ãƒ¼å ã§ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã™ã‚‹ã¨ã€ãã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥ãŒé€ã‚‰ã‚Œã¾ã™
                        </small>
                    </div>

                    <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                    <div class="mb-3">
                        <label class="form-label">
                            <i class="fas fa-paperclip me-1"></i>ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ·»ä»˜ (è¤‡æ•°é¸æŠå¯)
                        </label>
                        <input
                            type="file"
                            class="form-control"
                            id="comment-files"
                            multiple
                            accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.txt"
                        >
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i> ç”»åƒã€PDFã€Officeæ–‡æ›¸ã«å¯¾å¿œï¼ˆæœ€å¤§10MB/ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
                        </small>
                        <!-- é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ -->
                        <div id="file-preview" class="mt-2"></div>
                    </div>

                    <div class="form-check mb-3">
                        <input
                            type="checkbox"
                            class="form-check-input"
                            id="comment-important"
                        >
                        <label class="form-check-label" for="comment-important">
                            <i class="fas fa-exclamation-triangle text-warning"></i> é‡è¦ãªã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦ãƒãƒ¼ã‚¯ã™ã‚‹
                        </label>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="postComment()">
                        <i class="fas fa-paper-plane me-2"></i>ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* ãƒãƒ£ãƒƒãƒˆUIã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-item {
    border-left: 3px solid #dee2e6;
    padding: 15px;
    margin-bottom: 15px;
    background: #f8f9fa;
    border-radius: 8px;
    transition: all 0.2s;
}

.comment-item:hover {
    border-left-color: #0d6efd;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.comment-item.important {
    border-left-color: #ffc107;
    background: #fff3cd;
}

.comment-author {
    font-weight: 600;
    color: #0d6efd;
    margin-right: 10px;
}

.comment-date {
    color: #6c757d;
    font-size: 0.9em;
}

.comment-content {
    margin-top: 10px;
    line-height: 1.6;
}

.comment-important-badge {
    background: #ffc107;
    color: #000;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    margin-left: 10px;
}

/* æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«é–¢é€£ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.comment-attachments {
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-top: 10px;
}

.attachment-item {
    margin-bottom: 10px;
}

.attachment-link {
    display: inline-block;
    padding: 5px 10px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 5px;
    text-decoration: none;
    color: #333;
    transition: all 0.2s;
}

.attachment-link:hover {
    background: #e9ecef;
    border-color: #0d6efd;
    color: #0d6efd;
    text-decoration: none;
}

.attachment-name {
    margin: 0 5px;
}

.attachment-size {
    color: #6c757d;
    font-size: 0.85em;
}

.attachment-preview {
    max-width: 300px;
    max-height: 200px;
    border-radius: 5px;
    cursor: pointer;
    transition: transform 0.2s;
}

.attachment-preview:hover {
    transform: scale(1.05);
}

/* ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ« */
.image-modal {
    display: block;
    position: fixed;
    z-index: 10000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.9);
}

.image-modal-content {
    position: relative;
    margin: auto;
    padding: 20px;
    max-width: 90%;
    max-height: 90%;
    top: 50%;
    transform: translateY(-50%);
}

.image-modal-content img {
    max-width: 100%;
    max-height: 80vh;
    display: block;
    margin: auto;
}

.image-modal-close {
    position: absolute;
    top: 10px;
    right: 25px;
    color: #f1f1f1;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
}

.image-modal-close:hover,
.image-modal-close:focus {
    color: #bbb;
}

/* ãƒ•ã‚¡ã‚¤ãƒ«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ */
.file-item {
    padding: 5px;
    margin: 2px 0;
    background: #f8f9fa;
    border-radius: 3px;
}

.selected-files {
    margin-bottom: 5px;
    color: #0d6efd;
}
</style>

<script>
// ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã®JavaScript
const projectId = {{ project.id }};

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’å–å¾—
document.addEventListener('DOMContentLoaded', function() {
    loadComments();
});

// ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
function loadComments() {
    fetch(`/orders/api/projects/${projectId}/comments/`)
        .then(response => {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®Content-Typeã‚’ãƒã‚§ãƒƒã‚¯
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒæœŸå¾…ã•ã‚Œã¾ã—ãŸãŒã€åˆ¥ã®å½¢å¼ãŒè¿”ã•ã‚Œã¾ã—ãŸ');
            }
            return response.json();
        })
        .then(data => {
            displayComments(data.comments);
        })
        .catch(error => {
            console.error('ã‚³ãƒ¡ãƒ³ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
            // ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ãŒæœªå®Ÿè£…ã®å¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ã‚’éè¡¨ç¤ºã«ã™ã‚‹
            document.getElementById('comments-container').innerHTML = `
                <div class="text-center text-muted py-3">
                    <i class="fas fa-comment-slash fa-2x mb-2"></i>
                    <p class="small">ã‚³ãƒ¡ãƒ³ãƒˆæ©Ÿèƒ½ã¯ç¾åœ¨æº–å‚™ä¸­ã§ã™</p>
                </div>
            `;
        });
}

// ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¡¨ç¤º
function displayComments(comments) {
    const container = document.getElementById('comments-container');

    if (comments.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-comment-slash fa-3x mb-3"></i>
                <p>ã¾ã ã‚³ãƒ¡ãƒ³ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                <p class="small">æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¦ã¿ã¾ã—ã‚‡ã†ï¼</p>
            </div>
        `;
        return;
    }

    let html = '';
    comments.forEach(comment => {
        const importantClass = comment.is_important ? 'important' : '';
        const importantBadge = comment.is_important ?
            '<span class="comment-important-badge"><i class="fas fa-exclamation-triangle"></i> é‡è¦</span>' : '';

        // æ·»ä»˜ãƒ•ã‚¡ã‚¤ãƒ«ã®HTMLç”Ÿæˆ
        let attachmentsHtml = '';
        if (comment.attachments && comment.attachments.length > 0) {
            attachmentsHtml = '<div class="comment-attachments mt-2">';
            comment.attachments.forEach(attachment => {
                const icon = getFileIcon(attachment);
                attachmentsHtml += `
                    <div class="attachment-item">
                        <a href="${attachment.file_url}" target="_blank" class="attachment-link">
                            <i class="${icon}"></i>
                            <span class="attachment-name">${escapeHtml(attachment.file_name)}</span>
                            <span class="attachment-size">(${attachment.file_size})</span>
                        </a>
                        ${attachment.is_image ? `<div class="mt-2"><img src="${attachment.file_url}" class="attachment-preview" onclick="openImageModal('${attachment.file_url}', '${escapeHtml(attachment.file_name)}')"></div>` : ''}
                    </div>
                `;
            });
            attachmentsHtml += '</div>';
        }

        html += `
            <div class="comment-item ${importantClass}">
                <div class="comment-header">
                    <span class="comment-author">
                        <i class="fas fa-user-circle"></i> ${escapeHtml(comment.author)}
                    </span>
                    <span class="comment-date">
                        <i class="far fa-clock"></i> ${comment.created_at}
                    </span>
                    ${importantBadge}
                </div>
                <div class="comment-content">
                    ${formatCommentContent(comment.content)}
                </div>
                ${attachmentsHtml}
            </div>
        `;
    });

    container.innerHTML = html;

    // æœ€æ–°ã®ã‚³ãƒ¡ãƒ³ãƒˆã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
    container.scrollTop = container.scrollHeight;
}

// ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆ@ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼‰
function formatCommentContent(content) {
    const escaped = escapeHtml(content);
    return escaped.replace(/@(\w+)/g, '<strong class="text-primary">@$1</strong>');
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
function postComment() {
    const content = document.getElementById('comment-content').value.trim();
    const isImportant = document.getElementById('comment-important').checked;
    const filesInput = document.getElementById('comment-files');
    const files = filesInput.files;

    if (!content) {
        alert('ã‚³ãƒ¡ãƒ³ãƒˆå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBåˆ¶é™ï¼‰
    for (let file of files) {
        if (file.size > 10 * 1024 * 1024) {
            alert(`ãƒ•ã‚¡ã‚¤ãƒ« "${file.name}" ãŒ10MBã‚’è¶…ãˆã¦ã„ã¾ã™`);
            return;
        }
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    // FormDataã‚’ä½¿ã£ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ†ã‚­ã‚¹ãƒˆã‚’é€ä¿¡
    const formData = new FormData();
    formData.append('content', content);
    formData.append('is_important', isImportant);

    // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
    for (let file of files) {
        formData.append('files', file);
    }

    fetch(`/orders/api/projects/${projectId}/comments/post/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('comment-content').value = '';
            document.getElementById('comment-important').checked = false;
            filesInput.value = '';
            document.getElementById('file-preview').innerHTML = '';

            // ã‚³ãƒ¡ãƒ³ãƒˆä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
            loadComments();

            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            showToast('ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ', 'success');
        } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + (data.error || 'ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
        }
    })
    .catch(error => {
        console.error('ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    });
}

// ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
function showToast(message, type = 'info') {
    // ç°¡æ˜“çš„ãªãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed top-0 end-0 m-3`;
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        <i class="fas fa-check-circle"></i> ${message}
    `;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
function getFileIcon(attachment) {
    if (attachment.is_image) {
        return 'fas fa-file-image text-info';
    } else if (attachment.is_pdf) {
        return 'fas fa-file-pdf text-danger';
    } else if (attachment.file_type.includes('word') || attachment.file_type.includes('document')) {
        return 'fas fa-file-word text-primary';
    } else if (attachment.file_type.includes('excel') || attachment.file_type.includes('spreadsheet')) {
        return 'fas fa-file-excel text-success';
    } else {
        return 'fas fa-file text-secondary';
    }
}

// ç”»åƒãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
function openImageModal(imageUrl, imageName) {
    const modal = document.createElement('div');
    modal.className = 'image-modal';
    modal.innerHTML = `
        <div class="image-modal-content">
            <span class="image-modal-close" onclick="this.parentElement.parentElement.remove()">&times;</span>
            <img src="${imageUrl}" alt="${imageName}">
            <p class="text-center mt-2">${imageName}</p>
        </div>
    `;
    document.body.appendChild(modal);

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
document.getElementById('comment-files').addEventListener('change', function(e) {
    const files = e.target.files;
    const preview = document.getElementById('file-preview');
    preview.innerHTML = '';

    if (files.length === 0) return;

    preview.innerHTML = '<div class="selected-files"><strong>é¸æŠã—ãŸãƒ•ã‚¡ã‚¤ãƒ«:</strong></div>';
    for (let file of files) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        const sizeKB = (file.size / 1024).toFixed(1);
        fileItem.innerHTML = `
            <i class="fas fa-file me-2"></i>
            <span>${file.name}</span>
            <span class="text-muted ms-2">(${sizeKB} KB)</span>
        `;
        preview.appendChild(fileItem);
    }
});

// ã‚¨ãƒ³ã‚¿ãƒ¼ã‚­ãƒ¼ã§ã®é€ä¿¡ï¼ˆShift+Enterã§æ”¹è¡Œï¼‰
document.getElementById('comment-content').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        postComment();
    }
});

// ãƒ•ã‚¡ã‚¤ãƒ«å‰Šé™¤ç¢ºèª - Phase 5
function confirmFileDelete(fileId, fileName) {
    if (confirm(`ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ${fileName}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        const form = document.getElementById('fileDeleteForm');
        form.action = `/orders/projects/${projectId}/files/${fileId}/delete/`;
        form.submit();
    }
}

// å—æ³¨ãƒ¨ãƒŸã®å¤‰æ›´ã‚’è‡ªå‹•ä¿å­˜ï¼ˆæ¡ˆä»¶è©³ç´°ç”»é¢ï¼‰
$(document).on('change', '.order-forecast-select-detail', function(e) {
    var select = $(this);
    var projectId = select.data('project-id');
    var newValue = select.val();
    var csrfToken = $('[name=csrfmiddlewaretoken]').val() || '{{ csrf_token }}';

    // ä¿å­˜ä¸­ã®è¡¨ç¤º
    select.prop('disabled', true).css('opacity', '0.5');

    $.ajax({
        url: '/orders/' + projectId + '/update-forecast/',
        method: 'POST',
        data: {
            project_status: newValue,
            csrfmiddlewaretoken: csrfToken
        },
        success: function(response) {
            if (response.success) {
                // ä¿å­˜æˆåŠŸæ™‚ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                select.css('border-color', '#28a745');

                // ãƒ˜ãƒƒãƒ€ãƒ¼ãƒãƒƒã‚¸ã‚‚æ›´æ–°
                var badge = $('.badge[title="å—æ³¨ãƒ¨ãƒŸï¼ˆå–¶æ¥­è¦‹è¾¼ã¿åº¦ï¼‰"]');
                if (badge.length) {
                    // ãƒãƒƒã‚¸ã®è‰²ã‚’å¤‰æ›´
                    badge.removeClass('bg-primary bg-success bg-info bg-warning bg-secondary text-dark');
                    if (newValue === 'å—æ³¨ç¢ºå®š') {
                        badge.addClass('bg-primary');
                    } else if (newValue === 'A') {
                        badge.addClass('bg-success');
                    } else if (newValue === 'B') {
                        badge.addClass('bg-info');
                    } else if (newValue === 'NG') {
                        badge.addClass('bg-secondary');
                    } else {
                        badge.addClass('bg-warning text-dark');
                    }
                    badge.text('å—æ³¨ãƒ¨ãƒŸ: ' + newValue);
                }

                // 1ç§’å¾Œã«ç·‘ã®æ ç·šã‚’æ¶ˆã™
                setTimeout(function() {
                    select.css('border-color', '');
                }, 1000);
            } else {
                alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                location.reload();
            }
        },
        error: function(xhr, status, error) {
            console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
            location.reload();
        },
        complete: function() {
            select.prop('disabled', false).css('opacity', '1');
        }
    });
});

// è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
function switchViewMode(mode) {
    const tabViewBtn = document.getElementById('tabViewBtn');
    const fullViewBtn = document.getElementById('fullViewBtn');
    const tabNav = document.getElementById('projectDetailTabs');
    const tabContent = document.getElementById('projectDetailTabsContent');
    const tabPanes = document.querySelectorAll('#projectDetailTabsContent .tab-pane');

    if (mode === 'tab') {
        // ã‚¿ãƒ–è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        tabViewBtn.classList.add('active');
        fullViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
        tabNav.style.display = 'flex';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
        tabContent.classList.remove('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤ºã«ã™ã‚‹
        tabPanes.forEach(pane => {
            pane.classList.remove('show', 'active');
        });

        // æœ€åˆã®ã‚¿ãƒ–ã‚’è¡¨ç¤º
        const firstPane = document.getElementById('overview');
        if (firstPane) {
            firstPane.classList.add('show', 'active');
        }

        // æœ€åˆã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã™ã‚‹
        const tabButtons = document.querySelectorAll('#projectDetailTabs .nav-link');
        tabButtons.forEach(btn => btn.classList.remove('active'));
        const firstButton = document.getElementById('overview-tab');
        if (firstButton) {
            firstButton.classList.add('active');
        }

    } else if (mode === 'full') {
        // å…¨ä½“è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
        fullViewBtn.classList.add('active');
        tabViewBtn.classList.remove('active');

        // ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
        tabNav.style.display = 'none';

        // full-view-modeã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
        tabContent.classList.add('full-view-mode');

        // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        tabPanes.forEach(pane => {
            pane.classList.add('show', 'active');
        });
    }

    // é¸æŠçŠ¶æ…‹ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
    localStorage.setItem('projectDetailViewMode', mode);
}

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å‰å›ã®è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’å¾©å…ƒ
document.addEventListener('DOMContentLoaded', function() {
    const savedMode = localStorage.getItem('projectDetailViewMode');
    if (savedMode === 'full') {
        switchViewMode('full');
    }
});
</script>

{% endblock %}