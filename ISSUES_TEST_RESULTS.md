# 11個の問題点のテスト結果

## ✅ 解決済み (Resolved)

### 問題1: 案件新規作成で案件担当者(営業)が登録できない
**ステータス**: ✅ 解決済み

**確認内容**:
- フォームに営業担当者選択フィールドが実装されている (project_form.html:453-472)
- ビューでsales_managerからproject_managerへの保存処理が実装されている (views.py:272-280)
- 案件作成時と編集時の両方で正しく動作する

**該当コード**:
```python
# views.py:272-280
sales_manager_id = request.POST.get('sales_manager')
if sales_manager_id:
    try:
        sales_worker = InternalWorker.objects.get(id=sales_manager_id)
        project.project_manager = sales_worker.name
        project.save()
    except InternalWorker.DoesNotExist:
        pass
```

### 問題9: 進捗状況の順序
**ステータス**: ✅ 解決済み

**確認内容**:
- 期待される順序: 立ち会い日→現場調査→見積書発行→着工日→完工日
- 実装されている順序: 立ち会い日→現調日(現場調査)→見積もり発行日→着工日→完工日
- **完全に一致**

**該当コード**:
```javascript
// project_detail.html:4949-5148
const availableSteps = [
    { name: '立ち会い日', key: 'attendance', ... },
    { name: '現調日', key: 'survey', ... },
    { name: '見積もり発行日', key: 'estimate', ... },
    { name: '着工日', key: 'construction_start', ... },
    { name: '完工日', key: 'completion', ... },
    ...
];
```

---

## ⚠️ 手動テストが必要 (Manual Testing Required)

### 問題2: 案件詳細で完了ボタン押すと通信エラー
**ステータス**: ⚠️ 手動テスト必要

**推奨テスト方法**:
1. 開発サーバーを起動: `python manage.py runserver`
2. ブラウザで案件詳細ページを開く
3. 金額などを入力して「完了」ボタンをクリック
4. ブラウザの開発者ツール（Networkタブ）でAJAXリクエストのステータスを確認
5. エラーが発生した場合、レスポンスの内容を確認

**確認ポイント**:
- update_progressビューのエラーハンドリング
- CSRF token の正常な送信
- フォームデータの正常な送信

### 問題3: 暫定利益率分析の数字がバグってる
**ステータス**: ⚠️ 詳細確認必要

**確認内容**:
- Projectモデルに`projectprofitanalysis`関連のメソッドが存在することを確認
- 利益率計算ロジックの詳細確認が必要

**推奨対応**:
1. どの画面/セクションの利益率分析か特定
2. 期待される計算式と実際の計算結果を比較
3. バグの具体的な内容を特定

### 問題4: 作業者追加ボタンで作業者が追加されない
**ステータス**: ⚠️ 手動テスト必要

**推奨テスト方法**:
1. 案件作成/編集画面を開く
2. 「作業者追加」ボタンをクリック
3. 作業者情報を入力
4. 右下の「作業者を追加」ボタンをクリック
5. 作業者リストに追加されるか確認
6. ブラウザコンソールでJavaScriptエラーを確認

**確認ポイント**:
- JavaScriptイベントハンドラーの動作
- AJAXリクエストの成否
- DOM要素の更新

### 問題5: 着工日待ちになったらAヨミに自動変更
**ステータス**: ⚠️ 仕様確認と実装確認が必要

**確認内容**:
- Projectモデルのsaveメソッドに着工日関連の処理が存在
- ステータス自動更新ロジックの詳細確認が必要

**推奨対応**:
1. 「Aヨミ」の正確な定義を確認（project_statusフィールドの値？）
2. どのタイミングで自動変更すべきか確認（着工日設定時？職人手配完了時？）
3. 該当ロジックの実装状況を確認

### 問題6: NO237で過去日付でも着工日待ち表示される
**ステータス**: ⚠️ テストデータ不足

**確認内容**:
- NO237のプロジェクトがデータベースに存在しない
- テストデータを作成して確認が必要

**推奨対応**:
1. NO237のプロジェクトを作成または既存データを確認
2. 過去の着工日を設定
3. ステータス表示が正しいか確認
4. get_current_project_stage()メソッドのロジックを確認

### 問題7: 元請業者追加の際の業者分類が不透明
**ステータス**: ⚠️ UI改善が必要

**確認内容**:
- ClientCompanyモデル（元請業者）とContractorモデル（下請け業者/職人）が分離されている
- UIで明確な区別が必要

**推奨対応**:
1. 元請業者登録画面に説明テキストを追加
2. 「この画面は案件をくれる会社（元請業者）を登録するためのものです」
3. 職人/下請け業者は別の画面で登録することを明示

### 問題8: 新規業者登録後にメモリアルされていない
**ステータス**: ⚠️ 詳細確認必要

**意味の確認**:
- 「メモリアル」= 記憶される/保存される？
- 新規業者登録後、次の案件作成画面で選択肢に表示されないという意味？

**推奨対応**:
1. 新規元請業者登録後、ページ遷移時にセッションやキャッシュが正しく更新されるか確認
2. ClientCompany.objects.filter(is_active=True)のクエリが正しく動作するか確認
3. フォームの選択肢がリフレッシュされるか確認

### 問題10: 立ち会い日入力済みで立ち会い済み表示
**ステータス**: ⚠️ 実装確認必要

**期待される動作**:
- 立ち会い日（actual_date）が入力されている場合
- ステータスが「立ち会い待ち」ではなく「立ち会い済み」と表示される

**推奨対応**:
1. 複合ステップ（attendance）のステータス計算ロジックを確認
2. getComplexStepStatus関数の実装を確認
3. actual_dateが入力されている場合、completedステータスになるか確認

### 問題11: 完工済みでも着工日待ち表示になる
**ステータス**: ⚠️ テストデータ不足

**確認内容**:
- work_end_completed=Trueのプロジェクトがデータベースに存在しない
- テストデータを作成して確認が必要

**推奨対応**:
1. 完工済みのプロジェクトを作成
2. get_current_project_stage()メソッドの優先順位を確認
3. 完工済みの場合、他のステータスより優先されるか確認

---

## 📋 テスト実行コマンド

```bash
# 自動テストスクリプト
python test_all_issues.py

# 開発サーバー起動
python manage.py runserver

# データベース確認
python manage.py shell
>>> from order_management.models import Project
>>> Project.objects.filter(management_no__contains='237').first()
```

---

## 🔍 次のステップ

1. **手動テストの実行**: 問題2, 4, 7, 8をブラウザでテスト
2. **テストデータの作成**: 問題6, 11のためのテストプロジェクトを作成
3. **仕様の明確化**: 問題3, 5, 8の具体的な要件を確認
4. **実装の確認**: 問題10のステータス計算ロジックを詳細確認

---

## 📊 サマリー

| カテゴリ | 件数 | 問題番号 |
|---------|------|---------|
| ✅ 解決済み | 2 | 1, 9 |
| ⚠️ 手動テスト必要 | 9 | 2, 3, 4, 5, 6, 7, 8, 10, 11 |
| **合計** | **11** | |

**進捗率**: 18% (2/11解決済み)
